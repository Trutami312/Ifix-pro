<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>iFix Pro Enterprise - Cloud SaaS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Aplikasi POS untuk Service HP & Penjualan - iFix Pro Enterprise">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="iFix Pro">
    
    <!-- Inline PWA Manifest -->
    <link id="manifest-placeholder" rel="manifest">
    
    <link rel="icon" type="image/png" href="/logo-ifix.png">
    <link rel="apple-touch-icon" href="/logo-ifix.png">
    
    <script>
        // Generate inline manifest
        const manifestData = {
            id: "/",
            name: "iFix Pro - Phone Repair POS",
            short_name: "iFix Pro",
            description: "Sistem POS untuk servis HP dengan fitur multi-branch, inventory, HR & Payroll",
            start_url: "/index.html",
            scope: "/",
            display: "standalone",
            display_override: ["standalone", "minimal-ui"],
            background_color: "#0f172a",
            theme_color: "#2563eb",
            prefer_related_applications: false,
            related_applications: [],
            categories: ["business", "productivity"],
            icons: [{
                src: "/logo-ifix.png",
                sizes: "192x192",
                type: "image/png",
                purpose: "any maskable"
            }, {
                src: "/logo-ifix.png",
                sizes: "512x512",
                type: "image/png",
                purpose: "any"
            }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>
    <!-- 
    ÔøΩ POCKETBASE BACKEND AKTIF üîå
    ========================================
    ‚úÖ Self-hosted PocketBase di VPS: https://amproject.my.id
    ‚úÖ Real-time subscriptions via SSE
    ‚úÖ Firebase-compatible adapter layer
    ‚úÖ Semua 28 collections di-mirror ke PocketBase
    ‚úÖ Auth via PocketBase users collection
    ‚úÖ Batch operations via sequential writes
    ‚úÖ In-memory caching dengan TTL 5 menit
    ‚úÖ Debounce utility untuk search/input
    
    Keuntungan PocketBase:
    - GRATIS tanpa batas quota
    - Data di VPS sendiri (full control)
    - Tidak ada biaya per-read/write
    - Real-time updates tetap berfungsi
    - Backup mudah via PocketBase admin UI
    
    Migrasi dari Firebase: February 16, 2026
    -->
    
    
    <!-- 
    ‚ö†Ô∏è  DEPENDENCY VERSIONS LOCKED - DO NOT AUTO-UPDATE ‚ö†Ô∏è
    ================================================================
    Status: PRODUCTION STABLE (Migrated to PocketBase - Feb 2026)
    
    CORE LIBRARIES (LOCKED):
    - React: 18.2.0 (Stable - No breaking changes expected)
    - PocketBase SDK: 0.21.1 (Self-hosted backend)
    - Lucide Icons: 0.263.1 (Icon library)
    - Recharts: 2.12.0 (Charts)
    - HTML2Canvas: 1.4.1 (Export PDF)
    - Babel Standalone: 7.23.6 (JSX compiler)
    - Tailwind CSS: Latest (via CDN - safe to update)
    
    BACKEND:
    - PocketBase Server: 0.22.6 at https://amproject.my.id
    - Firebase: REMOVED (migrated Feb 16, 2026)
    
    Last Verified: February 16, 2026
    Risk Level: LOW (All versions locked)
    ================================================================
    -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Libraries (VERSIONS LOCKED) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom-client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
        "html2canvas": "https://esm.sh/html2canvas@1.4.1",
        "jspdf": "https://esm.sh/jspdf@2.5.1"
      }
    }
    </script>
    
    <!-- PocketBase SDK (UMD) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.21.1/pocketbase.umd.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      body { background-color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .saas-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
      
      /* Animasi Timeline */
      .timeline-line { position: absolute; left: 15px; top: 30px; bottom: -20px; width: 2px; background: #e2e8f0; z-index: 0; }
      .timeline-item:last-child .timeline-line { display: none; }
      
      /* Animasi Loading */
      .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 30px; height: 30px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      @media print {
        /* Sembunyikan elemen non-print */
        .no-print { display: none !important; }

        /* Tampilkan elemen print-only */
        .print-only { display: block !important; }

        /* Tetap cetak warna background, badge, dan tabel */
        body {
          background: white;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        /* Ukuran halaman */
        @page { margin: 10mm; }

        /* Netralkan semua scroll area agar konten penuh tampil */
        *,
        .overflow-auto,
        .overflow-y-auto,
        .overflow-x-auto,
        .overflow-scroll,
        .overflow-y-scroll,
        .overflow-x-scroll {
          overflow: visible !important;
        }

        /* Netralkan batasan tinggi layar */
        .h-screen,
        .h-full,
        .min-h-screen,
        .max-h-screen,
        [class*="max-h-"] {
          height: auto !important;
          max-height: none !important;
        }

        /* Wrapper cetak tidak terpotong */
        .fixed.inset-0,
        .print-only {
          position: absolute !important;
          top: 0 !important;
          left: 0 !important;
          width: 100% !important;
          min-height: 100% !important;
        }

        /* Hindari terpotong di tengah baris/elemen */
        tr, li, .break-avoid {
          break-inside: avoid;
          page-break-inside: avoid;
        }

        /* Hindari heading tabel terpotong dari isinya */
        thead { display: table-header-group; }
        tfoot { display: table-footer-group; }
        table { page-break-inside: auto; }
      }

      /* Animasi Fade In */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
      
      /* Animasi Scale Up untuk popup */
      @keyframes scaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
      .animate-scale-up { animation: scaleUp 0.3s ease-out forwards; }
      
      /* Sidebar Scrollbar - Custom untuk sidebar agar tidak mengecil */
      .sidebar-scroll::-webkit-scrollbar { width: 4px; }
      .sidebar-scroll::-webkit-scrollbar-track { background: #0f172a; }
      .sidebar-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
      .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }
      .sidebar-scroll { scrollbar-width: thin; scrollbar-color: #334155 #0f172a; }
      
      /* ========================================
         üì± MOBILE RESPONSIVE OPTIMIZATIONS
         ======================================== */
      
      /* Mobile touch targets - min 44px */
      @media (max-width: 767px) {
        /* Sembunyikan scrollbar horizontal di tabel mobile */
        .overflow-x-auto::-webkit-scrollbar { height: 3px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        
        /* Padding tabel lebih compact di mobile */
        table th, table td { padding: 8px 10px !important; font-size: 12px !important; }
        
        /* Card value text responsive */
        .mobile-value { font-size: 1.25rem !important; }
        
        /* Input & button touch-friendly */
        input, select, textarea { font-size: 16px !important; min-height: 44px; }
        button { min-height: 40px; }
        
        /* Bottom padding untuk bottom nav */
        .mobile-bottom-padding { padding-bottom: 80px !important; }
        
        /* Sidebar mobile overlay */
        .mobile-sidebar { max-width: 85vw !important; }
        
        /* Responsive card grid */
        .mobile-stat-value { font-size: 1.1rem !important; word-break: break-all; }
        
        /* Fix tabel agar tidak terlalu wide */
        .mobile-table-compact th:nth-child(n+4), .mobile-table-compact td:nth-child(n+4) {
          display: none;
        }
        
      }
      
      /* Small phone (iPhone SE, Galaxy S8 etc) */
      @media (max-width: 375px) {
        table th, table td { padding: 6px 8px !important; font-size: 11px !important; }
        .text-3xl { font-size: 1.25rem !important; }
        .text-2xl { font-size: 1.1rem !important; }
      }
      
      /* Bottom Navigation Bar */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 40;
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        padding: 4px 8px;
        padding-bottom: max(4px, env(safe-area-inset-bottom));
        display: none;
      }
      @media (max-width: 767px) {
        .bottom-nav { display: flex; justify-content: space-around; align-items: center; }
      }
      .bottom-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 6px 4px;
        border-radius: 8px;
        transition: all 0.2s;
        min-width: 56px;
        cursor: pointer;
        border: none;
        background: transparent;
        color: #64748b;
        font-size: 9px;
        font-weight: 600;
      }
      .bottom-nav-item.active {
        color: #2563eb;
        background: #eff6ff;
      }
      .bottom-nav-item svg { width: 20px; height: 20px; margin-bottom: 2px; }
      
      /* ========================================
         üíº MOBILE TABLE TO CARD VIEW
         ======================================== */
      @media (max-width: 767px) {
        /* Sembunyikan table normal, tampilkan mobile card stack */
        .mobile-card-wrapper table { display: none; }
        .mobile-card-stack { display: block !important; }
        
        /* Mobile card styles */
        .mobile-card {
          background: white;
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          padding: 16px;
          margin-bottom: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .mobile-card-row {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid #f1f5f9;
        }
        .mobile-card-row:last-child { border-bottom: none; }
        .mobile-card-label {
          font-size: 11px;
          font-weight: 700;
          color: #64748b;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }
        .mobile-card-value {
          font-size: 13px;
          font-weight: 600;
          color: #1e293b;
          text-align: right;
          max-width: 60%;
        }
        .mobile-card-actions {
          display: flex;
          gap: 8px;
          margin-top: 12px;
          padding-top: 12px;
          border-top: 1px solid #e2e8f0;
        }
      }
      @media (min-width: 768px) {
        /* Desktop: hide mobile cards, show table */
        .mobile-card-stack { display: none !important; }
      }
      
      /* Safe area untuk notch / gesture area */
      @supports (padding: max(0px)) {
        body { padding-bottom: env(safe-area-inset-bottom); }
      }
      
      /* Swipe hint animation */
      @keyframes swipeHint {
        0%, 100% { transform: translateX(0); opacity: 0.5; }
        50% { transform: translateX(-8px); opacity: 1; }
      }
      .swipe-hint { animation: swipeHint 2s ease-in-out 1; }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-blue-100 selection:text-blue-900">
    <!-- Error Display Container -->
    <div id="error-display" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 999999; overflow-y: auto; padding: 20px;">
        <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: #dc2626;">
                <svg style="width: 32px; height: 32px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <h2 style="margin: 0; font-size: 24px; font-weight: bold; color: #dc2626;">Error Terdeteksi</h2>
            </div>
            <div id="error-content" style="font-family: monospace; font-size: 14px; line-height: 1.6; color: #1f2937; white-space: pre-wrap; word-wrap: break-word; background: #f3f4f6; padding: 15px; border-radius: 4px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;"></div>
            
            <!-- Diagnostic Info -->
            <details style="margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px;">
                <summary style="cursor: pointer; font-weight: bold; color: #3b82f6; margin-bottom: 10px;">üìä Info Diagnostik (klik untuk lihat)</summary>
                <div id="diagnostic-info" style="font-family: monospace; font-size: 12px; line-height: 1.6; color: #1f2937; white-space: pre-wrap; background: #f9fafb; padding: 10px; border-radius: 4px; margin-top: 10px;"></div>
            </details>
            
            <button onclick="document.getElementById('error-display').style.display='none'" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%;">Tutup</button>
            <button onclick="location.reload()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;">Reload Halaman</button>
            <button onclick="window.copyToClipboard(document.getElementById('error-content').textContent + '\\n\\n' + document.getElementById('diagnostic-info').textContent)" style="background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;">üìã Copy Error Info</button>
        </div>
    </div>
    
    <div id="root"></div>

    <script>
        // ==========================================
        // üîç DIAGNOSTIC INFO (tampil di console)
        // ==========================================
        console.log('==========================================');
        console.log('üöÄ iFix Pro Enterprise - Starting...');
        console.log('==========================================');
        console.log('üì± User Agent:', navigator.userAgent);
        console.log('üåê Browser:', navigator.appName + ' ' + navigator.appVersion);
        console.log('üì∫ Screen:', window.screen.width + 'x' + window.screen.height);
        console.log('ü™ü Viewport:', window.innerWidth + 'x' + window.innerHeight);
        console.log('üåç Online:', navigator.onLine);
        console.log('üíæ LocalStorage:', typeof localStorage !== 'undefined' ? 'Supported' : 'Not Supported');
        console.log('üîß ServiceWorker:', 'serviceWorker' in navigator ? 'Supported' : 'Not Supported');
        console.log('üìÖ Date:', new Date().toLocaleString('id-ID'));
        console.log('==========================================');
        
        // Global Error Handler untuk menampilkan error di halaman
        window.showError = function(title, message, error) {
            const errorDisplay = document.getElementById('error-display');
            const errorContent = document.getElementById('error-content');
            const diagnosticInfo = document.getElementById('diagnostic-info');
            
            let errorText = `üî¥ ${title}\n\n`;
            errorText += `${message}\n\n`;
            
            if (error) {
                errorText += `Error Details:\n`;
                errorText += `${error.toString()}\n\n`;
                
                if (error.stack) {
                    errorText += `Stack Trace:\n${error.stack}`;
                }
            }
            
            errorContent.textContent = errorText;
            
            // Populate diagnostic info
            let diagText = '';
            diagText += `User Agent: ${navigator.userAgent}\n`;
            diagText += `Browser: ${navigator.appName} ${navigator.appVersion}\n`;
            diagText += `Screen: ${window.screen.width}x${window.screen.height}\n`;
            diagText += `Viewport: ${window.innerWidth}x${window.innerHeight}\n`;
            diagText += `Online: ${navigator.onLine}\n`;
            diagText += `LocalStorage: ${typeof localStorage !== 'undefined' ? 'Supported' : 'Not Supported'}\n`;
            diagText += `ServiceWorker: ${'serviceWorker' in navigator ? 'Supported' : 'Not Supported'}\n`;
            diagText += `Cookies: ${navigator.cookieEnabled ? 'Enabled' : 'Disabled'}\n`;
            diagText += `Language: ${navigator.language}\n`;
            diagText += `Platform: ${navigator.platform}\n`;
            diagText += `Date: ${new Date().toLocaleString('id-ID')}\n`;
            diagText += `URL: ${window.location.href}\n`;
            
            diagnosticInfo.textContent = diagText;
            errorDisplay.style.display = 'block';
            
            // Juga log ke console untuk reference
            console.error('‚ùå Error:', title, message, error);
        };
        
        // Copy to clipboard with fallback for HTTP (non-HTTPS) context
        window.copyToClipboard = function(text) {
            // HTTPS context: use modern Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text)
                    .then(() => {
                        alert('‚úÖ Error & diagnostic info berhasil disalin ke clipboard!');
                        return true;
                    })
                    .catch(err => {
                        console.error('Clipboard API failed:', err);
                        return fallbackCopyToClipboard(text);
                    });
            }
            // HTTP context: use fallback method
            return fallbackCopyToClipboard(text);
        };
        
        // Fallback copy method for HTTP context (uses document.execCommand)
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) {
                    alert('‚úÖ Error & diagnostic info berhasil disalin ke clipboard!');
                    return true;
                } else {
                    alert('‚ùå Gagal menyalin ke clipboard. Silakan copy manual.');
                    return false;
                }
            } catch (err) {
                document.body.removeChild(textArea);
                console.error('Fallback copy failed:', err);
                alert('‚ùå Browser tidak mendukung copy otomatis. Silakan copy manual.');
                return false;
            }
        }
        
        // Catch all unhandled errors
        window.addEventListener('error', function(event) {
            showError(
                'JavaScript Error',
                `File: ${event.filename}\nLine: ${event.lineno}:${event.colno}`,
                event.error
            );
        });
        
        // Catch all unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            showError(
                'Unhandled Promise Rejection',
                'Promise ditolak tanpa error handler',
                event.reason
            );
        });
        
        // Loading indicator
        window.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM loaded');
            
            // Check if React loaded
            setTimeout(function() {
                const root = document.getElementById('root');
                if (!root.hasChildNodes()) {
                    showError(
                        'React Tidak Load',
                        'React tidak berhasil merender aplikasi.\nPeriksa koneksi internet atau kompabilitas browser.',
                        new Error('Root div kosong setelah 5 detik')
                    );
                }
            }, 5000);
            
            // Monitor network status
            if (!navigator.onLine) {
                showError(
                    'Tidak Ada Koneksi Internet',
                    'Perangkat Anda sedang offline.\nPastikan koneksi internet aktif.',
                    new Error('navigator.onLine = false')
                );
            }
            
            window.addEventListener('online', function() {
                console.log('‚úÖ Kembali online');
                const errorDisplay = document.getElementById('error-display');
                if (errorDisplay.style.display === 'block') {
                    if (confirm('Koneksi internet kembali. Reload halaman?')) {
                        location.reload();
                    }
                }
            });
            
            window.addEventListener('offline', function() {
                console.log('‚ö†Ô∏è Offline');
                showError(
                    'Koneksi Internet Terputus',
                    'Perangkat kehilangan koneksi internet.\nBeberapa fitur mungkin tidak tersedia.',
                    new Error('Connection lost')
                );
            });
        });
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useContext, createContext, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom-client';
        import { 
          LayoutDashboard, Smartphone, Box, Wallet, FileText, Users, Settings, 
          LogOut, Plus, Search, Store, ChevronDown, Check, Lock, ShieldCheck, MapPin,
          Printer, Share2, X, Save, Menu, CheckCircle, AlertTriangle, Trash2, 
          Upload, Download, RefreshCw, Copy, Wrench, PackagePlus, PenTool, 
          MessageCircle, Calendar, Clock, DollarSign, CreditCard, Image as ImageIcon, 
          ArrowUpRight, ArrowDownRight, Activity, TrendingUp, TrendingDown, ToggleLeft, Globe, Eye, UserX, Key, User,
          ShieldAlert, Shield, Building, Database, HardDriveDownload, HardDriveUpload, Layers,
          Loader2, LogIn, UserPlus, RefreshCcw, SearchX, Truck, CheckCheck, Pencil,
          Hash, Edit3, Filter, MinusCircle, Crown, Minus, History, Tag,
          Zap, BarChart3, Info, ShoppingCart, Banknote, Phone, Mail, RotateCcw, RotateCw, Package, AlertCircle, ExternalLink,
          File, CheckCircle2, HeartHandshake,
          Send, Bot, Sparkles, Lightbulb, Brain, ChevronRight, ClipboardList
        } from 'lucide-react';
        import { 
          BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, 
          AreaChart, Area, PieChart, Pie
        } from 'recharts';
        import html2canvas from 'html2canvas';
        import { jsPDF } from 'jspdf';

        // ==========================================
        // üñ®Ô∏è PRINT AS IMAGE UTILITY
        // Render elemen ke canvas lalu cetak lewat popup
        // ==========================================
        const printAsImage = async (elementId) => {
            const el = document.getElementById(elementId);
            if (!el) { alert('Elemen invoice tidak ditemukan.'); return; }
            const canvas = await html2canvas(el, {
                scale: 3,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                allowTaint: true,
                windowHeight: el.scrollHeight,
                height: el.scrollHeight,
                width: el.scrollWidth,
            });
            const imgUrl = canvas.toDataURL('image/png');
            const popup = window.open('', '_blank', 'width=420,height=800,scrollbars=yes');
            if (!popup) { alert('Pop-up diblokir browser. Izinkan pop-up untuk halaman ini lalu coba lagi.'); return; }
            popup.document.write(`
                <!DOCTYPE html><html><head><title>Print Invoice</title>
                <style>
                    * { margin:0; padding:0; box-sizing:border-box; }
                    html, body { background:#fff; width:100%; margin:0; padding:0; }
                    img { width:100%; height:auto; display:block; }
                    @media print {
                        @page { margin:0; size:auto; }
                        html, body { width:100%; margin:0; padding:0; }
                        img { width:100%; height:auto; display:block; page-break-inside:avoid; page-break-after:avoid; page-break-before:avoid; }
                    }
                </style>
                </head><body>
                <img src="${imgUrl}" onload="setTimeout(()=>{ window.print(); window.onfocus=()=>window.close(); },300);" />
                </body></html>
            `);
            popup.document.close();
        };
        
        // üì≤ SHARE AS IMAGE UTILITY
        // Render elemen ke PNG lalu share via Web Share API ke app printer
        // ==========================================
        const shareAsImage = async (elementId) => {
            const el = document.getElementById(elementId);
            if (!el) { alert('Elemen invoice tidak ditemukan.'); return; }
            const canvas = await html2canvas(el, {
                scale: 3,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                allowTaint: true,
                windowHeight: el.scrollHeight,
                height: el.scrollHeight,
                width: el.scrollWidth,
            });
            const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
            // Buat File dengan fallback jika File constructor tidak tersedia
            let file = null;
            try {
                file = new File([blob], 'invoice.png', { type: 'image/png' });
            } catch(e) {
                // Android lama: File constructor tidak tersedia, pakai Blob
                file = blob;
                file.name = 'invoice.png';
            }
            const canShareFile = navigator.canShare && (() => { try { return navigator.canShare({ files: [file] }); } catch(e) { return false; } })();
            if (canShareFile) {
                await navigator.share({ files: [file], title: 'Invoice', text: 'Invoice dari toko' });
            } else if (navigator.share) {
                // Fallback share tanpa file ‚Äî share URL data
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'invoice.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                // Fallback terakhir: download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'invoice.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };

        // --- POCKETBASE (loaded via UMD CDN in <head>) ---
        const PocketBase = window.PocketBase || globalThis.PocketBase;

        // ==========================================
        // üîÑ POCKETBASE COMPATIBILITY LAYER
        // Mimics Firebase API ‚Üí PocketBase
        // ==========================================
        // Auto-detect PocketBase URL: jika dihosting dari PocketBase sendiri (pb_public), gunakan origin yang sama
        const POCKETBASE_URL = (() => {
            const host = window.location.hostname;
            if (host === 'localhost' || host === '127.0.0.1') return 'http://localhost:8090';
            // Jika diakses dari VPS langsung (PocketBase serve frontend)
            if (host === 'amproject.my.id') return window.location.origin;
            // Jika diakses dari domain custom yang mengarah ke VPS
            if (host === 'server1.amproject.com') return window.location.origin;
            // Jika diakses via subdomain tenant (*.amproject.my.id) ‚Üí pakai backend utama
            if (host.endsWith('.amproject.my.id')) return 'https://amproject.my.id';
            // Fallback: Domain amproject.my.id
            return 'https://amproject.my.id';
        })();
        const pb = new PocketBase(POCKETBASE_URL);
        console.log('üîå PocketBase SDK loaded, connecting to:', POCKETBASE_URL);

        // ‚îÄ‚îÄ üåê Subdomain Tenant Detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Mendeteksi subdomain untuk routing multi-tenant.
        // Contoh: tokosaya.amproject.my.id ‚Üí subdomain = "tokosaya"
        const _MAIN_HOSTNAMES = ['amproject.my.id', 'localhost', '127.0.0.1', 'server1.amproject.com'];
        const _detectSubdomain = () => {
            const host = window.location.hostname;
            if (_MAIN_HOSTNAMES.includes(host)) return null;
            const parts = host.split('.');
            if (parts.length >= 3) {
                const sub = parts[0].toLowerCase().trim();
                if (sub && sub !== 'www' && sub !== 'app') return sub;
            }
            return null;
        };
        // Subdomain yang terdeteksi dari URL (null = akses dari domain utama)
        window.DETECTED_SUBDOMAIN = _detectSubdomain();
        console.log('üåê Subdomain terdeteksi:', window.DETECTED_SUBDOMAIN || '(none - domain utama)');

        // Cache info tenant dari subdomain (diisi saat resolveSubdomainTenant() dipanggil)
        window._SUBDOMAIN_TENANT = null;

        // Resolusi subdomain ‚Üí owner dari PocketBase (dipanggil sekali saat app start)
        const resolveSubdomainTenant = async () => {
            if (!window.DETECTED_SUBDOMAIN) return null;
            try {
                const results = await pb.collection('owners').getList(1, 1, {
                    filter: `subdomain = "${window.DETECTED_SUBDOMAIN}"`,
                    fields: 'id,name,subdomain,plan'
                });
                if (results.items.length > 0) {
                    const owner = results.items[0];
                    // Ambil logo dari stores collection berdasarkan ownerId
                    try {
                        const storeRes = await pb.collection('stores').getList(1, 1, {
                            filter: `ownerId = "${owner.id}"`,
                            fields: 'id,name,logo,address'
                        });
                        if (storeRes.items.length > 0) {
                            owner.logo = storeRes.items[0].logo || null;
                            owner.storeAddress = storeRes.items[0].address || null;
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Gagal ambil logo toko:', e.message);
                    }
                    window._SUBDOMAIN_TENANT = owner;
                    console.log('‚úÖ Tenant subdomain ditemukan:', window._SUBDOMAIN_TENANT.name);
                } else {
                    window._SUBDOMAIN_TENANT = { notFound: true };
                    console.warn('‚ö†Ô∏è Tidak ada tenant dengan subdomain:', window.DETECTED_SUBDOMAIN);
                }
            } catch (err) {
                console.error('‚ùå Gagal resolve subdomain tenant:', err.message);
            }
            return window._SUBDOMAIN_TENANT;
        };
        // Jalankan resolusi subdomain sedini mungkin
        resolveSubdomainTenant();
        
        // Test connection
        (async () => {
            try {
                const health = await fetch(`${POCKETBASE_URL}/api/health`);
                if (health.ok) {
                    console.log('‚úÖ PocketBase server is reachable and healthy');
                } else {
                    console.warn('‚ö†Ô∏è PocketBase server responded but not healthy:', health.status);
                }
            } catch (err) {
                console.error('‚ùå Cannot connect to PocketBase server:', err.message);
                console.error('   Make sure PocketBase is running at:', POCKETBASE_URL);
                console.error('   Check: 1) Server is running, 2) Port 8090 is open, 3) CORS is configured');
            }
        })();

        // ‚îÄ‚îÄ Reference Classes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        class PBCollectionRef {
            constructor(name) {
                this.collectionName = name;
                this.id = name;
                this.path = name;
                this._isPBCollectionRef = true;
            }
        }

        class PBDocRef {
            constructor(collectionName, docId) {
                this.collectionName = collectionName;
                this.id = docId;
                this.path = docId ? `${collectionName}/${docId}` : collectionName;
                this._isPBDocRef = true;
            }
        }

        class PBQueryConstraint {
            constructor(type, data) { this.type = type; this.data = data; }
        }

        class PBQuery {
            constructor(collectionRef) {
                this.collectionRef = collectionRef;
                this.collectionName = collectionRef.collectionName;
                this.constraints = [];
                this._isPBQuery = true;
            }
        }

        // ‚îÄ‚îÄ Timestamp ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        class PBTimestamp {
            constructor(dateStr) {
                this._date = dateStr instanceof Date ? dateStr : new Date(dateStr);
                this.seconds = Math.floor(this._date.getTime() / 1000);
                this.nanoseconds = 0;
            }
            toDate() { return this._date; }
            static fromDate(date) { return new PBTimestamp(date); }
            static now() { return new PBTimestamp(new Date()); }
        }
        const Timestamp = PBTimestamp;

        // ‚îÄ‚îÄ Document & Query Snapshots ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const _convertDates = (obj) => {
            if (!obj || typeof obj !== 'object') return obj;
            if (Array.isArray(obj)) return obj.map(_convertDates);
            const result = {};
            for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}/.test(value) && value.length < 35) {
                    const d = new Date(value);
                    if (!isNaN(d.getTime())) { result[key] = new PBTimestamp(d); continue; }
                }
                if (value && typeof value === 'object' && !Array.isArray(value)) {
                    result[key] = _convertDates(value);
                } else if (Array.isArray(value)) {
                    result[key] = value.map(item => (item && typeof item === 'object') ? _convertDates(item) : item);
                } else {
                    result[key] = value;
                }
            }
            return result;
        };

        class PBDocumentSnapshot {
            constructor(record, collectionName) {
                this._record = record;
                this.collectionName = collectionName;
                this.id = record?.id || null;
                this.ref = record ? new PBDocRef(collectionName, record.id) : null;
                this.metadata = { fromCache: false };
            }
            exists() { return this._record !== null && this._record !== undefined; }
            data() {
                if (!this._record) return undefined;
                const raw = { ...this._record };
                delete raw.collectionId;
                delete raw.collectionName;
                delete raw.expand;
                // Provide uid if missing (auth collection records)
                if (!raw.uid && raw.id) raw.uid = raw.id;
                // Convert ISO date strings ‚Üí PBTimestamp (compatibility for .seconds, .toDate())
                return _convertDates(raw);
            }
        }

        class PBQuerySnapshot {
            constructor(records, collectionName) {
                this.docs = (records || []).map(r => new PBDocumentSnapshot(r, collectionName));
                this.empty = this.docs.length === 0;
                this.size = this.docs.length;
                this.metadata = { fromCache: false };
            }
        }

        // ‚îÄ‚îÄ Firebase-compatible functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const collection = (dbArg, ...segments) => {
            const name = segments[segments.length - 1];
            // Automatically apply tenant prefix for tenant-specific collections (DISABLED)
            const tenantAwareName = getTenantCollection(name);
            return new PBCollectionRef(tenantAwareName);
        };

        // Generate a random 15-char ID (matches PocketBase default ID format)
        const _generateId = () => {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let id = '';
            const arr = crypto.getRandomValues(new Uint8Array(15));
            for (let i = 0; i < 15; i++) id += chars[arr[i] % chars.length];
            return id;
        };

        const doc = (dbOrRef, ...segments) => {
            if (dbOrRef && dbOrRef._isPBCollectionRef) {
                // doc(collectionRef) ‚Üí auto-generate ID (like Firebase)
                if (segments.length === 0) return new PBDocRef(dbOrRef.collectionName, _generateId());
                return new PBDocRef(dbOrRef.collectionName, segments[0]);
            }
            // doc(db, prefix, 'public', 'collection', 'docId')
            if (segments.length >= 2) {
                return new PBDocRef(segments[segments.length - 2], segments[segments.length - 1]);
            }
            return new PBDocRef(segments[0], null);
        };

        const query = (collectionRef, ...constraints) => {
            const q = new PBQuery(collectionRef);
            q.constraints = constraints.filter(c => c instanceof PBQueryConstraint);
            return q;
        };

        const where = (field, op, value) => new PBQueryConstraint('where', { field, op, value });
        const orderBy = (field, direction = 'asc') => new PBQueryConstraint('orderBy', { field, direction });
        const limit = (n) => new PBQueryConstraint('limit', { count: n });
        const startAfter = (docSnap) => new PBQueryConstraint('startAfter', { doc: docSnap });

        // ‚îÄ‚îÄ Filter/Sort builders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const _buildFilter = (constraints) => {
            const wheres = constraints.filter(c => c.type === 'where');
            if (wheres.length === 0) return '';
            return wheres.map(w => {
                const { field, op, value } = w.data;
                const pbOp = { '==': '=', '!=': '!=', '<': '<', '<=': '<=', '>': '>', '>=': '>=' }[op] || '=';
                let pbValue;
                if (value === null || value === undefined) { pbValue = 'null'; }
                else if (value instanceof PBTimestamp) { pbValue = `"${value.toDate().toISOString().replace('T', ' ')}"`; }
                else if (value instanceof Date) { pbValue = `"${value.toISOString().replace('T', ' ')}"`; }
                else if (typeof value === 'string') { pbValue = `"${value.replace(/"/g, '\\"')}"`; }
                else if (typeof value === 'boolean') { pbValue = value.toString(); }
                else { pbValue = value.toString(); }
                return `${field} ${pbOp} ${pbValue}`;
            }).join(' && ');
        };

        const _buildSort = (constraints) => {
            const orders = constraints.filter(c => c.type === 'orderBy');
            if (orders.length === 0) return '-created';
            return orders.map(o => {
                let f = o.data.field;
                if (f === 'createdAt') f = 'created';
                else if (f === 'updatedAt') f = 'updated';
                return o.data.direction === 'desc' ? `-${f}` : f;
            }).join(',');
        };

        const _getLimit = (constraints) => {
            const l = constraints.find(c => c.type === 'limit');
            return l ? l.data.count : 500;
        };

        // ‚îÄ‚îÄ Data preparation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const _prepareData = (data) => {
            const clean = {};
            for (const [key, value] of Object.entries(data)) {
                if (key.includes('.')) continue; // dot-notation handled separately
                if (value && value._isServerTimestamp) { clean[key] = new Date().toISOString(); }
                else if (value && value._isIncrement) { clean[key] = value; }
                else if (value instanceof PBTimestamp) { clean[key] = value.toDate().toISOString(); }
                else if (value instanceof Date) { clean[key] = value.toISOString(); }
                else { clean[key] = value; }
            }
            return clean;
        };

        const _handleDotNotation = async (collectionName, docId, data) => {
            const dotKeys = Object.keys(data).filter(k => k.includes('.'));
            if (dotKeys.length === 0) return null;
            const current = await pb.collection(collectionName).getOne(docId);
            const merged = { ...current };
            for (const dotKey of dotKeys) {
                const parts = dotKey.split('.');
                let target = merged;
                for (let i = 0; i < parts.length - 1; i++) {
                    if (!target[parts[i]] || typeof target[parts[i]] !== 'object') target[parts[i]] = {};
                    target = target[parts[i]];
                }
                let val = data[dotKey];
                if (val && val._isServerTimestamp) val = new Date().toISOString();
                else if (val instanceof PBTimestamp) val = val.toDate().toISOString();
                else if (val instanceof Date) val = val.toISOString();
                target[parts[parts.length - 1]] = val;
            }
            // Return only the top-level keys that were modified
            const topKeys = [...new Set(dotKeys.map(k => k.split('.')[0]))];
            const result = {};
            for (const tk of topKeys) { result[tk] = merged[tk]; }
            return result;
        };

        // ‚îÄ‚îÄ CRUD Operations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const getDoc = async (docRef) => {
            try {
                const record = await pb.collection(docRef.collectionName).getOne(docRef.id);
                return new PBDocumentSnapshot(record, docRef.collectionName);
            } catch (err) {
                if (err.status === 404) return new PBDocumentSnapshot(null, docRef.collectionName);
                throw err;
            }
        };

        const getDocs = async (queryOrRef) => {
            const q = (queryOrRef && queryOrRef._isPBQuery) ? queryOrRef : new PBQuery(queryOrRef);
            const filter = _buildFilter(q.constraints);
            const sort = _buildSort(q.constraints);
            const perPage = _getLimit(q.constraints);
            try {
                const result = await pb.collection(q.collectionName).getList(1, perPage, {
                    filter: filter || undefined,
                    sort: sort || undefined,
                });
                return new PBQuerySnapshot(result.items, q.collectionName);
            } catch (err) {
                console.error('getDocs error:', q.collectionName, err);
                return new PBQuerySnapshot([], q.collectionName);
            }
        };

        const addDoc = async (collectionRef, data) => {
            const cleanData = _prepareData(data);
            const record = await pb.collection(collectionRef.collectionName).create(cleanData);
            return new PBDocRef(collectionRef.collectionName, record.id);
        };

        const setDoc = async (docRef, data, options = {}) => {
            const cleanData = _prepareData(data);
            if (docRef.id) {
                try {
                    await pb.collection(docRef.collectionName).getOne(docRef.id);
                    await pb.collection(docRef.collectionName).update(docRef.id, cleanData);
                } catch (e) {
                    if (e.status === 404) {
                        cleanData.id = docRef.id;
                        await pb.collection(docRef.collectionName).create(cleanData);
                    } else { throw e; }
                }
            } else {
                const record = await pb.collection(docRef.collectionName).create(cleanData);
                // Update ref with the new ID so callers can reference it
                docRef.id = record.id;
                docRef.path = `${docRef.collectionName}/${record.id}`;
            }
        };

        const updateDoc = async (docRef, data) => {
            let cleanData = _prepareData(data);
            // Handle dot-notation for nested field updates
            const dotMerged = await _handleDotNotation(docRef.collectionName, docRef.id, data);
            if (dotMerged) Object.assign(cleanData, dotMerged);
            // Handle increment
            const hasIncrement = Object.values(cleanData).some(v => v && v._isIncrement);
            if (hasIncrement) {
                const current = await pb.collection(docRef.collectionName).getOne(docRef.id);
                for (const [key, value] of Object.entries(cleanData)) {
                    if (value && value._isIncrement) {
                        cleanData[key] = (current[key] || 0) + value.value;
                    }
                }
            }
            await pb.collection(docRef.collectionName).update(docRef.id, cleanData);
        };

        const deleteDoc = async (docRef) => {
            await pb.collection(docRef.collectionName).delete(docRef.id);
        };

        const serverTimestamp = () => ({ _isServerTimestamp: true, toDate: () => new Date(), seconds: Math.floor(Date.now() / 1000), nanoseconds: 0 });
        const increment = (n) => ({ _isIncrement: true, value: n });

        // ‚îÄ‚îÄ Real-time Subscriptions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const _subCallbacks = {};
        let _subCounter = 0;

        const _subscribeCollection = (collectionName, callback) => {
            const id = ++_subCounter;
            const key = `col_${collectionName}`;
            if (!_subCallbacks[key]) {
                _subCallbacks[key] = new Map();
                pb.collection(collectionName).subscribe('*', (e) => {
                    const cbs = _subCallbacks[key];
                    if (cbs) for (const cb of cbs.values()) cb(e);
                }).catch(err => console.warn('Subscribe error:', collectionName, err));
            }
            _subCallbacks[key].set(id, callback);
            return () => {
                if (_subCallbacks[key]) {
                    _subCallbacks[key].delete(id);
                    if (_subCallbacks[key].size === 0) {
                        pb.collection(collectionName).unsubscribe('*').catch(() => {});
                        delete _subCallbacks[key];
                    }
                }
            };
        };

        const _subscribeDoc = (collectionName, docId, callback) => {
            const id = ++_subCounter;
            const key = `doc_${collectionName}_${docId}`;
            if (!_subCallbacks[key]) {
                _subCallbacks[key] = new Map();
                pb.collection(collectionName).subscribe(docId, (e) => {
                    const cbs = _subCallbacks[key];
                    if (cbs) for (const cb of cbs.values()) cb(e);
                }).catch(err => console.warn('Subscribe doc error:', collectionName, docId, err));
            }
            _subCallbacks[key].set(id, callback);
            return () => {
                if (_subCallbacks[key]) {
                    _subCallbacks[key].delete(id);
                    if (_subCallbacks[key].size === 0) {
                        pb.collection(collectionName).unsubscribe(docId).catch(() => {});
                        delete _subCallbacks[key];
                    }
                }
            };
        };

        const onSnapshot = (refOrQuery, callback, errorCallback) => {
            // Document listener
            if (refOrQuery && refOrQuery._isPBDocRef) {
                const { collectionName, id: docId } = refOrQuery;
                let cancelled = false;
                // Initial fetch
                pb.collection(collectionName).getOne(docId).then(record => {
                    if (!cancelled) callback(new PBDocumentSnapshot(record, collectionName));
                }).catch(err => {
                    if (!cancelled) {
                        if (err.status === 404) callback(new PBDocumentSnapshot(null, collectionName));
                        else if (errorCallback) errorCallback(err);
                    }
                });
                // Subscribe
                const unsub = _subscribeDoc(collectionName, docId, (e) => {
                    if (cancelled) return;
                    if (e.action === 'delete') callback(new PBDocumentSnapshot(null, collectionName));
                    else callback(new PBDocumentSnapshot(e.record, collectionName));
                });
                return () => { cancelled = true; unsub(); };
            }

            // Query / Collection listener
            const q = (refOrQuery && refOrQuery._isPBQuery) ? refOrQuery : new PBQuery(refOrQuery);
            let cancelled = false;

            const fetchAndNotify = async () => {
                if (cancelled) return;
                try {
                    const filter = _buildFilter(q.constraints);
                    const sort = _buildSort(q.constraints);
                    const perPage = _getLimit(q.constraints);
                    console.log(`üì° onSnapshot fetch [${q.collectionName}]:`, { filter: filter || '(none)', sort, perPage });
                    const result = await pb.collection(q.collectionName).getList(1, perPage, {
                        filter: filter || undefined,
                        sort: sort || undefined,
                    });
                    console.log(`‚úÖ onSnapshot result [${q.collectionName}]:`, result.totalItems, 'items');
                    if (!cancelled) callback(new PBQuerySnapshot(result.items, q.collectionName));
                } catch (err) {
                    console.error(`‚ùå onSnapshot fetch error [${q.collectionName}]:`, err.message, err.status, err);
                    if (!cancelled && errorCallback) errorCallback(err);
                    else if (!cancelled) {
                        // üîß FIX: Panggil callback dengan empty snapshot agar nested listeners tetap terbentuk
                        // (misal: jika master_qc_functional_items tidak ada di PocketBase, owner items tetap muncul)
                        console.warn(`‚ö†Ô∏è onSnapshot error [${q.collectionName}] ‚Üí returning empty snapshot. Error: ${err.message}`);
                        callback(new PBQuerySnapshot([], q.collectionName));
                    }
                }
            };

            // Initial fetch
            fetchAndNotify();
            // Subscribe to changes
            const unsub = _subscribeCollection(q.collectionName, () => { fetchAndNotify(); });
            return () => { cancelled = true; unsub(); };
        };

        // ‚îÄ‚îÄ WriteBatch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        class PBWriteBatch {
            constructor() { this.operations = []; }
            set(docRef, data) { this.operations.push({ type: 'set', ref: docRef, data }); }
            update(docRef, data) { this.operations.push({ type: 'update', ref: docRef, data }); }
            delete(docRef) { this.operations.push({ type: 'delete', ref: docRef }); }
            async commit() {
                for (const op of this.operations) {
                    if (op.type === 'set') {
                        if (op.ref.id) {
                            await setDoc(op.ref, op.data);
                        } else {
                            await addDoc(new PBCollectionRef(op.ref.collectionName), op.data);
                        }
                    } else if (op.type === 'update') {
                        await updateDoc(op.ref, op.data);
                    } else if (op.type === 'delete') {
                        await deleteDoc(op.ref);
                    }
                }
            }
        }
        const writeBatch = (dbArg) => new PBWriteBatch();

        // ‚îÄ‚îÄ runTransaction ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const runTransaction = async (dbArg, updateFn) => {
            const txn = {
                _ops: [],
                async get(docRef) {
                    const record = await pb.collection(docRef.collectionName).getOne(docRef.id);
                    return new PBDocumentSnapshot(record, docRef.collectionName);
                },
                set(docRef, data) { this._ops.push({ type: 'set', ref: docRef, data }); },
                update(docRef, data) { this._ops.push({ type: 'update', ref: docRef, data }); },
                delete(docRef) { this._ops.push({ type: 'delete', ref: docRef }); },
            };
            await updateFn(txn);
            for (const op of txn._ops) {
                if (op.type === 'set') await setDoc(op.ref, op.data);
                else if (op.type === 'update') await updateDoc(op.ref, op.data);
                else if (op.type === 'delete') await deleteDoc(op.ref);
            }
        };

        // ‚îÄ‚îÄ Aggregation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const getAggregateFromServer = async (queryOrRef, aggregations) => {
            const snapshot = await getDocs(queryOrRef);
            const result = {};
            for (const [key, agg] of Object.entries(aggregations)) {
                if (agg._type === 'count') {
                    result[key] = snapshot.size;
                } else if (agg._type === 'sum') {
                    result[key] = snapshot.docs.reduce((s, d) => s + (d.data()[agg._field] || 0), 0);
                }
            }
            return { data: () => result };
        };
        const count = () => ({ _type: 'count' });
        const sum = (field) => ({ _type: 'sum', _field: field });

        // ‚îÄ‚îÄ Auth Layer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üîê Admin credentials cache for tenant creation (set during developer admin login)
        let _pbAdminCredentials = null;
        let _pbAdminTokenCache = null;

        // Helper: Get a valid admin token (cached or fresh)
        // Hardcoded fallback admin credentials (always available regardless of who is logged in)
        const _PB_ADMIN_FALLBACK = { identity: 'admin@kasir.com', password: 'IFixPro@Admin2024' };

        const getAdminToken = async () => {
            // Try cached token first (check if still valid)
            if (_pbAdminTokenCache) {
                try {
                    const resp = await fetch(`${POCKETBASE_URL}/api/admins/auth-refresh`, {
                        method: 'POST',
                        headers: { 'Authorization': _pbAdminTokenCache }
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        _pbAdminTokenCache = data.token;
                        return _pbAdminTokenCache;
                    }
                } catch (e) { /* token expired, get fresh one */ }
                _pbAdminTokenCache = null;
            }
            // Try stored credentials (set when developer logs in)
            const credsList = [];
            if (_pbAdminCredentials) credsList.push(_pbAdminCredentials);
            // Always include hardcoded fallback
            credsList.push(_PB_ADMIN_FALLBACK);

            for (const creds of credsList) {
                try {
                    const resp = await fetch(`${POCKETBASE_URL}/api/admins/auth-with-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ identity: creds.identity || creds.email, password: creds.password })
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        _pbAdminTokenCache = data.token;
                        console.log('‚úÖ Admin token obtained');
                        return _pbAdminTokenCache;
                    }
                } catch (e) { console.warn('‚ö†Ô∏è Admin token attempt failed:', e.message); }
            }
            console.warn('‚ö†Ô∏è getAdminToken: all attempts failed, returning null');
            return null;
        };

        let app = {};
        let db = {};
        let auth = {
            currentUser: null,
            _listeners: [],
            // Method-style signOut (for getAuth().signOut() pattern)
            async signOut() {
                pb.authStore.clear();
                this.currentUser = null;
                this._listeners.forEach(cb => cb(null));
            }
        };

        const initializeApp = (config, name) => {
            if (name) return { _isSecondary: true, name };
            return app;
        };
        const deleteApp = async (appInst) => {};
        const getAuth = (appInst) => {
            if (appInst && appInst._isSecondary) return { _isSecondary: true, currentUser: null };
            return auth;
        };
        const getFirestore = (appInst) => db;

        const signInWithEmailAndPassword = async (authInst, email, password) => {
            try {
                console.log('üîê PocketBase login attempt:', email);
                const authData = await pb.collection('users').authWithPassword(email, password);
                console.log('‚úÖ PocketBase login success:', authData.record.id);

                // ‚îÄ‚îÄ Cek domain restriction sebelum auth listeners diaktifkan ‚îÄ‚îÄ
                const isMainDomain = !window.DETECTED_SUBDOMAIN;
                const isDeveloper = email.toLowerCase() === DEVELOPER_EMAIL.toLowerCase();

                if (isMainDomain && !isDeveloper) {
                    // Tenant mencoba login di main domain ‚Üí cari subdomain lalu blokir
                    let ownerSubdomain = null;
                    let ownerName = null;
                    try {
                        const ownerRes = await pb.collection('owners').getList(1, 1, { filter: `email = "${email.replace(/"/g, '')}"` });
                        if (ownerRes.items.length > 0) {
                            ownerSubdomain = ownerRes.items[0].subdomain || null;
                            ownerName = ownerRes.items[0].name || null;
                        }
                    } catch(e) { console.warn('‚ö†Ô∏è Owner lookup:', e.message); }
                    pb.authStore.clear();
                    const err = new Error('WRONG_DOMAIN_TENANT');
                    err.code = 'auth/wrong-domain-tenant';
                    err.ownerSubdomain = ownerSubdomain;
                    err.ownerName = ownerName || email;
                    throw err;
                }

                if (!isMainDomain && isDeveloper) {
                    // Developer mencoba login di subdomain tenant ‚Üí blokir
                    pb.authStore.clear();
                    const err = new Error('WRONG_DOMAIN_DEV');
                    err.code = 'auth/wrong-domain-dev';
                    throw err;
                }

                const user = { uid: authData.record.id, email: authData.record.email, isAnonymous: false };
                if (!authInst._isSecondary) {
                    authInst.currentUser = user;
                    authInst._listeners.forEach(cb => cb(user));
                }
                // üîê For developer: also try to get admin token in background for tenant creation
                if (email.toLowerCase() === DEVELOPER_EMAIL.toLowerCase()) {
                    try {
                        const adminResp = await fetch(POCKETBASE_URL + '/api/admins/auth-with-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ identity: email, password: password })
                        });
                        if (adminResp.ok) {
                            const adminData = await adminResp.json();
                            _pbAdminCredentials = { email, password };
                            _pbAdminTokenCache = adminData.token;
                            console.log('‚úÖ Admin token cached for tenant management');
                        }
                    } catch (e) { /* admin password may differ from user password */ }
                }
                return { user };
            } catch (err) {
                // Re-throw domain restriction errors langsung - jangan diproses sebagai generic error
                if (err.code && err.code.startsWith('auth/wrong-domain')) throw err;

                // üîê DEVELOPER FALLBACK: Try PocketBase admin auth for developer email
                if (email.toLowerCase() === DEVELOPER_EMAIL.toLowerCase()) {
                    console.log('üîê Trying PocketBase admin auth fallback for developer...');
                    try {
                        const adminResponse = await fetch(POCKETBASE_URL + '/api/admins/auth-with-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ identity: email, password: password })
                        });
                        if (adminResponse.ok) {
                            const adminData = await adminResponse.json();
                            console.log('‚úÖ PocketBase admin auth success!');

                            // Cek domain: developer tidak boleh login di subdomain
                            if (window.DETECTED_SUBDOMAIN) {
                                const errD = new Error('WRONG_DOMAIN_DEV');
                                errD.code = 'auth/wrong-domain-dev';
                                throw errD;
                            }

                            // üîê Cache admin credentials & token for tenant creation
                            _pbAdminCredentials = { email: email, password: password };
                            _pbAdminTokenCache = adminData.token;
                            // Save admin token to authStore - override email with developer email for profile matching
                            const adminModel = { ...adminData.admin, email: email };
                            pb.authStore.save(adminData.token, adminModel);
                            const user = { uid: 'admin_' + adminData.admin.id, email: email, isAnonymous: false };
                            if (!authInst._isSecondary) {
                                authInst.currentUser = user;
                                authInst._listeners.forEach(cb => cb(user));
                            }
                            // Also sync the developer user in users collection for future direct login
                            try {
                                // Try to find existing user by email
                                const existingUsers = await pb.collection('users').getFullList({ filter: `email = "${email}"` });
                                if (existingUsers.length > 0) {
                                    // Update password for existing developer user
                                    await pb.collection('users').update(existingUsers[0].id, {
                                        password: password,
                                        passwordConfirm: password,
                                        verified: true,
                                        emailVisibility: true,
                                        role: 'developer'
                                    });
                                    console.log('‚úÖ Developer user password synced');
                                } else {
                                    // Create developer user for future direct login
                                    await pb.collection('users').create({
                                        email: email,
                                        password: password,
                                        passwordConfirm: password,
                                        verified: true,
                                        emailVisibility: true,
                                        role: 'developer',
                                        name: 'Developer Admin'
                                    });
                                    console.log('‚úÖ Developer user auto-created');
                                }
                            } catch (syncErr) {
                                console.warn('‚ö†Ô∏è Could not sync developer user:', syncErr.message);
                            }
                            return { user };
                        }
                    } catch (adminErr) {
                        // Re-throw domain restriction errors - jangan ditelan
                        if (adminErr.code && adminErr.code.startsWith('auth/wrong-domain')) throw adminErr;
                        console.warn('‚ö†Ô∏è Admin auth fallback failed:', adminErr.message);
                    }
                }

                console.error('‚ùå PocketBase login error:', {
                    status: err.status,
                    message: err.message,
                    data: err.data,
                    url: err.url,
                    isAbort: err.isAbort,
                    originalError: err
                });
                
                // Detailed error mapping
                let code = 'auth/network-request-failed';
                let message = err.message || 'Login failed';
                
                // Network/CORS errors (no status code)
                if (!err.status || err.isAbort) {
                    code = 'auth/network-request-failed';
                    message = `Tidak dapat terhubung ke server PocketBase di ${POCKETBASE_URL}. Pastikan:\n1. Server PocketBase berjalan\n2. Port 8090 terbuka\n3. CORS dikonfigurasi dengan benar`;
                    console.error('üí° Troubleshooting:', {
                        serverUrl: POCKETBASE_URL,
                        suggestion: 'Run on VPS: ./pocketbase serve --http="0.0.0.0:8090"'
                    });
                } 
                // HTTP error codes
                else if (err.status === 400) {
                    const msg = err.message?.toLowerCase() || '';
                    if (msg.includes('password') || msg.includes('credentials')) {
                        code = 'auth/wrong-password';
                        message = 'Password salah';
                    } else if (msg.includes('user') || msg.includes('email') || msg.includes('not found')) {
                        code = 'auth/user-not-found';
                        message = 'Akun tidak ditemukan';
                    } else {
                        code = 'auth/invalid-credential';
                        message = 'Email atau password salah';
                    }
                } else if (err.status === 404) {
                    code = 'auth/user-not-found';
                    message = 'Akun tidak ditemukan';
                } else if (err.status === 403) {
                    code = 'auth/access-denied';
                    message = 'Akses ditolak';
                }
                
                const e = new Error(message);
                e.code = code;
                throw e;
            }
        };

        const createUserWithEmailAndPassword = async (authInst, email, password) => {
            try {
                console.log('Creating user with email:', email);
                
                // Strategy: Use admin API to create user with verified=true directly
                const adminToken = await getAdminToken();
                
                if (adminToken) {
                    // üîê Admin API: create user with verified=true in one step
                    console.log('üì° Creating user via Admin API (verified=true)...');
                    const resp = await fetch(`${POCKETBASE_URL}/api/collections/users/records`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': adminToken
                        },
                        body: JSON.stringify({
                            email: email,
                            password: password,
                            passwordConfirm: password,
                            emailVisibility: true,
                            verified: true
                        })
                    });
                    
                    if (resp.ok) {
                        const record = await resp.json();
                        console.log('‚úÖ User created with verified=true:', record.id);
                        return { user: { uid: record.id, email: record.email } };
                    }
                    
                    // Handle API errors
                    const errData = await resp.json().catch(() => ({}));
                    console.error('‚ùå Admin API create failed:', resp.status, errData);
                    
                    // Check for duplicate email
                    const errStr = JSON.stringify(errData).toLowerCase();
                    if (resp.status === 400 && (errStr.includes('already') || errStr.includes('unique'))) {
                        const e = new Error('Email ini sudah terdaftar.');
                        e.code = 'auth/email-already-in-use';
                        throw e;
                    }
                    // Check for password validation
                    if (resp.status === 400 && errStr.includes('password')) {
                        const e = new Error('Password harus minimal 8 karakter.');
                        e.code = 'auth/weak-password';
                        throw e;
                    }
                    // Other admin API error - throw
                    const e = new Error(errData.message || 'Gagal membuat user via Admin API');
                    e.code = 'auth/unknown';
                    throw e;
                }
                
                // Fallback: No admin token available - create via SDK (verified=false)
                console.warn('‚ö†Ô∏è No admin token - creating user without verified flag');
                const record = await pb.collection('users').create({
                    email: email,
                    password: password,
                    passwordConfirm: password,
                    emailVisibility: true,
                });
                console.log('‚úÖ User created (verified=false):', record.id);
                
                // üîß FIX: Try to auto-verify using developer admin credentials
                try {
                    if (email.toLowerCase() !== DEVELOPER_EMAIL.toLowerCase()) {
                        console.log('üîß Attempting to auto-verify user...');
                        // Try admin auth with developer credentials to verify user
                        const adminResp = await fetch(POCKETBASE_URL + '/api/admins/auth-with-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                identity: 'admin@kasir.com', 
                                password: 'IFixPro@Admin2024' 
                            })
                        });
                        if (adminResp.ok) {
                            const adminData = await adminResp.json();
                            // Update user to verified
                            const verifyResp = await fetch(`${POCKETBASE_URL}/api/collections/users/records/${record.id}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': adminData.token
                                },
                                body: JSON.stringify({ verified: true })
                            });
                            if (verifyResp.ok) {
                                console.log('‚úÖ User auto-verified successfully!');
                            } else {
                                console.warn('‚ö†Ô∏è Auto-verify failed, user needs manual verification');
                            }
                        }
                    }
                } catch (verifyErr) {
                    console.warn('‚ö†Ô∏è Auto-verify failed:', verifyErr.message);
                    console.warn('üí° User perlu di-verify manual via login-troubleshoot.html');
                }
                
                return { user: { uid: record.id, email: record.email } };
                
            } catch (err) {
                // Re-throw if already has error code
                if (err.code) throw err;
                
                console.error('‚ùå createUserWithEmailAndPassword error:', err);
                
                const msg = (err.message || '').toLowerCase();
                const dataStr = JSON.stringify(err.data || {}).toLowerCase();
                
                if (err.status === 400 && (msg.includes('already') || msg.includes('unique') || 
                    dataStr.includes('email') && (dataStr.includes('already') || dataStr.includes('unique')))) {
                    const e = new Error('Email ini sudah terdaftar.');
                    e.code = 'auth/email-already-in-use';
                    e.originalError = err;
                    throw e;
                }
                
                if (err.status === 400 && (msg.includes('password') || dataStr.includes('password'))) {
                    const e = new Error('Password harus minimal 8 karakter.');
                    e.code = 'auth/weak-password';
                    e.originalError = err;
                    throw e;
                }
                
                const e = new Error(err.message || 'Gagal membuat user: ' + JSON.stringify(err.data));
                e.code = 'auth/unknown';
                e.originalError = err;
                throw e;
            }
        };

        // Helper: find existing user by email
        const findUserByEmail = async (email) => {
            try {
                // Try using admin token (if available) for reliable email filtering
                const result = await pb.collection('users').getList(1, 1, {
                    filter: `email = "${email.replace(/"/g, '\\"')}"`
                });
                return result.items.length > 0 ? result.items[0] : null;
            } catch (err) {
                console.warn('findUserByEmail filter failed, trying getFullList...', err.message);
                // Fallback: get all users and filter client-side
                try {
                    const all = await pb.collection('users').getFullList({ fields: 'id,email,name,role,ownerId,storeId' });
                    return all.find(u => u.email === email) || null;
                } catch (err2) {
                    console.warn('findUserByEmail fallback also failed:', err2.message);
                    return null;
                }
            }
        };

        const signOut = async (authInst) => {
            if (!authInst._isSecondary) {
                pb.authStore.clear();
                authInst.currentUser = null;
                authInst._listeners.forEach(cb => cb(null));
            }
        };

        const signInAnonymously = async (authInst) => {
            const user = { uid: 'anonymous_' + Date.now(), email: null, isAnonymous: true };
            auth.currentUser = user;
            return { user };
        };

        const onAuthStateChanged = (authInst, callback) => {
            // Initial state
            if (pb.authStore.isValid && pb.authStore.model) {
                const user = { uid: pb.authStore.model.id, email: pb.authStore.model.email, isAnonymous: false };
                authInst.currentUser = user;
                setTimeout(() => callback(user), 0);
            } else {
                authInst.currentUser = null;
                setTimeout(() => callback(null), 0);
            }
            // Listen for changes
            authInst._listeners.push(callback);
            const pbUnsub = pb.authStore.onChange((token, model) => {
                if (model) {
                    const user = { uid: model.id, email: model.email, isAnonymous: false };
                    authInst.currentUser = user;
                    callback(user);
                } else {
                    authInst.currentUser = null;
                    callback(null);
                }
            });
            return () => {
                const idx = authInst._listeners.indexOf(callback);
                if (idx >= 0) authInst._listeners.splice(idx, 1);
                if (typeof pbUnsub === 'function') pbUnsub();
            };
        };

        const setPersistence = async () => {};
        const browserLocalPersistence = {};
        const browserSessionPersistence = {};

        const updatePassword = async (user, newPassword) => {
            if (pb.authStore.model) {
                await pb.collection('users').update(pb.authStore.model.id, {
                    password: newPassword, passwordConfirm: newPassword
                });
            }
        };

        const reauthenticateWithCredential = async (user, credential) => {
            await pb.collection('users').authWithPassword(credential.email, credential.password);
        };

        const EmailAuthProvider = {
            credential(email, password) { return { email, password }; }
        };

        const enableIndexedDbPersistence = async () => {
            console.log('‚ÑπÔ∏è PocketBase menggunakan localStorage untuk auth persistence');
        };

        // ‚îÄ‚îÄ Verify adapter loaded ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        console.log('üîß PocketBase adapter check:', {
            query: typeof query,
            where: typeof where,
            collection: typeof collection,
            onSnapshot: typeof onSnapshot
        });

        if (typeof query !== 'function') {
            console.error('‚ùå PocketBase adapter failed!');
            throw new Error('PocketBase adapter import failed');
        }

        // ==========================================
        // Wrapper untuk protect dari breaking changes
        // ==========================================
        const FirebaseAPI = {
            async safeGetDoc(ref) {
                try { return await getDoc(ref); }
                catch (error) { console.error('‚ö†Ô∏è getDoc error:', error); throw error; }
            },
            async safeSetDoc(ref, data, options) {
                try { return await setDoc(ref, data, options); }
                catch (error) { console.error('‚ö†Ô∏è setDoc error:', error); throw error; }
            },
            async safeAddDoc(collectionRef, data) {
                try { return await addDoc(collectionRef, data); }
                catch (error) { console.error('‚ö†Ô∏è addDoc error:', error); throw error; }
            },
            async safeGetDocs(queryRef) {
                try { return await getDocs(queryRef); }
                catch (error) { console.error('‚ö†Ô∏è getDocs error:', error); throw error; }
            },
            async safeUpdateDoc(ref, data) {
                try { return await updateDoc(ref, data); }
                catch (error) { console.error('‚ö†Ô∏è updateDoc error:', error); throw error; }
            },
            async safeDeleteDoc(ref) {
                try { return await deleteDoc(ref); }
                catch (error) { console.error('‚ö†Ô∏è deleteDoc error:', error); throw error; }
            },
            async safeSignIn(email, password) {
                try { return await signInWithEmailAndPassword(auth, email, password); }
                catch (error) {
                    console.error('‚ö†Ô∏è signIn error:', error);
                    if (error.code === 'auth/wrong-password') throw new Error('Password salah');
                    else if (error.code === 'auth/user-not-found') throw new Error('User tidak ditemukan');
                    else if (error.code === 'auth/too-many-requests') throw new Error('Terlalu banyak percobaan. Coba lagi nanti.');
                    throw error;
                }
            },
            getVersionInfo() {
                return { pocketbase: '0.21.1', react: '18.2.0', status: 'locked', lastVerified: '2026-02-16', backend: POCKETBASE_URL };
            }
        };

        console.log('üõ°Ô∏è PocketBase Protection Layer Active:', FirebaseAPI.getVersionInfo());

        // ==========================================
        // üöÄ OPTIMIZATION UTILITIES (PocketBase)
        // ==========================================
        
        const debounce = (func, wait = 500) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const batchDelete = async (refs, batchSize = 500) => {
            const promises = [];
            for (const ref of refs) {
                promises.push(deleteDoc(ref));
            }
            // Execute in chunks
            const chunks = [];
            for (let i = 0; i < promises.length; i += batchSize) {
                chunks.push(Promise.all(promises.slice(i, i + batchSize)));
            }
            for (const chunk of chunks) { await chunk; }
        };

        const batchUpdate = async (updates, batchSize = 500) => {
            const promises = [];
            for (const { ref, data } of updates) {
                promises.push(updateDoc(ref, data));
            }
            const chunks = [];
            for (let i = 0; i < promises.length; i += batchSize) {
                chunks.push(Promise.all(promises.slice(i, i + batchSize)));
            }
            for (const chunk of chunks) { await chunk; }
        };

        const polling = (fetchFn, callback, interval = 60000) => {
            let timeoutId;
            let isCancelled = false;
            const poll = async () => {
                if (isCancelled) return;
                try {
                    const data = await fetchFn();
                    if (!isCancelled) callback(data);
                } catch (error) { console.error('Polling error:', error); }
                if (!isCancelled) timeoutId = setTimeout(poll, interval);
            };
            poll();
            return () => { isCancelled = true; if (timeoutId) clearTimeout(timeoutId); };
        };

        const collectionCache = new Map();
        const CACHE_TTL = 5 * 60 * 1000;

        const fetchWithCache = async (cacheKey, fetchFn, ttl = CACHE_TTL) => {
            const cached = collectionCache.get(cacheKey);
            const now = Date.now();
            if (cached && (now - cached.timestamp) < ttl) {
                console.log(`üì¶ Cache hit: ${cacheKey}`);
                return cached.data;
            }
            console.log(`üåê Cache miss: ${cacheKey}, fetching...`);
            const data = await fetchFn();
            collectionCache.set(cacheKey, { data, timestamp: now });
            return data;
        };

        console.log('‚úÖ PocketBase Optimization Utilities Loaded');

        // ==========================================
        // ‚öôÔ∏è OPTIMIZATION CONFIG
        // ==========================================
        const FIREBASE_OPTIMIZATION_CONFIG = {
            POLLING_STATIC_DATA: 60000,
            POLLING_SEMI_STATIC: 30000,
            POLLING_ACTIVE_DATA: 10000,
            MEMORY_CACHE_TTL: 5 * 60 * 1000,
            DEFAULT_QUERY_LIMIT: 25,
            MAX_QUERY_LIMIT: 100,
            BATCH_SIZE: 500,
            SEARCH_DEBOUNCE: 500,
            INPUT_DEBOUNCE: 300,
        };

        console.log('‚öôÔ∏è Optimization Config:', FIREBASE_OPTIMIZATION_CONFIG);

        // ==========================================
        // üîå POCKETBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = { projectId: 'pocketbase-local' }; // kept for backward compat references

        // PocketBase sudah diinisialisasi di atas
        console.log('‚úÖ PocketBase initialized successfully at', POCKETBASE_URL);
        
        // Auth persistence handled by PocketBase localStorage automatically
        console.log('‚úÖ PocketBase Auth Persistence AKTIF via localStorage');

        // ==========================================
        // üßπ CLEANUP & ERROR RECOVERY
        // ==========================================
        window.firestoreListeners = new Set();
        
        // Global error handler for PocketBase errors
        window.addEventListener('error', (event) => {
            if (event.error && event.error.message && event.error.message.includes('PocketBase')) {
                console.warn('üî¥ PocketBase error suppressed:', event.error.message);
                event.preventDefault();
                return false;
            }
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            if (event.reason && event.reason.message && (event.reason.message.includes('PocketBase') || event.reason.message.includes('autocancelled'))) {
                console.warn('üî¥ PocketBase rejection suppressed:', event.reason.message);
                event.preventDefault();
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            // Cleanup all active listeners
            if (window.firestoreListeners) {
                window.firestoreListeners.forEach(unsubscribe => {
                    try { if (typeof unsubscribe === 'function') unsubscribe(); } catch (e) {}
                });
                window.firestoreListeners.clear();
            }
            // Cleanup PocketBase subscriptions
            try { pb.realtime.unsubscribe(); } catch(e) {}
        });

        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                console.log('üì± Tab hidden - listeners paused');
            } else {
                console.log('üì± Tab visible - listeners active');
            }
        });

        // ==========================================
        // üöÄ PWA SERVICE WORKER REGISTRATION
        // ==========================================
        window.deferredPrompt = null;

        // Check PWA install state
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('PWA: Already installed');
        } else {
            console.log('PWA: Running in browser, installable');
        }

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            window.dispatchEvent(new Event('pwa-installable'));
            console.log('PWA: Install prompt available');
        });

        // Hide button when app is installed
        window.addEventListener('appinstalled', () => {
            window.deferredPrompt = null;
            window.dispatchEvent(new Event('pwa-installed'));
            console.log('PWA: Successfully installed');
        });

        // ==========================================
        // üîß SERVICE WORKER
        // ==========================================
        // Inline Service Worker (no external file needed)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'ifix-pro-v20';
                    const urlsToCache = [
                        '/logo-ifix.png'
                    ];
                    
                    self.addEventListener('install', e => {
                        console.log('SW: Installing v4');
                        e.waitUntil(
                            caches.open(CACHE_NAME).then(cache => {
                                console.log('SW: Caching logo');
                                return cache.addAll(urlsToCache);
                            }).then(() => self.skipWaiting())
                        );
                    });
                    
                    self.addEventListener('activate', e => {
                        console.log('SW: Activating v4');
                        e.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== CACHE_NAME) {
                                            console.log('SW: Deleting old cache:', cacheName);
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            }).then(() => self.clients.claim())
                        );
                    });
                    
                    self.addEventListener('fetch', e => {
                        const url = new URL(e.request.url);
                        
                        // BYPASS Service Worker for external domains & API
                        if (!url.origin.includes(self.location.origin)) {
                            // Don't intercept external requests (PocketBase API, CDN, etc.)
                            return;
                        }
                        
                        // NEVER cache HTML - always fetch from network
                        if (e.request.method === 'GET' && 
                            (e.request.destination === 'document' || 
                             url.pathname.endsWith('.html') || 
                             url.pathname === '/' || 
                             url.pathname === '/index.html')) {
                            e.respondWith(
                                fetch(e.request, { cache: 'no-store' }).catch(() => {
                                    return new Response(
                                        '<h1>Offline</h1><p>Anda sedang offline. Silakan coba lagi saat terhubung ke internet.</p>',
                                        { headers: { 'Content-Type': 'text/html' } }
                                    );
                                })
                            );
                            return;
                        }
                        
                        // Cache-first strategy for logo only
                        if (url.pathname.includes('/logo-ifix.png')) {
                            e.respondWith(
                                caches.match(e.request).then(response => {
                                    return response || fetch(e.request).then(fetchResponse => {
                                        return caches.open(CACHE_NAME).then(cache => {
                                            cache.put(e.request, fetchResponse.clone());
                                            return fetchResponse;
                                        });
                                    });
                                })
                            );
                            return;
                        }
                        
                        // For everything else from same origin (if any), just fetch
                        // Don't cache, don't interfere
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                
                navigator.serviceWorker.register(swUrl).then(reg => {
                    console.log('PWA: Service Worker registered');
                    // Force update pada reload untuk memastikan tidak ada cache lama
                    reg.update();
                }).catch(err => {
                    console.log('PWA: SW registration skipped (OK for development)');
                });
            });
        } else {
            console.log('PWA: Service Worker not supported');
        }

        // Constants
        const DEVELOPER_EMAIL = "agis.cpcd@gmail.com";
        const APP_COLLECTION_PREFIX = "ifix_enterprise_data"; 

        /**
         * üè¢ TENANT-SPECIFIC COLLECTIONS (DISABLED - UNDER DEVELOPMENT)
         * Generate collection name with tenant prefix for data isolation
         * Format: tenant_{ownerId}_{collectionName}
         * 
         * CATATAN: Feature ini di-disable karena memerlukan migration data.
         * Saat ini semua tenant menggunakan shared collections dengan filter ownerId.
         */
        const SYSTEM_COLLECTIONS = ['users', 'owners', 'plan_configs', 'stores', 'store_configs'];
        
        // Global tenant context - not used yet
        let _currentOwnerId = null;
        
        const getTenantCollection = (collectionName, ownerId) => {
            // üî¥ DISABLED: Return collection name without tenant prefix
            // Semua tenant menggunakan shared collections dengan filter ownerId
            return collectionName;
            
            /* FUTURE: Enable tenant-specific collections after migration
            // System-wide collections don't use tenant prefix
            if (SYSTEM_COLLECTIONS.includes(collectionName)) {
                return collectionName;
            }
            // Tenant-specific collections: tenant_{ownerId}_{collectionName}
            const ownerIdToUse = ownerId || _currentOwnerId;
            if (!ownerIdToUse) {
                console.warn(`‚ö†Ô∏è getTenantCollection called without ownerId for ${collectionName}`);
                return collectionName; // fallback to collection without prefix
            }
            return `tenant_${ownerIdToUse}_${collectionName}`;
            */
        };

        // Update tenant context (called when activeOwner changes)
        const setTenantContext = (ownerId) => {
            // üî¥ DISABLED: No-op untuk saat ini
            _currentOwnerId = ownerId;
        };

        // PocketBase ID mapping for plan_configs (PB requires 15-char IDs)
        const _PLAN_CONFIG_IDS = { 'basic': 'basicplan000001', 'pro': 'proplanconf0001' };
        const _planDocId = (planName) => _PLAN_CONFIG_IDS[planName] || planName;

        // Auto-populate plan IDs from PocketBase at startup
        (async () => {
            try {
                const result = await pb.collection('plan_configs').getFullList();
                result.forEach(r => { if (r.plan) _PLAN_CONFIG_IDS[r.plan] = r.id; });
                console.log('‚úÖ Plan config IDs loaded:', _PLAN_CONFIG_IDS);
            } catch(e) { console.warn('‚ö†Ô∏è Could not load plan config IDs:', e.message); }
        })();

        // ==========================================
        // üõ†Ô∏è UTILS
        // ==========================================
        const formatCurrency = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0);
        
        // Number formatter untuk input dengan separator ribuan
        const formatNumberWithSeparator = (value) => {
            if (!value) return '';
            const num = value.toString().replace(/\D/g, '');
            if (!num) return '';
            return new Intl.NumberFormat('id-ID').format(num);
        };
        
        const parseNumberFromInput = (value) => {
            if (!value) return 0;
            return parseInt(value.toString().replace(/\D/g, '')) || 0;
        };

        // ==========================================
        // üìÑ PAGINATION COMPONENT (Reusable)
        // ==========================================
        const Pagination = ({ currentPage, totalPages, totalItems, startIndex, endIndex, onPageChange, itemsPerPage, onItemsPerPageChange }) => {
            if (totalPages <= 1) return null;
            
            return (
                <div className="space-y-4">
                    {/* Items per page controls */}
                    <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                            <div className="flex gap-2">
                                <button onClick={() => onItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                <button onClick={() => onItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                                <button onClick={() => onItemsPerPageChange(50)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 50 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>50</button>
                            </div>
                        </div>
                        <div className="text-sm text-slate-600 font-medium">
                            Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                        </div>
                    </div>
                    
                    {/* Navigation */}
                    <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <button 
                            onClick={() => onPageChange(currentPage - 1)} 
                            disabled={currentPage === 1}
                            className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                        >
                            ‚Üê Sebelumnya
                        </button>
                        <div className="text-sm text-slate-600 font-medium">
                            Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                        </div>
                        <button 
                            onClick={() => onPageChange(currentPage + 1)} 
                            disabled={currentPage === totalPages}
                            className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                        >
                            Selanjutnya ‚Üí
                        </button>
                    </div>
                </div>
            );
        };
        
        // Custom number input component
        const NumberInput = ({ value, onChange, placeholder, className, name, ...props }) => {
            const [displayValue, setDisplayValue] = React.useState('');
            const [numericValue, setNumericValue] = React.useState(0);
            
            React.useEffect(() => {
                if (value || value === 0) {
                    setDisplayValue(formatNumberWithSeparator(value));
                    setNumericValue(value);
                } else {
                    setDisplayValue('');
                    setNumericValue(0);
                }
            }, [value]);
            
            const handleChange = (e) => {
                const input = e.target.value;
                const parsed = parseNumberFromInput(input);
                
                // Update display value dengan separator
                setDisplayValue(formatNumberWithSeparator(parsed));
                setNumericValue(parsed);
                
                // Call onChange dengan angka asli
                if (onChange) {
                    onChange(parsed);
                }
            };
            
            return (
                <>
                    <input
                        type="text"
                        inputMode="numeric"
                        value={displayValue}
                        onChange={handleChange}
                        placeholder={placeholder || '0'}
                        className={className}
                        {...props}
                    />
                    {name && <input type="hidden" name={name} value={numericValue} />}
                </>
            );
        };
        
        const formatDate = (timestamp) => {
          if (!timestamp) return '-';
          let date;
          if (timestamp?.seconds) {
             date = new Date(timestamp.seconds * 1000);
          } else {
             date = new Date(timestamp);
          }
          if (isNaN(date.getTime())) return '-';
          return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        const generateToken = () => Math.random().toString(36).substring(2, 8).toUpperCase();
        
        const STATUS_FLOW = ['Diterima', 'Diagnosa', 'Menunggu Sparepart', 'Selesai', 'Dibatalkan'];

        const formatWhatsAppNumber = (phone) => {
            if (!phone) return '';
            let p = phone.toString().replace(/\D/g, ''); 
            if (p.startsWith('0')) {
                p = '62' + p.substring(1);
            } else if (p.startsWith('8')) {
                p = '62' + p;
            }
            return p;
        };

        const handleShareProgress = (service) => {
            const formattedPhone = formatWhatsAppNumber(service.customerPhone || service.phone);
            
            if (!formattedPhone) {
                alert("‚ö†Ô∏è Nomor WA pelanggan kosong atau tidak valid!");
                return;
            }

            // Build detailed progress message
            const publicLink = `${window.location.origin}${window.location.pathname}?track=${service.id}`;
            
            let progressMessage = `Halo Kak ${service.customerName}! üëã\n\n`;
            progressMessage += `üì± *Update Progress Servis HP*\n`;
            progressMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            progressMessage += `üÜî *Token:* ${service.token}\n`;
            progressMessage += `üì± *HP:* ${service.unitType || service.deviceType || '-'}\n`;
            progressMessage += `üîß *Keluhan:* ${service.complaint || service.problem || '-'}\n`;
            progressMessage += `‚öôÔ∏è *Status:* ${service.status}\n\n`;
            progressMessage += `üí∞ *Biaya Servis:* ${formatCurrency(service.costEstimate)}\n`;
            
            // Add payment status
            const paid = parseFloat(service.dp) || 0;
            const total = parseFloat(service.costEstimate) || 0;
            const remaining = total - paid;
            
            if (service.paymentStatus === 'Lunas') {
                progressMessage += `‚úÖ *Status Bayar:* LUNAS\n\n`;
            } else if (service.paymentStatus === 'DP') {
                progressMessage += `‚è≥ *Status Bayar:* DP ${formatCurrency(paid)}\n`;
                progressMessage += `üí≥ *Sisa Bayar:* ${formatCurrency(remaining)}\n\n`;
            } else {
                progressMessage += `‚è≥ *Status Bayar:* Belum Dibayar\n\n`;
            }
            
            progressMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            progressMessage += `üîó *Cek Progress Realtime:*\n${publicLink}\n\n`;
            progressMessage += `‚ú® Terimakasih telah mempercayakan servis HP kepada kami. Kami berkomitmen memberikan yang terbaik! üôè`;
            
            const encodedMessage = encodeURIComponent(progressMessage);
            const waLink = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            window.open(waLink, '_blank');
        };

        const handleShareInvoiceToWA = async (service) => {
            const formattedPhone = formatWhatsAppNumber(service.customerPhone || service.phone);
            
            if (!formattedPhone) {
                alert("‚ö†Ô∏è Nomor WA pelanggan kosong atau tidak valid!");
                return;
            }

            // Generate invoice image FIRST
            setCaptureData(service);
            
            await new Promise(resolve => setTimeout(resolve, 800));
            
            try {
                const element = document.getElementById('invoice-capture');
                if (!element) {
                    alert("Gagal membuat invoice");
                    setCaptureData(null);
                    return;
                }

                const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true, backgroundColor: '#ffffff' });
                canvas.toBlob(async (blob) => {
                    setCaptureData(null);
                    
                    try {
                        const file = new File([blob], `Invoice-${service.token}.jpg`, { type: 'image/jpeg' });
                        
                        // Use native share API (mobile) - file will be attached, user just tap send
                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                files: [file],
                                title: `Invoice ${service.customerName}`,
                                text: `Invoice servis untuk ${service.customerName}\nToken: ${service.token}`
                            });
                            return;
                        }
                        
                        // Desktop fallback: copy to clipboard then open WhatsApp
                        if (navigator.clipboard && navigator.clipboard.write) {
                            try {
                                const item = new ClipboardItem({ 'image/jpeg': blob });
                                await navigator.clipboard.write([item]);
                                
                                // Open WhatsApp after copying
                                const waLink = `https://wa.me/${formattedPhone}`;
                                window.open(waLink, '_blank');
                                
                                alert('‚úÖ Invoice sudah di-copy!\n\nPaste ke chat WA dengan Ctrl+V atau klik kanan > Paste');
                            } catch (err) {
                                // Fallback: download file
                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(blob);
                                link.download = `Invoice-${service.token}.jpg`;
                                link.click();
                                
                                const waLink = `https://wa.me/${formattedPhone}`;
                                window.open(waLink, '_blank');
                                
                                alert('üì• Invoice sudah di-download!\n\nKirim file dari folder download ke chat WA');
                            }
                        }
                        
                    } catch (err) {
                        console.error('Share error:', err);
                    }
                }, 'image/jpeg', 0.95);
                
            } catch (err) {
                setCaptureData(null);
                console.error('Canvas error:', err);
            }
        };

        const showAccessDenied = (msg = "Akses Ditolak") => {
            alert(`üîí ${msg}`);
        };

        const normalizeFirestoreData = (data) => {
            if (!data) return data;
            if (typeof data === 'object') {
                if (data.seconds !== undefined && data.nanoseconds !== undefined) {
                    return new Date(data.seconds * 1000);
                }
                if (Array.isArray(data)) {
                    return data.map(normalizeFirestoreData);
                }
                const newItem = {};
                Object.keys(data).forEach(key => {
                    newItem[key] = normalizeFirestoreData(data[key]);
                });
                return newItem;
            }
            if (typeof data === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(data)) {
                const d = new Date(data);
                if (!isNaN(d.getTime())) return d;
            }
            return data;
        };

        const recalculateServicePayment = async (serviceId, ownerId) => {
            if (!serviceId) return;
            try {
                const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId);
                const serviceSnap = await getDoc(serviceRef);
                if (!serviceSnap.exists()) return;
                const serviceData = serviceSnap.data();

                const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                const q = query(transRef, where('serviceId', '==', serviceId));
                const transSnap = await getDocs(q);
                
                let totalPaid = 0;
                transSnap.docs.forEach(doc => {
                    const t = doc.data();
                    if (t.type === 'income') totalPaid += (parseFloat(t.amount) || 0);
                });

                let paymentStatus = 'Belum Lunas';
                if (totalPaid >= (serviceData.costEstimate || 0) && (serviceData.costEstimate || 0) > 0) paymentStatus = 'Lunas';
                else if (totalPaid > 0) paymentStatus = 'DP';

                await updateDoc(serviceRef, {
                    dp: totalPaid,
                    paymentStatus: paymentStatus
                });
                console.log(`Service ${serviceId} synced. Total Paid: ${totalPaid}`);
            } catch (err) {
                console.error("Error syncing payment:", err);
            }
        };

        // ==========================================
        // ‚öõÔ∏è CONTEXT & HOOKS
        // ==========================================
        const SessionContext = createContext(null);
        const ToastContext = createContext(null);

        // ==========================================
        // üí∞ GLOBAL CASH ACCOUNTS HOOK & COMPONENT
        // ==========================================
        const useCashAccounts = (ownerId, storeId) => {
            const [cashAccounts, setCashAccounts] = useState([]);
            useEffect(() => {
                if (!ownerId) return;
                const accountsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts');
                let q = query(accountsRef, where('ownerId', '==', ownerId));
                if (storeId && storeId !== 'all') {
                    q = query(accountsRef, where('ownerId', '==', ownerId), where('storeId', '==', storeId));
                }
                const unsub = onSnapshot(q, (snap) => {
                    setCashAccounts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                if (window.firestoreListeners) window.firestoreListeners.add(unsub);
                return () => {
                    if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
                    unsub();
                };
            }, [ownerId, storeId]);
            return ['Kas Tunai', ...cashAccounts.map(a => a.name)];
        };

        const CashAccountSelect = ({ value, onChange, label, className = '' }) => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const accounts = useCashAccounts(activeOwner?.id, activeStore?.id);
            return (
                <div className={className}>
                    <label className="text-xs font-bold text-slate-500 block mb-1">{label || 'Masuk/Keluar dari Kas'}</label>
                    <select value={value || 'Kas Tunai'} onChange={e => onChange(e.target.value)} className="w-full border border-slate-300 p-2 rounded-lg text-sm">
                        {accounts.map(a => <option key={a} value={a}>{a === 'Kas Tunai' ? 'üíµ ' + a : 'üè¶ ' + a}</option>)}
                    </select>
                </div>
            );
        };

        // Toast Notification System
        const Toast = ({ message, type = 'info', duration = 3000, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, duration);
                return () => clearTimeout(timer);
            }, [duration, onClose]);

            const bgColor = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500',
                sync: 'bg-purple-500'
            }[type] || 'bg-blue-500';

            return (
                <div className={`${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in`}>
                    {type === 'success' && <Check className="w-4 h-4"/>}
                    {type === 'error' && <X className="w-4 h-4"/>}
                    {type === 'warning' && <AlertTriangle className="w-4 h-4"/>}
                    {type === 'sync' && <RefreshCw className="w-4 h-4 animate-spin"/>}
                    <span className="text-sm font-medium">{message}</span>
                </div>
            );
        };

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            
            const showToast = (message, type = 'info', duration = 3000) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type, duration }]);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={{ showToast }}>
                    {children}
                    <div className="fixed bottom-6 right-6 space-y-2 z-[999]">
                        {toasts.map(toast => (
                            <Toast 
                                key={toast.id}
                                message={toast.message}
                                type={toast.type}
                                duration={toast.duration}
                                onClose={() => removeToast(toast.id)}
                            />
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => {
            const context = useContext(ToastContext);
            if (!context) throw new Error('useToast must be used within ToastProvider');
            return context;
        };

        // Hook untuk monitor perubahan akses real-time
        const useAccessNotification = (userProfile) => {
            const { showToast } = useToast();
            const lastNotificationRef = useRef(null);

            useEffect(() => {
                if (!userProfile?.id || userProfile?.role === 'developer') return;

                const userRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'users', userProfile.id);
                
                const unsubscribe = onSnapshot(userRef, (docSnap) => {
                    if (!docSnap.exists()) return;
                    
                    const userData = docSnap.data();
                    const notification = userData?.notification;
                    
                    // Jika ada notifikasi baru tentang akses yang berubah
                    if (notification?.type === 'access_updated' && 
                        !notification?.acknowledged &&
                        lastNotificationRef.current !== notification?.timestamp) {
                        
                        lastNotificationRef.current = notification?.timestamp;
                        showToast(
                            'üîÑ Hak akses Anda telah diperbarui oleh Developer. Beberapa fitur mungkin terkunci.',
                            'sync',
                            4000
                        );
                        
                        // Mark notification as acknowledged
                        updateDoc(userRef, {
                            'notification.acknowledged': true
                        }).catch(e => console.error('Failed to acknowledge notification:', e));
                    }
                }, (error) => {
                    console.error('Error monitoring access notifications:', error);
                });
                if (window.firestoreListeners) window.firestoreListeners.add(unsubscribe);

                return () => {
                    if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribe);
                    unsubscribe();
                };
            }, [userProfile?.id, userProfile?.role, showToast]);
        };

        // ==========================================
        // üìä FIREBASE QUOTA TRACKING SYSTEM
        // ==========================================
        const QuotaTrackingContext = createContext();
        
        const QuotaTrackingProvider = ({children}) => {
            const [quotaStats, setQuotaStats] = useState(() => {
                const saved = localStorage.getItem('firebase_quota_stats');
                return saved ? JSON.parse(saved) : {
                    totalReads: 0,
                    cacheHits: 0,
                    serverReads: 0,
                    totalWrites: 0,
                    totalUpdates: 0,
                    totalDeletes: 0,
                    byCollection: {},
                    byCollectionWrites: {},
                    dailyStats: {},
                    lastReset: new Date().toISOString().split('T')[0]
                };
            });
            
            const trackRead = useCallback((collectionName, fromCache, count = 1) => {
                setQuotaStats(prev => {
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Reset jika hari berbeda
                    if (prev.lastReset !== today) {
                        return {
                            totalReads: fromCache ? 0 : count,
                            cacheHits: fromCache ? count : 0,
                            serverReads: fromCache ? 0 : count,
                            totalWrites: 0,
                            totalUpdates: 0,
                            totalDeletes: 0,
                            byCollection: { [collectionName]: fromCache ? 0 : count },
                            byCollectionWrites: {},
                            dailyStats: {
                                ...prev.dailyStats,
                                [prev.lastReset]: {
                                    totalReads: prev.totalReads,
                                    serverReads: prev.serverReads,
                                    cacheHits: prev.cacheHits,
                                    totalWrites: prev.totalWrites,
                                    totalUpdates: prev.totalUpdates,
                                    totalDeletes: prev.totalDeletes
                                }
                            },
                            lastReset: today
                        };
                    }
                    
                    const updated = {
                        ...prev,
                        totalReads: prev.totalReads + count,
                        cacheHits: fromCache ? prev.cacheHits + count : prev.cacheHits,
                        serverReads: fromCache ? prev.serverReads : prev.serverReads + count,
                        byCollection: {
                            ...prev.byCollection,
                            [collectionName]: (prev.byCollection[collectionName] || 0) + (fromCache ? 0 : count)
                        }
                    };
                    
                    localStorage.setItem('firebase_quota_stats', JSON.stringify(updated));
                    return updated;
                });
            }, []);
            
            const trackWrite = useCallback((collectionName, operation = 'write', count = 1) => {
                setQuotaStats(prev => {
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Reset jika hari berbeda
                    if (prev.lastReset !== today) {
                        return {
                            ...prev,
                            totalReads: prev.totalReads || 0,
                            cacheHits: prev.cacheHits || 0,
                            serverReads: prev.serverReads || 0,
                            totalWrites: operation === 'write' ? count : 0,
                            totalUpdates: operation === 'update' ? count : 0,
                            totalDeletes: operation === 'delete' ? count : 0,
                            byCollectionWrites: { [collectionName]: count },
                            dailyStats: {
                                ...prev.dailyStats,
                                [prev.lastReset]: {
                                    totalReads: prev.totalReads,
                                    serverReads: prev.serverReads,
                                    cacheHits: prev.cacheHits,
                                    totalWrites: prev.totalWrites,
                                    totalUpdates: prev.totalUpdates,
                                    totalDeletes: prev.totalDeletes
                                }
                            },
                            lastReset: today
                        };
                    }
                    
                    const updated = {
                        ...prev,
                        totalWrites: operation === 'write' ? (prev.totalWrites || 0) + count : (prev.totalWrites || 0),
                        totalUpdates: operation === 'update' ? (prev.totalUpdates || 0) + count : (prev.totalUpdates || 0),
                        totalDeletes: operation === 'delete' ? (prev.totalDeletes || 0) + count : (prev.totalDeletes || 0),
                        byCollectionWrites: {
                            ...prev.byCollectionWrites,
                            [collectionName]: ((prev.byCollectionWrites || {})[collectionName] || 0) + count
                        }
                    };
                    
                    localStorage.setItem('firebase_quota_stats', JSON.stringify(updated));
                    return updated;
                });
            }, []);
            
            const resetStats = useCallback(() => {
                const reset = {
                    totalReads: 0,
                    cacheHits: 0,
                    serverReads: 0,
                    totalWrites: 0,
                    totalUpdates: 0,
                    totalDeletes: 0,
                    byCollection: {},
                    byCollectionWrites: {},
                    dailyStats: {},
                    lastReset: new Date().toISOString().split('T')[0]
                };
                setQuotaStats(reset);
                localStorage.setItem('firebase_quota_stats', JSON.stringify(reset));
            }, []);
            
            return (
                <QuotaTrackingContext.Provider value={{ quotaStats, trackRead, trackWrite, resetStats }}>
                    {children}
                </QuotaTrackingContext.Provider>
            );
        };
        
        const useQuotaTracking = () => useContext(QuotaTrackingContext);
        
        // Helper functions untuk track writes otomatis
        const trackedAddDoc = async (collectionRef, data, quotaContext) => {
            const result = await addDoc(collectionRef, data);
            if (quotaContext) {
                const collectionName = collectionRef.path.split('/').pop();
                quotaContext.trackWrite(collectionName, 'write', 1);
            }
            return result;
        };
        
        const trackedUpdateDoc = async (docRef, data, quotaContext) => {
            const result = await updateDoc(docRef, data);
            if (quotaContext) {
                const collectionName = docRef.path.split('/')[docRef.path.split('/').length - 2];
                quotaContext.trackWrite(collectionName, 'update', 1);
            }
            return result;
        };
        
        const trackedDeleteDoc = async (docRef, quotaContext) => {
            const result = await deleteDoc(docRef);
            if (quotaContext) {
                const collectionName = docRef.path.split('/')[docRef.path.split('/').length - 2];
                quotaContext.trackWrite(collectionName, 'delete', 1);
            }
            return result;
        };

        // ==========================================
        // üîÑ REFACTORED DATA ACCESS LAYER
        // Supports: realtime | fetch | paginated modes
        // ==========================================

        /**
         * DATA_MODE configuration per collection.
         * 'realtime' = onSnapshot (active orders, queues, running services)
         * 'fetch'    = getDocs one-time (product list, customer list, service list, etc.)
         * 'paginated'= getDocs + startAfter (transaction history)
         */
        const COLLECTION_DATA_MODE = {
            // --- Realtime: semua collection realtime seperti Firebase ---
            services:       'realtime',
            cash_accounts:  'realtime',
            owners:         'realtime',
            inventory:      'realtime',
            customers:      'realtime',
            sales:          'realtime',
            users:          'realtime',
            suppliers:      'realtime',
            brands:         'realtime',
            transactions:   'realtime',
        };

        /**
         * buildCollectionQuery - shared query builder logic
         * @param {string} collectionName 
         * @param {string} ownerId 
         * @param {Array}  extraConstraints - additional where/orderBy/limit
         * @param {number} limitCount
         * @returns {Query}
         */
        const buildCollectionQuery = (collectionName, ownerId, extraConstraints = [], limitCount = 25) => {
            const colRef = collection(db, APP_COLLECTION_PREFIX, 'public', collectionName);
            const constraints = [];
            if (ownerId) constraints.push(where('ownerId', '==', ownerId));
            constraints.push(...extraConstraints);
            try {
                return query(colRef, ...constraints, orderBy('createdAt', 'desc'), limit(limitCount));
            } catch (e) {
                console.warn(`‚ö†Ô∏è orderBy failed for ${collectionName}, fallback without ordering`);
                return query(colRef, ...constraints, limit(limitCount));
            }
        };

        /**
         * loadCollection - unified data loader (backward compatible wrapper)
         *
         * @param {Object} opts
         * @param {string}   opts.collectionName
         * @param {string}   [opts.ownerId]
         * @param {string}   [opts.storeId]      - client-side filter
         * @param {string}   [opts.mode]          - 'realtime' | 'fetch' | 'paginated' (auto-detected if omitted)
         * @param {number}   [opts.limitCount=25]
         * @param {Array}    [opts.extraConstraints=[]]
         * @param {Function} opts.callback        - receives { data, fromCache, lastVisible }
         * @param {Object}   [opts.quotaContext]
         * @param {DocumentSnapshot} [opts.startAfterDoc] - for pagination
         * @returns {Function|null} unsubscribe (only for realtime mode)
         */
        const loadCollection = (opts) => {
            const {
                collectionName,
                ownerId,
                storeId,
                mode: explicitMode,
                limitCount = 25,
                extraConstraints = [],
                callback,
                quotaContext,
                startAfterDoc
            } = opts;

            if (!collectionName) { callback({ data: [], fromCache: false, lastVisible: null }); return null; }
            if (typeof query !== 'function' || typeof collection !== 'function') {
                console.error('‚ùå Firebase functions not available');
                callback({ data: [], fromCache: false, lastVisible: null });
                return null;
            }

            const mode = explicitMode || COLLECTION_DATA_MODE[collectionName] || 'fetch';
            const colRef = collection(db, APP_COLLECTION_PREFIX, 'public', collectionName);

            // Build constraints
            // ‚úÖ FIX: storeId TIDAK disertakan di server-side query agar data lama (tanpa storeId) ikut termuat
            // Filter storeId dilakukan hanya di sisi klien (applyStoreFilter)
            const constraints = [];
            if (ownerId) constraints.push(where('ownerId', '==', ownerId));
            constraints.push(...extraConstraints);

            // Build query parts
            const qParts = [...constraints];
            try { qParts.push(orderBy('createdAt', 'desc')); } catch (e) { /* skip */ }
            qParts.push(limit(limitCount));
            if (startAfterDoc) qParts.push(startAfter(startAfterDoc));

            let q;
            try {
                q = query(colRef, ...qParts);
            } catch (e) {
                // Fallback without orderBy
                const fallbackParts = [...constraints, limit(limitCount)];
                if (startAfterDoc) fallbackParts.push(startAfter(startAfterDoc));
                q = query(colRef, ...fallbackParts);
            }

            const applyStoreFilter = (items) => {
                let filtered = items;
                
                // ‚úÖ FIX BACKWARD COMPAT: Filter storeId di client-side
                // Sertakan juga record lama yang tidak memiliki storeId (data sebelum fitur multi-toko)
                if (storeId !== undefined && storeId !== null) {
                    filtered = filtered.filter(item => !item.storeId || item.storeId === storeId);
                }
                
                // Exclude deleted items (soft delete support)
                filtered = filtered.filter(item => !item.deleted);
                
                // Sort by createdAt descending
                filtered.sort((a, b) => {
                    const tA = a.createdAt?.seconds || a.date?.seconds || 0;
                    const tB = b.createdAt?.seconds || b.date?.seconds || 0;
                    return tB - tA;
                });
                return filtered;
            };

            // ========== REALTIME MODE ==========
            if (mode === 'realtime') {
                const unsub = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    const filtered = applyStoreFilter(items);
                    if (quotaContext) {
                        quotaContext.trackRead(collectionName, snapshot.metadata.fromCache, snapshot.docs.length);
                    }
                    callback({
                        data: filtered,
                        fromCache: snapshot.metadata.fromCache,
                        lastVisible: snapshot.docs[snapshot.docs.length - 1] || null
                    });
                }, (error) => {
                    console.error(`‚ùå Realtime listener error [${collectionName}]:`, error);
                    callback({ data: [], fromCache: false, lastVisible: null });
                });
                if (window.firestoreListeners) window.firestoreListeners.add(unsub);
                return unsub;
            }

            // ========== FETCH / PAGINATED MODE ==========
            (async () => {
                try {
                    const snapshot = await getDocs(q);
                    const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    const filtered = applyStoreFilter(items);
                    if (quotaContext) {
                        quotaContext.trackRead(collectionName, snapshot.metadata.fromCache, snapshot.docs.length);
                    }
                    callback({
                        data: filtered,
                        fromCache: snapshot.metadata.fromCache,
                        lastVisible: snapshot.docs[snapshot.docs.length - 1] || null
                    });
                } catch (error) {
                    console.error(`‚ùå Fetch error [${collectionName}]:`, error);
                    // Fallback tanpa orderBy
                    try {
                        const fallbackQ = ownerId
                            ? query(colRef, where('ownerId', '==', ownerId), limit(limitCount))
                            : query(colRef, limit(limitCount));
                        const snap2 = await getDocs(fallbackQ);
                        const items2 = snap2.docs.map(d => ({ id: d.id, ...d.data() }));
                        callback({
                            data: applyStoreFilter(items2),
                            fromCache: snap2.metadata.fromCache,
                            lastVisible: snap2.docs[snap2.docs.length - 1] || null
                        });
                    } catch (e2) {
                        console.error(`‚ùå Fallback also failed [${collectionName}]:`, e2);
                        callback({ data: [], fromCache: false, lastVisible: null });
                    }
                }
            })();
            return null; // no unsubscribe needed for fetch mode
        };

        // ==========================================
        // ü™ù HOOK: useRealtimeCollection
        // For: active orders, queues, running services
        // Uses onSnapshot ‚Üí always up-to-date
        // ==========================================
        const useRealtimeCollection = (collectionName, ownerId, storeId, extraConstraints = [], limitCount = 25) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fromCache, setFromCache] = useState(false);
            const quotaContext = useContext(QuotaTrackingContext);

            useEffect(() => {
                if (!collectionName) { setLoading(false); return; }
                let isMounted = true;

                const unsub = loadCollection({
                    collectionName,
                    ownerId,
                    storeId,
                    mode: 'realtime',
                    limitCount,
                    extraConstraints,
                    quotaContext,
                    callback: (result) => {
                        if (!isMounted) return;
                        setData(result.data);
                        setFromCache(result.fromCache);
                        setLoading(false);
                    }
                });

                return () => {
                    isMounted = false;
                    if (unsub) {
                        if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
                        unsub();
                    }
                };
            }, [collectionName, ownerId, storeId, JSON.stringify(extraConstraints), limitCount]);

            return { data, loading, fromCache };
        };

        // ==========================================
        // ü™ù HOOK: useFetchCollection
        // For: product list, customer list, service list
        // Uses getDocs ‚Üí one-time read, saves quota
        // Includes manual refetch capability
        // ==========================================
        const useFetchCollection = (collectionName, ownerId, storeId, extraConstraints = [], limitCount = 25) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fromCache, setFromCache] = useState(false);
            const [refreshKey, setRefreshKey] = useState(0);
            const quotaContext = useContext(QuotaTrackingContext);

            const refetch = useCallback(() => setRefreshKey(k => k + 1), []);

            useEffect(() => {
                if (!collectionName) { setLoading(false); return; }
                let isMounted = true;
                setLoading(true);

                loadCollection({
                    collectionName,
                    ownerId,
                    storeId,
                    mode: 'fetch',
                    limitCount,
                    extraConstraints,
                    quotaContext,
                    callback: (result) => {
                        if (!isMounted) return;
                        setData(result.data);
                        setFromCache(result.fromCache);
                        setLoading(false);
                    }
                });

                return () => { isMounted = false; };
            }, [collectionName, ownerId, storeId, JSON.stringify(extraConstraints), limitCount, refreshKey]);

            return { data, loading, fromCache, refetch };
        };

        // ==========================================
        // ü™ù HOOK: usePaginatedTransactions
        // For: transaction history with date range + pagination
        // Uses getDocs + limit + startAfter
        // ==========================================
        const usePaginatedTransactions = (ownerId, storeId, dateRange = {}, pageSize = 25) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [fromCache, setFromCache] = useState(false);
            const [lastVisible, setLastVisible] = useState(null);
            const [hasMore, setHasMore] = useState(true);
            const [totalLoaded, setTotalLoaded] = useState(0);
            const quotaContext = useContext(QuotaTrackingContext);

            // Builds date range constraints
            const buildDateConstraints = useCallback(() => {
                const constraints = [];
                if (dateRange.start) {
                    const startDate = new Date(dateRange.start);
                    startDate.setHours(0, 0, 0, 0);
                    constraints.push(where('date', '>=', Timestamp.fromDate(startDate)));
                }
                if (dateRange.end) {
                    const endDate = new Date(dateRange.end);
                    endDate.setHours(23, 59, 59, 999);
                    constraints.push(where('date', '<=', Timestamp.fromDate(endDate)));
                }
                return constraints;
            }, [dateRange.start, dateRange.end]);

            // Fetch first page or when filters change
            const fetchFirstPage = useCallback(async () => {
                if (!ownerId) return;
                setLoading(true);
                setLastVisible(null);
                setHasMore(true);

                const colRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                const constraints = [where('ownerId', '==', ownerId)];
                constraints.push(...buildDateConstraints());

                let q;
                try {
                    q = query(colRef, ...constraints, orderBy('date', 'desc'), limit(pageSize));
                } catch (e) {
                    try {
                        q = query(colRef, ...constraints, orderBy('createdAt', 'desc'), limit(pageSize));
                    } catch (e2) {
                        q = query(colRef, ...constraints, limit(pageSize));
                    }
                }

                try {
                    const snapshot = await getDocs(q);
                    let items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                    // Client-side storeId filter
                    if (storeId !== undefined && storeId !== null) {
                        items = items.filter(item => item.storeId === storeId);
                    }
                    items.sort((a, b) => {
                        const tA = a.date?.seconds || a.createdAt?.seconds || 0;
                        const tB = b.date?.seconds || b.createdAt?.seconds || 0;
                        return tB - tA;
                    });

                    const last = snapshot.docs[snapshot.docs.length - 1] || null;
                    setData(items);
                    setLastVisible(last);
                    setHasMore(snapshot.docs.length === pageSize);
                    setTotalLoaded(items.length);
                    setFromCache(snapshot.metadata.fromCache);

                    if (quotaContext) {
                        quotaContext.trackRead('transactions', snapshot.metadata.fromCache, snapshot.docs.length);
                    }
                } catch (error) {
                    console.error('‚ùå Paginated transactions fetch error:', error);
                    setData([]);
                    setHasMore(false);
                } finally {
                    setLoading(false);
                }
            }, [ownerId, storeId, pageSize, buildDateConstraints]);

            // Fetch next page
            const fetchNextPage = useCallback(async () => {
                if (!ownerId || !lastVisible || loading || !hasMore) return;
                setLoading(true);

                const colRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                const constraints = [where('ownerId', '==', ownerId)];
                constraints.push(...buildDateConstraints());

                let q;
                try {
                    q = query(colRef, ...constraints, orderBy('date', 'desc'), startAfter(lastVisible), limit(pageSize));
                } catch (e) {
                    try {
                        q = query(colRef, ...constraints, orderBy('createdAt', 'desc'), startAfter(lastVisible), limit(pageSize));
                    } catch (e2) {
                        q = query(colRef, ...constraints, startAfter(lastVisible), limit(pageSize));
                    }
                }

                try {
                    const snapshot = await getDocs(q);
                    let newItems = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                    if (storeId !== undefined && storeId !== null) {
                        newItems = newItems.filter(item => item.storeId === storeId);
                    }
                    newItems.sort((a, b) => {
                        const tA = a.date?.seconds || a.createdAt?.seconds || 0;
                        const tB = b.date?.seconds || b.createdAt?.seconds || 0;
                        return tB - tA;
                    });

                    const last = snapshot.docs[snapshot.docs.length - 1] || null;
                    setData(prev => [...prev, ...newItems]);
                    setLastVisible(last);
                    setHasMore(snapshot.docs.length === pageSize);
                    setTotalLoaded(prev => prev + newItems.length);
                    setFromCache(snapshot.metadata.fromCache);

                    if (quotaContext) {
                        quotaContext.trackRead('transactions', snapshot.metadata.fromCache, snapshot.docs.length);
                    }
                } catch (error) {
                    console.error('‚ùå Paginated transactions next-page error:', error);
                    setHasMore(false);
                } finally {
                    setLoading(false);
                }
            }, [ownerId, storeId, lastVisible, loading, hasMore, pageSize, buildDateConstraints]);

            // Auto-fetch first page when ownerId/storeId/dateRange changes
            useEffect(() => {
                fetchFirstPage();
            }, [fetchFirstPage]);

            return {
                data,
                loading,
                fromCache,
                hasMore,
                totalLoaded,
                lastVisible,
                fetchNextPage,
                refetch: fetchFirstPage
            };
        };

        // ==========================================
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üñ±Ô∏è  useDraggableModals ‚Äî global drag handler untuk semua popup
        //     Bekerja via event delegation: tidak perlu ubah modal satu per satu.
        //     Cara kerja:
        //       1. onMouseDown: cari modal panel (anak langsung dari overlay fixed inset-0)
        //       2. Jika klik berada di zona header (<=70px dari atas panel) dan bukan tombol/input ‚Üí aktifkan drag
        //       3. onMouseMove: geser panel via style.left + style.top
        //       4. onMouseUp/Leave: hentikan drag
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const useDraggableModals = () => {
            useEffect(() => {
                let dragging = null;
                let ox = 0, oy = 0;  // offset kursor dari pojok kiri-atas panel

                const getModalPanel = (el) => {
                    let node = el;
                    while (node && node !== document.body) {
                        const parent = node.parentElement;
                        if (!parent) break;
                        if (parent.classList.contains('inset-0') && parent.classList.contains('fixed')) {
                            return node; // ini panel modal
                        }
                        node = parent;
                    }
                    return null;
                };

                const startDrag = (clientX, clientY, target) => {
                    // Jangan drag jika klik pada elemen interaktif
                    if (target.closest('button,input,select,textarea,a,[role="button"],[tabindex]')) return;
                    const panel = getModalPanel(target);
                    if (!panel) return;
                    const rect = panel.getBoundingClientRect();
                    const relY = clientY - rect.top;
                    if (relY > 70) return; // hanya drag di zona header (70px teratas)
                    dragging = panel;
                    ox = clientX - rect.left;
                    oy = clientY - rect.top;
                    // Lepas dari flex-centering parent ‚Üí posisi fixed absolut
                    panel.style.position = 'fixed';
                    panel.style.left = rect.left + 'px';
                    panel.style.top = rect.top + 'px';
                    panel.style.transform = 'none';
                    panel.style.margin = '0';
                    panel.style.transition = 'none';
                    panel.style.cursor = 'grabbing';
                    document.body.style.userSelect = 'none';
                };

                const moveDrag = (clientX, clientY) => {
                    if (!dragging) return;
                    const maxX = window.innerWidth  - dragging.offsetWidth;
                    const maxY = window.innerHeight - dragging.offsetHeight;
                    dragging.style.left = Math.max(0, Math.min(clientX - ox, maxX)) + 'px';
                    dragging.style.top  = Math.max(0, Math.min(clientY - oy, maxY)) + 'px';
                };

                const stopDrag = () => {
                    if (dragging) {
                        dragging.style.cursor = '';
                        dragging = null;
                    }
                    document.body.style.userSelect = '';
                };

                const onMouseDown = (e) => startDrag(e.clientX, e.clientY, e.target);
                const onMouseMove = (e) => moveDrag(e.clientX, e.clientY);
                const onTouchStart = (e) => {
                    const t = e.touches[0];
                    startDrag(t.clientX, t.clientY, e.target);
                };
                const onTouchMove = (e) => {
                    if (!dragging) return;
                    e.preventDefault();
                    const t = e.touches[0];
                    moveDrag(t.clientX, t.clientY);
                };

                document.addEventListener('mousedown', onMouseDown);
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchstart', onTouchStart, { passive: true });
                document.addEventListener('touchmove', onTouchMove, { passive: false });
                document.addEventListener('touchend', stopDrag);

                // Tambah kursor grab otomatis ke header semua modal
                const styleTag = document.createElement('style');
                styleTag.id = 'draggable-modal-style';
                styleTag.textContent = `
                    .fixed.inset-0 > * { cursor: default; }
                    .fixed.inset-0 > * > *:first-child { cursor: grab; user-select: none; }
                    .fixed.inset-0 > * > *:first-child:active { cursor: grabbing; }
                    .fixed.inset-0 > * > *:first-child button,
                    .fixed.inset-0 > * > *:first-child input,
                    .fixed.inset-0 > * > *:first-child select { cursor: auto; }
                `;
                if (!document.getElementById('draggable-modal-style')) {
                    document.head.appendChild(styleTag);
                }

                return () => {
                    document.removeEventListener('mousedown', onMouseDown);
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', stopDrag);
                    document.removeEventListener('touchstart', onTouchStart);
                    document.removeEventListener('touchmove', onTouchMove);
                    document.removeEventListener('touchend', stopDrag);
                };
            }, []);
        };

        // üîÅ BACKWARD COMPATIBLE: useFirestoreCollection
        // Auto-selects mode based on COLLECTION_DATA_MODE config
        // Signature preserved: (collectionName, ownerId, storeId)
        // ==========================================
        const useFirestoreCollection = (collectionName, ownerId, storeId) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fromCache, setFromCache] = useState(false);
            const quotaContext = useContext(QuotaTrackingContext);

            useEffect(() => {
                if (!collectionName) {
                    setLoading(false);
                    return;
                }
                
                if (typeof query !== 'function' || typeof collection !== 'function') {
                    console.error('‚ùå Firebase functions not available:', {query: typeof query, collection: typeof collection});
                    setLoading(false);
                    setData([]);
                    return;
                }
                
                let isMounted = true;
                const mode = COLLECTION_DATA_MODE[collectionName] || 'fetch';

                // For 'paginated' collections called via this hook, fallback to fetch with limit
                const effectiveMode = mode === 'paginated' ? 'fetch' : mode;

                const unsub = loadCollection({
                    collectionName,
                    ownerId,
                    storeId,
                    mode: effectiveMode,
                    limitCount: 1000, // PocketBase: no quota limit, load all
                    quotaContext,
                    callback: (result) => {
                        if (!isMounted) return;
                        setData(result.data);
                        setFromCache(result.fromCache);
                        setLoading(false);
                    }
                });

                return () => {
                    isMounted = false;
                    if (unsub) {
                        if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
                        unsub();
                    }
                };
            }, [collectionName, ownerId, storeId]);
            return { data, loading, fromCache };
        };

        // Hook khusus inventory dengan server-side filtering untuk kategori dan subkategori
        const useInventoryWithFilters = (ownerId, storeId, category, subCategory, searchTerm) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fromCache, setFromCache] = useState(false);
            const quotaContext = useContext(QuotaTrackingContext);

            useEffect(() => {
                if (!ownerId) {
                    setLoading(false);
                    return;
                }
                
                // Safety check for Firebase functions
                if (typeof query !== 'function' || typeof collection !== 'function') {
                    console.error('‚ùå Firebase functions not available');
                    setLoading(false);
                    setData([]);
                    return;
                }
                
                let isMounted = true;
                
                const colRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory');
                
                // PocketBase: no quota limit, load all items
                const limitCount = 1000;
                
                // Query builder dengan filter server-side
                let constraints = [where('ownerId', '==', ownerId)];
                
                // Add category filter if selected
                if (category) {
                    constraints.push(where('category', '==', category));
                }
                
                // Add subcategory filter if selected (requires category to be set first)
                if (subCategory && category) {
                    constraints.push(where('subCategory', '==', subCategory));
                }
                
                let q;
                try {
                    // Try with orderBy and limit
                    q = query(colRef, ...constraints, orderBy('createdAt', 'desc'), limit(limitCount));
                } catch (e) {
                    console.warn('OrderBy failed, using fallback query without ordering...', e);
                    // Fallback without orderBy
                    q = query(colRef, ...constraints, limit(limitCount));
                }
                
                // One-time fetch dengan getDocs
                const fetchData = async (queryObj) => {
                    try {
                        const snapshot = await getDocs(queryObj);
                        if (!isMounted) return;
                        
                        setFromCache(snapshot.metadata.fromCache);
                        
                        // Track quota usage
                        if (quotaContext) {
                            quotaContext.trackRead('inventory', snapshot.metadata.fromCache, snapshot.docs.length);
                        }
                        
                        let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Filter by storeId if provided
                        if (storeId !== undefined && storeId !== null) { 
                            items = items.filter(item => item.storeId === storeId); 
                        }
                        
                        // Client-side search filter (untuk nama dan SKU)
                        if (searchTerm) {
                            const term = searchTerm.toLowerCase();
                            items = items.filter(i => 
                                i.name?.toLowerCase().includes(term) || 
                                i.sku?.toLowerCase().includes(term)
                            );
                        }
                        
                        // Client-side sort sebagai fallback
                        items.sort((a, b) => {
                            const tA = a.createdAt?.seconds || 0;
                            const tB = b.createdAt?.seconds || 0;
                            return tB - tA;
                        });
                        
                        setData(items);
                        setLoading(false);
                    } catch (error) {
                        if (!isMounted) return;
                        console.error('Error fetching inventory with filters:', error);
                        setData([]);
                        setLoading(false);
                    }
                };
                
                // Fetch data
                fetchData(q);
                
                return () => {
                    isMounted = false;
                };
            }, [ownerId, storeId, category, subCategory, searchTerm]);
            
            return { data, loading, fromCache };
        };

        
// ==========================================
// üîÑ REALTIME SYNC PLAN -> OWNER (OPTIONAL)
// ==========================================
// Jika owner.autoSyncPlan === true,
// maka perubahan plan_configs akan langsung update accessRights owner
const useRealtimePlanSync = (activeOwner) => {
  React.useEffect(() => {
    if (!activeOwner?.autoSyncPlan) return;
    if (!activeOwner?.plan || !activeOwner?.id) return;

    const unsub = onSnapshot(
      doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', _planDocId(activeOwner.plan)),
      async (snap) => {
        if (!snap.exists()) return;
        try {
          await updateDoc(
            doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', activeOwner.id),
            { accessRights: snap.data() }
          );
          console.log('Owner accessRights synced with plan:', activeOwner.plan);
        } catch (e) {
          console.error('Sync plan error', e);
        }
      },
      (error) => {
        console.error('Plan sync listener error:', error);
      }
    );
    
    if (window.firestoreListeners) window.firestoreListeners.add(unsub);
    return () => {
      if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
      unsub();
    };
  }, [activeOwner?.id, activeOwner?.plan, activeOwner?.autoSyncPlan]);
};


const SessionProvider = ({ children }) => {
            const [authUser, setAuthUser] = useState(null); 
            const [userProfile, setUserProfile] = useState(null); 
            const [activeOwner, setActiveOwner] = useState(null); 
            const [activeStore, setActiveStore] = useState(null); 
            const [availableStores, setAvailableStores] = useState([]);
            const [ownerAccess, setOwnerAccess] = useState({});
            const [storeConfig, setStoreConfig] = useState({});
            const [adminWhatsApp, setAdminWhatsApp] = useState('');
            const [subConfig, setSubConfig] = useState({ 
                whatsapp: '', 
                basicFirstYear: 1200000, 
                basicRenewal: 960000, 
                proFirstYear: 2400000, 
                proRenewal: 1920000, 
                duration: 365 
            });
            const [loading, setLoading] = useState(true);
            const ownerUnsubRef = useRef(null);
            const storesUnsubRef = useRef(null);
            const storeConfigUnsubRef = useRef(null);

            // Load admin WA number and subscription pricing from config
            useEffect(() => {
                // Strategy 1: Firebase adapter onSnapshot
                const configRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'subscription_config');
                let adapterWorked = false;
                const unsub = onSnapshot(
                    query(configRef, limit(1)),
                    (snapshot) => { 
                        if (!snapshot.empty) {
                            const data = snapshot.docs[0].data();
                            const wa = data.whatsapp || '';
                            console.log('üìû Admin WhatsApp loaded:', wa);
                            console.log('üíé Subscription pricing loaded:', data);
                            setAdminWhatsApp(wa);
                            setSubConfig({...data, _configId: snapshot.docs[0].id});
                            adapterWorked = true;
                        } else {
                            console.log('‚ö†Ô∏è Subscription config document not found via adapter');
                        }
                    }
                );
                
                // Strategy 2: Direct PocketBase fallback after delay
                const fallbackTimer = setTimeout(async () => {
                    if (!adapterWorked) {
                        console.log('üîÑ Trying direct PocketBase fallback for subscription_config...');
                        try {
                            const result = await pb.collection('subscription_config').getList(1, 1);
                            if (result.items.length > 0) {
                                const data = result.items[0];
                                const wa = data.whatsapp || '';
                                console.log('‚úÖ PocketBase fallback - Admin WhatsApp:', wa);
                                console.log('‚úÖ PocketBase fallback - Pricing:', data);
                                setAdminWhatsApp(wa);
                                setSubConfig({...data, _configId: data.id});
                            } else {
                                console.log('‚ö†Ô∏è No subscription_config found in PocketBase either');
                            }
                        } catch (pbErr) {
                            console.warn('‚ùå PocketBase fallback for subscription_config failed:', pbErr.message);
                        }
                    }
                }, 3000);
                
                // Strategy 3: Subscribe to PocketBase real-time changes directly
                let pbUnsub = null;
                try {
                    pb.collection('subscription_config').subscribe('*', async (e) => {
                        console.log('üîî subscription_config changed via PocketBase SSE:', e.action);
                        if (e.action === 'update' || e.action === 'create') {
                            const data = e.record;
                            const wa = data.whatsapp || '';
                            setAdminWhatsApp(wa);
                            setSubConfig(prev => ({...prev, ...data, _configId: data.id}));
                            console.log('‚úÖ Real-time sync: subscription_config updated');
                        }
                    }).then(u => { pbUnsub = u; }).catch(err => {
                        console.warn('‚ö†Ô∏è PocketBase SSE subscription for subscription_config failed:', err.message);
                    });
                } catch(sseErr) {
                    console.warn('‚ö†Ô∏è Could not setup PocketBase SSE:', sseErr.message);
                }
                
                if (window.firestoreListeners) window.firestoreListeners.add(unsub);
                return () => { 
                    clearTimeout(fallbackTimer);
                    if (window.firestoreListeners) window.firestoreListeners.delete(unsub); 
                    unsub(); 
                    if (pbUnsub && typeof pbUnsub === 'function') pbUnsub();
                    try { pb.collection('subscription_config').unsubscribe('*'); } catch(e) {}
                };
            }, []);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    setAuthUser(currentUser);
                    if (currentUser && !currentUser.isAnonymous) {
                        await fetchUserProfile(currentUser.email);
                    } else {
                        setUserProfile(null);
                        setActiveOwner(null);
                        setTenantContext(null); // üè¢ Clear tenant context on logout
                        setActiveStore(null);
                        if(ownerUnsubRef.current) ownerUnsubRef.current();
                        if(storesUnsubRef.current) storesUnsubRef.current();
                        if(storeConfigUnsubRef.current) storeConfigUnsubRef.current();
                        setLoading(false);
                    }
                });
                
                return () => {
                    unsubscribe();
                    if(ownerUnsubRef.current) ownerUnsubRef.current();
                    if(storesUnsubRef.current) storesUnsubRef.current();
                    if(storeConfigUnsubRef.current) storeConfigUnsubRef.current();
                };
            }, []);

            const fetchUserProfile = async (email) => {
                try {
                    if (email.toLowerCase() === DEVELOPER_EMAIL.toLowerCase()) {
                        const adminProfile = { uid: 'developer_master', email: email, name: 'Developer', role: 'developer', ownerId: null };
                        setUserProfile(adminProfile);
                        setLoading(false);
                        return;
                    }
                    
                    // Strategy 1: Try direct getOne using auth user ID (most reliable for PocketBase)
                    let profile = null;
                    const currentAuthModel = pb.authStore.model;
                    if (currentAuthModel && currentAuthModel.id) {
                        try {
                            const record = await pb.collection('users').getOne(currentAuthModel.id);
                            console.log('‚úÖ User profile loaded via getOne:', record.id);
                            profile = { id: record.id, ...record };
                        } catch (directErr) {
                            console.warn('‚ö†Ô∏è Direct getOne failed, trying query...', directErr.message);
                        }
                    }
                    
                    // Strategy 2: Fallback to email query
                    if (!profile) {
                        const usersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'users');
                        const q = query(usersRef, where('email', '==', email));
                        const snapshot = await getDocs(q); 
                        if (!snapshot.empty) {
                            profile = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                            console.log('‚úÖ User profile loaded via email query:', profile.id);
                        }
                    }
                    
                    // Strategy 3: Use authStore model data directly as fallback
                    if (!profile && currentAuthModel) {
                        console.log('‚ö†Ô∏è Using authStore model as profile fallback');
                        profile = {
                            id: currentAuthModel.id,
                            email: currentAuthModel.email,
                            name: currentAuthModel.name || '',
                            role: currentAuthModel.role || '',
                            ownerId: currentAuthModel.ownerId || '',
                            storeId: currentAuthModel.storeId || ''
                        };
                    }

                    // Strategy 4: Auto-detect Owner ‚Äî cek apakah email ada di 'owners' collection
                    // Ini mencegah owner kehilangan akses meskipun record 'users' tidak punya role
                    if (!profile || !profile.role) {
                        try {
                            console.log('üîç Strategy 4: Checking owners collection for email:', email);
                            const ownersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'owners');
                            const ownerQuery = query(ownersRef, where('email', '==', email));
                            const ownerSnap = await getDocs(ownerQuery);
                            if (!ownerSnap.empty) {
                                const ownerData = { id: ownerSnap.docs[0].id, ...ownerSnap.docs[0].data() };
                                console.log('‚úÖ Strategy 4: Found owner record! Auto-assigning owner role:', ownerData.name);
                                profile = {
                                    id: profile?.id || ownerData.id,
                                    email: email,
                                    name: ownerData.name || email,
                                    role: 'owner',
                                    ownerId: ownerData.id,
                                    storeId: ''
                                };
                                // Patch role ke PocketBase users record agar tidak kejadian lagi
                                if (currentAuthModel && currentAuthModel.id) {
                                    try {
                                        await pb.collection('users').update(currentAuthModel.id, {
                                            role: 'owner',
                                            ownerId: ownerData.id,
                                            verified: true
                                        });
                                        console.log('‚úÖ Auto-patched PocketBase users record with owner role');
                                    } catch(patchErr) {
                                        console.warn('‚ö†Ô∏è Could not patch PocketBase record:', patchErr.message);
                                    }
                                }
                                // Patch juga ke Firestore users
                                try {
                                    const usersRef2 = collection(db, APP_COLLECTION_PREFIX, 'public', 'users');
                                    const uq = query(usersRef2, where('email', '==', email));
                                    const uSnap = await getDocs(uq);
                                    if (!uSnap.empty) {
                                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', uSnap.docs[0].id), {
                                            role: 'owner',
                                            ownerId: ownerData.id
                                        });
                                        console.log('‚úÖ Auto-patched Firestore users record with owner role');
                                    }
                                } catch(fsErr) {
                                    console.warn('‚ö†Ô∏è Could not patch Firestore record:', fsErr.message);
                                }
                            } else {
                                // Strategy 4b: Cek di PocketBase owners collection
                                try {
                                    const pbOwners = await pb.collection('owners').getFullList({
                                        filter: `email = "${email}"`
                                    });
                                    if (pbOwners.length > 0) {
                                        const pbOwner = pbOwners[0];
                                        console.log('‚úÖ Strategy 4b: Found owner in PocketBase:', pbOwner.name);
                                        profile = {
                                            id: profile?.id || pbOwner.id,
                                            email: email,
                                            name: pbOwner.name || email,
                                            role: 'owner',
                                            ownerId: pbOwner.id,
                                            storeId: ''
                                        };
                                        // Patch ke PocketBase users
                                        if (currentAuthModel && currentAuthModel.id) {
                                            try {
                                                await pb.collection('users').update(currentAuthModel.id, {
                                                    role: 'owner',
                                                    ownerId: pbOwner.id,
                                                    verified: true
                                                });
                                                console.log('‚úÖ Auto-patched PocketBase users record (4b)');
                                            } catch(pErr) { console.warn(pErr.message); }
                                        }
                                    }
                                } catch(pbErr) {
                                    console.warn('‚ö†Ô∏è PocketBase owners check failed:', pbErr.message);
                                }
                            }
                        } catch(ownerCheckErr) {
                            console.warn('‚ö†Ô∏è Strategy 4 failed:', ownerCheckErr.message);
                        }
                    }

                    if (profile && profile.role && profile.role !== 'guest') {
                        setUserProfile(profile);
                        if (profile.role !== 'developer' && profile.ownerId) {
                            enterTenantContext(profile.ownerId, profile);
                        }
                    } else {
                        // ‚ö° Strategy 5: Direct PocketBase email query ‚Äî fallback terakhir
                        // Berguna saat authStore.model stale, role kosong, atau PATCH user gagal
                        let profileFixed = null;
                        try {
                            const adminTok = await getAdminToken();
                            const userTok = pb.authStore.token; // token dari login yang baru saja berhasil
                            const s5AuthToken = adminTok || userTok;
                            const emailFilter = encodeURIComponent(`email="${email}"`);
                            const s5Headers = s5AuthToken ? { 'Authorization': s5AuthToken } : {};
                            const s5Resp = await fetch(`${POCKETBASE_URL}/api/collections/users/records?filter=${emailFilter}&perPage=1`, { headers: s5Headers });
                            if (s5Resp.ok) {
                                const s5Data = await s5Resp.json();
                                if (s5Data.items && s5Data.items.length > 0) {
                                    const u = s5Data.items[0];
                                    if (u.role && u.role !== 'guest') {
                                        profileFixed = { id: u.id, ...u };
                                        console.log('‚úÖ Strategy 5: profile fixed via PocketBase email query, role:', u.role);
                                    }
                                }
                            }
                        } catch(s5err) {
                            console.warn('‚ö†Ô∏è Strategy 5 failed:', s5err.message);
                        }

                        if (profileFixed && profileFixed.role && profileFixed.role !== 'guest') {
                            setUserProfile(profileFixed);
                            if (profileFixed.role !== 'developer' && profileFixed.ownerId) {
                                enterTenantContext(profileFixed.ownerId, profileFixed);
                            }
                        } else {
                            console.warn('‚ö†Ô∏è User profile has no role (all strategies failed):', profile);
                            setUserProfile({ email: email, role: 'guest', name: profile?.name || 'Guest User' });
                        }
                    }
                } catch (err) {
                    console.error("Error fetching profile:", err);
                } finally {
                    setLoading(false);
                }
            };

            const enterTenantContext = (ownerId, specificUser = null) => {
                // üîÑ PocketBase: Load owner + accessRights (prioritas utama karena app pakai PocketBase)
                pb.collection('owners').getOne(ownerId)
                    .then(pbOwner => {
                        setActiveOwner(pbOwner);
                        setOwnerAccess(pbOwner.accessRights || {});
                        setTenantContext(pbOwner.id);
                    })
                    .catch(e => console.warn('‚ö†Ô∏è PB owner load:', e.message));

                // üîÑ PocketBase: Load stores
                pb.collection('stores').getFullList({ filter: `ownerId = "${ownerId}"` })
                    .then(pbStores => {
                        let targetStore = null;
                        if (specificUser && specificUser.role !== 'owner' && specificUser.storeId) {
                            targetStore = pbStores.find(s => s.id === specificUser.storeId);
                            setAvailableStores(targetStore ? [targetStore] : []);
                        } else {
                            setAvailableStores(pbStores);
                            targetStore = pbStores[0] || null;
                        }
                        setActiveStore(prev => {
                            if (!prev) return targetStore;
                            const still = pbStores.find(s => s.id === prev.id);
                            return still || targetStore;
                        });
                        if (targetStore) fetchStoreConfig(targetStore.id);
                    })
                    .catch(e => console.warn('‚ö†Ô∏è PB stores load:', e.message));

                try {
                    const ownerRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', ownerId);
                    if (ownerUnsubRef.current) {
                        if (window.firestoreListeners) window.firestoreListeners.delete(ownerUnsubRef.current);
                        ownerUnsubRef.current();
                    }
                    
                    // Listener untuk owner doc - includes real-time accessRights update
                    ownerUnsubRef.current = onSnapshot(ownerRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const ownerData = { id: docSnap.id, ...docSnap.data() };
                            setActiveOwner(ownerData);
                            setTenantContext(ownerData.id); // üè¢ Set tenant context for collection prefix
                            setOwnerAccess(ownerData.accessRights || {});
                            
                            // Notifikasi jika ada perubahan akses
                            if (ownerData.updatedAt) {
                                console.log('‚úÖ Hak akses owner diperbarui secara real-time:', ownerData.accessRights);
                            }
                        } else {
                            handleLogout();
                        }
                    }, (error) => {
                        console.error('Error listening to owner:', error);
                    });
                    if (window.firestoreListeners) window.firestoreListeners.add(ownerUnsubRef.current);

                    const storesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'stores');
                    const q = query(storesRef, where('ownerId', '==', ownerId));
                    if (storesUnsubRef.current) {
                        if (window.firestoreListeners) window.firestoreListeners.delete(storesUnsubRef.current);
                        storesUnsubRef.current();
                    }

                    storesUnsubRef.current = onSnapshot(q, (snapshot) => {
                        const stores = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        let targetStore = null;
                        if (specificUser && specificUser.role !== 'owner' && specificUser.storeId) {
                            targetStore = stores.find(s => s.id === specificUser.storeId);
                            setAvailableStores(targetStore ? [targetStore] : []);
                        } else {
                            setAvailableStores(stores);
                            targetStore = stores[0];
                        }
                        
                        setActiveStore(prev => {
                            if (!prev) return targetStore;
                            const stillExists = stores.find(s => s.id === prev.id);
                            return stillExists ? stillExists : targetStore;
                        });
                        
                        const storeToLoad = activeStore || targetStore;
                        if (storeToLoad) fetchStoreConfig(storeToLoad.id);
                    });
                    if (window.firestoreListeners) window.firestoreListeners.add(storesUnsubRef.current);
                } catch (err) { console.error("Context Error:", err); }
            };

            const fetchStoreConfig = (storeId) => {
                // Clean up previous listener
                if (storeConfigUnsubRef.current) {
                    if (window.firestoreListeners) window.firestoreListeners.delete(storeConfigUnsubRef.current);
                    storeConfigUnsubRef.current();
                    storeConfigUnsubRef.current = null;
                }
                
                // Real-time listener dengan query spesifik
                const configsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs');
                const q = query(configsRef, where('storeId', '==', storeId));
                
                storeConfigUnsubRef.current = onSnapshot(q, (snap) => {
                    if (!snap.empty) {
                        const conf = snap.docs[0].data();
                        setStoreConfig(conf);
                        console.log('‚úÖ Real-time update: Store config untuk', storeId, conf);
                    } else {
                        // Default config jika belum ada di Firestore
                        const defaultConfig = {
                            storeId: storeId,
                            feature_share: true, 
                            feature_print: true, 
                            feature_delete: true, 
                            feature_stock_add: true
                        };
                        setStoreConfig(defaultConfig);
                        console.log('üìã Menggunakan default config untuk', storeId);
                    }
                }, (error) => {
                    console.error('‚ùå Error listening to store config:', error);
                });
                if (window.firestoreListeners) window.firestoreListeners.add(storeConfigUnsubRef.current);
            };

            const switchStore = (storeId) => {
                if (storeId === null) {
                    // "Semua" - All stores mode
                    setActiveStore(null);
                    return;
                }
                const target = availableStores.find(s => s.id === storeId);
                if (target) {
                    setActiveStore(target);
                    fetchStoreConfig(target.id);
                }
            };

            const handleLogout = async () => {
                await signOut(auth);
                window.location.href = window.location.origin + window.location.pathname; 
            };

            const checkPermission = (featureKey) => {
                if (userProfile?.role === 'developer') return true;
                
                const userRole = userProfile?.role || 'kasir';
                
                // Essential features that should work by default
                const essentialFeatures = ['feature_delete', 'feature_print', 'feature_share'];
                
                // NEW: Per-Role Access Control
                // Check if accessRights has role-based structure (nested object)
                let roleAccess = null;
                if (ownerAccess) {
                    // Check if this is new per-role structure
                    if (ownerAccess[userRole] && typeof ownerAccess[userRole] === 'object') {
                        roleAccess = ownerAccess[userRole];
                    } else if (ownerAccess[featureKey] !== undefined) {
                        // Backward compatibility: old flat structure (global for all users)
                        roleAccess = ownerAccess;
                    }
                }
                
                // For essential features, only block if explicitly disabled
                // Cek storeConfig per-role untuk essential features
                const roleStoreConfigE = storeConfig?.permissions?.[userRole] ?? storeConfig?.[userRole];
                const effectiveStoreConfigE = roleStoreConfigE ?? storeConfig?.permissions ?? storeConfig;

                if (essentialFeatures.includes(featureKey)) {
                    // Role-based restriction
                    if (roleAccess && roleAccess[featureKey] === false) return false;
                    // Store level restriction  
                    if (effectiveStoreConfigE && effectiveStoreConfigE[featureKey] === false) return false;
                    // Default to enabled for essential features
                    return true;
                }
                
                // Cek storeConfig per-role (baru), fallback ke flat (lama)
                const roleStoreConfig = storeConfig?.permissions?.[userRole] ?? storeConfig?.[userRole];
                const effectiveStoreConfig = roleStoreConfig ?? storeConfig?.permissions ?? storeConfig;

                // Priority: Role Access (tenant level) -> Store Config (store level)
                if (roleAccess && roleAccess[featureKey] === false) return false;
                if (userProfile?.role === 'owner') return true; // Owner always has access unless explicitly locked
                if (effectiveStoreConfig && effectiveStoreConfig[featureKey] === false) return false;
                return true;
            };

            // Subscription status calculation
            const subscriptionStatus = useMemo(() => {
                if (!activeOwner) return null;
                const sub = activeOwner.subscription;
                if (!sub || !sub.expiresAt) return { status: 'none', remainingDays: 0, expired: true };
                
                const now = new Date();
                const expiresAt = sub.expiresAt?.toDate ? sub.expiresAt.toDate() : new Date(sub.expiresAt);
                const activatedAt = sub.activatedAt?.toDate ? sub.activatedAt.toDate() : (sub.activatedAt ? new Date(sub.activatedAt) : null);
                const diffMs = expiresAt.getTime() - now.getTime();
                const remainingDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                
                return {
                    status: remainingDays > 0 ? 'active' : 'expired',
                    remainingDays: Math.max(0, remainingDays),
                    expiresAt,
                    activatedAt,
                    expired: remainingDays <= 0,
                    amount: sub.amount || 0
                };
            }, [activeOwner]);

            return (
                <SessionContext.Provider value={{ 
                    user: userProfile, authUser, activeOwner, activeStore, availableStores, ownerAccess, storeConfig, 
                    switchStore, enterTenantContext, logout: handleLogout,
                    checkPermission, loading, subscriptionStatus, adminWhatsApp, subConfig
                }}>
                    {children}
                </SessionContext.Provider>
            );
        };

        const PublicTrackingView = ({ token, onBack }) => {
            const [service, setService] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [store, setStore] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const adminToken = await getAdminToken();
                        const headers = adminToken ? { 'Authorization': adminToken } : {};

                        // Cari by token field
                        const res1 = await fetch(`${POCKETBASE_URL}/api/collections/services/records?filter=${encodeURIComponent(`token="${token}"`)}&perPage=1`, { headers });
                        let foundService = null;
                        if (res1.ok) {
                            const data1 = await res1.json();
                            if (data1.items && data1.items.length > 0) {
                                const r = data1.items[0];
                                foundService = { id: r.id, ...r };
                            }
                        }
                        // Fallback: cari by publicToken
                        if (!foundService) {
                            const res2 = await fetch(`${POCKETBASE_URL}/api/collections/services/records?filter=${encodeURIComponent(`publicToken="${token}"`)}&perPage=1`, { headers });
                            if (res2.ok) {
                                const data2 = await res2.json();
                                if (data2.items && data2.items.length > 0) {
                                    const r = data2.items[0];
                                    foundService = { id: r.id, ...r };
                                }
                            }
                        }

                        if (foundService) {
                            setService(foundService);
                            if (foundService.storeId) {
                                const storeRes = await fetch(`${POCKETBASE_URL}/api/collections/stores/records/${encodeURIComponent(foundService.storeId)}`, { headers });
                                if (storeRes.ok) setStore(await storeRes.json());
                            }
                        } else {
                            setError('Data servis tidak ditemukan. Periksa kembali token Anda.');
                        }
                    } catch (err) {
                        setError('Gagal memuat data. ' + err.message);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, [token]);

            if(loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="text-center"><Loader2 className="w-10 h-10 animate-spin text-blue-600 mx-auto mb-4"/><p className="text-slate-500">Mencari Data Servis...</p></div></div>;
            if(error) return <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6"><div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full"><div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><SearchX className="w-8 h-8"/></div><h2 className="text-xl font-bold text-slate-800 mb-2">Maaf!</h2><p className="text-slate-500 mb-6">{error}</p><button onClick={onBack} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold w-full">Kembali</button></div></div>;
            const isDone = ['Selesai', 'Diambil'].includes(service.status);
            const statusColor = isDone ? 'bg-green-500' : service.status === 'Dibatalkan' ? 'bg-red-500' : 'bg-blue-500';
            return (
                <div className="min-h-screen bg-slate-100 py-10 px-4">
                    <div className="max-w-lg mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
                        <div className="bg-slate-900 p-6 text-white text-center relative">{store?.logo ? <img src={store.logo} className="w-16 h-16 object-contain mx-auto mb-3 bg-white rounded-lg p-1"/> : <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center font-bold text-2xl mx-auto mb-3">iF</div>}<h1 className="font-bold text-xl">{store?.name || 'iFix Service Tracker'}</h1><p className="text-slate-400 text-xs mt-1">{store?.address}</p><div className="absolute top-4 right-4"><button onClick={onBack} className="text-slate-400 hover:text-white text-xs font-bold bg-slate-800 px-3 py-1 rounded-full">Login</button></div></div>
                        <div className="p-6"><div className="bg-slate-50 border border-slate-100 rounded-2xl p-5 mb-6 text-center shadow-inner"><p className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2">Status Pengerjaan</p><div className={`inline-block px-6 py-2 rounded-full text-white font-bold text-lg shadow-lg ${statusColor} mb-2`}>{service.status}</div><p className="text-xs text-slate-500">Update Terakhir: {formatDate(service.updatedAt)}</p></div><div className="space-y-4 mb-8"><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-blue-100 p-2 rounded-lg text-blue-600"><UserPlus className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Pelanggan</p><p className="font-bold text-slate-800">{service.customerName}</p></div></div></div><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-purple-100 p-2 rounded-lg text-purple-600"><Smartphone className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Perangkat</p><p className="font-bold text-slate-800">{service.unitType || service.deviceType}</p></div></div></div><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-orange-100 p-2 rounded-lg text-orange-600"><Wrench className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Keluhan</p><p className="font-bold text-slate-800">{service.complaint || service.problem}</p></div></div></div><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-green-100 p-2 rounded-lg text-green-600"><Wallet className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Biaya Estimasi</p><p className="font-bold text-green-600 text-lg">{formatCurrency(service.costEstimate)}</p></div></div></div></div><div><h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Activity className="w-5 h-5 text-blue-500"/> Riwayat Status</h3><div className="space-y-0 pl-2"><div className="relative pl-8 pb-6 timeline-item"><div className="timeline-line"></div><div className="absolute left-0 top-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center border-2 border-white shadow-sm"><CheckCheck className="w-4 h-4"/></div><p className="font-bold text-sm text-slate-800">Diterima</p><p className="text-xs text-slate-500">{formatDate(service.createdAt)}</p></div>{service.status !== 'Diterima' && (<div className="relative pl-8 pb-0 timeline-item"><div className="absolute left-0 top-0 w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center border-2 border-white shadow-sm"><Activity className="w-4 h-4"/></div><p className="font-bold text-sm text-slate-800">{service.status}</p><p className="text-xs text-slate-500">{formatDate(service.updatedAt)}</p></div>)}</div></div></div><div className="bg-slate-50 p-4 text-center text-xs text-slate-400 border-t border-slate-200">&copy; 2026 iFix Enterprise Cloud</div></div></div>
            );
        };

        
// ================================
// PLAN CONFIG (DEVELOPER)
// ================================
const ALL_ACCESS_FEATURES = [
  { id: 'menu_dashboard',      label: 'üìä Dashboard',           group: 'Menu Utama' },
  { id: 'menu_report',         label: 'üìà Laporan',              group: 'Menu Utama' },
  { id: 'menu_service',        label: 'üì± Servis HP',            group: 'Menu Transaksi' },
  { id: 'menu_sales',          label: 'üõí Penjualan',            group: 'Menu Transaksi' },
  { id: 'menu_purchase',       label: 'üõçÔ∏è Pembelian',            group: 'Menu Transaksi' },
  { id: 'menu_return_sales',   label: '‚Ü©Ô∏è Retur Penjualan',      group: 'Menu Transaksi' },
  { id: 'menu_return_purchase',label: '‚Ü™Ô∏è Retur Pembelian',      group: 'Menu Transaksi' },
  { id: 'menu_after_sales',    label: 'üõ°Ô∏è After Sales Care',     group: 'Menu Transaksi' },
  { id: 'menu_payable',        label: 'üì§ Utang',                group: 'Menu Keuangan' },
  { id: 'menu_receivable',     label: 'üì• Piutang',              group: 'Menu Keuangan' },
  { id: 'menu_cash',           label: 'üíµ Kas',                  group: 'Menu Keuangan' },
  { id: 'menu_finance',        label: 'üí≥ Laporan Keuangan',     group: 'Menu Keuangan' },
  { id: 'menu_inventory',      label: 'üì¶ Stok Barang',          group: 'Menu Inventory & Data' },
  { id: 'menu_supplier',       label: 'üöö Supplier',             group: 'Menu Inventory & Data' },
  { id: 'menu_customers',      label: 'üë• Pelanggan',            group: 'Menu Inventory & Data' },
  { id: 'menu_hr',             label: 'üëî HR & Payroll',         group: 'Menu Inventory & Data' },
  { id: 'menu_ai_assistant',   label: '‚ú® AI Assistant',          group: 'Fitur Premium' },
  { id: 'menu_users',          label: 'üë® Pegawai',              group: 'Menu Admin' },
  { id: 'menu_settings',       label: '‚öôÔ∏è Pengaturan',           group: 'Menu Admin' },
  { id: 'feature_service_edit',   label: '‚úèÔ∏è Edit Servis',       group: 'Fitur & Aksi' },
  { id: 'feature_sales_edit',     label: '‚úèÔ∏è Edit Penjualan',    group: 'Fitur & Aksi' },
  { id: 'feature_inventory_edit', label: '‚úèÔ∏è Edit Inventory',    group: 'Fitur & Aksi' },
  { id: 'feature_customer_edit',  label: '‚úèÔ∏è Edit Pelanggan',    group: 'Fitur & Aksi' },
  { id: 'feature_employee_edit',  label: '‚úèÔ∏è Edit Pegawai',      group: 'Fitur & Aksi' },
  { id: 'feature_finance_edit',   label: '‚úèÔ∏è Edit Keuangan',     group: 'Fitur & Aksi' },
  { id: 'feature_print',          label: 'üñ®Ô∏è Cetak Invoice',     group: 'Fitur & Aksi' },
  { id: 'feature_share',          label: 'üí¨ Share WhatsApp',    group: 'Fitur & Aksi' },
  { id: 'feature_delete',         label: 'üóëÔ∏è Hapus Data',        group: 'Fitur & Aksi' },
  { id: 'feature_stock_add',      label: '‚ûï Tambah Stok',       group: 'Fitur & Aksi' },
  { id: 'feature_backup',         label: 'üíæ Backup Data',       group: 'Fitur & Aksi' },
  { id: 'feature_backup_per_item',label: 'üíæ Backup Per Item',   group: 'Fitur & Aksi' },
  { id: 'feature_import_export',  label: 'üì§ Import/Export',     group: 'Fitur & Aksi' },
  { id: 'feature_multi_branch',   label: 'üè¢ Multi Cabang',      group: 'Fitur & Aksi' },
  { id: 'feature_qc_checklist',   label: '‚úÖ QC Checklist',      group: 'Fitur & Aksi' },
  { id: 'feature_kelengkapan',    label: 'üìã Kelengkapan Item',  group: 'Fitur & Aksi' },
  { id: 'feature_accounting',     label: 'üìä Akuntansi',         group: 'Fitur & Aksi' },
  { id: 'feature_subdomain',      label: 'üåê Subdomain Custom',  group: 'Fitur & Aksi' },
  // Statistik Dashboard
  { id: 'dash_servis_selesai',    label: 'üìä Status Selesai (Dashboard)',      group: 'Statistik Dashboard' },
  { id: 'dash_untung_jasa',       label: 'üí∞ Untung Jasa (Dashboard)',          group: 'Statistik Dashboard' },
  { id: 'dash_pemasukan',         label: 'üìà Pemasukan (Dashboard)',            group: 'Statistik Dashboard' },
  { id: 'dash_pengeluaran',       label: 'üìâ Pengeluaran (Dashboard)',          group: 'Statistik Dashboard' },
  { id: 'dash_untung_jual',       label: 'üíπ Untung Jual (Dashboard)',          group: 'Statistik Dashboard' },
  { id: 'dash_komp_retur',        label: 'üîÑ Kompensasi Retur (Dashboard)',     group: 'Statistik Dashboard' },
  { id: 'dash_nilai_stok',        label: 'üì¶ Nilai Stok (Dashboard)',           group: 'Statistik Dashboard' },
  { id: 'dash_total_keuntungan',  label: 'üèÜ Total Keuntungan (Dashboard)',     group: 'Statistik Dashboard' },
  // Visibilitas Data
  { id: 'feature_show_modal',     label: 'üëÅÔ∏è Lihat Harga Modal/Beli',          group: 'Visibilitas Data' },
];

// Default paket (saran awal - bisa diubah dari UI)
const PLAN_DEFAULTS = {
  basic: {
    menu_dashboard: true, menu_report: false,
    menu_service: true, menu_sales: true, menu_purchase: false,
    menu_return_sales: false, menu_return_purchase: false, menu_after_sales: false,
    menu_payable: false, menu_receivable: false, menu_cash: false, menu_finance: false,
    menu_inventory: true, menu_supplier: false, menu_customers: true, menu_hr: false,
    menu_ai_assistant: false,
    menu_users: true, menu_settings: true,
    feature_service_edit: true, feature_sales_edit: true, feature_inventory_edit: true,
    feature_customer_edit: true, feature_employee_edit: false, feature_finance_edit: false,
    feature_print: true, feature_share: true, feature_delete: false,
    feature_stock_add: true, feature_backup: false, feature_backup_per_item: false,
    feature_import_export: false, feature_multi_branch: false,
    feature_qc_checklist: false, feature_kelengkapan: false, feature_accounting: false,
    feature_subdomain: false,
    dash_servis_selesai: false, dash_untung_jasa: false, dash_pemasukan: false, dash_pengeluaran: false,
    dash_untung_jual: false, dash_komp_retur: false, dash_nilai_stok: false, dash_total_keuntungan: false,
    feature_show_modal: false,
  },
  pro: {
    menu_dashboard: true, menu_report: true,
    menu_service: true, menu_sales: true, menu_purchase: true,
    menu_return_sales: true, menu_return_purchase: true, menu_after_sales: true,
    menu_payable: true, menu_receivable: true, menu_cash: true, menu_finance: true,
    menu_inventory: true, menu_supplier: true, menu_customers: true, menu_hr: true,
    menu_ai_assistant: true,
    menu_users: true, menu_settings: true,
    feature_service_edit: true, feature_sales_edit: true, feature_inventory_edit: true,
    feature_customer_edit: true, feature_employee_edit: true, feature_finance_edit: true,
    feature_print: true, feature_share: true, feature_delete: true,
    feature_stock_add: true, feature_backup: true, feature_backup_per_item: true,
    feature_import_export: true, feature_multi_branch: true,
    feature_qc_checklist: true, feature_kelengkapan: true, feature_accounting: true,
    feature_subdomain: true,
    dash_servis_selesai: true, dash_untung_jasa: true, dash_pemasukan: true, dash_pengeluaran: true,
    dash_untung_jual: true, dash_komp_retur: true, dash_nilai_stok: true, dash_total_keuntungan: true,
    feature_show_modal: true,
  }
};

// Warisan ‚Äî tetap ada agar tidak error jika ada kode lain yang pakai PLAN_FEATURES
const PLAN_FEATURES = ALL_ACCESS_FEATURES;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üåê SubdomainManager ‚Äî Fitur Premium (Hanya Pro Plan)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Memungkinkan owner Pro plan untuk mengatur subdomain custom mereka.
// Contoh: tokosaya.amproject.my.id
// Cara kerja:
//   1. Owner Pro set subdomain ‚Üí disimpan ke field `subdomain` di collection `owners`
//   2. DNS Wildcard *.amproject.my.id sudah mengarah ke VPS yang sama
//   3. Saat user buka tokosaya.amproject.my.id, app ‚Üí deteksi subdomain ‚Üí
//      baca `owners` collection ‚Üí tampilkan branding toko di halaman login
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SubdomainManager = ({ activeOwner }) => {
    const { ownerAccess } = React.useContext(SessionContext);
    // Aktif jika developer mengizinkan feature_subdomain DAN plan pro
    const isPro = (activeOwner?.plan || '').toLowerCase() === 'pro'
                  && ownerAccess?.feature_subdomain !== false;
    const BASE_DOMAIN = 'amproject.my.id';

    const [subdomain, setSubdomain] = React.useState(activeOwner?.subdomain || '');
    const [savedSubdomain, setSavedSubdomain] = React.useState(activeOwner?.subdomain || '');
    const [checking, setChecking]   = React.useState(false);
    const [saving, setSaving]       = React.useState(false);
    const [msg, setMsg]             = React.useState(null); // { type: 'ok'|'err'|'warn', text }
    const [isOpen, setIsOpen]       = React.useState(false);

    // Validasi format subdomain
    const SUBDOMAIN_RE = /^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/;
    const isValidFormat = subdomain.length >= 3 && SUBDOMAIN_RE.test(subdomain);

    // Cek apakah subdomain sudah dipakai owner lain
    const checkAvailability = async () => {
        if (!isValidFormat) return;
        setChecking(true);
        setMsg(null);
        try {
            const res = await pb.collection('owners').getList(1, 1, {
                filter: `subdomain = "${subdomain}" && id != "${activeOwner.id}"`,
                fields: 'id'
            });
            if (res.items.length > 0) {
                setMsg({ type: 'err', text: `‚ùå Subdomain "${subdomain}" sudah digunakan oleh tenant lain.` });
            } else {
                setMsg({ type: 'ok', text: `‚úÖ Subdomain "${subdomain}.${BASE_DOMAIN}" tersedia!` });
            }
        } catch (e) {
            setMsg({ type: 'warn', text: '‚ö†Ô∏è Gagal memeriksa ketersediaan: ' + e.message });
        } finally {
            setChecking(false);
        }
    };

    // Simpan subdomain ke PocketBase
    const saveSubdomain = async () => {
        if (!isValidFormat || msg?.type === 'err') return;
        setSaving(true);
        setMsg(null);
        try {
            // Cek sekali lagi sebelum simpan
            const res = await pb.collection('owners').getList(1, 1, {
                filter: `subdomain = "${subdomain}" && id != "${activeOwner.id}"`,
                fields: 'id'
            });
            if (res.items.length > 0) {
                setMsg({ type: 'err', text: `‚ùå Subdomain "${subdomain}" sudah digunakan.` });
                setSaving(false);
                return;
            }
            await pb.collection('owners').update(activeOwner.id, { subdomain: subdomain.toLowerCase() });
            setSavedSubdomain(subdomain.toLowerCase());
            setMsg({ type: 'ok', text: `‚úÖ Subdomain berhasil disimpan! Akses via: ${subdomain}.${BASE_DOMAIN}` });
        } catch (e) {
            setMsg({ type: 'err', text: '‚ùå Gagal menyimpan: ' + e.message });
        } finally {
            setSaving(false);
        }
    };

    // Hapus / reset subdomain
    const removeSubdomain = async () => {
        if (!confirm('Hapus subdomain custom Anda? Toko tidak lagi bisa diakses via subdomain.')) return;
        setSaving(true);
        try {
            await pb.collection('owners').update(activeOwner.id, { subdomain: '' });
            setSubdomain('');
            setSavedSubdomain('');
            setMsg({ type: 'warn', text: 'üóëÔ∏è Subdomain dihapus.' });
        } catch (e) {
            setMsg({ type: 'err', text: '‚ùå Gagal menghapus: ' + e.message });
        } finally {
            setSaving(false);
        }
    };

    return (
        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-purple-500 overflow-hidden">
            {/* Header / toggle */}
            <button onClick={() => setIsOpen(o => !o)}
                className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-slate-800">
                    <Globe className="w-5 h-5 text-purple-600"/>
                    Subdomain Custom
                    {isPro
                        ? <span className="text-xs font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full ml-1">PRO ‚úì</span>
                        : ownerAccess?.feature_subdomain === false
                            ? <span className="text-xs font-bold bg-red-100 text-red-600 px-2 py-0.5 rounded-full ml-1">üîí Dinonaktifkan</span>
                            : <span className="text-xs font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full ml-1">üîí PRO</span>
                    }
                </h3>
                <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}/>
            </button>

            {isOpen && (
            <div className="px-4 sm:px-5 pb-4 sm:pb-5 border-t border-slate-100 pt-4 space-y-4">

                {/* Locked state */}
                {!isPro ? (
                    <div className="bg-gradient-to-br from-slate-50 to-purple-50 border border-purple-200 rounded-xl p-5 text-center space-y-3">
                        <div className="text-4xl">{ownerAccess?.feature_subdomain === false ? 'üö´' : 'üîí'}</div>
                        <h4 className="font-bold text-slate-700">
                            {ownerAccess?.feature_subdomain === false ? 'Fitur Dinonaktifkan' : 'Fitur Premium ‚Äî Pro Plan'}
                        </h4>
                        <p className="text-sm text-slate-500 leading-relaxed">
                            {ownerAccess?.feature_subdomain === false
                                ? 'Fitur Subdomain Custom telah dinonaktifkan oleh developer untuk akun Anda. Hubungi developer untuk mengaktifkannya.'
                                : <>Dapatkan subdomain eksklusif untuk bisnis Anda.<br/>
                                    <span className="font-bold text-purple-600">namatoko.amproject.my.id</span><br/>
                                    Tampilkan identitas toko Anda langsung di URL.</>
                            }
                        </p>
                        {ownerAccess?.feature_subdomain !== false && (
                        <div className="bg-white border border-purple-200 rounded-lg p-3 text-left space-y-1.5 text-sm">
                            <div className="flex items-center gap-2 text-slate-600"><CheckCircle className="w-4 h-4 text-purple-500 flex-shrink-0"/> URL eksklusif untuk toko Anda</div>
                            <div className="flex items-center gap-2 text-slate-600"><CheckCircle className="w-4 h-4 text-purple-500 flex-shrink-0"/> Halaman login berbranding toko</div>
                            <div className="flex items-center gap-2 text-slate-600"><CheckCircle className="w-4 h-4 text-purple-500 flex-shrink-0"/> Mudah dibagikan ke karyawan</div>
                            <div className="flex items-center gap-2 text-slate-600"><CheckCircle className="w-4 h-4 text-purple-500 flex-shrink-0"/> Tampil lebih profesional</div>
                        </div>
                        )}
                        <p className="text-xs text-slate-400">
                            {ownerAccess?.feature_subdomain === false
                                ? 'üí° Hubungi developer untuk mengaktifkan fitur ini'
                                : 'üí° Hubungi developer untuk upgrade ke Pro Plan'}
                        </p>
                    </div>
                ) : (
                    <div className="space-y-4">
                        {/* Penjelasan singkat */}
                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-3 text-sm text-purple-800 leading-relaxed">
                            <p className="font-bold mb-1">üåê Cara Kerja Subdomain</p>
                            <p>Setelah subdomain diatur, bisnis Anda dapat diakses via URL:</p>
                            <p className="font-mono font-bold mt-1 text-purple-700 break-all">
                                {subdomain
                                    ? `https://${subdomain}.${BASE_DOMAIN}`
                                    : `https://[subdomain].${BASE_DOMAIN}`}
                            </p>
                            <p className="text-xs text-purple-600 mt-2">
                                DNS Wildcard <code>*.{BASE_DOMAIN}</code> sudah aktif ‚Äî tidak perlu konfigurasi DNS tambahan.
                            </p>
                        </div>

                        {/* Subdomain saat ini */}
                        {savedSubdomain && (
                            <div className="bg-green-50 border border-green-300 rounded-lg p-3 flex items-center justify-between">
                                <div>
                                    <p className="text-xs font-bold text-green-700 uppercase">Subdomain Aktif</p>
                                    <p className="font-mono font-bold text-green-800 text-sm break-all">
                                        {savedSubdomain}.{BASE_DOMAIN}
                                    </p>
                                </div>
                                <button onClick={removeSubdomain} disabled={saving}
                                    className="text-xs bg-red-100 text-red-600 hover:bg-red-200 font-bold px-2 py-1 rounded-lg transition-colors flex-shrink-0 ml-2">
                                    Hapus
                                </button>
                            </div>
                        )}

                        {/* Input subdomain */}
                        <div>
                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Atur Subdomain</label>
                            <div className="flex gap-2">
                                <div className="flex flex-1 border border-slate-300 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-purple-400">
                                    <input
                                        type="text"
                                        value={subdomain}
                                        onChange={e => {
                                            setSubdomain(e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, ''));
                                            setMsg(null);
                                        }}
                                        placeholder="namatoko"
                                        className="flex-1 px-3 py-2.5 text-sm outline-none"
                                        maxLength={40}
                                    />
                                    <span className="bg-slate-100 text-slate-500 text-xs font-bold px-3 flex items-center border-l border-slate-300 whitespace-nowrap">
                                        .{BASE_DOMAIN}
                                    </span>
                                </div>
                                <button onClick={checkAvailability} disabled={!isValidFormat || checking}
                                    className="px-3 py-2 bg-slate-700 text-white text-xs font-bold rounded-xl hover:bg-slate-800 disabled:opacity-40 transition-colors whitespace-nowrap">
                                    {checking ? '...' : 'Cek'}
                                </button>
                            </div>
                            <p className="text-xs text-slate-400 mt-1">
                                Gunakan huruf kecil, angka, dan tanda hubung (-). Min. 3 karakter.
                            </p>
                        </div>

                        {/* Pesan status */}
                        {msg && (
                            <div className={`text-sm font-medium px-3 py-2 rounded-lg border ${
                                msg.type === 'ok'   ? 'bg-green-50 text-green-700 border-green-200' :
                                msg.type === 'err'  ? 'bg-red-50 text-red-600 border-red-200' :
                                                      'bg-yellow-50 text-yellow-700 border-yellow-200'
                            }`}>
                                {msg.text}
                            </div>
                        )}

                        {/* Tombol simpan */}
                        <button
                            onClick={saveSubdomain}
                            disabled={!isValidFormat || saving || msg?.type === 'err'}
                            className="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white p-3 rounded-xl font-bold hover:from-purple-700 hover:to-blue-700 disabled:opacity-40 transition-all shadow-lg flex items-center justify-center gap-2">
                            {saving
                                ? <><Loader2 className="w-4 h-4 animate-spin"/> Menyimpan...</>
                                : <><Globe className="w-4 h-4"/> Simpan Subdomain</>
                            }
                        </button>

                        {/* Panduan DNS */}
                        <details className="text-xs text-slate-500 border border-slate-200 rounded-lg overflow-hidden">
                            <summary className="px-3 py-2 cursor-pointer font-bold bg-slate-50 hover:bg-slate-100">
                                üìñ Panduan Teknis & Cara Bagikan URL
                            </summary>
                            <div className="px-3 py-2 space-y-1.5 leading-relaxed">
                                <p><span className="font-bold">DNS:</span> Domain <code>*.amproject.my.id</code> sudah dikonfigurasi wildcard oleh developer ‚Äî tidak perlu setting DNS sendiri.</p>
                                <p><span className="font-bold">Bagikan ke karyawan:</span> Minta karyawan buka <code>{savedSubdomain || 'namatoko'}.{BASE_DOMAIN}</code> ‚Äî halaman login akan otomatis menampilkan nama toko Anda.</p>
                                <p><span className="font-bold">Penting:</span> Setelah simpan, tunggu 1-2 menit agar perubahan aktif.</p>
                            </div>
                        </details>
                    </div>
                )}
            </div>
            )}
        </div>
    );
};

const PlanConfigModal = ({ close }) => {
  const [configs, setConfigs] = React.useState({ basic: null, pro: null });
  const [saving, setSaving] = React.useState(null); // 'basic' | 'pro' | null
  const [applying, setApplying] = React.useState(null); // 'basic' | 'pro' | null
  const [activeTab, setActiveTab] = React.useState('basic'); // untuk mobile

  // Load kedua paket sekaligus
  React.useEffect(() => {
    const load = async (plan) => {
      try {
        const planId = _planDocId(plan);
        const record = await pb.collection('plan_configs').getOne(planId);
        // Baca dari field 'settings' (JSON) ‚Äî berisi semua toggle fitur
        // Fallback ke PLAN_DEFAULTS jika settings belum ada
        const saved = (record.settings && typeof record.settings === 'object' && Object.keys(record.settings).length > 0)
            ? record.settings
            : null;
        const data = saved
            ? { ...PLAN_DEFAULTS[plan], ...saved }  // merge: default + saved (saved override)
            : { ...PLAN_DEFAULTS[plan] };
        setConfigs(prev => ({ ...prev, [plan]: data }));
      } catch (err) {
        // Paket belum ada di DB ‚Üí gunakan default
        setConfigs(prev => ({ ...prev, [plan]: { ...PLAN_DEFAULTS[plan] } }));
      }
    };
    load('basic');
    load('pro');
  }, []);

  const toggle = (plan, key) => {
    setConfigs(prev => ({ ...prev, [plan]: { ...prev[plan], [key]: !prev[plan][key] } }));
  };

  const resetToDefault = (plan) => {
    if (!confirm(`Reset paket ${plan.toUpperCase()} ke saran default?`)) return;
    setConfigs(prev => ({ ...prev, [plan]: { ...PLAN_DEFAULTS[plan] } }));
  };

  const savePlan = async (plan) => {
    setSaving(plan);
    try {
      const planId = _planDocId(plan);
      // Simpan semua toggle ke dalam field 'settings' (JSON) agar tidak terbatas schema
      const settings = { ...configs[plan] };
      delete settings.id; delete settings.collectionId; delete settings.collectionName; delete settings.expand;
      try {
        await pb.collection('plan_configs').update(planId, { plan, settings });
      } catch (e) {
        if (e.status === 404) {
          await pb.collection('plan_configs').create({ id: planId, plan, settings });
        } else throw e;
      }
      alert(`‚úÖ Paket ${plan.toUpperCase()} berhasil disimpan!`);
    } catch (e) {
      alert('Gagal simpan: ' + e.message);
    } finally {
      setSaving(null);
    }
  };

  const applyToAllOwners = async (plan) => {
    if (!confirm(`Terapkan pengaturan paket ${plan.toUpperCase()} ke SEMUA tenant dengan paket ini?\n\nIni akan menimpa hak akses custom mereka.`)) return;
    setApplying(plan);
    try {
      const rights = { ...configs[plan] };
      delete rights.id; delete rights.plan; delete rights.collectionId; delete rights.collectionName; delete rights.expand;
      // Ambil semua owner dengan plan ini
      const result = await pb.collection('owners').getFullList({ filter: `plan = "${plan}"` });
      let count = 0;
      for (const owner of result) {
        await pb.collection('owners').update(owner.id, { accessRights: rights });
        count++;
      }
      alert(`‚úÖ Berhasil diterapkan ke ${count} tenant paket ${plan.toUpperCase()}!`);
    } catch (e) {
      alert('Gagal apply: ' + e.message);
    } finally {
      setApplying(null);
    }
  };

  const groups = [...new Set(ALL_ACCESS_FEATURES.map(f => f.group))];
  const groupColors = {
    'Menu Utama':          'border-blue-500/40 bg-blue-900/10',
    'Menu Transaksi':      'border-green-500/40 bg-green-900/10',
    'Menu Keuangan':       'border-yellow-500/40 bg-yellow-900/10',
    'Menu Inventory & Data': 'border-purple-500/40 bg-purple-900/10',
    'Menu Admin':          'border-red-500/40 bg-red-900/10',
    'Fitur & Aksi':        'border-cyan-500/40 bg-cyan-900/10',
  };
  const groupTextColors = {
    'Menu Utama': 'text-blue-300', 'Menu Transaksi': 'text-green-300',
    'Menu Keuangan': 'text-yellow-300', 'Menu Inventory & Data': 'text-purple-300',
    'Menu Admin': 'text-red-300', 'Fitur & Aksi': 'text-cyan-300',
  };

        const PlanColumn = ({ plan, label, accentClass, accentText, badgeClass, onSave, onApply, saving, applying }) => {
    const cfg = configs[plan];
    if (!cfg) return <div className="flex-1 flex items-center justify-center py-20"><div className="w-8 h-8 border-2 border-slate-500 border-t-white rounded-full animate-spin"/></div>;
    const enabledCount = ALL_ACCESS_FEATURES.filter(f => cfg[f.id] !== false && cfg[f.id]).length;
    const allActive = enabledCount === ALL_ACCESS_FEATURES.length;
    return (
      <div className="flex-1 flex flex-col min-w-0 min-h-0">
        {/* Header kolom */}
        <div className={`rounded-xl border p-3 mb-3 ${accentClass}`}>
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-2 flex-wrap">
              <Crown className={`w-4 h-4 ${accentText}`}/>
              <span className={`font-black text-base uppercase ${accentText}`}>{label}</span>
              <span className={`text-xs px-2 py-0.5 rounded-full font-bold ${badgeClass}`}>{enabledCount}/{ALL_ACCESS_FEATURES.length}</span>
              {allActive && <span className="text-xs px-2 py-0.5 rounded-full font-black bg-green-900/50 text-green-300 border border-green-500/40">‚úì SEMUA FITUR LENGKAP</span>}
            </div>
            <button onClick={() => resetToDefault(plan)} className="text-xs text-slate-400 hover:text-white underline ml-2 flex-shrink-0">Reset</button>
          </div>
          <div className="grid grid-cols-2 gap-1.5">
            <button onClick={() => setConfigs(prev => {
              const all = {}; ALL_ACCESS_FEATURES.forEach(f => all[f.id] = true);
              return { ...prev, [plan]: { ...prev[plan], ...all } };
            })} className="text-xs py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold">‚úÖ Semua Aktif</button>
            <button onClick={() => setConfigs(prev => {
              const none = {}; ALL_ACCESS_FEATURES.forEach(f => none[f.id] = false);
              return { ...prev, [plan]: { ...prev[plan], ...none } };
            })} className="text-xs py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold">‚ùå Semua Mati</button>
          </div>
        </div>

        {/* Daftar fitur per grup - scroll area */}
        <div className="space-y-2 overflow-y-auto flex-1 pr-0.5 min-h-0 overscroll-contain">
          {groups.map(grp => (
            <div key={grp} className={`rounded-lg border p-2.5 ${groupColors[grp] || ''}`}>
              <p className={`text-xs font-black uppercase mb-1.5 ${groupTextColors[grp] || 'text-slate-300'}`}>{grp}</p>
              <div className="space-y-1">
                {ALL_ACCESS_FEATURES.filter(f => f.group === grp).map(f => (
                  <label key={f.id} className="flex items-center justify-between bg-slate-900/70 px-2 py-1.5 rounded cursor-pointer hover:bg-slate-800 transition-colors">
                    <span className="text-slate-300 text-xs">{f.label}</span>
                    <div className="relative flex items-center ml-2 flex-shrink-0">
                      <input type="checkbox" checked={!!cfg[f.id]} onChange={() => toggle(plan, f.id)} className="peer sr-only"/>
                      <div className="w-9 h-5 bg-slate-700 rounded-full peer peer-checked:after:translate-x-4 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"/>
                    </div>
                  </label>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[120] flex items-center justify-center p-2 md:p-4">
      <div className="bg-slate-800 border border-slate-700 w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col" style={{maxHeight:'96vh'}}>
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-slate-700">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center">
              <Crown className="w-5 h-5 text-white"/>
            </div>
            <div>
              <h3 className="font-black text-white text-lg">Konfigurasi Paket Langganan</h3>
              <p className="text-xs text-slate-400">Atur fitur yang tersedia di setiap paket</p>
            </div>
          </div>
          <button onClick={close} className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg"><X className="w-5 h-5"/></button>
        </div>

        {/* Info box */}
        <div className="px-4 pt-3">
          <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg px-3 py-2 text-xs text-yellow-200 flex gap-2">
            <span className="text-yellow-400 font-bold flex-shrink-0">üí° Cara kerja:</span>
            <span>Simpan = hanya update template paket di database. <strong>Terapkan ke Semua Tenant</strong> = update hak akses seluruh owner yang pakai paket ini sesuai template.</span>
          </div>
        </div>

        {/* Tab mobile */}
        <div className="md:hidden flex gap-2 px-4 pt-3">
          <button onClick={() => setActiveTab('basic')} className={`flex-1 py-2 rounded-lg font-bold text-sm ${activeTab==='basic' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400'}`}>üì¶ Basic</button>
          <button onClick={() => setActiveTab('pro')} className={`flex-1 py-2 rounded-lg font-bold text-sm ${activeTab==='pro' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-400'}`}>üëë Pro</button>
        </div>

        {/* Kolom konten */}
        <div className="flex gap-4 p-4 flex-1 min-h-0 overflow-hidden">
          {/* Desktop: berdampingan | Mobile: tab */}
          <div className={`flex-1 flex flex-col min-w-0 min-h-0 ${activeTab !== 'basic' ? 'hidden md:flex' : 'flex'}`}>
            {PlanColumn({ plan: 'basic', label: 'Basic', accentClass: 'border-blue-500/40 bg-blue-900/10', accentText: 'text-blue-300', badgeClass: 'bg-blue-900/50 text-blue-300 border border-blue-500/30' })}
          </div>
          <div className="hidden md:block w-px bg-slate-700 flex-shrink-0"/>
          <div className={`flex-1 flex flex-col min-w-0 min-h-0 ${activeTab !== 'pro' ? 'hidden md:flex' : 'flex'}`}>
            {PlanColumn({ plan: 'pro', label: 'Pro', accentClass: 'border-purple-500/40 bg-purple-900/10', accentText: 'text-purple-300', badgeClass: 'bg-purple-900/50 text-purple-300 border border-purple-500/30' })}
          </div>
        </div>

        {/* FOOTER STICKY ‚Äî tombol simpan selalu terlihat */}
        <div className="px-4 py-3 border-t border-slate-700 bg-slate-800 rounded-b-2xl flex-shrink-0">
          {/* Mobile: tombol untuk tab aktif saja */}
          <div className="md:hidden space-y-2">
            <button onClick={() => savePlan(activeTab)} disabled={!!saving}
              className={`w-full py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-lg ${saving===activeTab ? 'bg-slate-600 text-slate-400' : activeTab==='pro' ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}>
              {saving===activeTab ? <><div className="w-4 h-4 border-2 border-slate-400 border-t-white rounded-full animate-spin"/> Menyimpan...</> : <><Save className="w-4 h-4"/> Simpan Paket {activeTab.toUpperCase()}</>}
            </button>
            <button onClick={() => applyToAllOwners(activeTab)} disabled={!!applying}
              className="w-full py-2.5 rounded-xl font-bold text-sm border border-orange-500/50 text-orange-300 hover:bg-orange-900/20 flex items-center justify-center gap-2">
              {applying===activeTab ? <><div className="w-4 h-4 border-2 border-orange-400 border-t-white rounded-full animate-spin"/> Menerapkan...</> : <><RefreshCw className="w-4 h-4"/> Terapkan ke Semua {activeTab.toUpperCase()}</>}
            </button>
          </div>
          {/* Desktop: 2 kolom berdampingan */}
          <div className="hidden md:grid grid-cols-2 gap-3">
            <div className="space-y-1.5">
              <button onClick={() => savePlan('basic')} disabled={!!saving}
                className={`w-full py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 ${saving==='basic' ? 'bg-slate-600 text-slate-400' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}>
                {saving==='basic' ? <><div className="w-4 h-4 border-2 border-slate-400 border-t-white rounded-full animate-spin"/> Menyimpan...</> : <><Save className="w-4 h-4"/> Simpan Basic</>}
              </button>
              <button onClick={() => applyToAllOwners('basic')} disabled={!!applying}
                className="w-full py-2 rounded-xl font-bold text-xs border border-orange-500/40 text-orange-300 hover:bg-orange-900/20 flex items-center justify-center gap-2">
                {applying==='basic' ? <><div className="w-4 h-4 border-2 border-orange-400 border-t-white rounded-full animate-spin"/> Menerapkan...</> : <><RefreshCw className="w-3.5 h-3.5"/> Terapkan ke Semua Basic</>}
              </button>
            </div>
            <div className="space-y-1.5">
              <button onClick={() => savePlan('pro')} disabled={!!saving}
                className={`w-full py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 ${saving==='pro' ? 'bg-slate-600 text-slate-400' : 'bg-purple-600 hover:bg-purple-700 text-white'}`}>
                {saving==='pro' ? <><div className="w-4 h-4 border-2 border-slate-400 border-t-white rounded-full animate-spin"/> Menyimpan...</> : <><Save className="w-4 h-4"/> Simpan Pro</>}
              </button>
              <button onClick={() => applyToAllOwners('pro')} disabled={!!applying}
                className="w-full py-2 rounded-xl font-bold text-xs border border-orange-500/40 text-orange-300 hover:bg-orange-900/20 flex items-center justify-center gap-2">
                {applying==='pro' ? <><div className="w-4 h-4 border-2 border-orange-400 border-t-white rounded-full animate-spin"/> Menerapkan...</> : <><RefreshCw className="w-3.5 h-3.5"/> Terapkan ke Semua Pro</>}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const CategoryItemsModal = ({ close, ownerId, storeId }) => {
    const [categories, setCategories] = useState(['Sparepart', 'Aksesori', 'Tools', 'Lainnya']);
    const [customCategories, setCustomCategories] = useState([]);
    const [subCategories, setSubCategories] = useState({});
    const [newCategory, setNewCategory] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('');
    const [newSubCategory, setNewSubCategory] = useState('');
    const [loading, setLoading] = useState(false);
    const [deleting, setDeleting] = useState(null);
    const [editingCat, setEditingCat] = useState(null);
    const [editCatValue, setEditCatValue] = useState('');
    const [editingSub, setEditingSub] = useState(null);
    const [editSubValue, setEditSubValue] = useState('');

    useEffect(() => {
        if (!ownerId) return;
        // Load custom categories and subcategories from Firestore
        let q;
        if (storeId) {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId));
        } else {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId));
        }
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const configs = snapshot.docs.map(doc => doc.data());
            const allCats = new Set([...categories]);
            const allSubs = {};
            configs.forEach(config => {
                if (config.customCategories && Array.isArray(config.customCategories)) {
                    config.customCategories.forEach(cat => allCats.add(cat));
                }
                if (config.subCategories && typeof config.subCategories === 'object') {
                    Object.assign(allSubs, config.subCategories);
                }
            });
            setCustomCategories(Array.from(allCats).filter(c => !categories.includes(c)));
            setSubCategories(allSubs);
        });
        if (window.firestoreListeners) window.firestoreListeners.add(unsubscribe);
        return () => {
            if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribe);
            unsubscribe();
        };
    }, [ownerId, storeId]);

    const addCategory = async (e) => {
        e.preventDefault();
        if (!newCategory.trim()) return;
        if ([...categories, ...customCategories].includes(newCategory)) {
            alert('Kategori sudah ada!');
            return;
        }

        setLoading(true);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                const configData = {
                    ownerId: ownerId,
                    customCategories: [newCategory],
                    createdAt: serverTimestamp()
                };
                if (storeId) configData.storeId = storeId;
                await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), configData);
            } else {
                const docRef = snapshot.docs[0].ref;
                const existing = snapshot.docs[0].data().customCategories || [];
                if (!existing.includes(newCategory)) {
                    await updateDoc(docRef, {
                        customCategories: [...existing, newCategory]
                    });
                }
            }
            setNewCategory('');
            alert('Kategori berhasil ditambahkan!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    const addSubCategory = async (e) => {
        e.preventDefault();
        if (!selectedCategory || !newSubCategory.trim()) return;
        
        const existingSubs = subCategories[selectedCategory] || [];
        if (existingSubs.includes(newSubCategory)) {
            alert('Sub-kategori sudah ada!');
            return;
        }

        setLoading(true);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            
            const updatedSubs = {
                ...subCategories,
                [selectedCategory]: [...existingSubs, newSubCategory]
            };
            
            if (snapshot.empty) {
                const configData = {
                    ownerId: ownerId,
                    subCategories: updatedSubs,
                    createdAt: serverTimestamp()
                };
                if (storeId) configData.storeId = storeId;
                await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), configData);
            } else {
                await updateDoc(snapshot.docs[0].ref, {
                    subCategories: updatedSubs
                });
            }
            setNewSubCategory('');
            alert('Sub-kategori berhasil ditambahkan!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    const deleteCategory = async (category) => {
        if (!confirm(`Hapus kategori "${category}"?`)) return;
        
        setDeleting(category);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId));
            }
            const snapshot = await getDocs(q);
            
            for (const docSnap of snapshot.docs) {
                const existing = docSnap.data().customCategories || [];
                const updated = existing.filter(c => c !== category);
                await updateDoc(docSnap.ref, { customCategories: updated });
            }
            alert('Kategori berhasil dihapus!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setDeleting(null);
        }
    };

    const deleteSubCategory = async (category, subCat) => {
        if (!confirm(`Hapus sub-kategori "${subCat}"?`)) return;
        
        setDeleting(`${category}_${subCat}`);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            
            if (!snapshot.empty) {
                const existingSubs = subCategories[category] || [];
                const updatedSubs = {
                    ...subCategories,
                    [category]: existingSubs.filter(s => s !== subCat)
                };
                await updateDoc(snapshot.docs[0].ref, {
                    subCategories: updatedSubs
                });
            }
            alert('Sub-kategori berhasil dihapus!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setDeleting(null);
        }
    };

    const saveEditCategory = async (oldName) => {
        const newName = editCatValue.trim();
        if (!newName || newName === oldName) { setEditingCat(null); return; }
        if ([...categories, ...customCategories].includes(newName)) {
            alert('Nama kategori sudah ada!'); return;
        }
        setLoading(true);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId));
            }
            const snapshot = await getDocs(q);
            for (const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const existing = data.customCategories || [];
                const updatedCats = existing.map(c => c === oldName ? newName : c);
                const updatedSubs = {};
                Object.keys(data.subCategories || {}).forEach(k => {
                    updatedSubs[k === oldName ? newName : k] = (data.subCategories || {})[k];
                });
                await updateDoc(docSnap.ref, { customCategories: updatedCats, subCategories: updatedSubs });
            }
            setEditingCat(null);
            alert('Kategori berhasil diubah!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    const saveEditSubCategory = async (cat, oldSub) => {
        const newSub = editSubValue.trim();
        if (!newSub || newSub === oldSub) { setEditingSub(null); return; }
        const existingSubs = subCategories[cat] || [];
        if (existingSubs.includes(newSub)) {
            alert('Nama sub-kategori sudah ada!'); return;
        }
        setLoading(true);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                const updatedSubs = {
                    ...subCategories,
                    [cat]: existingSubs.map(s => s === oldSub ? newSub : s)
                };
                await updateDoc(snapshot.docs[0].ref, { subCategories: updatedSubs });
            }
            setEditingSub(null);
            alert('Sub-kategori berhasil diubah!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    const allCategories = [...categories, ...customCategories];

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-gradient-to-r from-orange-600 to-orange-500 p-6 text-white flex items-center justify-between">
                    <h2 className="font-bold text-xl flex items-center gap-2"><Tag className="w-6 h-6"/> Kelola Kategori & Sub-Kategori</h2>
                    <button onClick={close} className="p-1 hover:bg-white/20 rounded-lg"><X className="w-6 h-6"/></button>
                </div>

                <div className="p-6 space-y-6">
                    {/* Add Category */}
                    <div className="bg-orange-50 p-4 rounded-xl border border-orange-200">
                        <h3 className="font-bold text-orange-900 mb-3">Tambah Kategori Baru</h3>
                        <form onSubmit={addCategory} className="flex flex-col sm:flex-row gap-2">
                            <input 
                                type="text" 
                                placeholder="Contoh: LCD, Baterai, IC..."
                                value={newCategory}
                                onChange={e => setNewCategory(e.target.value)}
                                className="flex-1 px-4 py-2 border border-orange-300 rounded-lg focus:outline-none focus:border-orange-500"
                            />
                            <button 
                                type="submit"
                                disabled={loading || !newCategory.trim()}
                                className="w-full sm:w-auto px-6 py-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 disabled:opacity-50 flex items-center justify-center gap-2"
                            >
                                {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : '+ Kategori'}
                            </button>
                        </form>
                    </div>

                    {/* Add Sub-Category */}
                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <h3 className="font-bold text-blue-900 mb-3">Tambah Sub-Kategori</h3>
                        <form onSubmit={addSubCategory} className="flex flex-col gap-2">
                            <div className="flex flex-col sm:flex-row gap-2">
                                <select 
                                    value={selectedCategory}
                                    onChange={e => setSelectedCategory(e.target.value)}
                                    className="w-full sm:w-auto px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:border-blue-500"
                                >
                                    <option value="">Pilih Kategori...</option>
                                    {allCategories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                                <input 
                                    type="text" 
                                    placeholder="Contoh: OLED, IPS, LCD..."
                                    value={newSubCategory}
                                    onChange={e => setNewSubCategory(e.target.value)}
                                    disabled={!selectedCategory}
                                    className="flex-1 min-w-0 px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:border-blue-500 disabled:bg-slate-100"
                                />
                            </div>
                            <button 
                                type="submit"
                                disabled={loading || !selectedCategory || !newSubCategory.trim()}
                                className="w-full sm:w-auto sm:self-end px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center gap-2"
                            >
                                {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : '+ Sub-Kategori'}
                            </button>
                        </form>
                    </div>

                    {/* Categories List */}
                    <div className="space-y-4">
                        <h3 className="font-bold text-slate-700">Kategori & Sub-Kategori ({allCategories.length})</h3>
                        <div className="space-y-3">
                            {allCategories.map((cat) => (
                                <div key={cat} className="bg-slate-50 rounded-lg border border-slate-200 p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        {editingCat === cat ? (
                                            <div className="flex items-center gap-2 flex-1 mr-2">
                                                <input
                                                    autoFocus
                                                    type="text"
                                                    value={editCatValue}
                                                    onChange={e => setEditCatValue(e.target.value)}
                                                    onKeyDown={e => { if (e.key === 'Enter') saveEditCategory(cat); if (e.key === 'Escape') setEditingCat(null); }}
                                                    className="flex-1 px-3 py-1 text-sm border border-orange-400 rounded-lg focus:outline-none focus:border-orange-600"
                                                />
                                                <button onClick={() => saveEditCategory(cat)} disabled={loading} className="px-3 py-1 bg-orange-600 text-white text-xs font-bold rounded-lg hover:bg-orange-700 disabled:opacity-50">Simpan</button>
                                                <button onClick={() => setEditingCat(null)} className="px-3 py-1 bg-slate-200 text-slate-700 text-xs font-bold rounded-lg hover:bg-slate-300">Batal</button>
                                            </div>
                                        ) : (
                                            <span className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                                <Tag className="w-4 h-4 text-orange-600" />
                                                {cat}
                                            </span>
                                        )}
                                        {editingCat !== cat && (
                                            <div className="flex items-center gap-1">
                                                {!categories.includes(cat) && (
                                                    <button
                                                        onClick={() => { setEditingCat(cat); setEditCatValue(cat); }}
                                                        className="p-1 hover:bg-orange-100 rounded text-orange-600"
                                                        title="Edit kategori"
                                                    >
                                                        <Pencil className="w-4 h-4" />
                                                    </button>
                                                )}
                                                {!categories.includes(cat) && (
                                                    <button
                                                        onClick={() => deleteCategory(cat)}
                                                        disabled={deleting === cat}
                                                        className="p-1 hover:bg-red-100 rounded text-red-600 disabled:opacity-50"
                                                        title="Hapus kategori"
                                                    >
                                                        <Trash2 className="w-4 h-4" />
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    {subCategories[cat] && subCategories[cat].length > 0 && (
                                        <div className="ml-6 mt-2 flex flex-wrap gap-2">
                                            {subCategories[cat].map(sub => (
                                                <div key={sub} className="inline-flex items-center gap-1 bg-white px-3 py-1 rounded-full border border-blue-200 text-xs">
                                                    {editingSub === `${cat}_${sub}` ? (
                                                        <>
                                                            <input
                                                                autoFocus
                                                                type="text"
                                                                value={editSubValue}
                                                                onChange={e => setEditSubValue(e.target.value)}
                                                                onKeyDown={e => { if (e.key === 'Enter') saveEditSubCategory(cat, sub); if (e.key === 'Escape') setEditingSub(null); }}
                                                                className="w-24 px-2 py-0.5 text-xs border border-blue-400 rounded focus:outline-none"
                                                            />
                                                            <button onClick={() => saveEditSubCategory(cat, sub)} disabled={loading} className="text-green-600 hover:text-green-800 disabled:opacity-50" title="Simpan">
                                                                <Check className="w-3 h-3" />
                                                            </button>
                                                            <button onClick={() => setEditingSub(null)} className="text-slate-400 hover:text-slate-600" title="Batal">
                                                                <X className="w-3 h-3" />
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <span className="text-blue-700 font-medium">{sub}</span>
                                                            <button
                                                                onClick={() => { setEditingSub(`${cat}_${sub}`); setEditSubValue(sub); }}
                                                                className="text-orange-400 hover:text-orange-600"
                                                                title="Edit sub-kategori"
                                                            >
                                                                <Pencil className="w-3 h-3" />
                                                            </button>
                                                            <button
                                                                onClick={() => deleteSubCategory(cat, sub)}
                                                                disabled={deleting === `${cat}_${sub}`}
                                                                className="text-red-500 hover:text-red-700 disabled:opacity-50"
                                                                title="Hapus sub-kategori"
                                                            >
                                                                <X className="w-3 h-3" />
                                                            </button>
                                                        </>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <p className="text-xs text-slate-500 italic">* Kategori default (Sparepart, Aksesori, Tools, Lainnya) tidak dapat dihapus</p>
                </div>

                <div className="bg-slate-100 p-4 flex gap-2 justify-end sticky bottom-0">
                    <button onClick={close} className="px-6 py-2 bg-white border border-slate-300 rounded-lg font-bold hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const BrandItemsModal = ({ close, ownerId }) => {
    const [brands, setBrands] = useState([]);
    const [newBrand, setNewBrand] = useState('');
    const [loading, setLoading] = useState(false);
    const [deleting, setDeleting] = useState(null);

    useEffect(() => {
        if (!ownerId) return;
        
        // üöÄ OPTIMIZED: Polling instead of real-time listener (brands jarang berubah)
        const fetchBrands = async () => {
            const q = query(
                collection(db, APP_COLLECTION_PREFIX, 'public', 'brands'), 
                where('ownerId', '==', ownerId)
            );
            const snapshot = await getDocs(q);
            return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        };

        const cleanup = polling(
            fetchBrands,
            (data) => setBrands(data),
            FIREBASE_OPTIMIZATION_CONFIG.POLLING_STATIC_DATA
        );

        return cleanup;
    }, [ownerId]);

    const addBrand = async (e) => {
        e.preventDefault();
        if (!newBrand.trim()) return;
        if (brands.some(b => b.name.toLowerCase() === newBrand.toLowerCase())) {
            alert('Brand sudah ada!');
            return;
        }

        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'brands'), {
                ownerId: ownerId,
                name: newBrand.trim(),
                createdAt: serverTimestamp()
            });
            setNewBrand('');
            alert('Brand berhasil ditambahkan!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    const deleteBrand = async (brandId, brandName) => {
        if (!confirm(`Hapus brand "${brandName}"?`)) return;
        
        setDeleting(brandId);
        try {
            await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'brands', brandId));
            alert('Brand berhasil dihapus!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setDeleting(null);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-gradient-to-r from-purple-600 to-purple-500 p-6 text-white flex items-center justify-between">
                    <h2 className="font-bold text-xl flex items-center gap-2"><Tag className="w-6 h-6"/> Kelola Brand Produk</h2>
                    <button onClick={close} className="p-1 hover:bg-white/20 rounded-lg"><X className="w-6 h-6"/></button>
                </div>

                <div className="p-6 space-y-4">
                    <form onSubmit={addBrand} className="flex gap-2 mb-6">
                        <input 
                            type="text" 
                            placeholder="Tambah brand baru... (contoh: Samsung, Apple, Xiaomi)"
                            value={newBrand}
                            onChange={e => setNewBrand(e.target.value)}
                            className="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-purple-500"
                        />
                        <button 
                            type="submit"
                            disabled={loading || !newBrand.trim()}
                            className="px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 disabled:opacity-50"
                        >
                            {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : '+'}
                        </button>
                    </form>

                    <div className="space-y-2">
                        <h3 className="font-bold text-slate-700 mb-3">Brand Tersedia ({brands.length})</h3>
                        {brands.length === 0 ? (
                            <div className="text-center py-8 text-slate-400">
                                <Tag className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                <p>Belum ada brand. Tambahkan brand pertama Anda!</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                {brands.map((brand) => (
                                    <div 
                                        key={brand.id}
                                        className="flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-200"
                                    >
                                        <span className="text-sm font-bold text-purple-700">{brand.name}</span>
                                        <button
                                            onClick={() => deleteBrand(brand.id, brand.name)}
                                            disabled={deleting === brand.id}
                                            className="p-1 hover:bg-red-100 rounded text-red-600 disabled:opacity-50"
                                        >
                                            <Trash2 className="w-4 h-4" />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>

                <div className="bg-slate-100 p-4 flex gap-2 justify-end sticky bottom-0">
                    <button onClick={close} className="px-6 py-2 bg-white border border-slate-300 rounded-lg font-bold hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const InventorySettingsModal = ({ close, ownerId, storeId }) => {
    const [settings, setSettings] = useState({
        preventDuplicateNames: false,
        preventDuplicatePrices: false
    });
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!ownerId) return;
        let q;
        if (storeId) {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
        } else {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
        }
        const unsubscribe = onSnapshot(q, (snapshot) => {
            if (!snapshot.empty) {
                const config = snapshot.docs[0].data();
                setSettings(config.inventorySettings || {
                    preventDuplicateNames: false,
                    preventDuplicatePrices: false
                });
            }
        });
        if (window.firestoreListeners) window.firestoreListeners.add(unsubscribe);
        return () => {
            if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribe);
            unsubscribe();
        };
    }, [ownerId, storeId]);

    const saveSettings = async () => {
        setLoading(true);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                const configData = {
                    ownerId: ownerId,
                    inventorySettings: settings,
                    createdAt: serverTimestamp()
                };
                if (storeId) configData.storeId = storeId;
                await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), configData);
            } else {
                await updateDoc(snapshot.docs[0].ref, {
                    inventorySettings: settings
                });
            }
            alert('‚úÖ Pengaturan berhasil disimpan!');
            close();
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full">
                <div className="sticky top-0 bg-gradient-to-r from-slate-700 to-slate-600 p-6 text-white flex items-center justify-between rounded-t-2xl">
                    <h2 className="font-bold text-xl flex items-center gap-2"><Settings className="w-6 h-6"/> Pengaturan Stok</h2>
                    <button onClick={close} className="p-1 hover:bg-white/20 rounded-lg"><X className="w-6 h-6"/></button>
                </div>

                <div className="p-6 space-y-6">
                    <div className="space-y-4">
                        <label className="flex items-start gap-3 p-4 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                            <input 
                                type="checkbox"
                                checked={settings.preventDuplicateNames}
                                onChange={e => setSettings({...settings, preventDuplicateNames: e.target.checked})}
                                className="mt-1 w-5 h-5 text-blue-600 rounded"
                            />
                            <div className="flex-1">
                                <div className="font-bold text-slate-700 mb-1">Cegah Duplikasi Nama Produk</div>
                                <div className="text-sm text-slate-500">Sistem akan menolak jika Anda menambahkan produk dengan nama, kategori, dan brand yang sama</div>
                            </div>
                        </label>

                        <label className="flex items-start gap-3 p-4 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100 opacity-50">
                            <input 
                                type="checkbox"
                                checked={settings.preventDuplicatePrices}
                                onChange={e => setSettings({...settings, preventDuplicatePrices: e.target.checked})}
                                className="mt-1 w-5 h-5 text-blue-600 rounded"
                                disabled
                            />
                            <div className="flex-1">
                                <div className="font-bold text-slate-700 mb-1">Cegah Duplikasi Harga <span className="text-xs bg-slate-200 px-2 py-0.5 rounded">Coming Soon</span></div>
                                <div className="text-sm text-slate-500">Sistem akan memberi peringatan jika harga produk sama persis dengan produk lain</div>
                            </div>
                        </label>
                    </div>

                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <div className="flex gap-2 items-start">
                            <AlertTriangle className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
                            <div className="text-sm text-amber-700">
                                <strong>Info:</strong> Pengaturan ini hanya berlaku untuk penambahan produk baru. Produk yang sudah ada tidak akan terpengaruh.
                            </div>
                        </div>
                    </div>
                </div>

                <div className="bg-slate-100 p-4 flex gap-2 justify-end rounded-b-2xl">
                    <button onClick={close} className="px-6 py-2 bg-white border border-slate-300 rounded-lg font-bold hover:bg-slate-50">Batal</button>
                    <button 
                        onClick={saveSettings}
                        disabled={loading}
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
                    >
                        {loading && <Loader2 className="w-4 h-4 animate-spin" />}
                        Simpan Pengaturan
                    </button>
                </div>
            </div>
        </div>
    );
};

const QCFunctionalItemsModal = ({ close, ownerId }) => {
    const [items, setItems] = useState([]);
    const [newItem, setNewItem] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!ownerId) return;
        
        // üöÄ OPTIMIZED: Polling instead of real-time listener (QC items jarang berubah)
        const fetchQCItems = async () => {
            const q = query(
                collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), 
                where('ownerId', '==', ownerId)
            );
            const snap = await getDocs(q);
            return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        };

        const cleanup = polling(
            fetchQCItems,
            (data) => setItems(data),
            FIREBASE_OPTIMIZATION_CONFIG.POLLING_STATIC_DATA
        );

        return cleanup;
    }, [ownerId]);

    const addItem = async () => {
        if (!newItem.trim()) return;
        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), {
                name: newItem, ownerId, createdAt: serverTimestamp()
            });
            // üîß FIX: Langsung tambah ke state (optimistic update) agar list langsung refresh
            setItems(prev => [...prev, { id: 'temp_' + Date.now(), name: newItem, ownerId }]);
            setNewItem('');
        } catch (e) {
            alert('‚ùå Gagal menyimpan item: ' + e.message);
        } finally { setLoading(false); }
    };

    const deleteItem = async (id) => {
        try { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items', id)); } catch (e) { alert(e.message); }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 className="font-bold text-xl mb-4 text-slate-800">Kelola QC Cek Fungsional</h3>
                <div className="flex gap-2 mb-4">
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Nama item..." className="flex-1 border border-slate-300 p-2 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-blue-500 bg-white"/>
                    <button onClick={addItem} disabled={loading} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700"><Plus className="w-4 h-4"/></button>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                    {items.map(item => (
                        <div key={item.id} className="flex justify-between items-center p-3 bg-slate-100 rounded-lg">
                            <span className="font-medium text-slate-800">{item.name}</span>
                            <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700"><Trash2 className="w-4 h-4"/></button>
                        </div>
                    ))}
                </div>
                <div className="mt-6 flex gap-3">
                    <button onClick={close} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-800 hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const MasterKelengkapanModal = ({ close }) => {
    const [activeTab, setActiveTab] = useState('kelengkapan'); // 'kelengkapan' | 'qc'
    const [kelItems, setKelItems] = useState([]);
    const [qcItems, setQCItems] = useState([]);
    const [newItem, setNewItem] = useState('');
    const [loading, setLoading] = useState(false);

    // Load master kelengkapan items
    useEffect(() => {
        const unsub = onSnapshot(
            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items'), orderBy('createdAt', 'desc')),
            (snap) => setKelItems(snap.docs.map(d => ({ id: d.id, ...d.data() })))
        );
        if (window.firestoreListeners) window.firestoreListeners.add(unsub);
        return () => {
            if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
            unsub();
        };
    }, []);

    // Load master QC items
    useEffect(() => {
        const loadQC = async () => {
            try {
                const result = await pb.collection('master_qc_functional_items').getList(1, 500, {});
                setQCItems(result.items.map(r => ({ id: r.id, name: r.name, created: r.created })));
            } catch (e) {
                console.warn('‚ö†Ô∏è master_qc_functional_items not found, will auto-create on first add');
                setQCItems([]);
            }
        };
        loadQC();
    }, []);

    const currentItems = activeTab === 'kelengkapan' ? kelItems : qcItems;
    const collectionName = activeTab === 'kelengkapan' ? 'master_kelengkapan_items' : 'master_qc_functional_items';

    const addItem = async () => {
        if (!newItem.trim()) return;
        setLoading(true);
        try {
            if (activeTab === 'kelengkapan') {
                await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items'), {
                    name: newItem, createdAt: serverTimestamp()
                });
            } else {
                // For master QC, use PB SDK directly (collection might not exist in adapter)
                await pb.collection('master_qc_functional_items').create({
                    name: newItem, createdAt: new Date().toISOString()
                });
                // Optimistic update
                setQCItems(prev => [{ id: 'temp_' + Date.now(), name: newItem }, ...prev]);
            }
            setNewItem('');
        } catch (e) {
            alert('‚ùå Gagal menyimpan: ' + e.message);
        } finally { setLoading(false); }
    };

    const deleteItem = async (id) => {
        try {
            if (activeTab === 'kelengkapan') {
                await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items', id));
            } else {
                await pb.collection('master_qc_functional_items').delete(id);
                setQCItems(prev => prev.filter(i => i.id !== id));
            }
        } catch (e) { alert(e.message); }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 className="font-bold text-xl mb-2 text-slate-800">Master Data</h3>
                <p className="text-sm text-slate-600 mb-4">Kelola item QC & kelengkapan default untuk semua owner. Item ini akan otomatis muncul sebagai pilihan centang di form service.</p>
                
                {/* Tab Selector */}
                <div className="flex gap-2 mb-4 border-b border-slate-200 pb-3">
                    <button onClick={() => setActiveTab('kelengkapan')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${activeTab === 'kelengkapan' ? 'bg-teal-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>üìã Kelengkapan</button>
                    <button onClick={() => setActiveTab('qc')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${activeTab === 'qc' ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>‚úÖ QC Fungsional</button>
                </div>
                
                <div className="flex gap-2 mb-4">
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} onKeyDown={e => { if (e.key === 'Enter') addItem(); }} placeholder={activeTab === 'kelengkapan' ? 'Tambah item kelengkapan...' : 'Tambah item QC...'} className="flex-1 border border-slate-300 p-2 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-blue-500 bg-white"/>
                    <button onClick={addItem} disabled={loading} className={`text-white px-4 py-2 rounded-lg font-bold ${activeTab === 'kelengkapan' ? 'bg-teal-600 hover:bg-teal-700' : 'bg-amber-500 hover:bg-amber-600'}`}><Plus className="w-4 h-4"/></button>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                    {currentItems.length === 0 ? (
                        <p className="text-center text-slate-400 py-8">Belum ada item master {activeTab === 'kelengkapan' ? 'kelengkapan' : 'QC'}</p>
                    ) : (
                        currentItems.map(item => (
                            <div key={item.id} className={`flex justify-between items-center p-3 rounded-lg ${activeTab === 'kelengkapan' ? 'bg-teal-50 border border-teal-200' : 'bg-amber-50 border border-amber-200'}`}>
                                <span className="font-medium text-slate-800">{item.name}</span>
                                <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700"><Trash2 className="w-4 h-4"/></button>
                            </div>
                        ))
                    )}
                </div>
                <p className="text-[10px] text-slate-400 mt-3 text-center">üí° Item master akan muncul otomatis di form service sebagai pilihan centang untuk semua owner</p>
                <div className="mt-4 flex gap-3">
                    <button onClick={close} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-800 hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const KelengkapanItemsModal = ({ close, ownerId }) => {
    const [items, setItems] = useState([]);
    const [newItem, setNewItem] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!ownerId) return;
        
        // üöÄ OPTIMIZED: Polling instead of real-time listener (kelengkapan items jarang berubah)
        const fetchKelengkapanItems = async () => {
            const q = query(
                collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), 
                where('ownerId', '==', ownerId)
            );
            const snap = await getDocs(q);
            return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        };

        const cleanup = polling(
            fetchKelengkapanItems,
            (data) => setItems(data),
            FIREBASE_OPTIMIZATION_CONFIG.POLLING_STATIC_DATA
        );

        return cleanup;
    }, [ownerId]);

    const addItem = async () => {
        if (!newItem.trim()) return;
        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), {
                name: newItem, ownerId, createdAt: serverTimestamp()
            });
            // üîß FIX: Langsung tambah ke state (optimistic update) agar list langsung refresh
            setItems(prev => [...prev, { id: 'temp_' + Date.now(), name: newItem, ownerId }]);
            setNewItem('');
        } catch (e) {
            alert('‚ùå Gagal menyimpan item: ' + e.message);
        } finally { setLoading(false); }
    };

    const deleteItem = async (id) => {
        try { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items', id)); } catch (e) { alert(e.message); }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 className="font-bold text-xl mb-4 text-slate-800">Kelola Cek Kelengkapan</h3>
                <div className="flex gap-2 mb-4">
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Nama item..." className="flex-1 border border-slate-300 p-2 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-blue-500 bg-white"/>
                    <button onClick={addItem} disabled={loading} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700"><Plus className="w-4 h-4"/></button>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                    {items.map(item => (
                        <div key={item.id} className="flex justify-between items-center p-3 bg-slate-100 rounded-lg">
                            <span className="font-medium text-slate-800">{item.name}</span>
                            <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700"><Trash2 className="w-4 h-4"/></button>
                        </div>
                    ))}
                </div>
                <div className="mt-6 flex gap-3">
                    <button onClick={close} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-800 hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

// BackupModal untuk Developer (dengan pilihan owner)
const BackupModalDeveloper = ({ close }) => {
    const [selectedOwner, setSelectedOwner] = useState(null);
    const [selectedCollection, setSelectedCollection] = useState('inventory');
    const [loading, setLoading] = useState(false);
    const { data: owners } = useFirestoreCollection('owners');

    const collections = [
        { id: 'inventory', name: 'Stok Barang', icon: 'üì¶' },
        { id: 'customers', name: 'Pelanggan', icon: 'üë•' },
        { id: 'services', name: 'Riwayat Servis', icon: 'üì±' },
        { id: 'sales', name: 'Riwayat Penjualan', icon: 'üõí' },
        { id: 'suppliers', name: 'Supplier', icon: 'üöö' },
        { id: 'employees', name: 'Pegawai', icon: 'üëî' },
        { id: 'transactions', name: 'Transaksi Keuangan', icon: 'üí∞' },
    ];

    const handleBackup = async () => {
        if (!selectedOwner) {
            alert('‚ùå Pilih owner terlebih dahulu!');
            return;
        }

        setLoading(true);
        try {
            const collectionRef = collection(db, APP_COLLECTION_PREFIX, 'public', selectedCollection);
            const q = query(collectionRef, where('ownerId', '==', selectedOwner));
            const snapshot = await getDocs(q);
            
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Convert Firestore timestamps to strings for JSON
            const cleanData = JSON.parse(JSON.stringify(data, (key, value) => {
                if (value && typeof value === 'object' && value.seconds) {
                    return new Date(value.seconds * 1000).toISOString();
                }
                return value;
            }));
            
            // Download as JSON
            const blob = new Blob([JSON.stringify(cleanData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const ownerName = owners.find(o => o.id === selectedOwner)?.name || 'Unknown';
            const collectionName = collections.find(c => c.id === selectedCollection)?.name || selectedCollection;
            a.download = `backup_${selectedCollection}_${ownerName}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`‚úÖ Backup berhasil!\n\nüìã Data: ${data.length} item\nüì¶ Kategori: ${collectionName}\nüè¢ Owner: ${ownerName}\nüìÖ Tanggal: ${new Date().toLocaleDateString('id-ID')}`);
        } catch (error) {
            console.error('Backup error:', error);
            alert('‚ùå Gagal backup: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-slate-800 border border-slate-700 w-full max-w-2xl rounded-2xl p-6 shadow-2xl">
                <div className="flex justify-between items-center mb-6">
                    <h3 className="font-bold text-xl text-white flex items-center gap-2">
                        <Database className="w-5 h-5 text-blue-400"/> Backup Data per Item (Developer)
                    </h3>
                    <button onClick={close} className="text-slate-400 hover:text-white p-1">
                        <X className="w-5 h-5"/>
                    </button>
                </div>

                <div className="space-y-6">
                    {/* Select Owner */}
                    <div>
                        <label className="text-xs text-slate-400 font-bold uppercase mb-2 block">1Ô∏è‚É£ Pilih Owner/Tenant</label>
                        <select 
                            value={selectedOwner || ''} 
                            onChange={(e) => setSelectedOwner(e.target.value)}
                            className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-blue-500 outline-none"
                        >
                            <option value="">-- Pilih Owner --</option>
                            {owners?.map(owner => (
                                <option key={owner.id} value={owner.id}>{owner.name} ({owner.email})</option>
                            ))}
                        </select>
                    </div>

                    {/* Select Collection */}
                    <div>
                        <label className="text-xs text-slate-400 font-bold uppercase mb-2 block">2Ô∏è‚É£ Pilih Data yang akan di-Backup</label>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                            {collections.map(col => (
                                <button
                                    key={col.id}
                                    onClick={() => setSelectedCollection(col.id)}
                                    className={`p-4 rounded-lg border-2 transition-all text-left ${
                                        selectedCollection === col.id 
                                            ? 'bg-blue-600 border-blue-400 text-white shadow-lg shadow-blue-900/50' 
                                            : 'bg-slate-900 border-slate-700 text-slate-300 hover:border-slate-500'
                                    }`}
                                >
                                    <div className="text-2xl mb-2">{col.icon}</div>
                                    <div className="text-xs font-bold">{col.name}</div>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Info */}
                    <div className="bg-blue-900/30 border border-blue-500/30 p-4 rounded-lg">
                        <h4 className="text-blue-300 font-bold text-sm mb-2 flex items-center gap-2">
                            <Info className="w-4 h-4"/> Informasi Backup
                        </h4>
                        <ul className="text-sm text-blue-200 space-y-1">
                            <li>‚Ä¢ File akan diunduh dalam format JSON</li>
                            <li>‚Ä¢ Hanya data milik owner terpilih yang akan di-backup</li>
                            <li>‚Ä¢ Backup dapat digunakan untuk restore atau analisis data</li>
                            <li>‚Ä¢ File aman disimpan di komputer Anda</li>
                        </ul>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex gap-3">
                        <button 
                            onClick={close} 
                            className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700"
                        >
                            Batal
                        </button>
                        <button 
                            onClick={handleBackup}
                            disabled={loading || !selectedOwner}
                            className="flex-1 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-bold hover:from-blue-700 hover:to-purple-700 flex items-center justify-center gap-2 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {loading ? (
                                <><Loader2 className="w-5 h-5 animate-spin"/> Memproses...</>
                            ) : (
                                <><Download className="w-5 h-5"/> Backup & Download</>
                            )}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// BackupModal untuk Owner & Admin (dengan pilihan toko)
const BackupModal = ({ close }) => {
    const { activeOwner, activeStore, availableStores } = useContext(SessionContext);
    const [selectedStore, setSelectedStore] = useState(activeStore?.id || 'all');
    const [selectedCollection, setSelectedCollection] = useState('inventory');
    const [loading, setLoading] = useState(false);

    const collections = [
        { id: 'inventory', name: 'Stok Barang', icon: 'üì¶' },
        { id: 'customers', name: 'Pelanggan', icon: 'üë•' },
        { id: 'services', name: 'Riwayat Servis', icon: 'üì±' },
        { id: 'sales', name: 'Riwayat Penjualan', icon: 'üõí' },
        { id: 'suppliers', name: 'Supplier', icon: 'üöö' },
        { id: 'employees', name: 'Pegawai', icon: 'üëî' },
        { id: 'transactions', name: 'Transaksi Keuangan', icon: 'üí∞' },
    ];

    const handleBackup = async () => {
        if (!activeOwner?.id) {
            alert('‚ùå Data owner tidak ditemukan!');
            return;
        }

        setLoading(true);
        try {
            const collectionRef = collection(db, APP_COLLECTION_PREFIX, 'public', selectedCollection);
            
            // Query berdasarkan store yang dipilih
            let q;
            if (selectedStore === 'all') {
                q = query(collectionRef, where('ownerId', '==', activeOwner.id));
            } else {
                q = query(collectionRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', selectedStore));
            }
            
            const snapshot = await getDocs(q);
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Convert Firestore timestamps to strings for JSON
            const cleanData = JSON.parse(JSON.stringify(data, (key, value) => {
                if (value && typeof value === 'object' && value.seconds) {
                    return new Date(value.seconds * 1000).toISOString();
                }
                return value;
            }));
            
            // Download as JSON
            const blob = new Blob([JSON.stringify(cleanData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const ownerName = activeOwner.name || 'Unknown';
            const storeName = selectedStore === 'all' ? 'All_Stores' : (availableStores.find(s => s.id === selectedStore)?.name || 'Store');
            const collectionName = collections.find(c => c.id === selectedCollection)?.name || selectedCollection;
            a.download = `backup_${selectedCollection}_${storeName}_${ownerName}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`‚úÖ Backup berhasil!\n\nüìã Data: ${data.length} item\nüì¶ Kategori: ${collectionName}\nüè¢ Toko: ${storeName === 'All_Stores' ? 'Semua Toko' : storeName}\nüè¢ Owner: ${ownerName}\nüìÖ Tanggal: ${new Date().toLocaleDateString('id-ID')}`);
        } catch (error) {
            console.error('Backup error:', error);
            alert('‚ùå Gagal backup: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-slate-800 border border-slate-700 w-full max-w-xl rounded-xl p-4 shadow-2xl">
                <div className="flex justify-between items-center mb-4">
                    <div>
                        <h3 className="font-bold text-lg text-white flex items-center gap-2">
                            <Database className="w-4 h-4 text-purple-400"/> Backup Data per Item
                        </h3>
                        <p className="text-xs text-slate-400 mt-0.5">Owner: <span className="text-white font-bold">{activeOwner?.name}</span></p>
                    </div>
                    <button onClick={close} className="text-slate-400 hover:text-white p-1">
                        <X className="w-4 h-4"/>
                    </button>
                </div>

                <div className="space-y-4">
                    {/* Select Store */}
                    <div>
                        <label className="text-xs text-slate-400 font-bold uppercase mb-1.5 block">üè¢ Pilih Toko/Cabang</label>
                        <select 
                            value={selectedStore} 
                            onChange={(e) => setSelectedStore(e.target.value)}
                            className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm text-white placeholder-slate-500 focus:border-purple-500 outline-none"
                        >
                            <option value="all">üìä Semua Toko (All Stores)</option>
                            {availableStores?.map(store => (
                                <option key={store.id} value={store.id}>üè™ {store.name}</option>
                            ))}
                        </select>
                    </div>

                    {/* Select Collection */}
                    <div>
                        <label className="text-xs text-slate-400 font-bold uppercase mb-1.5 block">üìã Pilih Data yang akan di-Backup</label>
                        <div className="grid grid-cols-3 md:grid-cols-4 gap-2">
                            {collections.map(col => (
                                <button
                                    key={col.id}
                                    onClick={() => setSelectedCollection(col.id)}
                                    className={`p-2.5 rounded-lg border-2 transition-all text-center ${
                                        selectedCollection === col.id 
                                            ? 'bg-purple-600 border-purple-400 text-white shadow-lg shadow-purple-900/50' 
                                            : 'bg-slate-900 border-slate-700 text-slate-300 hover:border-slate-500'
                                    }`}
                                >
                                    <div className="text-xl mb-1">{col.icon}</div>
                                    <div className="text-[10px] font-bold leading-tight">{col.name}</div>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Info */}
                    <div className="bg-purple-900/30 border border-purple-500/30 p-3 rounded-lg">
                        <h4 className="text-purple-300 font-bold text-xs mb-1.5 flex items-center gap-1.5">
                            <Info className="w-3.5 h-3.5"/> Informasi Backup
                        </h4>
                        <ul className="text-xs text-purple-200 space-y-0.5">
                            <li>‚Ä¢ File format JSON</li>
                            <li>‚Ä¢ Pilih toko atau semua data</li>
                            <li>‚Ä¢ Aman disimpan di device Anda</li>
                        </ul>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex gap-2">
                        <button 
                            onClick={close} 
                            className="flex-1 py-2 border border-slate-600 rounded-lg font-bold text-sm text-slate-400 hover:bg-slate-700"
                        >
                            Batal
                        </button>
                        <button 
                            onClick={handleBackup}
                            disabled={loading}
                            className="flex-1 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-bold text-sm hover:from-purple-700 hover:to-blue-700 flex items-center justify-center gap-1.5 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {loading ? (
                                <><Loader2 className="w-4 h-4 animate-spin"/> Memproses...</>
                            ) : (
                                <><Download className="w-4 h-4"/> Backup</>
                            )}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// RestoreBackupModal - Modal untuk restore backup JSON (untuk Owner & Admin)
const RestoreBackupModal = ({ close }) => {
    const { activeOwner, activeStore, availableStores } = useContext(SessionContext);
    const [file, setFile] = useState(null);
    const [loading, setLoading] = useState(false);
    const [progress, setProgress] = useState({ current: 0, total: 0, collection: '' });
    const [result, setResult] = useState(null);
    const [restoreType, setRestoreType] = useState('data'); // 'data' or 'config'
    const [selectedStore, setSelectedStore] = useState('');
    const fileInputRef = useRef(null);

    // Convert Firebase timestamp to ISO string
    const convertFirebaseTimestamp = (ts) => {
        if (!ts) return new Date().toISOString();
        if (typeof ts === 'string') return ts;
        if (ts.seconds) {
            const date = new Date(ts.seconds * 1000 + (ts.nanoseconds || 0) / 1000000);
            return date.toISOString();
        }
        return new Date().toISOString();
    };

    // Generate 15-char ID for PocketBase
    const generatePBId = () => {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let id = '';
        for (let i = 0; i < 15; i++) {
            id += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return id;
    };

    const handleFileChange = (e) => {
        const selectedFile = e.target.files[0];
        if (selectedFile && selectedFile.type === 'application/json') {
            setFile(selectedFile);
            setResult(null);
        } else {
            alert('‚ùå Pilih file JSON yang valid!');
        }
    };

    // Handle Restore Store Configs
    const handleRestoreConfig = async () => {
        if (!file) {
            alert('‚ùå Pilih file backup store config terlebih dahulu!');
            return;
        }

        if (!activeOwner?.id) {
            alert('‚ùå Data owner tidak ditemukan!');
            return;
        }

        const targetStoreId = selectedStore || activeStore?.id;
        if (!targetStoreId) {
            alert('‚ùå Pilih target store untuk restore!');
            return;
        }

        const targetStore = availableStores.find(s => s.id === targetStoreId);
        if (!targetStore) {
            alert('‚ùå Target store tidak ditemukan!');
            return;
        }

        const confirmRestore = confirm(
            `‚ö†Ô∏è KONFIRMASI RESTORE STORE CONFIG\n\n` +
            `File: ${file.name}\n` +
            `Target Store: ${targetStore.name}\n` +
            `Owner: ${activeOwner.name}\n\n` +
            `Konfigurasi store akan ditimpa dengan data dari backup.\n\n` +
            `Lanjutkan restore?`
        );

        if (!confirmRestore) return;

        setLoading(true);
        setResult(null);

        try {
            // Read file
            const text = await file.text();
            let backup = JSON.parse(text);

            // Validate format - harus array dengan store config
            if (!Array.isArray(backup) || backup.length === 0) {
                alert('‚ùå Format backup store config tidak valid! File harus berisi array of config objects.');
                setLoading(false);
                return;
            }

            const config = backup[0]; // Ambil config pertama

            // Validate required fields
            if (!config.customCategories && !config.subCategories && config.menu_inventory === undefined) {
                alert('‚ùå File bukan backup store config yang valid!');
                setLoading(false);
                return;
            }

            // Prepare data for restore
            const restoreData = {
                storeId: targetStoreId,
                ownerId: activeOwner.id,
                feature_print: config.feature_print || false,
                feature_employee_edit: config.feature_employee_edit || false,
                menu_inventory: config.menu_inventory !== undefined ? config.menu_inventory : true,
                feature_sales_edit: config.feature_sales_edit !== undefined ? config.feature_sales_edit : true,
                feature_stock_add: config.feature_stock_add || false,
                feature_qc_checklist: config.feature_qc_checklist || false,
                feature_kelengkapan: config.feature_kelengkapan || false,
                inventorySettings: config.inventorySettings ? JSON.stringify(config.inventorySettings) : JSON.stringify({}),
                customCategories: config.customCategories ? JSON.stringify(config.customCategories) : JSON.stringify([]),
                menu_service: config.menu_service || false,
                feature_finance_edit: config.feature_finance_edit || false,
                feature_customer_edit: config.feature_customer_edit || false,
                menu_receivable: config.menu_receivable || false,
                menu_return_sales: config.menu_return_sales || false,
                feature_delete: config.feature_delete || false,
                menu_finance: config.menu_finance || false,
                subCategories: config.subCategories ? JSON.stringify(config.subCategories) : JSON.stringify({}),
                feature_share: config.feature_share || false,
                feature_accounting: config.feature_accounting || false,
                menu_cash: config.menu_cash || false,
                menu_report: config.menu_report || false,
                menu_hr: config.menu_hr || false,
                menu_payable: config.menu_payable || false,
                feature_import_export: config.feature_import_export || false,
                menu_purchase: config.menu_purchase || false,
                menu_supplier: config.menu_supplier || false,
                feature_inventory_edit: config.feature_inventory_edit || false,
                menu_sales: config.menu_sales !== undefined ? config.menu_sales : true,
                menu_return_purchase: config.menu_return_purchase || false,
                menu_customers: config.menu_customers || false,
                feature_service_edit: config.feature_service_edit || false,
                feature_backup: config.feature_backup || false,
                menu_dashboard: config.menu_dashboard !== undefined ? config.menu_dashboard : true,
                feature_multi_branch: config.feature_multi_branch || false
            };

            // Check if store_configs already exists for this store
            let existingConfigs = await pb.collection(getTenantCollection('store_configs', activeOwner.id)).getFullList({
                filter: `storeId = "${targetStoreId}"`
            });

            let resultMessage;
            if (existingConfigs.length > 0) {
                // Update existing config
                await pb.collection(getTenantCollection('store_configs', activeOwner.id)).update(existingConfigs[0].id, restoreData);
                resultMessage = `‚úÖ Konfigurasi berhasil diupdate untuk store: ${targetStore.name}`;
            } else {
                // Create new config
                await pb.collection(getTenantCollection('store_configs', activeOwner.id)).create(restoreData);
                resultMessage = `‚úÖ Konfigurasi berhasil dibuat untuk store: ${targetStore.name}`;
            }

            setResult({
                store_configs: { success: 1, failed: 0, skipped: 0, message: resultMessage }
            });

        } catch (error) {
            console.error('Restore config error:', error);
            alert('‚ùå Gagal restore store config:\n\n' + error.message);
            setResult({
                store_configs: { success: 0, failed: 1, skipped: 0, message: error.message }
            });
        } finally {
            setLoading(false);
        }
    };

    const handleRestore = async () => {
        if (!file) {
            alert('‚ùå Pilih file backup terlebih dahulu!');
            return;
        }

        if (!activeOwner?.id || !activeStore?.id) {
            alert('‚ùå Data owner/toko tidak ditemukan!');
            return;
        }

        const confirmRestore = confirm(
            `‚ö†Ô∏è KONFIRMASI RESTORE\n\n` +
            `File: ${file.name}\n` +
            `Owner: ${activeOwner.name}\n` +
            `Toko: ${activeStore.name}\n\n` +
            `Data dari backup akan ditambahkan ke database.\n` +
            `Data yang sudah ada TIDAK akan dihapus.\n\n` +
            `Lanjutkan restore?`
        );

        if (!confirmRestore) return;

        setLoading(true);
        setResult(null);
        const errors = [];
        
        try {
            // Read file
            const text = await file.text();
            let backup = JSON.parse(text);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // AUTO-DETECT BACKUP FORMAT
            // Support 2 formats:
            // 1. Firebase format: { customers: [...], inventory: [...], services: [...], ... }
            // 2. Per-item format: [...] ‚Äî array of records from single collection
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (Array.isArray(backup) && backup.length > 0) {
                // Per-item format: detect collection type from first item structure
                const sample = backup[0];
                let collectionType = null;

                // Detection logic based on unique field combinations
                if (sample.items && sample.total && sample.paymentMethod !== undefined) {
                    collectionType = 'sales';
                } else if (sample.stock !== undefined && sample.buyPrice !== undefined && sample.sellPrice !== undefined) {
                    collectionType = 'inventory';
                } else if ((sample.deviceModel || sample.unitType) && (sample.problem || sample.complaint) && sample.serviceFee !== undefined) {
                    collectionType = 'services';
                } else if (sample.type && sample.amount !== undefined && sample.category) {
                    collectionType = 'transactions';
                } else if (sample.name && sample.phone !== undefined && !sample.stock && !sample.items) {
                    collectionType = 'customers';
                }

                if (collectionType) {
                    // Normalize to Firebase format
                    backup = { [collectionType]: backup };
                    console.log(`üì¶ Detected per-item backup: ${collectionType} (${backup[collectionType].length} items)`);
                } else {
                    alert('‚ö†Ô∏è Format backup tidak dikenali. Pastikan file JSON valid.');
                    setLoading(false);
                    return;
                }
            } else if (typeof backup !== 'object' || backup === null) {
                alert('‚ö†Ô∏è Format backup tidak valid. File harus berisi object atau array.');
                setLoading(false);
                return;
            }

            const stats = {
                customers: { success: 0, failed: 0, skipped: 0 },
                inventory: { success: 0, failed: 0, skipped: 0 },
                services: { success: 0, failed: 0, skipped: 0 },
                transactions: { success: 0, failed: 0, skipped: 0 },
                sales: { success: 0, failed: 0, skipped: 0 }
            };

            // Helper: ensure JSON fields are stringified for PocketBase
            const jsonField = (val, fallback) => {
                if (val === undefined || val === null) return typeof fallback === 'string' ? fallback : JSON.stringify(fallback);
                if (typeof val === 'string') return val;
                return JSON.stringify(val);
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Import Customers (direct PocketBase API)
            // Schema: name, phone, address, customerType, ownerId, storeId, createdAt
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (backup.customers?.length > 0) {
                // Fetch existing customers to check duplicates
                const existingCustResp = await pb.collection(getTenantCollection('customers', activeOwner.id)).getList(1, 500, {
                    filter: `ownerId="${activeOwner.id}"`,
                    fields: 'name,phone'
                });
                const existingCustKeys = new Set(
                    existingCustResp.items.map(c => 
                        `${(c.name || '').toLowerCase()}_${(c.phone || '').replace(/\D/g, '')}`
                    )
                );

                setProgress({ current: 0, total: backup.customers.length, collection: 'Customers' });
                for (let i = 0; i < backup.customers.length; i++) {
                    const customer = backup.customers[i];
                    
                    // Skip deleted customers
                    if (customer.deleted) {
                        stats.customers.skipped++;
                        setProgress({ current: i + 1, total: backup.customers.length, collection: 'Customers' });
                        continue;
                    }

                    // Check duplicate
                    const customerPhone = customer.phone || customer.customerPhone || customer.phoneNumber || '';
                    const dupKey = `${(customer.name || '').toLowerCase()}_${customerPhone.replace(/\D/g, '')}`;
                    if (existingCustKeys.has(dupKey)) {
                        stats.customers.skipped++;
                        setProgress({ current: i + 1, total: backup.customers.length, collection: 'Customers' });
                        continue; // Skip duplicate
                    }

                    try {
                        const data = {
                            id: generatePBId(),
                            name: customer.name || '',
                            phone: customer.phone || customer.customerPhone || customer.phoneNumber || '',
                            address: customer.address || '',
                            customerType: customer.customerType || customer.phoneType || 'regular',
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            createdAt: convertFirebaseTimestamp(customer.createdAt)
                        };

                        await pb.collection(getTenantCollection('customers', activeOwner.id)).create(data);
                        stats.customers.success++;
                        existingCustKeys.add(dupKey); // Add to set
                    } catch (error) {
                        stats.customers.failed++;
                        errors.push(`Customer "${customer.name}": ${error.message}`);
                        console.error('Failed to import customer:', customer.name, error);
                    }

                    setProgress({ current: i + 1, total: backup.customers.length, collection: 'Customers' });
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Import Inventory (direct PocketBase API) 
            // Schema: name, category, subCategory, brand, supplier, stock, buyPrice, sellPrice, minStock, ownerId, storeId, createdAt
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (backup.inventory?.length > 0) {
                // üîπ Fetch existing inventory to prevent duplicates
                const existingInventory = await pb.collection(getTenantCollection('inventory', activeOwner.id)).getFullList({
                    filter: `ownerId="${activeOwner.id}" && storeId="${activeStore.id}"`
                });
                const inventoryKeys = new Set(
                    existingInventory.map(item => 
                        `${(item.name || '').toLowerCase()}_${(item.brand || '').toLowerCase()}_${item.category}`
                    )
                );

                setProgress({ current: 0, total: backup.inventory.length, collection: 'Inventory' });
                for (let i = 0; i < backup.inventory.length; i++) {
                    const item = backup.inventory[i];

                    // üîπ Check for duplicate
                    const itemKey = `${(item.name || '').toLowerCase()}_${(item.brand || '').toLowerCase()}_${item.category}`;
                    if (inventoryKeys.has(itemKey)) {
                        stats.inventory.failed++;
                        console.log(`‚ö†Ô∏è Skipping duplicate inventory: ${item.name} (${item.brand})`);
                        continue;
                    }

                    try {
                        const data = {
                            id: generatePBId(),
                            name: item.name || '',
                            category: item.category || '',
                            subCategory: item.subCategory || '',
                            brand: item.brand || '',
                            supplier: item.supplier || '',
                            stock: Number(item.stock) || 0,
                            buyPrice: Number(item.buyPrice) || 0,
                            sellPrice: Number(item.sellPrice) || 0,
                            minStock: Number(item.minStock) || 0,
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            createdAt: convertFirebaseTimestamp(item.createdAt)
                        };

                        await pb.collection(getTenantCollection('inventory', activeOwner.id)).create(data);
                        inventoryKeys.add(itemKey); // üîπ Add to prevent within-batch duplicates
                        stats.inventory.success++;
                    } catch (error) {
                        stats.inventory.failed++;
                        errors.push(`Inventory "${item.name}": ${error.message}`);
                        console.error('Failed to import inventory:', item.name, error);
                    }

                    if ((i + 1) % 10 === 0 || i === backup.inventory.length - 1) {
                        setProgress({ current: i + 1, total: backup.inventory.length, collection: 'Inventory' });
                    }
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Import Services (direct PocketBase API)
            // Schema: customerName, customerPhone, deviceBrand, deviceModel, deviceSN, problem, status,
            //   paymentStatus, costEstimate, serviceFee, dp, usedParts(json), notes, token, cashAccount,
            //   ownerId, storeId, createdAt, updatedAt, completedAt, kelengkapan(json), qcChecklist(json), warrantyDays
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (backup.services?.length > 0) {
                setProgress({ current: 0, total: backup.services.length, collection: 'Services' });
                for (let i = 0; i < backup.services.length; i++) {
                    const service = backup.services[i];

                    try {
                        const data = {
                            id: generatePBId(),
                            token: service.token || '',
                            customerName: service.customerName || '',
                            customerPhone: service.phone || service.customerPhone || '',
                            deviceBrand: service.deviceBrand || '',
                            deviceModel: service.unitType || service.deviceModel || '',
                            deviceSN: service.imei || service.deviceSN || '',
                            problem: service.complaint || service.problem || '',
                            status: service.status || 'Antri',
                            paymentStatus: service.paymentStatus || 'Belum Lunas',
                            costEstimate: Number(service.costEstimate) || 0,
                            serviceFee: Number(service.serviceFee) || 0,
                            dp: Number(service.dp) || 0,
                            warrantyDays: Number(service.warranty || service.warrantyDays) || 0,
                            cashAccount: service.cashAccount || 'Kas Tunai',
                            notes: service.notes || '',
                            kelengkapan: jsonField(service.kelengkapan, {}),
                            qcChecklist: jsonField(service.qcFunctional || service.qcChecklist, {}),
                            usedParts: jsonField(service.usedParts, []),
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            createdAt: convertFirebaseTimestamp(service.createdAt),
                            updatedAt: convertFirebaseTimestamp(service.updatedAt || service.createdAt),
                            completedAt: service.status === 'Selesai' ? convertFirebaseTimestamp(service.updatedAt || service.createdAt) : ''
                        };

                        await pb.collection(getTenantCollection('services', activeOwner.id)).create(data);
                        stats.services.success++;
                    } catch (error) {
                        stats.services.failed++;
                        errors.push(`Service "${service.customerName} - ${service.token}": ${error.message}`);
                        console.error('Failed to import service:', service.token, error);
                    }

                    setProgress({ current: i + 1, total: backup.services.length, collection: 'Services' });
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Import Sales (direct PocketBase API)
            // Schema: customerName, customerId, items(json), subtotal, discount, discountAmount, total,
            //   profit, modal, paymentMethod, type, cashAccount, ownerId, storeId, createdAt
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (backup.sales?.length > 0) {
                // Fetch existing sales to check duplicates
                const existingSalesResp = await pb.collection(getTenantCollection('sales', activeOwner.id)).getList(1, 500, {
                    filter: `ownerId="${activeOwner.id}"`,
                    fields: 'customerName,total,createdAt'
                });
                const existingSalesKeys = new Set(
                    existingSalesResp.items.map(s => 
                        `${s.customerName}_${s.total}_${s.createdAt.slice(0, 10)}`
                    )
                );

                setProgress({ current: 0, total: backup.sales.length, collection: 'Sales' });
                for (let i = 0; i < backup.sales.length; i++) {
                    const sale = backup.sales[i];
                    
                    // Check duplicate
                    const saleDate = convertFirebaseTimestamp(sale.createdAt || sale.date).slice(0, 10);
                    const dupKey = `${sale.customerName}_${sale.total}_${saleDate}`;
                    if (existingSalesKeys.has(dupKey)) {
                        stats.sales.skipped++;
                        setProgress({ current: i + 1, total: backup.sales.length, collection: 'Sales' });
                        continue; // Skip duplicate
                    }

                    try {
                        const data = {
                            id: generatePBId(),
                            customerName: sale.customerName || '',
                            customerId: sale.customerId || '',
                            items: jsonField(sale.items, []),
                            subtotal: Number(sale.subtotal) || 0,
                            discount: Number(sale.discount) || 0,
                            discountAmount: Number(sale.discountAmount) || 0,
                            total: Number(sale.total) || 0,
                            profit: Number(sale.profit) || 0,
                            modal: Number(sale.modal) || 0,
                            paymentMethod: sale.paymentMethod || 'Cash',
                            type: sale.type || 'sale',
                            cashAccount: sale.cashAccount || 'Kas Tunai',
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            createdAt: convertFirebaseTimestamp(sale.createdAt || sale.date)
                        };

                        await pb.collection(getTenantCollection('sales', activeOwner.id)).create(data);
                        stats.sales.success++;
                        existingSalesKeys.add(dupKey); // Add to set to prevent re-import in same batch
                    } catch (error) {
                        stats.sales.failed++;
                        errors.push(`Sale "${sale.customerName}": ${error.message}`);
                        console.error('Failed to import sale:', error);
                    }

                    setProgress({ current: i + 1, total: backup.sales.length, collection: 'Sales' });
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Import Transactions (direct PocketBase API)
            // Schema: type, category, description, amount, date, serviceId, originalSaleId, cashAccount,
            //   items(json), ownerId, storeId, createdAt
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (backup.transactions?.length > 0) {
                setProgress({ current: 0, total: backup.transactions.length, collection: 'Transactions' });
                for (let i = 0; i < backup.transactions.length; i++) {
                    const tx = backup.transactions[i];

                    try {
                        const data = {
                            id: generatePBId(),
                            type: tx.type || 'income',
                            category: tx.category || '',
                            description: tx.description || '',
                            amount: Number(tx.amount) || 0,
                            date: convertFirebaseTimestamp(tx.date),
                            serviceId: tx.serviceId || '',
                            originalSaleId: tx.originalSaleId || '',
                            cashAccount: tx.cashAccount || 'Kas Tunai',
                            items: jsonField(tx.items, []),
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            createdAt: convertFirebaseTimestamp(tx.createdAt || tx.date)
                        };

                        await pb.collection(getTenantCollection('transactions', activeOwner.id)).create(data);
                        stats.transactions.success++;
                    } catch (error) {
                        stats.transactions.failed++;
                        errors.push(`Transaction "${tx.description}": ${error.message}`);
                        console.error('Failed to import transaction:', tx.description, error);
                    }

                    if ((i + 1) % 5 === 0 || i === backup.transactions.length - 1) {
                        setProgress({ current: i + 1, total: backup.transactions.length, collection: 'Transactions' });
                    }
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Auto-generate Sales from "Penjualan Barang" transactions
            // (Firebase lama menyimpan penjualan di transactions, bukan di sales terpisah)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (backup.transactions?.length > 0 && (!backup.sales || backup.sales.length === 0)) {
                const salesFromTx = backup.transactions.filter(tx => tx.category === 'Penjualan Barang' && tx.type === 'income');
                if (salesFromTx.length > 0) {
                    stats.sales = stats.sales || { success: 0, failed: 0, skipped: 0 };
                    setProgress({ current: 0, total: salesFromTx.length, collection: 'Sales (auto)' });
                    for (let i = 0; i < salesFromTx.length; i++) {
                        const tx = salesFromTx[i];
                        try {
                            // Extract customer name from description "Penjualan X item ke NAMA"
                            const descMatch = (tx.description || '').match(/ke\s+(.+)$/i);
                            const customerName = descMatch ? descMatch[1].trim() : '';
                            const data = {
                                id: generatePBId(),
                                customerName: customerName,
                                customerId: '',
                                items: jsonField(tx.items, []),
                                subtotal: Number(tx.amount) || 0,
                                discount: 0,
                                discountAmount: 0,
                                total: Number(tx.amount) || 0,
                                profit: 0,
                                modal: 0,
                                paymentMethod: 'Cash',
                                type: 'sale',
                                cashAccount: tx.cashAccount || 'Kas Tunai',
                                ownerId: activeOwner.id,
                                storeId: activeStore.id,
                                createdAt: convertFirebaseTimestamp(tx.date || tx.createdAt)
                            };
                            await pb.collection(getTenantCollection('sales', activeOwner.id)).create(data);
                            stats.sales.success++;
                        } catch (error) {
                            stats.sales.failed++;
                            errors.push(`Sale (auto) "${tx.description}": ${error.message}`);
                        }
                        setProgress({ current: i + 1, total: salesFromTx.length, collection: 'Sales (auto)' });
                    }
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Auto-create missing customers from transactions & services
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            try {
                // Collect all customer names + phones from services
                const customerData = new Map(); // name -> {phone, source}
                
                if (backup.services) {
                    backup.services.forEach(s => {
                        if (s.customerName) {
                            const name = s.customerName.trim();
                            const phone = s.customerPhone || s.phone || '';
                            // Only add if we have phone number or if name not exists yet
                            if (!customerData.has(name) || phone) {
                                customerData.set(name, { phone, source: 'service' });
                            }
                        }
                    });
                }
                
                if (backup.transactions) {
                    backup.transactions.forEach(tx => {
                        const desc = tx.description || '';
                        const match = desc.match(/(?:ke|untuk|dari)\s+(.+)$/i);
                        if (match) {
                            const name = match[1].trim();
                            // Skip names that look like sentences
                            if (name.length < 40 && !name.includes(' - ') && !customerData.has(name)) {
                                customerData.set(name, { phone: '', source: 'transaction' });
                            }
                        }
                    });
                }

                // Get existing customer names
                const existingResp = await pb.collection(getTenantCollection('customers', activeOwner.id)).getList(1, 500, {
                    filter: `ownerId="${activeOwner.id}"`,
                    fields: 'name'
                });
                const existingNames = new Set(existingResp.items.map(c => c.name.toLowerCase()));

                // Create missing ones
                const missing = Array.from(customerData.entries())
                    .filter(([name, _]) => !existingNames.has(name.toLowerCase()));
                
                if (missing.length > 0) {
                    setProgress({ current: 0, total: missing.length, collection: 'Customers (auto)' });
                    for (let i = 0; i < missing.length; i++) {
                        const [name, data] = missing[i];
                        try {
                            await pb.collection(getTenantCollection('customers', activeOwner.id)).create({
                                id: generatePBId(),
                                name: name,
                                phone: data.phone,
                                address: '',
                                customerType: 'regular',
                                ownerId: activeOwner.id,
                                storeId: activeStore.id,
                                createdAt: new Date().toISOString()
                            });
                            stats.customers.success++;
                        } catch (e) {
                            stats.customers.failed++;
                        }
                        setProgress({ current: i + 1, total: missing.length, collection: 'Customers (auto)' });
                    }
                }
            } catch (e) {
                console.warn('Auto-customer creation error:', e);
            }

            setResult(stats);
            setProgress({ current: 0, total: 0, collection: '' });
            if (errors.length > 0) {
                console.warn('Restore errors:', errors);
            }
            
        } catch (error) {
            console.error('Restore error:', error);
            alert('‚ùå Gagal restore backup:\n\n' + error.message);
        } finally {
            setLoading(false);
        }
    };

    const totalSuccess = result ? Object.values(result).reduce((sum, stat) => sum + stat.success, 0) : 0;
    const totalFailed = result ? Object.values(result).reduce((sum, stat) => sum + stat.failed, 0) : 0;

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-slate-800 border border-slate-700 w-full max-w-xl rounded-xl p-4 shadow-2xl max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                    <div>
                        <h3 className="font-bold text-lg text-white flex items-center gap-2">
                            <Upload className="w-4 h-4 text-blue-400"/> Restore Backup
                        </h3>
                        <p className="text-xs text-slate-400 mt-0.5">
                            Import data dari backup JSON
                        </p>
                    </div>
                    <button onClick={close} disabled={loading} className="text-slate-400 hover:text-white p-1 disabled:opacity-50">
                        <X className="w-4 h-4"/>
                    </button>
                </div>

                {/* Tab Selector */}
                <div className="flex gap-2 mb-4">
                    <button
                        onClick={() => { setRestoreType('data'); setFile(null); setResult(null); }}
                        disabled={loading}
                        className={`flex-1 py-2 px-4 rounded-lg font-bold text-sm transition-all ${
                            restoreType === 'data'
                                ? 'bg-blue-600 text-white shadow-lg'
                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                        } disabled:opacity-50`}
                    >
                        üì¶ Data Backup
                    </button>
                    <button
                        onClick={() => { setRestoreType('config'); setFile(null); setResult(null); }}
                        disabled={loading}
                        className={`flex-1 py-2 px-4 rounded-lg font-bold text-sm transition-all ${
                            restoreType === 'config'
                                ? 'bg-purple-600 text-white shadow-lg'
                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                        } disabled:opacity-50`}
                    >
                        ‚öôÔ∏è Store Configs
                    </button>
                </div>

                <div className="space-y-4">
                    {/* Store Selector - hanya untuk config restore */}
                    {restoreType === 'config' && (
                        <div>
                            <label className="text-xs text-slate-400 font-bold uppercase mb-1.5 block">
                                üè™ Pilih Target Store
                            </label>
                            <select
                                value={selectedStore}
                                onChange={(e) => setSelectedStore(e.target.value)}
                                disabled={loading}
                                className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:border-blue-500 focus:outline-none disabled:opacity-50"
                            >
                                <option value="">-- Pilih Store --</option>
                                {availableStores?.map(store => (
                                    <option key={store.id} value={store.id}>
                                        {store.name} {store.id === activeStore?.id ? '(Aktif)' : ''}
                                    </option>
                                ))}
                            </select>
                        </div>
                    )}

                    {/* File Upload */}
                    <div>
                        <label className="text-xs text-slate-400 font-bold uppercase mb-1.5 block">
                            üìÅ Pilih File Backup (JSON)
                        </label>
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept="application/json,.json"
                            onChange={handleFileChange}
                            disabled={loading}
                            className="hidden"
                        />
                        <div
                            onClick={() => !loading && fileInputRef.current?.click()}
                            className={`border-2 border-dashed rounded-lg p-4 text-center cursor-pointer transition-all ${
                                file 
                                    ? 'border-blue-500 bg-blue-500/10' 
                                    : 'border-slate-600 bg-slate-900 hover:border-slate-500'
                            } ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                        >
                            {file ? (
                                <div className="text-blue-300">
                                    <File className="w-8 h-8 mx-auto mb-2"/>
                                    <p className="font-bold">{file.name}</p>
                                    <p className="text-xs text-slate-400 mt-1">
                                        {(file.size / 1024).toFixed(2)} KB
                                    </p>
                                </div>
                            ) : (
                                <div className="text-slate-400">
                                    <Upload className="w-8 h-8 mx-auto mb-2"/>
                                    <p className="font-bold">Klik untuk pilih file</p>
                                    <p className="text-xs mt-1">Format: JSON</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Progress Bar */}
                    {loading && progress.total > 0 && (
                        <div className="bg-slate-900 border border-slate-700 p-3 rounded-lg">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs text-slate-300 font-bold">
                                    Importing {progress.collection}...
                                </span>
                                <span className="text-xs text-slate-400">
                                    {progress.current} / {progress.total}
                                </span>
                            </div>
                            <div className="w-full bg-slate-700 rounded-full h-2">
                                <div 
                                    className="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${(progress.current / progress.total) * 100}%` }}
                                />
                            </div>
                        </div>
                    )}

                    {/* Result Summary */}
                    {result && (
                        <div className="bg-slate-900 border border-slate-700 p-3 rounded-lg space-y-2">
                            <h4 className="text-white font-bold flex items-center gap-2">
                                <CheckCircle2 className="w-4 h-4 text-green-400"/> Hasil Restore
                            </h4>
                            <div className="space-y-1 text-xs">
                                {Object.entries(result).map(([key, stat]) => {
                                    if (stat.success === 0 && stat.failed === 0) return null;
                                    return (
                                        <div key={key} className="flex flex-col gap-1">
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-300 capitalize">{key.replace('_', ' ')}:</span>
                                                <span className="text-white font-bold">
                                                    <span className="text-green-400">{stat.success} ‚úì</span>
                                                    {stat.failed > 0 && <span className="text-red-400 ml-2">{stat.failed} ‚úó</span>}
                                                    {stat.skipped > 0 && <span className="text-yellow-400 ml-2">{stat.skipped} skip</span>}
                                                </span>
                                            </div>
                                            {stat.message && (
                                                <div className="text-blue-300 text-xs pl-2 border-l-2 border-blue-500">
                                                    {stat.message}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                {restoreType === 'data' && (
                                    <div className="border-t border-slate-700 pt-2 mt-2">
                                        <div className="flex justify-between items-center font-bold">
                                            <span className="text-slate-200">Total Imported:</span>
                                            <span className="text-green-400">{totalSuccess}</span>
                                        </div>
                                        {totalFailed > 0 && (
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-200">Total Failed:</span>
                                                <span className="text-red-400">{totalFailed}</span>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Info */}
                    <div className={`p-3 rounded-lg ${
                        restoreType === 'config' 
                            ? 'bg-purple-900/30 border border-purple-500/30' 
                            : 'bg-blue-900/30 border border-blue-500/30'
                    }`}>
                        <h4 className={`font-bold text-xs mb-1.5 flex items-center gap-1.5 ${
                            restoreType === 'config' ? 'text-purple-300' : 'text-blue-300'
                        }`}>
                            <Info className="w-3.5 h-3.5"/> Informasi Restore
                        </h4>
                        {restoreType === 'data' ? (
                            <ul className="text-xs text-blue-200 space-y-0.5">
                                <li>‚Ä¢ Support backup format Firebase JSON</li>
                                <li>‚Ä¢ Data akan ditambahkan ke toko aktif</li>
                                <li>‚Ä¢ Data lama tidak akan dihapus</li>
                                <li>‚Ä¢ Record yang sudah ada akan diskip</li>
                            </ul>
                        ) : (
                            <ul className="text-xs text-purple-200 space-y-0.5">
                                <li>‚Ä¢ File backup store configs dari backup collection</li>
                                <li>‚Ä¢ Pilih target store yang akan di-restore</li>
                                <li>‚Ä¢ Konfigurasi lama akan ditimpa (update)</li>
                                <li>‚Ä¢ Termasuk: features, menus, categories, subcategories</li>
                            </ul>
                        )}
                    </div>

                    {/* Action Buttons */}
                    <div className="flex gap-2">
                        <button 
                            onClick={close} 
                            disabled={loading}
                            className="flex-1 py-2 border border-slate-600 rounded-lg font-bold text-sm text-slate-400 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {result ? 'Tutup' : 'Batal'}
                        </button>
                        {!result && (
                            <button 
                                onClick={restoreType === 'config' ? handleRestoreConfig : handleRestore}
                                disabled={loading || !file || (restoreType === 'config' && !selectedStore)}
                                className={`flex-1 py-2 bg-gradient-to-r text-white rounded-lg font-bold text-sm hover:shadow-xl flex items-center justify-center gap-1.5 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all ${
                                    restoreType === 'config'
                                        ? 'from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700'
                                        : 'from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700'
                                }`}
                            >
                                {loading ? (
                                    <><Loader2 className="w-4 h-4 animate-spin"/> Memproses...</>
                                ) : (
                                    <><Upload className="w-4 h-4"/> {restoreType === 'config' ? 'Restore Config' : 'Restore Data'}</>
                                )}
                            </button>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

// BackupPage - Halaman khusus untuk Backup (untuk Admin & Owner)
const BackupPage = () => {
    const { user, activeOwner, activeStore, availableStores, checkPermission } = useContext(SessionContext);
    const [modal, setModal] = useState(null);
    const effectiveRole = user.role === 'developer' ? 'owner' : user.role;
    
    // Check permission untuk backup
    if (!checkPermission('feature_backup')) {
        return (
            <div className="p-10 text-center text-red-500">
                <Lock className="w-16 h-16 mx-auto mb-4"/>
                <h3 className="font-bold text-xl mb-2">Akses Ditolak</h3>
                <p className="text-slate-400">Fitur Backup dikunci oleh Owner/Developer</p>
            </div>
        );
    }

    return (
        <div className="space-y-8 max-w-4xl">
            {/* Header */}
            <div className="bg-gradient-to-r from-purple-600 to-blue-600 p-8 rounded-2xl text-white shadow-xl">
                <div className="flex items-center gap-4 mb-4">
                    <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                        <Database className="w-8 h-8"/>
                    </div>
                    <div>
                        <h2 className="text-3xl font-bold">Backup & Restore Data</h2>
                        <p className="text-purple-100">Kelola backup data toko Anda dengan mudah</p>
                    </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                        <div className="text-2xl font-bold">{availableStores?.length || 0}</div>
                        <div className="text-sm text-purple-100">Toko/Cabang</div>
                    </div>
                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                        <div className="text-2xl font-bold">{activeOwner?.plan?.toUpperCase() || 'BASIC'}</div>
                        <div className="text-sm text-purple-100">Plan Aktif</div>
                    </div>
                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                        <div className="text-2xl font-bold">{effectiveRole === 'owner' ? 'OWNER' : 'ADMIN'}</div>
                        <div className="text-sm text-purple-100">Role Anda</div>
                    </div>
                </div>
            </div>

            {/* Quick Actions */}
            <div className="bg-white border border-slate-200 rounded-2xl p-8 shadow-sm">
                <h3 className="font-bold text-xl mb-6 flex items-center gap-2 text-slate-800">
                    <Zap className="w-6 h-6 text-yellow-500"/> Quick Actions
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {checkPermission('feature_backup_per_item') ? (
                        <button
                            onClick={() => setModal('backup')}
                            className="bg-gradient-to-br from-purple-50 to-blue-50 border-2 border-purple-200 p-6 rounded-xl hover:shadow-lg transition-all group text-left"
                        >
                            <div className="flex items-start justify-between mb-3">
                                <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                                    <Download className="w-6 h-6"/>
                                </div>
                                <span className="text-xs font-bold text-purple-600 bg-purple-100 px-3 py-1 rounded-full">POPULAR</span>
                            </div>
                            <h4 className="font-bold text-lg mb-2 text-slate-800">Backup Per Item</h4>
                            <p className="text-sm text-slate-600">Backup data per kategori (stok, pelanggan, servis, dll)</p>
                        </button>
                    ) : (
                        <div className="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200 p-6 rounded-xl text-left opacity-80">
                            <div className="flex items-start justify-between mb-3">
                                <div className="w-12 h-12 bg-red-400 rounded-xl flex items-center justify-center text-white">
                                    <Lock className="w-6 h-6"/>
                                </div>
                                <span className="text-xs font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full">LOCKED</span>
                            </div>
                            <h4 className="font-bold text-lg mb-2 text-slate-600">Backup Per Item</h4>
                            <p className="text-sm text-slate-500">Fitur dikunci oleh Developer</p>
                        </div>
                    )}
                    
                    <button
                        onClick={() => setModal('restore')}
                        className="bg-gradient-to-br from-blue-50 to-green-50 border-2 border-blue-200 p-6 rounded-xl hover:shadow-lg transition-all group text-left"
                    >
                        <div className="flex items-start justify-between mb-3">
                            <div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                                <Upload className="w-6 h-6"/>
                            </div>
                            <span className="text-xs font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">NEW</span>
                        </div>
                        <h4 className="font-bold text-lg mb-2 text-slate-800">Restore Backup</h4>
                        <p className="text-sm text-slate-600">Upload file backup JSON untuk restore data ke aplikasi</p>
                    </button>
                </div>
            </div>

            {/* Info & Tips */}
            <div className="bg-blue-50 border border-blue-200 rounded-2xl p-6">
                <div className="flex items-start gap-3">
                    <Info className="w-6 h-6 text-blue-600 mt-1 flex-shrink-0"/>
                    <div>
                        <h4 className="font-bold text-blue-900 mb-2">Tips Backup Data</h4>
                        <ul className="text-sm text-blue-800 space-y-2">
                            <li>‚Ä¢ Lakukan backup data secara berkala (minimal 1x seminggu)</li>
                            <li>‚Ä¢ Simpan file backup di tempat aman (cloud storage, external hard disk)</li>
                            <li>‚Ä¢ Pastikan pilih toko yang benar sebelum backup</li>
                            <li>‚Ä¢ File backup dalam format JSON dapat dibuka dengan text editor</li>
                            <li>‚Ä¢ Nama file otomatis: backup_[kategori]_[toko]_[owner]_[tanggal].json</li>
                        </ul>
                    </div>
                </div>
            </div>

            {/* Plan Information */}
            {activeOwner?.plan === 'basic' && (
                <div className="bg-yellow-50 border-2 border-yellow-300 rounded-2xl p-6">
                    <div className="flex items-start gap-3">
                        <AlertTriangle className="w-6 h-6 text-yellow-600 mt-1"/>
                        <div>
                            <h4 className="font-bold text-yellow-900 mb-2">‚ö†Ô∏è Basic Plan - Fitur Terbatas</h4>
                            <p className="text-sm text-yellow-800 mb-3">
                                Anda menggunakan Basic Plan. Fitur backup mungkin dibatasi. Upgrade ke Pro Plan untuk akses penuh.
                            </p>
                            <button className="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                Upgrade ke Pro
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Modal */}
            {modal === 'backup' && <BackupModal close={() => setModal(null)} />}
            {modal === 'restore' && <RestoreBackupModal close={() => setModal(null)} />}
        </div>
    );
};

const DeveloperDashboard = () => {
             const { logout, enterTenantContext } = useContext(SessionContext);
             
             // ‚úÖ REALTIME: Direct PocketBase subscription untuk daftar tenant
             const [owners, setOwners] = useState([]);
             const [isOwnersLoading, setIsOwnersLoading] = useState(true);
             const [ownersError, setOwnersError] = useState('');
             
             useEffect(() => {
                 let cancelled = false;
                 
                 const fetchOwners = async () => {
                     try {
                         const result = await pb.collection('owners').getList(1, 500, { sort: '-created' });
                         if (cancelled) return;
                         const mapped = result.items.map(r => {
                             const obj = { ...r };
                             delete obj.collectionId;
                             delete obj.collectionName;
                             delete obj.expand;
                             return obj;
                         });
                         setOwners(mapped);
                         setOwnersError('');
                         setIsOwnersLoading(false);
                         console.log('‚úÖ Owners loaded:', mapped.length, 'tenants');
                     } catch (err) {
                         console.error('‚ùå Owners fetch failed:', err);
                         if (!cancelled) {
                             setOwnersError('Gagal memuat data tenant: ' + err.message);
                             setIsOwnersLoading(false);
                         }
                     }
                 };

                 // Fetch awal
                 fetchOwners();

                 // Subscribe realtime via adapter (deduplicated SSE) - trigger re-fetch saat ada perubahan
                 const unsubOwners = _subscribeCollection('owners', (e) => {
                     if (cancelled) return;
                     console.log('üîî Owners realtime event:', e.action, e.record?.id);
                     fetchOwners();
                 });

                 return () => {
                     cancelled = true;
                     unsubOwners();
                 };
             }, []);
             
             const quotaTracking = useQuotaTracking(); // kept for internal metrics
             const [subConfig, setSubConfig] = useState({ 
                 whatsapp: '', 
                 basicFirstYear: 1200000, 
                 basicRenewal: 960000, 
                 proFirstYear: 2400000, 
                 proRenewal: 1920000, 
                 duration: 365 
             });
             const [featureLists, setFeatureLists] = useState({
                 basic: ['Maksimal **1 Cabang**', 'Semua fitur dasar POS', '~Backup otomatis', '~Support prioritas'],
                 pro: ['Maksimal **5 Cabang**', 'Semua fitur lengkap', 'Backup & Restore data', 'Support prioritas 24/7', 'Custom request fitur']
             });
             const [subModal, setSubModal] = useState(null); // null | 'settings' | {type: 'activate', owner}
             const [vpsStatus, setVpsStatus] = useState({ pbHealth: null, pbCollections: [], pbStats: {}, loading: true, lastCheck: null });
             const [modal, setModal] = useState(null); 
             const [selectedOwner, setSelectedOwner] = useState(null);
             const [selectedOwnerUser, setSelectedOwnerUser] = useState(null);
             const [selectedRole, setSelectedRole] = useState('owner'); // NEW: Role selector for access rights
             const [loading, setLoading] = useState(false);
             
             // Load subscription config - Direct PocketBase
             useEffect(() => {
                 let cancelled = false;
                 const loadConfig = async () => {
                     try {
                         const result = await pb.collection('subscription_config').getList(1, 1);
                         if (!cancelled && result.items.length > 0) {
                             const data = result.items[0];
                             console.log('‚úÖ Dev: subscription_config loaded from PocketBase:', data);
                             setSubConfig(prev => ({...prev, ...data, _configId: data.id}));
                         }
                         // Load feature lists from plan_configs
                         try {
                             const basicRec = await pb.collection('plan_configs').getOne(_planDocId('basic'));
                             if (!cancelled && basicRec.featuresList && basicRec.featuresList.length > 0)
                                 setFeatureLists(prev => ({ ...prev, basic: basicRec.featuresList }));
                         } catch(_) {}
                         try {
                             const proRec = await pb.collection('plan_configs').getOne(_planDocId('pro'));
                             if (!cancelled && proRec.featuresList && proRec.featuresList.length > 0)
                                 setFeatureLists(prev => ({ ...prev, pro: proRec.featuresList }));
                         } catch(_) {}
                     } catch (err) {
                         console.warn('‚ö†Ô∏è Dev: PocketBase subscription_config load failed, trying adapter...', err.message);
                         // Fallback to adapter
                         const configRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'subscription_config');
                         const snapshot = await getDocs(query(configRef, limit(1)));
                         if (!cancelled && !snapshot.empty) {
                             setSubConfig(prev => ({...prev, ...snapshot.docs[0].data(), _configId: snapshot.docs[0].id}));
                         }
                     }
                 };
                 loadConfig();
                 // Also listen for real-time changes
                 const configRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'subscription_config');
                 const unsub = onSnapshot(
                     query(configRef, limit(1)),
                     (snapshot) => {
                         if (!cancelled && !snapshot.empty) setSubConfig(prev => ({...prev, ...snapshot.docs[0].data(), _configId: snapshot.docs[0].id}));
                     }
                 );
                 if (window.firestoreListeners) window.firestoreListeners.add(unsub);
                 return () => { cancelled = true; if (window.firestoreListeners) window.firestoreListeners.delete(unsub); unsub(); };
             }, []);
             
             // VPS & PocketBase Health Monitor
             const checkVpsHealth = async () => {
                 setVpsStatus(prev => ({...prev, loading: true}));
                 const status = { pbHealth: null, pbCollections: [], pbStats: {}, loading: false, lastCheck: new Date() };
                 
                 // Check PocketBase health
                 try {
                     const startTime = performance.now();
                     const healthResp = await fetch(`${POCKETBASE_URL}/api/health`, { signal: AbortSignal.timeout(10000) });
                     const latency = Math.round(performance.now() - startTime);
                     if (healthResp.ok) {
                         const healthData = await healthResp.json();
                         status.pbHealth = { ok: true, latency, code: healthData.code || 200, message: healthData.message || 'OK' };
                     } else {
                         status.pbHealth = { ok: false, latency, code: healthResp.status, message: 'Server Error' };
                     }
                 } catch (err) {
                     status.pbHealth = { ok: false, latency: -1, code: 0, message: err.message || 'Unreachable' };
                 }
                 
                 // Get PocketBase collections stats
                 try {
                     const collections = ['users', 'owners', 'stores', 'services', 'inventory', 'transactions', 
                                          'customers', 'suppliers', 'store_configs', 'plan_configs', 'subscription_config',
                                          'cash_accounts', 'return_sales', 'return_purchases'];
                     const colStats = [];
                     let totalRecords = 0;
                     for (const col of collections) {
                         try {
                             const result = await pb.collection(col).getList(1, 1);
                             colStats.push({ name: col, count: result.totalItems, ok: true });
                             totalRecords += result.totalItems;
                         } catch (e) {
                             colStats.push({ name: col, count: 0, ok: false, error: e.message });
                         }
                     }
                     status.pbCollections = colStats;
                     status.pbStats = { totalCollections: colStats.filter(c => c.ok).length, totalRecords, errorCollections: colStats.filter(c => !c.ok).length };
                 } catch (err) {
                     console.warn('‚ö†Ô∏è Collection stats failed:', err.message);
                 }
                 
                 setVpsStatus(status);
             };
             
             useEffect(() => {
                 checkVpsHealth();
                 const interval = setInterval(checkVpsHealth, 60000); // Auto-refresh setiap 60 detik
                 return () => clearInterval(interval);
             }, []);

             // Subscription helper functions
             const getOwnerSubStatus = (owner) => {
                 const sub = owner.subscription;
                 if (!sub || !sub.expiresAt) return { status: 'none', remainingDays: 0, expired: true, label: 'Belum Aktif' };
                 const now = new Date();
                 const expiresAt = sub.expiresAt?.toDate ? sub.expiresAt.toDate() : new Date(sub.expiresAt);
                 const diffMs = expiresAt.getTime() - now.getTime();
                 const remainingDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                 if (remainingDays <= 0) return { status: 'expired', remainingDays: 0, expired: true, label: 'Kedaluwarsa', expiresAt };
                 return { status: 'active', remainingDays, expired: false, label: `${remainingDays} hari lagi`, expiresAt };
             };

             const activateSubscription = async (owner, customPrice, customDuration, adminMessage) => {
                 setLoading(true);
                 try {
                     const plan = owner?.plan || 'basic';
                     const defaultPrice = plan === 'pro' ? (subConfig.proFirstYear || 2400000) : (subConfig.basicFirstYear || 1200000);
                     const price = customPrice || defaultPrice;
                     const duration = customDuration || subConfig.duration || 365;
                     const now = new Date();
                     const expiresAt = new Date(now.getTime() + duration * 24 * 60 * 60 * 1000);
                     
                     const historyEntry = {
                         activatedAt: now.toISOString(),
                         expiresAt: expiresAt.toISOString(),
                         amount: price,
                         duration: duration,
                         activatedBy: 'developer'
                     };

                     const ownerRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', owner.id);
                     const ownerSnap = await getDoc(ownerRef);
                     const existingHistory = ownerSnap.data()?.subscription?.history || [];

                     const updateData = {
                         'subscription.status': 'active',
                         'subscription.activatedAt': serverTimestamp(),
                         'subscription.expiresAt': expiresAt,
                         'subscription.amount': price,
                         'subscription.duration': duration,
                         'subscription.history': [...existingHistory, historyEntry]
                     };
                     
                     // Add admin message if provided
                     if (adminMessage && adminMessage.trim()) {
                         updateData['adminMessage'] = adminMessage.trim();
                         updateData['adminMessageAt'] = serverTimestamp();
                     }

                     await updateDoc(ownerRef, updateData);
                     alert(`‚úÖ Langganan ${owner.name} berhasil diaktifkan!\nBerlaku hingga: ${expiresAt.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}\nDurasi: ${duration} hari`);
                     setSubModal(null);
                 } catch (err) {
                     alert('Gagal mengaktifkan langganan: ' + err.message);
                 } finally {
                     setLoading(false);
                 }
             };

             const revokeSubscription = async (owner, adminMessage) => {
                 if (!confirm(`‚ö†Ô∏è Anda yakin ingin menonaktifkan langganan ${owner.name}?\n\nAplikasi akan terkunci untuk owner ini.`)) return;
                 setLoading(true);
                 try {
                     const updateData = {
                         'subscription.status': 'expired',
                         'subscription.expiresAt': new Date(2000, 0, 1) // Force expired
                     };
                     
                     // Add admin message if provided
                     if (adminMessage && adminMessage.trim()) {
                         updateData['adminMessage'] = adminMessage.trim();
                         updateData['adminMessageAt'] = serverTimestamp();
                     }
                     
                     await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', owner.id), updateData);
                     alert(`Langganan ${owner.name} dinonaktifkan.`);
                 } catch (err) {
                     alert('Gagal: ' + err.message);
                 } finally {
                     setLoading(false);
                 }
             };

             const saveSubConfig = async (newConfig, newFeatureLists) => {
                 setLoading(true);
                 try {
                     console.log('üíæ Saving subscription config:', newConfig);
                     // Direct PocketBase save for reliability
                     try {
                         const existing = await pb.collection('subscription_config').getList(1, 1);
                         if (existing.items.length > 0) {
                             await pb.collection('subscription_config').update(existing.items[0].id, newConfig);
                             console.log('‚úÖ PocketBase subscription_config updated:', existing.items[0].id);
                         } else {
                             await pb.collection('subscription_config').create(newConfig);
                             console.log('‚úÖ PocketBase subscription_config created');
                         }
                     } catch (pbErr) {
                         console.warn('‚ö†Ô∏è Direct PocketBase save failed, trying adapter...', pbErr.message);
                         const configRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'subscription_config');
                         const snapshot = await getDocs(query(configRef, limit(1)));
                         if (!snapshot.empty) {
                             await updateDoc(snapshot.docs[0].ref, newConfig);
                         } else {
                             await addDoc(configRef, newConfig);
                         }
                     }
                     // Immediately sync local state so UI updates instantly
                     setSubConfig(prev => ({ ...prev, ...newConfig }));
                     // Save feature lists to plan_configs if provided
                     if (newFeatureLists) {
                         setFeatureLists(newFeatureLists);
                         for (const plan of ['basic', 'pro']) {
                             try {
                                 const planId = _planDocId(plan);
                                 try {
                                     await pb.collection('plan_configs').update(planId, { featuresList: newFeatureLists[plan] });
                                 } catch(e) {
                                     if (e.status === 404) await pb.collection('plan_configs').create({ id: planId, plan, featuresList: newFeatureLists[plan] });
                                     else throw e;
                                 }
                             } catch(e) { console.warn('featuresList save failed for', plan, e.message); }
                         }
                     }
                     console.log('‚úÖ Subscription config saved & synced successfully');
                     alert('‚úÖ Pengaturan langganan disimpan & disinkronkan ke semua halaman!');
                     setSubModal(null);
                 } catch (err) {
                     alert('Gagal: ' + err.message);
                 } finally {
                     setLoading(false);
                 }
             };

             const createOwner = async (e) => { 
                 e.preventDefault(); 
                 setLoading(true); 
                 const formData = new FormData(e.target); 
                 const ownerName = formData.get('name'); 
                 const ownerEmail = formData.get('email'); 
                 const password = formData.get('password'); 
                 const personalName = formData.get('ownerName'); 
                 const plan = formData.get('plan'); 
                 
                 // üî• DEFINISI HAK AKSES DARI PLAN_CONFIGS (DINAMIS) + AUTO-CREATE FALLBACK
                 const defaultPlans = {
                     basic: {
                         feature_delete: true, feature_print: true, feature_share: true, feature_stock_add: true,
                         menu_finance: false, feature_backup: false, feature_finance_edit: false, feature_employee_edit: false
                     },
                     pro: {
                         feature_delete: true, feature_print: true, feature_share: true, feature_stock_add: true,
                         menu_finance: true, feature_backup: true, feature_finance_edit: true, feature_employee_edit: true
                     }
                 };
                 
                 let defaultAccessRights;
                 try {
                     const planSnap = await getDoc(
                         doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', _planDocId(plan))
                     );
                     if (planSnap.exists()) {
                         defaultAccessRights = planSnap.data();
                         console.log(`‚úÖ Plan "${plan}" loaded from plan_configs`);
                     } else {
                         console.log(`‚ö†Ô∏è Plan "${plan}" not found, using & auto-creating defaults...`);
                         defaultAccessRights = defaultPlans[plan] || defaultPlans.basic;
                         try {
                             await setDoc(
                                 doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', _planDocId(plan)),
                                 { ...defaultAccessRights, plan: plan }
                             );
                             console.log(`‚úÖ Plan "${plan}" auto-created in plan_configs`);
                         } catch (autoErr) {
                             console.warn('Could not auto-create plan_configs:', autoErr.message);
                         }
                     }
                 } catch (configErr) {
                     console.warn('Error reading plan_configs, using defaults:', configErr.message);
                     defaultAccessRights = defaultPlans[plan] || defaultPlans.basic;
                 }

                 try { 
                     // Create atau gunakan user yang sudah ada di PocketBase
                     let newUid = null; 
                     let userCreated = false; // Track if we created a new user
                     
                     try { 
                         const userCred = await createUserWithEmailAndPassword(auth, ownerEmail, password); 
                         newUid = userCred.user.uid; 
                         userCreated = true;
                         console.log('‚úÖ New user created:', newUid);
                     } catch(authErr) { 
                         if(authErr.code === 'auth/email-already-in-use') {
                             // Email sudah ada - cek apakah sudah jadi owner
                             console.log('‚ö†Ô∏è Email exists, checking if already an owner...');
                             const existingUser = await findUserByEmail(ownerEmail);
                             if (!existingUser) {
                                 throw new Error('Email terdaftar tapi tidak dapat ditemukan. Hubungi admin.');
                             }
                             if (existingUser.role === 'owner') {
                                 throw new Error('Email ini sudah terdaftar sebagai Owner.');
                             }
                             // User ada tapi belum jadi owner - gunakan user ini
                             newUid = existingUser.id;
                             console.log('‚úÖ Using existing user:', newUid);
                             // Update password jika perlu
                             try {
                                 await pb.collection('users').update(newUid, {
                                     password: password,
                                     passwordConfirm: password
                                 });
                             } catch(pwErr) { console.warn('Could not update password:', pwErr.message); }
                         } else {
                             throw authErr;
                         }
                     } 
                     
                     try {
                         const ownerRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'owners'), { 
                             name: ownerName, 
                             email: ownerEmail, 
                             plan: plan, 
                             status: 'active', 
                             createdAt: serverTimestamp(), 
                             accessRights: defaultAccessRights 
                         }); 
                         
                         const storeRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'stores'), { 
                             ownerId: ownerRef.id, 
                             name: `${ownerName} - Pusat`, 
                             address: 'Alamat Default', 
                             phone: '-', 
                             createdAt: serverTimestamp() 
                         }); 
                         
                         // Update user record dengan role owner + storeId
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', newUid), { 
                             name: personalName, 
                             role: 'owner', 
                             ownerId: ownerRef.id, 
                             storeId: storeRef.id, 
                         });
                         
                         console.log('‚úÖ Owner created successfully:', ownerRef.id);
                         console.log('‚úÖ Store created:', storeRef.id);
                         console.log('‚úÖ User updated with role=owner, ownerId, storeId');
                         alert(`‚úÖ SUKSES!\n\nTenant: ${ownerName}\nPlan: ${plan.toUpperCase()}\n\nUser telah dibuat. Default Access Rights disesuaikan dengan Plan.`); 
                         setModal(null);
                         // Data akan auto-refresh karena menggunakan realtime mode
                     } catch (processErr) {
                         console.error('‚ùå Error during owner/store creation:', processErr);
                         // Rollback: delete user if we just created it
                         if (userCreated && newUid) {
                             console.log('Rollback: deleting newly created user...');
                             try {
                                 await pb.collection('users').delete(newUid);
                                 console.log('‚úÖ User rollback successful');
                             } catch (rollbackErr) {
                                 console.error('‚ùå Rollback failed:', rollbackErr.message);
                             }
                         }
                         throw processErr;
                     } 
                 } catch (err) { 
                     console.error('‚ùå createOwner error:', err);
                     alert("Gagal: " + err.message); 
                 } finally { 
                     setLoading(false); 
                 } 
             };
             
             const handleEditClick = async (owner) => {
                 setLoading(true);
                 try {
                     const usersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'users');
                     const q = query(usersRef, where('ownerId', '==', owner.id), where('role', '==', 'owner'));
                     const snap = await getDocs(q);
                     if (!snap.empty) {
                         setSelectedOwnerUser({ id: snap.docs[0].id, ...snap.docs[0].data() });
                     } else {
                         setSelectedOwnerUser(null);
                     }
                     setSelectedOwner(owner);
                     setModal('edit');
                 } catch (e) {
                     alert("Error mengambil data user owner: " + e.message);
                 } finally {
                     setLoading(false);
                 }
             };

             const updateOwner = async (e) => { 
                 e.preventDefault(); 
                 setLoading(true); 
                 const formData = new FormData(e.target); 
                 try { 
                     
                 // üîÑ AUTO SYNC ACCESS RIGHTS DENGAN PLAN + FALLBACK
                 const defaultPlans = {
                     basic: {
                         feature_delete: true, feature_print: true, feature_share: true, feature_stock_add: true,
                         menu_finance: false, feature_backup: false, feature_finance_edit: false, feature_employee_edit: false
                     },
                     pro: {
                         feature_delete: true, feature_print: true, feature_share: true, feature_stock_add: true,
                         menu_finance: true, feature_backup: true, feature_finance_edit: true, feature_employee_edit: true
                     }
                 };
                 const plan = formData.get('plan');
                 let accessRights;
                 try {
                     const planSnap = await getDoc(
                         doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', _planDocId(plan))
                     );
                     if (planSnap.exists()) {
                         accessRights = planSnap.data();
                     } else {
                         accessRights = defaultPlans[plan] || defaultPlans.basic;
                         try {
                             await setDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', _planDocId(plan)), { ...accessRights, plan });
                         } catch(e) { console.warn('Auto-create plan_configs failed:', e.message); }
                     }
                 } catch (configErr) {
                     accessRights = defaultPlans[plan] || defaultPlans.basic;
                 }

                 await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', selectedOwner.id), {
                         accessRights: accessRights, 
                         name: formData.get('name'), 
                         email: formData.get('email'),
                         plan: formData.get('plan'), 
                     }); 
                     if (selectedOwnerUser) {
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', selectedOwnerUser.id), {
                             name: formData.get('ownerName'), 
                             email: formData.get('email')
                         });
                     }
                     alert("Data Owner & Profil Berhasil Diperbarui!"); 
                     setModal(null); 
                 } catch(err) { 
                     alert("Gagal update: " + err.message); 
                 } finally { 
                     setLoading(false); 
                 } 
        };
             
             const deleteTenant = async (ownerId, ownerName) => { 
                 if (!confirm(`‚ö†Ô∏è BAHAYA!\n\nAnda yakin ingin menghapus Tenant: ${ownerName}?\n\nTindakan ini akan menghapus:\n- Data Owner\n- Data Toko (Cabang)\n- Data User (Pegawai)\n\nData tidak dapat dikembalikan!`)) return; 
                 
                 setLoading(true); 
                 try { 
                     // üöÄ OPTIMIZED: Batch delete untuk efisiensi
                     const usersQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'users'), where('ownerId', '==', ownerId)); 
                     const usersSnap = await getDocs(usersQ); 
                     
                     const storesQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'stores'), where('ownerId', '==', ownerId)); 
                     const storesSnap = await getDocs(storesQ); 
                     
                     // Combine all refs for batch delete
                     const allRefs = [
                         ...usersSnap.docs.map(d => d.ref),
                         ...storesSnap.docs.map(d => d.ref),
                         doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', ownerId)
                     ];
                     
                     // Execute batch delete (more efficient than individual deletes)
                     await batchDelete(allRefs);
                     
                     alert(`‚úÖ Tenant ${ownerName} berhasil dihapus permanen.`); 
                 } catch(err) { 
                     alert("‚ùå Gagal menghapus tenant: " + err.message); 
                 } finally { 
                     setLoading(false); 
                 } 
             };
             const updateAccess = async (e) => { 
                 e.preventDefault(); 
                 if (!selectedOwner) return; 
                 
                 const newRights = { 
                     feature_delete: e.target.feature_delete.checked, 
                     feature_print: e.target.feature_print.checked, 
                     feature_share: e.target.feature_share.checked, 
                     feature_stock_add: e.target.feature_stock_add.checked, 
                     menu_finance: e.target.menu_finance.checked, 
                     feature_backup: e.target.feature_backup.checked,
                     feature_backup_per_item: e.target.feature_backup_per_item.checked,
                     feature_finance_edit: e.target.feature_finance_edit.checked, 
                     feature_employee_edit: e.target.feature_employee_edit.checked, 
                     menu_dashboard: e.target.menu_dashboard.checked, 
                     menu_report: e.target.menu_report.checked,
                     menu_service: e.target.menu_service.checked,
                     menu_sales: e.target.menu_sales.checked,
                     menu_purchase: e.target.menu_purchase.checked,
                     menu_return_sales: e.target.menu_return_sales.checked,
                     menu_return_purchase: e.target.menu_return_purchase.checked,
                     menu_after_sales: e.target.menu_after_sales.checked,
                     menu_payable: e.target.menu_payable.checked,
                     menu_receivable: e.target.menu_receivable.checked,
                     menu_cash: e.target.menu_cash.checked,
                     menu_inventory: e.target.menu_inventory.checked,
                     menu_supplier: e.target.menu_supplier.checked,
                     menu_customers: e.target.menu_customers.checked,
                     menu_hr: e.target.menu_hr.checked,
                     menu_ai_assistant: e.target.menu_ai_assistant.checked,
                     menu_users: e.target.menu_users.checked,
                     menu_settings: e.target.menu_settings.checked,
                     menu_finance: e.target.menu_finance.checked,
                     feature_service_edit: e.target.feature_service_edit.checked, 
                     feature_sales_edit: e.target.feature_sales_edit.checked, 
                     feature_inventory_edit: e.target.feature_inventory_edit.checked, 
                     feature_customer_edit: e.target.feature_customer_edit.checked,
                     feature_import_export: e.target.feature_import_export.checked,
                     feature_multi_branch: e.target.feature_multi_branch.checked,
                     feature_qc_checklist: e.target.feature_qc_checklist.checked,
                     feature_kelengkapan: e.target.feature_kelengkapan.checked,
                     feature_accounting: e.target.feature_accounting.checked,
                     feature_subdomain: e.target.feature_subdomain.checked
                 }; 

                 // ‚îÄ‚îÄ Gabungkan trial AI ke dalam accessRights JSON (field yang ada di schema PocketBase) ‚îÄ‚îÄ
                 newRights.aiTrialEnabled = e.target.aiTrialEnabled?.checked || false;
                 newRights.aiTrialKey     = e.target.aiTrialKey?.value?.trim() || '';
                 newRights.aiTrialProvider = e.target.aiTrialProvider?.value || 'groq';
                 newRights.aiTrialDays    = parseInt(e.target.aiTrialDays?.value) || 7;
                 newRights.aiTrialEndDate = e.target.aiTrialEndDate?.value || '';
                 
                 try { 
                     setLoading(true);
                     
                     // Simpan ke PocketBase ‚Äî hanya accessRights (JSON field yang ada di schema)
                     await pb.collection('owners').update(selectedOwner.id, { accessRights: newRights });

                     // Sync ke Firestore agar onSnapshot owner ikut update
                     try {
                         const ownerFsRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', selectedOwner.id);
                         await updateDoc(ownerFsRef, { accessRights: newRights });
                     } catch (fsErr) {
                         console.warn('‚ö†Ô∏è Firestore sync access:', fsErr.message);
                     }

                     // Update state lokal agar UI langsung mencerminkan perubahan
                     const updatedOwner = { ...selectedOwner, accessRights: newRights };
                     setSelectedOwner(updatedOwner);
                     setOwners(prev => prev.map(o => o.id === selectedOwner.id ? updatedOwner : o));
                     
                     alert("‚úÖ Hak akses berhasil disimpan!");
                     setModal(null);
                 } catch (err) { 
                     alert("Gagal update: " + err.message); 
                 } finally {
                     setLoading(false);
                 }
             };

             const handleAutoLogout = async () => {
                 if (!window.confirm('Logout dari semua sesi dan kembali ke halaman login utama (amproject.my.id)?')) return;
                 // Hapus SEMUA localStorage & sessionStorage tanpa filter
                 try { localStorage.clear(); } catch(_) {}
                 try { sessionStorage.clear(); } catch(_) {}
                 // Clear PocketBase authStore (hapus token dari memory & storage)
                 try { pb.authStore.clear(); } catch(_) {}
                 // Reset auth object langsung tanpa menunggu listener
                 try {
                     if (auth) {
                         auth.currentUser = null;
                         auth._listeners = [];
                     }
                 } catch(_) {}
                 // Hapus semua cache global
                 try {
                     _pbAdminTokenCache = null;
                     _pbAdminCredentials = null;
                     window._SUBDOMAIN_TENANT = null;
                 } catch(_) {}
                 // Hard reload ke halaman utama - replace agar tidak bisa back
                 window.location.replace('https://amproject.my.id');
             };

             return (
                 <div className="min-h-screen bg-slate-900 text-white">
                     {loading && <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center"><Loader2 className="w-10 h-10 animate-spin text-purple-500"/></div>}
                     <header className="bg-slate-800 border-b border-slate-700 p-4 md:p-6 sticky top-0 z-50 shadow-lg">
                         <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                             <div className="flex items-center gap-3 md:gap-4">
                                 <div className="w-10 h-10 md:w-12 md:h-12 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/20"><Globe className="w-6 h-6 md:w-7 md:h-7 text-white"/></div>
                                 <div>
                                     <h1 className="text-base md:text-xl font-black tracking-tight">iFix Platform Manager</h1>
                                     <p className="text-[10px] md:text-xs text-purple-400 font-medium uppercase tracking-wider">Developer Control Panel</p>
                                 </div>
                             </div>
                             <div className="flex flex-col gap-2 md:flex-row md:items-center md:gap-3">
                                 <div className="text-right hidden md:block">
                                     <p className="text-sm font-bold">Administrator</p>
                                     <p className="text-xs text-slate-400">{DEVELOPER_EMAIL}</p>
                                 </div>
                                 {/* Mobile 2x2 grid */}
                                 <div className="grid grid-cols-2 gap-2 md:hidden">
                                     <button onClick={()=>setModal('plan')} className="bg-amber-500 hover:bg-amber-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-xs active:scale-95 transition-transform"><Crown className="w-4 h-4 flex-shrink-0"/>Pengaturan Paket</button>
                                     <button onClick={()=>setSubModal('settings')} className="bg-green-600 hover:bg-green-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-xs active:scale-95 transition-transform"><DollarSign className="w-4 h-4 flex-shrink-0"/>Harga Langganan</button>
                                     <button onClick={()=>setModal('backup')} className="bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-xs active:scale-95 transition-transform"><HardDriveDownload className="w-4 h-4 flex-shrink-0"/>Backup Sistem</button>
                                     <button onClick={()=>setModal('masterKelengkapan')} className="bg-teal-600 hover:bg-teal-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-xs active:scale-95 transition-transform"><Layers className="w-4 h-4 flex-shrink-0"/>Master Data</button>
                                     <button onClick={handleAutoLogout} className="col-span-2 bg-orange-500 hover:bg-orange-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-xs active:scale-95 transition-transform"><RefreshCw className="w-4 h-4 flex-shrink-0"/>Auto Logout &amp; Login Ulang</button>
                                     <button onClick={logout} className="col-span-2 bg-red-600 hover:bg-red-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-xs active:scale-95 transition-transform"><LogOut className="w-4 h-4 flex-shrink-0"/>Keluar</button>
                                 </div>
                                 {/* Desktop row */}
                                 <div className="hidden md:flex items-center gap-2">
                                     <button onClick={()=>setModal('plan')} className="bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"><Crown className="w-4 h-4"/>Pengaturan Paket</button>
                                     <button onClick={()=>setSubModal('settings')} className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"><DollarSign className="w-4 h-4"/>Harga Langganan</button>
                                     <button onClick={()=>setModal('backup')} className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"><HardDriveDownload className="w-4 h-4"/>Backup</button>
                                     <button onClick={()=>setModal('masterKelengkapan')} className="bg-teal-600 hover:bg-teal-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"><Layers className="w-4 h-4"/>Master Data</button>
                                     <button onClick={handleAutoLogout} className="bg-orange-500 hover:bg-orange-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"><RefreshCw className="w-4 h-4"/>Auto Logout</button>
                                     <button onClick={logout} className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"><LogOut className="w-4 h-4"/>Logout</button>
                                 </div>
                             </div>
                         </div>
                     </header>
                     
                     {/* VPS & PocketBase Performance Monitor */}
                     <div className="px-3 md:px-8 pt-4 md:pt-6 max-w-7xl mx-auto">
                         <div className="bg-gradient-to-br from-slate-800 to-emerald-900/30 rounded-2xl p-4 md:p-6 border border-emerald-500/30 shadow-2xl mb-4 md:mb-6">
                             <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 md:gap-0 mb-4 md:mb-6">
                                 <div>
                                     <h2 className="text-xl md:text-2xl font-bold text-white mb-1 flex items-center gap-2">
                                         <Activity className="w-5 h-5 md:w-6 md:h-6 text-emerald-400"/>
                                         VPS & PocketBase Monitor
                                     </h2>
                                     <p className="text-emerald-200 text-xs md:text-sm">
                                         VPS: 202.10.40.89 ‚Ä¢ PocketBase: {POCKETBASE_URL} ‚Ä¢ 
                                         {vpsStatus.lastCheck ? `Update: ${vpsStatus.lastCheck.toLocaleTimeString('id-ID')}` : 'Loading...'}
                                     </p>
                                 </div>
                                 <div className="flex gap-2">
                                     <button 
                                         onClick={checkVpsHealth}
                                         disabled={vpsStatus.loading}
                                         className="bg-emerald-600/50 hover:bg-emerald-600 px-3 md:px-4 py-2 rounded-lg text-white font-bold text-xs md:text-sm flex items-center gap-2 border border-emerald-400/30 transition-all disabled:opacity-50">
                                         <RefreshCw className={`w-3 h-3 md:w-4 md:h-4 ${vpsStatus.loading ? 'animate-spin' : ''}`}/> Refresh
                                     </button>
                                     <a href={`${POCKETBASE_URL}/_/`} target="_blank" rel="noopener noreferrer"
                                         className="bg-blue-600/50 hover:bg-blue-600 px-3 md:px-4 py-2 rounded-lg text-white font-bold text-xs md:text-sm flex items-center gap-2 border border-blue-400/30 transition-all">
                                         <ExternalLink className="w-3 h-3 md:w-4 md:h-4"/> Admin UI
                                     </a>
                                 </div>
                             </div>
                             
                             {/* Status Cards */}
                             <div className="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4 md:mb-6">
                                 {/* PocketBase Health */}
                                 <div className={`backdrop-blur-sm rounded-xl p-4 border ${vpsStatus.pbHealth?.ok ? 'bg-emerald-500/10 border-emerald-400/30' : vpsStatus.loading ? 'bg-white/10 border-white/20' : 'bg-red-500/10 border-red-400/30'}`}>
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-slate-200 text-xs font-bold uppercase">PocketBase</span>
                                         {vpsStatus.loading ? <Loader2 className="w-4 h-4 text-slate-400 animate-spin"/> : 
                                          vpsStatus.pbHealth?.ok ? <CheckCircle className="w-4 h-4 text-emerald-400"/> : <AlertTriangle className="w-4 h-4 text-red-400"/>}
                                     </div>
                                     <div className={`text-2xl font-black mb-1 ${vpsStatus.pbHealth?.ok ? 'text-emerald-400' : vpsStatus.loading ? 'text-slate-400' : 'text-red-400'}`}>
                                         {vpsStatus.loading ? '...' : vpsStatus.pbHealth?.ok ? 'ONLINE' : 'OFFLINE'}
                                     </div>
                                     <div className="text-xs text-slate-300">
                                         {vpsStatus.pbHealth?.latency >= 0 ? `Latency: ${vpsStatus.pbHealth.latency}ms` : 'Tidak terjangkau'}
                                     </div>
                                 </div>
                                 
                                 {/* VPS Info */}
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-slate-200 text-xs font-bold uppercase">VPS Server</span>
                                         <Globe className="w-4 h-4 text-blue-400"/>
                                     </div>
                                     <div className="text-lg font-black text-white mb-1">202.10.40.89</div>
                                     <div className="text-xs text-slate-300">Self-hosted PocketBase</div>
                                 </div>
                                 
                                 {/* Total Collections */}
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-slate-200 text-xs font-bold uppercase">Collections</span>
                                         <Database className="w-4 h-4 text-purple-400"/>
                                     </div>
                                     <div className="text-3xl font-black text-white mb-1">
                                         {vpsStatus.loading ? '...' : vpsStatus.pbStats.totalCollections || 0}
                                     </div>
                                     <div className="text-xs text-slate-300">
                                         {vpsStatus.pbStats.errorCollections > 0 ? `${vpsStatus.pbStats.errorCollections} error` : 'Semua aktif'}
                                     </div>
                                 </div>
                                 
                                 {/* Total Records */}
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-slate-200 text-xs font-bold uppercase">Total Records</span>
                                         <TrendingUp className="w-4 h-4 text-cyan-400"/>
                                     </div>
                                     <div className="text-3xl font-black text-white mb-1">
                                         {vpsStatus.loading ? '...' : (vpsStatus.pbStats.totalRecords || 0).toLocaleString()}
                                     </div>
                                     <div className="text-xs text-slate-300">Di semua collections</div>
                                 </div>
                             </div>
                             
                             {/* Collection Details */}
                             <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                 <h3 className="text-white font-bold mb-3 flex items-center gap-2">
                                     <Database className="w-4 h-4 text-purple-400"/>
                                     Detail Collections PocketBase
                                 </h3>
                                 {vpsStatus.loading ? (
                                     <div className="flex items-center justify-center py-8 text-slate-400 gap-2">
                                         <Loader2 className="w-5 h-5 animate-spin"/> Loading...
                                     </div>
                                 ) : vpsStatus.pbCollections.length > 0 ? (
                                     <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                         {vpsStatus.pbCollections
                                             .sort((a, b) => b.count - a.count)
                                             .map((col, idx) => (
                                             <div key={idx} className={`flex items-center justify-between p-2.5 rounded-lg border ${col.ok ? 'bg-slate-900/50 border-slate-700' : 'bg-red-900/30 border-red-500/30'}`}>
                                                 <div className="flex items-center gap-2">
                                                     <div className={`w-2 h-2 rounded-full ${col.ok ? 'bg-emerald-400' : 'bg-red-400'}`}></div>
                                                     <span className="text-sm text-white font-medium capitalize">{col.name.replace(/_/g, ' ')}</span>
                                                 </div>
                                                 <span className={`text-sm font-bold ${col.ok ? 'text-emerald-400' : 'text-red-400'}`}>
                                                     {col.ok ? col.count.toLocaleString() : '‚úó'}
                                                 </span>
                                             </div>
                                         ))}
                                     </div>
                                 ) : (
                                     <div className="text-center py-6 text-slate-400 text-sm">Tidak ada data collections</div>
                                 )}
                             </div>
                             
                             {/* Keuntungan PocketBase Info */}
                             <div className="mt-4 bg-gradient-to-r from-emerald-900/30 to-cyan-900/30 border-2 border-emerald-500/40 rounded-xl p-4">
                                 <div className="flex items-start gap-3">
                                     <Info className="w-5 h-5 text-emerald-400 flex-shrink-0 mt-0.5"/>
                                     <div>
                                         <h4 className="text-emerald-200 font-bold text-sm mb-2">üöÄ Keuntungan PocketBase (Self-hosted)</h4>
                                         <div className="grid md:grid-cols-2 gap-2 text-xs text-emerald-100">
                                             <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3 text-emerald-400 flex-shrink-0"/> GRATIS tanpa batas quota</div>
                                             <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3 text-emerald-400 flex-shrink-0"/> Data di VPS sendiri (full control)</div>
                                             <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3 text-emerald-400 flex-shrink-0"/> Tidak ada biaya per-read/write</div>
                                             <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3 text-emerald-400 flex-shrink-0"/> Real-time updates via SSE</div>
                                             <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3 text-emerald-400 flex-shrink-0"/> Backup mudah via Admin UI</div>
                                             <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3 text-emerald-400 flex-shrink-0"/> Single binary, ringan di VPS</div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     
                     <main className="p-3 md:p-8 max-w-7xl mx-auto"> 
                         <div className="flex flex-col md:flex-row md:justify-between md:items-end gap-4 mb-6 md:mb-8">
                             <div>
                                 <h2 className="text-2xl md:text-3xl font-bold mb-2">Daftar Tenant (Owner)</h2>
                                 <p className="text-slate-400 text-sm md:text-base">Kelola bisnis dan hak akses setiap owner.</p>
                             </div>
                             <button onClick={()=>{setModal('create')}} className="bg-purple-600 hover:bg-purple-700 px-4 md:px-6 py-2.5 md:py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all hover:scale-105 shadow-lg shadow-purple-900/50 text-sm md:text-base w-full md:w-auto">
                                 <Plus className="w-4 h-4 md:w-5 md:h-5"/> Buat Owner Baru
                             </button>
                         </div> 
                         {isOwnersLoading ? (
                             <div className="flex flex-col items-center justify-center py-16 text-slate-400 gap-4">
                                 <Loader2 className="w-10 h-10 animate-spin text-purple-400"/>
                                 <p className="font-bold">Memuat data tenant...</p>
                             </div>
                         ) : ownersError ? (
                             <div className="bg-red-900/20 border border-red-500/30 rounded-xl p-6 text-center">
                                 <ShieldAlert className="w-10 h-10 text-red-400 mx-auto mb-3"/>
                                 <p className="text-red-300 font-bold mb-2">{ownersError}</p>
                                 <button onClick={() => { 
                                     setOwnersError(''); 
                                     setIsOwnersLoading(true); 
                                     pb.collection('owners').getList(1, 500, { sort: '-created' })
                                         .then(r => { setOwners(r.items.map(i => { const o = {...i}; delete o.collectionId; delete o.collectionName; delete o.expand; return o; })); setIsOwnersLoading(false); })
                                         .catch(e => { setOwnersError('Gagal: ' + e.message); setIsOwnersLoading(false); });
                                 }} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold">Coba Lagi</button>
                             </div>
                         ) : owners.length === 0 ? (
                             <div className="bg-slate-800/50 border border-dashed border-slate-600 rounded-xl p-8 text-center">
                                 <div className="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                     <Plus className="w-8 h-8 text-slate-500"/>
                                 </div>
                                 <h3 className="text-lg font-bold text-slate-300 mb-2">Belum Ada Tenant</h3>
                                 <p className="text-slate-500 text-sm mb-4">Klik "Buat Owner Baru" untuk menambahkan tenant pertama.</p>
                                 <button onClick={() => setModal('create')} className="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-xl font-bold text-sm">
                                     <Plus className="w-4 h-4 inline mr-1"/> Buat Owner Baru
                                 </button>
                             </div>
                         ) : (
                         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"> {owners.map(owner => { const subStatus = getOwnerSubStatus(owner); return ( <div key={owner.id} className="bg-slate-800 border border-slate-700 rounded-2xl p-3 md:p-6 hover:border-purple-500 transition-all group relative overflow-hidden flex flex-col"> <div className="flex justify-between items-start mb-3 md:mb-4 relative z-10"> <div className="w-10 h-10 md:w-12 md:h-12 rounded-full bg-slate-700 flex items-center justify-center font-bold text-lg md:text-xl text-purple-400 border border-slate-600">{owner.name?.charAt(0)}</div> <div className="flex gap-1.5 md:gap-2"> <button onClick={()=>{handleEditClick(owner)}} className="bg-blue-900/50 hover:bg-blue-800 text-blue-300 p-1.5 md:p-2 rounded-lg transition-colors"><Pencil className="w-3 h-3"/></button> <span className={`px-2 md:px-3 py-1 rounded-full text-[10px] md:text-xs font-bold uppercase pt-1 md:pt-1.5 border ${owner.plan === 'pro' ? 'bg-purple-900/50 text-purple-300 border-purple-500/30' : 'bg-slate-700 text-slate-400 border-slate-600'}`}>{owner.plan}</span> </div> </div> <h3 className="text-base md:text-xl font-bold mb-1">{owner.name}</h3><p className="text-slate-400 text-xs md:text-sm mb-2 md:mb-3 flex items-center gap-1 md:gap-2 break-all"><MessageCircle className="w-3 h-3 flex-shrink-0"/> <span className="truncate">{owner.email}</span></p> <div className={`flex flex-col sm:flex-row items-start sm:items-center justify-between p-2 md:p-3 rounded-lg mb-3 md:mb-4 border gap-2 sm:gap-0 ${subStatus.status === 'active' ? 'bg-green-900/30 border-green-500/30' : subStatus.status === 'expired' ? 'bg-red-900/30 border-red-500/30' : 'bg-yellow-900/30 border-yellow-500/30'}`}><div className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full flex-shrink-0 ${subStatus.status === 'active' ? 'bg-green-400 animate-pulse' : subStatus.status === 'expired' ? 'bg-red-400' : 'bg-yellow-400'}`}></div><span className={`text-[10px] md:text-xs font-bold ${subStatus.status === 'active' ? 'text-green-300' : subStatus.status === 'expired' ? 'text-red-300' : 'text-yellow-300'}`}>{subStatus.status === 'active' ? `Aktif - ${subStatus.remainingDays} hari` : subStatus.status === 'expired' ? 'Kedaluwarsa' : 'Belum Aktif'}</span></div><div className="flex gap-1 flex-wrap">{subStatus.status === 'active' && <button onClick={() => revokeSubscription(owner)} className="px-2 py-1 rounded text-[9px] md:text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex items-center gap-0.5" title="Nonaktifkan"><Lock className="w-2.5 h-2.5 md:w-3 md:h-3"/><span className="hidden sm:inline">Nonaktifkan</span><span className="sm:hidden">Off</span></button>}{subStatus.status === 'active' && <button onClick={() => setSubModal({type: 'activate', owner})} className="px-2 py-1 rounded text-[9px] md:text-[10px] font-bold bg-blue-600 hover:bg-blue-700 text-white">Perpanjang</button>}{subStatus.status !== 'active' && <button onClick={() => setSubModal({type: 'activate', owner})} className="px-2 py-1 rounded text-[9px] md:text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white animate-pulse">Aktifkan</button>}</div></div><div className="grid grid-cols-2 md:grid-cols-4 gap-1.5 md:gap-2 mb-3 md:mb-4"><button onClick={() => { setSelectedOwner(owner); setModal('access'); }} className="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg font-bold text-[10px] md:text-xs flex items-center justify-center gap-0.5 md:gap-1 transition-colors border border-slate-600"><Key className="w-3 h-3"/> <span className="hidden sm:inline">Akses</span><span className="sm:hidden">Akses</span></button><button onClick={() => { setSelectedOwner(owner); setModal('qcItems'); }} className="bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold text-[10px] md:text-xs flex items-center justify-center gap-0.5 md:gap-1 transition-colors"><ShieldCheck className="w-3 h-3"/> QC</button><button onClick={() => { setSelectedOwner(owner); setModal('kelengkapanItems'); }} className="bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded-lg font-bold text-[10px] md:text-xs flex items-center justify-center gap-0.5 md:gap-1 transition-colors"><CheckCircle className="w-3 h-3"/> <span className="hidden sm:inline">Lengkap</span><span className="sm:hidden">OK</span></button><button onClick={() => setSubModal({type: 'message', owner})} className="bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold text-[10px] md:text-xs flex items-center justify-center gap-0.5 md:gap-1 transition-colors" title="Kirim Pesan ke Owner"><MessageCircle className="w-3 h-3"/> <span className="hidden sm:inline">Pesan</span><span className="sm:hidden">Chat</span></button></div><button onClick={() => enterTenantContext(owner.id)} className="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold text-[10px] md:text-xs flex items-center justify-center gap-1 md:gap-2 transition-colors mb-2"><Eye className="w-3 h-3"/> Masuk (Spy)</button> <button onClick={() => deleteTenant(owner.id, owner.name)} className="mt-auto w-full py-2 bg-red-900/30 text-red-400 border border-red-900/50 hover:bg-red-900/50 rounded-lg text-[10px] md:text-xs font-bold flex items-center justify-center gap-1 md:gap-2"><Trash2 className="w-3 h-3"/> Hapus Tenant</button> </div> ); })} </div>
                         )} </main> { (modal === 'create' || modal === 'edit') && ( <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4"> <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl"> <h3 className="font-bold text-xl mb-6 text-white">{modal === 'create' ? 'Registrasi Owner Baru' : 'Edit Data Owner'}</h3> <form onSubmit={modal === 'create' ? createOwner : updateOwner} className="space-y-4"> <input name="name" defaultValue={selectedOwner?.name} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Nama Bisnis / Toko" required/> <input name="ownerName" defaultValue={selectedOwnerUser?.name} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Nama Pemilik" required/> <input name="email" type="email" defaultValue={selectedOwner?.email} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Email Login Owner" required/> {modal === 'create' && <input name="password" type="password" className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Password Login (Min 6 Karakter)" required minLength="6"/>} <div className="grid grid-cols-1 gap-2"> <label className="text-xs text-slate-400 font-bold uppercase">Pilih Paket Langganan</label> <select name="plan" defaultValue={selectedOwner?.plan || 'basic'} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-purple-500 outline-none"> <option value="basic">Basic Plan (Max 1 Cabang, No Backup)</option> <option value="pro">Pro Plan (Unlimited, Full Akses)</option> </select> </div> <div className="flex gap-3 mt-6"> <button type="button" onClick={()=>{setModal(null); setSelectedOwner(null); setSelectedOwnerUser(null);}} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700">Batal</button> <button disabled={loading} className="flex-1 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 shadow-lg shadow-purple-900/50 flex items-center justify-center gap-2"> {loading && <Loader2 className="w-4 h-4 animate-spin"/>} {modal === 'create' ? 'Buat Tenant' : 'Simpan Perubahan'} </button> </div> </form> </div> </div> ) } {modal === 'access' && selectedOwner && ( <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-2"><div className="bg-slate-800 border border-slate-700 w-full max-w-[98vw] rounded-2xl shadow-2xl h-[96vh] overflow-hidden flex flex-col"><div className="flex items-center justify-between gap-3 p-6 border-b border-slate-700 bg-slate-750"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white text-lg">{selectedOwner.name.charAt(0)}</div><div><h3 className="font-bold text-lg text-white">{selectedOwner.name}</h3><p className="text-xs text-purple-300">Pengaturan Hak Akses Tenant - Kontrol Fitur & Menu</p></div></div><button type="button" onClick={()=>setModal(null)} className="text-slate-400 hover:text-white transition-colors p-2 hover:bg-slate-700 rounded-lg"><X className="w-5 h-5"/></button></div><div className="px-6 pt-4"><p className="text-slate-400 text-sm bg-slate-900/50 p-3 rounded-lg border border-slate-700"><span className="text-yellow-400 font-bold">‚ö†Ô∏è PERHATIAN:</span> Fitur yang Anda matikan akan <strong>terkunci permanen</strong> untuk Owner dan seluruh karyawannya.</p></div><form onSubmit={updateAccess} className="flex-1 overflow-y-auto p-6 space-y-6"><div className="space-y-4"><div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4"><h4 className="font-bold text-blue-300 mb-3 flex items-center gap-2"><LayoutDashboard className="w-4 h-4"/> MENU UTAMA</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_dashboard', label: 'üìä Dashboard'},{id: 'menu_report', label: 'üìà Laporan'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div></div></label>))}</div></div><div className="bg-green-900/20 border border-green-500/30 rounded-lg p-4"><h4 className="font-bold text-green-300 mb-3 flex items-center gap-2"><Smartphone className="w-4 h-4"/> MENU TRANSAKSI</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_service', label: 'üì± Servis HP'},{id: 'menu_sales', label: 'üõí Penjualan'},{id: 'menu_purchase', label: 'üõçÔ∏è Pembelian'},{id: 'menu_return_sales', label: '‚Ü©Ô∏è Retur Penjualan'},{id: 'menu_return_purchase', label: '‚Ü™Ô∏è Retur Pembelian'},{id: 'menu_after_sales', label: 'üõ°Ô∏è After Sales Care'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div></div></label>))}</div></div><div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4"><h4 className="font-bold text-yellow-300 mb-3 flex items-center gap-2"><Wallet className="w-4 h-4"/> MENU KEUANGAN</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_payable', label: 'üì§ Utang'},{id: 'menu_receivable', label: 'üì• Piutang'},{id: 'menu_cash', label: 'üíµ Kas'},{id: 'menu_finance', label: 'üí≥ Laporan Keuangan'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-600"></div></div></label>))}</div></div><div className="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4"><h4 className="font-bold text-purple-300 mb-3 flex items-center gap-2"><Box className="w-4 h-4"/> MENU INVENTORY & DATA</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_inventory', label: 'üì¶ Stok Barang'},{id: 'menu_supplier', label: 'üöö Supplier'},{id: 'menu_customers', label: 'üë• Pelanggan'},{id: 'menu_hr', label: 'üëî HR & Payroll'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div></div></label>))}</div></div><div className="bg-violet-900/20 border border-violet-500/30 rounded-lg p-4"><h4 className="font-bold text-violet-300 mb-3 flex items-center gap-2"><Brain className="w-4 h-4"/> FITUR PREMIUM</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_ai_assistant', label: '‚ú® AI Assistant (Gemini)'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-violet-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-violet-600"></div></div></label>))}</div></div><div className="bg-red-900/20 border border-red-500/30 rounded-lg p-4"><h4 className="font-bold text-red-300 mb-3 flex items-center gap-2"><Settings className="w-4 h-4"/> MENU ADMIN</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_users', label: 'üë® Pegawai'},{id: 'menu_settings', label: '‚öôÔ∏è Pengaturan'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div></div></label>))}</div></div><div className="bg-cyan-900/20 border border-cyan-500/30 rounded-lg p-4"><h4 className="font-bold text-cyan-300 mb-3 flex items-center gap-2"><ShieldCheck className="w-4 h-4"/> FITUR & AKSI</h4><div className="grid grid-cols-1 gap-3">{[{id: 'feature_service_edit', label: '‚úèÔ∏è Edit Servis'},{id: 'feature_sales_edit', label: '‚úèÔ∏è Edit Penjualan'},{id: 'feature_inventory_edit', label: '‚úèÔ∏è Edit Inventory'},{id: 'feature_customer_edit', label: '‚úèÔ∏è Edit Pelanggan'},{id: 'feature_employee_edit', label: '‚úèÔ∏è Edit Pegawai'},{id: 'feature_finance_edit', label: '‚úèÔ∏è Edit Keuangan'},{id: 'feature_print', label: 'üñ®Ô∏è Cetak Invoice'},{id: 'feature_share', label: 'üí¨ Share WhatsApp'},{id: 'feature_delete', label: 'üóëÔ∏è Hapus Data'},{id: 'feature_stock_add', label: '‚ûï Tambah Stok'},{id: 'feature_backup', label: 'üíæ Backup Data'},{id: 'feature_backup_per_item', label: 'üíæ Backup Per Item'},{id: 'feature_import_export', label: 'üì§ Import/Export'},{id: 'feature_multi_branch', label: 'üè¢ Multi Cabang'},{id: 'feature_qc_checklist', label: '‚úÖ QC Checklist'},{id: 'feature_kelengkapan', label: 'üìã Kelengkapan Item'},{id: 'feature_accounting', label: 'üìä Akuntansi'},{id: 'feature_subdomain', label: 'üåê Subdomain Custom'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600"></div></div></label>))}</div></div></div>

<div className="bg-violet-900/20 border border-violet-500/30 rounded-lg p-4 mt-4"><h4 className="font-bold text-violet-300 mb-3 flex items-center gap-2"><Brain className="w-4 h-4"/> TRIAL AI ASSISTANT</h4><div className="space-y-3"><label className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-violet-500 cursor-pointer group"><div><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm block">üéÅ Aktifkan Trial AI</span><span className="text-slate-500 text-xs">Owner dapat mencoba AI dengan key developer</span></div><div className="relative flex items-center"><input type="checkbox" name="aiTrialEnabled" defaultChecked={!!(selectedOwner.accessRights?.aiTrialEnabled)} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-violet-600"></div></div></label><div className="grid grid-cols-2 gap-3"><div><label className="text-xs text-slate-400 font-bold uppercase mb-1.5 block">Provider</label><select name="aiTrialProvider" defaultValue={selectedOwner.accessRights?.aiTrialProvider || 'groq'} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white focus:border-violet-500 outline-none text-sm font-bold"><option value="groq">‚ö° Groq</option><option value="gemini">üîµ Gemini</option></select></div><div><label className="text-xs text-slate-400 font-bold uppercase mb-1.5 block">Durasi (hari)</label><input name="aiTrialDays" type="number" min="1" max="365" defaultValue={selectedOwner.accessRights?.aiTrialDays || 7} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white focus:border-violet-500 outline-none font-bold text-sm" placeholder="7"/></div></div><div><label className="text-xs text-slate-400 font-bold uppercase mb-1.5 block flex items-center gap-1"><Key className="w-3 h-3"/> API Key untuk Trial</label><input name="aiTrialKey" type="password" defaultValue={selectedOwner.accessRights?.aiTrialKey || ''} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white placeholder-slate-500 focus:border-violet-500 outline-none font-mono text-xs" placeholder="gsk_... atau AIzaSy..."/><p className="text-xs text-slate-500 mt-1">API key developer yang dipakai owner selama trial</p></div><div><label className="text-xs text-slate-400 font-bold uppercase mb-1.5 block">Tanggal Berakhir (opsional)</label><input name="aiTrialEndDate" type="date" defaultValue={selectedOwner.accessRights?.aiTrialEndDate || ''} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white focus:border-violet-500 outline-none text-sm font-bold"/><p className="text-xs text-slate-500 mt-1">Kosongkan = hitung otomatis dari hari pertama buka AI</p></div>{selectedOwner.accessRights?.aiTrialEnabled && (<div className="bg-slate-900 rounded-lg p-2.5 border border-violet-700/50 text-xs text-violet-300">‚úÖ Trial <strong>AKTIF</strong> untuk tenant ini ‚Äî sisa {(() => { if (selectedOwner.accessRights?.aiTrialEndDate) { const d = Math.ceil((new Date(selectedOwner.accessRights?.aiTrialEndDate) - new Date()) / 86400000); return d > 0 ? d + ' hari' : 'Expired'; } const start = localStorage.getItem('ai_trial_start_' + selectedOwner.id); if (!start) return (selectedOwner.accessRights?.aiTrialDays || 7) + ' hari (belum dimulai)'; const d = Math.ceil((new Date(start).getTime() + (selectedOwner.accessRights?.aiTrialDays||7)*86400000 - Date.now()) / 86400000); return d > 0 ? d + ' hari' : 'Expired'; })()}</div>)}</div></div>

<div className="flex gap-3 pt-4 border-t border-slate-700"><button type="button" onClick={()=>setModal(null)} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700 text-sm">Batal</button><button className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 text-sm flex items-center justify-center gap-2"><Save className="w-4 h-4"/>Simpan Hak Akses</button></div></form></div></div> )} {modal === 'plan' && <PlanConfigModal close={()=>setModal(null)} />} {modal === 'masterKelengkapan' && <MasterKelengkapanModal close={()=>setModal(null)} />} {modal === 'qcItems' && <QCFunctionalItemsModal close={()=>setModal(null)} ownerId={selectedOwner?.id} />} {modal === 'kelengkapanItems' && <KelengkapanItemsModal close={()=>setModal(null)} ownerId={selectedOwner?.id} />} {modal === 'backup' && <BackupModalDeveloper close={()=>setModal(null)} />}

                    {/* Subscription Settings Modal */}
                    {subModal === 'settings' && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-700 w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-xl text-white flex items-center gap-2"><Crown className="w-5 h-5 text-amber-400"/> Pengaturan Paket Langganan</h3>
                                    <button onClick={() => setSubModal(null)} className="text-slate-400 hover:text-white p-1"><X className="w-5 h-5"/></button>
                                </div>
                                <form onSubmit={(e) => { 
                                    e.preventDefault(); 
                                    const fd = new FormData(e.target); 
                                    saveSubConfig({ 
                                        whatsapp: fd.get('whatsapp'),
                                        basicFirstYear: parseInt(fd.get('basicFirstYear')),
                                        basicRenewal: parseInt(fd.get('basicRenewal')),
                                        proFirstYear: parseInt(fd.get('proFirstYear')),
                                        proRenewal: parseInt(fd.get('proRenewal')),
                                        duration: parseInt(fd.get('duration')),
                                        currency: 'IDR'
                                    }, featureLists); 
                                }} className="space-y-6">
                                    {/* WhatsApp Admin */}
                                    <div className="bg-slate-900 border border-slate-700 rounded-lg p-4">
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-2 block flex items-center gap-2">
                                            <Phone className="w-4 h-4"/> No. WhatsApp Admin
                                        </label>
                                        <input name="whatsapp" type="tel" defaultValue={subConfig.whatsapp} className="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-amber-500 outline-none font-bold" placeholder="6281234567890" required/>
                                        <p className="text-xs text-slate-500 mt-2">Nomor WA yang tampil di halaman lock (format: 628xxx tanpa + atau spasi)</p>
                                    </div>

                                    {/* Basic Plan */}
                                    <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-5">
                                        <h4 className="font-bold text-blue-300 mb-4 flex items-center gap-2">
                                            <Package className="w-5 h-5"/> Basic Plan
                                        </h4>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-xs text-slate-400 font-bold uppercase mb-2 block">Tahun Pertama (Rp)</label>
                                                <input name="basicFirstYear" type="number" defaultValue={subConfig.basicFirstYear || 1200000} className="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none font-bold text-lg" required/>
                                            </div>
                                            <div>
                                                <label className="text-xs text-slate-400 font-bold uppercase mb-2 block">Perpanjangan (Rp)</label>
                                                <input name="basicRenewal" type="number" defaultValue={subConfig.basicRenewal || 960000} className="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none font-bold text-lg" required/>
                                            </div>
                                        </div>
                                        <p className="text-xs text-blue-300 mt-2">‚úÖ Max 1 cabang, fitur dasar POS</p>
                                    </div>

                                    {/* Pro Plan */}
                                    <div className="bg-purple-900/20 border border-purple-500/30 rounded-lg p-5">
                                        <h4 className="font-bold text-purple-300 mb-4 flex items-center gap-2">
                                            <Crown className="w-5 h-5"/> Pro Plan ‚≠ê
                                        </h4>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-xs text-slate-400 font-bold uppercase mb-2 block">Tahun Pertama (Rp)</label>
                                                <input name="proFirstYear" type="number" defaultValue={subConfig.proFirstYear || 2400000} className="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-purple-500 outline-none font-bold text-lg" required/>
                                            </div>
                                            <div>
                                                <label className="text-xs text-slate-400 font-bold uppercase mb-2 block">Perpanjangan (Rp)</label>
                                                <input name="proRenewal" type="number" defaultValue={subConfig.proRenewal || 1920000} className="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-purple-500 outline-none font-bold text-lg" required/>
                                            </div>
                                        </div>
                                        <p className="text-xs text-purple-300 mt-2">‚úÖ Max 5 cabang, laporan lengkap, backup & restore data</p>
                                    </div>

                                    {/* ‚îÄ‚îÄ‚îÄ EDITOR DAFTAR FITUR ‚îÄ‚îÄ‚îÄ */}
                                    {['basic','pro'].map(plan => (
                                        <div key={plan} className={`rounded-xl border p-5 ${plan==='pro' ? 'bg-purple-900/10 border-purple-500/30' : 'bg-blue-900/10 border-blue-500/30'}`}>
                                            <div className="flex items-center justify-between mb-3">
                                                <h4 className={`font-bold flex items-center gap-2 ${plan==='pro' ? 'text-purple-300' : 'text-blue-300'}`}>
                                                    {plan==='pro' ? <Crown className="w-4 h-4"/> : <Package className="w-4 h-4"/>}
                                                    Daftar Fitur {plan==='pro' ? 'Pro' : 'Basic'} (tampil ke owner)
                                                </h4>
                                                <span className="text-xs text-slate-500">tip: awali ~ untuk item ‚ùå coret</span>
                                            </div>
                                            <div className="space-y-2 mb-3">
                                                {featureLists[plan].map((item, idx) => (
                                                    <div key={idx} className="flex gap-2 items-center">
                                                        <span className="flex-shrink-0 text-base">
                                                            {item.startsWith('~') ? '‚ùå' : '‚úÖ'}
                                                        </span>
                                                        <input
                                                            value={item.startsWith('~') ? item.slice(1) : item}
                                                            onChange={e => {
                                                                const raw = item.startsWith('~') ? ('~' + e.target.value) : e.target.value;
                                                                setFeatureLists(prev => {
                                                                    const arr = [...prev[plan]];
                                                                    arr[idx] = raw;
                                                                    return {...prev, [plan]: arr};
                                                                });
                                                            }}
                                                            className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-1.5 text-white text-sm focus:border-blue-400 outline-none"
                                                            placeholder="Teks fitur, **bold** untuk tebal"
                                                        />
                                                        <button type="button"
                                                            onClick={() => setFeatureLists(prev => {
                                                                const was = prev[plan][idx];
                                                                const arr = [...prev[plan]];
                                                                arr[idx] = was.startsWith('~') ? was.slice(1) : ('~' + was);
                                                                return {...prev, [plan]: arr};
                                                            })}
                                                            title="Toggle ‚úÖ/‚ùå"
                                                            className="px-2 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs font-bold flex-shrink-0">
                                                            {item.startsWith('~') ? '‚úÖ' : '‚ùå'}
                                                        </button>
                                                        <button type="button"
                                                            onClick={() => setFeatureLists(prev => {
                                                                const arr = prev[plan].filter((_,i) => i!==idx);
                                                                return {...prev, [plan]: arr};
                                                            })}
                                                            className="px-2 py-1.5 rounded-lg bg-red-900/40 hover:bg-red-800 text-red-300 flex-shrink-0">
                                                            <Trash2 className="w-3.5 h-3.5"/>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                            <button type="button"
                                                onClick={() => setFeatureLists(prev => ({...prev, [plan]: [...prev[plan], 'Fitur baru']}))}
                                                className={`w-full py-2 rounded-lg border text-sm font-bold flex items-center justify-center gap-2 ${plan==='pro' ? 'border-purple-500/40 text-purple-300 hover:bg-purple-900/20' : 'border-blue-500/40 text-blue-300 hover:bg-blue-900/20'}`}>
                                                + Tambah Item Fitur
                                            </button>
                                        </div>
                                    ))}
                                    <div className="bg-slate-900 border border-slate-700 rounded-lg p-4">
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-2 block flex items-center gap-2">
                                            <Calendar className="w-4 h-4"/> Durasi Aktif (Hari)
                                        </label>
                                        <input name="duration" type="number" defaultValue={subConfig.duration || 365} className="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 outline-none font-bold text-lg" required min="1"/>
                                        <p className="text-xs text-slate-500 mt-2">Berapa hari aplikasi aktif setelah pembayaran (365 = 1 tahun)</p>
                                    </div>

                                    {/* Preview */}
                                    <div className="bg-gradient-to-r from-amber-900/30 to-orange-900/30 border border-amber-500/30 p-5 rounded-lg">
                                        <p className="text-amber-200 text-sm font-bold mb-3 flex items-center gap-2">
                                            <Info className="w-4 h-4"/> Preview Halaman Subscription Owner:
                                        </p>
                                        <div className="grid md:grid-cols-2 gap-3 text-sm">
                                            <div className="bg-slate-900/50 p-3 rounded border border-blue-500/20">
                                                <p className="text-blue-300 font-bold mb-2">Basic Plan</p>
                                                <p className="text-white text-xs mb-1">Tahun 1: Rp {((subConfig.basicFirstYear || 1200000)).toLocaleString('id-ID')}</p>
                                                <p className="text-emerald-300 text-xs mb-2">Perpanjangan: Rp {((subConfig.basicRenewal || 960000)).toLocaleString('id-ID')}</p>
                                                <div className="space-y-1">
                                                    {featureLists.basic.map((f,i) => (
                                                        <div key={i} className="flex items-center gap-1.5 text-xs">
                                                            {f.startsWith('~') ? <span className="text-red-400 flex-shrink-0">‚úï</span> : <span className="text-green-400 flex-shrink-0">‚úì</span>}
                                                            <span className={f.startsWith('~') ? 'line-through text-slate-500' : 'text-slate-300'} dangerouslySetInnerHTML={{__html: (f.startsWith('~') ? f.slice(1) : f).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')}}/>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="bg-slate-900/50 p-3 rounded border border-purple-500/20">
                                                <p className="text-purple-300 font-bold mb-2">Pro Plan ‚≠ê</p>
                                                <p className="text-white text-xs mb-1">Tahun 1: Rp {((subConfig.proFirstYear || 2400000)).toLocaleString('id-ID')}</p>
                                                <p className="text-emerald-300 text-xs mb-2">Perpanjangan: Rp {((subConfig.proRenewal || 1920000)).toLocaleString('id-ID')}</p>
                                                <div className="space-y-1">
                                                    {featureLists.pro.map((f,i) => (
                                                        <div key={i} className="flex items-center gap-1.5 text-xs">
                                                            {f.startsWith('~') ? <span className="text-red-400 flex-shrink-0">‚úï</span> : <span className="text-green-400 flex-shrink-0">‚úì</span>}
                                                            <span className={f.startsWith('~') ? 'line-through text-slate-500' : 'text-slate-300'} dangerouslySetInnerHTML={{__html: (f.startsWith('~') ? f.slice(1) : f).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')}}/>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setSubModal(null)} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700">Batal</button>
                                        <button disabled={loading} className="flex-1 py-3 bg-gradient-to-r from-amber-600 to-orange-600 text-white rounded-lg font-bold hover:from-amber-700 hover:to-orange-700 flex items-center justify-center gap-2 shadow-lg">
                                            {loading && <Loader2 className="w-4 h-4 animate-spin"/>} 
                                            <Save className="w-4 h-4"/> Simpan Setting
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Activate/Extend Subscription Modal */}
                    {subModal?.type === 'activate' && subModal.owner && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-2 md:p-4">
                            <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-4 md:p-6 shadow-2xl max-h-[95vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-4 md:mb-6">
                                    <h3 className="font-bold text-lg md:text-xl text-white flex items-center gap-2">
                                        <CheckCircle className="w-4 h-4 md:w-5 md:h-5 text-green-400"/> 
                                        <span className="hidden sm:inline">Aktifkan Langganan</span>
                                        <span className="sm:hidden">Perpanjang</span>
                                    </h3>
                                    <button onClick={() => setSubModal(null)} className="text-slate-400 hover:text-white p-1"><X className="w-5 h-5"/></button>
                                </div>
                                <div className="bg-slate-900 p-3 md:p-4 rounded-lg mb-3 md:mb-4 border border-slate-700">
                                    <p className="text-white font-bold text-base md:text-lg">{subModal.owner.name}</p>
                                    <p className="text-slate-400 text-xs md:text-sm break-all">{subModal.owner.email}</p>
                                    {(() => {
                                        const st = getOwnerSubStatus(subModal.owner);
                                        return st.status === 'active' ? (
                                            <p className="text-green-400 text-xs mt-2 font-bold">
                                                Status: Aktif - {st.remainingDays} hari tersisa 
                                                <span className="hidden md:inline"> (s/d {st.expiresAt?.toLocaleDateString('id-ID', {day:'numeric',month:'long',year:'numeric'})})</span>
                                            </p>
                                        ) : st.status === 'expired' ? (
                                            <p className="text-red-400 text-xs mt-2 font-bold">Status: Kedaluwarsa sejak {st.expiresAt?.toLocaleDateString('id-ID')}</p>
                                        ) : (
                                            <p className="text-yellow-400 text-xs mt-2 font-bold">Status: Belum pernah diaktifkan</p>
                                        );
                                    })()}
                                    {subModal.owner.adminMessage && (
                                        <div className="mt-2 p-2 bg-blue-900/30 border border-blue-500/30 rounded">
                                            <p className="text-blue-300 text-xs font-bold flex items-center gap-1"><MessageCircle className="w-3 h-3"/> Pesan Admin:</p>
                                            <p className="text-blue-200 text-xs mt-1">{subModal.owner.adminMessage}</p>
                                            {subModal.owner.adminMessageAt && subModal.owner.adminMessageAt.seconds && (
                                                <p className="text-blue-400 text-[10px] mt-1 opacity-70">
                                                    {new Date(subModal.owner.adminMessageAt.seconds * 1000).toLocaleString('id-ID')}
                                                </p>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <form onSubmit={(e) => { e.preventDefault(); const fd = new FormData(e.target); activateSubscription(subModal.owner, parseInt(fd.get('price')), parseInt(fd.get('duration')), fd.get('adminMessage')); }} className="space-y-3 md:space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[10px] md:text-xs text-slate-400 font-bold uppercase mb-1 block">Harga (Rp)</label>
                                            <input name="price" type="number" defaultValue={(() => {
                                                const plan = subModal.owner?.plan || 'basic';
                                                const hasSub = subModal.owner?.subscription?.status === 'active';
                                                if (plan === 'pro') return hasSub ? (subConfig.proRenewal || 1920000) : (subConfig.proFirstYear || 2400000);
                                                return hasSub ? (subConfig.basicRenewal || 960000) : (subConfig.basicFirstYear || 1200000);
                                            })()} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 md:p-3 text-white focus:border-green-500 outline-none font-bold text-sm md:text-base" required/>
                                        </div>
                                        <div>
                                            <label className="text-[10px] md:text-xs text-slate-400 font-bold uppercase mb-1 block">Durasi (Hari)</label>
                                            <input name="duration" type="number" defaultValue={subConfig.duration} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 md:p-3 text-white focus:border-green-500 outline-none font-bold text-sm md:text-base" required min="1"/>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] md:text-xs text-slate-400 font-bold uppercase mb-1 flex items-center gap-2">
                                            <MessageCircle className="w-3 h-3"/> Pesan untuk Owner (Opsional)
                                        </label>
                                        <textarea 
                                            name="adminMessage" 
                                            rows="3" 
                                            defaultValue={subModal.owner.adminMessage || ''}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 md:p-3 text-white focus:border-green-500 outline-none text-xs md:text-sm" 
                                            placeholder="Ketik pesan untuk owner di sini..."
                                        ></textarea>
                                        <p className="text-[10px] md:text-xs text-slate-500 mt-1">üí° Pesan tampil di layar owner</p>
                                    </div>
                                    {subModal.owner.subscription?.history?.length > 0 && (
                                        <div>
                                            <label className="text-[10px] md:text-xs text-slate-400 font-bold uppercase mb-2 block">Riwayat Pembayaran</label>
                                            <div className="space-y-2 max-h-32 overflow-y-auto">
                                                {subModal.owner.subscription.history.slice().reverse().map((h, idx) => (
                                                    <div key={idx} className="bg-slate-900/80 p-2 rounded border border-slate-700 text-[10px] md:text-xs flex justify-between gap-2">
                                                        <span className="text-slate-300 truncate">{new Date(h.activatedAt).toLocaleDateString('id-ID')}</span>
                                                        <span className="text-green-400 font-bold whitespace-nowrap">Rp {(h.amount || 0).toLocaleString('id-ID')}</span>
                                                        <span className="text-slate-500 whitespace-nowrap">{h.duration} hari</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    <div className="flex gap-2 md:gap-3 mt-4 md:mt-6">
                                        <button type="button" onClick={() => setSubModal(null)} className="flex-1 py-2 md:py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700 text-sm md:text-base">Batal</button>
                                        <button disabled={loading} className="flex-1 py-2 md:py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2 text-sm md:text-base">
                                            {loading && <Loader2 className="w-4 h-4 animate-spin"/>} 
                                            <span className="hidden sm:inline">Aktifkan Sekarang</span>
                                            <span className="sm:hidden">Aktifkan</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Send Message to Owner Modal */}
                    {subModal?.type === 'message' && subModal.owner && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-xl text-white flex items-center gap-2"><MessageCircle className="w-5 h-5 text-purple-400"/> Kirim Pesan ke Owner</h3>
                                    <button onClick={() => setSubModal(null)} className="text-slate-400 hover:text-white p-1"><X className="w-5 h-5"/></button>
                                </div>
                                <div className="bg-slate-900 p-4 rounded-lg mb-4 border border-slate-700">
                                    <p className="text-white font-bold text-lg">{subModal.owner.name}</p>
                                    <p className="text-slate-400 text-sm">{subModal.owner.email}</p>
                                </div>
                                <form onSubmit={async (e) => { 
                                    e.preventDefault(); 
                                    const fd = new FormData(e.target);
                                    const message = fd.get('adminMessage');
                                    if (!message || !message.trim()) {
                                        alert('Pesan tidak boleh kosong!');
                                        return;
                                    }
                                    setLoading(true);
                                    try {
                                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', subModal.owner.id), {
                                            adminMessage: message.trim(),
                                            adminMessageAt: serverTimestamp()
                                        });
                                        alert('‚úÖ Pesan berhasil terkirim ke ' + subModal.owner.name);
                                        setSubModal(null);
                                    } catch (err) {
                                        alert('Gagal mengirim pesan: ' + err.message);
                                    } finally {
                                        setLoading(false);
                                    }
                                }} className="space-y-4">
                                    {subModal.owner.adminMessage && (
                                        <div className="bg-blue-900/30 border border-blue-500/30 rounded-lg p-3">
                                            <p className="text-blue-300 text-xs font-bold mb-2">Pesan Saat Ini:</p>
                                            <p className="text-blue-200 text-sm">{subModal.owner.adminMessage}</p>
                                            {subModal.owner.adminMessageAt && subModal.owner.adminMessageAt.seconds && (
                                                <p className="text-blue-400 text-[10px] mt-1 opacity-70">
                                                    {new Date(subModal.owner.adminMessageAt.seconds * 1000).toLocaleString('id-ID', { 
                                                        dateStyle: 'medium', 
                                                        timeStyle: 'short' 
                                                    })}
                                                </p>
                                            )}
                                        </div>
                                    )}
                                    <div>
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-1 block">Pesan Baru</label>
                                        <textarea 
                                            name="adminMessage" 
                                            rows="5" 
                                            defaultValue={subModal.owner.adminMessage || ''}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-purple-500 outline-none text-sm" 
                                            placeholder="Ketik pesan untuk owner di sini... Pesan akan tampil di layar mereka termasuk saat aplikasi terkunci."
                                            required
                                        ></textarea>
                                        <p className="text-xs text-slate-500 mt-1">üí° Pesan ini akan tampil di layar owner, termasuk saat aplikasi nonaktif/terkunci</p>
                                    </div>
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setSubModal(null)} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700">Batal</button>
                                        <button disabled={loading} className="flex-1 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 flex items-center justify-center gap-2">
                                            {loading && <Loader2 className="w-4 h-4 animate-spin"/>} Kirim Pesan
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                 </div> );
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üìç ABSENSI GPS WIDGET ‚Äî tampil di Dashboard untuk non-owner
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const AbsensiWidget = () => {
            const { user, activeOwner, activeStore } = useContext(SessionContext);
            const [gpsStatus, setGpsStatus] = useState('idle'); // idle | locating | success | error
            const [msg, setMsg]           = useState('');
            const [todayRecord, setTodayRecord] = useState(null);
            const [loadingRecord, setLoadingRecord] = useState(true);

            const today = new Date().toISOString().split('T')[0];

            // GPS toko diambil langsung dari activeStore (sudah real-time via SessionContext)
            const storeGPS = activeStore ? {
                lat:    activeStore.gps_lat    || null,
                lon:    activeStore.gps_lon    || null,
                radius: activeStore.gps_radius || 200
            } : null;

            // Load absensi hari ini untuk user yang sedang login
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id || !user?.id) { setLoadingRecord(false); return; }
                setLoadingRecord(true);
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'attendance'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id),
                    where('userId', '==', user.id),
                    where('date', '==', today)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setTodayRecord(snap.empty ? null : { id: snap.docs[0].id, ...snap.docs[0].data() });
                    setLoadingRecord(false);
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id, user?.id, today]);

            // Rumus jarak Haversine (meter)
            const haversine = (lat1, lon1, lat2, lon2) => {
                const R = 6371000;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            };

            // Anti-fake GPS: 2 pembacaan berturutan
            const getVerifiedPosition = () => new Promise((resolve, reject) => {
                if (!navigator.geolocation) { reject(new Error('Browser tidak mendukung GPS.')); return; }
                const opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 };
                navigator.geolocation.getCurrentPosition(pos1 => {
                    // Reject jika akurasi buruk (>150m)
                    if (pos1.coords.accuracy > 150) {
                        reject(new Error(`Sinyal GPS terlalu lemah (akurasi ${Math.round(pos1.coords.accuracy)}m). Pindah ke area terbuka atau nyalakan GPS.`));
                        return;
                    }
                    // Ambil pembacaan ke-2 setelah 2 detik
                    setTimeout(() => {
                        navigator.geolocation.getCurrentPosition(pos2 => {
                            const diff = haversine(pos1.coords.latitude, pos1.coords.longitude, pos2.coords.latitude, pos2.coords.longitude);
                            // Fake GPS biasanya memberikan koordinat identik sempurna dengan akurasi 0
                            if (diff < 0.001 && pos1.coords.accuracy < 2 && pos2.coords.accuracy === pos1.coords.accuracy) {
                                reject(new Error('GPS palsu terdeteksi. Nonaktifkan aplikasi mock/fake GPS dan coba lagi.'));
                                return;
                            }
                            resolve({
                                latitude:  (pos1.coords.latitude  + pos2.coords.latitude)  / 2,
                                longitude: (pos1.coords.longitude + pos2.coords.longitude) / 2,
                                accuracy:  Math.max(pos1.coords.accuracy, pos2.coords.accuracy),
                            });
                        }, reject, opts);
                    }, 2000);
                }, reject, opts);
            });

            const handleAbsen = async (type) => {
                if (gpsStatus === 'locating') return;
                if (!storeGPS?.lat || !storeGPS?.lon) {
                    setMsg('‚ùå Lokasi GPS toko belum diatur. Hubungi owner untuk mengatur koordinat toko di menu Pengaturan.');
                    setGpsStatus('error'); return;
                }
                setGpsStatus('locating');
                setMsg('üì° Mendeteksi lokasi GPS kamu (ambil 2 titik untuk validasi)...');
                try {
                    const pos  = await getVerifiedPosition();
                    const dist = haversine(storeGPS.lat, storeGPS.lon, pos.latitude, pos.longitude);
                    const distText = dist < 1000 ? `${Math.round(dist)} m` : `${(dist/1000).toFixed(2)} km`;

                    if (dist > storeGPS.radius) {
                        setGpsStatus('error');
                        setMsg(`‚ùå Kamu berada ${distText} dari toko (batas: ${storeGPS.radius} m). Absen hanya bisa dilakukan di dalam area toko.`);
                        return;
                    }

                    const now = new Date();
                    if (type === 'in') {
                        if (todayRecord) { setGpsStatus('error'); setMsg('‚ö†Ô∏è Kamu sudah Check-In hari ini!'); return; }
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'attendance'), {
                            ownerId:  activeOwner.id,
                            storeId:  activeStore.id,
                            userId:   user.id,
                            userName: user.name || user.email,
                            date:     today,
                            checkIn:  serverTimestamp(),
                            checkOut: null,
                            workHours: 0,
                            gps_checkin_lat:      pos.latitude,
                            gps_checkin_lon:      pos.longitude,
                            gps_checkin_accuracy: Math.round(pos.accuracy),
                            gps_checkin_dist_m:   Math.round(dist),
                            createdAt: serverTimestamp()
                        });
                        setGpsStatus('success');
                        setMsg(`‚úÖ Check-In berhasil! Jarak dari toko: ${distText}, Akurasi GPS: ${Math.round(pos.accuracy)}m`);
                    } else {
                        if (!todayRecord)          { setGpsStatus('error'); setMsg('‚ö†Ô∏è Kamu belum Check-In hari ini!'); return; }
                        if (todayRecord.checkOut)  { setGpsStatus('error'); setMsg('‚ö†Ô∏è Kamu sudah Check-Out hari ini!'); return; }
                        const checkInTime = todayRecord.checkIn?.seconds ? new Date(todayRecord.checkIn.seconds * 1000) : now;
                        const workHours   = parseFloat(((now - checkInTime) / 3600000).toFixed(2));
                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'attendance', todayRecord.id), {
                            checkOut:  serverTimestamp(),
                            workHours,
                            gps_checkout_lat:      pos.latitude,
                            gps_checkout_lon:      pos.longitude,
                            gps_checkout_accuracy: Math.round(pos.accuracy),
                            gps_checkout_dist_m:   Math.round(dist),
                        });
                        setGpsStatus('success');
                        setMsg(`‚úÖ Check-Out berhasil! Jam kerja: ${workHours} jam. Jarak dari toko: ${distText}`);
                    }
                } catch (err) {
                    setGpsStatus('error');
                    const code = err.code;
                    if (code === 1) setMsg('‚ùå Izin lokasi ditolak. Aktifkan GPS di pengaturan browser/HP kamu.');
                    else if (code === 2) setMsg('‚ùå GPS tidak tersedia. Nyalakan GPS dan coba lagi.');
                    else if (code === 3) setMsg('‚ùå Timeout GPS. Pindah ke area terbuka dengan sinyal lebih baik.');
                    else setMsg('‚ùå ' + (err.message || 'Gagal mendapatkan lokasi.'));
                }
            };

            // Jangan tampil untuk owner/developer ‚Äî cek ini DULU sebelum kondisi lain
            if (user?.role === 'owner' || user?.role === 'developer') return null;

            // Tampilkan loading spinner sementara absensi loading
            if (loadingRecord) return (
                <div className="rounded-2xl border border-blue-100 bg-blue-50 p-4 mb-2 flex items-center gap-3 text-sm text-blue-700">
                    <Loader2 className="w-4 h-4 animate-spin flex-shrink-0"/>
                    <span>Memuat data absensi...</span>
                </div>
            );

            // Jika tidak ada activeStore (belum pilih toko)
            if (!activeStore?.id) return (
                <div className="rounded-2xl border border-amber-200 bg-amber-50 p-4 mb-2 text-sm text-amber-800 flex items-center gap-2">
                    <MapPin className="w-4 h-4 flex-shrink-0"/>
                    <span>Pilih toko terlebih dahulu untuk bisa melakukan absensi.</span>
                </div>
            );

            const checkedIn  = todayRecord && !todayRecord.checkOut;
            const checkedOut = !!todayRecord?.checkOut;
            const fmtTime = (ts) => ts?.seconds ? new Date(ts.seconds * 1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : null;
            const checkInTime  = fmtTime(todayRecord?.checkIn);
            const checkOutTime = fmtTime(todayRecord?.checkOut);

            return (
                <div className={`rounded-2xl border p-4 mb-2 ${checkedOut ? 'bg-slate-50 border-slate-200' : checkedIn ? 'bg-emerald-50 border-emerald-200' : 'bg-blue-50 border-blue-200'}`}>
                    <div className="flex items-center justify-between mb-3">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2 text-sm">
                            <MapPin className="w-4 h-4 text-blue-600"/>
                            Absensi GPS &mdash; Hari Ini
                        </h3>
                        <span className="text-xs text-slate-500">{new Date().toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long'})}</span>
                    </div>

                    {/* Baris status waktu */}
                    <div className="flex items-center gap-4 mb-3">
                        <div className={`flex items-center gap-1.5 text-sm ${checkInTime ? 'text-emerald-700 font-bold' : 'text-slate-400'}`}>
                            <LogIn className="w-4 h-4"/>
                            <span>{checkInTime || '--:--'}</span>
                            <span className="text-xs font-normal">Masuk</span>
                        </div>
                        <div className="flex-1 h-0.5 bg-slate-200 rounded"/>
                        <div className={`flex items-center gap-1.5 text-sm ${checkOutTime ? 'text-orange-600 font-bold' : 'text-slate-400'}`}>
                            <LogOut className="w-4 h-4"/>
                            <span>{checkOutTime || '--:--'}</span>
                            <span className="text-xs font-normal">Keluar</span>
                        </div>
                        {checkedOut && todayRecord.workHours > 0 && (
                            <span className="text-xs font-bold text-blue-700 bg-blue-100 px-2 py-1 rounded-lg whitespace-nowrap">‚è± {todayRecord.workHours} jam</span>
                        )}
                    </div>

                    {/* Tombol aksi */}
                    {!checkedOut && (
                        <button
                            onClick={() => handleAbsen(checkedIn ? 'out' : 'in')}
                            disabled={gpsStatus === 'locating'}
                            className={`w-full py-2.5 rounded-xl font-bold text-sm text-white flex items-center justify-center gap-2 transition-all active:scale-95 disabled:opacity-60
                                ${checkedIn ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-200' : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'} shadow-lg`}
                        >
                            {gpsStatus === 'locating'
                                ? <><Loader2 className="w-4 h-4 animate-spin"/> Mendeteksi GPS...</>
                                : checkedIn
                                    ? <><LogOut className="w-4 h-4"/> Check Out</>
                                    : <><LogIn className="w-4 h-4"/> Check In</>
                            }
                        </button>
                    )}

                    {/* Feedback pesan */}
                    {msg && (
                        <div className={`mt-2 text-xs rounded-lg px-3 py-2 font-medium leading-relaxed
                            ${gpsStatus === 'success' ? 'bg-emerald-100 text-emerald-800' : gpsStatus === 'error' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                            {msg}
                        </div>
                    )}

                    {!storeGPS?.lat && gpsStatus !== 'locating' && gpsStatus !== 'error' && (
                        <p className="text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 mt-2">
                            ‚ö†Ô∏è Koordinat GPS toko belum diatur oleh Owner. Hubungi owner untuk mengisi data di menu Pengaturan ‚Üí Lokasi GPS Absensi.
                        </p>
                    )}
                </div>
            );
        };

        const Dashboard = ({setView}) => {
          const { user, activeOwner, activeStore, checkPermission } = useContext(SessionContext);
          
          useRealtimePlanSync(activeOwner);
          const { data: services, fromCache: servicesFromCache } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
          const { data: transactions, fromCache: transactionsFromCache } = useFirestoreCollection('transactions', activeOwner?.id, activeStore?.id);
          const { data: sales, fromCache: salesFromCache } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
          const { data: users } = useFirestoreCollection('users', activeOwner?.id, activeStore?.id);
          const { data: inventory = [] } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
          const [filter, setFilter] = useState('today');
          const [customDateRange, setCustomDateRange] = useState({start: '', end: ''});
          const [detailModal, setDetailModal] = useState(null);
          const [technicianModal, setTechnicianModal] = useState(null);
          const [inventorySettings, setInventorySettings] = useState({});
          
          // Aggregation data for accurate totals (not affected by limit)
          const [inventoryAggregation, setInventoryAggregation] = useState({
              totalItems: 0,
              totalStock: 0,
              totalStockValue: 0,
              loading: true
          });

          // Fetch aggregation data from Firestore
          useEffect(() => {
              if (!activeOwner?.id) return;
              
              const fetchAggregation = async () => {
                  try {
                      const inventoryRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory');
                      let q;
                      
                      if (activeStore?.id) {
                          q = query(inventoryRef, 
                              where('ownerId', '==', activeOwner.id),
                              where('storeId', '==', activeStore.id)
                          );
                      } else {
                          q = query(inventoryRef, where('ownerId', '==', activeOwner.id));
                      }
                      
                      const aggregateSnapshot = await getAggregateFromServer(q, {
                          totalItems: count(),
                          totalStock: sum('stock')
                      });
                      
                      // Also fetch all items to calculate totalStockValue (sellPrice * stock)
                      const allItemsSnap = await getDocs(q);
                      const allItems = allItemsSnap.docs.map(d => d.data());
                      const stockValue = allItems.reduce((s, item) => s + ((item.sellPrice || 0) * (item.stock || 0)), 0);
                      
                      setInventoryAggregation({
                          totalItems: aggregateSnapshot.data().totalItems,
                          totalStock: aggregateSnapshot.data().totalStock || 0,
                          totalStockValue: stockValue,
                          loading: false
                      });
                  } catch (error) {
                      console.error('Error fetching aggregation:', error);
                      // Fallback to client-side calculation if aggregation fails
                      setInventoryAggregation({
                          totalItems: inventory.length,
                          totalStock: inventory.reduce((a, b) => a + (b.stock || 0), 0),
                          totalStockValue: inventory.reduce((s, item) => s + ((item.sellPrice || 0) * (item.stock || 0)), 0),
                          loading: false
                      });
                  }
              };
              
              fetchAggregation();
          }, [activeOwner?.id, activeStore?.id]);
          
          // Load inventory settings with debounce
          useEffect(() => {
              if (!activeOwner?.id) return;
              let unsubscribeRef = null;
              let timeoutRef = null;
              
              let q;
              if (activeStore?.id && activeStore.id !== 'all') {
                  q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
              } else {
                  q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', activeOwner.id));
              }
              
              unsubscribeRef = onSnapshot(q, (snapshot) => {
                  // Debounce settings update
                  if (timeoutRef) clearTimeout(timeoutRef);
                  timeoutRef = setTimeout(() => {
                      let settings = { minStockThreshold: 0 }; // default
                      snapshot.docs.forEach(doc => {
                          const data = doc.data();
                          if (data.inventorySettings) {
                              settings = { ...settings, ...data.inventorySettings };
                          }
                      });
                      setInventorySettings(settings);
                  }, 100); // 100ms debounce
              }, (error) => {
                  console.error('Error loading inventory settings:', error);
                  setInventorySettings({ minStockThreshold: 0 }); // fallback
              });
              
              return () => {
                  if (timeoutRef) clearTimeout(timeoutRef);
                  if (unsubscribeRef) {
                      unsubscribeRef();
                  }
              };
          }, [activeOwner?.id, activeStore?.id]);
          
          const getFilteredData = (items, isTransaction = false) => {
              if (filter === 'custom' && customDateRange.start && customDateRange.end) {
                  const startDate = new Date(customDateRange.start);
                  const endDate = new Date(customDateRange.end);
                  endDate.setHours(23, 59, 59, 999);
                  return items.filter(i => {
                      // Untuk transactions, prioritaskan field 'date'
                      const d = isTransaction ? 
                          (i.date?.seconds ? new Date(i.date.seconds * 1000) : (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : null)) :
                          (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : (i.date?.seconds ? new Date(i.date.seconds * 1000) : null));
                      if(!d) return false;
                      return d >= startDate && d <= endDate;
                  });
              }
              if (filter === 'all') return items;
              const now = new Date();
              return items.filter(i => {
                  // Untuk transactions, prioritaskan field 'date'
                  const d = isTransaction ? 
                      (i.date?.seconds ? new Date(i.date.seconds * 1000) : (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : null)) :
                      (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : (i.date?.seconds ? new Date(i.date.seconds * 1000) : null));
                  if(!d) return false;
                  if (filter === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                  if (filter === 'today') return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                  if (filter === 'year') return d.getFullYear() === now.getFullYear();
                  return true;
              });
          };

          const filteredServices = getFilteredData(services, false);
          const filteredTrans = getFilteredData(transactions, true);
          const filteredSales = getFilteredData(sales || [], false);

          const assignTechnician = async (serviceId, technicianName) => {
              if (!technicianName?.trim()) {
                  alert('Nama tekhnisi tidak boleh kosong');
                  return;
              }
              try {
                  const serviceDoc = filteredServices.find(s => s.id === serviceId);
                  const currentTechs = serviceDoc?.technicians || [];
                  
                  // Check if already assigned
                  if (currentTechs.includes(technicianName.trim())) {
                      alert('Tekhnisi ini sudah ditugaskan');
                      return;
                  }
                  
                  await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId), {
                      technicians: [...currentTechs, technicianName.trim()]
                  });
                  setTechnicianModal(null);
                  alert('Tekhnisi berhasil ditambahkan');
              } catch (err) {
                  alert('Gagal tambah tekhnisi: ' + err.message);
              }
          };

          const queueCount = filteredServices.filter(s => ['Diterima', 'Diagnosa'].includes(s.status)).length;
          const activeCount = filteredServices.filter(s => ['Dikerjakan', 'Menunggu Sparepart'].includes(s.status)).length;
          const readyCount = filteredServices.filter(s => s.status === 'Selesai').length;
          const completedServices = filteredServices.filter(s => s.status === 'Selesai');
          const sales_total = filteredSales.reduce((a, b) => a + (parseFloat(b.total) || 0), 0);
          const income_trans = filteredTrans.filter(t => t.type === 'income');
          const service_income = income_trans.reduce((a,b)=>a+b.amount,0);
          const expense_trans = filteredTrans.filter(t => t.type === 'expense');
          const expense = expense_trans.reduce((a,b)=>a+b.amount,0);
          const profit_trans = filteredTrans.filter(t => t.type === 'profit').reduce((a,b)=>a+b.amount,0);
          const profit_jasa = filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).reduce((a,b)=>a+b.amount,0);
          const profit_penjualan = profit_trans - profit_jasa;
          const loss_trans = filteredTrans.filter(t => t.type === 'loss').reduce((a,b)=>a+b.amount,0);
          const kerugian = loss_trans;
          const netProfit = service_income - expense;
          const totalProfit = netProfit + profit_trans - loss_trans;
          const service_income_only = filteredTrans.filter(t => t.type === 'income' && t.category?.includes('Servis')).reduce((a,b)=>a+b.amount,0);
          
          // Kompensasi Retur
          const kompensasi_retur_penjualan = filteredTrans.filter(t => t.type === 'income' && t.category === 'Kompensasi Retur Penjualan').reduce((a,b)=>a+b.amount,0);
          const kompensasi_retur_pembelian = filteredTrans.filter(t => t.type === 'expense' && t.category === 'Kompensasi Retur Pembelian').reduce((a,b)=>a+b.amount,0);

          const keuntungan = profit_jasa + profit_penjualan - kompensasi_retur_penjualan - kompensasi_retur_pembelian;
          
          // Calculate urgent stock and inventory metrics
          const minThreshold = inventorySettings.minStockThreshold ?? 0;
          const urgentStock = inventory.filter(i => (i.stock || 0) <= minThreshold && (i.stock || 0) > 0);
          const outOfStock = inventory.filter(i => (i.stock || 0) === 0);
          const totalStockValue = inventory.reduce((sum, item) => sum + ((item.sellPrice || 0) * (item.stock || 0)), 0);
          
          const statusCounts = filteredServices.reduce((acc, curr) => { acc[curr.status] = (acc[curr.status] || 0) + 1; return acc; }, {});
          const pieData = Object.keys(statusCounts).map(key => ({ name: key, value: statusCounts[key] }));
          const flowData = [{name:'Servis', val:service_income_only}, {name:'Penjualan', val:sales_total}, {name:'Pengeluaran', val:expense}];
          
          const StatCard = ({ title, value, icon: Icon, color, sub, clickable, onClick }) => ( 
            <button onClick={onClick} disabled={!clickable} className={`bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group transition-all duration-300 text-left ${clickable ? 'hover:shadow-md hover:border-blue-200 cursor-pointer' : ''}`}> 
              <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity ${color}`}><Icon className="w-24 h-24" /></div> 
              <div className="relative z-10">
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center mb-2 ${color} text-white shadow-lg shadow-blue-500/20`}><Icon className="w-5 h-5"/></div>
                <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">{title}</p>
                <h3 className="font-bold text-slate-800 line-clamp-2 break-words max-w-full" style={{fontSize: '0.875rem', lineHeight: '1.25'}}>{value}</h3>
                {sub && <p className="text-xs text-slate-400 mt-1">{sub}</p>}
              </div> 
            </button> 
          );
          
          // Permission check (after hooks to comply with React Rules of Hooks)
          if (!checkPermission('menu_dashboard')) {
              return (
                  <div className="p-10 text-center">
                      <div className="bg-red-50 border border-red-200 rounded-lg p-6 inline-block">
                          <Lock className="w-10 h-10 text-red-600 mx-auto mb-3"/>
                          <h2 className="text-lg font-bold text-red-600 mb-2">‚ùå Akses Ditolak</h2>
                          <p className="text-slate-600">Menu Dashboard telah dikunci oleh Developer/Owner. Hubungi mereka untuk mendapatkan akses.</p>
                      </div>
                  </div>
              );
          }

          return ( 
            <div className="space-y-6"> 
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                        <button onClick={() => { sessionStorage.setItem('autoOpenServiceForm', 'true'); setView('service'); }} className="bg-blue-600 text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-600/20 hover:bg-blue-700 hover:scale-105 transition-all whitespace-nowrap"><Plus className="w-5 h-5"/> Servis Baru</button>
                        <button onClick={() => setView('sales')} className="bg-white text-slate-600 border border-slate-200 px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-slate-50 transition-colors whitespace-nowrap"><Store className="w-5 h-5"/> Penjualan</button>
                        {/* Cache Indicator Badge */}
                        {(servicesFromCache || transactionsFromCache || salesFromCache) && (
                            <div className="flex items-center gap-2 px-4 py-2 bg-green-50 border border-green-200 rounded-xl text-xs">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span className="font-bold text-green-700">üì± Offline Mode - Hemat Quota</span>
                            </div>
                        )}
                    </div> 
                    <div className="flex flex-col gap-3 w-full md:w-auto">
                        <div className="bg-white border border-slate-200 rounded-lg p-1 flex flex-wrap gap-1">
                            {[{id:'today',l:'Hari Ini'},{id:'month',l:'Bulan Ini'},{id:'year',l:'Tahun Ini'},{id:'all',l:'Semua'},{id:'custom',l:'Custom'}].map(f => (
                                <button key={f.id} onClick={()=>{setFilter(f.id); if(f.id!=='custom') setCustomDateRange({start:'',end:''})}} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${filter === f.id ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-100'}`}>{f.l}</button>
                            ))}
                        </div>
                        {filter === 'custom' && (
                            <div className="flex gap-2 bg-white border border-slate-200 rounded-lg p-2">
                                <input type="date" value={customDateRange.start} onChange={(e)=>setCustomDateRange({...customDateRange, start:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Dari"/>
                                <span className="text-slate-400">-</span>
                                <input type="date" value={customDateRange.end} onChange={(e)=>setCustomDateRange({...customDateRange, end:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Ke"/>
                            </div>
                        )}
                    </div>
                </div>

                {/* üìç Widget Absensi GPS ‚Äî hanya untuk non-owner */}
                <AbsensiWidget/>

                {/* Baris 1: Servis & Jasa */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                  <StatCard title="Antrian" value={queueCount} icon={RotateCw} color="bg-orange-500" sub="Menunggu proses" clickable={queueCount > 0} onClick={() => queueCount > 0 && setDetailModal({type:'queue', title:'Antrian'})} />
                  <StatCard title="Servis Aktif" value={activeCount} icon={Activity} color="bg-blue-500" sub="Sedang dikerjakan" clickable={activeCount > 0} onClick={() => activeCount > 0 && setDetailModal({type:'active_service', title:'Servis Aktif'})} />
                  {checkPermission('dash_servis_selesai') && <StatCard title="Status Selesai" value={readyCount} icon={CheckCircle} color="bg-emerald-500" sub="Servis Selesai" clickable={readyCount > 0} onClick={() => readyCount > 0 && setDetailModal({type:'ready_service', title:'Status Selesai'})} />}
                  {checkPermission('dash_untung_jasa') && <StatCard title="Untung Jasa" value={formatCurrency(profit_jasa)} icon={TrendingUp} color="bg-indigo-500" sub="Profit Servis" clickable={profit_jasa > 0} onClick={() => profit_jasa > 0 && setDetailModal({type:'profit', subType:'jasa', title:'Keuntungan Jasa'})} />}
                </div>

                {/* Baris 2: Keuangan & Kompensasi */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                  {checkPermission('dash_pemasukan') && <StatCard title="Pemasukan" value={formatCurrency(service_income)} icon={TrendingUp} color="bg-green-500" sub="Total Penjualan" clickable={income_trans.length > 0} onClick={() => income_trans.length > 0 && setDetailModal({type:'income', title:'Pemasukan'})} />}
                  {checkPermission('dash_pengeluaran') && <StatCard title="Pengeluaran" value={formatCurrency(expense)} icon={ArrowDownRight} color="bg-red-500" sub="Total Modal" clickable={expense_trans.length > 0} onClick={() => expense_trans.length > 0 && setDetailModal({type:'expense', title:'Pengeluaran'})} />}
                  {checkPermission('dash_untung_jual') && <StatCard title="Untung Jual" value={formatCurrency(profit_penjualan)} icon={TrendingUp} color="bg-cyan-500" sub="Profit Penjualan" clickable={profit_penjualan > 0} onClick={() => profit_penjualan > 0 && setDetailModal({type:'profit', subType:'penjualan', title:'Keuntungan Penjualan'})} />}
                  {checkPermission('dash_komp_retur') && <StatCard title="Komp. Retur Jual" value={formatCurrency(kompensasi_retur_penjualan)} icon={RotateCcw} color="bg-teal-500" sub="Fee dari Customer" clickable={kompensasi_retur_penjualan > 0} onClick={() => kompensasi_retur_penjualan > 0 && setDetailModal({type:'kompensasi_retur_penjualan', title:'Kompensasi Retur Penjualan'})} />}
                </div>

                {/* Baris 3: Kompensasi Retur Pembelian + Total Keuntungan */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                  {checkPermission('dash_komp_retur') && <StatCard title="Komp. Retur Beli" value={formatCurrency(kompensasi_retur_pembelian)} icon={RotateCw} color="bg-rose-500" sub="Fee ke Supplier" clickable={kompensasi_retur_pembelian > 0} onClick={() => kompensasi_retur_pembelian > 0 && setDetailModal({type:'kompensasi_retur_pembelian', title:'Kompensasi Retur Pembelian'})} />}
                  {checkPermission('dash_nilai_stok') && <StatCard title="Nilai Stok" value={formatCurrency(inventoryAggregation.totalStockValue || totalStockValue)} icon={Box} color="bg-indigo-500" sub={inventoryAggregation.loading ? 'Loading...' : `${inventoryAggregation.totalItems} items`} clickable={true} onClick={() => setDetailModal({type:'stock_value', title:'Nilai Total Stok'})} />}
                  {checkPermission('dash_total_keuntungan') && <div className={`col-span-2 p-5 rounded-2xl shadow-sm border relative overflow-hidden transition-all duration-300 text-left ${keuntungan >= 0 ? 'bg-blue-50 border-blue-200' : 'bg-amber-50 border-amber-200'}`}>
                    <p className={`text-xs font-bold uppercase tracking-wider mb-1 ${keuntungan >= 0 ? 'text-blue-400' : 'text-amber-400'}`}>Total Keuntungan</p>
                    <h3 className={`font-bold text-2xl ${keuntungan >= 0 ? 'text-blue-600' : 'text-amber-600'}`}>{formatCurrency(keuntungan)}</h3>
                  </div>}
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6"> 
                  <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-80">
                    <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2"><Wallet className="w-4 h-4 text-slate-400"/> Arus Kas</h3>
                    <ResponsiveContainer width="100%" height="85%">
                      <AreaChart data={flowData}>
                        <defs><linearGradient id="colorInc" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.8}/><stop offset="95%" stopColor="#8b5cf6" stopOpacity={0}/></linearGradient></defs>
                        <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill:'#94a3b8', fontSize:12}} />
                        <YAxis axisLine={false} tickLine={false} tick={{fill:'#94a3b8', fontSize:12}} />
                        <CartesianGrid vertical={false} stroke="#f1f5f9" />
                        <Tooltip contentStyle={{borderRadius:'12px', border:'none', boxShadow:'0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                        <Area type="monotone" dataKey="val" stroke="#8b5cf6" fillOpacity={1} fill="url(#colorInc)" />
                      </AreaChart>
                    </ResponsiveContainer>
                  </div> 
                  <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-80 flex flex-col">
                    <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Smartphone className="w-4 h-4 text-slate-400"/> Status Servis</h3>
                    <div className="flex-1 w-full flex items-center justify-center">
                      {pieData.length > 0 ? (
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={pieData} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5}>
                              {pieData.map((entry, index) => (<Cell key={`cell-${index}`} fill={['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'][index % 6]} />))}
                            </Pie>
                            <Tooltip />
                          </PieChart>
                        </ResponsiveContainer>
                      ) : (
                        <p className="text-slate-400 text-sm text-center">Tidak ada data servis</p>
                      )}
                    </div>
                  </div> 
                </div>
                
                {/* Urgent Stock Warning */}
                {urgentStock.length > 0 && (
                <div className="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-lg mb-6">
                    <div className="flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 text-amber-500 mt-0.5" />
                        <div className="flex-1">
                            <h4 className="font-bold text-amber-800 mb-2">‚ö†Ô∏è Stok Menipis ({urgentStock.length} item)</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-3">
                                {urgentStock.slice(0, 6).map(item => (
                                    <div key={item.id} className="bg-white p-2 rounded border border-amber-200 text-sm flex justify-between">
                                        <span className="font-medium text-slate-700">{item.name}</span>
                                        <span className="text-amber-700 font-bold">{item.stock} pcs</span>
                                    </div>
                                ))}
                            </div>
                            {urgentStock.length > 6 && (
                                <p className="text-xs text-amber-600">dan {urgentStock.length - 6} item lainnya...</p>
                            )}
                            <button 
                                onClick={() => setDetailModal({type:'urgent_stock', title:'Stok Menipis', data: urgentStock})}
                                className="mt-2 text-xs font-bold text-amber-700 hover:text-amber-900 hover:underline"
                            >
                                Lihat Semua ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
                )}
                
                {/* Out of Stock Alert */}
                {outOfStock.length > 0 && (
                <div className="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg mb-6">
                    <div className="flex items-start gap-3">
                        <X className="w-5 h-5 text-red-500 mt-0.5" />
                        <div className="flex-1">
                            <h4 className="font-bold text-red-800 mb-2">üî¥ Stok Habis ({outOfStock.length} item)</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-3">
                                {outOfStock.slice(0, 6).map(item => (
                                    <div key={item.id} className="bg-white p-2 rounded border border-red-200 text-sm">
                                        <span className="font-medium text-slate-700">{item.name}</span>
                                    </div>
                                ))}
                            </div>
                            {outOfStock.length > 6 && (
                                <p className="text-xs text-red-600">dan {outOfStock.length - 6} item lainnya...</p>
                            )}
                            <button 
                                onClick={() => setDetailModal({type:'out_of_stock', title:'Stok Habis', data: outOfStock})}
                                className="mt-2 text-xs font-bold text-red-700 hover:text-red-900 hover:underline"
                            >
                                Lihat Semua ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
                )}
                
                {/* Modal Detail */}
                {detailModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden shadow-2xl flex flex-col">
                            {/* Header */}
                            <div className="flex justify-between items-center border-b border-slate-200 p-6 bg-gradient-to-r from-slate-50 to-slate-100">
                                <div>
                                    <h3 className="font-bold text-2xl text-slate-800">{detailModal.title}</h3>
                                    <p className="text-xs text-slate-500 mt-1">
                                        {detailModal.type === 'queue' && '‚è±Ô∏è Daftar servis yang menunggu proses'}
                                        {detailModal.type === 'active_service' && 'üìã Daftar servis yang sedang dikerjakan'}
                                        {detailModal.type === 'ready_service' && '‚úÖ Daftar servis yang sudah selesai'}
                                        {detailModal.type === 'income' && 'üí∞ Semua transaksi pemasukan'}
                                        {detailModal.type === 'expense' && 'üí∏ Semua transaksi pengeluaran'}
                                        {detailModal.type === 'profit' && detailModal.subType === 'jasa' && 'üíµ Keuntungan dari jasa servis'}
                                        {detailModal.type === 'profit' && detailModal.subType === 'penjualan' && 'üõçÔ∏è Keuntungan dari penjualan sparepart'}
                                        {detailModal.type === 'kompensasi_retur_penjualan' && 'üí∞ Fee kompensasi dari pelanggan untuk retur penjualan'}
                                        {detailModal.type === 'kompensasi_retur_pembelian' && 'üí∏ Fee kompensasi ke supplier untuk retur pembelian'}
                                        {detailModal.type === 'urgent_stock' && '‚ö†Ô∏è Daftar item dengan stok menipis'}
                                        {detailModal.type === 'out_of_stock' && 'üî¥ Daftar item dengan stok habis'}
                                        {detailModal.type === 'stock_value' && 'üíé Detail nilai total stok inventory'}
                                    </p>
                                </div>
                                <button onClick={() => setDetailModal(null)} className="p-2 hover:bg-slate-200 rounded-lg transition-all"><X className="w-6 h-6 text-slate-600" /></button>
                            </div>

                            {/* Content */}
                            <div className="overflow-y-auto flex-1 p-6">
                                {detailModal.type === 'queue' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {filteredServices.filter(s => ['Diterima', 'Diagnosa'].includes(s.status)).length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            filteredServices.filter(s => ['Diterima', 'Diagnosa'].includes(s.status)).map(s => (
                                                <div key={s.id} className="bg-gradient-to-r from-orange-50 to-orange-100/50 p-4 rounded-xl border border-orange-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{s.customerName}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üì± {s.deviceModel || s.device || s.unitType}</p>
                                                        </div>
                                                        <span className={`text-xs font-bold px-3 py-1 rounded-full ${
                                                            s.status === 'Diterima' ? 'bg-amber-100 text-amber-700' :
                                                            'bg-orange-100 text-orange-700'
                                                        }`}>{s.status}</span>
                                                    </div>
                                                    <div className="bg-white/60 p-2 rounded mb-2">
                                                        {Array.isArray(s.complaintTags) && s.complaintTags.length > 0 ? (
                                                            <div className="flex flex-wrap gap-1">
                                                                {s.complaintTags.map((t,i) => <span key={i} className="text-xs bg-red-100 text-red-700 border border-red-200 px-2 py-0.5 rounded-full font-medium">{t}</span>)}
                                                            </div>
                                                        ) : (
                                                            <p className="text-sm text-slate-700">üîß {s.problem || s.complaint || '-'}</p>
                                                        )}
                                                    </div>
                                                    {s.unlockMethod && s.unlockMethod !== 'Tidak Ada' && (
                                                        <div className="flex items-center gap-2 mb-2 bg-yellow-50 border border-yellow-200 rounded px-2 py-1">
                                                            <Lock className="w-3 h-3 text-yellow-600 shrink-0"/>
                                                            <span className="text-xs font-bold text-yellow-700">{s.unlockMethod}{s.unlockCode ? ': ' + s.unlockCode : ''}</span>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Sparepart Info */}
                                                    {(s.usedParts && s.usedParts.length > 0) && (
                                                        <div className="mb-3 pb-3 border-b border-orange-200">
                                                            <p className="text-xs font-bold text-slate-600 uppercase mb-2">üì¶ Sparepart ({s.usedParts.length})</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.usedParts.map((part, idx) => (
                                                                    <div key={idx} className="bg-white border border-purple-200 rounded-lg px-3 py-1.5 text-xs">
                                                                        <span className="font-bold text-purple-700">{part.name}</span>
                                                                        <span className="text-slate-400 ml-1">x{part.qty}</span>
                                                                        <div className="text-[10px] text-slate-500 mt-0.5">{formatCurrency(part.sellPrice || 0)}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Technician section */}
                                                    <div className="mb-3 pb-3 border-b border-orange-200">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <p className="text-xs font-bold text-slate-600 uppercase">üë®‚Äçüîß Tekhnisi ({(s.technicians || []).length})</p>
                                                            <button 
                                                                onClick={() => setTechnicianModal({serviceId: s.id, customerName: s.customerName})}
                                                                className="text-orange-600 hover:text-orange-800 text-xs font-bold hover:bg-orange-50 px-2 py-1 rounded transition"
                                                            >
                                                                + Tambah
                                                            </button>
                                                        </div>
                                                        {(s.technicians || []).length > 0 ? (
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.technicians.map((tech, idx) => (
                                                                    <span key={idx} className="bg-orange-600 text-white text-xs px-2.5 py-1 rounded-full font-medium flex items-center gap-1">
                                                                        {tech}
                                                                        <button
                                                                            onClick={async () => {
                                                                                try {
                                                                                    const newTechs = s.technicians.filter((t, i) => i !== idx);
                                                                                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', s.id), {
                                                                                        technicians: newTechs
                                                                                    });
                                                                                } catch (err) {
                                                                                    alert('Gagal hapus tekhnisi');
                                                                                }
                                                                            }}
                                                                            className="hover:text-red-300 ml-1"
                                                                            title="Hapus"
                                                                        >
                                                                            √ó
                                                                        </button>
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p className="text-xs text-slate-500 italic">Belum ada tekhnisi yang ditugaskan</p>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="flex justify-between text-xs text-slate-500">
                                                        <span>üìÖ {formatDate(s.createdAt)}</span>
                                                        {s.estimatedDate && <span>‚è∞ Est: {formatDate(s.estimatedDate)}</span>}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'active_service' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {filteredServices.filter(s => ['Dikerjakan', 'Menunggu Sparepart'].includes(s.status)).length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            filteredServices.filter(s => ['Dikerjakan', 'Menunggu Sparepart'].includes(s.status)).map(s => (
                                                <div key={s.id} className="bg-gradient-to-r from-blue-50 to-blue-100/50 p-4 rounded-xl border border-blue-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{s.customerName}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üì± {s.deviceModel || s.device || s.unitType}</p>
                                                        </div>
                                                        <span className={`text-xs font-bold px-3 py-1 rounded-full ${
                                                            s.status === 'Antri' ? 'bg-amber-100 text-amber-700' :
                                                            s.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                            'bg-purple-100 text-purple-700'
                                                        }`}>{s.status}</span>
                                                    </div>
                                                    <div className="bg-white/60 p-2 rounded mb-2">
                                                        {Array.isArray(s.complaintTags) && s.complaintTags.length > 0 ? (
                                                            <div className="flex flex-wrap gap-1">
                                                                {s.complaintTags.map((t,i) => <span key={i} className="text-xs bg-red-100 text-red-700 border border-red-200 px-2 py-0.5 rounded-full font-medium">{t}</span>)}
                                                            </div>
                                                        ) : (
                                                            <p className="text-sm text-slate-700">üîß {s.problem || s.complaint || '-'}</p>
                                                        )}
                                                    </div>
                                                    {s.unlockMethod && s.unlockMethod !== 'Tidak Ada' && (
                                                        <div className="flex items-center gap-2 mb-2 bg-yellow-50 border border-yellow-200 rounded px-2 py-1">
                                                            <Lock className="w-3 h-3 text-yellow-600 shrink-0"/>
                                                            <span className="text-xs font-bold text-yellow-700">{s.unlockMethod}{s.unlockCode ? ': ' + s.unlockCode : ''}</span>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Sparepart Info */}
                                                    {(s.usedParts && s.usedParts.length > 0) && (
                                                        <div className="mb-3 pb-3 border-b border-blue-200">
                                                            <p className="text-xs font-bold text-slate-600 uppercase mb-2">üì¶ Sparepart ({s.usedParts.length})</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.usedParts.map((part, idx) => (
                                                                    <div key={idx} className="bg-white border border-purple-200 rounded-lg px-3 py-1.5 text-xs">
                                                                        <span className="font-bold text-purple-700">{part.name}</span>
                                                                        <span className="text-slate-400 ml-1">x{part.qty}</span>
                                                                        <div className="text-[10px] text-slate-500 mt-0.5">{formatCurrency(part.sellPrice || 0)}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Technician section */}
                                                    <div className="mb-3 pb-3 border-b border-blue-200">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <p className="text-xs font-bold text-slate-600 uppercase">üë®‚Äçüîß Tekhnisi ({(s.technicians || []).length})</p>
                                                            <button 
                                                                onClick={() => setTechnicianModal({serviceId: s.id, customerName: s.customerName})}
                                                                className="text-blue-600 hover:text-blue-800 text-xs font-bold hover:bg-blue-50 px-2 py-1 rounded transition"
                                                            >
                                                                + Tambah
                                                            </button>
                                                        </div>
                                                        {(s.technicians || []).length > 0 ? (
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.technicians.map((tech, idx) => (
                                                                    <span key={idx} className="bg-blue-600 text-white text-xs px-2.5 py-1 rounded-full font-medium flex items-center gap-1">
                                                                        {tech}
                                                                        <button
                                                                            onClick={async () => {
                                                                                try {
                                                                                    const newTechs = s.technicians.filter((t, i) => i !== idx);
                                                                                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', s.id), {
                                                                                        technicians: newTechs
                                                                                    });
                                                                                } catch (err) {
                                                                                    alert('Gagal hapus tekhnisi');
                                                                                }
                                                                            }}
                                                                            className="hover:text-red-300 ml-1"
                                                                            title="Hapus"
                                                                        >
                                                                            √ó
                                                                        </button>
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p className="text-xs text-slate-500 italic">Belum ada tekhnisi yang ditugaskan</p>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="flex justify-between text-xs text-slate-500">
                                                        <span>üìÖ {formatDate(s.createdAt)}</span>
                                                        {s.estimatedDate && <span>‚è∞ Est: {formatDate(s.estimatedDate)}</span>}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'ready_service' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {completedServices.length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            completedServices.map(s => (
                                                <div key={s.id} className="bg-gradient-to-r from-emerald-50 to-emerald-100/50 p-4 rounded-xl border border-emerald-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{s.customerName}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üì± {s.device}</p>
                                                        </div>
                                                        <span className="text-xs font-bold px-3 py-1 rounded-full bg-emerald-100 text-emerald-700">‚úÖ Siap</span>
                                                    </div>
                                                    <p className="text-sm text-slate-700 bg-white/60 p-2 rounded mb-3">üîß {s.problem}</p>
                                                    
                                                    {/* Sparepart Info */}
                                                    {(s.usedParts && s.usedParts.length > 0) && (
                                                        <div className="mb-3 pb-3 border-b border-emerald-200">
                                                            <p className="text-xs font-bold text-slate-600 uppercase mb-2">üì¶ Sparepart Terpasang ({s.usedParts.length})</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.usedParts.map((part, idx) => (
                                                                    <div key={idx} className="bg-white border border-purple-200 rounded-lg px-3 py-1.5 text-xs">
                                                                        <span className="font-bold text-purple-700">{part.name}</span>
                                                                        <span className="text-slate-400 ml-1">x{part.qty}</span>
                                                                        <div className="text-[10px] text-emerald-600 font-semibold mt-0.5">{formatCurrency(part.sellPrice || 0)}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    <div className="flex justify-between text-xs text-slate-500">
                                                        <span>üìÖ Selesai: {formatDate(s.updatedAt)}</span>
                                                        <span>üíµ {s.totalPrice ? formatCurrency(s.totalPrice) : 'Belum ditentukan'}</span>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'income' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {income_trans.length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            income_trans.map(t => {
                                                const relatedService = services.find(s => s.id === t.serviceId);
                                                return (
                                                <div key={t.id} className="bg-gradient-to-r from-emerald-50 to-emerald-100/50 p-4 rounded-xl border border-emerald-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                        </div>
                                                        <span className="text-lg font-bold text-emerald-600">+{formatCurrency(t.amount)}</span>
                                                    </div>
                                                    {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                        <div className="bg-white/80 p-3 rounded-lg mb-2 border border-emerald-100">
                                                            <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart yang Digunakan:</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {relatedService.usedParts.map((part, idx) => (
                                                                    <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                        {part.name} x{part.qty} - {formatCurrency(part.sellPrice || 0)}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                    <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'expense' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {expense_trans.length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            expense_trans.map(t => {
                                                const relatedService = services.find(s => s.id === t.serviceId);
                                                return (
                                                <div key={t.id} className="bg-gradient-to-r from-rose-50 to-rose-100/50 p-4 rounded-xl border border-rose-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                        </div>
                                                        <span className="text-lg font-bold text-rose-600">-{formatCurrency(t.amount)}</span>
                                                    </div>
                                                    {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                        <div className="bg-white/80 p-3 rounded-lg mb-2 border border-rose-100">
                                                            <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart Modal:</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {relatedService.usedParts.map((part, idx) => (
                                                                    <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                        {part.name} x{part.qty} - Modal: {checkPermission('feature_show_modal') ? formatCurrency(part.buyPrice || 0) : '***'}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                    <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'profit' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {detailModal.subType === 'jasa' ? (
                                            filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).length === 0 ? (
                                                <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                            ) : (
                                                filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).map(t => {
                                                    const relatedService = services.find(s => s.id === t.serviceId);
                                                    return (
                                                    <div key={t.id} className="bg-gradient-to-r from-indigo-50 to-indigo-100/50 p-4 rounded-xl border border-indigo-200 hover:shadow-md transition-all">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                                <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                            </div>
                                                            <span className="text-lg font-bold text-indigo-600">+{formatCurrency(t.amount)}</span>
                                                        </div>
                                                        {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                            <div className="bg-white/80 p-3 rounded-lg mb-2 border border-indigo-100">
                                                                <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart Terpasang:</p>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {relatedService.usedParts.map((part, idx) => (
                                                                        <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                            {part.name} x{part.qty}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                        <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                    </div>
                                                    );
                                                })
                                            )
                                        ) : (
                                            filteredTrans.filter(t => t.type === 'profit' && !t.category?.includes('Jasa')).length === 0 ? (
                                                <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                            ) : (
                                                filteredTrans.filter(t => t.type === 'profit' && !t.category?.includes('Jasa')).map(t => {
                                                    const relatedSale = sales.find(s => s.id === t.originalSaleId);
                                                    return (
                                                    <div key={t.id} className="bg-gradient-to-r from-cyan-50 to-cyan-100/50 p-4 rounded-xl border border-cyan-200 hover:shadow-md transition-all">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                                <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                            </div>
                                                            <span className="text-lg font-bold text-cyan-600">+{formatCurrency(t.amount)}</span>
                                                        </div>
                                                        {relatedSale && relatedSale.items && relatedSale.items.length > 0 && (
                                                            <div className="bg-white/80 p-3 rounded-lg mb-3 border border-cyan-100">
                                                                <p className="text-xs font-bold text-cyan-700 mb-3">üì¶ Detail Barang & Keuntungan:</p>
                                                                <div className="space-y-2">
                                                                    {relatedSale.items.map((item, idx) => {
                                                                        const itemProfit = (item.sellPrice - (item.buyPrice || 0)) * item.qty;
                                                                        return (
                                                                            <div key={idx} className="bg-gradient-to-r from-cyan-50 to-blue-50 p-2.5 rounded-lg border border-cyan-200 text-xs">
                                                                                <div className="flex justify-between items-start gap-2">
                                                                                    <div className="flex-1">
                                                                                        <p className="font-bold text-slate-800">{item.name}</p>
                                                                                        <p className="text-slate-600 mt-0.5">Qty: {item.qty} ‚Ä¢ Modal: {checkPermission('feature_show_modal') ? formatCurrency(item.buyPrice || 0) : '***'}/pcs ‚Ä¢ Jual: {formatCurrency(item.sellPrice)}/pcs</p>
                                                                                        {item.category && <p className="text-slate-500 mt-1">üìÇ {item.category}</p>}
                                                                                    </div>
                                                                                    <span className="font-bold text-cyan-600 whitespace-nowrap">+{formatCurrency(itemProfit)}</span>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                        <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                    </div>
                                                    );
                                                })
                                            )
                                        )}
                                    </div>
                                )}
                                
                                {/* Kompensasi Retur Penjualan */}
                                {detailModal.type === 'kompensasi_retur_penjualan' && (
                                    <div className="space-y-3">
                                        {filteredTrans.filter(t => t.type === 'income' && t.category === 'Kompensasi Retur Penjualan').length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data kompensasi retur penjualan</div>
                                        ) : (
                                            filteredTrans.filter(t => t.type === 'income' && t.category === 'Kompensasi Retur Penjualan').map(t => (
                                                <div key={t.id} className="bg-gradient-to-r from-teal-50 to-teal-100/50 p-4 rounded-xl border border-teal-200">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-slate-800">{t.description}</p>
                                                            <p className="text-xs text-slate-500 mt-1">{formatDate(t.date || t.createdAt)}</p>
                                                        </div>
                                                        <span className="text-xl font-bold text-teal-600">+{formatCurrency(t.amount)}</span>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {/* Kompensasi Retur Pembelian */}
                                {detailModal.type === 'kompensasi_retur_pembelian' && (
                                    <div className="space-y-3">
                                        {filteredTrans.filter(t => t.type === 'expense' && t.category === 'Kompensasi Retur Pembelian').length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data kompensasi retur pembelian</div>
                                        ) : (
                                            filteredTrans.filter(t => t.type === 'expense' && t.category === 'Kompensasi Retur Pembelian').map(t => (
                                                <div key={t.id} className="bg-gradient-to-r from-rose-50 to-rose-100/50 p-4 rounded-xl border border-rose-200">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-slate-800">{t.description}</p>
                                                            <p className="text-xs text-slate-500 mt-1">{formatDate(t.date || t.createdAt)}</p>
                                                        </div>
                                                        <span className="text-xl font-bold text-rose-600">-{formatCurrency(t.amount)}</span>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {/* Summary Footer */}
                                {(detailModal.type === 'income' || detailModal.type === 'expense' || detailModal.type === 'profit' || detailModal.type === 'kompensasi_retur_penjualan' || detailModal.type === 'kompensasi_retur_pembelian') && (
                                    <div className="mt-6 pt-6 border-t border-slate-200">
                                        {detailModal.type === 'income' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Pemasukan:</p>
                                                <p className="text-2xl font-bold text-emerald-600">{formatCurrency(income_trans.reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'expense' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Pengeluaran:</p>
                                                <p className="text-2xl font-bold text-rose-600">-{formatCurrency(expense_trans.reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'profit' && detailModal.subType === 'jasa' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Keuntungan Jasa:</p>
                                                <p className="text-2xl font-bold text-indigo-600">+{formatCurrency(filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'profit' && detailModal.subType === 'penjualan' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Keuntungan Penjualan:</p>
                                                <p className="text-2xl font-bold text-cyan-600">+{formatCurrency(filteredTrans.filter(t => t.type === 'profit' && !t.category?.includes('Jasa')).reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'kompensasi_retur_penjualan' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Kompensasi Retur Penjualan:</p>
                                                <p className="text-2xl font-bold text-teal-600">+{formatCurrency(kompensasi_retur_penjualan)}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'kompensasi_retur_pembelian' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Kompensasi Retur Pembelian:</p>
                                                <p className="text-2xl font-bold text-rose-600">-{formatCurrency(kompensasi_retur_pembelian)}</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Stock Modal - Urgent Stock, Out of Stock, Stock Value */}
                {detailModal && (detailModal.type === 'urgent_stock' || detailModal.type === 'out_of_stock' || detailModal.type === 'stock_value') && (
                    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                            <div className="p-6 border-b border-slate-200 bg-slate-50">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-xl text-slate-800">{detailModal.title}</h3>
                                        <p className="text-xs text-slate-500">Daftar item inventory</p>
                                    </div>
                                    <button onClick={() => setDetailModal(null)} className="p-2 hover:bg-slate-200 rounded-full transition-colors">
                                        <X className="w-6 h-6 text-slate-400" />
                                    </button>
                                </div>
                            </div>
                            
                            <div className="p-6 max-h-[60vh] overflow-y-auto">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {(detailModal.data || []).map(item => (
                                        <div key={item.id} className={`p-4 border rounded-xl ${
                                            detailModal.type === 'urgent_stock' ? 'border-amber-200 bg-amber-50' :
                                            detailModal.type === 'out_of_stock' ? 'border-red-200 bg-red-50' :
                                            'border-indigo-200 bg-indigo-50'
                                        }`}>
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex-1">
                                                    <h4 className="font-bold text-slate-800 text-sm">{item.name}</h4>
                                                    {item.brand && <p className="text-xs text-slate-500">{item.brand}</p>}
                                                    {item.category && <p className="text-xs text-slate-500">{item.category}</p>}
                                                </div>
                                                <div className="text-right">
                                                    <p className={`font-bold text-lg ${
                                                        detailModal.type === 'urgent_stock' ? 'text-amber-600' :
                                                        detailModal.type === 'out_of_stock' ? 'text-red-600' :
                                                        'text-indigo-600'
                                                    }`}>
                                                        {detailModal.type === 'stock_value' ? formatCurrency(item.stock * item.sellPrice) : item.stock + ' pcs'}
                                                    </p>
                                                    {detailModal.type === 'stock_value' && (
                                                        <p className="text-xs text-slate-500">{item.stock} x {formatCurrency(item.sellPrice)}</p>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {detailModal.type === 'stock_value' && (
                                                <div className="grid grid-cols-2 gap-2 text-xs">
                                                    <div>
                                                        <p className="text-slate-500">Beli:</p>
                                                        <p className="font-bold text-slate-700">{checkPermission('feature_show_modal') ? formatCurrency(item.buyPrice || 0) : '***'}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-500">Jual:</p>
                                                        <p className="font-bold text-slate-700">{formatCurrency(item.sellPrice || 0)}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                
                                {detailModal.data && detailModal.data.length === 0 && (
                                    <div className="text-center py-12">
                                        <div className="w-16 h-16 mx-auto mb-4 bg-slate-100 rounded-full flex items-center justify-center">
                                            <Box className="w-8 h-8 text-slate-400" />
                                        </div>
                                        <p className="text-slate-500">Tidak ada item yang ditemukan</p>
                                    </div>
                                )}
                            </div>
                            
                            {/* Summary Footer */}
                            {detailModal.type === 'stock_value' && detailModal.data && (
                                <div className="p-6 border-t border-slate-200 bg-slate-50">
                                    <div className="grid grid-cols-3 gap-4 text-center">
                                        <div>
                                            <p className="text-sm text-slate-600">Total Item</p>
                                            <p className="font-bold text-lg text-indigo-600">{detailModal.data.length}</p>
                                        </div>
                                        <div>
                                            <p className="text-sm text-slate-600">Total Stock</p>
                                            <p className="font-bold text-lg text-indigo-600">{detailModal.data.reduce((a,b) => a + (b.stock || 0), 0)}</p>
                                        </div>
                                        <div>
                                            <p className="text-sm text-slate-600">Total Nilai</p>
                                            <p className="font-bold text-lg text-indigo-600">{formatCurrency(detailModal.data.reduce((a,b) => a + (b.stock * b.sellPrice), 0))}</p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                )}
                {technicianModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[71] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h3 className="font-bold text-xl text-slate-800">Assign Tekhnisi</h3>
                                <button onClick={() => setTechnicianModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                            </div>
                            
                            <div className="mb-4">
                                <p className="text-sm font-bold text-slate-700 mb-2">Service: <span className="text-blue-600">{technicianModal.customerName}</span></p>
                                <p className="text-xs text-slate-500">Pilih tekhnisi untuk menugaskan ke service ini:</p>
                            </div>
                            
                            <div className="space-y-2 max-h-64 overflow-y-auto mb-6 border rounded-lg p-3 bg-slate-50">
                                {users?.filter(u => u.role !== 'owner')?.length > 0 ? (
                                    users.filter(u => u.role !== 'owner').map(user => (
                                        <button
                                            key={user.id}
                                            onClick={() => assignTechnician(technicianModal.serviceId, user.name)}
                                            className="w-full text-left px-3 py-2 rounded-lg hover:bg-blue-100 transition-colors border border-slate-200 hover:border-blue-300"
                                        >
                                            <p className="font-bold text-slate-800 text-sm">{user.name}</p>
                                            <p className="text-xs text-slate-500">{user.role} ‚Ä¢ {user.email}</p>
                                        </button>
                                    ))
                                ) : (
                                    <div className="text-center py-6 text-slate-500">
                                        <Lock className="w-8 h-8 mx-auto mb-2 opacity-50"/>
                                        <p className="text-sm">Tidak ada tekhnisi tersedia</p>
                                    </div>
                                )}
                            </div>
                            
                            <div className="flex gap-3">
                                <button onClick={() => setTechnicianModal(null)} className="flex-1 py-2.5 border border-slate-300 rounded-lg font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Technician Assignment Modal */}
                {technicianModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h3 className="font-bold text-xl text-slate-800">Tambah Tekhnisi</h3>
                                <button onClick={() => setTechnicianModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                            </div>
                            
                            <p className="text-sm text-slate-600 mb-4">Servis: <strong>{technicianModal.customerName}</strong></p>
                            
                            <div className="space-y-3 mb-6">
                                <p className="text-xs font-bold text-slate-500 uppercase">Pilih dari daftar pegawai:</p>
                                {users && users.length > 0 ? (
                                    <div className="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto">
                                        {users.map(user => (
                                            <button
                                                key={user.id}
                                                onClick={() => {
                                                    assignTechnician(technicianModal.serviceId, user.name);
                                                }}
                                                className="p-3 text-left border border-slate-200 rounded-lg hover:bg-blue-50 hover:border-blue-400 transition"
                                            >
                                                <p className="text-sm font-bold text-slate-800">{user.name}</p>
                                                <p className="text-xs text-slate-500">{user.role}</p>
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-sm text-slate-500 text-center py-4">Tidak ada pegawai terdaftar</p>
                                )}
                            </div>
                            
                            <div className="border-t pt-4">
                                <p className="text-xs font-bold text-slate-500 uppercase mb-2">Atau ketik nama manual:</p>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const name = e.target.techName.value;
                                    assignTechnician(technicianModal.serviceId, name);
                                    e.target.techName.value = '';
                                }} className="flex gap-2">
                                    <input
                                        name="techName"
                                        placeholder="Nama tekhnisi..."
                                        className="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-700">
                                        Tambah
                                    </button>
                                </form>
                            </div>
                            
                            <button onClick={() => setTechnicianModal(null)} className="w-full mt-4 py-2 border border-slate-300 rounded-lg text-slate-600 font-bold hover:bg-slate-50">
                                Tutup
                            </button>
                        </div>
                    </div>
                )}
            </div> 
          );
        };

        const ReportManager = () => {
            const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
            
            const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
            const { data: transactions } = useFirestoreCollection('transactions', activeOwner?.id, activeStore?.id);
            const { data: sales } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
            const [inventory, setInventory] = useState([]);
            const [inventoryLoading, setInventoryLoading] = useState(true);
            const [tab, setTab] = useState('summary');
            const [dateRange, setDateRange] = useState('today');
            const [detailModal, setDetailModal] = useState(null); // { title, data[], type }
            
            // Pagination states for inventory tab
            const [inventoryCurrentPage, setInventoryCurrentPage] = useState(1);
            const [inventoryItemsPerPage, setInventoryItemsPerPage] = useState(10);
            
            // Pagination states for sales tab
            const [salesCurrentPage, setSalesCurrentPage] = useState(1);
            const [salesItemsPerPage, setSalesItemsPerPage] = useState(10);
            
            // Pagination states for service tab
            const [serviceCurrentPage, setServiceCurrentPage] = useState(1);
            const [serviceItemsPerPage, setServiceItemsPerPage] = useState(10);

            // ‚îÄ‚îÄ Utang & Piutang ‚îÄ‚îÄ
            const [debts, setDebts] = useState([]);
            useEffect(() => {
                if (!activeOwner?.id) return;
                const debtsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'debts');
                let q;
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                } else {
                    q = query(debtsRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                }
                const unsub = onSnapshot(q, snap => setDebts(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                return unsub;
            }, [activeOwner?.id, activeStore?.id]);
            const payableDebts    = debts.filter(d => d.type === 'payable');
            const receivableDebts = debts.filter(d => d.type === 'receivable');

            // Load inventory directly via raw fetch (bypass pb SDK issues)
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                setInventoryLoading(true);
                const filter = `ownerId = "${activeOwner.id}" && storeId = "${activeStore.id}"`;
                fetch(`${POCKETBASE_URL}/api/collections/inventory/records?perPage=2000&sort=-created&filter=${encodeURIComponent(filter)}`)
                    .then(r => r.json())
                    .then(d => {
                        if (d.items) {
                            setInventory(d.items.map(r => ({ id: r.id, ...r })));
                        } else {
                            setInventory([]);
                        }
                        setInventoryLoading(false);
                    })
                    .catch(e => {
                        console.error('‚ùå Inventory fetch error:', e);
                        setInventory([]);
                        setInventoryLoading(false);
                    });
            }, [activeOwner?.id, activeStore?.id]);

            // Aggregation data for accurate totals (not affected by limit)
            const [inventoryAggregation, setInventoryAggregation] = useState({
                totalItems: 0,
                totalStock: 0,
                totalStockValue: 0,
                loading: true
            });

            // Fetch aggregation data from Firestore
            useEffect(() => {
                if (!activeOwner?.id) return;
                
                const fetchAggregation = async () => {
                    try {
                        const inventoryRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory');
                        let q;
                        
                        if (activeStore?.id) {
                            q = query(inventoryRef, 
                                where('ownerId', '==', activeOwner.id),
                                where('storeId', '==', activeStore.id)
                            );
                        } else {
                            q = query(inventoryRef, where('ownerId', '==', activeOwner.id));
                        }
                        
                        const aggregateSnapshot = await getAggregateFromServer(q, {
                            totalItems: count(),
                            totalStock: sum('stock')
                        });
                        
                        // Also fetch all items to calculate totalStockValue (sellPrice * stock)
                        const allItemsSnap = await getDocs(q);
                        const allItems = allItemsSnap.docs.map(d => d.data());
                        const stockValue = allItems.reduce((s, item) => s + ((item.sellPrice || 0) * (item.stock || 0)), 0);
                        
                        setInventoryAggregation({
                            totalItems: aggregateSnapshot.data().totalItems,
                            totalStock: aggregateSnapshot.data().totalStock || 0,
                            totalStockValue: stockValue,
                            loading: false
                        });
                    } catch (error) {
                        console.error('Error fetching aggregation:', error);
                        // Fallback to client-side calculation if aggregation fails
                        setInventoryAggregation({
                            totalItems: inventory.length,
                            totalStock: inventory.reduce((a, b) => a + (b.stock || 0), 0),
                            totalStockValue: inventory.reduce((s, item) => s + ((item.sellPrice || 0) * (item.stock || 0)), 0),
                            loading: false
                        });
                    }
                };
                
                fetchAggregation();
            }, [activeOwner?.id, activeStore?.id]);

            const getFilteredByDateRange = (items) => {
                const now = new Date();
                return items.filter(i => {
                    const d = i.createdAt ? (i.createdAt.seconds ? new Date(i.createdAt.seconds * 1000) : new Date(i.createdAt)) : (i.date ? (i.date.seconds ? new Date(i.date.seconds * 1000) : new Date(i.date)) : null);
                    if (!d) return false;
                    if (dateRange === 'today') return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (dateRange === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (dateRange === 'year') return d.getFullYear() === now.getFullYear();
                    return true;
                });
            };

            const filteredServices = getFilteredByDateRange(services);
            const filteredSales = getFilteredByDateRange(sales || []);
            const filteredTrans = getFilteredByDateRange(transactions);

            const totalServices = filteredServices.length;
            const completedServices = filteredServices.filter(s => s.status === 'Selesai').length;
            const serviceIncome = filteredTrans.filter(t => t.type === 'income').reduce((a, b) => a + b.amount, 0);
            const serviceExpense = filteredTrans.filter(t => t.type === 'expense').reduce((a, b) => a + b.amount, 0);
            const serviceProfitLoss = serviceIncome - serviceExpense;

            const totalSales = filteredSales.reduce((a, b) => a + (parseFloat(b.total) || 0), 0);
            const totalReturns = filteredSales.filter(s => s.type === 'return').reduce((a, b) => a + (parseFloat(b.total) || 0), 0);

            const topItems = inventory.filter(i => i.stock > 0).sort((a, b) => (parseFloat(b.sellPrice) * b.stock) - (parseFloat(a.sellPrice) * a.stock)).slice(0, 5);
            const inventoryValue = inventory.reduce((a, b) => a + (parseFloat(b.sellPrice) * b.stock), 0);

            // Pagination calculations for inventory tab
            const inventoryStartIndex = (inventoryCurrentPage - 1) * inventoryItemsPerPage;
            const inventoryEndIndex = inventoryStartIndex + inventoryItemsPerPage;
            const paginatedInventory = inventory.slice(inventoryStartIndex, inventoryEndIndex);
            const inventoryTotalPages = Math.ceil(inventory.length / inventoryItemsPerPage);
            
            // ‚úÖ Filter kategori & sub kategori penjualan
            const [filterCat, setFilterCat] = useState('');
            const [filterSubCat, setFilterSubCat] = useState('');
            const [filterCustomer, setFilterCustomer] = useState('');

            // Daftar kategori & sub-kategori unik dari semua item penjualan
            const allSalesCategories = [...new Set(
                (sales || []).flatMap(s => s.items?.map(it => it.category).filter(Boolean) || [])
            )].sort();

            const allSalesSubCategories = [...new Set(
                (sales || []).flatMap(s => s.items?.map(it => it.subCategory).filter(Boolean) || [])
            )].filter(sc => {
                if (!filterCat) return true;
                // Hanya sub-kategori yang ada di kategori yang dipilih
                return (sales || []).some(s => s.items?.some(it => it.category === filterCat && it.subCategory === sc));
            }).sort();

            // Terapkan filter kategori/sub-kategori/pelanggan/nama barang
            const filteredSalesByCat = filteredSales.filter(s => {
                const term = filterCustomer.toLowerCase();
                const matchCustomer = !filterCustomer || 
                    (s.customerName || '').toLowerCase().includes(term) ||
                    (s.items || []).some(it => (it.name || it.productName || '').toLowerCase().includes(term));
                const matchCat = !filterCat || s.items?.some(it => it.category === filterCat);
                const matchSubCat = !filterSubCat || s.items?.some(it => it.subCategory === filterSubCat);
                return matchCustomer && matchCat && matchSubCat;
            });

            // Pagination calculations for sales tab
            const salesStartIndex = (salesCurrentPage - 1) * salesItemsPerPage;
            const salesEndIndex = salesStartIndex + salesItemsPerPage;
            const paginatedSales = filteredSalesByCat.slice(salesStartIndex, salesEndIndex);
            const salesTotalPages = Math.ceil(filteredSalesByCat.length / salesItemsPerPage);
            
            // Pagination calculations for service tab
            const serviceStartIndex = (serviceCurrentPage - 1) * serviceItemsPerPage;
            const serviceEndIndex = serviceStartIndex + serviceItemsPerPage;
            const paginatedServices = filteredServices.slice(serviceStartIndex, serviceEndIndex);
            const serviceTotalPages = Math.ceil(filteredServices.length / serviceItemsPerPage);

            // Reset to page 1 when tab changes to inventory
            useEffect(() => {
                if (tab === 'inventory') {
                    setInventoryCurrentPage(1);
                } else if (tab === 'sales') {
                    setSalesCurrentPage(1);
                    setFilterCat('');
                    setFilterSubCat('');
                    setFilterCustomer('');
                } else if (tab === 'service') {
                    setServiceCurrentPage(1);
                }
            }, [tab]);

            const handleInventoryPageChange = (newPage) => {
                if (newPage >= 1 && newPage <= inventoryTotalPages) {
                    setInventoryCurrentPage(newPage);
                    // Smooth scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleInventoryItemsPerPageChange = (value) => {
                setInventoryItemsPerPage(value);
                setInventoryCurrentPage(1);
            };
            
            const handleSalesPageChange = (newPage) => {
                if (newPage >= 1 && newPage <= salesTotalPages) {
                    setSalesCurrentPage(newPage);
                    // Smooth scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleSalesItemsPerPageChange = (value) => {
                setSalesItemsPerPage(value);
                setSalesCurrentPage(1);
            };
            
            const handleServicePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= serviceTotalPages) {
                    setServiceCurrentPage(newPage);
                    // Smooth scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleServiceItemsPerPageChange = (value) => {
                setServiceItemsPerPage(value);
                setServiceCurrentPage(1);
            };

            // ‚îÄ‚îÄ State modal laporan komprehensif ‚îÄ‚îÄ
            const [compModal, setCompModal] = useState(null); // null | 'monthly' | 'yearly'
            const now = new Date();
            const [compYear,  setCompYear]  = useState(now.getFullYear());
            const [compMonth, setCompMonth] = useState(now.getMonth() + 1);
            const [compLoading, setCompLoading] = useState(false);
            const MONTH_NAMES = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

            const handleExportPDF = async () => {
                const storeName  = activeStore?.name  || activeOwner?.name || 'iFix Pro';
                const storeAddr  = activeStore?.address || '';
                const storePhone = activeStore?.phone  || '';
                const storeLogo  = activeStore?.logo   || '';
                const periodLabel = dateRange === 'today' ? 'Hari Ini' : dateRange === 'month' ? 'Bulan Ini' : 'Tahun Ini';
                const printDate  = new Date().toLocaleDateString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
                const fmt = (n) => new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', minimumFractionDigits:0 }).format(n||0);
                const fmtDate = (v) => {
                    if (!v) return '-';
                    try {
                        const d = v.seconds ? new Date(v.seconds*1000) : new Date(v);
                        return d.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
                    } catch(e) { return '-'; }
                };
                // Escape HTML ‚Äî cegah data merusak template
                const esc = (s) => String(s==null?'-':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

                const tabTitles = { summary:'Ringkasan', sales:'Penjualan', service:'Servis', inventory:'Stok Inventaris', profitloss:'Profit & Loss', payable:'Utang', receivable:'Piutang' };
                const tabTitle = tabTitles[tab] || tab;

                // ‚îÄ‚îÄ Bangun baris tabel per tab ‚îÄ‚îÄ
                let tableHtml = '';

                if (tab === 'summary') {
                    tableHtml = `
                    <div class="kpi-grid">
                        <div class="kpi-card"><div class="kpi-label">Total Servis</div><div class="kpi-val">${totalServices}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Servis Selesai</div><div class="kpi-val text-green">${completedServices}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Dalam Proses</div><div class="kpi-val">${totalServices - completedServices}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Total Penjualan</div><div class="kpi-val">${fmt(totalSales)}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Total Retur</div><div class="kpi-val text-red">${fmt(totalReturns)}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Nilai Inventaris</div><div class="kpi-val">${fmt(inventoryValue)}</div></div>
                    </div>
                    <table><thead><tr><th>Keterangan</th><th class="num">Jumlah</th></tr></thead><tbody>
                        <tr><td>Pemasukan (Servis)</td><td class="num text-green">${fmt(serviceIncome)}</td></tr>
                        <tr><td>Pengeluaran (Servis)</td><td class="num text-red">${fmt(serviceExpense)}</td></tr>
                        <tr class="bold-row"><td>Profit / Loss</td><td class="num ${serviceProfitLoss>=0?'text-green':'text-red'}">${fmt(serviceProfitLoss)}</td></tr>
                        <tr><td>Total Transaksi Penjualan</td><td class="num">${filteredSales.length}</td></tr>
                        <tr><td>Total Nilai Penjualan</td><td class="num">${fmt(totalSales)}</td></tr>
                        <tr class="bold-row"><td>Jumlah Item Inventaris</td><td class="num">${inventory.length}</td></tr>
                    </tbody></table>`;
                } else if (tab === 'sales') {
                    const rows = filteredSalesByCat.map((s, i) => {
                        const items = esc((s.items||[]).map(it=>(it.name||it.productName||'?')+' x'+(it.qty||1)).join(', '));
                        const cust  = esc(s.customerName||'-');
                        const tipe  = s.type==='return'?'Retur':'Jual';
                        const bdg   = s.type==='return'?'badge-red':'badge-green';
                        return '<tr>'
                            + '<td class="center">'+(i+1)+'</td>'
                            + '<td>'+fmtDate(s.date||s.createdAt)+'</td>'
                            + '<td>'+cust+'</td>'
                            + '<td class="small">'+(items||'-')+'</td>'
                            + '<td class="num">'+fmt(s.total)+'</td>'
                            + '<td class="center"><span class="badge '+bdg+'">'+tipe+'</span></td>'
                            + '</tr>';
                    }).join('');
                    const grandTotal = filteredSalesByCat.reduce((a,b)=>a+(parseFloat(b.total)||0),0);
                    tableHtml = '<table><thead><tr><th class="center">No</th><th>Tanggal</th><th>Pelanggan</th><th>Item</th><th class="num">Total</th><th class="center">Tipe</th></tr></thead>'
                        + '<tbody>'+(rows||'<tr><td colspan="6" class="center">Tidak ada data</td></tr>')+'</tbody>'
                        + '<tfoot><tr><td colspan="4" class="bold-row">Total ('+filteredSalesByCat.length+' transaksi)</td><td class="num bold-row">'+fmt(grandTotal)+'</td><td></td></tr></tfoot></table>';
                } else if (tab === 'service') {
                    const unpaidCount   = filteredServices.filter(s => (s.paymentStatus||'Belum Lunas') !== 'Lunas').length;
                    const dpTotal       = filteredServices.reduce((a,b)=>a+(parseFloat(b.downPayment||b.dp)||0),0);
                    const estimateTotal = filteredServices.reduce((a,b)=>a+(parseFloat(b.costEstimate)||0),0);
                    const sisaTotal     = filteredServices.reduce((a,b)=>a+Math.max(0,(parseFloat(b.costEstimate)||0)-(parseFloat(b.downPayment||b.dp)||0)),0);
                    const rows = filteredServices.map((s, i) => {
                        const statusClass = s.status==='Selesai'?'badge-green':s.status==='Batal'?'badge-red':'badge-yellow';
                        const payStatus   = s.paymentStatus||'Belum Lunas';
                        const payClass    = payStatus==='Lunas'?'badge-green':payStatus==='DP'?'badge-yellow':'badge-red';
                        const device  = esc(s.unitType||s.deviceType||s.deviceModel||s.deviceBrand||s.device||'-');
                        const keluhan = esc(s.complaint||s.problem||s.problemDescription||s.keluhan||'-');
                        const cust    = esc(s.customerName||s.customer||'-');
                        const status  = esc(s.status||'-');
                        const dp      = parseFloat(s.downPayment||s.dp)||0;
                        const est     = parseFloat(s.costEstimate)||0;
                        const sisa    = Math.max(0, est - dp);
                        const rowStyle = payStatus !== 'Lunas' ? ' style="background:#fff7ed;"' : '';
                        return '<tr'+rowStyle+'>'
                            + '<td class="center">'+(i+1)+'</td>'
                            + '<td>'+fmtDate(s.createdAt)+'</td>'
                            + '<td>'+cust+'</td>'
                            + '<td>'+device+'</td>'
                            + '<td class="small">'+keluhan+'</td>'
                            + '<td class="center"><span class="badge '+statusClass+'">'+status+'</span></td>'
                            + '<td class="num">'+fmt(est)+'</td>'
                            + '<td class="num">'+fmt(dp)+'</td>'
                            + '<td class="num'+(sisa>0?' text-red':'')+'">'+(sisa>0?fmt(sisa):'<span class="badge badge-green">Lunas</span>')+'</td>'
                            + '<td class="center"><span class="badge '+payClass+'">'+esc(payStatus)+'</span></td>'
                            + '</tr>';
                    }).join('');
                    const kpiUtang = '<div class="kpi-grid">'
                        + '<div class="kpi-card"><div class="kpi-label">Total Servis</div><div class="kpi-val">'+filteredServices.length+'</div></div>'
                        + '<div class="kpi-card"><div class="kpi-label">Total Estimasi</div><div class="kpi-val">'+fmt(estimateTotal)+'</div></div>'
                        + '<div class="kpi-card"><div class="kpi-label">DP Diterima</div><div class="kpi-val text-green">'+fmt(dpTotal)+'</div></div>'
                        + '<div class="kpi-card"><div class="kpi-label">Sisa Tagihan</div><div class="kpi-val text-red">'+fmt(sisaTotal)+'</div></div>'
                        + '<div class="kpi-card"><div class="kpi-label">Belum Lunas ‚ö†Ô∏è</div><div class="kpi-val text-red">'+unpaidCount+'</div></div>'
                        + '</div>';
                    tableHtml = kpiUtang
                        + '<table><thead><tr>'
                        + '<th class="center">No</th><th>Tanggal</th><th>Pelanggan</th><th>Device</th><th>Keluhan</th>'
                        + '<th class="center">Status</th><th class="num">Estimasi</th><th class="num">DP</th><th class="num">Sisa</th><th class="center">Pembayaran</th>'
                        + '</tr></thead>'
                        + '<tbody>'+(rows||'<tr><td colspan="10" class="center">Tidak ada data</td></tr>')+'</tbody>'
                        + '<tfoot><tr><td colspan="6" class="bold-row">Total ('+filteredServices.length+' servis)</td>'
                        + '<td class="num bold-row">'+fmt(estimateTotal)+'</td>'
                        + '<td class="num bold-row">'+fmt(dpTotal)+'</td>'
                        + '<td class="num bold-row text-red">'+fmt(sisaTotal)+'</td>'
                        + '<td></td></tr></tfoot></table>'
                        + (unpaidCount>0?'<p style="margin-top:8px;font-size:9px;color:#dc2626;"><strong>‚ö†Ô∏è Baris oranye</strong> = servis belum lunas / masih ada sisa tagihan</p>':'');
                } else if (tab === 'inventory') {
                    const sorted = [...inventory].sort((a,b)=>{
                        const catA = (a.category||'').toLowerCase();
                        const catB = (b.category||'').toLowerCase();
                        if (catA !== catB) return catA.localeCompare(catB);
                        const subA = (a.subCategory||'').toLowerCase();
                        const subB = (b.subCategory||'').toLowerCase();
                        if (subA !== subB) return subA.localeCompare(subB);
                        return (a.name||'').localeCompare(b.name||'');
                    });
                    const rows = sorted.map((item, i) => {
                        const stockVal = (parseFloat(item.sellPrice)||0) * (item.stock||0);
                        const isLow = item.minStock && (item.stock||0) <= item.minStock;
                        return '<tr'+(isLow?' style="background:#fff7ed;"':'')+'>'
                            + '<td class="center">'+(i+1)+'</td>'
                            + '<td><strong>'+esc(item.name||'-')+'</strong>'+(item.brand?'<br/><span style="font-size:9px;color:#ea580c;">üè∑Ô∏è '+esc(item.brand)+'</span>':'')+'</td>'
                            + '<td>'+esc(item.category||'-')+(item.subCategory?'<br/><span style="font-size:9px;color:#0284c7;">‚Üí '+esc(item.subCategory)+'</span>':'')+'</td>'
                            + '<td class="center">'+(item.unit||'-')+'</td>'
                            + '<td class="center'+(isLow?' text-red':'')+'">'+(item.stock||0)+(item.minStock?'<br/><span style="font-size:8px;color:#94a3b8;">min:'+item.minStock+'</span>':'')+'</td>'
                            + '<td class="num">'+fmt(item.buyPrice)+'</td>'
                            + '<td class="num">'+fmt(item.sellPrice)+'</td>'
                            + '<td class="num">'+fmt(stockVal)+'</td>'
                            + '</tr>';
                    }).join('');
                    const totalStockVal = sorted.reduce((a,item)=>a+((parseFloat(item.sellPrice)||0)*(item.stock||0)),0);
                    const totalQty = sorted.reduce((a,item)=>a+(item.stock||0),0);
                    const lowStockCount = sorted.filter(item=>item.minStock&&(item.stock||0)<=item.minStock).length;
                    // Ringkasan per kategori
                    const catSummary = {};
                    sorted.forEach(item => {
                        const cat = item.category||'Tidak Berkategori';
                        if (!catSummary[cat]) catSummary[cat] = {qty:0, val:0, items:0};
                        catSummary[cat].qty   += (item.stock||0);
                        catSummary[cat].val   += (parseFloat(item.sellPrice)||0)*(item.stock||0);
                        catSummary[cat].items += 1;
                    });
                    const catRows = Object.entries(catSummary).map(([cat,v])=>
                        '<tr><td>'+esc(cat)+'</td><td class="center">'+v.items+'</td><td class="center">'+v.qty+'</td><td class="num">'+fmt(v.val)+'</td></tr>'
                    ).join('');
                    tableHtml = '<div class="kpi-grid">'
                        + '<div class="kpi-card"><div class="kpi-label">Total SKU</div><div class="kpi-val">'+sorted.length+'</div></div>'
                        + '<div class="kpi-card"><div class="kpi-label">Total Qty</div><div class="kpi-val">'+totalQty+'</div></div>'
                        + '<div class="kpi-card"><div class="kpi-label">Nilai Stok</div><div class="kpi-val">'+fmt(totalStockVal)+'</div></div>'
                        + '<div class="kpi-card"><div class="kpi-label">Kategori</div><div class="kpi-val">'+Object.keys(catSummary).length+'</div></div>'
                        + '<div class="kpi-card"><div class="kpi-label">Stok Rendah ‚ö†Ô∏è</div><div class="kpi-val text-red">'+lowStockCount+'</div></div>'
                        + '</div>'
                        + '<h3 style="margin:14px 0 6px;font-size:11px;color:#374151;text-transform:uppercase;letter-spacing:.05em;font-weight:800;">Ringkasan per Kategori</h3>'
                        + '<table><thead><tr><th>Kategori</th><th class="center">SKU</th><th class="center">Total Qty</th><th class="num">Nilai Stok</th></tr></thead>'
                        + '<tbody>'+catRows+'</tbody></table>'
                        + '<h3 style="margin:14px 0 6px;font-size:11px;color:#374151;text-transform:uppercase;letter-spacing:.05em;font-weight:800;">Detail Inventaris</h3>'
                        + '<table><thead><tr>'
                        + '<th class="center">No</th><th>Nama Barang / Brand</th><th>Kategori / Sub Kategori</th>'
                        + '<th class="center">Satuan</th><th class="center">Stok</th>'
                        + '<th class="num">Harga Beli</th><th class="num">Harga Jual</th><th class="num">Nilai Stok</th>'
                        + '</tr></thead>'
                        + '<tbody>'+(rows||'<tr><td colspan="8" class="center">Tidak ada data</td></tr>')+'</tbody>'
                        + '<tfoot><tr><td colspan="4" class="bold-row">Total ('+sorted.length+' item)</td><td class="center bold-row">'+totalQty+'</td><td colspan="2"></td><td class="num bold-row">'+fmt(totalStockVal)+'</td></tr></tfoot></table>'
                        + (lowStockCount>0?'<p style="margin-top:8px;font-size:9px;color:#dc2626;"><strong>‚ö†Ô∏è Baris oranye</strong> = stok di bawah atau sama dengan stok minimum</p>':'');
                } else if (tab === 'payable' || tab === 'receivable') {
                    const isPayable  = tab === 'payable';
                    const debtList   = isPayable ? payableDebts : receivableDebts;
                    const colorA     = isPayable ? 'text-red' : 'text-green';
                    const totalAmt   = debtList.reduce((a,d)=>a+(d.amount||0),0);
                    const totalPaid  = debtList.reduce((a,d)=>a+(d.paid||0),0);
                    const totalRemain= debtList.reduce((a,d)=>a+(d.remaining||0),0);
                    const unpaidDebt = debtList.filter(d=>d.status!=='paid').length;
                    const debtRows   = debtList.map((d,i)=>{
                        const sc = d.status==='paid'?'badge-green':d.status==='partial'?'badge-yellow':'badge-red';
                        const sl = d.status==='paid'?'Lunas':d.status==='partial'?'Dicicil':'Belum';
                        const rowStyle = d.status!=='paid' ? ' style="background:#fff7ed;"' : '';
                        return '<tr'+rowStyle+'>'
                            +'<td class="center">'+(i+1)+'</td>'
                            +'<td><strong>'+esc(d.customerName||'-')+'</strong>'+(d.invoiceNo?'<br/><span style="font-size:8px;color:#64748b;">'+esc(d.invoiceNo)+'</span>':'')+'</td>'
                            +'<td class="small">'+esc(d.description||'-')+'</td>'
                            +'<td>'+fmtDate(d.createdAt)+'</td>'
                            +'<td>'+(d.dueDate?esc(d.dueDate):'-')+'</td>'
                            +'<td class="num">'+fmt(d.amount)+'</td>'
                            +'<td class="num text-green">'+fmt(d.paid||0)+'</td>'
                            +'<td class="num '+(d.remaining>0?'text-red':'')+'">'+fmt(d.remaining||0)+'</td>'
                            +'<td class="center"><span class="badge '+sc+'">'+sl+'</span></td>'
                            +'</tr>';
                    }).join('');
                    tableHtml = '<div class="kpi-grid">'
                        +'<div class="kpi-card"><div class="kpi-label">Total '+( isPayable?'Utang':'Piutang')+'</div><div class="kpi-val '+colorA+'">'+debtList.length+'</div></div>'
                        +'<div class="kpi-card"><div class="kpi-label">Total Nominal</div><div class="kpi-val">'+fmt(totalAmt)+'</div></div>'
                        +'<div class="kpi-card"><div class="kpi-label">Sudah Dibayar</div><div class="kpi-val text-green">'+fmt(totalPaid)+'</div></div>'
                        +'<div class="kpi-card"><div class="kpi-label">Sisa</div><div class="kpi-val '+colorA+'">'+fmt(totalRemain)+'</div></div>'
                        +'<div class="kpi-card"><div class="kpi-label">Belum Lunas ‚ö†Ô∏è</div><div class="kpi-val text-red">'+unpaidDebt+'</div></div>'
                        +'</div>'
                        +'<table><thead><tr>'
                        +'<th class="center">No</th>'
                        +'<th>'+(isPayable?'Vendor':'Pelanggan')+'</th>'
                        +'<th>Keterangan</th>'
                        +'<th>Tanggal</th>'
                        +'<th>Jatuh Tempo</th>'
                        +'<th class="num">Total</th>'
                        +'<th class="num">Dibayar</th>'
                        +'<th class="num">Sisa</th>'
                        +'<th class="center">Status</th>'
                        +'</tr></thead>'
                        +'<tbody>'+(debtRows||'<tr><td colspan="9" class="center">Tidak ada data</td></tr>')+'</tbody>'
                        +'<tfoot><tr><td colspan="5" class="bold-row">Total ('+debtList.length+')</td>'
                        +'<td class="num bold-row">'+fmt(totalAmt)+'</td>'
                        +'<td class="num bold-row text-green">'+fmt(totalPaid)+'</td>'
                        +'<td class="num bold-row '+colorA+'">'+fmt(totalRemain)+'</td>'
                        +'<td></td></tr></tfoot></table>'
                        +(unpaidDebt>0?'<p style="margin-top:8px;font-size:9px;color:#dc2626;"><strong>‚ö†Ô∏è Baris oranye</strong> = belum lunas</p>':'');
                } else if (tab === 'profitloss') {
                    const income = filteredTrans.filter(t=>t.type==='income');
                    const expense = filteredTrans.filter(t=>t.type==='expense');
                    const totalIn  = income.reduce((a,b)=>a+(b.amount||0),0);
                    const totalExp = expense.reduce((a,b)=>a+(b.amount||0),0);
                    const pl = totalIn - totalExp;
                    const incRows = income.map((t,i)=>'<tr><td class="center">'+(i+1)+'</td><td>'+fmtDate(t.date||t.createdAt)+'</td><td>'+esc(t.description||t.note||'-')+'</td><td class="num text-green">'+fmt(t.amount)+'</td><td class="center">Pemasukan</td></tr>').join('');
                    const expRows = expense.map((t,i)=>'<tr><td class="center">'+(i+1)+'</td><td>'+fmtDate(t.date||t.createdAt)+'</td><td>'+esc(t.description||t.note||'-')+'</td><td class="num text-red">'+fmt(t.amount)+'</td><td class="center">Pengeluaran</td></tr>').join('');
                    tableHtml = `
                    <div class="kpi-grid">
                        <div class="kpi-card"><div class="kpi-label">Total Pemasukan</div><div class="kpi-val text-green">${fmt(totalIn)}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Total Pengeluaran</div><div class="kpi-val text-red">${fmt(totalExp)}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Profit / Loss</div><div class="kpi-val ${pl>=0?'text-green':'text-red'}">${fmt(pl)}</div></div>
                    </div>
                    <h3 style="margin:16px 0 6px;font-size:12px;color:#374151;text-transform:uppercase;letter-spacing:.05em;">Rincian Transaksi</h3>
                    <table><thead><tr><th class="center">No</th><th>Tanggal</th><th>Keterangan</th><th class="num">Jumlah</th><th class="center">Tipe</th></tr></thead>
                    <tbody>${(incRows+expRows)||'<tr><td colspan="5" class="center">Tidak ada data</td></tr>'}</tbody>
                    <tfoot><tr><td colspan="3" class="bold-row">Profit / Loss Net</td><td class="num bold-row ${pl>=0?'text-green':'text-red'}">${fmt(pl)}</td><td></td></tr></tfoot></table>`;
                }

                const logoHtml = storeLogo
                    ? `<img src="${storeLogo}" class="store-logo" onerror="this.style.display='none'"/>`
                    : `<div class="store-logo-placeholder">${storeName.charAt(0).toUpperCase()}</div>`;

                const html = `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"/>
<title>Laporan ${tabTitle} - ${storeName}</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Segoe UI',Arial,sans-serif;font-size:11px;color:#1e293b;background:#fff;padding:24px;}
  @page{size:A4;margin:18mm 15mm;}
  @media print{body{padding:0;} .no-print{display:none;}}

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header{display:flex;align-items:center;gap:14px;border-bottom:3px solid #1e40af;padding-bottom:12px;margin-bottom:16px;}
  .store-logo{width:56px;height:56px;object-fit:contain;border-radius:8px;border:1px solid #e2e8f0;}
  .store-logo-placeholder{width:56px;height:56px;background:linear-gradient(135deg,#1d4ed8,#3b82f6);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;color:#fff;}
  .store-info{flex:1;}
  .store-name{font-size:18px;font-weight:900;color:#1e3a8a;letter-spacing:.02em;text-transform:uppercase;}
  .store-sub{font-size:10px;color:#64748b;margin-top:2px;}
  .report-title-box{text-align:right;}
  .report-title{font-size:14px;font-weight:800;color:#1e40af;text-transform:uppercase;letter-spacing:.04em;}
  .report-meta{font-size:10px;color:#64748b;margin-top:4px;line-height:1.6;}

  /* ‚îÄ‚îÄ Section title ‚îÄ‚îÄ */
  .section-title{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:#fff;background:#1e40af;padding:6px 12px;border-radius:4px;margin-bottom:8px;}

  /* ‚îÄ‚îÄ KPI grid ‚îÄ‚îÄ */
  .kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
  .kpi-card{border:1px solid #e2e8f0;border-radius:6px;padding:10px 12px;background:#f8fafc;}
  .kpi-label{font-size:9px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;}
  .kpi-val{font-size:14px;font-weight:900;color:#1e293b;}

  /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
  table{width:100%;border-collapse:collapse;margin-bottom:16px;font-size:10px;}
  thead tr{background:#1e40af;color:#fff;}
  thead th{padding:7px 8px;text-align:left;font-weight:700;font-size:9px;text-transform:uppercase;letter-spacing:.05em;}
  tbody tr{border-bottom:1px solid #e2e8f0;}
  tbody tr:nth-child(even){background:#f8fafc;}
  tbody tr:hover{background:#eff6ff;}
  tbody td{padding:6px 8px;vertical-align:top;}
  tfoot tr{background:#1e3a8a;color:#fff;}
  tfoot td{padding:7px 8px;font-weight:700;}
  .bold-row{font-weight:800 !important;}
  .center{text-align:center;}
  .num{text-align:right;font-variant-numeric:tabular-nums;font-weight:600;}
  .small{max-width:180px;white-space:normal;word-break:break-word;}
  .text-green{color:#15803d;}
  .text-red{color:#dc2626;}
  .badge{display:inline-block;padding:2px 7px;border-radius:99px;font-size:9px;font-weight:700;}
  .badge-green{background:#dcfce7;color:#15803d;}
  .badge-yellow{background:#fef9c3;color:#a16207;}
  .badge-red{background:#fee2e2;color:#dc2626;}

  /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
  .footer{border-top:1px solid #cbd5e1;padding-top:10px;margin-top:8px;display:flex;justify-content:space-between;font-size:9px;color:#94a3b8;}
  .sign-block{text-align:center;margin-top:40px;}
  .sign-line{border-top:1px solid #334155;width:160px;margin:0 auto 4px;padding-top:4px;font-size:10px;color:#334155;}

  .print-btn{position:fixed;bottom:20px;right:20px;background:#1d4ed8;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;box-shadow:0 4px 12px rgba(29,78,216,.4);}
</style>
</head><body>

<div class="header">
  ${logoHtml}
  <div class="store-info">
    <div class="store-name">${storeName}</div>
    ${storeAddr ? `<div class="store-sub">üìç ${storeAddr}</div>` : ''}
    ${storePhone ? `<div class="store-sub">üìû ${storePhone}</div>` : ''}
  </div>
  <div class="report-title-box">
    <div class="report-title">Laporan ${tabTitle}</div>
    <div class="report-meta">
      Periode&nbsp;: <strong>${periodLabel}</strong><br/>
      Dicetak&nbsp;: ${printDate}<br/>
      Toko&nbsp;&nbsp;&nbsp;&nbsp;: ${storeName}
    </div>
  </div>
</div>

<div class="section-title">üìä Laporan ${tabTitle} ‚Äî ${periodLabel}</div>
${tableHtml}

<div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:20px;">
  <div style="font-size:9px;color:#94a3b8;">
    Dokumen ini digenerate otomatis oleh sistem iFix Pro Enterprise<br/>
    ${printDate}
  </div>
  <div class="sign-block">
    <div style="font-size:10px;color:#475569;margin-bottom:38px;">Dibuat oleh,</div>
    <div class="sign-line">( ________________________ )</div>
    <div style="font-size:9px;color:#64748b;">Pemilik / Admin ‚Äî ${storeName}</div>
  </div>
</div>

<div class="footer">
  <span>iFix Pro Enterprise ‚Äî Sistem Manajemen Toko Profesional</span>
  <span>Halaman 1</span>
</div>

<button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Cetak / Simpan PDF</button>
</body></html>`;

                // Render ke DOM sementara ‚Üí html2canvas ‚Üí jsPDF download
                const fileName = `Laporan_${tabTitle}_${storeName.replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,10)}.pdf`;

                // Buat container hidden dengan style + konten
                const tempWrap = document.createElement('div');
                tempWrap.id = '__pdf_report_render__';
                tempWrap.style.cssText = 'position:fixed;left:-9999px;top:0;width:794px;background:#fff;z-index:-1;padding:24px;font-family:Segoe UI,Arial,sans-serif;';

                // Sisipkan style
                const styleMatch = html.match(/<style>([\s\S]*?)<\/style>/);
                if (styleMatch) {
                    const styleEl = document.createElement('style');
                    styleEl.textContent = styleMatch[1];
                    tempWrap.appendChild(styleEl);
                }
                // Sisipkan body content (tanpa button & script)
                const bodyMatch = html.match(/<body>([\s\S]*)<\/body>/s) || html.match(/<body>([\s\S]*)$/s);
                if (bodyMatch) {
                    const inner = document.createElement('div');
                    inner.innerHTML = bodyMatch[1]
                        .replace(/<button[^>]*class="[^"]*print-btn[^"]*"[^>]*>[\s\S]*?<\/button>/gi, '')
                        .replace(/<script[\s\S]*?<\/script>/gi, '');
                    tempWrap.appendChild(inner);
                }
                document.body.appendChild(tempWrap);

                try {
                    // Tunggu render selesai
                    await new Promise(r => setTimeout(r, 200));
                    const canvas = await html2canvas(tempWrap, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        allowTaint: true,
                        windowWidth: 794
                    });
                    const imgData = canvas.toDataURL('image/jpeg', 0.92);
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', compress: true });
                    const pageW = pdf.internal.pageSize.getWidth();
                    const pageH = pdf.internal.pageSize.getHeight();
                    const imgW = pageW;
                    const imgH = (canvas.height * pageW) / canvas.width;
                    let yPos = 0;
                    let remaining = imgH;
                    let page = 0;
                    while (remaining > 0) {
                        if (page > 0) pdf.addPage();
                        const sliceH = Math.min(remaining, pageH);
                        pdf.addImage(imgData, 'JPEG', 0, -yPos, imgW, imgH, undefined, 'FAST');
                        yPos += pageH;
                        remaining -= pageH;
                        page++;
                    }
                    pdf.save(fileName);
                } catch(err) {
                    console.error('PDF export error:', err);
                    // Fallback: buka di tab baru
                    const w = window.open('', '_blank'); if (w) { w.document.write(html); w.document.close(); }
                } finally {
                    document.body.removeChild(tempWrap);
                }
            };

            const handleExportExcel = () => {
                alert('Export Excel akan segera tersedia. Untuk saat ini, gunakan Download PDF dan convert ke Excel.');
            };

            // ‚îÄ‚îÄ‚îÄ Laporan Komprehensif Bulanan / Tahunan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const handleExportComprehensive = async (type, year, month) => {
                setCompLoading(true);
                try {
                    const storeName  = activeStore?.name  || activeOwner?.name || 'iFix Pro';
                    const storeAddr  = activeStore?.address || '';
                    const storePhone = activeStore?.phone  || '';
                    const storeLogo  = activeStore?.logo   || '';
                    const printDate  = new Date().toLocaleDateString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
                    const fmt = (n) => new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', minimumFractionDigits:0 }).format(n||0);
                    const fmtDate = (v) => {
                        if (!v) return '-';
                        try { const d = v.seconds ? new Date(v.seconds*1000) : new Date(v); return d.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' }); } catch(e) { return '-'; }
                    };
                    const esc = (s) => String(s==null?'-':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
                    // A4 dimensions at 96dpi: 794√ó1123 px
                    const A4W = 794; const A4H = 1123;

                    // ‚îÄ‚îÄ Filter data berdasarkan periode ‚îÄ‚îÄ
                    const filterItem = (item) => {
                        const raw = item.createdAt || item.date;
                        if (!raw) return false;
                        const d = raw.seconds ? new Date(raw.seconds*1000) : new Date(raw);
                        if (type === 'monthly') return d.getFullYear() === year && (d.getMonth()+1) === month;
                        return d.getFullYear() === year;
                    };
                    const allServices  = (services  || []).filter(filterItem);
                    const allSales     = (sales     || []).filter(filterItem);
                    const allTrans     = (transactions || []).filter(t => {
                        const raw = t.date || t.createdAt;
                        if (!raw) return false;
                        const d = raw.seconds ? new Date(raw.seconds*1000) : new Date(raw);
                        if (type === 'monthly') return d.getFullYear() === year && (d.getMonth()+1) === month;
                        return d.getFullYear() === year;
                    });
                    const filterDebt = (d) => {
                        const raw = d.createdAt;
                        if (!raw) return false;
                        const dt = raw.seconds ? new Date(raw.seconds*1000) : new Date(raw);
                        if (type === 'monthly') return dt.getFullYear() === year && (dt.getMonth()+1) === month;
                        return dt.getFullYear() === year;
                    };
                    const allPayable    = payableDebts.filter(filterDebt);
                    const allReceivable = receivableDebts.filter(filterDebt);

                    const periodLabel = type === 'monthly'
                        ? MONTH_NAMES[month-1] + ' ' + year
                        : 'Tahun ' + year;
                    const reportTitle = type === 'monthly' ? 'LAPORAN BULANAN' : 'LAPORAN TAHUNAN';

                    // ‚îÄ‚îÄ KPI ringkasan ‚îÄ‚îÄ
                    const totalSalesAmt  = allSales.reduce((a,b)=>a+(parseFloat(b.total)||0),0);
                    const totalServiceEst= allServices.reduce((a,b)=>a+(parseFloat(b.costEstimate)||0),0);
                    const totalIncome    = allTrans.filter(t=>t.type==='income').reduce((a,b)=>a+(b.amount||0),0);
                    const totalExpense   = allTrans.filter(t=>t.type==='expense').reduce((a,b)=>a+(b.amount||0),0);
                    const netPL          = totalIncome - totalExpense;
                    const totalUtang     = allPayable.reduce((a,d)=>a+(d.remaining||0),0);
                    const totalPiutang   = allReceivable.reduce((a,d)=>a+(d.remaining||0),0);
                    const stockVal       = inventory.reduce((a,b)=>a+((parseFloat(b.sellPrice)||0)*(b.stock||0)),0);

                    // ‚îÄ‚îÄ CSS bersama: scoped di bawah .pdfwrap agar tidak bocor ke app ‚îÄ‚îÄ
                    const commonCSS = `
.pdfwrap *{margin:0;padding:0;box-sizing:border-box;}
.pdfwrap{font-family:"Segoe UI",Arial,sans-serif;font-size:11px;color:#1e293b;}
.pdfwrap table{width:100%;border-collapse:collapse;margin-bottom:14px;font-size:10px;}
.pdfwrap thead tr{background:#1e40af;color:#fff;}
.pdfwrap thead th{padding:6px 7px;text-align:left;font-weight:700;font-size:9px;text-transform:uppercase;}
.pdfwrap tbody tr{border-bottom:1px solid #e2e8f0;}
.pdfwrap tbody tr:nth-child(even){background:#f8fafc;}
.pdfwrap tbody td{padding:5px 7px;vertical-align:top;}
.pdfwrap tfoot tr{background:#1e3a8a;color:#fff;}
.pdfwrap tfoot td{padding:6px 7px;font-weight:700;}
.pdfwrap .bold-row{font-weight:800!important;}
.pdfwrap .center{text-align:center;}
.pdfwrap .num{text-align:right;font-variant-numeric:tabular-nums;font-weight:600;}
.pdfwrap .small{max-width:160px;white-space:normal;word-break:break-word;}
.pdfwrap .text-green{color:#15803d;}
.pdfwrap .text-red{color:#dc2626;}
.pdfwrap .badge{display:inline-block;padding:2px 6px;border-radius:99px;font-size:8px;font-weight:700;}
.pdfwrap .badge-green{background:#dcfce7;color:#15803d;}
.pdfwrap .badge-yellow{background:#fef9c3;color:#a16207;}
.pdfwrap .badge-red{background:#fee2e2;color:#dc2626;}
                    `;

                    // ‚îÄ‚îÄ Helper: page header HTML (pure inline styles, tanpa class) ‚îÄ‚îÄ
                    const pageHeaderHtml = '<div style="display:flex;align-items:center;gap:14px;border-bottom:3px solid #1e40af;padding-bottom:12px;margin-bottom:16px;">'
                        +(storeLogo
                            ? '<img src="'+storeLogo+'" style="width:52px;height:52px;object-fit:contain;border-radius:8px;flex-shrink:0;" onerror="this.style.display=\'none\'"/>'
                            : '<div style="width:52px;height:52px;background:linear-gradient(135deg,#1d4ed8,#3b82f6);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:#fff;flex-shrink:0;">'+storeName.charAt(0).toUpperCase()+'</div>')
                        +'<div style="flex:1;min-width:0;"><div style="font-size:15px;font-weight:900;color:#1e3a8a;text-transform:uppercase;">'+esc(storeName)+'</div>'
                        +(storeAddr?'<div style="font-size:9px;color:#64748b;margin-top:2px;">üìç '+esc(storeAddr)+'</div>':'')
                        +(storePhone?'<div style="font-size:9px;color:#64748b;">üìû '+esc(storePhone)+'</div>':'')+'</div>'
                        +'<div style="text-align:right;flex-shrink:0;">'
                        +'<div style="font-size:12px;font-weight:800;color:#1e40af;text-transform:uppercase;">'+reportTitle+'</div>'
                        +'<div style="font-size:9px;color:#64748b;margin-top:3px;line-height:1.6;">Periode: <strong>'+periodLabel+'</strong><br/>Dicetak: '+printDate+'</div>'
                        +'</div></div>';

                    const pgFooterHtml = '<div style="border-top:1px solid #cbd5e1;padding-top:6px;margin-top:16px;display:flex;justify-content:space-between;font-size:9px;color:#94a3b8;"><span>'+esc(storeName)+' ‚Äî '+reportTitle+' '+periodLabel+'</span><span>¬© '+year+'</span></div>';

                    // ‚îÄ‚îÄ COVER (halaman 1, tepat 1 halaman penuh) ‚îÄ‚îÄ
                    const coverHtml = '<div style="width:'+A4W+'px;height:'+A4H+'px;background:linear-gradient(135deg,#0f172a 0%,#1e3a8a 50%,#1d4ed8 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 48px;">'
                        +(storeLogo
                            ? '<img src="'+storeLogo+'" style="width:100px;height:100px;object-fit:contain;border-radius:16px;border:3px solid rgba(255,255,255,.3);margin-bottom:28px;" onerror="this.style.display=\'none\'"/>'
                            : '<div style="width:100px;height:100px;background:rgba(255,255,255,.15);border:3px solid rgba(255,255,255,.3);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:46px;font-weight:900;color:#fff;margin-bottom:28px;">'+storeName.charAt(0).toUpperCase()+'</div>')
                        +'<div style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);border-radius:50px;padding:7px 24px;font-size:11px;font-weight:700;color:rgba(255,255,255,.8);letter-spacing:.1em;text-transform:uppercase;margin-bottom:18px;">Laporan Resmi</div>'
                        +'<div style="font-size:38px;font-weight:900;color:#fff;text-align:center;letter-spacing:.02em;line-height:1.2;margin-bottom:10px;">'+reportTitle+'</div>'
                        +'<div style="font-size:22px;font-weight:700;color:#93c5fd;text-align:center;margin-bottom:36px;">'+periodLabel+'</div>'
                        +'<div style="width:90px;height:5px;background:linear-gradient(90deg,#60a5fa,#a78bfa);border-radius:3px;margin-bottom:36px;"></div>'
                        +'<div style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:14px;padding:24px 40px;text-align:center;">'
                        +'<div style="font-size:18px;font-weight:800;color:#fff;margin-bottom:8px;">'+esc(storeName)+'</div>'
                        +'<div style="font-size:11px;color:rgba(255,255,255,.6);line-height:2;">'
                        +(storeAddr?'üìç '+esc(storeAddr)+'<br/>':'')
                        +(storePhone?'üìû '+esc(storePhone):'')
                        +'</div></div>'
                        +'<div style="margin-top:48px;font-size:10px;color:rgba(255,255,255,.4);text-align:center;">Dicetak pada '+printDate+'</div>'
                        +'</div>';

                    // ‚îÄ‚îÄ SEKSI 1: Ringkasan Eksekutif ‚îÄ‚îÄ
                    const kpiGrid = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;">'
                        +'<div style="border:2px solid #3b82f6;border-radius:8px;padding:12px;background:#eff6ff;"><div style="font-size:9px;font-weight:700;color:#2563eb;text-transform:uppercase;">Total Penjualan</div><div style="font-size:16px;font-weight:900;color:#1d4ed8;margin-top:4px;">'+fmt(totalSalesAmt)+'</div><div style="font-size:9px;color:#64748b;">'+allSales.length+' transaksi</div></div>'
                        +'<div style="border:2px solid #8b5cf6;border-radius:8px;padding:12px;background:#f5f3ff;"><div style="font-size:9px;font-weight:700;color:#7c3aed;text-transform:uppercase;">Total Servis</div><div style="font-size:16px;font-weight:900;color:#6d28d9;margin-top:4px;">'+fmt(totalServiceEst)+'</div><div style="font-size:9px;color:#64748b;">'+allServices.length+' order</div></div>'
                        +'<div style="border:2px solid '+(netPL>=0?'#10b981':'#ef4444')+';border-radius:8px;padding:12px;background:'+(netPL>=0?'#ecfdf5':'#fef2f2')+'"><div style="font-size:9px;font-weight:700;color:'+(netPL>=0?'#059669':'#dc2626')+';text-transform:uppercase;">Net Profit/Loss</div><div style="font-size:16px;font-weight:900;color:'+(netPL>=0?'#047857':'#b91c1c')+';margin-top:4px;">'+fmt(netPL)+'</div><div style="font-size:9px;color:#64748b;">Pemasukan - Pengeluaran</div></div>'
                        +'<div style="border:2px solid #f59e0b;border-radius:8px;padding:12px;background:#fffbeb;"><div style="font-size:9px;font-weight:700;color:#d97706;text-transform:uppercase;">Nilai Stok</div><div style="font-size:14px;font-weight:900;color:#b45309;margin-top:4px;">'+fmt(stockVal)+'</div><div style="font-size:9px;color:#64748b;">'+inventory.length+' SKU</div></div>'
                        +'<div style="border:2px solid #ef4444;border-radius:8px;padding:12px;background:#fff1f2;"><div style="font-size:9px;font-weight:700;color:#dc2626;text-transform:uppercase;">Total Utang</div><div style="font-size:14px;font-weight:900;color:#b91c1c;margin-top:4px;">'+fmt(totalUtang)+'</div><div style="font-size:9px;color:#64748b;">'+allPayable.length+' tagihan</div></div>'
                        +'<div style="border:2px solid #10b981;border-radius:8px;padding:12px;background:#ecfdf5;"><div style="font-size:9px;font-weight:700;color:#059669;text-transform:uppercase;">Total Piutang</div><div style="font-size:14px;font-weight:900;color:#047857;margin-top:4px;">'+fmt(totalPiutang)+'</div><div style="font-size:9px;color:#64748b;">'+allReceivable.length+' tagihan</div></div>'
                        +'</div>';

                    const sec1Html = '<div style="padding:24px;">'
                        +pageHeaderHtml
                        +'<div style="font-size:13px;font-weight:900;color:#1e3a8a;text-transform:uppercase;margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid #e2e8f0;">üìä Ringkasan Eksekutif ‚Äî '+periodLabel+'</div>'
                        +kpiGrid
                        +'<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:8px;">'
                        +'<div style="background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:12px;"><div style="font-size:9px;color:#15803d;font-weight:700;text-transform:uppercase;">Total Pemasukan</div><div style="font-size:16px;font-weight:900;color:#15803d;margin-top:4px;">'+fmt(totalIncome)+'</div><div style="font-size:9px;color:#64748b;">'+allTrans.filter(t=>t.type==='income').length+' transaksi</div></div>'
                        +'<div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:6px;padding:12px;"><div style="font-size:9px;color:#dc2626;font-weight:700;text-transform:uppercase;">Total Pengeluaran</div><div style="font-size:16px;font-weight:900;color:#dc2626;margin-top:4px;">'+fmt(totalExpense)+'</div><div style="font-size:9px;color:#64748b;">'+allTrans.filter(t=>t.type==='expense').length+' transaksi</div></div>'
                        +'<div style="background:'+(netPL>=0?'#ecfdf5':'#fff7ed')+';border:1px solid '+(netPL>=0?'#6ee7b7':'#fed7aa')+';border-radius:6px;padding:12px;"><div style="font-size:9px;color:'+(netPL>=0?'#059669':'#ea580c')+';font-weight:700;text-transform:uppercase;">Net P/L</div><div style="font-size:16px;font-weight:900;color:'+(netPL>=0?'#047857':'#c2410c')+';margin-top:4px;">'+fmt(netPL)+'</div></div>'
                        +'</div>'
                        +pgFooterHtml+'</div>';

                    // ‚îÄ‚îÄ SEKSI 2: Penjualan ‚îÄ‚îÄ
                    const salesRows = allSales.map((s,i) => {
                        const items = (s.items||[]).map(it=>esc(it.name||it.productName||'')+' x'+(it.qty||1)).join(', ');
                        return '<tr><td class="center">'+(i+1)+'</td><td>'+fmtDate(s.date||s.createdAt)+'</td><td>'+esc(s.customerName||'-')+'</td><td class="small">'+(items||'-')+'</td><td class="num">'+fmt(s.total)+'</td><td class="center"><span class="badge '+(s.type==='return'?'badge-red':'badge-green')+'">'+(s.type==='return'?'Return':'Jual')+'</span></td></tr>';
                    }).join('');
                    const sec2Html = '<div style="padding:24px;">'
                        +pageHeaderHtml
                        +'<div style="background:#1d4ed8;color:#fff;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">üõí Data Penjualan</div>'
                        +'<table><thead><tr><th class="center">No</th><th>Tanggal</th><th>Pelanggan</th><th>Item</th><th class="num">Total</th><th class="center">Tipe</th></tr></thead>'
                        +'<tbody>'+(salesRows||'<tr><td colspan="6" class="center">Tidak ada transaksi penjualan</td></tr>')+'</tbody>'
                        +'<tfoot><tr><td colspan="4" class="bold-row">Total ('+allSales.length+' transaksi)</td><td class="num bold-row">'+fmt(totalSalesAmt)+'</td><td></td></tr></tfoot></table>'
                        +pgFooterHtml+'</div>';

                    // ‚îÄ‚îÄ SEKSI 3: Servis ‚îÄ‚îÄ
                    const srvRows = allServices.map((s,i) => {
                        const sc  = s.status==='Selesai'?'badge-green':s.status==='Batal'?'badge-red':'badge-yellow';
                        const pc  = (s.paymentStatus||'Belum Lunas')==='Lunas'?'badge-green':(s.paymentStatus||'')==='DP'?'badge-yellow':'badge-red';
                        const est = parseFloat(s.costEstimate)||0;
                        const dp  = parseFloat(s.downPayment||s.dp)||0;
                        const sisa= Math.max(0,est-dp);
                        return '<tr'+(s.paymentStatus!=='Lunas'?' style="background:#fff7ed;"':'')+'><td class="center">'+(i+1)+'</td><td>'+fmtDate(s.createdAt)+'</td><td>'+esc(s.customerName||'-')+'</td><td>'+esc(s.unitType||s.deviceType||s.deviceModel||'-')+'</td><td class="small">'+esc(s.complaint||s.problem||s.problemDescription||'-')+'</td><td class="center"><span class="badge '+sc+'">'+esc(s.status||'-')+'</span></td><td class="num">'+fmt(est)+'</td><td class="num">'+fmt(dp)+'</td><td class="num'+(sisa>0?' text-red':'')+'">'+fmt(sisa)+'</td><td class="center"><span class="badge '+pc+'">'+esc(s.paymentStatus||'Belum Lunas')+'</span></td></tr>';
                    }).join('');
                    const sec3Html = '<div style="padding:24px;">'
                        +pageHeaderHtml
                        +'<div style="background:#7c3aed;color:#fff;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">üîß Data Servis</div>'
                        +'<table><thead><tr><th class="center">No</th><th>Tanggal</th><th>Pelanggan</th><th>Device</th><th>Keluhan</th><th class="center">Status</th><th class="num">Estimasi</th><th class="num">DP</th><th class="num">Sisa</th><th class="center">Bayar</th></tr></thead>'
                        +'<tbody>'+(srvRows||'<tr><td colspan="10" class="center">Tidak ada data servis</td></tr>')+'</tbody>'
                        +'<tfoot><tr><td colspan="6" class="bold-row">Total ('+allServices.length+' order)</td><td class="num bold-row">'+fmt(totalServiceEst)+'</td><td class="num bold-row">'+fmt(allServices.reduce((a,b)=>a+(parseFloat(b.downPayment||b.dp)||0),0))+'</td><td class="num bold-row text-red">'+fmt(allServices.reduce((a,b)=>a+Math.max(0,(parseFloat(b.costEstimate)||0)-(parseFloat(b.downPayment||b.dp)||0)),0))+'</td><td></td></tr></tfoot></table>'
                        +pgFooterHtml+'</div>';

                    // ‚îÄ‚îÄ SEKSI 4: Inventaris ‚îÄ‚îÄ
                    const invSorted = [...inventory].sort((a,b)=>(a.category||'').localeCompare(b.category||''));
                    const invRows = invSorted.map((item,i)=>{
                        const sv = (parseFloat(item.sellPrice)||0)*(item.stock||0);
                        const isLow = item.minStock && (item.stock||0) <= item.minStock;
                        return '<tr'+(isLow?' style="background:#fff7ed;"':'')+'><td class="center">'+(i+1)+'</td><td>'+(item.brand?'<span style="font-size:8px;background:#f1f5f9;border-radius:3px;padding:1px 4px;color:#475569;">'+esc(item.brand)+'</span> ':'')+'<strong>'+esc(item.name||'-')+'</strong></td><td>'+esc(item.category||'-')+(item.subCategory?'<br/><span style="font-size:8px;color:#0284c7;">‚Üí'+esc(item.subCategory)+'</span>':'')+'</td><td class="center">'+(item.unit||'-')+'</td><td class="center'+(isLow?' text-red':'')+'">'+(item.stock||0)+(item.minStock?'<span style="font-size:8px;color:#94a3b8;"> /min:'+item.minStock+'</span>':'')+'</td><td class="num">'+fmt(item.sellPrice)+'</td><td class="num">'+fmt(sv)+'</td></tr>';
                    }).join('');
                    const sec4Html = '<div style="padding:24px;">'
                        +pageHeaderHtml
                        +'<div style="background:#d97706;color:#fff;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">üì¶ Snapshot Stok Inventaris (Saat Ini)</div>'
                        +'<table><thead><tr><th class="center">No</th><th>Nama Barang</th><th>Kategori</th><th class="center">Satuan</th><th class="center">Stok</th><th class="num">H.Jual</th><th class="num">Nilai</th></tr></thead>'
                        +'<tbody>'+(invRows||'<tr><td colspan="7" class="center">Tidak ada data</td></tr>')+'</tbody>'
                        +'<tfoot><tr><td colspan="4" class="bold-row">Total ('+invSorted.length+' SKU)</td><td class="center bold-row">'+invSorted.reduce((a,b)=>a+(b.stock||0),0)+'</td><td></td><td class="num bold-row">'+fmt(stockVal)+'</td></tr></tfoot></table>'
                        +pgFooterHtml+'</div>';

                    // ‚îÄ‚îÄ SEKSI 5: Profit / Loss ‚îÄ‚îÄ
                    const incTrans = allTrans.filter(t=>t.type==='income');
                    const expTrans = allTrans.filter(t=>t.type==='expense');
                    const incRows  = incTrans.map((t,i)=>'<tr style="background:#f0fdf4;"><td class="center">'+(i+1)+'</td><td>'+fmtDate(t.date||t.createdAt)+'</td><td>'+esc(t.description||t.note||'-')+'</td><td class="num text-green">'+fmt(t.amount)+'</td></tr>').join('');
                    const expRows  = expTrans.map((t,i)=>'<tr><td class="center">'+(i+1)+'</td><td>'+fmtDate(t.date||t.createdAt)+'</td><td>'+esc(t.description||t.note||'-')+'</td><td class="num text-red">'+fmt(t.amount)+'</td></tr>').join('');
                    const sec5Html = '<div style="padding:24px;">'
                        +pageHeaderHtml
                        +'<div style="background:#059669;color:#fff;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">üí∞ Profit &amp; Loss</div>'
                        +'<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px;">'
                        +'<div style="background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:10px;"><div style="font-size:9px;color:#15803d;font-weight:700;text-transform:uppercase;">Total Pemasukan</div><div style="font-size:15px;font-weight:900;color:#15803d;margin-top:4px;">'+fmt(totalIncome)+'</div></div>'
                        +'<div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:6px;padding:10px;"><div style="font-size:9px;color:#dc2626;font-weight:700;text-transform:uppercase;">Total Pengeluaran</div><div style="font-size:15px;font-weight:900;color:#dc2626;margin-top:4px;">'+fmt(totalExpense)+'</div></div>'
                        +'<div style="background:'+(netPL>=0?'#ecfdf5':'#fff7ed')+';border:1px solid '+(netPL>=0?'#6ee7b7':'#fed7aa')+';border-radius:6px;padding:10px;"><div style="font-size:9px;color:'+(netPL>=0?'#059669':'#ea580c')+';font-weight:700;text-transform:uppercase;">Net Profit/Loss</div><div style="font-size:15px;font-weight:900;color:'+(netPL>=0?'#047857':'#c2410c')+';margin-top:4px;">'+fmt(netPL)+'</div></div>'
                        +'</div>'
                        +'<table><thead><tr><th class="center">No</th><th>Tanggal</th><th>Keterangan</th><th class="num">Jumlah</th></tr></thead>'
                        +'<tbody>'+(incRows+expRows||'<tr><td colspan="4" class="center">Tidak ada transaksi</td></tr>')+'</tbody>'
                        +'<tfoot><tr><td colspan="3" class="bold-row">Net Profit / Loss</td><td class="num bold-row '+(netPL>=0?'text-green':'text-red')+'">'+fmt(netPL)+'</td></tr></tfoot></table>'
                        +pgFooterHtml+'</div>';

                    // ‚îÄ‚îÄ SEKSI 6: Utang ‚îÄ‚îÄ
                    const utangRows = allPayable.map((d,i)=>{
                        const sc = d.status==='paid'?'badge-green':d.status==='partial'?'badge-yellow':'badge-red';
                        const sl = d.status==='paid'?'Lunas':d.status==='partial'?'Dicicil':'Belum';
                        return '<tr'+(d.status!=='paid'?' style="background:#fff7ed;"':'')+'><td class="center">'+(i+1)+'</td><td><strong>'+esc(d.customerName||'-')+'</strong>'+(d.invoiceNo?'<br/><span style="font-size:8px;color:#64748b;">'+esc(d.invoiceNo)+'</span>':'')+'</td><td class="small">'+esc(d.description||'-')+'</td><td>'+fmtDate(d.createdAt)+'</td><td>'+(d.dueDate||'-')+'</td><td class="num">'+fmt(d.amount)+'</td><td class="num text-green">'+fmt(d.paid||0)+'</td><td class="num text-red">'+fmt(d.remaining||0)+'</td><td class="center"><span class="badge '+sc+'">'+sl+'</span></td></tr>';
                    }).join('');
                    const sec6Html = '<div style="padding:24px;">'
                        +pageHeaderHtml
                        +'<div style="background:#dc2626;color:#fff;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">üì§ Utang (Harus Dibayar)</div>'
                        +'<table><thead><tr><th class="center">No</th><th>Vendor</th><th>Keterangan</th><th>Tanggal</th><th>J.Tempo</th><th class="num">Total</th><th class="num">Dibayar</th><th class="num">Sisa</th><th class="center">Status</th></tr></thead>'
                        +'<tbody>'+(utangRows||'<tr><td colspan="9" class="center">Tidak ada utang periode ini</td></tr>')+'</tbody>'
                        +'<tfoot><tr><td colspan="5" class="bold-row">Total Utang</td><td class="num bold-row">'+fmt(allPayable.reduce((a,d)=>a+(d.amount||0),0))+'</td><td class="num bold-row text-green">'+fmt(allPayable.reduce((a,d)=>a+(d.paid||0),0))+'</td><td class="num bold-row text-red">'+fmt(totalUtang)+'</td><td></td></tr></tfoot></table>'
                        +pgFooterHtml+'</div>';

                    // ‚îÄ‚îÄ SEKSI 7: Piutang ‚îÄ‚îÄ
                    const piutangRows = allReceivable.map((d,i)=>{
                        const sc = d.status==='paid'?'badge-green':d.status==='partial'?'badge-yellow':'badge-red';
                        const sl = d.status==='paid'?'Lunas':d.status==='partial'?'Dicicil':'Belum';
                        return '<tr'+(d.status!=='paid'?' style="background:#fff7ed;"':'')+'><td class="center">'+(i+1)+'</td><td><strong>'+esc(d.customerName||'-')+'</strong>'+(d.invoiceNo?'<br/><span style="font-size:8px;color:#64748b;">'+esc(d.invoiceNo)+'</span>':'')+'</td><td class="small">'+esc(d.description||'-')+'</td><td>'+fmtDate(d.createdAt)+'</td><td>'+(d.dueDate||'-')+'</td><td class="num">'+fmt(d.amount)+'</td><td class="num text-green">'+fmt(d.paid||0)+'</td><td class="num text-green">'+fmt(d.remaining||0)+'</td><td class="center"><span class="badge '+sc+'">'+sl+'</span></td></tr>';
                    }).join('');
                    const sec7Html = '<div style="padding:24px;">'
                        +pageHeaderHtml
                        +'<div style="background:#059669;color:#fff;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">üì• Piutang (Harus Diterima)</div>'
                        +'<table><thead><tr><th class="center">No</th><th>Pelanggan</th><th>Keterangan</th><th>Tanggal</th><th>J.Tempo</th><th class="num">Total</th><th class="num">Dibayar</th><th class="num">Sisa</th><th class="center">Status</th></tr></thead>'
                        +'<tbody>'+(piutangRows||'<tr><td colspan="9" class="center">Tidak ada piutang periode ini</td></tr>')+'</tbody>'
                        +'<tfoot><tr><td colspan="5" class="bold-row">Total Piutang</td><td class="num bold-row">'+fmt(allReceivable.reduce((a,d)=>a+(d.amount||0),0))+'</td><td class="num bold-row text-green">'+fmt(allReceivable.reduce((a,d)=>a+(d.paid||0),0))+'</td><td class="num bold-row text-green">'+fmt(totalPiutang)+'</td><td></td></tr></tfoot></table>'
                        +'<div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:24px;">'
                        +'<div style="font-size:9px;color:#94a3b8;">Dokumen ini digenerate otomatis oleh sistem.<br/>'+printDate+'</div>'
                        +'<div style="text-align:center;"><div style="font-size:10px;color:#475569;margin-bottom:38px;">Mengetahui,</div><div style="border-top:1px solid #334155;width:160px;margin:0 auto 4px;padding-top:4px;font-size:10px;text-align:center;color:#334155;">( ________________________ )</div><div style="font-size:9px;color:#64748b;">'+esc(storeName)+'</div></div>'
                        +'</div>'
                        +pgFooterHtml+'</div>';

                    // ‚îÄ‚îÄ Render Helper: render div ‚Üí canvas ‚Üí tambah ke PDF ‚îÄ‚îÄ
                    const fileName = reportTitle.replace(/\s+/g,'_')+'_'+periodLabel.replace(/\s+/g,'_')+'_'+storeName.replace(/\s+/g,'_')+'.pdf';
                    const pdf = new jsPDF({ orientation:'p', unit:'mm', format:'a4', compress:true });
                    const pageW  = pdf.internal.pageSize.getWidth();
                    const pageH  = pdf.internal.pageSize.getHeight();

                    // Style di-inject ke <head>, scoped dengan .pdfwrap
                    const globalStyle = document.createElement('style');
                    globalStyle.id = '__pdf_report_style__';
                    globalStyle.textContent = commonCSS;
                    document.head.appendChild(globalStyle);

                    const renderSection = async (innerHtml, isCover) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'pdfwrap';
                        // Render on-screen (left:0) agar html2canvas bisa capture sempurna.
                        // Sembunyikan dari user dengan opacity:0 + pointer-events:none.
                        wrapper.style.cssText = 'position:fixed;left:0;top:0;width:'+A4W+'px;opacity:0;pointer-events:none;z-index:-1;';
                        if (isCover) {
                            wrapper.style.height = A4H + 'px';
                            wrapper.style.overflow = 'hidden';
                        } else {
                            wrapper.style.background = '#fff';
                        }
                        wrapper.innerHTML = innerHtml;
                        document.body.appendChild(wrapper);
                        // Tunggu layout browser settle
                        await new Promise(r => setTimeout(r, 350));
                        // html2canvas: ignore opacity saat capture
                        wrapper.style.opacity = '1';
                        const canvas = await html2canvas(wrapper, {
                            scale: 2, useCORS: true,
                            backgroundColor: isCover ? null : '#ffffff',
                            logging: false, allowTaint: true,
                            width: A4W,
                            height: isCover ? A4H : wrapper.scrollHeight,
                            windowWidth: A4W, scrollX: 0, scrollY: 0,
                            x: 0, y: 0
                        });
                        document.body.removeChild(wrapper);
                        const imgData = canvas.toDataURL('image/jpeg', 0.93);
                        if (isCover) {
                            pdf.addImage(imgData, 'JPEG', 0, 0, pageW, pageH, undefined, 'FAST');
                        } else {
                            pdf.addPage();
                            const imgHmm = (canvas.height / canvas.width) * pageW;
                            let yOff = 0; let rem = imgHmm; let pg = 0;
                            while (rem > 0.5) {
                                if (pg > 0) pdf.addPage();
                                pdf.addImage(imgData, 'JPEG', 0, -yOff, pageW, imgHmm, undefined, 'FAST');
                                yOff += pageH; rem -= pageH; pg++;
                            }
                        }
                    };

                    // ‚îÄ‚îÄ Render semua seksi ‚îÄ‚îÄ
                    await renderSection(coverHtml, true);       // Hal. 1 ‚Äî Cover
                    await renderSection(sec1Html, false);       // Hal. 2+ ‚Äî Ringkasan
                    await renderSection(sec2Html, false);       // Hal. baru ‚Äî Penjualan
                    await renderSection(sec3Html, false);       // Hal. baru ‚Äî Servis
                    await renderSection(sec4Html, false);       // Hal. baru ‚Äî Inventaris
                    await renderSection(sec5Html, false);       // Hal. baru ‚Äî P&L
                    await renderSection(sec6Html, false);       // Hal. baru ‚Äî Utang
                    await renderSection(sec7Html, false);       // Hal. baru ‚Äî Piutang

                    pdf.save(fileName);
                    const gs = document.getElementById('__pdf_report_style__');
                    if (gs) document.head.removeChild(gs);
                } catch(err) {
                    const gs = document.getElementById('__pdf_report_style__');
                    if (gs) document.head.removeChild(gs);
                    alert('Gagal generate laporan: '+err.message);
                } finally {
                    setCompLoading(false);
                    setCompModal(null);
                }
            };

            // Permission check (after hooks to comply with React Rules of Hooks)
            if (!checkPermission('menu_report')) {
                return (
                    <div className="p-10 text-center">
                        <div className="bg-red-50 border border-red-200 rounded-lg p-6 inline-block">
                            <Lock className="w-10 h-10 text-red-600 mx-auto mb-3"/>
                            <h2 className="text-lg font-bold text-red-600 mb-2">‚ùå Akses Ditolak</h2>
                            <p className="text-slate-600">Menu Laporan telah dikunci oleh Developer/Owner. Hubungi mereka untuk mendapatkan akses.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-4">
                    {/* ‚îÄ‚îÄ HEADER RESPONSIF ‚îÄ‚îÄ */}
                    <div className="flex flex-col gap-3">
                        {/* Baris 1: Judul + Filter Periode */}
                        <div className="flex items-center justify-between gap-2">
                            <h2 className="font-black text-xl md:text-2xl text-slate-800">üìà Laporan</h2>
                            <select value={dateRange} onChange={e => setDateRange(e.target.value)} className="border border-slate-300 px-3 py-2 rounded-xl text-sm font-bold bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                <option value="today">Hari Ini</option>
                                <option value="month">Bulan Ini</option>
                                <option value="year">Tahun Ini</option>
                            </select>
                        </div>
                        {/* Baris 2: Tombol Export */}
                        <div className="grid grid-cols-3 gap-2">
                            <button onClick={handleExportPDF} className="bg-red-500 text-white px-3 py-2.5 rounded-xl font-bold text-xs md:text-sm hover:bg-red-600 active:scale-95 flex items-center justify-center gap-1.5 shadow-sm">
                                <Download className="w-3.5 h-3.5 flex-shrink-0"/>
                                <span className="truncate">PDF Tab</span>
                            </button>
                            <button onClick={() => setCompModal('monthly')} className="bg-indigo-600 text-white px-3 py-2.5 rounded-xl font-bold text-xs md:text-sm hover:bg-indigo-700 active:scale-95 flex items-center justify-center gap-1.5 shadow-sm">
                                <FileText className="w-3.5 h-3.5 flex-shrink-0"/>
                                <span className="truncate">Bulanan</span>
                            </button>
                            <button onClick={() => setCompModal('yearly')} className="bg-purple-700 text-white px-3 py-2.5 rounded-xl font-bold text-xs md:text-sm hover:bg-purple-800 active:scale-95 flex items-center justify-center gap-1.5 shadow-sm">
                                <FileText className="w-3.5 h-3.5 flex-shrink-0"/>
                                <span className="truncate">Tahunan</span>
                            </button>
                        </div>
                    </div>

                    {/* ‚îÄ‚îÄ TAB BAR RESPONSIF ‚îÄ‚îÄ */}
                    <div className="bg-white rounded-2xl p-1.5 border border-slate-200 shadow-sm">
                        <div className="flex gap-1 overflow-x-auto scrollbar-hide">
                            {[
                                { id: 'summary',   icon: 'üìä', label: 'Ringkasan' },
                                { id: 'sales',     icon: 'üõí', label: 'Penjualan' },
                                { id: 'service',   icon: 'üîß', label: 'Servis' },
                                { id: 'inventory', icon: 'üì¶', label: 'Stok' },
                                { id: 'profitloss',icon: 'üí∞', label: 'P/L' },
                                { id: 'payable',   icon: 'üì§', label: 'Utang' },
                                { id: 'receivable',icon: 'üì•', label: 'Piutang' },
                            ].map(t => (
                                <button key={t.id} onClick={() => setTab(t.id)}
                                    className={`flex-1 min-w-[64px] flex flex-col items-center gap-0.5 px-2 py-2 rounded-xl text-[10px] md:text-xs font-bold transition-all whitespace-nowrap ${
                                        tab === t.id
                                            ? 'bg-blue-600 text-white shadow-md'
                                            : 'text-slate-500 hover:bg-slate-100 hover:text-slate-700'
                                    }`}>
                                    <span className="text-base leading-none">{t.icon}</span>
                                    <span>{t.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    {tab === 'summary' && (
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                <button onClick={() => setDetailModal({ title: 'üì± Total Servis', type: 'service-list', data: filteredServices })} className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-blue-700 font-bold uppercase mb-1 truncate">Total Servis</p>
                                    <h3 className="text-lg md:text-xl font-black text-blue-600 truncate">{totalServices}</h3>
                                    <p className="text-[10px] text-blue-600 mt-1 truncate">‚úÖ {completedServices} selesai</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üõí Total Penjualan', type: 'sales-list', data: filteredSales })} className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border-2 border-green-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-green-700 font-bold uppercase mb-1 truncate">Total Penjualan</p>
                                    <h3 className="text-lg md:text-xl font-black text-green-600 truncate">{formatCurrency(totalSales)}</h3>
                                    <p className="text-[10px] text-red-600 mt-1 truncate">‚Ü©Ô∏è {formatCurrency(totalReturns)}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üìä Transaksi Penjualan', type: 'sales-list', data: filteredSales })} className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border-2 border-purple-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-purple-700 font-bold uppercase mb-1 truncate">Total Transaksi</p>
                                    <h3 className="text-lg md:text-xl font-black text-purple-600 truncate">{filteredSales.length}</h3>
                                    <p className="text-[10px] text-purple-600 mt-1 truncate">Avg: {formatCurrency(filteredSales.length > 0 ? totalSales / filteredSales.length : 0)}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üí∞ Profit Penjualan', type: 'profit-list', data: filteredSales })} className="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border-2 border-emerald-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-emerald-700 font-bold uppercase mb-1 truncate">Profit Penjualan</p>
                                    <h3 className="text-lg md:text-xl font-black text-emerald-600 truncate">
                                        {formatCurrency(filteredSales.reduce((a, b) => {
                                            const profit = b.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                            return a + profit;
                                        }, 0))}
                                    </h3>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì• Pemasukan', type: 'income-list', data: filteredTrans.filter(t => t.type === 'income') })} className="bg-gradient-to-br from-violet-50 to-violet-100 p-4 rounded-xl border-2 border-violet-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-violet-700 font-bold uppercase mb-1 truncate">Pemasukan</p>
                                    <h3 className="text-lg md:text-xl font-black text-violet-600 truncate">{formatCurrency(serviceIncome)}</h3>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì§ Pengeluaran', type: 'expense-list', data: filteredTrans.filter(t => t.type === 'expense') })} className="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl border-2 border-red-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-red-700 font-bold uppercase mb-1 truncate">Pengeluaran</p>
                                    <h3 className="text-lg md:text-xl font-black text-red-600 truncate">{formatCurrency(serviceExpense)}</h3>
                                </button>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <button onClick={() => setDetailModal({ title: 'üìä Profit/Loss', type: 'profitloss-detail', data: { income: serviceIncome, expense: serviceExpense, profit: serviceProfitLoss, incomeData: filteredTrans.filter(t => t.type === 'income'), expenseData: filteredTrans.filter(t => t.type === 'expense') } })} className={`${serviceProfitLoss >= 0 ? 'bg-gradient-to-br from-green-50 to-green-100 border-green-200' : 'bg-gradient-to-br from-red-50 to-red-100 border-red-200'} p-6 rounded-xl border-2 text-left hover:shadow-lg hover:scale-[1.01] transition-all cursor-pointer`}>
                                    <h3 className={`font-bold mb-2 text-sm ${serviceProfitLoss >= 0 ? 'text-green-700' : 'text-red-700'}`}>üìä Profit/Loss Periode Ini</h3>
                                    <div className={`text-2xl md:text-3xl font-black truncate ${serviceProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(serviceProfitLoss)}</div>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì¶ Nilai Stok Barang', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl border-2 border-orange-200 text-left hover:shadow-lg hover:scale-[1.01] transition-all cursor-pointer">
                                    <h3 className="font-bold text-orange-700 mb-2 text-sm">üì¶ Nilai Stok Barang</h3>
                                    <div className="text-2xl md:text-3xl font-black text-orange-600 truncate">{formatCurrency(inventoryValue)}</div>
                                    <p className="text-xs text-orange-600 mt-2">{inventoryAggregation.totalStock} pcs ({inventoryAggregation.totalItems} item)</p>
                                </button>
                            </div>

                            <div className="bg-white p-6 rounded-xl border border-slate-200">
                                <h3 className="font-bold text-slate-800 mb-4">üèÜ Top 5 Produk (Nilai Stok Terbesar)</h3>
                                <div className="space-y-2">
                                    {topItems.map((item, idx) => {
                                        const totalValue = parseFloat(item.sellPrice) * item.stock;
                                        const profitValue = ((parseFloat(item.sellPrice) - parseFloat(item.buyPrice || 0)) * item.stock);
                                        return (
                                            <div key={item.id} className="p-3 bg-gradient-to-r from-slate-50 to-slate-100 rounded-lg border border-slate-200 hover:shadow-md transition-shadow">
                                                <div className="flex justify-between items-start mb-1">
                                                    <div className="flex-1">
                                                        <p className="font-bold text-slate-800">{idx + 1}. {item.name}</p>
                                                        <p className="text-xs text-slate-500">üì¶ {item.category || 'No Category'} ‚Ä¢ Stok: {item.stock} pcs</p>
                                                    </div>
                                                    <div className="text-right ml-3">
                                                        <p className="font-bold text-green-600 text-lg">{formatCurrency(totalValue)}</p>
                                                        <p className="text-xs text-emerald-600">Profit: {formatCurrency(profitValue)}</p>
                                                    </div>
                                                </div>
                                                <div className="w-full bg-slate-300 rounded-full h-2">
                                                    <div 
                                                        className="bg-gradient-to-r from-green-400 to-emerald-600 h-2 rounded-full transition-all"
                                                        style={{width: `${Math.min(100, (totalValue / ((parseFloat(topItems[0]?.sellPrice || 0) * (topItems[0]?.stock || 1)) || 1)) * 100)}%`}}
                                                    ></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'sales' && (
                        <div className="space-y-4">
                            {/* ‚úÖ Filter Bar Kategori, Sub Kategori, Pelanggan */}
                            <div className="bg-white rounded-xl border border-slate-200 p-4">
                                <div className="flex flex-wrap items-end gap-3">
                                    <div className="flex-1 min-w-[160px]">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Cari Pelanggan / Nama Barang</label>
                                        <input
                                            type="text"
                                            value={filterCustomer}
                                            onChange={e => { setFilterCustomer(e.target.value); setSalesCurrentPage(1); }}
                                            placeholder="Nama pelanggan atau nama barang..."
                                            className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                                        />
                                    </div>
                                    <div className="flex-1 min-w-[140px]">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Kategori</label>
                                        <select
                                            value={filterCat}
                                            onChange={e => { setFilterCat(e.target.value); setFilterSubCat(''); setSalesCurrentPage(1); }}
                                            className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-500"
                                        >
                                            <option value="">Semua Kategori</option>
                                            {allSalesCategories.map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex-1 min-w-[140px]">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Sub Kategori</label>
                                        <select
                                            value={filterSubCat}
                                            onChange={e => { setFilterSubCat(e.target.value); setSalesCurrentPage(1); }}
                                            className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-500"
                                            disabled={allSalesSubCategories.length === 0}
                                        >
                                            <option value="">Semua Sub Kategori</option>
                                            {allSalesSubCategories.map(sc => (
                                                <option key={sc} value={sc}>{sc}</option>
                                            ))}
                                        </select>
                                    </div>
                                    {(filterCat || filterSubCat || filterCustomer) && (
                                        <button
                                            onClick={() => { setFilterCat(''); setFilterSubCat(''); setFilterCustomer(''); setSalesCurrentPage(1); }}
                                            className="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-bold hover:bg-red-200 flex items-center gap-1 whitespace-nowrap"
                                        >
                                            ‚úï Reset Filter
                                        </button>
                                    )}
                                    <div className="text-sm text-slate-500 whitespace-nowrap">
                                        {filteredSalesByCat.length} transaksi
                                        {(filterCat || filterSubCat || filterCustomer) && (
                                            <span className="ml-1 text-blue-600 font-bold">(difilter)</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                            {/* ‚îÄ‚îÄ Mobile: Card View ‚îÄ‚îÄ */}
                            <div className="md:hidden space-y-3">
                                {paginatedSales.map((s, i) => {
                                    const profit = s.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                    const itemsText = s.items?.map(it => `${it.name} x${it.qty}`).join(', ') || '-';
                                    return (
                                        <div key={i} className={`bg-white rounded-2xl border shadow-sm overflow-hidden ${s.type === 'return' ? 'border-red-200' : 'border-slate-200'}`}>
                                            <div className={`px-4 py-2.5 flex items-center justify-between ${s.type === 'return' ? 'bg-red-50' : 'bg-slate-50'}`}>
                                                <div>
                                                    <p className="font-black text-slate-800 text-sm">{s.customerName || 'Umum'}</p>
                                                    <p className="text-xs text-slate-500">{formatDate(s.createdAt)}</p>
                                                </div>
                                                <div className="flex flex-col items-end gap-1">
                                                    <span className={`text-xs font-bold px-2.5 py-1 rounded-full ${s.paymentMethod === 'credit' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`}>
                                                        {s.paymentMethod === 'credit' ? 'Piutang' : s.paymentMethod === 'transfer' ? 'Transfer' : s.paymentMethod === 'card' ? 'Kartu' : 'Kas'}
                                                    </span>
                                                    {s.type === 'return' && <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-red-100 text-red-700">‚Ü© Return</span>}
                                                </div>
                                            </div>
                                            <div className="px-4 py-3">
                                                <p className="text-xs text-slate-600 mb-2 line-clamp-2">üõí {itemsText}</p>
                                                <div className="grid grid-cols-3 gap-2 bg-slate-50 rounded-xl p-2.5">
                                                    <div className="text-center">
                                                        <p className="text-[9px] text-slate-400 font-bold uppercase">Total</p>
                                                        <p className={`text-xs font-black ${s.type === 'return' ? 'text-red-600' : 'text-green-600'}`}>{s.type === 'return' ? '-' : ''}{formatCurrency(s.total)}</p>
                                                    </div>
                                                    <div className="text-center border-x border-slate-200">
                                                        <p className="text-[9px] text-slate-400 font-bold uppercase">Diskon</p>
                                                        <p className="text-xs font-black text-red-500">{s.discount > 0 ? `-${s.discount}%` : '-'}</p>
                                                    </div>
                                                    <div className="text-center">
                                                        <p className="text-[9px] text-slate-400 font-bold uppercase">Profit</p>
                                                        <p className={`text-xs font-black ${profit > 0 ? 'text-emerald-600' : profit < 0 ? 'text-red-600' : 'text-slate-400'}`}>{profit > 0 ? '+' : ''}{formatCurrency(profit)}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                                {paginatedSales.length === 0 && <div className="p-10 text-center text-slate-400 bg-white rounded-2xl border">Tidak ada data penjualan</div>}
                            </div>

                            {/* ‚îÄ‚îÄ Desktop: Table View ‚îÄ‚îÄ */}
                            <div className="hidden md:block bg-white rounded-xl border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs">
                                        <thead className="bg-gradient-to-r from-slate-100 to-slate-50 border-b-2 border-slate-300">
                                            <tr>
                                                <th className="p-3 text-left text-slate-700 font-bold">Tanggal</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Pelanggan</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Items</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Barang Terjual</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Kategori</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Metode</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Subtotal</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Diskon</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Total</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Profit</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-200">
                                            {paginatedSales.map((s, i) => {
                                                const profit = s.items?.reduce((acc, item) => {
                                                    return acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty);
                                                }, 0) || 0;
                                                const itemsList = s.items?.map(it => it.name).join(', ') || '-';
                                                const categoriesList = s.items?.map(it => it.category).filter(Boolean).join(', ') || '-';
                                                
                                                return (
                                                    <tr key={i} className={`hover:bg-blue-50 transition-colors ${s.type === 'return' ? 'bg-red-50' : ''}`}>
                                                        <td className="p-3 text-slate-700 font-semibold">{formatDate(s.createdAt)}</td>
                                                        <td className="p-3 text-slate-700 font-semibold">{s.customerName}</td>
                                                        <td className="p-3 text-center">
                                                            <span className="inline-block bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">{s.items?.length || 0}</span>
                                                        </td>
                                                        <td className="p-3 text-slate-600 max-w-xs">
                                                            <div className="space-y-1">
                                                                {s.items?.map((item, idx) => (
                                                                    <div key={idx} className="flex justify-between items-start gap-2">
                                                                        <span>{item.name}</span>
                                                                        <span className="text-slate-500 ml-auto">(x{item.qty})</span>
                                                                    </div>
                                                                )) || <span className="text-slate-400">-</span>}
                                                            </div>
                                                        </td>
                                                        <td className="p-3 text-slate-600 max-w-xs">
                                                            <div className="space-y-1">
                                                                {s.items?.map((item, idx) => (
                                                                    <div key={idx}>
                                                                        <span className="inline-block bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-semibold">
                                                                            üì¶ {item.category || 'No Category'}
                                                                        </span>
                                                                        {item.subCategory && (
                                                                            <span className="inline-block bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded font-semibold ml-1">
                                                                                ‚Üí {item.subCategory}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                )) || <span className="text-slate-400">-</span>}
                                                            </div>
                                                        </td>
                                                        <td className="p-3">
                                                            <span className={`text-xs font-bold px-2 py-1 rounded ${s.paymentMethod === 'credit' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`}>
                                                                {s.paymentMethod === 'credit' ? 'Piutang' : s.paymentMethod === 'transfer' ? 'Transfer' : s.paymentMethod === 'card' ? 'Kartu' : 'Kas'}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-center text-slate-700 font-semibold">{formatCurrency(s.subtotal || (s.items?.reduce((a, b) => a + (b.sellPrice * b.qty), 0)) || s.total)}</td>
                                                        <td className="p-3 text-center font-semibold">
                                                            {s.discount > 0 ? (
                                                                <div className="flex flex-col items-center">
                                                                    <span className="text-slate-500 text-[10px]">Disc: {s.discount}%</span>
                                                                    <span className="text-red-600 font-bold">-{formatCurrency(s.discountAmount || 0)}</span>
                                                                </div>
                                                            ) : (
                                                                <span className="text-slate-400">-</span>
                                                            )}
                                                        </td>
                                                        <td className="p-3 text-center font-bold text-lg">
                                                            <span className={s.type === 'return' ? 'text-red-600' : 'text-green-600'}>
                                                                {s.type === 'return' ? '-' : ''}{formatCurrency(s.total)}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-center font-bold">
                                                            <span className={profit > 0 ? 'text-emerald-600' : profit < 0 ? 'text-red-600' : 'text-slate-500'}>
                                                                {profit > 0 ? '+' : ''}{formatCurrency(profit)}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot className="bg-slate-100 border-t-2 border-slate-300 font-bold">
                                            <tr>
                                                <td colSpan="6" className="p-3 text-right">TOTAL ({filteredSalesByCat.length} transaksi):</td>
                                                <td className="p-3 text-center text-slate-800">{formatCurrency(filteredSalesByCat.reduce((a, b) => a + (parseFloat(b.subtotal) || parseFloat(b.total) || 0), 0))}</td>
                                                <td className="p-3 text-center text-red-600">{formatCurrency(filteredSalesByCat.reduce((a, b) => a + (parseFloat(b.discountAmount) || 0), 0))}</td>
                                                <td className="p-3 text-center text-green-700">{formatCurrency(filteredSalesByCat.reduce((a, b) => a + (parseFloat(b.total) || 0), 0))}</td>
                                                <td className="p-3 text-center text-emerald-700">
                                                    {formatCurrency(filteredSalesByCat.reduce((a, b) => {
                                                        const profit = b.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                                        return a + profit;
                                                    }, 0))}
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            {/* Pagination Controls for Sales */}
                            <div className="pt-4 border-t border-slate-200">
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                    {/* Items Per Page Selector */}
                                    <div className="flex items-center space-x-2">
                                        <span className="text-sm text-slate-600">Tampilkan:</span>
                                        <select 
                                            value={salesItemsPerPage} 
                                            onChange={(e) => handleSalesItemsPerPageChange(parseInt(e.target.value))}
                                            className="border border-slate-300 rounded px-2 py-1 text-sm bg-white"
                                        >
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                        <span className="text-sm text-slate-600">transaksi per halaman</span>
                                    </div>

                                    {/* Page Info */}
                                    <div className="text-sm text-slate-600">
                                        Menampilkan {Math.min(salesItemsPerPage * (salesCurrentPage - 1) + 1, filteredSalesByCat.length)} - {Math.min(salesItemsPerPage * salesCurrentPage, filteredSalesByCat.length)} dari {filteredSalesByCat.length} transaksi
                                    </div>

                                    {/* Page Navigation */}
                                    <div className="flex items-center space-x-2">
                                        <button 
                                            onClick={() => handleSalesPageChange(salesCurrentPage - 1)}
                                            disabled={salesCurrentPage === 1}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            ‚Üê Sebelumnya
                                        </button>
                                        
                                        {/* Page Numbers */}
                                        <div className="flex space-x-1">
                                            {Array.from({ length: salesTotalPages }, (_, i) => {
                                                const pageNumber = i + 1;
                                                if (
                                                    pageNumber === 1 || 
                                                    pageNumber === salesTotalPages ||
                                                    (pageNumber >= salesCurrentPage - 2 && pageNumber <= salesCurrentPage + 2)
                                                ) {
                                                    return (
                                                        <button
                                                            key={pageNumber}
                                                            onClick={() => handleSalesPageChange(pageNumber)}
                                                            className={`px-3 py-1 text-sm rounded ${
                                                                pageNumber === salesCurrentPage
                                                                    ? 'bg-blue-600 text-white'
                                                                    : 'border border-slate-300 hover:bg-slate-50'
                                                            }`}
                                                        >
                                                            {pageNumber}
                                                        </button>
                                                    );
                                                } else if (
                                                    pageNumber === salesCurrentPage - 3 || 
                                                    pageNumber === salesCurrentPage + 3
                                                ) {
                                                    return <span key={pageNumber} className="px-2 py-1 text-slate-400">...</span>;
                                                }
                                                return null;
                                            })}
                                        </div>

                                        <button 
                                            onClick={() => handleSalesPageChange(salesCurrentPage + 1)}
                                            disabled={salesCurrentPage === salesTotalPages}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            Selanjutnya ‚Üí
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Summary Cards */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button onClick={() => setDetailModal({ title: 'üõí Transaksi Penjualan', type: 'sales-list', data: filteredSalesByCat })} className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-blue-700 font-bold uppercase mb-1 truncate">Total Transaksi</p>
                                    <p className="text-lg md:text-xl font-black text-blue-600 truncate">{filteredSalesByCat.length}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üíµ Total Penjualan', type: 'sales-list', data: filteredSalesByCat })} className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border-2 border-green-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-green-700 font-bold uppercase mb-1 truncate">Total Penjualan</p>
                                    <p className="text-lg md:text-xl font-black text-green-600 truncate">{formatCurrency(filteredSalesByCat.reduce((a, b) => a + (parseFloat(b.total) || 0), 0))}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üìä Avg Per Transaksi', type: 'sales-list', data: filteredSalesByCat })} className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border-2 border-purple-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-purple-700 font-bold uppercase mb-1 truncate">Avg Per Transaksi</p>
                                    <p className="text-lg md:text-xl font-black text-purple-600 truncate">{formatCurrency(filteredSalesByCat.length > 0 ? filteredSalesByCat.reduce((a, b) => a + (parseFloat(b.total) || 0), 0) / filteredSalesByCat.length : 0)}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üí∞ Profit Penjualan', type: 'profit-list', data: filteredSalesByCat })} className="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border-2 border-emerald-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-emerald-700 font-bold uppercase mb-1 truncate">Total Profit</p>
                                    <p className="text-lg md:text-xl font-black text-emerald-600 truncate">{formatCurrency(filteredSalesByCat.reduce((a, b) => {
                                        const profit = b.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                        return a + profit;
                                    }, 0))}</p>
                                </button>
                            </div>
                        </div>
                    )}

                    {tab === 'service' && (
                        <div className="space-y-4">
                            {/* ‚îÄ‚îÄ Mobile: Card View ‚îÄ‚îÄ */}
                            <div className="md:hidden space-y-3">
                                {paginatedServices.map(s => {
                                    const dp   = parseFloat(s.downPayment) || 0;
                                    const est  = parseFloat(s.costEstimate) || 0;
                                    const sisa = Math.max(0, est - dp);
                                    const payStatus = s.paymentStatus || 'Belum Lunas';
                                    return (
                                        <div key={s.id} className={`bg-white rounded-2xl border shadow-sm overflow-hidden ${sisa > 0 ? 'border-orange-200' : 'border-slate-200'}`}>
                                            <div className={`px-4 py-2.5 flex items-center justify-between ${sisa > 0 ? 'bg-orange-50' : 'bg-slate-50'}`}>
                                                <div>
                                                    <p className="font-black text-slate-800 text-sm">{s.customerName || '-'}</p>
                                                    <p className="text-xs text-slate-500">{formatDate(s.createdAt)}</p>
                                                </div>
                                                <div className="flex flex-col items-end gap-1">
                                                    <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${
                                                        s.status === 'Selesai' ? 'bg-green-100 text-green-700' :
                                                        s.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                        s.status === 'Diagnosa' ? 'bg-yellow-100 text-yellow-700' :
                                                        s.status === 'Menunggu Sparepart' ? 'bg-orange-100 text-orange-700' :
                                                        'bg-slate-100 text-slate-700'
                                                    }`}>{s.status}</span>
                                                    <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${
                                                        payStatus === 'Lunas' ? 'bg-green-100 text-green-700' :
                                                        payStatus === 'DP' ? 'bg-yellow-100 text-yellow-700' :
                                                        'bg-red-100 text-red-700'
                                                    }`}>{payStatus === 'Lunas' ? '‚úÖ Lunas' : payStatus === 'DP' ? '‚è≥ DP' : '‚ùå Belum'}</span>
                                                </div>
                                            </div>
                                            <div className="px-4 py-3">
                                                <p className="text-xs text-slate-600 mb-1">üîß <span className="font-semibold">{s.deviceModel || s.unitType || '-'}</span></p>
                                                <p className="text-xs text-slate-500 line-clamp-2 mb-3">üí¨ {s.problemDescription || s.complaint || s.problem || '-'}</p>
                                                <div className="grid grid-cols-3 gap-2 bg-slate-50 rounded-xl p-2.5">
                                                    <div className="text-center">
                                                        <p className="text-[9px] text-slate-400 font-bold uppercase">Estimasi</p>
                                                        <p className="text-xs font-black text-slate-700">{formatCurrency(est)}</p>
                                                    </div>
                                                    <div className="text-center border-x border-slate-200">
                                                        <p className="text-[9px] text-slate-400 font-bold uppercase">DP</p>
                                                        <p className="text-xs font-black text-blue-600">{formatCurrency(dp)}</p>
                                                    </div>
                                                    <div className="text-center">
                                                        <p className="text-[9px] text-slate-400 font-bold uppercase">Sisa</p>
                                                        <p className={`text-xs font-black ${sisa > 0 ? 'text-orange-600' : 'text-green-600'}`}>{sisa > 0 ? formatCurrency(sisa) : 'Lunas'}</p>
                                                    </div>
                                                </div>
                                                {s.assignedTechnician && <p className="text-[10px] text-slate-400 mt-2">üë®‚Äçüîß {s.assignedTechnician}</p>}
                                            </div>
                                        </div>
                                    );
                                })}
                                {paginatedServices.length === 0 && <div className="p-10 text-center text-slate-400 bg-white rounded-2xl border">Tidak ada data servis</div>}
                            </div>

                            {/* ‚îÄ‚îÄ Desktop: Table View ‚îÄ‚îÄ */}
                            <div className="hidden md:block bg-white rounded-xl border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs">
                                        <thead className="bg-gradient-to-r from-slate-100 to-slate-50 border-b-2 border-slate-300">
                                            <tr>
                                                <th className="p-3 text-left text-slate-700 font-bold">Tanggal</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Pelanggan</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Unit</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Keluhan</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Tekhnisi</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Status</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Estimasi</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Bayar Awal</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Sisa</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-200">
                                            {paginatedServices.map(s => {
                                                const dpAmount = s.downPayment || 0;
                                                const estimateCost = parseFloat(s.costEstimate) || 0;
                                                const remaining = estimateCost - dpAmount;
                                                return (
                                                    <tr key={s.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-3 text-slate-700 font-semibold">{formatDate(s.createdAt)}</td>
                                                        <td className="p-3 font-bold text-slate-700">{s.customerName}</td>
                                                        <td className="p-3 text-slate-600">{s.deviceModel || s.unitType}</td>
                                                        <td className="p-3 text-slate-600 max-w-xs"><span className="line-clamp-2">{s.problemDescription || s.problem || '-'}</span></td>
                                                        <td className="p-3 text-slate-600">{s.assignedTechnician || '-'}</td>
                                                        <td className="p-3 text-center">
                                                            <span className={`text-xs font-bold px-2 py-1 rounded whitespace-nowrap inline-block ${
                                                                s.status === 'Selesai' ? 'bg-green-100 text-green-700' :
                                                                s.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                                s.status === 'Diagnosa' ? 'bg-yellow-100 text-yellow-700' :
                                                                s.status === 'Menunggu Sparepart' ? 'bg-orange-100 text-orange-700' :
                                                                'bg-slate-100 text-slate-700'
                                                            }`}>{s.status}</span>
                                                        </td>
                                                        <td className="p-3 text-right font-bold text-slate-700">{formatCurrency(estimateCost)}</td>
                                                        <td className="p-3 text-right font-semibold"><span className="text-blue-600">{formatCurrency(dpAmount)}</span></td>
                                                        <td className="p-3 text-right font-bold"><span className={remaining > 0 ? 'text-orange-600' : remaining === 0 ? 'text-green-600' : 'text-red-600'}>{formatCurrency(Math.max(0, remaining))}</span></td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot className="bg-slate-100 border-t-2 border-slate-300 font-bold">
                                            <tr>
                                                <td colSpan="4" className="p-3 text-right">TOTAL:</td>
                                                <td colSpan="2" className="p-3"></td>
                                                <td className="p-3 text-right text-slate-800">{formatCurrency(filteredServices.reduce((a, b) => a + (parseFloat(b.costEstimate) || 0), 0))}</td>
                                                <td className="p-3 text-right text-blue-700">{formatCurrency(filteredServices.reduce((a, b) => a + (parseFloat(b.downPayment) || 0), 0))}</td>
                                                <td className="p-3 text-right text-orange-700">{formatCurrency(filteredServices.reduce((a, b) => a + Math.max(0, (parseFloat(b.costEstimate) || 0) - (parseFloat(b.downPayment) || 0)), 0))}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            {/* Pagination Controls for Services */}
                            <div className="pt-4 border-t border-slate-200">
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                    {/* Items Per Page Selector */}
                                    <div className="flex items-center space-x-2">
                                        <span className="text-sm text-slate-600">Tampilkan:</span>
                                        <select 
                                            value={serviceItemsPerPage} 
                                            onChange={(e) => handleServiceItemsPerPageChange(parseInt(e.target.value))}
                                            className="border border-slate-300 rounded px-2 py-1 text-sm bg-white"
                                        >
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                        <span className="text-sm text-slate-600">service per halaman</span>
                                    </div>

                                    {/* Page Info */}
                                    <div className="text-sm text-slate-600">
                                        Menampilkan {Math.min(serviceItemsPerPage * (serviceCurrentPage - 1) + 1, filteredServices.length)} - {Math.min(serviceItemsPerPage * serviceCurrentPage, filteredServices.length)} dari {filteredServices.length} service
                                    </div>

                                    {/* Page Navigation */}
                                    <div className="flex items-center space-x-2">
                                        <button 
                                            onClick={() => handleServicePageChange(serviceCurrentPage - 1)}
                                            disabled={serviceCurrentPage === 1}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            ‚Üê Sebelumnya
                                        </button>
                                        
                                        {/* Page Numbers */}
                                        <div className="flex space-x-1">
                                            {Array.from({ length: serviceTotalPages }, (_, i) => {
                                                const pageNumber = i + 1;
                                                if (
                                                    pageNumber === 1 || 
                                                    pageNumber === serviceTotalPages ||
                                                    (pageNumber >= serviceCurrentPage - 2 && pageNumber <= serviceCurrentPage + 2)
                                                ) {
                                                    return (
                                                        <button
                                                            key={pageNumber}
                                                            onClick={() => handleServicePageChange(pageNumber)}
                                                            className={`px-3 py-1 text-sm rounded ${
                                                                pageNumber === serviceCurrentPage
                                                                    ? 'bg-blue-600 text-white'
                                                                    : 'border border-slate-300 hover:bg-slate-50'
                                                            }`}
                                                        >
                                                            {pageNumber}
                                                        </button>
                                                    );
                                                } else if (
                                                    pageNumber === serviceCurrentPage - 3 || 
                                                    pageNumber === serviceCurrentPage + 3
                                                ) {
                                                    return <span key={pageNumber} className="px-2 py-1 text-slate-400">...</span>;
                                                }
                                                return null;
                                            })}
                                        </div>

                                        <button 
                                            onClick={() => handleServicePageChange(serviceCurrentPage + 1)}
                                            disabled={serviceCurrentPage === serviceTotalPages}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            Selanjutnya ‚Üí
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Summary Cards for Services */}
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                <button onClick={() => setDetailModal({ title: 'üì± Total Servis', type: 'service-list', data: filteredServices })} className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-blue-700 font-bold uppercase mb-1 truncate">Total Servis</p>
                                    <p className="text-lg md:text-xl font-black text-blue-600 truncate">{totalServices}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: '‚úÖ Servis Selesai', type: 'service-list', data: filteredServices.filter(s => s.status === 'Selesai') })} className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border-2 border-green-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-green-700 font-bold uppercase mb-1 truncate">Selesai</p>
                                    <p className="text-lg md:text-xl font-black text-green-600 truncate">{completedServices}</p>
                                    <p className="text-[10px] text-green-600 mt-1 truncate">{totalServices > 0 ? ((completedServices / totalServices * 100).toFixed(1)) : 0}%</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üí∞ Estimasi Total', type: 'service-list', data: filteredServices })} className="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-xl border-2 border-yellow-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-yellow-700 font-bold uppercase mb-1 truncate">Estimasi Total</p>
                                    <p className="text-lg md:text-xl font-black text-yellow-600 truncate">{formatCurrency(filteredServices.reduce((a, b) => a + (parseFloat(b.costEstimate) || 0), 0))}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üíµ DP Terkumpul', type: 'service-list', data: filteredServices.filter(s => (parseFloat(s.downPayment) || 0) > 0) })} className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border-2 border-purple-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-purple-700 font-bold uppercase mb-1 truncate">DP Terkumpul</p>
                                    <p className="text-lg md:text-xl font-black text-purple-600 truncate">{formatCurrency(filteredServices.reduce((a, b) => a + (parseFloat(b.downPayment) || 0), 0))}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: '‚è≥ Sisa Tagihan', type: 'service-list', data: filteredServices.filter(s => ((parseFloat(s.costEstimate) || 0) - (parseFloat(s.downPayment) || 0)) > 0) })} className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border-2 border-orange-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-orange-700 font-bold uppercase mb-1 truncate">Sisa Tagihan</p>
                                    <p className="text-lg md:text-xl font-black text-orange-600 truncate">{formatCurrency(filteredServices.reduce((a, b) => a + Math.max(0, (parseFloat(b.costEstimate) || 0) - (parseFloat(b.downPayment) || 0)), 0))}</p>
                                </button>
                            </div>
                        </div>
                    )}

                    {tab === 'inventory' && (
                        <div className="space-y-4">
                            {/* Ringkasan Total Stok */}
                            <div className="grid grid-cols-3 gap-3">
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200 p-3 text-center">
                                    <div className="text-[10px] font-bold text-blue-600 uppercase mb-1">Total Stok</div>
                                    <div className="text-base font-black text-blue-700">{inventory.reduce((a, b) => a + (b.stock||0), 0)} pcs</div>
                                </div>
                                <div className="bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl border border-slate-200 p-3 text-center">
                                    <div className="text-[10px] font-bold text-slate-600 uppercase mb-1">Nilai Modal</div>
                                    <div className="text-sm font-black text-slate-700">{checkPermission('feature_show_modal') ? formatCurrency(inventory.reduce((a, b) => a + (parseFloat(b.buyPrice)||0) * (b.stock||0), 0)) : '***'}</div>
                                </div>
                                <div className="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl border border-emerald-200 p-3 text-center">
                                    <div className="text-[10px] font-bold text-emerald-600 uppercase mb-1">Nilai Jual</div>
                                    <div className="text-sm font-black text-emerald-700">{formatCurrency(inventory.reduce((a, b) => a + (parseFloat(b.sellPrice)||0) * (b.stock||0), 0))}</div>
                                </div>
                            </div>

                            {/* Card List Inventori */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {inventoryLoading && (
                                    <div className="md:col-span-2 bg-white rounded-xl p-10 text-center border border-slate-200">
                                        <div className="flex flex-col items-center gap-2 text-slate-400">
                                            <div className="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                                            <span className="text-sm">Memuat data stok...</span>
                                        </div>
                                    </div>
                                )}
                                {!inventoryLoading && paginatedInventory.length === 0 && (
                                    <div className="md:col-span-2 bg-white rounded-xl p-10 text-center border border-slate-200 text-slate-400 text-sm">üì¶ Tidak ada data inventori untuk ditampilkan</div>
                                )}
                                {paginatedInventory.map((i, idx) => {
                                    const profitPerUnit = (parseFloat(i.sellPrice) || 0) - (parseFloat(i.buyPrice) || 0);
                                    const totalValue = (parseFloat(i.sellPrice) || 0) * (i.stock || 0);
                                    const stockBadge = (i.stock || 0) === 0
                                        ? 'bg-red-100 text-red-700 border-red-200'
                                        : (i.stock || 0) <= 5
                                        ? 'bg-yellow-100 text-yellow-700 border-yellow-200'
                                        : 'bg-blue-100 text-blue-700 border-blue-200';
                                    return (
                                        <div key={i.id} className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                            {/* Header: nama + kategori + stok */}
                                            <div className="flex items-start justify-between gap-2 px-4 py-3 bg-slate-50 border-b border-slate-100">
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-bold text-slate-800 text-sm leading-tight truncate">{i.name}</div>
                                                    <div className="flex gap-1 flex-wrap mt-1">
                                                        {i.category && (
                                                            <span className="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded-full">üì¶ {i.category}</span>
                                                        )}
                                                        {i.subCategory && (
                                                            <span className="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded-full">‚Üí {i.subCategory}</span>
                                                        )}
                                                        {i.brand && (
                                                            <span className="bg-orange-100 text-orange-700 text-[10px] font-bold px-2 py-0.5 rounded-full">üè∑Ô∏è {i.brand}</span>
                                                        )}
                                                    </div>
                                                </div>
                                                <span className={`shrink-0 px-3 py-1 rounded-lg text-sm font-extrabold border ${stockBadge}`}>{i.stock || 0} pcs</span>
                                            </div>
                                            {/* Grid harga */}
                                            <div className="grid grid-cols-3 divide-x divide-slate-100 text-center">
                                                <div className="py-3 px-2">
                                                    <div className="text-[10px] text-slate-400 font-bold uppercase mb-0.5">Modal</div>
                                                    <div className="text-xs font-bold text-slate-700">{checkPermission('feature_show_modal') ? formatCurrency(parseFloat(i.buyPrice) || 0) : '***'}</div>
                                                </div>
                                                <div className="py-3 px-2">
                                                    <div className="text-[10px] text-slate-400 font-bold uppercase mb-0.5">Harga Jual</div>
                                                    <div className="text-xs font-bold text-slate-700">{formatCurrency(parseFloat(i.sellPrice) || 0)}</div>
                                                </div>
                                                <div className="py-3 px-2">
                                                    <div className="text-[10px] text-slate-400 font-bold uppercase mb-0.5">Untung/pcs</div>
                                                    <div className={`text-xs font-bold ${profitPerUnit > 0 ? 'text-green-600' : profitPerUnit < 0 ? 'text-red-600' : 'text-slate-500'}`}>{profitPerUnit > 0 ? '+' : ''}{formatCurrency(profitPerUnit)}</div>
                                                </div>
                                            </div>
                                            {/* Footer: nilai stok */}
                                            <div className="flex items-center justify-between bg-emerald-600 text-white px-4 py-2">
                                                <span className="text-xs font-bold">Nilai Stok</span>
                                                <span className="text-sm font-extrabold">{formatCurrency(totalValue)}</span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            {/* Pagination Controls for Inventory */}
                            <div className="pt-4 border-t border-slate-200">
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                    {/* Items Per Page Selector */}
                                    <div className="flex items-center space-x-2">
                                        <span className="text-sm text-slate-600">Tampilkan:</span>
                                        <select 
                                            value={inventoryItemsPerPage} 
                                            onChange={(e) => setInventoryItemsPerPage(parseInt(e.target.value))}
                                            className="border border-slate-300 rounded px-2 py-1 text-sm bg-white"
                                        >
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                        <span className="text-sm text-slate-600">item per halaman</span>
                                    </div>

                                    {/* Page Info */}
                                    <div className="text-sm text-slate-600">
                                        Menampilkan {Math.min(inventoryItemsPerPage * (inventoryCurrentPage - 1) + 1, inventory.length)} - {Math.min(inventoryItemsPerPage * inventoryCurrentPage, inventory.length)} dari {inventory.length} item
                                    </div>

                                    {/* Page Navigation */}
                                    <div className="flex items-center space-x-2">
                                        <button 
                                            onClick={() => handleInventoryPageChange(inventoryCurrentPage - 1)}
                                            disabled={inventoryCurrentPage === 1}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            ‚Üê Sebelumnya
                                        </button>
                                        
                                        {/* Page Numbers */}
                                        <div className="flex space-x-1">
                                            {Array.from({ length: Math.ceil(inventory.length / inventoryItemsPerPage) }, (_, i) => {
                                                const pageNumber = i + 1;
                                                if (
                                                    pageNumber === 1 || 
                                                    pageNumber === Math.ceil(inventory.length / inventoryItemsPerPage) ||
                                                    (pageNumber >= inventoryCurrentPage - 2 && pageNumber <= inventoryCurrentPage + 2)
                                                ) {
                                                    return (
                                                        <button
                                                            key={pageNumber}
                                                            onClick={() => handleInventoryPageChange(pageNumber)}
                                                            className={`px-3 py-1 text-sm rounded ${
                                                                pageNumber === inventoryCurrentPage
                                                                    ? 'bg-blue-600 text-white'
                                                                    : 'border border-slate-300 hover:bg-slate-50'
                                                            }`}
                                                        >
                                                            {pageNumber}
                                                        </button>
                                                    );
                                                } else if (
                                                    pageNumber === inventoryCurrentPage - 3 || 
                                                    pageNumber === inventoryCurrentPage + 3
                                                ) {
                                                    return <span key={pageNumber} className="px-2 py-1 text-slate-400">...</span>;
                                                }
                                                return null;
                                            })}
                                        </div>

                                        <button 
                                            onClick={() => handleInventoryPageChange(inventoryCurrentPage + 1)}
                                            disabled={inventoryCurrentPage === Math.ceil(inventory.length / inventoryItemsPerPage)}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            Selanjutnya ‚Üí
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Summary Cards for Inventory */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button onClick={() => setDetailModal({ title: 'üì¶ Total Item', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-blue-700 font-bold uppercase mb-1 truncate">Total Item</p>
                                    <p className="text-lg md:text-xl font-black text-blue-600 truncate">{inventoryAggregation.loading ? '...' : inventoryAggregation.totalItems}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì¶ Total Stok', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-cyan-50 to-cyan-100 p-4 rounded-xl border-2 border-cyan-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-cyan-700 font-bold uppercase mb-1 truncate">Total Stok</p>
                                    <p className="text-lg md:text-xl font-black text-cyan-600 truncate">{inventoryAggregation.loading ? '...' : `${inventoryAggregation.totalStock} pcs`}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üí∞ Modal Total', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border-2 border-orange-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-orange-700 font-bold uppercase mb-1 truncate">Modal Total</p>
                                    <p className="text-lg md:text-xl font-black text-orange-600 truncate">{checkPermission('feature_show_modal') ? formatCurrency(inventory.reduce((a, b) => a + (parseFloat(b.buyPrice) * b.stock || 0), 0)) : '***'}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üíé Nilai Stok', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border-2 border-emerald-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-emerald-700 font-bold uppercase mb-1 truncate">Nilai Stok</p>
                                    <p className="text-lg md:text-xl font-black text-emerald-600 truncate">{formatCurrency(inventoryValue)}</p>
                                </button>
                            </div>
                        </div>
                    )}

                    {(tab === 'payable' || tab === 'receivable') && (() => {
                        const isPayable  = tab === 'payable';
                        const debtList   = isPayable ? payableDebts : receivableDebts;
                        const unpaid     = debtList.filter(d => d.status !== 'paid');
                        const totalRemain= debtList.reduce((a,d)=>a+(d.remaining||0),0);
                        return (
                            <div className="space-y-4">
                                {/* KPI Banner */}
                                <div className={`rounded-2xl p-4 border ${isPayable ? 'bg-gradient-to-r from-red-50 to-rose-50 border-red-200' : 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-200'}`}>
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className={`text-xs font-bold uppercase mb-1 ${isPayable ? 'text-red-500' : 'text-green-600'}`}>{isPayable ? 'üì§ Total Utang' : 'üì• Total Piutang'}</p>
                                            <p className={`text-2xl md:text-3xl font-black ${isPayable ? 'text-red-600' : 'text-green-600'}`}>{formatCurrency(totalRemain)}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-xs text-slate-500">{debtList.length} total</p>
                                            <p className={`text-sm font-bold mt-1 ${isPayable ? 'text-red-500' : 'text-orange-500'}`}>{unpaid.length} belum lunas</p>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 mt-3">
                                        <div className="bg-white/70 rounded-xl p-2 text-center">
                                            <p className="text-[9px] text-slate-400 font-bold uppercase">Total Nominal</p>
                                            <p className="text-xs font-black text-slate-700">{formatCurrency(debtList.reduce((a,d)=>a+(d.amount||0),0))}</p>
                                        </div>
                                        <div className="bg-white/70 rounded-xl p-2 text-center">
                                            <p className="text-[9px] text-slate-400 font-bold uppercase">Terbayar</p>
                                            <p className="text-xs font-black text-blue-600">{formatCurrency(debtList.reduce((a,d)=>a+(d.paid||0),0))}</p>
                                        </div>
                                        <div className="bg-white/70 rounded-xl p-2 text-center">
                                            <p className="text-[9px] text-slate-400 font-bold uppercase">Sisa</p>
                                            <p className={`text-xs font-black ${isPayable ? 'text-red-600' : 'text-orange-600'}`}>{formatCurrency(totalRemain)}</p>
                                        </div>
                                    </div>
                                </div>

                                {/* ‚îÄ‚îÄ Mobile: Card View ‚îÄ‚îÄ */}
                                <div className="md:hidden space-y-3">
                                    {debtList.map(d => (
                                        <div key={d.id} className={`bg-white rounded-2xl border shadow-sm overflow-hidden ${d.status!=='paid' ? 'border-orange-200' : 'border-slate-200'}`}>
                                            <div className={`px-4 py-2.5 flex items-center justify-between ${d.status!=='paid' ? 'bg-orange-50' : 'bg-slate-50'}`}>
                                                <div>
                                                    <p className="font-black text-slate-800 text-sm">{d.customerName||'-'}</p>
                                                    <p className="text-xs font-mono text-slate-400">{d.invoiceNo||'-'}</p>
                                                </div>
                                                <span className={`text-xs font-bold px-2.5 py-1 rounded-full ${d.status==='paid'?'bg-green-100 text-green-700':d.status==='partial'?'bg-yellow-100 text-yellow-700':'bg-red-100 text-red-700'}`}>
                                                    {d.status==='paid'?'‚úÖ Lunas':d.status==='partial'?'‚è≥ Dicicil':'‚ùå Belum'}
                                                </span>
                                            </div>
                                            <div className="px-4 py-3">
                                                {d.description && <p className="text-xs text-slate-500 mb-2 line-clamp-2">üìù {d.description}</p>}
                                                <div className="flex gap-2 text-xs text-slate-400 mb-3">
                                                    <span>üìÖ {formatDate(d.createdAt)}</span>
                                                    {d.dueDate && <span>‚è∞ Jatuh: {d.dueDate}</span>}
                                                </div>
                                                <div className="grid grid-cols-3 gap-2 bg-slate-50 rounded-xl p-2.5">
                                                    <div className="text-center">
                                                        <p className="text-[9px] text-slate-400 font-bold uppercase">Total</p>
                                                        <p className="text-xs font-black text-slate-700">{formatCurrency(d.amount||0)}</p>
                                                    </div>
                                                    <div className="text-center border-x border-slate-200">
                                                        <p className="text-[9px] text-slate-400 font-bold uppercase">Dibayar</p>
                                                        <p className="text-xs font-black text-blue-600">{formatCurrency(d.paid||0)}</p>
                                                    </div>
                                                    <div className="text-center">
                                                        <p className="text-[9px] text-slate-400 font-bold uppercase">Sisa</p>
                                                        <p className={`text-xs font-black ${d.remaining>0?(isPayable?'text-red-600':'text-orange-600'):'text-green-600'}`}>{formatCurrency(d.remaining||0)}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {debtList.length === 0 && <div className="p-10 text-center text-slate-400 bg-white rounded-2xl border">Tidak ada data {isPayable ? 'utang' : 'piutang'}</div>}
                                </div>

                                {/* ‚îÄ‚îÄ Desktop: Table View ‚îÄ‚îÄ */}
                                <div className="hidden md:block bg-white rounded-xl border border-slate-200 overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-xs">
                                            <thead className="bg-slate-100">
                                                <tr>
                                                    <th className="p-3 text-left">No. Invoice</th>
                                                    <th className="p-3 text-left">{isPayable ? 'Vendor' : 'Pelanggan'}</th>
                                                    <th className="p-3 text-left">Keterangan</th>
                                                    <th className="p-3 text-left">Tanggal</th>
                                                    <th className="p-3 text-left">Jatuh Tempo</th>
                                                    <th className="p-3 text-right">Total</th>
                                                    <th className="p-3 text-right">Dibayar</th>
                                                    <th className="p-3 text-right">Sisa</th>
                                                    <th className="p-3 text-center">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-200">
                                                {debtList.map(d => (
                                                    <tr key={d.id} className={d.status!=='paid' ? 'bg-orange-50' : ''}>
                                                        <td className="p-3 font-mono text-xs text-slate-500">{d.invoiceNo||'-'}</td>
                                                        <td className="p-3 font-bold text-slate-700">{d.customerName||'-'}</td>
                                                        <td className="p-3 text-slate-600 max-w-xs truncate">{d.description||'-'}</td>
                                                        <td className="p-3 text-slate-600 whitespace-nowrap">{formatDate(d.createdAt)}</td>
                                                        <td className="p-3 text-slate-600 whitespace-nowrap">{d.dueDate||'-'}</td>
                                                        <td className="p-3 text-right font-bold text-slate-700">{formatCurrency(d.amount||0)}</td>
                                                        <td className="p-3 text-right text-blue-600">{formatCurrency(d.paid||0)}</td>
                                                        <td className={'p-3 text-right font-bold '+(d.remaining>0?(isPayable?'text-red-600':'text-orange-600'):'text-green-600')}>{formatCurrency(d.remaining||0)}</td>
                                                        <td className="p-3 text-center">
                                                            <span className={`text-xs font-bold px-2 py-1 rounded-full ${d.status==='paid'?'bg-green-100 text-green-700':d.status==='partial'?'bg-yellow-100 text-yellow-700':'bg-red-100 text-red-700'}`}>
                                                                {d.status==='paid'?'‚úÖ Lunas':d.status==='partial'?'‚è≥ Dicicil':'‚ùå Belum'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {debtList.length === 0 && <tr><td colSpan="9" className="p-8 text-center text-slate-400">Tidak ada data</td></tr>}
                                            </tbody>
                                            <tfoot className="bg-slate-100 border-t-2 border-slate-300 font-bold">
                                                <tr>
                                                    <td colSpan="5" className="p-3 text-right">TOTAL:</td>
                                                    <td className="p-3 text-right">{formatCurrency(debtList.reduce((a,d)=>a+(d.amount||0),0))}</td>
                                                    <td className="p-3 text-right text-blue-700">{formatCurrency(debtList.reduce((a,d)=>a+(d.paid||0),0))}</td>
                                                    <td className={`p-3 text-right font-black ${isPayable ? 'text-red-700' : 'text-orange-700'}`}>{formatCurrency(totalRemain)}</td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {tab === 'profitloss' && (
                        <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onClick={() => setDetailModal({ title: 'üì• Detail Pemasukan', type: 'income-list', data: filteredTrans.filter(t => t.type === 'income') })} className="bg-green-50 p-6 rounded-xl border border-green-200 text-left hover:shadow-lg hover:scale-[1.01] transition-all cursor-pointer">
                                    <h3 className="font-bold text-green-900 mb-2 text-sm">Total Pemasukan</h3>
                                    <p className="text-2xl md:text-3xl font-black text-green-600 truncate">{formatCurrency(serviceIncome)}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì§ Detail Pengeluaran', type: 'expense-list', data: filteredTrans.filter(t => t.type === 'expense') })} className="bg-red-50 p-6 rounded-xl border border-red-200 text-left hover:shadow-lg hover:scale-[1.01] transition-all cursor-pointer">
                                    <h3 className="font-bold text-red-900 mb-2 text-sm">Total Pengeluaran</h3>
                                    <p className="text-2xl md:text-3xl font-black text-red-600 truncate">{formatCurrency(serviceExpense)}</p>
                                </button>
                            </div>
                            <div className={`${serviceProfitLoss >= 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-orange-50 border-orange-200'} p-6 rounded-xl border`}>
                                <h3 className={`font-bold mb-2 text-sm ${serviceProfitLoss >= 0 ? 'text-emerald-900' : 'text-orange-900'}`}>Profit/Loss Bersih</h3>
                                <p className={`text-3xl md:text-4xl font-black truncate ${serviceProfitLoss >= 0 ? 'text-emerald-600' : 'text-orange-600'}`}>{formatCurrency(serviceProfitLoss)}</p>
                            </div>
                        </div>
                    )}

                    {/* Detail Modal */}
                    {detailModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" onClick={() => setDetailModal(null)}>
                            <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center p-5 border-b bg-slate-50">
                                    <h3 className="font-bold text-lg text-slate-800">{detailModal.title}</h3>
                                    <button onClick={() => setDetailModal(null)} className="text-slate-400 hover:text-slate-700 p-1 hover:bg-slate-200 rounded-lg transition-colors">
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                <div className="overflow-y-auto max-h-[calc(85vh-80px)] p-5">
                                    {/* Income List */}
                                    {detailModal.type === 'income-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-green-700 font-bold">Total Pemasukan: <span className="text-xl">{formatCurrency(detailModal.data.reduce((a, b) => a + (b.amount || 0), 0))}</span></p>
                                                <p className="text-xs text-green-600 mt-1">{detailModal.data.length} transaksi pemasukan</p>
                                            </div>
                                            {detailModal.data.length === 0 ? (
                                                <div className="text-center text-slate-400 py-8">Tidak ada data pemasukan</div>
                                            ) : (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-100">
                                                            <tr>
                                                                <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Keterangan</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">Jumlah</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {detailModal.data.map((t, idx) => (
                                                                <tr key={idx} className="hover:bg-green-50">
                                                                    <td className="p-3 text-slate-600 text-xs">{formatDate(t.date || t.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{t.description || t.note || '-'}</td>
                                                                    <td className="p-3 text-right font-bold text-green-600">+{formatCurrency(t.amount || 0)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Expense List */}
                                    {detailModal.type === 'expense-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-red-700 font-bold">Total Pengeluaran: <span className="text-xl">{formatCurrency(detailModal.data.reduce((a, b) => a + (b.amount || 0), 0))}</span></p>
                                                <p className="text-xs text-red-600 mt-1">{detailModal.data.length} transaksi pengeluaran</p>
                                            </div>
                                            {detailModal.data.length === 0 ? (
                                                <div className="text-center text-slate-400 py-8">Tidak ada data pengeluaran</div>
                                            ) : (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-100">
                                                            <tr>
                                                                <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Keterangan</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">Jumlah</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {detailModal.data.map((t, idx) => (
                                                                <tr key={idx} className="hover:bg-red-50">
                                                                    <td className="p-3 text-slate-600 text-xs">{formatDate(t.date || t.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{t.description || t.note || '-'}</td>
                                                                    <td className="p-3 text-right font-bold text-red-600">-{formatCurrency(t.amount || 0)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Sales List */}
                                    {detailModal.type === 'sales-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-green-700 font-bold">Total Penjualan: <span className="text-xl">{formatCurrency(detailModal.data.reduce((a, b) => a + (parseFloat(b.total) || 0), 0))}</span></p>
                                                <p className="text-xs text-green-600 mt-1">{detailModal.data.length} transaksi</p>
                                            </div>
                                            {detailModal.data.length === 0 ? (
                                                <div className="text-center text-slate-400 py-8">Tidak ada data penjualan</div>
                                            ) : (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-100">
                                                            <tr>
                                                                <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Pelanggan</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Barang</th>
                                                                <th className="p-3 text-center font-bold text-slate-700">Metode</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {detailModal.data.map((s, idx) => (
                                                                <tr key={idx} className="hover:bg-slate-50">
                                                                    <td className="p-3 text-slate-600 text-xs whitespace-nowrap">{formatDate(s.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{s.customerName || '-'}</td>
                                                                    <td className="p-3 text-xs text-slate-600">
                                                                        {s.items?.map(it => `${it.name} x${it.qty}`).join(', ') || '-'}
                                                                    </td>
                                                                    <td className="p-3 text-center">
                                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${s.paymentMethod === 'credit' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`}>
                                                                            {s.paymentMethod === 'credit' ? 'Piutang' : s.paymentMethod === 'transfer' ? 'Transfer' : 'Kas'}
                                                                        </span>
                                                                    </td>
                                                                    <td className="p-3 text-right font-bold text-green-600 whitespace-nowrap">{formatCurrency(s.total)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Profit List */}
                                    {detailModal.type === 'profit-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-emerald-700 font-bold">Total Profit: <span className="text-xl">{formatCurrency(detailModal.data.reduce((a, b) => {
                                                    const profit = b.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                                    return a + profit;
                                                }, 0))}</span></p>
                                                <p className="text-xs text-emerald-600 mt-1">{detailModal.data.length} transaksi</p>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-slate-100">
                                                        <tr>
                                                            <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                            <th className="p-3 text-left font-bold text-slate-700">Pelanggan</th>
                                                            <th className="p-3 text-left font-bold text-slate-700">Barang</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Total</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Profit</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y">
                                                        {detailModal.data.map((s, idx) => {
                                                            const profit = s.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                                            return (
                                                                <tr key={idx} className="hover:bg-slate-50">
                                                                    <td className="p-3 text-slate-600 text-xs whitespace-nowrap">{formatDate(s.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{s.customerName || '-'}</td>
                                                                    <td className="p-3 text-xs text-slate-600">
                                                                        {s.items?.map(it => `${it.name} x${it.qty}`).join(', ') || '-'}
                                                                    </td>
                                                                    <td className="p-3 text-right text-slate-700 whitespace-nowrap">{formatCurrency(s.total)}</td>
                                                                    <td className="p-3 text-right font-bold whitespace-nowrap">
                                                                        <span className={profit > 0 ? 'text-emerald-600' : profit < 0 ? 'text-red-600' : 'text-slate-500'}>
                                                                            {profit > 0 ? '+' : ''}{formatCurrency(profit)}
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    {/* Service List */}
                                    {detailModal.type === 'service-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-blue-700 font-bold">Total: {detailModal.data.length} servis</p>
                                                <p className="text-xs text-blue-600 mt-1">Estimasi: {formatCurrency(detailModal.data.reduce((a, b) => a + (parseFloat(b.costEstimate) || 0), 0))}</p>
                                            </div>
                                            {detailModal.data.length === 0 ? (
                                                <div className="text-center text-slate-400 py-8">Tidak ada data servis</div>
                                            ) : (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-100">
                                                            <tr>
                                                                <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Pelanggan</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Unit</th>
                                                                <th className="p-3 text-center font-bold text-slate-700">Status</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">Estimasi</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">DP</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {detailModal.data.map((s, idx) => (
                                                                <tr key={idx} className="hover:bg-slate-50">
                                                                    <td className="p-3 text-slate-600 text-xs whitespace-nowrap">{formatDate(s.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{s.customerName || '-'}</td>
                                                                    <td className="p-3 text-slate-600 text-xs">{s.deviceModel || s.unitType || '-'}</td>
                                                                    <td className="p-3 text-center">
                                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded whitespace-nowrap ${
                                                                            s.status === 'Selesai' ? 'bg-green-100 text-green-700' :
                                                                            s.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                                            'bg-yellow-100 text-yellow-700'
                                                                        }`}>{s.status}</span>
                                                                    </td>
                                                                    <td className="p-3 text-right font-bold text-slate-700 whitespace-nowrap">{formatCurrency(parseFloat(s.costEstimate) || 0)}</td>
                                                                    <td className="p-3 text-right font-bold text-blue-600 whitespace-nowrap">{formatCurrency(parseFloat(s.downPayment) || 0)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Inventory Detail */}
                                    {detailModal.type === 'inventory-detail' && (
                                        <div className="space-y-3">
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                                    <p className="text-[10px] text-blue-700 font-bold uppercase">Total Item</p>
                                                    <p className="text-lg font-black text-blue-600">{detailModal.data.length}</p>
                                                </div>
                                                <div className="bg-cyan-50 border border-cyan-200 rounded-lg p-3">
                                                    <p className="text-[10px] text-cyan-700 font-bold uppercase">Total Stok</p>
                                                    <p className="text-lg font-black text-cyan-600">{detailModal.data.reduce((a, b) => a + b.stock, 0)} pcs</p>
                                                </div>
                                                <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                                    <p className="text-[10px] text-orange-700 font-bold uppercase">Modal</p>
                                                    <p className="text-lg font-black text-orange-600">{checkPermission('feature_show_modal') ? formatCurrency(detailModal.data.reduce((a, b) => a + (parseFloat(b.buyPrice) * b.stock || 0), 0)) : '***'}</p>
                                                </div>
                                                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                                    <p className="text-[10px] text-emerald-700 font-bold uppercase">Nilai Jual</p>
                                                    <p className="text-lg font-black text-emerald-600">{formatCurrency(detailModal.data.reduce((a, b) => a + (parseFloat(b.sellPrice) * b.stock || 0), 0))}</p>
                                                </div>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-slate-100">
                                                        <tr>
                                                            <th className="p-3 text-left font-bold text-slate-700">Nama</th>
                                                            <th className="p-3 text-left font-bold text-slate-700">Kategori</th>
                                                            <th className="p-3 text-center font-bold text-slate-700">Stok</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Modal</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Harga Jual</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Nilai Stok</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y">
                                                        {detailModal.data.sort((a, b) => (parseFloat(b.sellPrice) * b.stock) - (parseFloat(a.sellPrice) * a.stock)).map((i, idx) => (
                                                            <tr key={idx} className="hover:bg-slate-50">
                                                                <td className="p-3 font-medium text-slate-700">{i.name}</td>
                                                                <td className="p-3">
                                                                    <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded font-semibold">{i.category || '-'}</span>
                                                                </td>
                                                                <td className="p-3 text-center font-bold text-blue-600">{i.stock}</td>
                                                                <td className="p-3 text-right text-slate-600 whitespace-nowrap">{checkPermission('feature_show_modal') ? formatCurrency(parseFloat(i.buyPrice) || 0) : '***'}</td>
                                                                <td className="p-3 text-right text-slate-700 whitespace-nowrap">{formatCurrency(parseFloat(i.sellPrice) || 0)}</td>
                                                                <td className="p-3 text-right font-bold text-emerald-600 whitespace-nowrap">{formatCurrency(parseFloat(i.sellPrice) * i.stock)}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    {/* Profit/Loss Detail */}
                                    {detailModal.type === 'profitloss-detail' && (
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                                    <p className="text-xs text-green-700 font-bold uppercase">Total Pemasukan</p>
                                                    <p className="text-xl font-black text-green-600">{formatCurrency(detailModal.data.income)}</p>
                                                </div>
                                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                                    <p className="text-xs text-red-700 font-bold uppercase">Total Pengeluaran</p>
                                                    <p className="text-xl font-black text-red-600">{formatCurrency(detailModal.data.expense)}</p>
                                                </div>
                                                <div className={`${detailModal.data.profit >= 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-orange-50 border-orange-200'} border rounded-lg p-4`}>
                                                    <p className={`text-xs font-bold uppercase ${detailModal.data.profit >= 0 ? 'text-emerald-700' : 'text-orange-700'}`}>Profit/Loss</p>
                                                    <p className={`text-xl font-black ${detailModal.data.profit >= 0 ? 'text-emerald-600' : 'text-orange-600'}`}>{formatCurrency(detailModal.data.profit)}</p>
                                                </div>
                                            </div>
                                            
                                            <h4 className="font-bold text-green-700 flex items-center gap-2">üì• Rincian Pemasukan ({detailModal.data.incomeData?.length || 0})</h4>
                                            <div className="overflow-x-auto mb-4">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-green-50"><tr><th className="p-2 text-left text-xs">Tanggal</th><th className="p-2 text-left text-xs">Keterangan</th><th className="p-2 text-right text-xs">Jumlah</th></tr></thead>
                                                    <tbody className="divide-y">
                                                        {(detailModal.data.incomeData || []).map((t, idx) => (
                                                            <tr key={idx} className="hover:bg-green-50">
                                                                <td className="p-2 text-xs text-slate-600">{formatDate(t.date || t.createdAt)}</td>
                                                                <td className="p-2 text-xs font-medium">{t.description || t.note || '-'}</td>
                                                                <td className="p-2 text-right text-xs font-bold text-green-600">+{formatCurrency(t.amount)}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>

                                            <h4 className="font-bold text-red-700 flex items-center gap-2">üì§ Rincian Pengeluaran ({detailModal.data.expenseData?.length || 0})</h4>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-red-50"><tr><th className="p-2 text-left text-xs">Tanggal</th><th className="p-2 text-left text-xs">Keterangan</th><th className="p-2 text-right text-xs">Jumlah</th></tr></thead>
                                                    <tbody className="divide-y">
                                                        {(detailModal.data.expenseData || []).map((t, idx) => (
                                                            <tr key={idx} className="hover:bg-red-50">
                                                                <td className="p-2 text-xs text-slate-600">{formatDate(t.date || t.createdAt)}</td>
                                                                <td className="p-2 text-xs font-medium">{t.description || t.note || '-'}</td>
                                                                <td className="p-2 text-right text-xs font-bold text-red-600">-{formatCurrency(t.amount)}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Laporan Bulanan / Tahunan */}
                    {compModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
                                <div className={`p-6 ${compModal === 'monthly' ? 'bg-gradient-to-r from-indigo-600 to-blue-600' : 'bg-gradient-to-r from-purple-700 to-indigo-700'}`}>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="text-white/70 text-xs font-bold uppercase tracking-wider mb-1">Generate Laporan</p>
                                            <h3 className="text-white font-black text-xl">{compModal === 'monthly' ? 'üìÖ Laporan Bulanan' : 'üìÜ Laporan Tahunan'}</h3>
                                            <p className="text-white/60 text-xs mt-1">Semua data dalam 1 PDF lengkap dengan cover</p>
                                        </div>
                                        <button onClick={() => setCompModal(null)} className="text-white/60 hover:text-white p-1"><X className="w-5 h-5"/></button>
                                    </div>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-2">Tahun</label>
                                        <select value={compYear} onChange={e => setCompYear(Number(e.target.value))}
                                            className="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm font-bold bg-white focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                                            {[...Array(5)].map((_,i) => { const y = new Date().getFullYear() - 2 + i; return React.createElement('option', {key:y, value:y}, y); })}
                                        </select>
                                    </div>
                                    {compModal === 'monthly' && (
                                        <div>
                                            <label className="block text-sm font-bold text-slate-700 mb-2">Bulan</label>
                                            <select value={compMonth} onChange={e => setCompMonth(Number(e.target.value))}
                                                className="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm font-bold bg-white focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                                                {MONTH_NAMES.map((m,i) => React.createElement('option', {key:i+1, value:i+1}, m))}
                                            </select>
                                        </div>
                                    )}
                                    <div className="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                        <p className="text-xs font-bold text-slate-500 uppercase mb-2">Yang akan diexport:</p>
                                        <div className="grid grid-cols-2 gap-1.5 text-xs text-slate-600">
                                            {['üìä Ringkasan Eksekutif','üõí Penjualan','üîß Servis + Status Bayar','üì¶ Inventaris','üí∞ Profit & Loss','üì§ Utang','üì• Piutang','‚úçÔ∏è Cover + TTD'].map(item => (
                                                <div key={item} className="flex items-center gap-1.5 bg-white rounded-lg px-2 py-1.5 border border-slate-100">
                                                    <span className="w-1.5 h-1.5 bg-green-500 rounded-full flex-shrink-0 inline-block"></span>
                                                    <span>{item}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => handleExportComprehensive(compModal, compYear, compMonth)}
                                        disabled={compLoading}
                                        className={`w-full py-3 rounded-xl font-black text-white text-sm flex items-center justify-center gap-2 transition-all ${compLoading ? 'opacity-60 cursor-not-allowed bg-slate-400' : compModal === 'monthly' ? 'bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 shadow-lg' : 'bg-gradient-to-r from-purple-700 to-indigo-600 hover:from-purple-800 hover:to-indigo-700 shadow-lg'}`}>
                                        {compLoading
                                            ? React.createElement(React.Fragment, null, React.createElement('span', {className:'animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full inline-block'}), ' Generating PDF...')
                                            : React.createElement(React.Fragment, null, React.createElement(Download, {className:'w-4 h-4'}), ' Export PDF ‚Äî ', compModal==='monthly' ? (MONTH_NAMES[compMonth-1]+' '+compYear) : ('Tahun '+compYear))
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ServiceManager = () => {
             const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
             const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
             const { data: inventory } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
             const [modal, setModal] = useState(null);
             const [payModal, setPayModal] = useState(null);
             const [addPartModal, setAddPartModal] = useState(null);
             const [printData, setPrint] = useState(null);
             const [showPrintModal, setShowPrintModal] = useState(false);
             const [store, setStore] = useState(activeStore);
             const [term, setTerm] = useState('');
             const [statusFilter, setStatusFilter] = useState('all');
             const [captureData, setCaptureData] = useState(null);
             const [invoiceShareState, setInvoiceShareState] = useState(null); // { dataUrl, blob, fileName, message, formattedPhone }
             const [allKelengkapanItems, setAllKelengkapanItems] = useState([]);
             const [allQCItems, setAllQCItems] = useState([]);
             const [currentPage, setCurrentPage] = useState(1);
             const [itemsPerPage, setItemsPerPage] = useState(10);
             const [waTrackingModal, setWaTrackingModal] = useState(null); // { service, newStatus }
             const [pendingWAAfterPay, setPendingWAAfterPay] = useState(null);
             const [printingAsImage, setPrintingAsImage] = useState(false);
             const [sharingAsImage, setSharingAsImage] = useState(false);
             
             // Subscribe langsung ke dokumen Firestore agar logo & alamat selalu fresh
             useEffect(() => {
                 if (!activeStore?.id) { setStore(activeStore); return; }
                 const storeRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'stores', activeStore.id);
                 const unsub = onSnapshot(storeRef, (snap) => {
                     if (snap.exists()) {
                         setStore({ id: snap.id, ...snap.data() });
                     } else {
                         setStore(activeStore);
                     }
                 });
                 return () => unsub();
             }, [activeStore?.id]);
             
             // Load Kelengkapan dan QC items ‚Äî langsung pakai PocketBase SDK (bypass adapter)
             // Gabungkan owner-specific items + master items
             useEffect(() => {
                 if (!activeOwner?.id) return;
                 let cancelled = false;
                 const loadItems = async () => {
                     try {
                         const oid = activeOwner.id;
                         console.log('üîç ServiceManager: loading QC & Kelengkapan for ownerId=', oid);
                         
                         // Fetch owner-specific items
                         const [qcResult, kelResult] = await Promise.all([
                             pb.collection('qc_functional_items').getList(1, 500, { filter: `ownerId="${oid}"` }),
                             pb.collection('kelengkapan_items').getList(1, 500, { filter: `ownerId="${oid}"` })
                         ]);
                         
                         // Fetch master items (global, tanpa ownerId)
                         let masterQCItems = [];
                         let masterKelItems = [];
                         try {
                             const masterQCResult = await pb.collection('master_qc_functional_items').getList(1, 500, {});
                             masterQCItems = masterQCResult.items.map(r => ({ id: r.id, name: r.name, type: 'master' }));
                         } catch (e) { console.warn('‚ö†Ô∏è master_qc_functional_items not found, skipping'); }
                         try {
                             const masterKelResult = await pb.collection('master_kelengkapan_items').getList(1, 500, {});
                             masterKelItems = masterKelResult.items.map(r => ({ id: r.id, name: r.name, type: 'master' }));
                         } catch (e) { console.warn('‚ö†Ô∏è master_kelengkapan_items not found, skipping'); }
                         
                         if (cancelled) return;
                         
                         // Merge: owner items + unique master items (by name)
                         const ownerQC = qcResult.items.map(r => ({ id: r.id, name: r.name, ownerId: r.ownerId, type: 'owner' }));
                         const ownerKel = kelResult.items.map(r => ({ id: r.id, name: r.name, ownerId: r.ownerId, type: 'owner' }));
                         
                         const qcNames = new Set(ownerQC.map(i => i.name.toLowerCase()));
                         const kelNames = new Set(ownerKel.map(i => i.name.toLowerCase()));
                         
                         const uniqueMasterQC = masterQCItems.filter(m => !qcNames.has(m.name.toLowerCase()));
                         const uniqueMasterKel = masterKelItems.filter(m => !kelNames.has(m.name.toLowerCase()));
                         
                         setAllQCItems([...uniqueMasterQC, ...ownerQC]);
                         setAllKelengkapanItems([...uniqueMasterKel, ...ownerKel]);
                         console.log('‚úÖ ServiceManager loaded QC: owner=', ownerQC.length, 'master=', uniqueMasterQC.length, '| Kelengkapan: owner=', ownerKel.length, 'master=', uniqueMasterKel.length);
                     } catch (err) {
                         console.warn('‚ö†Ô∏è ServiceManager loadItems error:', err);
                     }
                 };
                 loadItems();
                 return () => { cancelled = true; };
             }, [activeOwner?.id]);
             
             // Auto-recalculate profit untuk service yang belum punya profit transactions
             const recalculateRef = useRef(false);
             useEffect(() => {
                 const recalculateAllMissingProfits = async () => {
                     if (recalculateRef.current) return;
                     if (!activeOwner?.id || !activeStore?.id || services.length === 0) return;
                     
                     const recalcFlag = localStorage.getItem('profit_recalculated_date_fix');
                     if (recalcFlag === 'true') {
                         console.log('‚úÖ Profit already recalculated with service dates, skipping...');
                         return;
                     }
                     
                     // DISABLED: Auto-recalculate can cause errors on startup
                     // Only run manually if needed by removing this return
                     console.log('‚ö†Ô∏è Auto-recalculate disabled to prevent startup errors');
                     return;
                     
                     recalculateRef.current = true;
                     console.log('üîç Recalculating ALL profit transactions with correct service dates...');
                     
                     try {
                         // Recalculate SEMUA service (untuk fix tanggal)
                         const servicesToRecalc = services.filter(s => {
                             const hasParts = (s.usedParts || []).length > 0;
                             const hasFee = parseFloat(s.serviceFee || 0) > 0;
                             return hasParts || hasFee;
                         });
                         
                         if (servicesToRecalc.length === 0) {
                             console.log('‚úÖ No services to recalculate');
                             localStorage.setItem('profit_recalculated_date_fix', 'true');
                             return;
                         }
                         
                         console.log(`üîß Recalculating ${servicesToRecalc.length} services with correct dates...`);
                         
                         for (const service of servicesToRecalc) {
                             await recalculateServiceProfit(
                                 service.id,
                                 service,
                                 service.customerName,
                                 false // Hapus profit lama, buat yang baru dengan tanggal benar
                             );
                         }
                         
                         console.log('‚úÖ All profits recalculated with correct dates!');
                         localStorage.setItem('profit_recalculated_date_fix', 'true');
                         localStorage.removeItem('profit_recalculated_v1');
                         alert(`‚úÖ ${servicesToRecalc.length} profit transactions telah diupdate dengan tanggal yang benar!`);
                         
                     } catch (error) {
                         console.error('‚ùå Error during auto-recalculate:', error);
                         recalculateRef.current = false;
                     }
                 };
                 
                 if (services.length > 0 && !recalculateRef.current) {
                     const timer = setTimeout(() => {
                         recalculateAllMissingProfits();
                     }, 1000);
                     return () => clearTimeout(timer);
                 }
             }, [services.length, activeOwner?.id, activeStore?.id]);
             
             // Check for customer data from CustomerManager
             useEffect(() => {
                 // Small delay to ensure sessionStorage is written
                 const timer = setTimeout(() => {
                     const newServiceData = sessionStorage.getItem('newServiceData');
                     if (newServiceData) {
                         try {
                             const data = JSON.parse(newServiceData);
                             console.log('‚úÖ Loading service data from customer:', data);
                             setModal(data);
                             sessionStorage.removeItem('newServiceData');
                         } catch (e) {
                             console.error('‚ùå Error parsing service data:', e);
                         }
                     }
                     
                     // Check for auto-open from Dashboard
                     const autoOpen = sessionStorage.getItem('autoOpenServiceForm');
                     if (autoOpen === 'true') {
                         console.log('‚úÖ Auto-opening service form from Dashboard');
                         setModal({ownerId: activeOwner?.id});
                         sessionStorage.removeItem('autoOpenServiceForm');
                     }
                 }, 100);
                 return () => clearTimeout(timer);
             }, []);
             const canDelete = checkPermission('feature_delete');
             const canPrint = checkPermission('feature_print');
             const canShare = checkPermission('feature_share');
             
             // Fungsi untuk recalculate profit saat service diupdate
             const recalculateServiceProfit = async (serviceId, serviceData, customerName, skipDelete = false) => {
                 try {
                     // Null check untuk activeOwner dan activeStore
                     if (!activeOwner?.id || !activeStore?.id) {
                         console.warn('‚ö†Ô∏è activeOwner or activeStore not available, skipping recalculate');
                         return;
                     }
                     
                     console.log('üîÑ Recalculating profit for service:', serviceId);
                     
                     const batch = writeBatch(db);
                     
                     // 1. Delete existing profit/loss transactions for this service (jika bukan batch recalculate)
                     if (!skipDelete) {
                         try {
                             const transactionsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                             
                             // Split query - fetch profit transactions
                             const qProfit = query(
                                 transactionsRef, 
                                 where('serviceId', '==', serviceId),
                                 where('type', '==', 'profit')
                             );
                             
                             // Split query - fetch loss transactions
                             const qLoss = query(
                                 transactionsRef, 
                                 where('serviceId', '==', serviceId),
                                 where('type', '==', 'loss')
                             );
                             
                             const [profitSnapshot, lossSnapshot] = await Promise.all([
                                 getDocs(qProfit),
                                 getDocs(qLoss)
                             ]);
                             
                             let deletedCount = 0;
                             profitSnapshot.forEach((doc) => {
                                 batch.delete(doc.ref);
                                 deletedCount++;
                             });
                             lossSnapshot.forEach((doc) => {
                                 batch.delete(doc.ref);
                                 deletedCount++;
                             });
                             
                             console.log(`üóëÔ∏è Deleting ${deletedCount} old profit/loss transactions`);
                         } catch (queryError) {
                             console.error('‚ö†Ô∏è Error querying old transactions (will continue):', queryError.message);
                             // Continue anyway - create new transactions
                         }
                     }
                     
                     // 2. Calculate new profits
                     const usedParts = serviceData.usedParts || [];
                     const serviceFee = parseFloat(serviceData.serviceFee) || 0;
                     
                     // Profit from spareparts - hitung per part
                     let totalProfitParts = 0;
                     usedParts.forEach(part => {
                         if (!part.isManual) {
                             const buyPrice = parseFloat(part.buyPrice) || 0;
                             const sellPrice = parseFloat(part.sellPrice) || 0;
                             const qty = parseInt(part.qty) || 0;
                             const profitPerUnit = sellPrice - buyPrice;
                             const itemProfit = profitPerUnit * qty;
                             totalProfitParts += itemProfit;
                         }
                     });
                     
                     // Buat transaction untuk profit/loss sparepart (gabungan)
                     if (totalProfitParts !== 0) {
                         const transactionRef = doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'));
                         batch.set(transactionRef, {
                             ownerId: activeOwner.id,
                             storeId: activeStore.id,
                             type: totalProfitParts > 0 ? 'profit' : 'loss',
                             category: totalProfitParts > 0 ? 'Keuntungan Sparepart' : 'Rugi Sparepart',
                             description: `${totalProfitParts > 0 ? 'Profit' : 'Loss'} sparepart untuk ${customerName || 'Customer'}`,
                             amount: Math.abs(totalProfitParts),
                             date: serviceData.createdAt || serverTimestamp(),
                             createdAt: serviceData.createdAt || serverTimestamp(),
                             serviceId: serviceId
                         });
                         console.log(`üí∞ Creating ${totalProfitParts > 0 ? 'profit' : 'loss'} transaction for parts: Rp ${Math.abs(totalProfitParts).toLocaleString('id-ID')}`);
                     }
                     
                     // Profit from service fee
                     // Untung Jasa = Total Biaya - Harga Jual Sparepart
                     const partsJual = usedParts.reduce((acc, part) => acc + (parseFloat(part.sellPrice || 0) * part.qty), 0);
                     const jasaProfit = serviceFee - partsJual;
                     if (jasaProfit > 0) {
                         const transactionRef = doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'));
                         batch.set(transactionRef, {
                             ownerId: activeOwner.id,
                             storeId: activeStore.id,
                             type: 'profit',
                             category: 'Keuntungan Jasa Servis',
                             description: `Profit jasa servis untuk ${customerName || 'Customer'}`,
                             amount: jasaProfit,
                             date: serviceData.createdAt || serverTimestamp(),
                             createdAt: serviceData.createdAt || serverTimestamp(),
                             serviceId: serviceId
                         });
                         console.log(`üí∞ Creating profit transaction for service fee: Rp ${jasaProfit.toLocaleString('id-ID')}`);
                     }
                     
                     // 3. Commit batch
                     await batch.commit();
                     console.log('‚úÖ Profit recalculation completed successfully');
                     
                 } catch (error) {
                     console.error('‚ùå Error recalculating profit:', {
                         message: error?.message || 'Unknown error',
                         serviceId,
                         error: error
                     });
                     // Don't throw - allow service save to continue even if profit calc fails
                 }
             };
             
             const saveService = async (data) => { 
                const totalBiaya = parseFloat(data.serviceFee) || 0; // Total Biaya sudah termasuk harga jual sparepart
                const partsTotal = (data.usedParts || []).reduce((acc, p) => acc + (parseFloat(p.sellPrice) * p.qty), 0); 
                const paid = parseFloat(data.dp) || 0; 
                let paymentStatus = 'Belum Lunas'; 
                if (paid >= totalBiaya && totalBiaya > 0) paymentStatus = 'Lunas'; 
                else if (paid > 0) paymentStatus = 'DP'; 
                
                // ‚úÖ MAP form field names TO PocketBase database field names
                // Form uses: phone, unitType, complaint, imei, warranty
                // PocketBase uses: customerPhone, deviceModel, problem, deviceSN, warrantyDays
                const payload = { 
                    ...data,
                    // Map to PocketBase field names
                    customerPhone: data.phone || data.customerPhone || '', 
                    deviceModel: data.unitType || data.deviceModel || '',
                    problem: data.complaint || data.problem || '',
                    deviceSN: data.imei || data.deviceSN || '',
                    warrantyDays: parseInt(data.warranty) || parseInt(data.warrantyDays) || 0,
                    // Standard fields
                    costEstimate: totalBiaya, 
                    ownerId: activeOwner.id, 
                    storeId: activeStore.id, 
                    paymentStatus, 
                    updatedAt: serverTimestamp(), 
                    token: data.token || generateToken() 
                };
                
                // Remove form-only field names that don't exist in PocketBase schema
                delete payload.phone;
                delete payload.unitType;
                delete payload.complaint;
                delete payload.imei;
                delete payload.warranty;
                delete payload.device;
                delete payload.deviceType;
                
                 try { 
                     if (modal.id) { 
                         // UPDATE existing service - compare old vs new parts for stock adjustment
                         const oldService = services.find(s => s.id === modal.id);
                         const oldParts = oldService?.usedParts || [];
                         const newParts = data.usedParts || [];
                         
                         // Batch write for stock adjustments
                         const batch = writeBatch(db);
                         
                         // Restore stock for parts removed in this edit
                         oldParts.forEach(oldPart => {
                             if (!oldPart.isManual && !newParts.some(np => np.id === oldPart.id && np.qty === oldPart.qty)) {
                                 const removedQty = oldPart.qty - (newParts.find(np => np.id === oldPart.id)?.qty || 0);
                                 if (removedQty > 0) {
                                     const ref = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', oldPart.id);
                                     batch.update(ref, { stock: increment(removedQty) });
                                 }
                             }
                         });
                         
                         // Decrease stock for parts added or increased in this edit
                         newParts.forEach(newPart => {
                             if (!newPart.isManual) {
                                 const oldQty = oldParts.find(op => op.id === newPart.id)?.qty || 0;
                                 const decreaseQty = newPart.qty - oldQty;
                                 if (decreaseQty > 0) {
                                     const ref = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', newPart.id);
                                     batch.update(ref, { stock: increment(-decreaseQty) });
                                 }
                             }
                         });
                         
                         await batch.commit();
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', modal.id), payload);
                         
                         // Recalculate and update profit transactions saat EDIT
                         await recalculateServiceProfit(modal.id, data, payload.customerName);

                         // Sync sparepart ke riwayat penjualan
                         await syncServicePartsToSales(modal.id, data, payload);
                     } else { 
                         // CREATE new service - DECREASE stock for all used parts
                         const batch = writeBatch(db);
                         
                         // Decrease stock for each part from inventory
                         (data.usedParts || []).forEach(part => {
                             if (!part.isManual) {
                                 const ref = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id);
                                 batch.update(ref, { stock: increment(-part.qty) });
                             }
                         });
                         
                         payload.createdAt = serverTimestamp(); 
                         await batch.commit(); // Commit stock updates first
                         
                         const serviceRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'services'), payload);
                         
                         // üîÑ Sync address & phone ke customers collection
                         if (payload.customerName && (data.address || payload.customerPhone)) {
                             try {
                                 const custQ = query(
                                     collection(db, APP_COLLECTION_PREFIX, 'public', 'customers'),
                                     where('ownerId', '==', activeOwner.id),
                                     where('name', '==', payload.customerName)
                                 );
                                 const custSnap = await getDocs(custQ);
                                 if (custSnap.empty) {
                                     // Tidak ada record ‚Üí buat baru
                                     if (data.address || payload.customerPhone) {
                                         await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers'), {
                                             ownerId: activeOwner.id,
                                             storeId: activeStore.id,
                                             name: payload.customerName,
                                             phone: payload.customerPhone || '',
                                             address: data.address || '',
                                             createdAt: serverTimestamp()
                                         });
                                     }
                                 } else {
                                     // Sudah ada ‚Üí update address jika kosong atau berubah
                                     const custDoc = custSnap.docs[0];
                                     const custData = custDoc.data();
                                     const updates = {};
                                     if (data.address && data.address !== custData.address) updates.address = data.address;
                                     if (payload.customerPhone && !custData.phone) updates.phone = payload.customerPhone;
                                     if (Object.keys(updates).length > 0) {
                                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', custDoc.id), updates);
                                     }
                                 }
                             } catch(e) { /* ignore customer sync error */ }
                         }
                         const transactionBatch = writeBatch(db);
                         
                         // 1. INCOME transaction (jasa service)
                         if (paid > 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), { 
                                 ownerId: activeOwner.id, 
                                 storeId: activeStore.id, 
                                 type: 'income', 
                                 amount: paid, 
                                 category: 'DP Servis', 
                                 description: `DP ${payload.customerName}`, 
                                 date: serverTimestamp(), 
                                 serviceId: serviceRef.id,
                                 cashAccount: data.cashAccount || 'Kas Tunai'
                             }); 
                         }
                         
                         // 2. EXPENSE transaction (modal dari sparepart yang dijual)
                         const modalSparepart = (data.usedParts || []).reduce((acc, p) => {
                             if (!p.isManual) {
                                 acc += (parseFloat(p.buyPrice || 0) * p.qty);
                             }
                             return acc;
                         }, 0);
                         
                         if (modalSparepart > 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: 'expense',
                                 category: 'Modal Sparepart Dijual',
                                 description: `Modal sparepart untuk ${payload.customerName}`,
                                 amount: modalSparepart,
                                 date: serverTimestamp(),
                                 serviceId: serviceRef.id,
                                 cashAccount: data.cashAccount || 'Kas Tunai',
                                 items: (data.usedParts || []).filter(p => !p.isManual).map(p => ({
                                     name: p.name,
                                     qty: p.qty,
                                     buyPrice: p.buyPrice,
                                     subtotal: (parseFloat(p.buyPrice || 0) * p.qty)
                                 }))
                             });
                         }
                         
                         // 3. PROFIT/LOSS transaction (keuntungan dari sparepart)
                         let profitSparepart = 0;
                         (data.usedParts || []).forEach(p => {
                             if (!p.isManual) {
                                 const itemProfit = ((parseFloat(p.sellPrice) || 0) - (parseFloat(p.buyPrice) || 0)) * p.qty;
                                 profitSparepart += itemProfit;
                             }
                         });
                         
                         if (profitSparepart !== 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: profitSparepart > 0 ? 'profit' : 'loss',
                                 category: profitSparepart > 0 ? 'Keuntungan Sparepart' : 'Rugi Sparepart',
                                 description: `${profitSparepart > 0 ? 'Profit' : 'Loss'} sparepart untuk ${payload.customerName}`,
                                 amount: Math.abs(profitSparepart),
                                 date: serverTimestamp(),
                                 createdAt: serverTimestamp(),
                                 serviceId: serviceRef.id,
                                 cashAccount: data.cashAccount || 'Kas Tunai'
                             });
                         }
                         
                         // 4. PROFIT transaction (keuntungan dari jasa service)
                         // Untung Jasa = Total Biaya - Harga Jual Sparepart
                         const partsJualTotal = (data.usedParts || []).reduce((acc, p) => acc + (parseFloat(p.sellPrice || 0) * p.qty), 0);
                         const jasaProfit = (parseFloat(data.serviceFee) || 0) - partsJualTotal;
                         if (jasaProfit > 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: 'profit',
                                 category: 'Keuntungan Jasa Servis',
                                 description: `Profit jasa servis untuk ${payload.customerName}`,
                                 amount: jasaProfit,
                                 date: serverTimestamp(),
                                 createdAt: serverTimestamp(),
                                 serviceId: serviceRef.id,
                                 cashAccount: data.cashAccount || 'Kas Tunai'
                             });
                         }
                         
                         await transactionBatch.commit();

                         // ‚úÖ Catat DP ke cash_flow agar saldo kas terupdate saat servis dibuat
                         if (paid > 0) {
                             await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: 'in',
                                 amount: paid,
                                 category: 'DP Servis',
                                 description: `DP servis ${payload.customerName}`,
                                 account: payload.cashAccount || 'Kas Tunai',
                                 serviceId: serviceRef.id,
                                 createdAt: serverTimestamp()
                             });
                         }

                         // Sync sparepart ke riwayat penjualan
                         await syncServicePartsToSales(serviceRef.id, data, payload);
                     } 
                     setModal(null); 
                 } catch(err) { alert("Gagal simpan: " + err.message); } 
             };
             const handlePay = async (service, amount, method, cashAccount) => {
                 try {
                     const parsedAmount = parseFloat(amount);
                     const newPaid = (parseFloat(service.dp) || 0) + parsedAmount;
                     const isPaidOff = newPaid >= service.costEstimate;
                     const account = cashAccount || 'Kas Tunai';
                     // Update status servis
                     await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', service.id), {
                         dp: newPaid,
                         paymentStatus: isPaidOff ? 'Lunas' : 'DP'
                     });
                     // Catat ke transactions
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                         ownerId: activeOwner.id,
                         storeId: activeStore.id,
                         type: 'income',
                         amount: parsedAmount,
                         category: 'Pelunasan Servis',
                         description: `Bayar ${service.customerName} (${method})`,
                         date: serverTimestamp(),
                         serviceId: service.id,
                         cashAccount: account
                     });
                     // ‚úÖ Catat ke cash_flow agar saldo kas terupdate (serviceId wajib untuk sinkronisasi hapus)
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), {
                         ownerId: activeOwner.id,
                         storeId: activeStore.id,
                         type: 'in',
                         amount: parsedAmount,
                         category: 'Pembayaran Servis',
                         description: `Bayar servis ${service.customerName} (${method})`,
                         account: account,
                         serviceId: service.id,
                         createdAt: serverTimestamp()
                     });
                     setPayModal(null);
                     // Tampilkan WA tracking setelah bayar jika ada pending
                     if (pendingWAAfterPay) {
                         const updatedService = { ...pendingWAAfterPay.service, dp: (parseFloat(service.dp)||0) + parsedAmount, paymentStatus: isPaidOff ? 'Lunas' : 'DP' };
                         setWaTrackingModal({ service: updatedService, newStatus: pendingWAAfterPay.newStatus });
                         setPendingWAAfterPay(null);
                     }
                 } catch(err) { alert("Gagal bayar: " + err.message); }
             };
             const deleteService = async (id) => { 
                 if(confirm("Hapus data servis ini?")) { 
                     try { 
                         console.log('üóëÔ∏è Starting service deletion for ID:', id);
                         
                         // Check if service exists first
                         const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', id);
                         const serviceDoc = await getDoc(serviceRef);
                         
                         if (!serviceDoc.exists()) {
                             alert("‚ùå Data servis tidak ditemukan di database!");
                             return;
                         }
                         
                         const serviceData = serviceDoc.data();
                         console.log('üìÑ Service data found:', serviceData);
                         
                         // Restore stock if service has used parts
                         if (serviceData.usedParts && serviceData.usedParts.length > 0) { 
                             console.log('üîÑ Restoring stock for used parts...');
                             for (const part of serviceData.usedParts) { 
                                 try {
                                     const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id); 
                                     const invDoc = await getDoc(invRef);
                                     if (invDoc.exists()) {
                                         const currentStock = invDoc.data().stock || 0;
                                         await updateDoc(invRef, {stock: currentStock + (part.qty || 0)}); 
                                         console.log(`‚úÖ Stock restored for ${part.name}: +${part.qty}`);
                                     }
                                 } catch (partError) {
                                     console.warn(`‚ö†Ô∏è Failed to restore stock for part ${part.id}:`, partError);
                                 }
                             } 
                         }
                         
                         // Delete related transactions
                         console.log('üóëÔ∏è Deleting related transactions...');
                         const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'); 
                         const tq = query(transRef, where('serviceId', '==', id)); 
                         const tSnap = await getDocs(tq); 
                         
                         if (tSnap.docs.length > 0) {
                             const tbatch = writeBatch(db); 
                             tSnap.docs.forEach(d => tbatch.delete(d.ref)); 
                             await tbatch.commit(); 
                             console.log(`‚úÖ Deleted ${tSnap.docs.length} related transactions`);
                         }

                         // ‚úÖ Delete related cash_flow entries agar saldo kas terupdate
                         console.log('üóëÔ∏è Deleting related cash_flow entries...');
                         const cfRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow');
                         const cfq = query(cfRef, where('serviceId', '==', id));
                         const cfSnap = await getDocs(cfq);
                         if (cfSnap.docs.length > 0) {
                             const cfBatch = writeBatch(db);
                             cfSnap.docs.forEach(d => cfBatch.delete(d.ref));
                             await cfBatch.commit();
                             console.log(`‚úÖ Deleted ${cfSnap.docs.length} cash_flow entries ‚Üí saldo kas diperbarui`);
                         }
                         
                         // Finally delete the service document
                         console.log('üóëÔ∏è Deleting service document...');
                         await deleteDoc(serviceRef); 
                         console.log('‚úÖ Service deleted successfully');
                         
                         alert("‚úÖ Servis berhasil dihapus. Stok, transaksi & saldo kas sudah dikembalikan."); 
                         
                     } catch(err) { 
                         console.error('‚ùå Error deleting service:', err);
                         
                         // More specific error messages
                         let errorMessage = "‚ùå Gagal hapus servis: ";
                         if (err.code === 'not-found') {
                             errorMessage += "Data tidak ditemukan";
                         } else if (err.code === 'permission-denied') {
                             errorMessage += "Tidak ada izin";
                         } else {
                             errorMessage += err.message;
                         }
                         
                         alert(errorMessage); 
                     } 
                 } 
             };

             // NEW: Delete All Services Function
             const deleteAllServices = async () => {
                 const confirmText = prompt(
                     "‚ö†Ô∏è PERINGATAN: Ini akan menghapus SEMUA data servis!\n\nKetik 'HAPUS SEMUA' untuk konfirmasi:"
                 );
                 
                 if (confirmText !== 'HAPUS SEMUA') {
                     alert('‚ùå Konfirmasi dibatalkan');
                     return;
                 }
                 
                 if (!confirm(`üö® KONFIRMASI TERAKHIR\n\nAnda akan menghapus ${services.length} data servis.\nStok spare part akan dikembalikan.\nTransaksi terkait akan dihapus.\n\nLanjutkan?`)) {
                     return;
                 }
                 
                 try {
                     console.log('üóëÔ∏è Starting bulk service deletion...');
                     
                     let restoredParts = 0;
                     let deletedTransactions = 0;
                     
                     // Process each service
                     for (const service of services) {
                         console.log(`Processing service ${service.id}...`);
                         
                         // Restore stock if service has used parts
                         if (service.usedParts && service.usedParts.length > 0) {
                             for (const part of service.usedParts) {
                                 try {
                                     const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id);
                                     const invDoc = await getDoc(invRef);
                                     if (invDoc.exists()) {
                                         const currentStock = invDoc.data().stock || 0;
                                         await updateDoc(invRef, {stock: currentStock + (part.qty || 0)});
                                         restoredParts++;
                                     }
                                 } catch (partError) {
                                     console.warn(`‚ö†Ô∏è Failed to restore part ${part.id}:`, partError);
                                 }
                             }
                         }
                         
                         // Delete related transactions
                         const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                         const tq = query(transRef, where('serviceId', '==', service.id));
                         const tSnap = await getDocs(tq);
                         
                         if (tSnap.docs.length > 0) {
                             const tbatch = writeBatch(db);
                             tSnap.docs.forEach(d => tbatch.delete(d.ref));
                             await tbatch.commit();
                             deletedTransactions += tSnap.docs.length;
                         }
                     }
                     
                     // Delete all services in batches
                     const serviceRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'services');
                     const serviceQuery = query(serviceRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                     const serviceSnap = await getDocs(serviceQuery);
                     
                     const batchArray = [];
                     let currentBatch = writeBatch(db);
                     let count = 0;
                     
                     serviceSnap.docs.forEach(doc => {
                         currentBatch.delete(doc.ref);
                         count++;
                         if (count >= 450) {
                             batchArray.push(currentBatch);
                             currentBatch = writeBatch(db);
                             count = 0;
                         }
                     });
                     
                     if (count > 0) {
                         batchArray.push(currentBatch);
                     }
                     
                     // Commit all batches
                     for (const batch of batchArray) {
                         await batch.commit();
                     }
                     
                     console.log('‚úÖ Bulk deletion completed');
                     alert(`‚úÖ BERHASIL!\n\nüìã ${serviceSnap.docs.length} servis dihapus\nüì¶ ${restoredParts} stok dikembalikan\nüí∞ ${deletedTransactions} transaksi dihapus`);
                     
                 } catch (err) {
                     console.error('‚ùå Error in bulk deletion:', err);
                     alert(`‚ùå Gagal hapus semua: ${err.message}`);
                 }
             };
             // Helper: Sync usedParts ke riwayat penjualan (sales)
             const syncServicePartsToSales = async (serviceId, data, payload) => {
                 if (!activeOwner?.id || !activeStore?.id) return;
                 const parts = (data.usedParts || []);

                 // Query existing sale linked to this service
                 const salesCol = collection(db, APP_COLLECTION_PREFIX, 'public', 'sales');
                 const existingSnap = await getDocs(query(salesCol, where('sourceServiceId', '==', serviceId)));

                 if (parts.length === 0) {
                     // Hapus linked sale jika semua sparepart dihapus
                     if (!existingSnap.empty) {
                         const delBatch = writeBatch(db);
                         existingSnap.docs.forEach(d => delBatch.delete(d.ref));
                         await delBatch.commit();
                         console.log(`üóëÔ∏è Linked sale dihapus karena semua sparepart dihapus dari servis ${serviceId}`);
                     }
                     return;
                 }

                 const items = parts.map(p => ({
                     id: p.id || null,
                     name: p.name,
                     category: p.category || 'Sparepart',
                     brand: p.brand || '',
                     qty: p.qty,
                     sellPrice: parseFloat(p.sellPrice) || 0,
                     buyPrice: parseFloat(p.buyPrice) || 0,
                     isManual: p.isManual || false,
                 }));

                 const subtotalParts = items.reduce((s, i) => s + (i.sellPrice * i.qty), 0);
                 const modalParts   = items.reduce((s, i) => s + (i.buyPrice * i.qty), 0);
                 const profitParts  = subtotalParts - modalParts;

                 const saleData = {
                     customerName: payload.customerName,
                     customerId: payload.customerId || null,
                     items,
                     subtotal: subtotalParts,
                     discount: 0,
                     discountAmount: 0,
                     total: subtotalParts,
                     profit: profitParts,
                     modal: modalParts,
                     paymentMethod: 'cash',
                     cashAccount: data.cashAccount || 'Kas Tunai',
                     ownerId: activeOwner.id,
                     storeId: activeStore.id,
                     type: 'service_sale',
                     status: 'active',
                     sourceServiceId: serviceId,
                     updatedAt: serverTimestamp(),
                 };

                 if (!existingSnap.empty) {
                     await updateDoc(existingSnap.docs[0].ref, saleData);
                     console.log(`üîÑ Linked sale diperbarui untuk servis ${serviceId}`);
                 } else {
                     await addDoc(salesCol, { ...saleData, createdAt: serverTimestamp() });
                     console.log(`‚úÖ Linked sale dibuat untuk servis ${serviceId}`);
                 }
             };

             const getStatusWAMessage = (service, newStatus) => {
                 const fmt = (n) => 'Rp ' + (n||0).toLocaleString('id-ID');
                 const statusEmoji = { 'Diterima': 'üì•', 'Diagnosa': 'üîç', 'Dikerjakan': 'üîß', 'Menunggu Sparepart': '‚è≥', 'Selesai': '‚úÖ', 'Diambil': 'üì¶', 'Dibatalkan': '‚ùå' };
                 const statusMsg = { 
                     'Diterima': 'HP/perangkat Anda sudah kami terima dan akan segera diproses.',
                     'Diagnosa': 'Perangkat Anda sedang dalam tahap diagnosa oleh teknisi kami.',
                     'Dikerjakan': 'Perangkat Anda sedang dikerjakan oleh teknisi kami.',
                     'Menunggu Sparepart': 'Proses servis perlu menunggu kedatangan sparepart.',
                     'Selesai': 'Perangkat Anda sudah selesai diperbaiki dan siap diambil! üéâ',
                     'Diambil': 'Perangkat Anda sudah diambil. Terima kasih telah mempercayakan servis kepada kami! üôè',
                     'Dibatalkan': 'Mohon maaf, proses servis perangkat Anda dibatalkan.',
                 };
                 const storeName = store?.name || activeStore?.name || 'Toko Kami';
                 const total = parseFloat(service.costEstimate) || 0;
                 const paid = parseFloat(service.dp) || 0;
                 const remaining = total - paid;
                 let payInfo = '';
                 if (service.paymentStatus === 'Lunas' || remaining <= 0) payInfo = 'üí≥ Status Bayar: *LUNAS* ‚úÖ';
                 else if (paid > 0) payInfo = `üí≥ DP: ${fmt(paid)} | Sisa: *${fmt(remaining)}*`;
                 else if (total > 0) payInfo = `üí≥ Total Biaya: *${fmt(total)}*`;
                 const trackingLink = `${window.location.origin}${window.location.pathname}?track=${service.id}`;
                 return `Halo Kak *${service.customerName}* üëã\n\n` +
                     `${statusEmoji[newStatus]||'üîÑ'} *Update Status Servis:*\n` +
                     `*${newStatus.toUpperCase()}*\n\n` +
                     `${statusMsg[newStatus]||'Status servis Anda telah diperbarui.'}\n\n` +
                     `üìã *Detail Servis:*\n` +
                     `‚Ä¢ Perangkat: ${service.deviceModel||service.unitType||'-'}\n` +
                     `‚Ä¢ Keluhan: ${service.problem||service.complaint||'-'}\n` +
                     (service.token ? `‚Ä¢ No. Antrian: *${service.token}*\n` : '') +
                     (payInfo ? `‚Ä¢ ${payInfo}\n` : '') +
                     `\nüîó *Cek Progress Realtime:*\n${trackingLink}\n\n` +
                     `Dari: *${storeName}*` +
                     (store?.phone ? `\nüìû ${store.phone}` : '');
             };

             const updateStatus = async (id, newStatus) => { 
                 try {
                     const service = services.find(s => s.id === id);
                     const prevStatus = service?.status;

                     const statusUpdate = { status: newStatus };
                     // Set completedAt saat status berubah ke Selesai (dipakai AfterSalesCare)
                     if (newStatus === 'Selesai' && prevStatus !== 'Selesai') {
                         statusUpdate.completedAt = serverTimestamp();
                     }
                     await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', id), statusUpdate);
                     
                     // Status Selesai: payModal dulu, lalu WA popup
                     if (newStatus === 'Selesai') {
                         if (service && service.paymentStatus !== 'Lunas') {
                             const remainingAmount = (parseFloat(service.costEstimate) || 0) - (parseFloat(service.dp) || 0);
                             if (remainingAmount > 0) {
                                 setPendingWAAfterPay({ service: { ...service, status: newStatus }, newStatus });
                                 setPayModal(service);
                             } else {
                                 setWaTrackingModal({ service: { ...service, status: newStatus }, newStatus });
                             }
                         } else {
                             setWaTrackingModal({ service: { ...service, status: newStatus }, newStatus });
                         }
                     } else {
                         // Semua status lain: langsung WA popup
                         setWaTrackingModal({ service: { ...service, status: newStatus }, newStatus });
                     }

                     // Kembalikan stok sparepart ketika status diubah ke Dibatalkan
                     if (newStatus === 'Dibatalkan' && prevStatus !== 'Dibatalkan') {
                         const usedParts = service?.usedParts || [];
                         if (usedParts.length > 0) {
                             const batch = writeBatch(db);
                             let restoredCount = 0;
                             for (const part of usedParts) {
                                 if (!part.isManual && part.id) {
                                     const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id);
                                     batch.update(invRef, { stock: increment(part.qty || 0) });
                                     restoredCount++;
                                 }
                             }
                             if (restoredCount > 0) {
                                 await batch.commit();
                                 console.log(`‚úÖ Stok ${restoredCount} sparepart dikembalikan karena servis dibatalkan (ID: ${id})`);
                             }
                         }
                         // Tandai linked sale sebagai dibatalkan
                         const cancelSalesSnap = await getDocs(query(collection(db, APP_COLLECTION_PREFIX, 'public', 'sales'), where('sourceServiceId', '==', id)));
                         if (!cancelSalesSnap.empty) {
                             const cb = writeBatch(db);
                             cancelSalesSnap.docs.forEach(d => cb.update(d.ref, { status: 'cancelled', cancelledAt: serverTimestamp() }));
                             await cb.commit();
                             console.log(`üö´ Linked sale ditandai dibatalkan untuk servis ${id}`);
                         }
                     }

                     // Kurangi stok kembali jika status diubah DARI Dibatalkan ke status lain
                     if (prevStatus === 'Dibatalkan' && newStatus !== 'Dibatalkan') {
                         const usedParts = service?.usedParts || [];
                         if (usedParts.length > 0) {
                             const batch = writeBatch(db);
                             let decreasedCount = 0;
                             for (const part of usedParts) {
                                 if (!part.isManual && part.id) {
                                     const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id);
                                     batch.update(invRef, { stock: increment(-(part.qty || 0)) });
                                     decreasedCount++;
                                 }
                             }
                             if (decreasedCount > 0) {
                                 await batch.commit();
                                 console.log(`‚úÖ Stok ${decreasedCount} sparepart dikurangi kembali karena servis diaktifkan ulang (ID: ${id})`);
                             }
                         }
                         // Aktifkan kembali linked sale
                         const restoreSalesSnap = await getDocs(query(collection(db, APP_COLLECTION_PREFIX, 'public', 'sales'), where('sourceServiceId', '==', id)));
                         if (!restoreSalesSnap.empty) {
                             const rb = writeBatch(db);
                             restoreSalesSnap.docs.forEach(d => rb.update(d.ref, { status: 'active', cancelledAt: null }));
                             await rb.commit();
                             console.log(`‚úÖ Linked sale diaktifkan kembali untuk servis ${id}`);
                         }
                     }
                 } catch(err) {
                     console.error('Error updating status:', err);
                 } 
             };
             const print = (s) => { setPrint(s); setShowPrintModal(true); };
             const shareInvoiceAsImage = async (service) => { 
                const formattedPhone = formatWhatsAppNumber(service.customerPhone || service.phone);
                if (!formattedPhone) { alert('‚ö†Ô∏è Nomor WA pelanggan kosong!\nPastikan nomor HP pelanggan sudah diisi di form servis.'); return; }
                
                // Build WA message text
                const paid = parseFloat(service.dp) || 0;
                const total = parseFloat(service.costEstimate) || 0;
                const remaining = total - paid;
                let payInfo = '';
                if (service.paymentStatus === 'Lunas') payInfo = '‚úÖ Status Bayar: LUNAS';
                else if (service.paymentStatus === 'DP') payInfo = `‚è≥ DP: ${formatCurrency(paid)} | Sisa: ${formatCurrency(remaining)}`;
                else payInfo = `‚è≥ Status Bayar: Belum Dibayar | Total: ${formatCurrency(total)}`;
                
                const message = `Halo Kak ${service.customerName}! üëã\n\n` +
                    `Berikut *Invoice Servis* dari kami:\n` +
                    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                    `üÜî *Token:* ${service.token || service.publicToken}\n` +
                    `üì± *HP:* ${service.unitType || service.deviceModel || service.deviceType || '-'}\n` +
                    `üîß *Keluhan:* ${service.complaint || service.problem || '-'}\n` +
                    `‚öôÔ∏è *Status:* ${service.status}\n` +
                    `üí∞ *Total Biaya:* ${formatCurrency(total)}\n` +
                    `${payInfo}\n` +
                    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                    `Terimakasih telah mempercayakan servis kepada kami. üôè`;
                
                // Render invoice
                setCaptureData(service); 
                await new Promise(r => setTimeout(r, 800));
                const element = document.getElementById('invoice-capture'); 
                if (!element) { alert('Gagal membuat invoice'); setCaptureData(null); return; } 
                try { 
                    const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true, backgroundColor: '#ffffff' }); 
                    canvas.toBlob((blob) => { 
                        setCaptureData(null);
                        const fileName = `Invoice-${service.token || service.id}.jpg`;
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
                        
                        // AUTO-DOWNLOAD langsung tanpa konfirmasi
                        const dlUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = dlUrl;
                        a.download = fileName;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        setTimeout(() => URL.revokeObjectURL(dlUrl), 10000);
                        
                        // Tampilkan modal preview + tombol buka WA
                        setInvoiceShareState({ blob, dataUrl, fileName, message, formattedPhone, customerName: service.customerName, token: service.token || service.id });
                    }, 'image/jpeg', 0.95); 
                } catch (err) { setCaptureData(null); console.error(err); alert('Gagal membuat invoice: ' + err.message); } 
             };
             const filtered = services.filter(s => (s.customerName.toLowerCase().includes(term) || (s.token || s.publicToken || '').includes(term)) && (statusFilter === 'all' || s.status === statusFilter));
             
             // Pagination logic
             const totalItems = filtered.length;
             const totalPages = Math.ceil(totalItems / itemsPerPage);
             const startIndex = (currentPage - 1) * itemsPerPage;
             const endIndex = startIndex + itemsPerPage;
             const paginatedData = filtered.slice(startIndex, endIndex);
             
             // Reset to page 1 when filter changes
             useEffect(() => {
                 setCurrentPage(1);
             }, [statusFilter, term]);
             
             const handlePageChange = (newPage) => {
                 if (newPage >= 1 && newPage <= totalPages) {
                     setCurrentPage(newPage);
                     window.scrollTo({ top: 0, behavior: 'smooth' });
                 }
             };
             
             const handleItemsPerPageChange = (value) => {
                 setItemsPerPage(value);
                 setCurrentPage(1);
             };
             
             return (
                 <div className="space-y-6 no-print">
                     {/* Status Filter */}
                     <div className="flex flex-wrap gap-2 bg-white p-4 rounded-xl shadow-sm border border-gray-100 sticky top-16 md:top-0 z-10 overflow-x-auto">
                        {['all', ...STATUS_FLOW].map(status => {
                            const statusEmoji = {
                                'all': 'üìã Semua',
                                'Diterima': 'üì• Diterima',
                                'Diagnosa': 'üîç Diagnosa',
                                'Proses': '‚öôÔ∏è Proses',
                                'Menunggu Sparepart': '‚è≥ Menunggu Spare',
                                'Selesai': '‚úÖ Selesai',
                                'Diambil': 'üì¶ Diambil',
                                'Dibatalkan': '‚ùå Batal',
                                'Garansi': 'üîß Garansi'
                            };
                            return (
                                <button
                                    key={status}
                                    onClick={() => setStatusFilter(status)}
                                    className={`px-3 py-2 rounded-lg font-bold text-xs md:text-sm transition-all whitespace-nowrap ${
                                        statusFilter === status
                                            ? 'bg-blue-600 text-white shadow-lg'
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                                >
                                    {statusEmoji[status]}
                                </button>
                            );
                        })}
                     </div>

                     <div className="flex flex-col md:flex-row justify-between gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100 sticky top-28 md:top-0 z-10">
                        <div className="relative flex-1"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={term} onChange={e => setTerm(e.target.value)} placeholder="Cari pelanggan / token..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition-all" /></div>
                        <div className="flex gap-2">
                            <button onClick={deleteAllServices} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-red-500/30 transition-all hover:scale-105" title="Hapus Semua Data Service"><Trash2 className="w-4 h-4"/> Hapus Semua</button>
                            <button onClick={()=>setModal({ownerId: activeOwner?.id})} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30 transition-all hover:scale-105"><Plus className="w-5 h-5"/> Servis Baru</button>
                        </div>
                     </div>

                     <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        {/* MOBILE CARDS */}
                        <div className="md:hidden divide-y divide-slate-100">
                            {paginatedData.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada data ditemukan.</div>}
                            {paginatedData.map(s => {
                                const sisa = (s.costEstimate || 0) - (s.dp || 0);
                                const cardBg = s.status === 'Diterima' ? 'border-l-4 border-l-blue-400' : s.status === 'Diagnosa' ? 'border-l-4 border-l-yellow-400' : s.status === 'Dikerjakan' ? 'border-l-4 border-l-purple-400' : s.status === 'Menunggu Sparepart' ? 'border-l-4 border-l-orange-400' : s.status === 'Selesai' ? 'border-l-4 border-l-green-400' : s.status === 'Diambil' ? 'border-l-4 border-l-emerald-400' : s.status === 'Dibatalkan' ? 'border-l-4 border-l-red-400' : '';
                                return (
                                    <div key={s.id} className={`p-4 ${cardBg}`}>
                                        <div className="flex justify-between items-start gap-2 mb-2">
                                            <div className="flex-1 min-w-0">
                                                <p className="font-bold text-slate-800 truncate">{s.customerName}</p>
                                                <p className="text-xs text-slate-500 flex items-center gap-1 mt-0.5"><Smartphone className="w-3 h-3 flex-shrink-0"/><span className="truncate">{s.deviceModel || s.unitType || s.device}</span></p>
                                                <p className="text-[10px] text-slate-400 mt-0.5">{formatDate(s.createdAt)} ¬∑ {s.token || s.publicToken}</p>
                                            </div>
                                            <select value={s.status} onChange={e => updateStatus(s.id, e.target.value)} onClick={e => e.stopPropagation()} className={`text-xs font-bold border rounded-lg px-2 py-1.5 flex-shrink-0 ${s.status === 'Diterima' ? 'bg-blue-100 text-blue-700 border-blue-200' : s.status === 'Diagnosa' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : s.status === 'Dikerjakan' ? 'bg-purple-100 text-purple-700 border-purple-200' : s.status === 'Menunggu Sparepart' ? 'bg-orange-100 text-orange-700 border-orange-200' : s.status === 'Selesai' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200'}`}>{STATUS_FLOW.map(st => <option key={st} value={st}>{st}</option>)}</select>
                                        </div>
                                        <div className="flex justify-between items-center mb-2">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <span className={`px-2 py-0.5 rounded text-[10px] font-black uppercase border ${s.paymentStatus === 'Lunas' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : s.paymentStatus === 'DP' ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>{s.paymentStatus || 'Belum'}</span>
                                                {s.paymentStatus !== 'Lunas' && sisa > 0 && <span className="text-[10px] text-red-500 font-medium">Sisa: {formatCurrency(sisa)}</span>}
                                            </div>
                                            <span className="font-bold text-slate-700">{formatCurrency(s.costEstimate)}</span>
                                        </div>
                                        {s.paymentStatus !== 'Lunas' && <button onClick={() => setPayModal(s)} className="w-full mb-2 py-2 text-xs font-bold text-blue-700 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-center gap-1.5 hover:bg-blue-100"><DollarSign className="w-3.5 h-3.5"/>Bayar {s.paymentStatus === 'DP' ? 'Sisa' : 'Sekarang'}</button>}
                                        <div className="flex flex-col gap-1.5 pt-2 border-t border-slate-200">
                                            {/* Baris 1: Edit, Part, Print */}
                                            <div className="flex gap-1.5">
                                                <button onClick={() => setModal(s)} className="flex-1 py-2 bg-white border border-slate-200 rounded-lg text-slate-500 hover:text-blue-600 flex items-center justify-center gap-1 text-xs shadow-sm"><Settings className="w-3.5 h-3.5"/>Edit</button>
                                                <button onClick={() => setAddPartModal(s)} className="flex-1 py-2 bg-purple-50 border border-purple-200 rounded-lg text-purple-600 flex items-center justify-center gap-1 text-xs shadow-sm"><PackagePlus className="w-3.5 h-3.5"/>Part</button>
                                                {canPrint ? <button onClick={() => print(s)} className="flex-1 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 flex items-center justify-center gap-1 text-xs shadow-sm"><Printer className="w-3.5 h-3.5"/>Print</button> : <button disabled className="flex-1 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-400 text-xs flex items-center justify-center"><Lock className="w-3.5 h-3.5"/></button>}
                                            </div>
                                            {/* Baris 2: WA Progress, Invoice JPEG, Hapus */}
                                            <div className="flex gap-1.5">
                                                {canShare ? <button onClick={() => handleShareProgress(s)} className="flex-1 py-2 bg-white border border-green-200 rounded-lg text-green-600 flex items-center justify-center gap-1 text-xs shadow-sm"><Share2 className="w-3.5 h-3.5"/>Progress</button> : <button disabled className="flex-1 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-400 text-xs flex items-center justify-center"><Lock className="w-3.5 h-3.5"/></button>}
                                                {canShare ? <button onClick={() => shareInvoiceAsImage(s)} className="flex-1 py-2 bg-pink-50 border border-pink-200 rounded-lg text-pink-600 flex items-center justify-center gap-1 text-xs shadow-sm"><ImageIcon className="w-3.5 h-3.5"/>Invoice</button> : <button disabled className="flex-1 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-400 text-xs flex items-center justify-center"><Lock className="w-3.5 h-3.5"/></button>}
                                                {canDelete ? <button onClick={() => deleteService(s.id)} className="flex-1 py-2 bg-white border border-red-100 rounded-lg text-red-500 flex items-center justify-center gap-1 text-xs shadow-sm"><Trash2 className="w-3.5 h-3.5"/>Hapus</button> : <button disabled className="flex-1 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-400 text-xs flex items-center justify-center"><Lock className="w-3.5 h-3.5"/></button>}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        {/* DESKTOP TABLE */}
                        <div className="hidden md:block overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-100 text-slate-600 font-bold border-b border-slate-200 uppercase text-xs tracking-wider"><tr><th className="px-3 md:px-6 py-3 md:py-4">Pelanggan / Unit</th><th className="px-3 md:px-6 py-3 md:py-4 bg-purple-50 text-purple-700">Sparepart</th><th className="px-3 md:px-6 py-3 md:py-4">Status</th><th className="px-3 md:px-6 py-3 md:py-4 hidden lg:table-cell">Pembayaran</th><th className="px-3 md:px-6 py-3 md:py-4">Total</th><th className="px-3 md:px-6 py-3 md:py-4 text-center">Aksi</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {paginatedData.map(s => {
                                        const sisa = (s.costEstimate || 0) - (s.dp || 0);
                                        const statusBgClass = s.status === 'Diterima' ? 'bg-blue-100 hover:bg-blue-200' : 
                                            s.status === 'Diagnosa' ? 'bg-yellow-100 hover:bg-yellow-200' : 
                                            s.status === 'Dikerjakan' ? 'bg-purple-100 hover:bg-purple-200' : 
                                            s.status === 'Menunggu Sparepart' ? 'bg-orange-100 hover:bg-orange-200' : 
                                            s.status === 'Selesai' ? 'bg-green-100 hover:bg-green-200' : 
                                            s.status === 'Diambil' ? 'bg-emerald-100 hover:bg-emerald-200' :
                                            s.status === 'Dibatalkan' ? 'bg-red-100 hover:bg-red-200' : 
                                            'bg-slate-100 hover:bg-slate-200';
                                        return (
                                            <tr key={s.id} className={`transition-colors ${statusBgClass}`}>
                                                <td className="px-3 md:px-6 py-3 md:py-4">
                                                    <div className="font-bold text-slate-800 text-base">{s.customerName}</div>
                                                    <div className="text-xs text-slate-500 font-medium flex items-center gap-1 mt-1"><Smartphone className="w-3 h-3"/> {s.deviceModel || s.unitType || s.device || s.deviceType}</div>
                                                    <div className="text-[10px] text-slate-400 mt-1">{formatDate(s.createdAt)} ‚Ä¢ {s.token || s.publicToken}</div>
                                                </td>
                                                <td className="px-3 md:px-6 py-3 md:py-4 hidden md:table-cell">
                                                    <div className="flex flex-col gap-2">
                                                        {(s.usedParts || []).map((p, idx) => (
                                                            <div key={idx} className="bg-white border border-purple-100 rounded-lg p-2 shadow-sm">
                                                                <div className="flex items-center gap-1.5 mb-1">
                                                                    <Box className="w-3.5 h-3.5 text-purple-500"/>
                                                                    <span className="text-purple-700 text-xs font-bold">{p.name}</span>
                                                                    <span className="text-slate-400 font-normal text-[10px]">x{p.qty}</span>
                                                                </div>
                                                                <div className="text-[10px] text-slate-600 font-semibold ml-5">
                                                                    {formatCurrency(p.sellPrice || 0)} <span className="text-slate-400 font-normal">/ pcs</span>
                                                                    {p.qty > 1 && <span className="text-purple-600 ml-2">= {formatCurrency((p.sellPrice || 0) * p.qty)}</span>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {(!s.usedParts || s.usedParts.length === 0) && <span className="text-slate-400 italic text-xs">-</span>}
                                                    </div>
                                                </td>
                                                <td className="px-3 md:px-6 py-3 md:py-4"><select value={s.status} onChange={(e) => updateStatus(s.id, e.target.value)} className={`text-xs font-bold border rounded-lg px-2 py-1.5 cursor-pointer outline-none transition-colors ${ s.status === 'Diterima' ? 'bg-blue-100 text-blue-700 border-blue-200' : s.status === 'Diagnosa' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : s.status === 'Menunggu Sparepart' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : s.status === 'Selesai' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200'}`} onClick={(e) => e.stopPropagation()}>{STATUS_FLOW.map(st => <option key={st} value={st}>{st}</option>)}</select></td>
                                                <td className="px-3 md:px-6 py-3 md:py-4 hidden lg:table-cell"><div className="flex flex-col gap-1 items-start"><span className={`px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wide border ${s.paymentStatus === 'Lunas' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : s.paymentStatus === 'DP' ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>{s.paymentStatus}</span>{s.paymentStatus !== 'Lunas' && (<button onClick={() => setPayModal(s)} className="flex items-center gap-1 text-xs font-bold text-blue-600 hover:text-blue-800 hover:underline mt-1"><DollarSign className="w-3 h-3"/> Bayar {s.paymentStatus === 'DP' ? 'Sisa' : 'Sekarang'}</button>)}{s.paymentStatus !== 'Lunas' && <span className="text-[10px] text-red-500 font-medium">Sisa: {formatCurrency(sisa)}</span>}</div></td>
                                                <td className="px-3 md:px-6 py-3 md:py-4"><div className="font-bold text-slate-700">{formatCurrency(s.costEstimate)}</div></td>
                                                <td className="px-3 md:px-6 py-3 md:py-4">
                                                    <div className="flex flex-col gap-2">
                                                        {/* Baris 1: Edit, Add Part, Share Progress */}
                                                        <div className="flex justify-center gap-2">
                                                            <button onClick={() => {
                                                                setModal(s);
                                                            }} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-blue-50 hover:text-blue-600 text-slate-500 transition-all shadow-sm" title="Edit Detail"><Settings className="w-4 h-4"/></button>
                                                            <button onClick={() => setAddPartModal(s)} className="p-2 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 text-purple-600 transition-all shadow-sm" title="Tambah Sparepart"><PackagePlus className="w-4 h-4"/></button>
                                                            {canShare ? <button onClick={() => handleShareProgress(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-green-50 text-green-600 shadow-sm" title="Kirim Progress ke WA"><Share2 className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur SHARE dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                        </div>
                                                        {/* Baris 2: Print, Share Image, Delete */}
                                                        <div className="flex justify-center gap-2">
                                                            {canPrint ? <button onClick={() => print(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-100 text-slate-600 shadow-sm" title="Print"><Printer className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur PRINT dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                            {canShare ? <button onClick={() => shareInvoiceAsImage(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-pink-50 text-pink-600 shadow-sm" title="Kirim Invoice JPEG ke WA"><ImageIcon className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur SHARE IMG dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                            {canDelete ? <button onClick={() => deleteService(s.id)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-red-50 text-red-500 shadow-sm" title="Hapus"><Trash2 className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur HAPUS dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {paginatedData.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada data ditemukan.</div>}
                        </div>
                     </div>
                     
                     {/* Pagination Info & Controls */}
                     <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                            <div className="flex gap-2">
                                <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                            </div>
                        </div>
                        <div className="text-sm text-slate-600 font-medium">
                            Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                        </div>
                     </div>
                     
                     {/* Pagination Navigation */}
                     {totalPages > 1 && (
                         <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <button 
                                onClick={() => handlePageChange(currentPage - 1)} 
                                disabled={currentPage === 1}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                ‚Üê Sebelumnya
                            </button>
                            <div className="flex gap-2 flex-wrap justify-center">
                                {Array.from({ length: Math.min(totalPages, 7) }, (_, i) => {
                                    let pageNum;
                                    if (totalPages <= 7) {
                                        pageNum = i + 1;
                                    } else if (currentPage <= 4) {
                                        pageNum = i + 1;
                                    } else if (currentPage >= totalPages - 3) {
                                        pageNum = totalPages - 6 + i;
                                    } else {
                                        pageNum = currentPage - 3 + i;
                                    }
                                    return (
                                        <button
                                            key={pageNum}
                                            onClick={() => handlePageChange(pageNum)}
                                            className={`w-10 h-10 rounded-lg font-bold text-sm transition-all ${
                                                currentPage === pageNum
                                                    ? 'bg-blue-600 text-white shadow-lg'
                                                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                            }`}
                                        >
                                            {pageNum}
                                        </button>
                                    );
                                })}
                            </div>
                            <button 
                                onClick={() => handlePageChange(currentPage + 1)} 
                                disabled={currentPage === totalPages}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                Selanjutnya ‚Üí
                            </button>
                         </div>
                     )}
                     
                     {modal && <ServiceForm initial={modal} close={()=>setModal(null)} save={saveService} allServices={services} qcItemsProp={allQCItems} kelengkapanItemsProp={allKelengkapanItems} />}
                     {addPartModal && <AddPartModal service={addPartModal} close={()=>setAddPartModal(null)} />}
                     {payModal && <PaymentModal service={payModal} close={()=>{ setPayModal(null); if(pendingWAAfterPay){ setWaTrackingModal(pendingWAAfterPay); setPendingWAAfterPay(null); } }} pay={handlePay} />}
                     {waTrackingModal && (() => {
                         const { service: svc, newStatus } = waTrackingModal;
                         const msg = getStatusWAMessage(svc, newStatus);
                         const phone = svc.customerPhone || svc.phone || '';
                         let fp = phone.replace(/[\s\-\(\)]/g,'');
                         if (fp.startsWith('+')) fp = fp.slice(1);
                         if (fp.startsWith('0')) fp = '62' + fp.slice(1);
                         if (fp && !fp.startsWith('62')) fp = '62' + fp;
                         const waUrl = fp ? `https://wa.me/${fp}?text=${encodeURIComponent(msg)}` : `https://wa.me/?text=${encodeURIComponent(msg)}`;
                         const statusColor = { 'Selesai':'bg-green-500', 'Dikerjakan':'bg-purple-500', 'Diagnosa':'bg-yellow-500', 'Menunggu Sparepart':'bg-orange-500', 'Diterima':'bg-blue-500', 'Diambil':'bg-emerald-500', 'Dibatalkan':'bg-red-500' };
                         return (
                             <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                                 <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
                                     <div className={`${statusColor[newStatus]||'bg-blue-500'} text-white px-6 py-4 flex items-center justify-between`}>
                                         <div>
                                             <div className="text-xs font-bold opacity-80 uppercase tracking-wider">Update Status Servis</div>
                                             <div className="font-bold text-lg">{newStatus}</div>
                                         </div>
                                         <button onClick={() => setWaTrackingModal(null)} className="text-white/70 hover:text-white text-2xl leading-none">&times;</button>
                                     </div>
                                     <div className="p-5 space-y-4">
                                         <div className="text-sm text-gray-600">Kirim notifikasi update status ke pelanggan via WhatsApp?</div>
                                         <div className="bg-gray-50 rounded-xl p-4 border text-sm text-gray-700 whitespace-pre-line max-h-52 overflow-y-auto font-mono text-xs leading-relaxed">{msg}</div>
                                         {!phone && <div className="text-xs text-orange-500 bg-orange-50 px-3 py-2 rounded-lg border border-orange-200">‚ö†Ô∏è Nomor HP pelanggan tidak tersedia. Pesan tetap bisa dikirim manual.</div>}
                                         <div className="flex gap-3 pt-1">
                                             <button onClick={() => setWaTrackingModal(null)} className="flex-1 border border-gray-300 text-gray-600 py-2.5 rounded-xl font-bold text-sm hover:bg-gray-50">Lewati</button>
                                             <button onClick={() => { window.open(waUrl, '_blank'); setWaTrackingModal(null); }} className="flex-1 bg-green-500 hover:bg-green-600 text-white py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2">
                                                 <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.115.549 4.103 1.514 5.831L.057 23.903l6.248-1.637A11.944 11.944 0 0 0 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.818a9.818 9.818 0 0 1-5.007-1.37l-.36-.213-3.71.974.989-3.627-.234-.372A9.818 9.818 0 1 1 12 21.818z"/></svg>
                                                 Kirim via WhatsApp
                                             </button>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         );
                     })()}
                     {printData && <div className="print-only hidden absolute inset-0 min-h-screen bg-white z-[9999]"><Invoice s={printData} store={store} allKelengkapanItems={allKelengkapanItems} allQCItems={allQCItems} /></div>}
                     {showPrintModal && printData && (
                         <PrintModal
                             s={printData}
                             store={store}
                             allKelengkapanItems={allKelengkapanItems}
                             allQCItems={allQCItems}
                             onClose={async (result) => {
                                 setShowPrintModal(false);
                                 if (result === 'regular') {
                                     setTimeout(() => { window.print(); setPrint(null); }, 300);
                                 } else if (result === 'image') {
                                     setPrintingAsImage(true);
                                     setCaptureData(printData);
                                     await new Promise(r => setTimeout(r, 900));
                                     await printAsImage('invoice-capture');
                                     setCaptureData(null);
                                     setPrintingAsImage(false);
                                     setPrint(null);
                                 } else if (result === 'share') {
                                     setSharingAsImage(true);
                                     setCaptureData(printData);
                                     await new Promise(r => setTimeout(r, 900));
                                     await shareAsImage('invoice-capture');
                                     setCaptureData(null);
                                     setSharingAsImage(false);
                                     setPrint(null);
                                 } else {
                                     setPrint(null);
                                 }
                             }}
                         />
                     )}
                     {captureData && (<div style={{ position: 'fixed', top: 0, left: '-9999px', width: '80mm', zIndex: -1 }}><div id="invoice-capture" className="bg-white"><Invoice s={captureData} store={store} allKelengkapanItems={allKelengkapanItems} allQCItems={allQCItems} /></div></div>)}
                     {printingAsImage && (
                         <div className="fixed inset-0 bg-black/70 z-[99999] flex flex-col items-center justify-center gap-4">
                             <div className="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
                             <p className="text-white font-bold text-sm">Rendering invoice sebagai gambar...</p>
                             <p className="text-white/60 text-xs">Mohon tunggu sebentar</p>
                         </div>
                     )}
                     {sharingAsImage && (
                         <div className="fixed inset-0 bg-black/70 z-[99999] flex flex-col items-center justify-center gap-4">
                             <div className="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
                             <p className="text-white font-bold text-sm">üì≤ Menyiapkan gambar invoice...</p>
                             <p className="text-white/60 text-xs">Akan dibuka di Share Sheet</p>
                         </div>
                     )}

                     {/* INVOICE SHARE PREVIEW MODAL */}
                     {invoiceShareState && (
                         <div className="fixed inset-0 bg-black/70 z-[9998] flex items-end md:items-center justify-center p-0 md:p-4" onClick={() => setInvoiceShareState(null)}>
                             <div className="bg-white w-full md:max-w-sm rounded-t-3xl md:rounded-2xl shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                                 {/* Header */}
                                 <div className="flex items-center justify-between px-5 pt-5 pb-3 border-b border-slate-100">
                                     <div>
                                         <p className="font-bold text-slate-800 text-base">Invoice Siap Dikirim</p>
                                         <p className="text-xs text-slate-500">{invoiceShareState.customerName} ¬∑ {invoiceShareState.token}</p>
                                     </div>
                                     <button onClick={() => setInvoiceShareState(null)} className="p-2 rounded-full hover:bg-slate-100 text-slate-400"><X className="w-5 h-5"/></button>
                                 </div>
                                 {/* Preview image */}
                                 <div className="px-4 py-3 bg-slate-50 overflow-auto max-h-64">
                                     <img src={invoiceShareState.dataUrl} alt="Invoice" className="w-full rounded-lg border border-slate-200 shadow-sm"/>
                                 </div>
                                 {/* Info: gambar sudah otomatis terdownload */}
                                 <div className="mx-4 mt-3 px-3 py-2 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2 text-xs text-green-700">
                                     <CheckCircle className="w-4 h-4 flex-shrink-0"/>
                                     <span>Gambar invoice sudah otomatis tersimpan ke galeri/unduhan</span>
                                 </div>
                                 {/* Action buttons */}
                                 <div className="p-4 flex flex-col gap-3">
                                     {/* Buka WA ke nomor pelanggan, teks sudah terisi */}
                                     <button
                                         onClick={() => {
                                             const { message, formattedPhone } = invoiceShareState;
                                             window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`, '_blank');
                                             setInvoiceShareState(null);
                                         }}
                                         className="w-full py-4 bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold rounded-xl flex items-center justify-center gap-2 text-sm shadow-lg shadow-green-500/30"
                                     >
                                         <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.138.563 4.144 1.547 5.878L0 24l6.305-1.524A11.94 11.94 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-1.885 0-3.647-.49-5.17-1.348l-.371-.22-3.742.904.942-3.648-.242-.385A9.96 9.96 0 012 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"/></svg>
                                         Buka WA Pelanggan (Teks Sudah Terisi)
                                     </button>
                                     <button
                                         onClick={() => setInvoiceShareState(null)}
                                         className="w-full py-3 border-2 border-slate-200 hover:bg-slate-50 text-slate-500 font-semibold rounded-xl text-sm"
                                     >
                                         Tutup
                                     </button>
                                 </div>
                             </div>
                         </div>
                     )}
                 </div>
             );
        };

        const AddPartModal = ({ service, close }) => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [partMode, setPartMode] = useState('stock');
            const [selectedCategory, setSelectedCategory] = useState('');
            const [selectedPart, setPart] = useState('');
            const [manualPart, setManualPart] = useState({name:'', buyPrice:'', sellPrice:'', qty:1});
            const [loading, setLoading] = useState(false);
            const [customCategories, setCustomCategories] = useState([]);
            
            // Fetch inventory dengan server-side filtering untuk kategori
            const { data: inventory = [] } = useInventoryWithFilters(
                activeOwner?.id, 
                activeStore?.id, 
                selectedCategory, 
                null, // no subcategory filter for AddPartModal
                '' // no search term for AddPartModal
            );
            
            // Load custom categories from Firestore real-time
            useEffect(() => {
                if (!activeOwner?.id) return;
                let q;
                if (activeStore?.id) {
                    q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id), 
                        where('storeId', '==', activeStore.id));
                } else {
                    q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allCats = new Set();
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.customCategories && Array.isArray(data.customCategories)) {
                            data.customCategories.forEach(cat => allCats.add(cat));
                        }
                    });
                    setCustomCategories(Array.from(allCats));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);
            
            // Extract unique categories from inventory
            const invCategories = [...new Set(inventory.map(i => i.category).filter(c => c))];
            const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
            const categories = [...new Set([...invCategories, ...defaultCategories, ...customCategories])];
            
            // Inventory sudah difilter server-side berdasarkan selectedCategory
            const categoryProducts = inventory;
            
            const handleSave = async (newPart) => {
                setLoading(true);
                try {
                    const currentParts = service.usedParts || [];
                    const updatedParts = [...currentParts, newPart];
                    
                    // Total Biaya (serviceFee) sudah termasuk harga jual sparepart
                    // Jadi costEstimate = serviceFee (tidak perlu ditambah lagi)
                    const totalBiaya = parseFloat(service.serviceFee || service.costEstimate || 0);

                    // NEW: Atomic Transaction to Update Service & Deduct Stock
                    await runTransaction(db, async (transaction) => {
                         const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', service.id);
                         transaction.update(serviceRef, {
                            usedParts: updatedParts,
                            costEstimate: totalBiaya,
                            updatedAt: serverTimestamp()
                        });

                        // If it's a stock item, decrement inventory by qty
                        if (!newPart.isManual && newPart.id) {
                             const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', newPart.id);
                             transaction.update(invRef, {
                                 stock: increment(-newPart.qty)
                             });
                        }
                    });
                    
                    close();
                } catch(e) {
                    alert("Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const add = () => {
                 if (partMode === 'stock') {
                    const item = inventory.find(i => i.id === selectedPart);
                    if (item) {
                        if (item.stock <= 0) {
                            alert("Stok barang habis!");
                            return;
                        }
                        // Tambahkan qty (default 1, bisa dimodifikasi jika ada input qty)
                        handleSave({ ...item, qty: 1, isManual: false });
                    }
                } else {
                    if(manualPart.name && manualPart.buyPrice && manualPart.sellPrice && manualPart.qty > 0) {
                        handleSave({ 
                           id: 'man_'+Date.now(), 
                           name: manualPart.name + ' (Manual)', 
                           buyPrice: parseFloat(manualPart.buyPrice),
                           sellPrice: parseFloat(manualPart.sellPrice), 
                           qty: parseInt(manualPart.qty) || 1, 
                           isManual: true 
                        });
                        setManualPart({name:'', buyPrice:'', sellPrice:'', qty:1});
                    } else {
                        alert('Semua field harus diisi!');
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[80] animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                             <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><PackagePlus className="w-5 h-5 text-purple-600"/> Tambah Sparepart</h3>
                             <button onClick={close} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <div className="bg-yellow-50 text-yellow-800 p-2 rounded text-xs mb-4 border border-yellow-200">
                           ‚ÑπÔ∏è <b>Info:</b> Stok akan otomatis berkurang jika mengambil dari Inventaris.
                        </div>
                        <div className="flex gap-2 mb-3">
                            <button type="button" onClick={()=>setPartMode('stock')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${partMode==='stock'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>üì¶ Stok Toko</button>
                            <button type="button" onClick={()=>setPartMode('manual')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${partMode==='manual'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>‚úèÔ∏è Input Manual</button>
                        </div>
                        <div className="space-y-3 mb-6">
                            {partMode === 'manual' ? (
                                <>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 block mb-1">Nama Barang *</label>
                                        <input className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: LCD iPhone 12" value={manualPart.name} onChange={e=>setManualPart({...manualPart, name:e.target.value})}/>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 block mb-1">Harga Beli (Modal) *</label>
                                            <NumberInput value={manualPart.buyPrice} onChange={(val)=>setManualPart({...manualPart, buyPrice:val})} className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="0"/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 block mb-1">Harga Jual *</label>
                                            <NumberInput value={manualPart.sellPrice} onChange={(val)=>setManualPart({...manualPart, sellPrice:val})} className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="0"/>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 block mb-1">Jumlah (Qty) *</label>
                                        <NumberInput value={manualPart.qty} onChange={(val)=>setManualPart({...manualPart, qty:val || 1})} className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="1"/>
                                    </div>
                                    {manualPart.buyPrice && manualPart.sellPrice && (
                                        <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                                            <p className="text-xs text-slate-600 mb-1">Keuntungan per item:</p>
                                            <p className="text-sm font-bold text-blue-600">{formatCurrency((parseFloat(manualPart.sellPrice) - parseFloat(manualPart.buyPrice)) * (manualPart.qty || 1))}</p>
                                        </div>
                                    )}
                                </>
                            ) : (
                                <>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 uppercase mb-2 block">1Ô∏è‚É£ Pilih Kategori</label>
                                        <select 
                                            className="w-full border-2 border-blue-300 rounded-lg p-3 text-sm bg-gradient-to-r from-blue-50 to-purple-50 focus:outline-none focus:border-blue-500 font-bold" 
                                            value={selectedCategory} 
                                            onChange={e => {
                                                setSelectedCategory(e.target.value);
                                                setPart('');
                                            }}
                                        >
                                            <option value="">üì¶ -- Pilih Kategori Dulu --</option>
                                            {categories.map(cat => (
                                                <option key={cat} value={cat}>üìÅ {cat}</option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    {selectedCategory ? (
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 uppercase mb-2 block">2Ô∏è‚É£ Pilih Barang</label>
                                            <select 
                                                className="w-full border-2 border-green-300 rounded-lg p-3 text-sm bg-white focus:outline-none focus:border-green-500" 
                                                value={selectedPart} 
                                                onChange={e => setPart(e.target.value)}
                                            >
                                                <option value="">-- Pilih Barang --</option>
                                                {categoryProducts.map(i => (
                                                    <option key={i.id} value={i.id} disabled={i.stock <= 0}>
                                                        {i.name} - {formatCurrency(i.sellPrice)} (Stok: {i.stock})
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    ) : (
                                        <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg text-center">
                                            <Info className="w-5 h-5 text-blue-500 mx-auto mb-1" />
                                            <p className="text-xs text-blue-700">Silakan pilih kategori terlebih dahulu</p>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                        <button onClick={add} disabled={loading || (partMode === 'stock' && !selectedPart)} className="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            {loading ? "Menyimpan..." : "‚úÖ Tambahkan & Simpan"}
                        </button>
                    </div>
                </div>
            );
        };

        const ServiceForm = ({ initial, close, save, allServices = [], qcItemsProp = [], kelengkapanItemsProp = [] }) => {
            // Helper: fetch QC items langsung dari PocketBase SDK (bypass adapter layer)
            // Gabungkan owner-specific QC items + master QC items
            const loadQCItemsDirect = async (ownerId) => {
                if (!ownerId) { console.warn('loadQCItemsDirect: no ownerId'); return []; }
                try {
                    console.log('üîç loadQCItemsDirect: fetching for ownerId=', ownerId);
                    // Fetch owner-specific items
                    const ownerResult = await pb.collection('qc_functional_items').getList(1, 500, {
                        filter: `ownerId="${ownerId}"`
                    });
                    const ownerItems = ownerResult.items.map(r => ({ id: r.id, name: r.name, ownerId: r.ownerId, type: 'owner' }));
                    
                    // Fetch master QC items (global, tanpa ownerId)
                    let masterItems = [];
                    try {
                        const masterResult = await pb.collection('master_qc_functional_items').getList(1, 500, {});
                        masterItems = masterResult.items.map(r => ({ id: r.id, name: r.name, type: 'master' }));
                    } catch (masterErr) {
                        console.warn('‚ö†Ô∏è master_qc_functional_items collection not found or empty, skipping');
                    }
                    
                    // Merge: master items first, then owner items (skip duplicates by name)
                    const existingNames = new Set(ownerItems.map(i => i.name.toLowerCase()));
                    const uniqueMasterItems = masterItems.filter(m => !existingNames.has(m.name.toLowerCase()));
                    const combined = [...uniqueMasterItems, ...ownerItems];
                    console.log('‚úÖ loadQCItemsDirect: owner=', ownerItems.length, 'master=', uniqueMasterItems.length, 'total=', combined.length);
                    return combined;
                } catch (err) {
                    console.error('‚ùå loadQCItemsDirect error:', err);
                    return [];
                }
            };

            // Helper: fetch Kelengkapan items langsung dari PocketBase SDK (bypass adapter layer)
            // Gabungkan owner-specific kelengkapan items + master kelengkapan items
            const loadKelengkapanItemsDirect = async (ownerId) => {
                if (!ownerId) { console.warn('loadKelengkapanItemsDirect: no ownerId'); return []; }
                try {
                    console.log('üîç loadKelengkapanItemsDirect: fetching for ownerId=', ownerId);
                    // Fetch owner-specific items
                    const ownerResult = await pb.collection('kelengkapan_items').getList(1, 500, {
                        filter: `ownerId="${ownerId}"`
                    });
                    const ownerItems = ownerResult.items.map(r => ({ id: r.id, name: r.name, ownerId: r.ownerId, type: 'owner' }));
                    
                    // Fetch master kelengkapan items (global, tanpa ownerId)
                    let masterItems = [];
                    try {
                        const masterResult = await pb.collection('master_kelengkapan_items').getList(1, 500, {});
                        masterItems = masterResult.items.map(r => ({ id: r.id, name: r.name, type: 'master' }));
                    } catch (masterErr) {
                        console.warn('‚ö†Ô∏è master_kelengkapan_items collection not found or empty, skipping');
                    }
                    
                    // Merge: master items first, then owner items (skip duplicates by name)
                    const existingNames = new Set(ownerItems.map(i => i.name.toLowerCase()));
                    const uniqueMasterItems = masterItems.filter(m => !existingNames.has(m.name.toLowerCase()));
                    const combined = [...uniqueMasterItems, ...ownerItems];
                    console.log('‚úÖ loadKelengkapanItemsDirect: owner=', ownerItems.length, 'master=', uniqueMasterItems.length, 'total=', combined.length);
                    return combined;
                } catch (err) {
                    console.error('‚ùå loadKelengkapanItemsDirect error:', err);
                    return [];
                }
            };
            // Default form structure
            const defaultForm = { 
                customerName:'', phone:'', unitType:'', address:'', imei:'', complaint:'', serviceFee:0, dp:0, 
                status:'Diterima', paymentMethod:'Cash', warranty:'', usedParts:[], paymentStatus:'Belum Lunas',
                complaintTags: [],
                unlockMethod: 'Tidak Ada',
                unlockCode: '',
                qcFunctional: {
                    microphone: false, speaker_bawah: false, touchscreen: false, proximity: false,
                    volume: false, silent: false, bluetooth: false, nfc: false, speaker_atas: false,
                    lcd: false, face_id: false, vibrator: false, power: false, charging: false,
                    wifi: false, flashlight: false, truetone: false,
                    kamera_belakang: { wide: false, ultrawide: false, tele: false },
                    kamera_depan: { wide: false, ultrawide: false }
                },
                kelengkapan: {
                    sim: false, sim_ejector: false, kabel_charger: false, charger_adapter: false,
                    box_dus: false, manual_buku: false, garansi: false, sticker: false,
                    screen_protector: false, case_casing: false
                }
            };
            
            // If initial has customerName, use it (from customer click). Otherwise check for id (edit mode)
            const [form, setForm] = useState(() => {
                if (initial.id) {
                    // Edit mode - MAP PocketBase field names TO form field names
                    // PocketBase: customerPhone, deviceModel, problem, deviceSN, warrantyDays
                    // Form: phone, unitType, complaint, imei, warranty
                    const baseComplaint = initial.problem || initial.complaint || '';
                    const existingTags = Array.isArray(initial.complaintTags) && initial.complaintTags.length > 0
                        ? initial.complaintTags
                        : (baseComplaint ? baseComplaint.split(/[,;\n]+/).map(s=>s.trim()).filter(Boolean) : []);
                    const normalized = {
                        ...initial,
                        phone: initial.customerPhone || initial.phone || '',
                        unitType: initial.deviceModel || initial.unitType || initial.device || initial.deviceType || '',
                        complaint: baseComplaint,
                        imei: initial.deviceSN || initial.imei || '',
                        warranty: String(initial.warrantyDays || initial.warranty || ''),
                        complaintTags: existingTags,
                        unlockMethod: initial.unlockMethod || 'Tidak Ada',
                        unlockCode: initial.unlockCode || '',
                    };
                    return normalized;
                } else if (initial.customerName) {
                    // New service from customer click - merge with defaults but keep customer data
                    return { ...defaultForm, ...initial };
                } else {
                    // New service - use defaults but preserve ownerId if provided
                    return { ...defaultForm, ownerId: initial.ownerId };
                }
            });
            const [showParts, setShowParts] = useState(!!(form.usedParts && form.usedParts.length > 0));
            const [showQC, setShowQC] = useState(false);
            const [showKelengkapan, setShowKelengkapan] = useState(false);
            const [complaintInput, setComplaintInput] = useState('');
            const [showQuickComplaints, setShowQuickComplaints] = useState(false);
            const QUICK_COMPLAINTS = [
                'LCD Mati','Layar Retak / Pecah','Touchscreen Tidak Berfungsi',
                'Baterai Cepat Habis','Tidak Bisa Charge','Kamera Rusak / Buram',
                'Speaker Tidak Bunyi','Mic Tidak Berfungsi','WiFi / Sinyal Bermasalah',
                'Mati Total','Hang / Restart Sendiri','Tombol Power Rusak',
                'Tombol Volume Rusak','Water Damage / Kena Air','Slot SIM Rusak',
                'Lainnya'
            ];
            const addComplaintTag = (tag) => {
                const t = tag.trim();
                if (!t) return;
                if ((form.complaintTags||[]).includes(t)) return;
                const newTags = [...(form.complaintTags||[]), t];
                setForm({...form, complaintTags: newTags, complaint: newTags.join(', ')});
                setComplaintInput('');
            };
            const removeComplaintTag = (tag) => {
                const newTags = (form.complaintTags||[]).filter(t => t !== tag);
                setForm({...form, complaintTags: newTags, complaint: newTags.join(', ')});
            };
            const [partMode, setPartMode] = useState('stock');
            const [selectedCategory, setSelectedCategory] = useState('');
            const [selectedSubCategory, setSelectedSubCategory] = useState('');
            const [selectedPart, setPart] = useState('');
            const [searchPartTerm, setSearchPartTerm] = useState('');
            const [showPartDropdown, setShowPartDropdown] = useState(false);
            const [manualPart, setManualPart] = useState({name:'', price:''});
            const [saving, setSaving] = useState(false);
            const [customCategories, setCustomCategories] = useState([]);
            const [subCategories, setSubCategories] = useState({});
            const [cashAccount, setCashAccount] = useState('Kas Tunai');
            
            // Fetch inventory dengan server-side filtering untuk kategori
            const { activeStore } = useContext(SessionContext);
            const { data: inventory = [] } = useInventoryWithFilters(
                initial.ownerId, 
                activeStore?.id, 
                selectedCategory, 
                selectedSubCategory, 
                searchPartTerm
            );
            
            // Load custom categories and subCategories from Firestore real-time
            useEffect(() => {
                if (!initial.ownerId) return;
                let q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                    where('ownerId', '==', initial.ownerId));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allCats = new Set();
                    const allSubCats = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.customCategories && Array.isArray(data.customCategories)) {
                            data.customCategories.forEach(cat => allCats.add(cat));
                        }
                        if (data.subCategories && typeof data.subCategories === 'object') {
                            Object.assign(allSubCats, data.subCategories);
                        }
                    });
                    setCustomCategories(Array.from(allCats));
                    setSubCategories(allSubCats);
                });
                if (window.firestoreListeners) window.firestoreListeners.add(unsubscribe);
                return () => {
                    if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribe);
                    unsubscribe();
                };
            }, [initial.ownerId]);
            
            // Extract unique categories from inventory for inline category filter
            const invCategories = [...new Set(inventory.map(i => i.category).filter(c => c))];
            const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
            const inventoryCategories = [...new Set([...invCategories, ...defaultCategories, ...customCategories])];
            
            // Get sub categories for selected category
            const availableSubCategories = selectedCategory && subCategories[selectedCategory] 
                ? subCategories[selectedCategory] 
                : [];
            
            // Inventory sudah difilter server-side melalui useInventoryWithFilters hook
            // Tidak perlu client-side filtering lagi
            const filteredInventory = inventory;
            
            // QC & Kelengkapan items ‚Äî init dari props (ServiceManager), lalu preload langsung dari PocketBase
            const [kelengkapanItems, setKelengkapanItems] = useState(kelengkapanItemsProp.length > 0 ? kelengkapanItemsProp : []);
            const [qcLoadingState, setQcLoadingState] = useState('idle'); // 'idle'|'loading'|'done'
            const [kelLoadingState, setKelLoadingState] = useState('idle');
            const [customerDropdownOpen, setCustomerDropdownOpen] = useState(false);
            
            // Extract unique customers from allServices for dropdown
            const uniqueCustomers = Array.from(new Map(
                allServices.map(s => [s.customerName?.toLowerCase(), {
                    name: s.customerName,
                    phone: s.customerPhone || s.phone || '',
                    address: s.address,
                    phoneType: s.deviceModel || s.unitType || s.device || s.deviceType || ''
                }])
            ).values())
            .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            
            // Riwayat Service Pelanggan
            const serviceHistory = allServices.filter(s => 
                s.customerName?.toLowerCase() === form.customerName.toLowerCase() && 
                s.id !== initial.id
            ).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).slice(0, 5);
            
            const loadFromHistory = (prevService) => {
                setForm(prev => ({
                    ...prev,
                    phone: prevService.customerPhone || prevService.phone || '',
                    unitType: prevService.deviceModel || prevService.unitType || prevService.device || prevService.deviceType || '',
                    address: prevService.address,
                    imei: prevService.imei,
                    complaint: prevService.complaint,
                    warranty: prevService.warranty
                }));
            };

            const partsTotal = (form.usedParts||[]).reduce((a,b) => a + (parseFloat(b.sellPrice) * b.qty), 0);
            const modalSparepart = (form.usedParts||[]).reduce((a,b) => a + ((parseFloat(b.buyPrice)||0) * b.qty), 0);
            const totalBiaya = (parseFloat(form.serviceFee)||0); // Total Biaya sudah termasuk harga jual sparepart
            const total = totalBiaya - modalSparepart; // Laba = Total Biaya - Modal Sparepart
            const untungJual = partsTotal - modalSparepart; // Untung dari jual sparepart
            const untungJasa = totalBiaya - partsTotal; // Untung Jasa = Total Biaya - Harga Jual Sparepart
            const sisa = totalBiaya - (parseFloat(form.dp)||0);

            const addPart = () => {
                if (partMode === 'stock') {
                    const item = inventory.find(i => i.id === selectedPart);
                    if (item) {
                        setForm(p => ({ ...p, usedParts: [...(p.usedParts||[]), { ...item, qty: 1, isManual: false }] }));
                        setPart('');
                        setSearchPartTerm('');
                        setShowPartDropdown(false);
                    }
                } else {
                    if(manualPart.name && manualPart.price) {
                        setForm(p => ({ ...p, usedParts: [...(p.usedParts||[]), { 
                           id: 'man_'+Date.now(), name: manualPart.name + ' (Manual)', 
                           sellPrice: parseFloat(manualPart.price), qty: 1, isManual: true 
                        }]}));
                        setManualPart({name:'', price:''});
                    }
                }
            };
            
            // Close dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (showPartDropdown && !e.target.closest('.relative')) {
                        setShowPartDropdown(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showPartDropdown]);
            
            const handleSave = async () => {
                setSaving(true);
                try {
                     const dataToSave = {...form, cashAccount};
                     await save(dataToSave);
                     close();
                } catch(e) {
                    alert("‚ùå ERROR: " + e.message);
                }
                setSaving(false);
            };

            const removePart = async (idx) => {
                const partToRemove = form.usedParts[idx];
                
                // Jika part bukan manual dan sudah tersimpan di database, kembalikan stok
                if (initial.id && !partToRemove.isManual && partToRemove.id) {
                    if (confirm(`Hapus ${partToRemove.name} dari service? Stok akan dikembalikan.`)) {
                        try {
                            await runTransaction(db, async (transaction) => {
                                // Update service - remove part
                                const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', initial.id);
                                const newUsedParts = form.usedParts.filter((_, i) => i !== idx);
                                transaction.update(serviceRef, {
                                    usedParts: newUsedParts,
                                    updatedAt: serverTimestamp()
                                });
                                
                                // Return stock
                                const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', partToRemove.id);
                                transaction.update(invRef, {
                                    stock: increment(partToRemove.qty)
                                });
                            });
                            
                            // Update local state
                            setForm(p => ({ ...p, usedParts: p.usedParts.filter((_, i) => i !== idx) }));
                            alert('‚úÖ Sparepart dihapus dan stok dikembalikan');
                        } catch (err) {
                            alert('Gagal hapus sparepart: ' + err.message);
                        }
                    }
                } else {
                    // Jika belum tersimpan atau manual, langsung hapus dari state
                    setForm(p => ({ ...p, usedParts: p.usedParts.filter((_, i) => i !== idx) }));
                }
            };

            // QC items state ‚Äî init dari props sebagai fallback instan
            const [qcItems, setQCItems] = useState(qcItemsProp.length > 0 ? qcItemsProp : []);

            // Pre-load saat mount ‚Äî langsung fetch dari PocketBase SDK (owner + master merged)
            // Selalu fetch ulang karena props mungkin belum include master items
            useEffect(() => {
                const oid = initial?.ownerId;
                if (!oid) { console.warn('ServiceForm: no ownerId, skip preload'); return; }
                let cancelled = false;
                console.log('üöÄ ServiceForm mount: preloading QC & Kelengkapan for ownerId=', oid);
                setQcLoadingState('loading');
                setKelLoadingState('loading');
                (async () => {
                    try {
                        const [qc, kel] = await Promise.all([
                            loadQCItemsDirect(oid),
                            loadKelengkapanItemsDirect(oid)
                        ]);
                        if (cancelled) return;
                        // Selalu update state ‚Äî hasil fetch sudah merged (owner + master)
                        setQCItems(qc);
                        setKelengkapanItems(kel);
                        setQcLoadingState('done');
                        setKelLoadingState('done');
                        console.log('‚úÖ ServiceForm preloaded QC:', qc.length, 'Kelengkapan:', kel.length);
                    } catch (err) {
                        console.error('‚ùå ServiceForm preload error:', err);
                        setQcLoadingState('done');
                        setKelLoadingState('done');
                    }
                })();
                return () => { cancelled = true; };
            }, [initial?.ownerId]);

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70] animate-fade-in">
                    <div className="bg-white w-full max-w-4xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                             <div className="flex items-center gap-3">
                                 <h3 className="font-bold text-xl text-slate-800">{initial.id ? 'Edit Servis' : 'Servis Baru'}</h3>
                                 {!initial.id && form.customerName && (
                                     <div className="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full flex items-center gap-2">
                                         <span>üë§</span>
                                         {form.customerName}
                                     </div>
                                 )}
                             </div>
                             <button onClick={close} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        
                        {/* Riwayat Service Pelanggan */}
                        {!initial.id && serviceHistory.length > 0 && (
                            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                                <p className="text-xs font-bold text-blue-600 uppercase mb-3 flex items-center gap-2">
                                    <History className="w-4 h-4"/> Riwayat Service Pelanggan
                                </p>
                                <div className="space-y-2">
                                    {serviceHistory.map((prev, idx) => (
                                        <button
                                            key={prev.id}
                                            onClick={() => loadFromHistory(prev)}
                                            className="w-full text-left p-3 bg-white border border-blue-100 rounded-lg hover:bg-blue-100 transition-all flex justify-between items-center"
                                        >
                                            <div>
                                                <p className="text-xs font-bold text-slate-600">{formatDate(prev.createdAt)} ‚Ä¢ {prev.unitType}</p>
                                                <p className="text-sm text-slate-700 font-medium">Status: {prev.status}</p>
                                            </div>
                                            <Copy className="w-4 h-4 text-blue-500 flex-shrink-0"/>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Info: Customer Data Pre-filled */}
                        {!initial.id && form.customerName && (
                            <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start gap-2">
                                <CheckCircle className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"/>
                                <div>
                                    <p className="text-xs font-bold text-green-800">Data Pelanggan Ter-isi Otomatis</p>
                                    <p className="text-xs text-green-700 mt-1">
                                        Nama, nomor HP, alamat, dan tipe HP sudah ter-isi dari data pelanggan. 
                                        Atau klik layanan sebelumnya di bawah untuk auto-fill dari riwayat servis.
                                    </p>
                                </div>
                            </div>
                        )}
                        
                        {/* COMPACT LAYOUT START */}
                        <div className="space-y-4">
                            {/* Baris 1: Info Utama - 4 Kolom */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="md:col-span-1 relative">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Nama Pelanggan</label>
                                    <input 
                                        className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" 
                                        value={form.customerName} 
                                        onChange={e=>setForm({...form, customerName:e.target.value})} 
                                        onFocus={() => setCustomerDropdownOpen(true)}
                                        onBlur={() => setTimeout(() => setCustomerDropdownOpen(false), 200)}
                                        required 
                                        placeholder="Ketik nama atau pilih..."
                                    />
                                    
                                    {/* Quick select dropdown untuk customers */}
                                    {customerDropdownOpen && uniqueCustomers.length > 0 && (
                                        <div className="absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-b-md shadow-lg z-20 max-h-60 overflow-y-auto">
                                            {uniqueCustomers
                                                .filter(c => !form.customerName || c.name?.toLowerCase().includes(form.customerName.toLowerCase()))
                                                .slice(0, 5)
                                                .map((c, idx) => (
                                                    <button
                                                        key={idx}
                                                        type="button"
                                                        onClick={() => {
                                                            setForm({
                                                                ...form,
                                                                customerName: c.name,
                                                                phone: c.phone || form.phone,
                                                                address: c.address || form.address,
                                                                unitType: c.phoneType || form.unitType
                                                            });
                                                            setCustomerDropdownOpen(false);
                                                        }}
                                                        className="w-full text-left px-3 py-2 hover:bg-blue-50 border-b last:border-b-0"
                                                    >
                                                        <div className="flex justify-between items-start gap-2">
                                                            <div className="flex-1">
                                                                <div className="font-bold text-sm text-slate-700">{c.name}</div>
                                                                {c.address && (
                                                                    <div className="text-[10px] text-slate-500 mt-0.5 line-clamp-1">
                                                                        üìç {c.address}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <span className="text-slate-600 text-[10px] font-medium whitespace-nowrap">{c.phone}</span>
                                                        </div>
                                                    </button>
                                                ))}
                                        </div>
                                    )}
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">No HP / WA</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} required placeholder="08..."/>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Tipe HP / Unit</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.unitType} onChange={e=>setForm({...form, unitType:e.target.value})} required placeholder="Tipe..."/>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Garansi (Hari)</label>
                                    <NumberInput className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.warranty} onChange={val=>setForm({...form, warranty:val})} placeholder="30"/>
                                </div>
                            </div>

                            {/* Baris 2: Keluhan multi-tag + Status */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="md:col-span-2">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Keluhan / Kerusakan</label>
                                    {/* Tags display */}
                                    {(form.complaintTags||[]).length > 0 && (
                                        <div className="flex flex-wrap gap-1.5 mb-2">
                                            {(form.complaintTags||[]).map((tag,i) => (
                                                <span key={i} className="inline-flex items-center gap-1 bg-red-100 text-red-700 border border-red-200 text-xs font-bold px-2 py-1 rounded-full">
                                                    {tag}
                                                    <button type="button" onClick={() => removeComplaintTag(tag)} className="hover:text-red-900 ml-0.5"><X className="w-3 h-3"/></button>
                                                </span>
                                            ))}
                                        </div>
                                    )}
                                    {/* Input + quick select */}
                                    <div className="relative">
                                        <div className="flex gap-1">
                                            <input
                                                className="flex-1 border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-medium text-slate-700 focus:border-red-400 focus:outline-none transition-colors rounded-t-md"
                                                value={complaintInput}
                                                onChange={e => setComplaintInput(e.target.value)}
                                                onKeyDown={e => { if (e.key === 'Enter') { e.preventDefault(); addComplaintTag(complaintInput); } }}
                                                placeholder="Ketik keluhan lalu Enter..."
                                            />
                                            <button type="button" onClick={() => addComplaintTag(complaintInput)} className="px-2 bg-red-500 text-white rounded-t-md hover:bg-red-600 text-xs font-bold shrink-0"><Plus className="w-3.5 h-3.5"/></button>
                                            <button type="button" onClick={() => setShowQuickComplaints(p=>!p)} className="px-2 bg-orange-500 text-white rounded-t-md hover:bg-orange-600 text-xs font-bold shrink-0" title="Pilih keluhan umum">‚ö°</button>
                                        </div>
                                        {/* Quick select dropdown */}
                                        {showQuickComplaints && (
                                            <div className="absolute top-full left-0 right-0 bg-white border border-orange-200 rounded-b-lg shadow-xl z-30 p-2">
                                                <p className="text-[10px] font-bold text-orange-600 uppercase mb-2 px-1">Pilih keluhan umum:</p>
                                                <div className="flex flex-wrap gap-1.5 max-h-40 overflow-y-auto">
                                                    {QUICK_COMPLAINTS.map((qc,i) => {
                                                        const already = (form.complaintTags||[]).includes(qc);
                                                        return (
                                                            <button key={i} type="button"
                                                                onClick={() => { addComplaintTag(qc); setShowQuickComplaints(false); }}
                                                                className={`text-xs px-2 py-1 rounded-full border font-medium transition-all ${already ? 'bg-red-100 text-red-500 border-red-200 opacity-50 cursor-not-allowed' : 'bg-orange-50 text-orange-700 border-orange-200 hover:bg-orange-100'}`}
                                                                disabled={already}
                                                            >{qc}</button>
                                                        );
                                                    })}
                                                </div>
                                                <button type="button" onClick={() => setShowQuickComplaints(false)} className="mt-2 w-full text-[10px] text-slate-500 hover:text-slate-700 py-1">Tutup ‚úï</button>
                                            </div>
                                        )}
                                    </div>
                                    {(form.complaintTags||[]).length === 0 && <p className="text-[10px] text-slate-400 mt-1">Klik ‚ö° untuk pilih keluhan umum, atau ketik manual lalu Enter</p>}
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Status Saat Ini</label>
                                    <select className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-blue-600 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.status} onChange={e=>setForm({...form, status:e.target.value})}>{STATUS_FLOW.map(s=><option key={s}>{s}</option>)}</select>
                                </div>
                            </div>

                            {/* Baris 3: Address & IMEI */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Alamat Pelanggan</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-medium text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.address || ''} onChange={e=>setForm({...form, address:e.target.value})} placeholder="Alamat rumah atau tempat kerja"/>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">IMEI / Serial Number</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-medium text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.imei || ''} onChange={e=>setForm({...form, imei:e.target.value})} placeholder="IMEI atau Serial..."/>
                                </div>
                            </div>

                            {/* Baris 4: Kunci / Pola HP */}
                            <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-3">
                                <p className="text-[10px] font-bold text-yellow-700 uppercase tracking-wider mb-2 flex items-center gap-1.5"><Lock className="w-3 h-3"/>Cara Buka HP (untuk tes tanpa pelanggan)</p>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {['Tidak Ada','PIN','Pola','Password','Sidik Jari','Face ID'].map(m => (
                                        <button key={m} type="button"
                                            onClick={() => setForm({...form, unlockMethod: m, unlockCode: m === 'Tidak Ada' ? '' : form.unlockCode})}
                                            className={`py-1.5 rounded-lg text-xs font-bold border transition-all ${form.unlockMethod === m ? 'bg-yellow-500 text-white border-yellow-500 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:border-yellow-300'}`}
                                        >{m === 'Tidak Ada' ? 'üîì Tidak Ada' : m === 'PIN' ? 'üî¢ PIN' : m === 'Pola' ? 'üî∑ Pola' : m === 'Password' ? 'üî§ Password' : m === 'Sidik Jari' ? 'üëÜ Sidik Jari' : 'üë§ Face ID'}</button>
                                    ))}
                                </div>
                                {form.unlockMethod !== 'Tidak Ada' && form.unlockMethod !== 'Sidik Jari' && form.unlockMethod !== 'Face ID' && (
                                    <div className="mt-2">
                                        <input
                                            className="w-full border border-yellow-300 bg-white p-2 rounded-lg text-sm font-bold text-slate-700 focus:border-yellow-500 focus:outline-none"
                                            value={form.unlockCode || ''}
                                            onChange={e => setForm({...form, unlockCode: e.target.value})}
                                            placeholder={form.unlockMethod === 'PIN' ? 'Masukkan PIN...' : form.unlockMethod === 'Pola' ? 'Deskripsi pola (misal: L / Z / angka)...' : 'Masukkan password...'}
                                        />
                                    </div>
                                )}
                                {(form.unlockMethod === 'Sidik Jari' || form.unlockMethod === 'Face ID') && (
                                    <p className="text-[10px] text-yellow-600 mt-2 font-medium">üí° HP dibuka dengan {form.unlockMethod} ‚Äî minta pelanggan aktifkan teknisi sementara jika diperlukan</p>
                                )}
                            </div>

                            {/* QC Functional Check Section */}
                            <div>
                                <button type="button" onClick={async () => {
                                    if (!showQC && qcItems.length === 0 && initial?.ownerId) {
                                        setQcLoadingState('loading');
                                        const items = await loadQCItemsDirect(initial.ownerId);
                                        if (items.length > 0) setQCItems(items);
                                        setQcLoadingState('done');
                                    }
                                    setShowQC(!showQC);
                                }} className={`w-full py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 border border-dashed transition-all mb-2 ${showQC ? 'bg-purple-50 text-purple-600 border-purple-200' : 'bg-amber-50 text-amber-600 border-amber-300'}`}>{showQC ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>} {showQC ? "Tutup QC Check" : qcLoadingState === 'loading' ? "Memuat..." : `QC Cek Fungsional (${qcItems.length > 0 ? qcItems.length + ' item' : 'Klik Disini'})`}</button>
                                {showQC && (
                                    <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 mb-4 animate-fade-in shadow-inner">
                                        <h4 className="font-bold text-sm text-amber-900 mb-3">‚úì Cek Fungsional Perangkat ({qcItems.length} items)</h4>
                                        {qcItems.length === 0 ? (
                                            <p className="text-xs text-amber-600 text-center py-4">{qcLoadingState === 'loading' ? '‚è≥ Memuat item QC...' : 'Belum ada item QC. Tambahkan dari Pengaturan ‚Üí Master Data ‚Üí Cek Fungsional.'}</p>
                                        ) : (
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                                {qcItems.map(item => {
                                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                                    return (
                                                        <label key={item.id} className="flex items-center gap-2 p-2 bg-white rounded-lg border border-amber-100 cursor-pointer hover:bg-amber-50 transition-colors">
                                                            <input type="checkbox" checked={form.qcFunctional[itemKey] || false} onChange={(e) => setForm({...form, qcFunctional: {...form.qcFunctional, [itemKey]: e.target.checked}})} className="w-4 h-4 accent-amber-500"/>
                                                            <span className="text-xs font-medium text-slate-700 flex-1">{item.name}</span>
                                                            <span className="text-[10px] text-slate-400 ml-auto">{item.type === 'master' ? 'üì¶' : 'üë§'}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Kelengkapan / Accessories Section */}
                            <div>
                                <button type="button" onClick={async () => {
                                    if (!showKelengkapan && kelengkapanItems.length === 0 && initial?.ownerId) {
                                        setKelLoadingState('loading');
                                        const items = await loadKelengkapanItemsDirect(initial.ownerId);
                                        if (items.length > 0) setKelengkapanItems(items);
                                        setKelLoadingState('done');
                                    }
                                    setShowKelengkapan(!showKelengkapan);
                                }} className={`w-full py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 border border-dashed transition-all mb-2 ${showKelengkapan ? 'bg-green-50 text-green-600 border-green-200' : 'bg-teal-50 text-teal-600 border-teal-300'}`}>{showKelengkapan ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>} {showKelengkapan ? "Tutup Cek Kelengkapan" : kelLoadingState === 'loading' ? "Memuat..." : `Cek Kelengkapan (${kelengkapanItems.length > 0 ? kelengkapanItems.length + ' item' : 'Klik Disini'})`}</button>
                                {showKelengkapan && (
                                    <div className="bg-teal-50 p-4 rounded-xl border border-teal-200 mb-4 animate-fade-in shadow-inner">
                                        <h4 className="font-bold text-sm text-teal-900 mb-3">üì¶ Cek Kelengkapan Paket ({kelengkapanItems.length} items)</h4>
                                        {kelengkapanItems.length === 0 ? (
                                            <p className="text-xs text-teal-600 text-center py-4">{kelLoadingState === 'loading' ? '‚è≥ Memuat item kelengkapan...' : 'Belum ada item kelengkapan. Tambahkan dari Pengaturan ‚Üí Master Data ‚Üí Kelengkapan.'}</p>
                                        ) : (
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                                {kelengkapanItems.map(item => {
                                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                                    return (
                                                        <label key={item.id} className="flex items-center gap-2 p-2 bg-white rounded-lg border border-teal-100 cursor-pointer hover:bg-teal-50 transition-colors">
                                                            <input type="checkbox" checked={form.kelengkapan[itemKey] || false} onChange={(e) => setForm({...form, kelengkapan: {...form.kelengkapan, [itemKey]: e.target.checked}})} className="w-4 h-4 accent-teal-500"/>
                                                            <span className="text-xs font-medium text-slate-700">{item.name}</span>
                                                            <span className="text-[10px] text-slate-400 ml-auto">{item.type === 'master' ? 'üì¶' : 'üë§'}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Sparepart Section Compact */}
                            <div>
                                <button type="button" onClick={() => setShowParts(!showParts)} className={`w-full py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 border border-dashed transition-all mb-2 ${showParts ? 'bg-red-50 text-red-600 border-red-200' : 'bg-blue-50 text-blue-600 border-blue-300'}`}>{showParts ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>} {showParts ? "Tutup Input Sparepart" : "Tambah Sparepart / Jasa (Klik Disini)"}</button>
                                {showParts && (
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4 animate-fade-in shadow-inner">
                                        <div className="bg-blue-50 text-blue-800 text-[10px] p-2 mb-2 rounded border border-blue-200">
                                            üí° Gunakan tombol <b>+ Sparepart</b> di tabel utama untuk manajemen stok yang lebih akurat.
                                        </div>
                                        <div className="flex gap-2 mb-2 border-b border-slate-200 pb-2">
                                            <button type="button" onClick={()=>setPartMode('stock')} className={`flex-1 py-1 text-[10px] font-bold rounded-lg transition-all ${partMode==='stock'?'bg-white text-blue-600 shadow-sm border border-blue-100':'text-slate-500 hover:bg-gray-200'}`}>üì¶ Dari Stok</button>
                                            <button type="button" onClick={()=>setPartMode('manual')} className={`flex-1 py-1 text-[10px] font-bold rounded-lg transition-all ${partMode==='manual'?'bg-white text-blue-600 shadow-sm border border-blue-100':'text-slate-500 hover:bg-gray-200'}`}>‚úèÔ∏è Manual</button>
                                        </div>
                                        <div className="flex gap-2 mb-2">
                                            {partMode === 'manual' ? (
                                                <>
                                                    <input className="flex-1 border rounded-lg p-2 text-xs focus:outline-blue-500" placeholder="Nama Barang" value={manualPart.name} onChange={e=>setManualPart({...manualPart, name:e.target.value})}/>
                                                    <NumberInput className="w-24 border rounded-lg p-2 text-xs focus:outline-blue-500 font-bold" placeholder="Harga" value={manualPart.price} onChange={val=>setManualPart({...manualPart, price:val})} onFocus={e => e.target.select()}/>
                                                </>
                                            ) : (
                                                <>
                                                    {/* Category Selector */}
                                                    {inventoryCategories.length > 0 && (
                                                        <select 
                                                            className="w-28 border border-blue-300 rounded-lg p-2 text-xs bg-white focus:outline-blue-500 font-bold" 
                                                            value={selectedCategory} 
                                                            onChange={e => {
                                                                setSelectedCategory(e.target.value);
                                                                setSelectedSubCategory('');
                                                                setPart('');
                                                                setSearchPartTerm('');
                                                            }}
                                                        >
                                                            <option value="">üìÅ Kategori</option>
                                                            {inventoryCategories.map(cat => (
                                                                <option key={cat} value={cat}>{cat}</option>
                                                            ))}
                                                        </select>
                                                    )}
                                                    
                                                    {/* Sub Category Selector */}
                                                    {availableSubCategories.length > 0 && (
                                                        <select 
                                                            className="w-28 border border-cyan-300 rounded-lg p-2 text-xs bg-white focus:outline-cyan-500 font-bold" 
                                                            value={selectedSubCategory} 
                                                            onChange={e => {
                                                                setSelectedSubCategory(e.target.value);
                                                                setPart('');
                                                                setSearchPartTerm('');
                                                            }}
                                                        >
                                                            <option value="">üìÇ Sub</option>
                                                            {availableSubCategories.map(subCat => (
                                                                <option key={subCat} value={subCat}>{subCat}</option>
                                                            ))}
                                                        </select>
                                                    )}
                                                    
                                                    {/* Searchable Item Selector */}
                                                    <div className="flex-1 relative">
                                                        <input 
                                                            type="text"
                                                            className="w-full border border-slate-300 rounded-lg p-2 text-xs bg-white focus:outline-blue-500 focus:border-blue-500"
                                                            placeholder="üîç Ketik atau klik untuk pilih barang..."
                                                            value={searchPartTerm}
                                                            onChange={e => {
                                                                setSearchPartTerm(e.target.value);
                                                                setShowPartDropdown(true);
                                                                setPart(''); // Reset selection saat mengetik
                                                            }}
                                                            onFocus={() => setShowPartDropdown(true)}
                                                        />
                                                        
                                                        {/* Dropdown Results - Show all filtered items or search results */}
                                                        {showPartDropdown && filteredInventory.length > 0 && (
                                                            <div className="absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                                                                {/* Show count info */}
                                                                <div className="sticky top-0 bg-slate-50 px-3 py-1.5 border-b border-slate-200 text-[10px] text-slate-600 font-bold">
                                                                    {searchPartTerm 
                                                                        ? `${filteredInventory.length} hasil pencarian` 
                                                                        : `${filteredInventory.length} barang tersedia`
                                                                    }
                                                                </div>
                                                                
                                                                {/* Items list */}
                                                                {filteredInventory.slice(0, 50).map(item => (
                                                                    <div 
                                                                        key={item.id}
                                                                        className="p-2 hover:bg-blue-50 cursor-pointer border-b border-slate-100 last:border-0 transition-colors"
                                                                        onClick={() => {
                                                                            setPart(item.id);
                                                                            setSearchPartTerm(item.name);
                                                                            setShowPartDropdown(false);
                                                                        }}
                                                                    >
                                                                        <div className="flex justify-between items-center">
                                                                            <span className="text-xs font-medium text-slate-700">{item.name}</span>
                                                                            <span className="text-xs font-bold text-blue-600">{formatCurrency(item.sellPrice)}</span>
                                                                        </div>
                                                                        <div className="flex gap-2 mt-0.5">
                                                                            {item.category && <span className="text-[10px] text-slate-500">üìÅ {item.category}</span>}
                                                                            {item.subCategory && <span className="text-[10px] text-cyan-600">üìÇ {item.subCategory}</span>}
                                                                            <span className="text-[10px] text-slate-400">Stok: {item.stock || 0}</span>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                                
                                                                {/* Show "type to search" hint if no search term and many items */}
                                                                {!searchPartTerm && filteredInventory.length > 50 && (
                                                                    <div className="p-3 text-center bg-blue-50 text-blue-600 text-[10px]">
                                                                        üí° Menampilkan 50 dari {filteredInventory.length} barang. Ketik untuk mencari lebih spesifik.
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                        
                                                        {/* Empty state */}
                                                        {showPartDropdown && filteredInventory.length === 0 && (
                                                            <div className="absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg p-4 text-center">
                                                                <div className="text-slate-400 text-xs">
                                                                    {searchPartTerm ? 'üîç Tidak ada barang yang cocok' : 'üì¶ Tidak ada barang di kategori ini'}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {selectedPart && (
                                                        <div className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold border border-blue-200 whitespace-nowrap flex items-center">
                                                            {formatCurrency(inventory.find(i => i.id === selectedPart)?.sellPrice || 0)}
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                            <button type="button" onClick={addPart} className="bg-blue-600 text-white px-3 py-1 rounded-lg font-bold hover:bg-blue-700 shadow-sm"><Plus className="w-4 h-4"/></button>
                                        </div>
                                        <div className="space-y-3 mb-6 text-sm">
                            {(form.usedParts||[]).map((p,i)=>(<div key={i} className="flex justify-between items-center text-xs bg-white p-1.5 rounded border border-slate-200 shadow-sm"><span className="font-medium text-slate-700">{p.name}</span><div className="flex items-center gap-2"><span className="font-bold text-slate-600">{formatCurrency(p.sellPrice)} x {p.qty} = {formatCurrency(p.sellPrice * p.qty)}</span><button type="button" onClick={()=>removePart(i)} className="text-red-400 hover:text-red-600 bg-red-50 p-0.5 rounded"><X className="w-3 h-3"/></button></div></div>))}</div>
                                    </div>
                                )}
                            </div>

                            {/* Biaya Section Compact Horizontal */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-dashed border-slate-200">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Biaya (Rp)</label>
                                    <NumberInput value={form.serviceFee} onChange={(val)=>setForm({...form, serviceFee:val})} className="w-full bg-slate-50 border border-slate-200 p-2 rounded text-right font-bold text-slate-700 focus:border-blue-500 focus:bg-white focus:outline-none" placeholder="0"/>
                                    <p className="text-[9px] text-slate-500 mt-1">{form.serviceFee ? formatCurrency(parseFloat(form.serviceFee) || 0) : '-'}</p>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Sparepart</label>
                                    <div className="w-full bg-slate-100 border border-slate-200 p-2 rounded text-right font-black text-slate-800">{formatCurrency(partsTotal)}</div>
                                    <p className="text-[9px] text-slate-500 mt-1">Modal: {formatCurrency(modalSparepart)}</p>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Laba</label>
                                    <div className="w-full bg-green-100 border border-green-300 p-2 rounded text-right font-black text-green-800 text-lg">{formatCurrency(total)}</div>
                                    <p className="text-[9px] text-slate-600 mt-1">Jual: {formatCurrency(untungJual)} | Jasa: {formatCurrency(untungJasa)}</p>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Bayar / DP</label>
                                    <NumberInput value={form.dp} onChange={(val)=>setForm({...form, dp:val})} className="w-full bg-green-50 border border-green-200 p-2 rounded text-right font-bold text-green-700 focus:border-green-500 focus:bg-white focus:outline-none" placeholder="0"/>
                                    <p className="text-[9px] text-green-600 mt-1 font-bold">{form.dp ? formatCurrency(parseFloat(form.dp) || 0) : '-'}</p>
                                </div>
                                <div>
                                    <CashAccountSelect value={cashAccount} onChange={setCashAccount} label="Masuk/Keluar dari Kas" />
                                </div>
                            </div>
                        </div>
                        {/* COMPACT LAYOUT END */}

                        <div className="p-5 border-t bg-gray-50 rounded-b-2xl flex gap-3 mt-6 -mx-6 -mb-6">
                            <button onClick={close} className="flex-1 py-3 border border-gray-300 bg-white rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-colors">Batal</button>
                            <button onClick={handleSave} disabled={saving} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-600/30 hover:bg-blue-700 transition-colors">{saving ? 'Menyimpan...' : 'Simpan Data'}</button>
                        </div>
                    </div>
                </div>
            )
        };

        const SalesManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const { data: sales } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
            const { data: inventory } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
            const [tab, setTab] = useState('cart');
            const [modal, setModal] = useState(null);
            const [term, setTerm] = useState('');
            const [searchBarang, setSearchBarang] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('');
            const [cart, setCart] = useState([]);
            const [customerName, setCustomerName] = useState('');
            const [customerPhone, setCustomerPhone] = useState('');
            const [customerAddress, setCustomerAddress] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('cash');
            const [cashAccount, setCashAccount] = useState('Kas Tunai');
            const [saleDueDate, setSaleDueDate] = useState('');
            const [discount, setDiscount] = useState(0);
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            const [productCurrentPage, setProductCurrentPage] = useState(1);
            const [productItemsPerPage, setProductItemsPerPage] = useState(12);
            const [customCategories, setCustomCategories] = useState([]);
            const [subCategories, setSubCategories] = useState({});
            const [selectedSubCategory, setSelectedSubCategory] = useState('');
            const [dateFilter, setDateFilter] = useState('all');
            const [customDateRange, setCustomDateRange] = useState({start:'', end:''});
            const [editModal, setEditModal] = useState(null);
            const [customers, setCustomers] = useState([]);
            const [showCustomerDropdown, setShowCustomerDropdown] = useState(false);
            const [manualItem, setManualItem] = useState({name: '', buyPrice: 0, sellPrice: 0, qty: 1});
            const [showManualItemForm, setShowManualItemForm] = useState(false);
            const [editingPrice, setEditingPrice] = useState(null);
            const [newCustomerForm, setNewCustomerForm] = useState({name: '', phone: '', address: '', customerType: 'sales'});
            const [showNewCustomerForm, setShowNewCustomerForm] = useState(false);
            const [historyCat, setHistoryCat] = useState('');
            const [historySubCat, setHistorySubCat] = useState('');
            
            // Load custom categories and subcategories from Firestore real-time
            useEffect(() => {
                if (!activeOwner?.id) return;
                let q;
                if (activeStore?.id) {
                    q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id), 
                        where('storeId', '==', activeStore.id));
                } else {
                    q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allCats = new Set();
                    const allSubCats = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.customCategories && Array.isArray(data.customCategories)) {
                            data.customCategories.forEach(cat => allCats.add(cat));
                        }
                        if (data.subCategories && typeof data.subCategories === 'object') {
                            Object.assign(allSubCats, data.subCategories);
                        }
                    });
                    setCustomCategories(Array.from(allCats));
                    setSubCategories(allSubCats);
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);
            
            // Load customers from Firestore
            useEffect(() => {
                if (!activeOwner?.id) return;
                const customersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'customers');
                const q = query(customersRef, where('ownerId', '==', activeOwner.id));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const customersList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setCustomers(customersList);
                });
                return unsubscribe;
            }, [activeOwner?.id]);
            
            // Close customer dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (showCustomerDropdown && !e.target.closest('.customer-dropdown-container')) {
                        setShowCustomerDropdown(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showCustomerDropdown]);
            
            // Extract unique categories from inventory
            const invCategories = [...new Set((inventory || []).map(i => i.category).filter(c => c))];
            const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
            
            // Tampilkan semua kategori termasuk yang stoknya 0
            const categoriesWithStock = [...new Set((inventory || [])
                .filter(i => i.category) // Tampilkan semua kategori
                .map(i => i.category))]; 
            
            // Gabungkan dengan custom categories jika ada di inventory
            const productCategories = [...new Set([...categoriesWithStock])];
            
            // Filter products by category + sub-category + search (tanpa filter stock)
            const displayedProducts = (inventory || []).filter(i => {
                const matchSearch = i.name?.toLowerCase().includes(searchBarang.toLowerCase());
                const matchCategory = !selectedCategory || i.category === selectedCategory;
                const matchSubCategory = !selectedSubCategory || i.subCategory === selectedSubCategory;
                return matchSearch && matchCategory && matchSubCategory;
            });

            // Pagination untuk produk
            const totalProducts = displayedProducts.length;
            const totalProductPages = Math.ceil(totalProducts / productItemsPerPage);
            const productStartIndex = (productCurrentPage - 1) * productItemsPerPage;
            const productEndIndex = productStartIndex + productItemsPerPage;
            const paginatedProducts = displayedProducts.slice(productStartIndex, productEndIndex);

            const handleProductPageChange = (page) => {
                if (page >= 1 && page <= totalProductPages) {
                    setProductCurrentPage(page);
                }
            };

            const handleProductItemsPerPageChange = (num) => {
                setProductItemsPerPage(num);
                setProductCurrentPage(1);
            };

            // Calculate cart totals
            const subtotal = cart.reduce((a, b) => a + (b.qty * b.sellPrice), 0);
            const discountAmount = (subtotal * discount) / 100;
            const total = subtotal - discountAmount;

            const removeFromCart = (itemId) => {
                setCart(cart.filter(c => c.id !== itemId));
            };

            const addToCart = (item) => {
                // Warning jika stok 0 atau kurang
                if (item.stock <= 0) {
                    if (!confirm(`‚ö†Ô∏è Stok ${item.name} saat ini ${item.stock || 0} pcs.\n\nTetap tambahkan ke keranjang?`)) {
                        return;
                    }
                }
                
                const existing = cart.find(c => c.id === item.id);
                if (existing) {
                    if (item.stock > 0 && existing.qty < item.stock) {
                        setCart(cart.map(c => c.id === item.id ? {...c, qty: c.qty + 1} : c));
                    } else if (item.stock <= 0) {
                        // Izinkan tambah qty meskipun stok 0 (dengan warning sebelumnya)
                        setCart(cart.map(c => c.id === item.id ? {...c, qty: c.qty + 1} : c));
                    } else {
                        alert(`Stok ${item.name} hanya ${item.stock} pcs`);
                    }
                } else {
                    setCart([...cart, {...item, qty: 1, subCategory: item.subCategory || '', brand: item.brand || ''}]);
                }
            };

            const updateCartItemPrice = (itemId, newPrice) => {
                setCart(cart.map(c => c.id === itemId ? {...c, sellPrice: newPrice} : c));
                setEditingPrice(null);
            };
            
            const addNewCustomer = async () => {
                if (!newCustomerForm.name.trim()) {
                    alert('Nama pelanggan tidak boleh kosong');
                    return;
                }
                
                try {
                    // Simpan pelanggan baru ke Firestore
                    const newCustomerRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers'), {
                        ownerId: activeOwner.id,
                        name: newCustomerForm.name,
                        phone: newCustomerForm.phone || '',
                        address: newCustomerForm.address || '',
                        customerType: newCustomerForm.customerType || 'sales',
                        createdAt: serverTimestamp()
                    });
                    
                    // Set nama pelanggan ke form checkout
                    setCustomerName(newCustomerForm.name);
                    setNewCustomerForm({name: '', phone: '', address: '', customerType: 'sales'});
                    setShowNewCustomerForm(false);
                    alert('‚úÖ Pelanggan baru berhasil ditambahkan!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            
            const addManualItem = () => {
                if (!manualItem.name.trim()) {
                    alert('Nama barang tidak boleh kosong');
                    return;
                }
                if (manualItem.buyPrice <= 0) {
                    alert('Harga modal harus lebih dari 0');
                    return;
                }
                if (manualItem.sellPrice <= 0) {
                    alert('Harga jual harus lebih dari 0');
                    return;
                }
                if (manualItem.qty <= 0) {
                    alert('Jumlah harus lebih dari 0');
                    return;
                }
                
                setCart([...cart, {
                    id: 'manual_' + Date.now(),
                    name: manualItem.name + ' (Manual)',
                    category: 'Manual',
                    brand: '',
                    subCategory: '',
                    sellPrice: manualItem.sellPrice,
                    buyPrice: manualItem.buyPrice,
                    qty: manualItem.qty,
                    isManual: true
                }]);
                
                setManualItem({name: '', buyPrice: 0, sellPrice: 0, qty: 1});
                setShowManualItemForm(false);
                alert('‚úÖ Barang manual ditambahkan ke keranjang');
            };

            const updateCartQty = (itemId, newQty) => {
                if (newQty <= 0) {
                    removeFromCart(itemId);
                } else {
                    const cartItem = cart.find(c => c.id === itemId);
                    // Manual items don't have stock limits
                    if (cartItem && cartItem.isManual) {
                        setCart(cart.map(c => c.id === itemId ? {...c, qty: newQty} : c));
                        return;
                    }
                    const item = inventory.find(i => i.id === itemId);
                    if (!item) {
                        // Item not found in inventory (e.g. deleted), allow update anyway
                        setCart(cart.map(c => c.id === itemId ? {...c, qty: newQty} : c));
                        return;
                    }
                    if (newQty <= item.stock) {
                        setCart(cart.map(c => c.id === itemId ? {...c, qty: newQty} : c));
                    } else {
                        alert(`Stok ${item.name} hanya ${item.stock} pcs`);
                    }
                }
            };

            const handleSaveSale = async () => {
                if (!customerName.trim()) {
                    alert("Nama pelanggan wajib diisi");
                    return;
                }
                if (cart.length === 0) {
                    alert("Keranjang tidak boleh kosong");
                    return;
                }

                try {
                    // 1. Check if customer exists, if not create new customer
                    let existingCustomer = customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
                    
                    if (!existingCustomer && (customerPhone || customerAddress)) {
                        // Create new customer
                        const newCustomerRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            name: customerName,
                            phone: customerPhone || '',
                            address: customerAddress || '',
                            createdAt: serverTimestamp()
                        });
                        existingCustomer = {
                            id: newCustomerRef.id,
                            name: customerName,
                            phone: customerPhone,
                            address: customerAddress
                        };
                    } else if (existingCustomer && existingCustomer.id && customerAddress && customerAddress !== existingCustomer.address) {
                        // Update address jika pelanggan sudah ada tapi address berubah/baru diisi
                        try {
                            await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', existingCustomer.id), {
                                address: customerAddress,
                                ...(customerPhone && !existingCustomer.phone ? { phone: customerPhone } : {})
                            });
                        } catch(e) { /* ignore update fail */ }
                    }
                    
                    const payload = {
                        customerName,
                        customerId: existingCustomer?.id || null,
                        items: cart.map(c => ({name: c.name, category: c.category, subCategory: c.subCategory || '', brand: c.brand || '', qty: c.qty, sellPrice: c.sellPrice, buyPrice: c.buyPrice, id: c.id})),
                        subtotal,
                        discount,
                        discountAmount,
                        total,
                        paymentMethod,
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        createdAt: serverTimestamp(),
                        type: 'sale'
                    };
                    
                    // Calculate modal (cost) and profit
                    let totalModal = 0;
                    let totalProfit = 0;
                    
                    // Calculate costs (tidak update stok dulu)
                    for (const item of cart) {
                        // Calculate modal per item
                        const itemModal = (item.buyPrice || 0) * item.qty;
                        totalModal += itemModal;
                        
                        // Calculate profit per item
                        const itemProfit = ((item.sellPrice || 0) - (item.buyPrice || 0)) * item.qty;
                        totalProfit += itemProfit;
                    }
                    
                    // Add profit to payload
                    payload.profit = totalProfit;
                    payload.modal = totalModal;
                    
                    // Use transaction to ensure atomicity
                    const saleRef = doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'sales'));
                    
                    await runTransaction(db, async (transaction) => {
                        // 1. Simpan sale
                        transaction.set(saleRef, payload);
                        
                        // 2. Kurangi stok untuk setiap item di cart (hanya yang bukan manual)
                        for (const item of cart) {
                            // Lewati item manual tidak perlu update stok
                            if (item.isManual) continue;
                            
                            const itemRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.id);
                            transaction.update(itemRef, {
                                stock: increment(-item.qty)
                            });
                        }
                    });
                    
                    const saleId = saleRef.id;
                    
                    // Create transaction records
                    const batch = writeBatch(db);
                    
                    // 1. PENGELUARAN (Modal/Cost)
                    if (totalModal > 0) {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'expense',
                            category: 'Modal Barang Terjual',
                            description: `Modal penjualan untuk ${customerName}`,
                            amount: totalModal,
                            date: serverTimestamp(),
                            originalSaleId: saleId,
                            cashAccount: cashAccount || 'Kas Tunai'
                        });
                    }
                    
                    // 2. PEMASUKAN (Revenue) - Only if not credit
                    if (paymentMethod !== 'credit') {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'income',
                            category: 'Penjualan Barang',
                            description: `Penjualan ${cart.length} item ke ${customerName}`,
                            amount: payload.total,
                            date: serverTimestamp(),
                            originalSaleId: saleId,
                            cashAccount: cashAccount || 'Kas Tunai'
                        });
                    }
                    
                    // If credit, create receivable (piutang)
                    if (paymentMethod === 'credit') {
                        const _now1 = new Date();
                        const _pad1 = (n,l=2) => String(n).padStart(l,'0');
                        const _ds1 = `${_now1.getFullYear()}${_pad1(_now1.getMonth()+1)}${_pad1(_now1.getDate())}`;
                        const _inv1 = `PIU-${_ds1}-${_pad1(Math.floor(Math.random()*9000)+1000,4)}`;
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'receivable',
                            customerName: customerName,
                            customerPhone: customerPhone || '',
                            invoiceNo: _inv1,
                            amount: payload.total,
                            paid: 0,
                            remaining: payload.total,
                            description: `Penjualan ${cart.length} item`,
                            items: cart.map(i => ({ name: i.name, qty: i.qty, price: i.price })),
                            dueDate: saleDueDate ? new Date(Date.now()+Number(saleDueDate)*86400000).toISOString().split('T')[0] : '',
                            status: 'unpaid',
                            createdAt: serverTimestamp()
                        });
                    }
                    
                    // 3. KEUNTUNGAN (Profit/Loss)
                    if (totalProfit !== 0) {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: totalProfit > 0 ? 'profit' : 'loss',
                            category: totalProfit > 0 ? 'Keuntungan Penjualan' : 'Rugi Penjualan',
                            description: `${totalProfit > 0 ? 'Profit' : 'Loss'} dari penjualan ke ${customerName}`,
                            amount: Math.abs(totalProfit),
                            date: serverTimestamp(),
                            originalSaleId: saleId,
                            cashAccount: cashAccount || 'Kas Tunai'
                        });
                    }
                    
                    await batch.commit();
                    
                    // ‚úÖ Catat ke cash_flow agar saldo kas terupdate
                    if (paymentMethod !== 'credit') {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'in',
                            amount: payload.total,
                            category: 'Penjualan Barang',
                            description: `Penjualan ke ${customerName} (${cart.length} item)`,
                            account: cashAccount || 'Kas Tunai',
                            createdAt: serverTimestamp()
                        });
                    }
                    
                    // Reset form
                    setCart([]);
                    setCustomerName('');
                    setCustomerPhone('');
                    setCustomerAddress('');
                    setDiscount(0);
                    setPaymentMethod('cash');
                    setCashAccount('Kas Tunai');
                    setSaleDueDate('');
                    setModal(null);
                    alert('‚úÖ Penjualan berhasil disimpan!');
                } catch (err) {
                    alert("Gagal simpan: " + err.message);
                }
            };

            const handleReturn = async (saleId, returnData) => {
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'sales'), {
                        ...returnData,
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        createdAt: serverTimestamp(),
                        type: 'return',
                        originalSaleId: saleId
                    });
                    alert('‚úÖ Retur berhasil dicatat!');
                } catch (err) {
                    alert("Gagal retur: " + err.message);
                }
            };

            const deleteSale = async (id) => {
                if (confirm("Hapus transaksi penjualan ini? Stok akan dikembalikan dan semua transaksi terkait akan dihapus.")) {
                    try {
                        const saleRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'sales', id);
                        const saleSnap = await getDoc(saleRef);
                        
                        if (!saleSnap.exists()) {
                            alert('Sale tidak ditemukan');
                            return;
                        }
                        
                        const saleData = saleSnap.data();
                        
                        // Get all related transactions first
                        const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                        const q = query(transRef, where('originalSaleId', '==', id));
                        const transSnap = await getDocs(q);
                        
                        // Prepare inventory items to restore (check which items exist first)
                        // ‚ö†Ô∏è SKIP stock restore untuk service_sale ‚Äî stok dikelola oleh modul servis
                        const itemsToRestore = [];
                        if (saleData.type !== 'service_sale') {
                        for (const item of (saleData.items || [])) {
                            // Skip jika item manual atau tidak punya id
                            if (!item.id || item.id.startsWith('manual_')) {
                                continue;
                            }
                            
                            // Cek apakah item masih ada di inventory
                            const itemRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.id);
                            const itemSnap = await getDoc(itemRef);
                            
                            // Hanya tambahkan ke list jika item masih ada
                            if (itemSnap.exists()) {
                                itemsToRestore.push({ ref: itemRef, qty: item.qty });
                            }
                        }
                        } // end if not service_sale
                        
                        // Use batch instead of transaction for better performance
                        const batch = writeBatch(db);
                        
                        // 1. Kembalikan stok untuk setiap item yang valid
                        for (const item of itemsToRestore) {
                            batch.update(item.ref, {
                                stock: increment(item.qty)
                            });
                        }
                        
                        // 2. Hapus semua transactions terkait
                        transSnap.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        // 3. Hapus sale
                        batch.delete(saleRef);
                        
                        // Commit batch
                        await batch.commit();
                        
                        alert('‚úÖ Transaksi dihapus, stok dikembalikan, dan semua data terkait dihapus');
                    } catch (err) {
                        console.error("Error deleting sale:", err);
                        alert("Gagal hapus: " + err.message);
                    }
                }
            };

            // Date filter logic
            const filterByDate = (sale) => {
                if (!sale.createdAt) return false;
                const saleDate = sale.createdAt.toDate ? sale.createdAt.toDate() : new Date(sale.createdAt);
                const now = new Date();
                
                switch(dateFilter) {
                    case 'today':
                        return saleDate.toDateString() === now.toDateString();
                    case 'month':
                        return saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear();
                    case 'year':
                        return saleDate.getFullYear() === now.getFullYear();
                    case 'custom':
                        if (!customDateRange.start || !customDateRange.end) return true;
                        const start = new Date(customDateRange.start);
                        const end = new Date(customDateRange.end);
                        end.setHours(23, 59, 59, 999);
                        return saleDate >= start && saleDate <= end;
                    default: // 'all'
                        return true;
                }
            };
            
            // Daftar kategori & sub-kategori unik dari riwayat penjualan
            const historyCategories = [...new Set(
                (sales || []).flatMap(s => s.items?.map(it => it.category).filter(Boolean) || [])
            )].sort();

            const historySubCategories = [...new Set(
                (sales || []).flatMap(s => {
                    if (!historyCat) return s.items?.map(it => it.subCategory).filter(Boolean) || [];
                    return s.items?.filter(it => it.category === historyCat).map(it => it.subCategory).filter(Boolean) || [];
                })
            )].sort();

            const sales_list = (sales || []).filter(s => {
                const t = (term || '').toLowerCase();
                const matchTerm = !t ||
                    (s.customerName || '').toLowerCase().includes(t) ||
                    (s.items || []).some(it =>
                        (it.name || '').toLowerCase().includes(t) ||
                        (it.brand || '').toLowerCase().includes(t) ||
                        (it.category || '').toLowerCase().includes(t)
                    );
                const matchDate = filterByDate(s);
                const matchCat = !historyCat || s.items?.some(it => it.category === historyCat);
                const matchSubCat = !historySubCat || s.items?.some(it => it.subCategory === historySubCat);
                return matchTerm && matchDate && matchCat && matchSubCat;
            });
            
            // Pagination logic
            const totalItems = sales_list.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedSales = sales_list.slice(startIndex, endIndex);
            
            // Reset to page 1 when filter changes
            useEffect(() => {
                setCurrentPage(1);
            }, [term, dateFilter, historyCat, historySubCat]);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    setCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const handleItemsPerPageChange = (value) => {
                setItemsPerPage(value);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center gap-4">
                        <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200">
                            {[
                                { id: 'cart', label: 'Keranjang' },
                                { id: 'history', label: 'Riwayat' }
                            ].map(t => (
                                <button key={t.id} onClick={() => { setTab(t.id); setTerm(''); if(t.id === 'cart') { setHistoryCat(''); setHistorySubCat(''); } }} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>{t.label}</button>
                            ))}
                        </div>
                    </div>

                    {tab === 'cart' ? (
                        <>
                            {/* Daftar Barang */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="font-bold text-lg mb-4 text-slate-800">Daftar Barang</h3>
                                    
                                    <div className="bg-white p-3 rounded-xl border border-slate-200 mb-3 sticky top-0 z-10">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            {productCategories.length > 0 && (
                                                <div>
                                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Filter Kategori</label>
                                                    <select 
                                                        value={selectedCategory} 
                                                        onChange={e => { setSelectedCategory(e.target.value); setSelectedSubCategory(''); }}
                                                        className="w-full border-2 border-slate-200 p-2.5 rounded-lg text-sm bg-white focus:border-blue-500 focus:outline-none font-bold"
                                                    >
                                                        <option value="">üì¶ Semua Kategori ({displayedProducts.length})</option>
                                                        {productCategories.map(cat => (
                                                            <option key={cat} value={cat}>
                                                                üìÅ {cat} ({(inventory || []).filter(i => i.category === cat).length})
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                            <div>
                                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Sub-Kategori</label>
                                                <select 
                                                    value={selectedSubCategory} 
                                                    onChange={e => setSelectedSubCategory(e.target.value)}
                                                    className="w-full border-2 border-slate-200 p-2.5 rounded-lg text-sm bg-white focus:border-blue-500 focus:outline-none font-bold"
                                                    disabled={!selectedCategory}
                                                >
                                                    <option value="">üìÅ Semua Sub-Kategori</option>
                                                    {selectedCategory && subCategories[selectedCategory] && subCategories[selectedCategory].map(sub => (
                                                        <option key={sub} value={sub}>‚Üí {sub}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="relative">
                                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Cari Barang</label>
                                                <Search className="absolute left-3 bottom-3 w-5 h-5 text-gray-400" />
                                                <input 
                                                    value={searchBarang} 
                                                    onChange={e => setSearchBarang(e.target.value)} 
                                                    placeholder="Ketik nama barang..." 
                                                    className="pl-10 pr-4 py-2.5 w-full border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 bg-gray-50 focus:bg-white transition-all" 
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl border border-slate-200">
                                        <div className="space-y-2 p-4 min-h-[450px]">
                                            {paginatedProducts.length > 0 ? (
                                                paginatedProducts.map(item => (
                                                    <button key={item.id} onClick={() => addToCart(item)} className={`w-full text-left p-3 rounded-lg border transition-all flex items-center justify-between group ${item.stock <= 0 ? 'border-red-300 bg-red-50 hover:border-red-500' : 'border-slate-200 hover:border-blue-500 hover:bg-blue-50'}`}>
                                                        <div className="flex-1">
                                                            <p className="font-bold text-slate-800">{item.name}</p>
                                                            <div className="flex gap-1 flex-wrap mt-0.5">
                                                                {item.category && (
                                                                    <span className="text-[10px] text-purple-600 font-semibold bg-purple-50 px-1.5 py-0.5 rounded">üì¶ {item.category}</span>
                                                                )}
                                                                {item.subCategory && (
                                                                    <span className="text-[10px] text-blue-600 font-semibold bg-blue-50 px-1.5 py-0.5 rounded">‚Üí {item.subCategory}</span>
                                                                )}
                                                                {item.stock <= 0 && (
                                                                    <span className="text-[10px] text-red-600 font-bold bg-red-100 px-1.5 py-0.5 rounded">‚ö†Ô∏è STOK HABIS</span>
                                                                )}
                                                            </div>
                                                            <p className={`text-xs ${item.stock <= 0 ? 'text-red-600 font-bold' : 'text-slate-500'}`}>Stok: {item.stock} | Harga: {formatCurrency(item.sellPrice)}</p>
                                                        </div>
                                                        <Plus className={`w-4 h-4 ${item.stock <= 0 ? 'text-red-400' : 'text-slate-400 group-hover:text-blue-600'}`} />
                                                    </button>
                                                ))
                                            ) : (
                                                <div className="flex items-center justify-center h-[400px] text-slate-400">
                                                    <div className="text-center">
                                                        <Package className="w-16 h-16 mx-auto mb-3 opacity-30" />
                                                        <p className="font-medium">Tidak ada produk ditemukan</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* Pagination Controls untuk Produk */}
                                        {displayedProducts.length > 0 && (
                                            <div className="border-t border-slate-200 p-4 space-y-3">
                                                <div className="flex flex-col sm:flex-row justify-between items-center gap-3 bg-gradient-to-r from-blue-50 to-purple-50 p-3 rounded-lg">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-xs text-slate-600 font-medium">Tampilkan:</span>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => handleProductItemsPerPageChange(12)} className={`px-2.5 py-1 rounded-lg text-xs font-bold transition-all ${productItemsPerPage === 12 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>12</button>
                                                            <button onClick={() => handleProductItemsPerPageChange(24)} className={`px-2.5 py-1 rounded-lg text-xs font-bold transition-all ${productItemsPerPage === 24 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>24</button>
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-slate-600 font-medium">
                                                        <span className="text-blue-600 font-bold">{productStartIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(productEndIndex, totalProducts)}</span> dari <span className="text-purple-600 font-bold">{totalProducts}</span> produk
                                                    </div>
                                                </div>

                                                {totalProductPages > 1 && (
                                                    <div className="flex justify-between items-center gap-3 bg-white p-3 rounded-lg border border-gray-100">
                                                        <button 
                                                            onClick={() => handleProductPageChange(productCurrentPage - 1)} 
                                                            disabled={productCurrentPage === 1}
                                                            className="px-3 py-1.5 rounded-lg font-bold text-xs transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                                        >
                                                            ‚Üê Sebelumnya
                                                        </button>
                                                        <div className="text-xs text-slate-600 font-medium">
                                                            Hal <span className="text-blue-600 font-bold">{productCurrentPage}</span> dari <span className="text-purple-600 font-bold">{totalProductPages}</span>
                                                        </div>
                                                        <button 
                                                            onClick={() => handleProductPageChange(productCurrentPage + 1)} 
                                                            disabled={productCurrentPage === totalProductPages}
                                                            className="px-3 py-1.5 rounded-lg font-bold text-xs transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                                        >
                                                            Selanjutnya ‚Üí
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Keranjang */}
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg text-slate-800">Keranjang Belanja</h3>
                                        <button 
                                            onClick={() => setShowManualItemForm(!showManualItemForm)}
                                            className="text-xs font-bold bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg hover:bg-purple-200 transition-all flex items-center gap-1"
                                        >
                                            {showManualItemForm ? '‚úï Batal' : '+ Manual'}
                                        </button>
                                    </div>
                                    
                                    {/* Form Input Barang Manual */}
                                    {showManualItemForm && (
                                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4 space-y-2">
                                            <input 
                                                type="text"
                                                placeholder="Nama barang/jasa..."
                                                value={manualItem.name}
                                                onChange={e => setManualItem({...manualItem, name: e.target.value})}
                                                className="w-full border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-purple-500"
                                            />
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                <input 
                                                    type="number"
                                                    placeholder="Harga Modal"
                                                    value={manualItem.buyPrice || ''}
                                                    onChange={e => setManualItem({...manualItem, buyPrice: parseFloat(e.target.value) || 0})}
                                                    className="border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-purple-500 font-bold"
                                                />
                                                <input 
                                                    type="number"
                                                    placeholder="Harga Jual"
                                                    value={manualItem.sellPrice || ''}
                                                    onChange={e => setManualItem({...manualItem, sellPrice: parseFloat(e.target.value) || 0})}
                                                    className="border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-purple-500 font-bold"
                                                />
                                                <input 
                                                    type="number"
                                                    placeholder="Qty"
                                                    min="1"
                                                    value={manualItem.qty || 1}
                                                    onChange={e => setManualItem({...manualItem, qty: parseInt(e.target.value) || 1})}
                                                    className="border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-purple-500 font-bold"
                                                />
                                                <button 
                                                    onClick={addManualItem}
                                                    className="bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all col-span-2 md:col-span-1 py-2"
                                                >
                                                    Tambah
                                                </button>
                                            </div>
                                            {manualItem.buyPrice > 0 && manualItem.sellPrice > 0 && manualItem.qty > 0 && (
                                                <div className="text-xs text-center space-y-1 pt-2 border-t border-purple-200">
                                                    <div className="text-slate-600">Subtotal: {formatCurrency(manualItem.sellPrice * manualItem.qty)}</div>
                                                    <div className="text-green-600 font-bold">Laba: {formatCurrency((manualItem.sellPrice - manualItem.buyPrice) * manualItem.qty)}</div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    <div className="bg-white rounded-xl p-4 border border-slate-200 space-y-4">
                                        <div className="space-y-3 max-h-48 overflow-y-auto border-b pb-4">
                                            {cart.length === 0 ? (
                                                <p className="text-center text-slate-400 py-6">Keranjang kosong</p>
                                            ) : (
                                                cart.map(item => (
                                                    <div key={item.id} className="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-sm text-slate-800">{item.name}</p>
                                                            <div className="flex gap-1 flex-wrap">
                                                                {item.brand && (
                                                                    <span className="text-[10px] text-orange-600 font-semibold">üè∑Ô∏è {item.brand}</span>
                                                                )}
                                                                {item.category && (
                                                                    <span className="text-[10px] text-purple-600 font-semibold">üì¶ {item.category}</span>
                                                                )}
                                                                {item.subCategory && (
                                                                    <span className="text-[10px] text-blue-600 font-semibold">‚Üí {item.subCategory}</span>
                                                                )}
                                                            </div>
                                                            <p className="text-xs text-slate-500">
                                                                {editingPrice?.itemId === item.id ? (
                                                                    <input 
                                                                        type="number"
                                                                        value={editingPrice.price}
                                                                        onChange={e => setEditingPrice({...editingPrice, price: parseFloat(e.target.value) || 0})}
                                                                        className="w-20 border border-blue-400 p-1 rounded text-xs font-bold"
                                                                        autoFocus
                                                                    />
                                                                ) : (
                                                                    <>{formatCurrency(item.sellPrice)} √ó {item.qty}</>
                                                                )}
                                                            </p>
                                                        </div>
                                                        <div className="flex items-center gap-1">
                                                            {editingPrice?.itemId === item.id ? (
                                                                <>
                                                                    <button onClick={() => updateCartItemPrice(item.id, editingPrice.price)} className="text-green-600 hover:bg-green-50 p-1 rounded text-xs font-bold">‚úì</button>
                                                                    <button onClick={() => setEditingPrice(null)} className="text-red-600 hover:bg-red-50 p-1 rounded text-xs font-bold">‚úï</button>
                                                                </>
                                                            ) : (
                                                                <button onClick={() => setEditingPrice({itemId: item.id, price: item.sellPrice})} className="text-blue-600 hover:bg-blue-50 p-1 rounded" title="Edit Harga"><Pencil className="w-3 h-3" /></button>
                                                            )}
                                                            <button onClick={() => updateCartQty(item.id, item.qty - 1)} className="text-slate-500 hover:text-red-600 p-1"><Minus className="w-4 h-4" /></button>
                                                            <span className="w-6 text-center text-sm font-bold">{item.qty}</span>
                                                            <button onClick={() => updateCartQty(item.id, item.qty + 1)} className="text-slate-500 hover:text-green-600 p-1"><Plus className="w-4 h-4" /></button>
                                                            <button onClick={() => removeFromCart(item.id)} className="text-red-500 hover:bg-red-50 p-1 rounded"><X className="w-4 h-4" /></button>
                                                        </div>
                                                        <p className="text-sm font-bold text-green-600 w-20 text-right">{formatCurrency(item.qty * item.sellPrice)}</p>
                                                    </div>
                                                ))
                                            )}
                                        </div>

                                        {/* Ringkasan */}
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between"><span>Subtotal</span><span className="font-bold">{formatCurrency(subtotal)}</span></div>
                                            <div className="flex justify-between"><span>Diskon</span><span className="font-bold text-orange-600">{discount}% ({formatCurrency(discountAmount)})</span></div>
                                            <div className="flex justify-between border-t pt-2"><span className="font-bold">Total</span><span className="font-bold text-lg text-green-600">{formatCurrency(total)}</span></div>
                                        </div>

                                        {cart.length > 0 && (
                                            <button onClick={() => setModal('checkout')} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition-all">Checkout</button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </>
                    ) : (
                        <>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 sticky top-0 z-10 space-y-3">
                                <div className="relative"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={term} onChange={e => setTerm(e.target.value)} placeholder="Cari pelanggan, nama barang, brand..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition-all" /></div>
                                
                                <div className="flex flex-col gap-3">
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-1 flex flex-wrap gap-1">
                                        {[{id:'today',l:'Hari Ini'},{id:'month',l:'Bulan Ini'},{id:'year',l:'Tahun Ini'},{id:'all',l:'Semua'},{id:'custom',l:'Custom'}].map(f => (
                                            <button key={f.id} onClick={()=>{setDateFilter(f.id); if(f.id!=='custom') setCustomDateRange({start:'',end:''})}} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${dateFilter === f.id ? 'bg-blue-600 text-white shadow' : 'text-slate-500 hover:bg-slate-200'}`}>{f.l}</button>
                                        ))}
                                    </div>
                                    {dateFilter === 'custom' && (
                                        <div className="flex gap-2 bg-slate-50 border border-slate-200 rounded-lg p-2">
                                            <input type="date" value={customDateRange.start} onChange={(e)=>setCustomDateRange({...customDateRange, start:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Dari"/>
                                            <span className="text-slate-400 self-center">-</span>
                                            <input type="date" value={customDateRange.end} onChange={(e)=>setCustomDateRange({...customDateRange, end:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Ke"/>
                                        </div>
                                    )}
                                    {/* ‚úÖ Filter Kategori & Sub Kategori */}
                                    <div className="flex flex-wrap gap-2 items-end">
                                        <div className="flex-1 min-w-[130px]">
                                            <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Kategori</label>
                                            <select
                                                value={historyCat}
                                                onChange={e => { setHistoryCat(e.target.value); setHistorySubCat(''); }}
                                                className="w-full border border-slate-300 rounded-lg px-2 py-1.5 text-xs bg-white focus:outline-none focus:border-blue-500 font-medium"
                                            >
                                                <option value="">üì¶ Semua Kategori</option>
                                                {historyCategories.map(cat => (
                                                    <option key={cat} value={cat}>{cat}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="flex-1 min-w-[130px]">
                                            <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Sub Kategori</label>
                                            <select
                                                value={historySubCat}
                                                onChange={e => setHistorySubCat(e.target.value)}
                                                disabled={historySubCategories.length === 0}
                                                className="w-full border border-slate-300 rounded-lg px-2 py-1.5 text-xs bg-white focus:outline-none focus:border-blue-500 font-medium disabled:opacity-50"
                                            >
                                                <option value="">üè∑Ô∏è Semua Sub Kategori</option>
                                                {historySubCategories.map(sc => (
                                                    <option key={sc} value={sc}>{sc}</option>
                                                ))}
                                            </select>
                                        </div>
                                        {(historyCat || historySubCat) && (
                                            <button
                                                onClick={() => { setHistoryCat(''); setHistorySubCat(''); }}
                                                className="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-xs font-bold hover:bg-red-200 whitespace-nowrap"
                                            >
                                                ‚úï Reset
                                            </button>
                                        )}
                                        <div className="text-xs text-slate-500 self-end pb-1.5 whitespace-nowrap">
                                            {sales_list.length} data
                                            {(historyCat || historySubCat || term) && <span className="ml-1 text-blue-600 font-bold">(filter)</span>}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {paginatedSales.length === 0 && (
                                    <div className="md:col-span-2 bg-white rounded-2xl p-10 text-center text-slate-400 border border-slate-200 shadow-sm">Tidak ada riwayat penjualan.</div>
                                )}
                                {paginatedSales.map(s => (
                                    <div key={s.id} className={`bg-white rounded-2xl shadow-sm border flex flex-col ${s.status === 'cancelled' ? 'border-red-200 bg-red-50/30' : 'border-slate-200'} overflow-hidden`}>
                                        {/* Header card: tanggal + metode + status */}
                                        <div className="flex items-center justify-between gap-2 px-4 py-3 bg-slate-50 border-b border-slate-100">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <span className="text-xs text-slate-500 font-medium">üóì {formatDate(s.createdAt)}</span>
                                                <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[11px] font-bold">{s.paymentMethod || '-'}</span>
                                                {s.type === 'service_sale' && (
                                                    <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-[10px] font-bold">üîß Via Servis</span>
                                                )}
                                                {s.status === 'cancelled' && (
                                                    <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold">‚ùå Dibatalkan</span>
                                                )}
                                            </div>
                                            <div className="flex gap-1 shrink-0">
                                                <button onClick={() => setEditModal(s)} className="text-blue-500 hover:bg-blue-100 p-1.5 rounded transition-all" title="Edit"><Pencil className="w-4 h-4" /></button>
                                                <button onClick={() => deleteSale(s.id)} className="text-red-500 hover:bg-red-100 p-1.5 rounded transition-all" title="Hapus"><Trash2 className="w-4 h-4" /></button>
                                            </div>
                                        </div>
                                        <div className="p-4 space-y-3">
                                            {/* Pelanggan */}
                                            {s.customerName && (
                                                <div className="flex items-center gap-2">
                                                    <span className="text-slate-400 text-xs font-bold uppercase tracking-wide">Pelanggan</span>
                                                    <span className="font-bold text-slate-800 text-sm">{s.customerName}</span>
                                                </div>
                                            )}
                                            {/* Barang */}
                                            <div className="space-y-1.5">
                                                {(s.items && s.items.length > 0) ? (
                                                    <>
                                                        {s.items.slice(0, 3).map((item, idx) => (
                                                            <div key={idx} className="bg-slate-50 px-3 py-2 rounded-lg flex items-start justify-between gap-2">
                                                                <div className="flex-1 min-w-0">
                                                                    <div className="font-medium text-slate-800 text-sm truncate">{item.name}</div>
                                                                    <div className="flex gap-1 flex-wrap mt-0.5">
                                                                        {item.brand && (
                                                                            <span className="bg-orange-100 text-orange-700 text-[10px] font-bold px-1.5 py-0.5 rounded">üè∑Ô∏è {item.brand}</span>
                                                                        )}
                                                                        {item.category && (
                                                                            <span className="bg-purple-100 text-purple-700 text-[10px] font-bold px-1.5 py-0.5 rounded">üì¶ {item.category}</span>
                                                                        )}
                                                                        {item.subCategory && (
                                                                            <span className="bg-blue-100 text-blue-700 text-[10px] font-bold px-1.5 py-0.5 rounded">‚Üí {item.subCategory}</span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="text-right shrink-0">
                                                                    <div className="text-xs font-bold text-slate-600">√ó{item.qty}</div>
                                                                    {item.sellPrice && <div className="text-[10px] text-slate-400">{formatCurrency(item.sellPrice)}</div>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {s.items.length > 3 && (
                                                            <div className="text-xs text-blue-600 font-bold text-center py-1 bg-blue-50 rounded-lg">+{s.items.length - 3} item lainnya</div>
                                                        )}
                                                    </>
                                                ) : (
                                                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-2 text-center">
                                                        <div className="text-amber-700 text-xs font-bold">üì¶ {formatCurrency(s.subtotal || s.total || 0)}</div>
                                                        <div className="text-amber-500 text-[10px] mt-0.5">Detail item tidak tersedia</div>
                                                    </div>
                                                )}
                                            </div>
                                            {/* Stats: Subtotal | Diskon | Laba */}
                                            <div className="grid grid-cols-3 gap-2 text-center">
                                                <div className="bg-slate-50 rounded-lg py-2 px-1">
                                                    <div className="text-[10px] text-slate-400 font-bold uppercase">Subtotal</div>
                                                    <div className="text-xs font-bold text-slate-700 mt-0.5">{formatCurrency(s.subtotal || 0)}</div>
                                                </div>
                                                <div className="bg-orange-50 rounded-lg py-2 px-1">
                                                    <div className="text-[10px] text-orange-400 font-bold uppercase">Diskon</div>
                                                    <div className="text-xs font-bold text-orange-600 mt-0.5">{s.discount || 0}%</div>
                                                </div>
                                                <div className="bg-green-50 rounded-lg py-2 px-1">
                                                    <div className="text-[10px] text-green-500 font-bold uppercase">Laba</div>
                                                    <div className="text-xs font-bold text-green-700 mt-0.5">{s.profit !== undefined ? formatCurrency(s.profit) : '-'}</div>
                                                </div>
                                            </div>
                                            {/* Total */}
                                            <div className="flex items-center justify-between bg-green-600 text-white rounded-xl px-4 py-2.5">
                                                <span className="text-sm font-bold">Total</span>
                                                <span className="text-base font-extrabold">{formatCurrency(s.total || 0)}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            {/* Pagination Controls */}
                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                                <div className="flex items-center gap-3">
                                    <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                        <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                                    </div>
                                </div>
                                <div className="text-sm text-slate-600 font-medium">
                                    Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                                </div>
                            </div>
                            
                            {/* Pagination Navigation */}
                            {totalPages > 1 && (
                                <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                    <button 
                                        onClick={() => handlePageChange(currentPage - 1)} 
                                        disabled={currentPage === 1}
                                        className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                    >
                                        ‚Üê Sebelumnya
                                    </button>
                                    <div className="text-sm text-slate-600 font-medium">
                                        Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                                    </div>
                                    <button 
                                        onClick={() => handlePageChange(currentPage + 1)} 
                                        disabled={currentPage === totalPages}
                                        className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                    >
                                        Selanjutnya ‚Üí
                                    </button>
                                </div>
                            )}
                        </>
                    )}

                    {/* Modal Checkout */}
                    {modal === 'checkout' && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl space-y-4">
                                <h3 className="font-bold text-xl text-slate-800">Konfirmasi Transaksi</h3>
                                
                                <div className="space-y-3 bg-slate-50 p-4 rounded-lg">
                                    <div className="relative customer-dropdown-container">
                                        <label className="text-xs font-bold text-slate-600 block mb-1">Nama Pelanggan</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={customerName} 
                                                onChange={e => {
                                                    setCustomerName(e.target.value);
                                                    setShowCustomerDropdown(true);
                                                }} 
                                                onFocus={() => setShowCustomerDropdown(true)}
                                                placeholder="Ketik nama atau pilih dari daftar" 
                                                className="flex-1 border border-slate-300 p-2 rounded-lg focus:border-blue-500 focus:outline-none" 
                                            />
                                            <button 
                                                type="button"
                                                onClick={() => setShowCustomerDropdown(!showCustomerDropdown)}
                                                className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-all"
                                                title="Lihat daftar pelanggan"
                                            >
                                                <ChevronDown className="w-4 h-4" />
                                            </button>
                                        </div>
                                        
                                        {showCustomerDropdown && customers.length > 0 && (
                                            <div className="absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                {customers
                                                    .filter(c => c.name?.toLowerCase().includes(customerName.toLowerCase()))
                                                    .map(customer => (
                                                        <button
                                                            key={customer.id}
                                                            type="button"
                                                            onClick={() => {
                                                                setCustomerName(customer.name);
                                                                setShowCustomerDropdown(false);
                                                            }}
                                                            className="w-full text-left px-3 py-2 hover:bg-blue-50 transition-colors border-b last:border-b-0"
                                                        >
                                                            <div className="font-bold text-slate-800 text-sm">{customer.name}</div>
                                                            {customer.phone && (
                                                                <div className="text-xs text-slate-500 flex items-center gap-1">
                                                                    <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                                                                    </svg>
                                                                    {customer.phone}
                                                                </div>
                                                            )}
                                                        </button>
                                                    ))
                                                }
                                                {customers.filter(c => c.name?.toLowerCase().includes(customerName.toLowerCase())).length === 0 && (
                                                    <div className="px-3 py-2 text-xs text-slate-500 text-center">Tidak ada pelanggan yang cocok</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Tombol Tambah Pelanggan Baru */}
                                    {!showNewCustomerForm && (
                                        <button 
                                            type="button"
                                            onClick={() => setShowNewCustomerForm(true)}
                                            className="w-full text-xs font-bold bg-emerald-100 text-emerald-700 px-3 py-2 rounded-lg hover:bg-emerald-200 transition-all"
                                        >
                                            + Tambah Pelanggan Baru
                                        </button>
                                    )}
                                    
                                    {/* Form Tambah Pelanggan Baru */}
                                    {showNewCustomerForm && (
                                        <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 space-y-2">
                                            <h4 className="font-bold text-sm text-emerald-900">Tambah Pelanggan Baru</h4>
                                            <input 
                                                type="text"
                                                placeholder="Nama Pelanggan"
                                                value={newCustomerForm.name}
                                                onChange={e => setNewCustomerForm({...newCustomerForm, name: e.target.value})}
                                                className="w-full border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-emerald-500"
                                            />
                                            <input 
                                                type="tel"
                                                placeholder="Nomor HP"
                                                value={newCustomerForm.phone}
                                                onChange={e => setNewCustomerForm({...newCustomerForm, phone: e.target.value})}
                                                className="w-full border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-emerald-500"
                                            />
                                            <input 
                                                type="text"
                                                placeholder="Alamat"
                                                value={newCustomerForm.address}
                                                onChange={e => setNewCustomerForm({...newCustomerForm, address: e.target.value})}
                                                className="w-full border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-emerald-500"
                                            />
                                            <div>
                                                <label className="text-xs font-bold text-emerald-900 mb-1 block">Tipe Pelanggan</label>
                                                <select 
                                                    value={newCustomerForm.customerType || 'sales'}
                                                    onChange={e => setNewCustomerForm({...newCustomerForm, customerType: e.target.value})}
                                                    className="w-full border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-emerald-500"
                                                >
                                                    <option value="sales">üõí Pelanggan Penjualan</option>
                                                    <option value="service">üì± Pelanggan Service</option>
                                                </select>
                                            </div>
                                            <div className="flex gap-2">
                                                <button 
                                                    type="button"
                                                    onClick={addNewCustomer}
                                                    className="flex-1 bg-emerald-600 text-white rounded-lg font-bold py-2 hover:bg-emerald-700 transition-all text-sm"
                                                >
                                                    ‚úì Simpan
                                                </button>
                                                <button 
                                                    type="button"
                                                    onClick={() => {
                                                        setShowNewCustomerForm(false);
                                                        setNewCustomerForm({name: '', phone: '', address: '', customerType: 'sales'});
                                                    }}
                                                    className="flex-1 bg-slate-300 text-slate-700 rounded-lg font-bold py-2 hover:bg-slate-400 transition-all text-sm"
                                                >
                                                    ‚úï Batal
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <select value={paymentMethod} onChange={e => setPaymentMethod(e.target.value)} className="w-full border border-slate-300 p-2 rounded-lg">
                                        <option value="cash">Tunai</option>
                                        <option value="transfer">Transfer</option>
                                        <option value="card">Kartu Kredit</option>
                                        <option value="credit">üí≥ Kredit (Piutang)</option>
                                    </select>
                                    {paymentMethod === 'credit' && (
                                        <div>
                                            <p className="text-xs text-orange-600 mt-1">‚ö†Ô∏è Akan otomatis dicatat sebagai piutang pelanggan</p>
                                            <div className="mt-2">
                                                <label className="text-xs font-bold text-slate-500">üìÖ Jatuh Tempo</label>
                                                <div className="flex items-center gap-2 mt-1">
                                                    <input type="number" min="1" max="365" placeholder="cth: 30" value={saleDueDate} onChange={e => setSaleDueDate(e.target.value)} className="w-full border border-orange-300 p-2 rounded-lg text-sm" />
                                                    <span className="text-xs text-slate-500 whitespace-nowrap">hari</span>
                                                </div>
                                                {saleDueDate > 0 && <p className="text-xs text-slate-400 mt-1">Jatuh tempo: {new Date(Date.now()+Number(saleDueDate)*86400000).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}</p>}
                                            </div>
                                        </div>
                                    )}

                                    {paymentMethod !== 'credit' && (
                                        <CashAccountSelect value={cashAccount} onChange={setCashAccount} label="Masuk ke Kas" />
                                    )}

                                    <div>
                                        <label className="text-xs font-bold text-slate-600">Diskon (%)</label>
                                        <NumberInput value={discount} onChange={val => setDiscount(val || 0)} min="0" max="100" className="w-full border border-slate-300 p-2 rounded-lg mt-1" />
                                    </div>
                                </div>

                                <div className="bg-slate-100 p-3 rounded-lg space-y-1">
                                    <div className="flex justify-between"><span>Subtotal</span><span className="font-bold">{formatCurrency(subtotal)}</span></div>
                                    <div className="flex justify-between"><span>Diskon {discount}%</span><span className="text-orange-600 font-bold">-{formatCurrency(discountAmount)}</span></div>
                                    <div className="flex justify-between border-t pt-1"><span className="font-bold">Total Bayar</span><span className="text-lg font-bold text-green-600">{formatCurrency(total)}</span></div>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => setModal(null)} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-600">Batal</button>
                                    <button onClick={handleSaveSale} className="flex-1 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700">Selesai</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Edit Penjualan */}
                    {editModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                    <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2">
                                        <Pencil className="w-5 h-5 text-blue-600" />
                                        Edit Transaksi Penjualan
                                    </h3>
                                    <button onClick={() => setEditModal(null)} className="p-1 hover:bg-gray-100 rounded-full">
                                        <X className="w-5 h-5 text-slate-400" />
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <p className="text-xs text-blue-700">
                                            <Info className="w-4 h-4 inline mr-1" />
                                            Edit data penjualan. Perubahan akan langsung tersimpan.
                                        </p>
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">Nama Pelanggan</label>
                                        <input 
                                            type="text" 
                                            value={editModal.customerName || ''} 
                                            onChange={e => setEditModal({...editModal, customerName: e.target.value})}
                                            className="w-full border-2 border-slate-300 p-2.5 rounded-lg focus:border-blue-500 focus:outline-none" 
                                        />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">Metode Pembayaran</label>
                                            <select 
                                                value={editModal.paymentMethod || 'cash'} 
                                                onChange={e => setEditModal({...editModal, paymentMethod: e.target.value})}
                                                className="w-full border-2 border-slate-300 p-2.5 rounded-lg focus:border-blue-500 focus:outline-none bg-white"
                                            >
                                                <option value="cash">Tunai</option>
                                                <option value="transfer">Transfer</option>
                                                <option value="card">Kartu Kredit</option>
                                                <option value="credit">Kredit (Piutang)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">Diskon (%)</label>
                                            <NumberInput 
                                                value={editModal.discount || 0} 
                                                onChange={val => {
                                                    const newDiscount = val || 0;
                                                    const newDiscountAmount = (editModal.subtotal * newDiscount) / 100;
                                                    const newTotal = editModal.subtotal - newDiscountAmount;
                                                    setEditModal({
                                                        ...editModal, 
                                                        discount: newDiscount,
                                                        total: newTotal
                                                    });
                                                }}
                                                min="0" 
                                                max="100" 
                                                className="w-full border-2 border-slate-300 p-2.5 rounded-lg focus:border-blue-500 focus:outline-none font-bold" 
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <h4 className="font-bold text-sm text-slate-700 mb-3">Daftar Barang</h4>
                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                            {(editModal.items || []).map((item, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center">
                                                    <div className="flex-1">
                                                        <p className="font-bold text-sm text-slate-800">{item.name}</p>
                                                        <div className="flex gap-1 flex-wrap">
                                                            {item.category && (
                                                                <span className="text-[10px] text-purple-600 font-semibold">üì¶ {item.category}</span>
                                                            )}
                                                            {item.subCategory && (
                                                                <span className="text-[10px] text-blue-600 font-semibold">‚Üí {item.subCategory}</span>
                                                            )}
                                                        </div>
                                                        <p className="text-xs text-slate-500">{formatCurrency(item.sellPrice)} √ó {item.qty}</p>
                                                    </div>
                                                    <p className="font-bold text-green-600">{formatCurrency(item.sellPrice * item.qty)}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border border-blue-200">
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between">
                                                <span className="text-slate-600">Subtotal</span>
                                                <span className="font-bold text-slate-800">{formatCurrency(editModal.subtotal || 0)}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-slate-600">Diskon {editModal.discount || 0}%</span>
                                                <span className="font-bold text-orange-600">-{formatCurrency((editModal.subtotal * (editModal.discount || 0)) / 100)}</span>
                                            </div>
                                            <div className="flex justify-between border-t border-blue-200 pt-2">
                                                <span className="font-bold text-slate-800">Total</span>
                                                <span className="font-bold text-xl text-green-600">{formatCurrency(editModal.total || 0)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => setEditModal(null)} 
                                        className="flex-1 py-3 border-2 border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-all"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            try {
                                                await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'sales', editModal.id), {
                                                    customerName: editModal.customerName,
                                                    paymentMethod: editModal.paymentMethod,
                                                    discount: editModal.discount || 0,
                                                    total: editModal.total,
                                                    updatedAt: serverTimestamp()
                                                });
                                                setEditModal(null);
                                                alert('‚úÖ Data penjualan berhasil diupdate!');
                                            } catch (err) {
                                                alert('Error: ' + err.message);
                                            }
                                        }}
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all"
                                    >
                                        üíæ Simpan Perubahan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const CustomerManager = ({ setView }) => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
            const { data: sales = [] } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
            const { data: customers = [] } = useFirestoreCollection('customers', activeOwner?.id, activeStore?.id);
            const [modal, setModal] = useState(null);
            const [historyModal, setHistoryModal] = useState(null);
            const [term, setTerm] = useState('');
            const [addressFilter, setAddressFilter] = useState('');
            const [typeFilter, setTypeFilter] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            const [customerTab, setCustomerTab] = useState('service');
            const [hiddenCustomers, setHiddenCustomers] = useState([]);
            const [deleteConfirmModal, setDeleteConfirmModal] = useState(null);
            const [deleteAllModal, setDeleteAllModal] = useState(false);
            
            // Cache phone numbers agar tidak pernah hilang setelah ditemukan
            const phoneCacheRef = useRef({});
            const addressCacheRef = useRef({});
            
            const createServiceFromCustomer = (customer) => {
                // Open service manager dengan data pelanggan ter-fill
                const serviceData = {
                    customerName: customer.name,
                    phone: customer.phone,
                    address: customer.address || '',
                    unitType: '',
                    imei: '',
                    complaint: '',
                    serviceFee: 0,
                    dp: 0,
                    status: 'Diterima',
                    warranty: ''
                };
                
                // Store ke session untuk di-pass ke ServiceManager
                sessionStorage.setItem('newServiceData', JSON.stringify(serviceData));
                setView('service');
            };

            const syncFromServices = async () => {
                if (!activeStore || !activeStore.id) {
                    alert('‚ö†Ô∏è Pilih cabang terlebih dahulu!\n\nFitur sinkronisasi pelanggan hanya bisa dilakukan per cabang, tidak bisa di mode "Semua Toko".');
                    return;
                }

                const existingEmails = new Set(customers.map(c => c.phone));
                const newCustomers = services
                .filter(s => (s.customerPhone || s.phone) && !existingEmails.has(s.customerPhone || s.phone))
                    .map(s => ({
                        name: s.customerName,
                        phone: s.customerPhone || s.phone,
                        address: s.address || '',
                        createdAt: serverTimestamp(),
                        ownerId: activeOwner.id,
                        storeId: activeStore.id
                    }))
                    .slice(0, 10);

                if (newCustomers.length === 0) {
                    alert('Tidak ada pelanggan baru untuk disinkronkan.');
                    return;
                }

                try {
                    const batch = writeBatch(db);
                    newCustomers.forEach(cust => {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers')), cust);
                    });
                    await batch.commit();
                    alert(`‚úÖ ${newCustomers.length} pelanggan baru berhasil disinkronkan dari data servis.`);
                } catch (err) {
                    alert("Gagal sinkronisasi: " + err.message);
                }
            };

            const handleSaveCustomer = async (data) => {
                try {
                    if (modal.id && modal.dbRecord !== false) {
                        // Pelanggan dari DB (Firestore) ‚Üí update
                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', modal.id), data);
                        setModal(null);
                        alert('Pelanggan diperbarui');
                    } else {
                        // Pelanggan baru ATAU berasal dari transaksi (non-DB, id=svc_/sale_)
                        // ‚Üí buat record baru di customers collection
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers'), {
                            ...data,
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            createdAt: serverTimestamp()
                        });
                        setModal(null);
                        alert('Pelanggan ditambahkan');
                    }
                } catch (err) {
                    alert("Gagal simpan: " + err.message);
                }
            };

            const confirmDeleteCustomer = (customer) => {
                console.log('Delete customer clicked:', customer);
                setDeleteConfirmModal(customer);
            };

            const executeDeleteCustomer = async () => {
                const customer = deleteConfirmModal;
                console.log('Execute delete:', customer);
                if (!customer) return;
                try {
                    if (customer.dbRecord) {
                        // Customer ada di database ‚Üí tandai deleted (jangan delete, karena mungkin ada referensi)
                        await pb.collection(getTenantCollection('customers', activeOwner.id)).update(customer.id, {
                            deleted: true,
                            deletedAt: new Date().toISOString()
                        });
                    } else {
                        // Customer dari transaksi ‚Üí buat record baru di DB dengan flag deleted
                        const customerId = customer.id.replace('service_', '').replace('sale_', '');
                        const generatePBId = () => {
                            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
                            let result = '';
                            for (let i = 0; i < 15; i++) {
                                result += chars.charAt(Math.floor(Math.random() * chars.length));
                            }
                            return result;
                        };
                        await pb.collection(getTenantCollection('customers', activeOwner.id)).create({
                            id: generatePBId(),
                            name: customer.name || '',
                            phone: customer.phone || '',
                            address: customer.address || '',
                            customerType: customer.phoneType || 'regular',
                            deleted: true,
                            deletedAt: new Date().toISOString(),
                            ownerId: activeOwner?.id || '',
                            storeId: activeStore?.id || '',
                            createdAt: customer.createdAt || new Date().toISOString()
                        });
                    }
                    alert('‚úÖ Pelanggan berhasil dihapus!');
                    setDeleteConfirmModal(null);
                } catch (err) {
                    console.error('Error deleting customer:', err);
                    alert("Gagal hapus: " + err.message);
                }
            };

            const executeDeleteAllCustomers = async () => {
                console.log('üóëÔ∏è Delete all customers - Starting');
                
                // Ambil semua customer yang aktif (baik dari database maupun transaksi)
                const currentTab = customerTab === 'service' ? mergedServiceCustomers : mergedSalesCustomers;
                const allActiveCustomers = currentTab.filter(c => !c.deleted);
                
                console.log('üìä Total customers in view:', currentTab.length);
                console.log('üìä Active customers to remove:', allActiveCustomers.length);
                
                if (allActiveCustomers.length === 0) {
                    alert('‚ö†Ô∏è Tidak ada pelanggan untuk dihapus.');
                    setDeleteAllModal(false);
                    return;
                }
                
                setDeleteAllModal(false);
                
                try {
                    let totalCount = 0;
                    const generatePBId = () => {
                        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
                        let result = '';
                        for (let i = 0; i < 15; i++) {
                            result += chars.charAt(Math.floor(Math.random() * chars.length));
                        }
                        return result;
                    };
                    
                    for (const customer of allActiveCustomers) {
                        try {
                            if (customer.dbRecord) {
                                // Customer ada di database ‚Üí tandai deleted (bukan delete fisik)
                                await pb.collection(getTenantCollection('customers', activeOwner.id)).update(customer.id, {
                                    deleted: true,
                                    deletedAt: new Date().toISOString()
                                });
                            } else {
                                // Customer dari transaksi ‚Üí buat record baru dengan flag deleted
                                const customerId = customer.id.replace('service_', '').replace('sale_', '');
                                await pb.collection(getTenantCollection('customers', activeOwner.id)).create({
                                    id: generatePBId(),
                                    name: customer.name || '',
                                    phone: customer.phone || '',
                                    address: customer.address || '',
                                    customerType: customer.phoneType || 'regular',
                                    deleted: true,
                                    deletedAt: new Date().toISOString(),
                                    ownerId: activeOwner?.id || '',
                                    storeId: activeStore?.id || '',
                                    createdAt: customer.createdAt || new Date().toISOString()
                                });
                            }
                            totalCount++;
                            if (totalCount % 10 === 0) {
                                console.log(`‚úÖ Processed: ${totalCount}/${allActiveCustomers.length}`);
                            }
                        } catch (err) {
                            console.error(`‚ùå Failed to delete customer ${customer.name}:`, err);
                        }
                    }
                    
                    // Clear cache
                    phoneCacheRef.current = {};
                    addressCacheRef.current = {};
                    
                    alert(`‚úÖ Berhasil menghapus ${totalCount} pelanggan!`);
                } catch (err) {
                    console.error('‚ùå Error deleting all customers:', err);
                    alert('‚ùå Gagal hapus semua pelanggan: ' + err.message);
                }
            };

            // Derive unique service customers from services data
            const serviceCustomers = useMemo(() => {
                if (!services || services.length === 0) return [];
                const customerMap = new Map();
                services.forEach(s => {
                    const key = (s.customerPhone || s.phone || s.customerName || '').toLowerCase();
                    if (!key) return;
                    if (!customerMap.has(key)) {
                        customerMap.set(key, {
                            id: 'svc_' + key,
                            name: s.customerName || '',
                            phone: s.customerPhone || s.phone || '',
                            address: s.address || '',
                            phoneType: s.deviceModel || s.unitType || s.deviceType || '',
                            createdAt: s.createdAt,
                            source: 'service',
                            serviceCount: 1
                        });
                    } else {
                        customerMap.get(key).serviceCount += 1;
                    }
                });
                return Array.from(customerMap.values());
            }, [services]);

            // Derive unique sales customers from sales data
            const salesCustomers = useMemo(() => {
                if (!sales || sales.length === 0) return [];
                const customerMap = new Map();
                sales.filter(s => s.type === 'sale' || s.type === 'service_sale').forEach(s => {
                    const key = (s.customerName || '').toLowerCase();
                    if (!key) return;
                    if (!customerMap.has(key)) {
                        customerMap.set(key, {
                            id: 'sale_' + key,
                            name: s.customerName || '',
                            phone: '',
                            address: '',
                            phoneType: '',
                            createdAt: s.createdAt,
                            source: 'sales',
                            salesCount: 1,
                            totalSpent: parseFloat(s.total) || 0
                        });
                    } else {
                        const existing = customerMap.get(key);
                        existing.salesCount += 1;
                        existing.totalSpent += parseFloat(s.total) || 0;
                    }
                });
                return Array.from(customerMap.values());
            }, [sales]);

            // Merge: Mulai dari database customers sebagai basis, lalu tambahkan info dari service/sales
            const mergedServiceCustomers = useMemo(() => {
                const result = new Map();
                customers.forEach(c => {
                    result.set(c.id, {
                        id: c.id,
                        name: c.name || '',
                        phone: c.phone || '',
                        address: c.address || '',
                        phoneType: c.phoneType || '',
                        createdAt: c.createdAt,
                        source: 'database',
                        serviceCount: 0,
                        dbRecord: true,
                        deleted: c.deleted || false
                    });
                });
                
                serviceCustomers.forEach(sc => {
                    const scPhone = (sc.phone || '').trim();
                    const scName = (sc.name || '').trim().toLowerCase();
                    
                    // Pertama, cek apakah ada DB record (termasuk yang deleted) yang cocok
                    const matchedEntry = [...result.values()].find(dbC => {
                        const dbPhone = (dbC.phone || '').trim();
                        const dbName = (dbC.name || '').trim().toLowerCase();
                        if (scPhone && dbPhone && scPhone === dbPhone) return true;
                        if (scName && dbName && scName === dbName) return true;
                        if (scPhone && dbPhone && (scPhone.includes(dbPhone) || dbPhone.includes(scPhone))) return true;
                        return false;
                    });
                    
                    if (matchedEntry) {
                        // Jika matched record sudah deleted, SKIP - jangan tambahkan data apapun
                        if (matchedEntry.deleted) return;
                        
                        matchedEntry.serviceCount = (matchedEntry.serviceCount || 0) + (sc.serviceCount || 1);
                        matchedEntry.phoneType = matchedEntry.phoneType || sc.phoneType || '';
                        matchedEntry.address = matchedEntry.address || sc.address || '';
                        if (!matchedEntry.phone && sc.phone) matchedEntry.phone = sc.phone;
                    } else {
                        // Tidak ada match sama sekali ‚Üí tambahkan sebagai customer baru dari transaksi
                        result.set(sc.id, { ...sc, dbRecord: false, deleted: false });
                    }
                });
                
                // Backfill phone dari raw services data
                if (services && services.length > 0) {
                    [...result.values()].forEach(entry => {
                        if (!entry.phone && entry.name) {
                            const svc = services.find(s => 
                                (s.customerPhone || s.phone) && s.customerName && 
                                s.customerName.trim().toLowerCase() === entry.name.trim().toLowerCase()
                            );
                            if (svc) entry.phone = svc.customerPhone || svc.phone;
                        }
                    });
                }
                
                // 4. Restore dari cache: jika phone pernah ditemukan sebelumnya, jangan pernah hilangkan
                const items = Array.from(result.values());
                items.forEach(entry => {
                    const cacheKey = (entry.name || '').trim().toLowerCase();
                    if (!cacheKey) return;
                    
                    // Simpan phone & address ke cache jika ada
                    if (entry.phone) phoneCacheRef.current[cacheKey] = entry.phone;
                    if (entry.address) addressCacheRef.current[cacheKey] = entry.address;
                    
                    // Restore dari cache jika saat ini kosong
                    if (!entry.phone && phoneCacheRef.current[cacheKey]) {
                        entry.phone = phoneCacheRef.current[cacheKey];
                    }
                    if (!entry.address && addressCacheRef.current[cacheKey]) {
                        entry.address = addressCacheRef.current[cacheKey];
                    }
                });
                
                // üîπ Filter: Hanya tampilkan pelanggan yang punya transaksi service
                return items.filter(c => c.serviceCount > 0);
            }, [serviceCustomers, customers, services]);

            const mergedSalesCustomers = useMemo(() => {
                const result = new Map();
                customers.forEach(c => {
                    result.set(c.id, {
                        id: c.id,
                        name: c.name || '',
                        phone: c.phone || '',
                        address: c.address || '',
                        phoneType: c.phoneType || '',
                        createdAt: c.createdAt,
                        source: 'database',
                        salesCount: 0,
                        totalSpent: 0,
                        dbRecord: true,
                        deleted: c.deleted || false
                    });
                });
                
                salesCustomers.forEach(sc => {
                    const scName = (sc.name || '').trim().toLowerCase();
                    
                    // Cek match dengan semua DB records (termasuk yang deleted)
                    const matchedEntry = [...result.values()].find(dbC => {
                        const dbName = (dbC.name || '').trim().toLowerCase();
                        if (scName && dbName && scName === dbName) return true;
                        return false;
                    });
                    
                    if (matchedEntry) {
                        // Jika matched record sudah deleted, SKIP
                        if (matchedEntry.deleted) return;
                        
                        matchedEntry.salesCount = (matchedEntry.salesCount || 0) + (sc.salesCount || 1);
                        matchedEntry.totalSpent = (matchedEntry.totalSpent || 0) + (sc.totalSpent || 0);
                        if (!matchedEntry.phone && sc.phone) matchedEntry.phone = sc.phone;
                        if (!matchedEntry.address && sc.address) matchedEntry.address = sc.address;
                    } else {
                        // Tidak ada match ‚Üí tambahkan sebagai customer baru dari transaksi
                        result.set(sc.id, { ...sc, dbRecord: false, deleted: false });
                    }
                });
                
                // Backfill phone dari raw services data
                if (services && services.length > 0) {
                    [...result.values()].forEach(entry => {
                        if (!entry.phone && entry.name) {
                            const svc = services.find(s => 
                                (s.customerPhone || s.phone) && s.customerName && 
                                s.customerName.trim().toLowerCase() === entry.name.trim().toLowerCase()
                            );
                            if (svc) entry.phone = svc.customerPhone || svc.phone;
                        }
                    });
                }
                
                // 4. Restore dari cache
                const items = Array.from(result.values());
                items.forEach(entry => {
                    const cacheKey = (entry.name || '').trim().toLowerCase();
                    if (!cacheKey) return;
                    
                    if (entry.phone) phoneCacheRef.current[cacheKey] = entry.phone;
                    if (entry.address) addressCacheRef.current[cacheKey] = entry.address;
                    
                    if (!entry.phone && phoneCacheRef.current[cacheKey]) {
                        entry.phone = phoneCacheRef.current[cacheKey];
                    }
                    if (!entry.address && addressCacheRef.current[cacheKey]) {
                        entry.address = addressCacheRef.current[cacheKey];
                    }
                });
                
                // üîπ Filter: Hanya tampilkan pelanggan yang punya transaksi penjualan
                return items.filter(c => c.salesCount > 0);
            }, [salesCustomers, customers, services]);

            // Select active customer list based on tab
            const activeCustomerList = customerTab === 'service' ? mergedServiceCustomers : mergedSalesCustomers;

            // Extract unique addresses and phone types for filters (normalize addresses)
            const uniqueAddresses = [...new Set(
                activeCustomerList
                    .map(c => c.address?.trim())
                    .filter(Boolean)
            )].sort();
            const uniqueTypes = [...new Set(activeCustomerList.map(c => c.phoneType).filter(Boolean))].sort();

            const filteredCustomers = activeCustomerList.length > 0 ? activeCustomerList.filter(c => {
                if (c.deleted) return false;
                if (hiddenCustomers.includes(c.id)) return false;
                const matchName = (c.name?.toLowerCase().includes(term.toLowerCase()) || false) || (c.phone?.includes(term) || false);
                const matchAddress = !addressFilter || c.address?.trim() === addressFilter;
                const matchType = !typeFilter || c.phoneType === typeFilter;
                return matchName && matchAddress && matchType;
            }) : [];

            // Count visible (non-deleted, non-hidden) customers for tab badges
            const visibleServiceCount = mergedServiceCustomers.filter(c => !c.deleted && !hiddenCustomers.includes(c.id)).length;
            const visibleSalesCount = mergedSalesCustomers.filter(c => !c.deleted && !hiddenCustomers.includes(c.id)).length;
            
            // Pagination logic
            const totalItems = filteredCustomers.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedCustomers = filteredCustomers.slice(startIndex, endIndex);
            
            // Reset to page 1 when filter or tab changes
            useEffect(() => {
                setCurrentPage(1);
            }, [term, addressFilter, typeFilter, customerTab]);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    setCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const handleItemsPerPageChange = (value) => {
                setItemsPerPage(value);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center gap-4">
                        <h2 className="font-bold text-2xl">Daftar Pelanggan</h2>
                        <div className="flex gap-2">
                            <button onClick={syncFromServices} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700 flex items-center gap-2"><RefreshCw className="w-4 h-4" /> Sinkronisasi</button>
                            <button onClick={() => setDeleteAllModal(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-700 flex items-center gap-2"><Trash2 className="w-4 h-4" /> Hapus Semua</button>
                            <button onClick={() => setModal({})} className="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:bg-blue-700"><Plus className="w-5 h-5" /> Pelanggan Baru</button>
                        </div>
                    </div>

                    {/* Tab Service & Penjualan */}
                    <div className="flex gap-2 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                        <button
                            onClick={() => { setCustomerTab('service'); setTerm(''); setAddressFilter(''); setTypeFilter(''); }}
                            className={`flex-1 py-3 px-4 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2 ${customerTab === 'service' ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}
                        >
                            üì± Pelanggan Service
                            <span className={`px-2 py-0.5 rounded-full text-xs ${customerTab === 'service' ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-600'}`}>{visibleServiceCount}</span>
                        </button>
                        <button
                            onClick={() => { setCustomerTab('sales'); setTerm(''); setAddressFilter(''); setTypeFilter(''); }}
                            className={`flex-1 py-3 px-4 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2 ${customerTab === 'sales' ? 'bg-green-600 text-white shadow-lg' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}
                        >
                            üõí Pelanggan Penjualan
                            <span className={`px-2 py-0.5 rounded-full text-xs ${customerTab === 'sales' ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-600'}`}>{visibleSalesCount}</span>
                        </button>
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 sticky top-0 z-10 space-y-3">
                        <div className="relative"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={term} onChange={e => setTerm(e.target.value)} placeholder="Cari nama atau nomor WA..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white" /></div>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">Filter Alamat</label>
                                <select value={addressFilter} onChange={e => setAddressFilter(e.target.value)} className="w-full border border-gray-200 p-2.5 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                                    <option value="">Semua Alamat</option>
                                    {uniqueAddresses.map(addr => (
                                        <option key={addr} value={addr}>{addr}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">Filter Type HP</label>
                                <select value={typeFilter} onChange={e => setTypeFilter(e.target.value)} className="w-full border border-gray-200 p-2.5 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                                    <option value="">Semua Type</option>
                                    {uniqueTypes.map(type => (
                                        <option key={type} value={type}>{type}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        
                        {(addressFilter || typeFilter || term) && (
                            <div className="text-xs text-slate-600 flex items-center gap-2">
                                <span>Hasil: <strong>{filteredCustomers.length}</strong> pelanggan</span>
                                {(addressFilter || typeFilter || term) && (
                                    <button onClick={() => {setTerm(''); setAddressFilter(''); setTypeFilter('');}} className="text-blue-600 hover:underline text-xs">Bersihkan Filter</button>
                                )}
                            </div>
                        )}
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mobile-card-wrapper">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b text-slate-600 font-bold uppercase text-xs">
                                    <tr>
                                        <th className="p-4">Nama & Alamat</th>
                                        <th className="p-4">No WA</th>
                                        <th className="p-4">{customerTab === 'service' ? 'Type HP' : 'Jml Transaksi'}</th>
                                        <th className="p-4">{customerTab === 'service' ? 'Jml Service' : 'Total Belanja'}</th>
                                        <th className="p-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {paginatedCustomers.map(c => (
                                        <tr key={c.id} className="hover:bg-slate-50">
                                            <td className="p-4">
                                                <div className="flex flex-col">
                                                    <button 
                                                        onClick={() => createServiceFromCustomer(c)}
                                                        className="font-bold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer transition text-left"
                                                        title="Klik untuk buat service baru"
                                                    >
                                                        {c.name}
                                                    </button>
                                                    {c.address && (
                                                        <span className="text-xs text-slate-500 mt-1">
                                                            üìç {c.address}
                                                        </span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="p-4 text-slate-600">
                                <div className="flex items-center gap-1">
                                    {c.phone ? (
                                        <>
                                            <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                                            </svg>
                                            {c.phone}
                                        </>
                                    ) : (
                                        '-'
                                    )}
                                </div>
                            </td>
                                            <td className="p-4 text-slate-500 text-xs">
                                                {customerTab === 'service' 
                                                    ? (c.phoneType || '-')
                                                    : <span className="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">{c.salesCount || 0}x</span>
                                                }
                                            </td>
                                            <td className="p-4 text-slate-500 text-xs">
                                                {customerTab === 'service'
                                                    ? <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold">{c.serviceCount || 0}x</span>
                                                    : <span className="font-bold text-green-600">{formatCurrency(c.totalSpent || 0)}</span>
                                                }
                                            </td>
                                            <td className="p-4 text-center flex justify-center gap-2">
                                                <button onClick={() => setHistoryModal(c)} className="text-purple-500 hover:bg-purple-50 p-2 rounded" title={customerTab === 'service' ? 'Lihat riwayat service' : 'Lihat riwayat pembelian'}><History className="w-4 h-4" /></button>
                                                <button onClick={() => setModal(c)} className="text-blue-500 hover:bg-blue-50 p-2 rounded" title="Edit pelanggan"><Pencil className="w-4 h-4" /></button>
                                                <button onClick={(e) => { e.stopPropagation(); confirmDeleteCustomer(c); }} className="text-red-500 hover:bg-red-50 p-2 rounded" title="Hapus pelanggan"><Trash2 className="w-4 h-4" /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {paginatedCustomers.length === 0 && <div className="p-8 text-center text-slate-400">{customerTab === 'service' ? 'Tidak ada pelanggan service.' : 'Tidak ada pelanggan penjualan.'}</div>}
                        </div>
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {paginatedCustomers.map(c => (
                                <div key={c.id} className="mobile-card">
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Nama</span>
                                        <span className="mobile-card-value">
                                            <button onClick={() => createServiceFromCustomer(c)} className="font-bold text-blue-600 hover:text-blue-800 hover:underline text-sm">
                                                {c.name}
                                            </button>
                                        </span>
                                    </div>
                                    {c.address && (
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Alamat</span>
                                            <span className="mobile-card-value text-xs">üìç {c.address}</span>
                                        </div>
                                    )}
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">WhatsApp</span>
                                        <span className="mobile-card-value text-xs flex items-center gap-1">
                                            {c.phone ? (
                                                <>
                                                    <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                                                    </svg>
                                                    {c.phone}
                                                </>
                                            ) : '-'}
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">{customerTab === 'service' ? 'Type HP' : 'Transaksi'}</span>
                                        <span className="mobile-card-value">
                                            {customerTab === 'service' 
                                                ? (c.phoneType || '-')
                                                : <span className="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">{c.salesCount || 0}x</span>
                                            }
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">{customerTab === 'service' ? 'Service' : 'Total Belanja'}</span>
                                        <span className="mobile-card-value">
                                            {customerTab === 'service'
                                                ? <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold">{c.serviceCount || 0}x</span>
                                                : <span className="font-bold text-green-600 text-sm">{formatCurrency(c.totalSpent || 0)}</span>
                                            }
                                        </span>
                                    </div>
                                    <div className="mobile-card-actions">
                                        <button onClick={() => setHistoryModal(c)} className="flex-1 bg-purple-50 text-purple-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                            <History className="w-3 h-3"/> Riwayat
                                        </button>
                                        <button onClick={() => setModal(c)} className="flex-1 bg-blue-50 text-blue-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                            <Pencil className="w-3 h-3"/> Edit
                                        </button>
                                        <button onClick={(e) => { e.stopPropagation(); confirmDeleteCustomer(c); }} className="bg-red-50 text-red-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                            <Trash2 className="w-3 h-3"/> Hapus
                                        </button>
                                    </div>
                                </div>
                            ))}
                            {paginatedCustomers.length === 0 && <div className="p-8 text-center text-slate-400">{customerTab === 'service' ? 'Tidak ada pelanggan service.' : 'Tidak ada pelanggan penjualan.'}</div>}
                        </div>
                    </div>
                    
                    {/* Pagination Controls */}
                    <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                            <div className="flex gap-2">
                                <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                            </div>
                        </div>
                        <div className="text-sm text-slate-600 font-medium">
                            Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                        </div>
                    </div>
                    
                    {/* Pagination Navigation */}
                    {totalPages > 1 && (
                        <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <button 
                                onClick={() => handlePageChange(currentPage - 1)} 
                                disabled={currentPage === 1}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                ‚Üê Sebelumnya
                            </button>
                            <div className="text-sm text-slate-600 font-medium">
                                Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                            </div>
                            <button 
                                onClick={() => handlePageChange(currentPage + 1)} 
                                disabled={currentPage === totalPages}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                Selanjutnya ‚Üí
                            </button>
                        </div>
                    )}

                    {modal !== null && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-6 border-b pb-4">
                                    <h3 className="font-bold text-xl text-slate-800">{modal.id ? 'Edit Pelanggan' : 'Pelanggan Baru'}</h3>
                                    <button onClick={() => setModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                                </div>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const formData = new FormData(e.target);
                                    handleSaveCustomer({
                                        name: formData.get('name'),
                                        phone: formData.get('phone'),
                                        address: formData.get('address'),
                                        phoneType: formData.get('phoneType'),
                                        customerType: formData.get('customerType')
                                    });
                                }} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Pelanggan</label>
                                        <input name="name" defaultValue={modal.name || ''} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">No WhatsApp</label>
                                        <input name="phone" defaultValue={modal.phone || ''} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Type HP</label>
                                        <input name="phoneType" defaultValue={modal.phoneType || ''} placeholder="Contoh: iPhone 12, Samsung A50, dll" className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Alamat</label>
                                        <textarea name="address" defaultValue={modal.address || ''} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500 resize-none" rows="3"></textarea>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Tipe Pelanggan</label>
                                        <select name="customerType" defaultValue={modal.customerType || 'sales'} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500">
                                            <option value="sales">üõí Pelanggan Penjualan</option>
                                            <option value="service">üì± Pelanggan Service</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-xl font-bold">Batal</button>
                                        <button className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {historyModal !== null && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6 border-b pb-4 sticky top-0 bg-white">
                                    <h3 className="font-bold text-xl text-slate-800">{customerTab === 'service' ? 'Riwayat Service' : 'Riwayat Pembelian'}: {historyModal.name}</h3>
                                    <button onClick={() => setHistoryModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                                </div>
                                
                                {customerTab === 'service' ? (
                                <div className="space-y-3">
                                    {services?.filter(s => s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <History className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                            <p>Belum ada riwayat service</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {services?.filter(s => s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(svc => (
                                                <div key={svc.id} className="border rounded-lg p-4 hover:bg-slate-50 transition">
                                                    <div className="flex justify-between items-start gap-4">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-3 mb-2">
                                                                <span className="font-bold text-slate-800">{svc.unitType || 'Service'}</span>
                                                                <span className={`text-xs font-bold px-2 py-1 rounded-full ${
                                                                    svc.status === 'Selesai' ? 'bg-green-100 text-green-700' :
                                                                    svc.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                                    svc.status === 'Diambil' ? 'bg-purple-100 text-purple-700' :
                                                                    svc.status === 'Dibatalkan' ? 'bg-red-100 text-red-700' :
                                                                    'bg-yellow-100 text-yellow-700'
                                                                }`}>{svc.status || 'Antri'}</span>
                                                            </div>
                                                            <p className="text-sm text-slate-600 mb-1">üîß {svc.complaint || 'Tidak ada keluhan'}</p>
                                                            <p className="text-xs text-slate-500">üì± IMEI: {svc.imei || '-'}</p>
                                                            <p className="text-xs text-slate-500">üìÖ {formatDate(svc.createdAt)}</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm font-bold text-slate-800 mb-1">Jasa: {formatCurrency(parseFloat(svc.serviceFee) || 0)}</div>
                                                            <div className={`text-xs font-bold px-2 py-1 rounded ${
                                                                svc.paymentStatus === 'Lunas' ? 'bg-green-100 text-green-700' :
                                                                svc.paymentStatus === 'DP' ? 'bg-orange-100 text-orange-700' :
                                                                'bg-red-100 text-red-700'
                                                            }`}>{svc.paymentStatus || 'Belum Bayar'}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                ) : (
                                <div className="space-y-3">
                                    {sales?.filter(s => (s.type === 'sale' || s.type === 'service_sale') && s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <History className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                            <p>Belum ada riwayat pembelian</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {sales?.filter(s => (s.type === 'sale' || s.type === 'service_sale') && s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(sale => (
                                                <div key={sale.id} className="border rounded-lg p-4 hover:bg-slate-50 transition">
                                                    <div className="flex justify-between items-start gap-4">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-3 mb-2">
                                                                <span className="font-bold text-slate-800">üõí Penjualan</span>
                                                                <span className={`text-xs font-bold px-2 py-1 rounded-full ${sale.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : sale.paymentMethod === 'credit' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                                                                    {sale.paymentMethod === 'cash' ? 'Tunai' : sale.paymentMethod === 'credit' ? 'Kredit' : 'Transfer'}
                                                                </span>
                                                            </div>
                                                            <div className="text-xs text-slate-600 space-y-1">
                                                                {sale.items?.map((item, idx) => (
                                                                    <p key={idx}>üì¶ {item.name} x{item.qty} @ {formatCurrency(item.sellPrice)}</p>
                                                                ))}
                                                            </div>
                                                            <p className="text-xs text-slate-500 mt-1">üìÖ {formatDate(sale.createdAt)}</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm font-bold text-green-600">{formatCurrency(parseFloat(sale.total) || 0)}</div>
                                                            {sale.discount > 0 && <div className="text-xs text-orange-500">Diskon {sale.discount}%</div>}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation Modal */}
                    {deleteConfirmModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[80]">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                                <div className="flex flex-col items-center text-center">
                                    <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                                        <Trash2 className="w-8 h-8 text-red-500" />
                                    </div>
                                    <h3 className="font-bold text-lg text-slate-800 mb-2">Hapus Pelanggan?</h3>
                                    <p className="text-slate-500 text-sm mb-1">Apakah Anda yakin ingin menghapus pelanggan:</p>
                                    <p className="font-bold text-red-600 text-lg mb-1">{deleteConfirmModal.name}</p>
                                    {deleteConfirmModal.phone && <p className="text-slate-400 text-xs mb-4">{deleteConfirmModal.phone}</p>}
                                    <p className="text-xs text-slate-400 mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-2">Data pelanggan akan dihapus dari daftar. Riwayat transaksi tetap tersimpan.</p>
                                    <div className="flex gap-3 w-full">
                                        <button onClick={() => setDeleteConfirmModal(null)} className="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-colors">Batal</button>
                                        <button onClick={executeDeleteCustomer} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors flex items-center justify-center gap-2"><Trash2 className="w-4 h-4" /> Hapus</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete All Confirmation Modal */}
                    {deleteAllModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[90]">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex flex-col items-center text-center">
                                    <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-4 animate-pulse">
                                        <Trash2 className="w-10 h-10 text-red-600" />
                                    </div>
                                    <h3 className="font-bold text-xl text-slate-800 mb-2">‚ö†Ô∏è Hapus Semua Pelanggan?</h3>
                                    <p className="text-slate-600 text-sm mb-3">Anda akan menghapus <strong className="text-red-600">{(customerTab === 'service' ? mergedServiceCustomers : mergedSalesCustomers).filter(c => !c.deleted).length} pelanggan</strong> dari tampilan!</p>
                                    <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-3 mb-3 w-full">
                                        <p className="text-xs text-blue-700">
                                            <strong>Tab aktif:</strong> {customerTab === 'service' ? 'üì± Pelanggan Service' : 'üõí Pelanggan Penjualan'}
                                        </p>
                                    </div>
                                    <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-6 w-full">
                                        <p className="text-red-700 font-bold text-sm mb-2">‚ö†Ô∏è PERINGATAN PENTING:</p>
                                        <ul className="text-left text-xs text-red-600 space-y-1">
                                            <li>‚Ä¢ Pelanggan di database akan dihapus permanen</li>
                                            <li>‚Ä¢ Pelanggan dari transaksi akan disembunyikan</li>
                                            <li>‚Ä¢ Riwayat transaksi tetap tersimpan</li>
                                            <li>‚Ä¢ Aksi ini tidak dapat dibatalkan</li>
                                        </ul>
                                    </div>
                                    <div className="flex gap-3 w-full">
                                        <button onClick={() => setDeleteAllModal(false)} className="flex-1 py-3 border-2 border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50 transition-colors">
                                            Batal
                                        </button>
                                        <button onClick={executeDeleteAllCustomers} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors flex items-center justify-center gap-2 shadow-lg">
                                            <Trash2 className="w-4 h-4" /> Ya, Hapus Semua
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const StockManager = () => {
          const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
          const { data: inv } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
          const [tab, setTab] = useState('barang');
          const [form, setForm] = useState({name:'', category: '', subCategory: '', brand: '', supplier: '', stock:0, buyPrice:0, sellPrice:0, minStock: ''});
          const [adjustModal, setAdjustModal] = useState(null);
          const [adjustAmount, setAdjustAmount] = useState(0);
          const [adjustType, setAdjustType] = useState('add');
          const [newMinStock, setNewMinStock] = useState('');
          const [editModal, setEditModal] = useState(null);
          const [categoryModal, setCategoryModal] = useState(null);
          const [categoryFilter, setCategoryFilter] = useState('');
          const [selectedSubCategory, setSelectedSubCategory] = useState('');
          const [searchTerm, setSearchTerm] = useState('');
          const [currentPage, setCurrentPage] = useState(1);
          const [itemsPerPage, setItemsPerPage] = useState(10);
          const [customCategories, setCustomCategories] = useState([]);
          const [subCategories, setSubCategories] = useState({});
          const [brands, setBrands] = useState([]);
          const [suppliers, setSuppliers] = useState([]);
          const [inventorySettings, setInventorySettings] = useState({});
          const [settingsModal, setSettingsModal] = useState(false);
          const [tempSettings, setTempSettings] = useState({});
          
          // State untuk Stock Opname
          const [opnameActive, setOpnameActive] = useState(false);
          const [opnameData, setOpnameData] = useState({});
          const [saving, setSaving] = useState(false);
          
          // Filter states untuk tab Opname, Adjustment, Alerts
          const [opnameCategoryFilter, setOpnameCategoryFilter] = useState('');
          const [opnameSubCategoryFilter, setOpnameSubCategoryFilter] = useState('');
          const [opnameSearch, setOpnameSearch] = useState('');
          const [adjustCategoryFilter, setAdjustCategoryFilter] = useState('');
          const [adjustSubCategoryFilter, setAdjustSubCategoryFilter] = useState('');
          const [adjustSearch, setAdjustSearch] = useState('');
          const [alertCategoryFilter, setAlertCategoryFilter] = useState('');
          const [alertSubCategoryFilter, setAlertSubCategoryFilter] = useState('');
          
          // Load custom categories and suppliers from Firestore real-time
          useEffect(() => {
              if (!activeOwner?.id) return;
              let q;
              if (activeStore?.id) {
                  q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                      where('ownerId', '==', activeOwner.id), 
                      where('storeId', '==', activeStore.id));
              } else {
                  q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                      where('ownerId', '==', activeOwner.id));
              }
              const unsubsc1 = onSnapshot(q, (snapshot) => {
                  const allCats = new Set();
                  const allSubCats = {};
                  let settings = {};
                  snapshot.docs.forEach(doc => {
                      const data = doc.data();
                      if (data.customCategories && Array.isArray(data.customCategories)) {
                          data.customCategories.forEach(cat => allCats.add(cat));
                      }
                      if (data.subCategories && typeof data.subCategories === 'object') {
                          Object.assign(allSubCats, data.subCategories);
                      }
                      if (data.inventorySettings) {
                          settings = data.inventorySettings;
                      }
                  });
                  setCustomCategories(Array.from(allCats));
                  setSubCategories(allSubCats);
                  setInventorySettings(settings);
                  setTempSettings(settings);
              });
              const suppQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers'), 
                  where('ownerId', '==', activeOwner.id));
              const unsubsc2 = onSnapshot(suppQ, (snapshot) => {
                  setSuppliers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
              });
              const brandsQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'brands'), 
                  where('ownerId', '==', activeOwner.id));
              const unsubsc3 = onSnapshot(brandsQ, (snapshot) => {
                  setBrands(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
              });
              return () => { unsubsc1(); unsubsc2(); unsubsc3(); };
          }, [activeOwner?.id, activeStore?.id]);
          
          // Save stock settings
          const saveStockSettings = async () => {
              try {
                  let configRef;
                  const configsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs');
                  
                  if (activeStore?.id && activeStore.id !== 'all') {
                      const q = query(configsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                      const snapshot = await getDocs(q);
                      
                      if (!snapshot.empty) {
                          configRef = snapshot.docs[0].ref;
                      } else {
                          configRef = doc(configsRef);
                      }
                  } else {
                      const q = query(configsRef, where('ownerId', '==', activeOwner.id));
                      const snapshot = await getDocs(q);
                      
                      if (!snapshot.empty) {
                          configRef = snapshot.docs[0].ref;
                      } else {
                          configRef = doc(configsRef);
                      }
                  }
                  
                  await setDoc(configRef, {
                      ownerId: activeOwner.id,
                      storeId: activeStore?.id || 'all',
                      inventorySettings: {
                          ...inventorySettings,
                          ...tempSettings
                      }
                  }, { merge: true });
                  
                  setInventorySettings(prev => ({ ...prev, ...tempSettings }));
                  setSettingsModal(false);
                  alert('‚úÖ Pengaturan stok berhasil disimpan!');
              } catch (error) {
                  console.error('Error saving stock settings:', error);
                  alert('‚ùå Gagal menyimpan pengaturan: ' + error.message);
              }
          };
          
          // Get unique categories and brands from inventory
          const categories = [...new Set(inv.map(i => i.category).filter(c => c))];
          const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
          const allCategories = [...new Set([...categories, ...defaultCategories, ...customCategories])];
          
          // Search and filter
          const filteredInv = (categoryFilter ? inv.filter(i => i.category === categoryFilter) : inv)
              .filter(i => !selectedSubCategory || i.subCategory === selectedSubCategory)
              .filter(i => !searchTerm || i.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                  (i.brand && i.brand.toLowerCase().includes(searchTerm.toLowerCase())) ||
                  (i.supplier && i.supplier.toLowerCase().includes(searchTerm.toLowerCase())));
          
          const add = async (e) => { 
              e.preventDefault(); 
              try {
                  await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory'), {
                      ...form,
                      ownerId: activeOwner.id,
                      storeId: activeStore.id,
                      createdAt: serverTimestamp()
                  });
                  setForm({name:'', category: '', stock:0, buyPrice:0, sellPrice:0});
                  alert('‚úÖ Barang berhasil ditambahkan');
              } catch(err) {
                  alert("Gagal tambah stok: " + err.message);
              }
          };
          
          const canAddStock = checkPermission('feature_stock_add');
          
          // Low stock and out of stock items with per-item minStock support
          const stockThreshold = inventorySettings?.minStockThreshold ?? 0;
          const lowStockItems = inv.filter(i => {
              const actualStock = i.stock || 0;
              const minThreshold = i.minStock || stockThreshold;
              return actualStock <= minThreshold && actualStock > 0;
          });
          const outOfStockItems = inv.filter(i => (i.stock || 0) === 0);
          
          // Pagination logic
          const totalItems = filteredInv.length;
          const totalPages = Math.ceil(totalItems / itemsPerPage);
          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const paginatedInv = filteredInv.slice(startIndex, endIndex);
          
          // Calculate total assets
          const totalBuyValue = inv.reduce((sum, item) => sum + ((item.buyPrice || 0) * (item.stock || 0)), 0);
          const totalSellValue = inv.reduce((sum, item) => sum + ((item.sellPrice || 0) * (item.stock || 0)), 0);
          const potentialProfit = totalSellValue - totalBuyValue;
          
          const handlePageChange = (newPage) => {
              if (newPage >= 1 && newPage <= totalPages) {
                  setCurrentPage(newPage);
                  window.scrollTo({ top: 0, behavior: 'smooth' });
              }
          };
          
          const handleItemsPerPageChange = (value) => {
              setItemsPerPage(value);
              setCurrentPage(1);
          };

          const handleAdjust = async () => {
              try {
                  if (!adjustModal || adjustAmount === 0) {
                      alert('Masukkan jumlah penyesuaian!');
                      return;
                  }
                  const item = inv.find(i => i.id === adjustModal.id);
                  const adjustment = adjustType === 'add' ? adjustAmount : -adjustAmount;
                  const newStock = Math.max(0, (item.stock || 0) + adjustment);
                  
                  const updateData = { stock: newStock };
                  if (newMinStock && newMinStock !== '') {
                      updateData.minStock = Number(newMinStock);
                  }
                  
                  await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', adjustModal.id), updateData);
                  
                  setAdjustModal(null);
                  setAdjustAmount(0);
                  setNewMinStock('');
                  setAdjustType('add');
                  
                  const minStockText = updateData.minStock ? `, minimal stok: ${updateData.minStock}` : '';
                  alert(`‚úÖ Stok berhasil diperbarui dari ${item.stock || 0} menjadi ${newStock}${minStockText}`);
              } catch (err) {
                  alert("Gagal: " + err.message);
              }
          };
          
          // Fungsi untuk memulai Stock Opname
          const handleStartOpname = () => {
              setOpnameActive(true);
              // Initialize opname data dengan stok sistem saat ini
              const initialData = {};
              inv.forEach(item => {
                  initialData[item.id] = {
                      systemStock: item.stock || 0,
                      physicalStock: item.stock || 0, // Default sama dengan sistem
                      difference: 0
                  };
              });
              setOpnameData(initialData);
          };
          
          // Update stok fisik saat input
          const handleOpnameInput = (itemId, value) => {
              const physicalStock = parseInt(value) || 0;
              const systemStock = opnameData[itemId]?.systemStock || 0;
              setOpnameData(prev => ({
                  ...prev,
                  [itemId]: {
                      ...prev[itemId],
                      physicalStock: physicalStock,
                      difference: physicalStock - systemStock
                  }
              }));
          };
          
          // Simpan hasil opname
          const handleSaveOpname = async () => {
              if (!confirm('Yakin ingin menyimpan hasil stock opname ini? Stok sistem akan diupdate sesuai stok fisik yang diinput.')) {
                  return;
              }
              
              setSaving(true);
              try {
                  // Update stok untuk setiap item yang ada perbedaan
                  const updates = [];
                  const opnameHistory = {
                      ownerId: activeOwner.id,
                      storeId: activeStore.id,
                      items: [],
                      createdAt: serverTimestamp()
                  };
                  
                  for (const [itemId, data] of Object.entries(opnameData)) {
                      if (data.difference !== 0) {
                          const item = inv.find(i => i.id === itemId);
                          // Update stok di inventory
                          updates.push(
                              updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', itemId), {
                                  stock: data.physicalStock
                              })
                          );
                          
                          // Simpan detail untuk history
                          opnameHistory.items.push({
                              itemId: itemId,
                              itemName: item?.name || 'Unknown',
                              systemStock: data.systemStock,
                              physicalStock: data.physicalStock,
                              difference: data.difference
                          });
                      }
                  }
                  
                  // Execute all updates
                  await Promise.all(updates);
                  
                  // Simpan history opname
                  if (opnameHistory.items.length > 0) {
                      await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'stock_opname_history'), opnameHistory);
                  }
                  
                  alert(`‚úÖ Stock opname berhasil disimpan!\n\n${opnameHistory.items.length} item diupdate.`);
                  setOpnameActive(false);
                  setOpnameData({});
              } catch (err) {
                  alert('Error: ' + err.message);
              } finally {
                  setSaving(false);
              }
          };
          
          const handleCancelOpname = () => {
              if (confirm('Batalkan stock opname? Data yang sudah diinput akan hilang.')) {
                  setOpnameActive(false);
                  setOpnameData({});
              }
          };
          
          const handleEditProduct = async (e) => {
              e.preventDefault();
              try {
                  const updateData = {
                      name: editModal.name,
                      category: editModal.category,
                      subCategory: editModal.subCategory || '',
                      brand: editModal.brand || '',
                      supplier: editModal.supplier || '',
                      buyPrice: parseFloat(editModal.buyPrice) || 0,
                      sellPrice: parseFloat(editModal.sellPrice) || 0,
                      updatedAt: serverTimestamp()
                  };
                  
                  if (editModal.minStock !== undefined && editModal.minStock !== '') {
                      updateData.minStock = Number(editModal.minStock);
                  }
                  
                  await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', editModal.id), updateData);
                  setEditModal(null);
                  alert('‚úÖ Produk berhasil diupdate');
              } catch (err) {
                  alert('Gagal update: ' + err.message);
              }
          };
          
          const deleteProduct = async (id, name) => {
              if (confirm(`Hapus produk "${name}"? Tindakan ini tidak dapat dibatalkan.`)) {
                  try {
                      await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', id));
                      alert('‚úÖ Produk berhasil dihapus');
                  } catch (err) {
                      alert('Gagal hapus: ' + err.message);
                  }
              }
          };

          // Reset page when search or filter changes
          useEffect(() => {
              setCurrentPage(1);
          }, [categoryFilter, selectedSubCategory, searchTerm]);
          
          // Reset sub-category when category changes
          useEffect(() => {
              setSelectedSubCategory('');
          }, [categoryFilter]);
          
          return (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                  <h2 className="font-bold text-2xl">Manajemen Stok</h2>
                  <button onClick={() => setCategoryModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-purple-700 text-sm">
                      <Filter className="w-4 h-4" /> Kelola Kategori
                  </button>
              </div>

              {/* Total Aset Card */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl shadow-lg text-white">
                      <div className="flex items-center gap-3 mb-2">
                          <div className="bg-white/20 p-2 rounded-lg">
                              <Package className="w-6 h-6" />
                          </div>
                          <div className="text-sm font-semibold opacity-90">Total Modal</div>
                      </div>
                      <div className="text-3xl font-bold">{formatCurrency(totalBuyValue)}</div>
                      <div className="text-xs opacity-75 mt-1">{inv.length} item stok</div>
                  </div>
                  <div className="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl shadow-lg text-white">
                      <div className="flex items-center gap-3 mb-2">
                          <div className="bg-white/20 p-2 rounded-lg">
                              <TrendingUp className="w-6 h-6" />
                          </div>
                          <div className="text-sm font-semibold opacity-90">Total Harga Jual</div>
                      </div>
                      <div className="text-3xl font-bold">{formatCurrency(totalSellValue)}</div>
                      <div className="text-xs opacity-75 mt-1">Nilai jual seluruh stok</div>
                  </div>
                  <div className="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl shadow-lg text-white">
                      <div className="flex items-center gap-3 mb-2">
                          <div className="bg-white/20 p-2 rounded-lg">
                              <DollarSign className="w-6 h-6" />
                          </div>
                          <div className="text-sm font-semibold opacity-90">Potensi Profit</div>
                      </div>
                      <div className="text-3xl font-bold">{formatCurrency(potentialProfit)}</div>
                      <div className="text-xs opacity-75 mt-1">{potentialProfit >= 0 ? '‚Üó' : '‚Üò'} {((potentialProfit / (totalBuyValue || 1)) * 100).toFixed(1)}% margin</div>
                  </div>
              </div>

              <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200 w-full overflow-x-auto">
                  {[
                      { id: 'barang', label: 'Daftar Barang' },
                      { id: 'adjustment', label: 'Penyesuaian' },
                      { id: 'opname', label: 'Opname' },
                      { id: 'alerts', label: 'Peringatan Stok' }
                  ].map(t => (
                      <button key={t.id} onClick={() => setTab(t.id)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>
                          {t.label}
                          {t.id === 'alerts' && (lowStockItems.length + outOfStockItems.length) > 0 && (
                              <span className="ml-2 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">
                                  {lowStockItems.length + outOfStockItems.length}
                              </span>
                          )}
                      </button>
                  ))}
              </div>

              {tab === 'barang' && (
                <>
                  {canAddStock ? (
                      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                          <h3 className="font-bold text-sm mb-4 text-slate-700">Tambah Barang Baru</h3>
                          <form onSubmit={(e) => {
                              e.preventDefault();
                              
                              // Check duplicate validation if enabled
                              if (inventorySettings?.preventDuplicateNames) {
                                  const duplicate = inv.find(item => 
                                      item.name.toLowerCase() === form.name.toLowerCase() &&
                                      item.category === form.category &&
                                      item.brand === form.brand
                                  );
                                  if (duplicate) {
                                      alert('‚ö†Ô∏è Produk dengan nama, kategori, dan brand yang sama sudah ada!\n\nUbah pengaturan di menu Pengaturan > Master Data > Pengaturan Stok jika ingin mengizinkan duplikat.');
                                      return;
                                  }
                              }
                              
                              addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory'), {
                                  ...form,
                                  ownerId: activeOwner.id,
                                  storeId: activeStore.id,
                                  createdAt: serverTimestamp()
                              }).then(() => {
                                  setForm({name:'', category: '', subCategory: '', brand: '', supplier: '', stock:0, buyPrice:0, sellPrice:0, minStock: ''});
                                  alert('‚úÖ Barang berhasil ditambahkan');
                              }).catch(err => {
                                  alert('Error: ' + err.message);
                              });
                          }} className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                              <div className="md:col-span-3">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Barang</label>
                                  <input className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.name} onChange={e => setForm({...form, name:e.target.value})} required placeholder="Contoh: LCD Samsung A50"/>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kategori</label>
                                  <select className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.category} onChange={e => setForm({...form, category:e.target.value, subCategory: ''})} required>
                                      <option value="">-- Pilih Kategori --</option>
                                      {allCategories.map(cat => (
                                          <option key={cat} value={cat}>{cat}</option>
                                      ))}
                                  </select>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Sub-Kategori</label>
                                  <select className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.subCategory} onChange={e => setForm({...form, subCategory:e.target.value})} disabled={!form.category}>
                                      <option value="">-- Pilih Sub (Opsional) --</option>
                                      {form.category && subCategories[form.category] && subCategories[form.category].map(sub => (
                                          <option key={sub} value={sub}>{sub}</option>
                                      ))}
                                  </select>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Brand</label>
                                  <select className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.brand} onChange={e => setForm({...form, brand:e.target.value})}>
                                      <option value="">-- Pilih Brand (Opsional) --</option>
                                      {brands.map(brand => (
                                          <option key={brand.id} value={brand.name}>{brand.name}</option>
                                      ))}
                                  </select>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Supplier</label>
                                  <select className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.supplier} onChange={e => setForm({...form, supplier:e.target.value})}>
                                      <option value="">-- Pilih Supplier (Opsional) --</option>
                                      {suppliers.map(sup => (
                                          <option key={sup.id} value={sup.name}>{sup.name}</option>
                                      ))}
                                  </select>
                              </div>
                              <div className="md:col-span-1">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Stok Awal</label>
                                  <NumberInput value={form.stock} onChange={(val) => setForm({...form, stock:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Harga Modal</label>
                                  <NumberInput value={form.buyPrice} onChange={(val) => setForm({...form, buyPrice:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Harga Jual</label>
                                  <NumberInput value={form.sellPrice} onChange={(val) => setForm({...form, sellPrice:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                              </div>
                              <div className="md:col-span-1">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Min Stok</label>
                                  <NumberInput value={form.minStock} onChange={(val) => setForm({...form, minStock:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder={stockThreshold.toString()}/>
                              </div>
                              <div className="md:col-span-1">
                                  <button className="w-full bg-blue-600 text-white p-2.5 rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center justify-center"><Plus className="w-5 h-5"/></button>
                              </div>
                          </form>
                      </div>
                  ) : (
                      <div onClick={() => showAccessDenied("Fitur TAMBAH STOK dikunci")} className="bg-red-50 text-red-600 p-4 rounded border border-red-200 flex items-center gap-2 cursor-pointer hover:bg-red-100">
                          <Lock className="w-4 h-4"/> Akses Tambah Stok dikunci.
                      </div>
                  )}
                  
                  <div className="bg-white p-4 rounded-xl border border-slate-200">
                      <div className="flex flex-col md:flex-row gap-3 md:items-end">
                          <div className="flex-1">
                              <label className="text-xs font-bold text-slate-500 uppercase block mb-1">üîç Cari Barang</label>
                              <input value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Cari nama, brand, atau supplier..." className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500"/>
                          </div>
                          <div className="flex-1">
                              <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Filter Kategori</label>
                              <select value={categoryFilter} onChange={e => setCategoryFilter(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm">
                                  <option value="">üìä Semua Kategori ({inv.length})</option>
                                  {allCategories.map(cat => (
                                      <option key={cat} value={cat}>
                                          {cat} ({inv.filter(i => i.category === cat).length})
                                      </option>
                                  ))}
                              </select>
                          </div>
                          <div className="flex-1">
                              <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Sub-Kategori</label>
                              <select 
                                  value={selectedSubCategory} 
                                  onChange={e => setSelectedSubCategory(e.target.value)} 
                                  disabled={!categoryFilter}
                                  className="w-full border p-2.5 rounded-lg text-sm disabled:bg-gray-50 disabled:text-gray-400"
                              >
                                  <option value="">üè∑Ô∏è Semua Sub-Kategori</option>
                                  {categoryFilter && subCategories[categoryFilter]?.map(sub => (
                                      <option key={sub} value={sub}>
                                          {sub} ({inv.filter(i => i.category === categoryFilter && i.subCategory === sub).length})
                                      </option>
                                  ))}
                              </select>
                          </div>
                      </div>
                  </div>
                  
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                      {paginatedInv.length === 0 && (
                          <div className="col-span-2 bg-white rounded-xl border border-slate-200 p-8 text-center text-slate-400 text-sm">
                              üì¶ Tidak ada barang{categoryFilter ? ` dalam kategori "${categoryFilter}"` : ''}
                          </div>
                      )}
                      {paginatedInv.map((i, idx) => {
                          const margin = i.buyPrice > 0 ? ((i.sellPrice - i.buyPrice) / i.buyPrice * 100).toFixed(0) : null;
                          const marginColor = !margin ? 'text-slate-400' : margin >= 30 ? 'text-green-600' : margin >= 15 ? 'text-yellow-600' : 'text-red-500';
                          const stockLow = (i.stock || 0) <= (i.minStock || stockThreshold);
                          const stockZero = (i.stock || 0) === 0;
                          const stockBadge = stockZero ? 'bg-red-100 text-red-700' : stockLow ? 'bg-yellow-100 text-yellow-700' : 'bg-emerald-100 text-emerald-700';
                          return (
                              <div key={i.id} className={`bg-white rounded-xl border ${stockZero ? 'border-red-200' : stockLow ? 'border-yellow-200' : 'border-slate-200'} overflow-hidden`}>
                                  {/* Baris 1: No + Nama + Stok */}
                                  <div className="flex items-center gap-2 px-3 pt-2.5 pb-1.5">
                                      <span className="text-slate-300 text-[10px] font-bold shrink-0">#{startIndex + idx + 1}</span>
                                      <span className="font-bold text-slate-800 text-sm flex-1 leading-tight line-clamp-1">{i.name}</span>
                                      <span className={`shrink-0 text-[11px] font-extrabold px-2 py-0.5 rounded-lg ${stockBadge}`}>{i.stock || 0} pcs</span>
                                  </div>
                                  {/* Baris 2: Badges */}
                                  {(i.category || i.brand || i.supplier) && (
                                      <div className="flex gap-1 flex-wrap px-3 pb-2">
                                          {i.category && <span className="bg-purple-50 text-purple-600 text-[9px] font-bold px-1.5 py-0.5 rounded">{i.category}{i.subCategory ? ` ¬∑ ${i.subCategory}` : ''}</span>}
                                          {i.brand && <span className="bg-orange-50 text-orange-600 text-[9px] font-bold px-1.5 py-0.5 rounded">{i.brand}</span>}
                                          {i.supplier && <span className="bg-teal-50 text-teal-600 text-[9px] font-bold px-1.5 py-0.5 rounded">{i.supplier}</span>}
                                      </div>
                                  )}
                                  {/* Baris 3: Harga row */}
                                  <div className="grid grid-cols-3 border-t border-slate-100 text-center divide-x divide-slate-100">
                                      <div className="py-1.5 px-1">
                                          <div className="text-[9px] text-slate-400 font-bold uppercase">Modal</div>
                                          <div className="text-[11px] font-bold text-slate-600 mt-0.5">{formatCurrency(i.buyPrice || 0)}</div>
                                      </div>
                                      <div className="py-1.5 px-1">
                                          <div className="text-[9px] text-slate-400 font-bold uppercase">Jual</div>
                                          <div className="text-[11px] font-bold text-slate-800 mt-0.5">{formatCurrency(i.sellPrice || 0)}</div>
                                      </div>
                                      <div className="py-1.5 px-1">
                                          <div className="text-[9px] text-slate-400 font-bold uppercase">Margin</div>
                                          <div className={`text-[11px] font-bold mt-0.5 ${marginColor}`}>{margin !== null ? `${margin}%` : '‚Äî'}</div>
                                      </div>
                                  </div>
                                  {/* Baris 4: Min stok + aksi */}
                                  <div className="flex items-center justify-between px-2.5 py-1.5 bg-slate-50 border-t border-slate-100">
                                      <div className="flex items-center gap-1.5">
                                          <span className="text-[9px] text-slate-400 font-bold">Min:</span>
                                          <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${stockLow ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500'}`}>{i.minStock || stockThreshold}</span>
                                          {stockZero && <span className="text-[9px] text-red-500 font-black">HABIS</span>}
                                          {!stockZero && stockLow && <span className="text-[9px] text-yellow-600 font-black">‚ö† RENDAH</span>}
                                      </div>
                                      <div className="flex items-center gap-0.5">
                                          <button onClick={() => setEditModal(i)} className="text-blue-500 hover:bg-blue-100 p-1 rounded" title="Edit"><Pencil className="w-3.5 h-3.5" /></button>
                                          <button onClick={() => { setAdjustModal(i); setAdjustAmount(0); setAdjustType('add'); }} className="text-orange-500 hover:bg-orange-100 p-1 rounded" title="Sesuaikan Stok"><PenTool className="w-3.5 h-3.5" /></button>
                                          <button onClick={() => deleteProduct(i.id, i.name)} className="text-red-500 hover:bg-red-100 p-1 rounded" title="Hapus"><Trash2 className="w-3.5 h-3.5" /></button>
                                      </div>
                                  </div>
                              </div>
                          );
                      })}
                  </div>
                  
                  {/* Pagination Controls */}
                  <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                      <div className="flex items-center gap-3">
                          <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                          <div className="flex gap-2">
                              <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                              <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                          </div>
                      </div>
                      <div className="text-sm text-slate-600 font-medium">
                          Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                      </div>
                  </div>
                  
                  {/* Pagination Navigation */}
                  {totalPages > 1 && (
                      <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                          <button 
                              onClick={() => handlePageChange(currentPage - 1)} 
                              disabled={currentPage === 1}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              ‚Üê Sebelumnya
                          </button>
                          <div className="text-sm text-slate-600 font-medium">
                              Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                          </div>
                          <button 
                              onClick={() => handlePageChange(currentPage + 1)} 
                              disabled={currentPage === totalPages}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              Selanjutnya ‚Üí
                          </button>
                      </div>
                  )}
                </>
              )}

              {tab === 'adjustment' && (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-6 border-b bg-slate-50">
                        <h3 className="font-bold text-slate-800 mb-2">Penyesuaian Stok</h3>
                        <p className="text-sm text-slate-600">Sesuaikan stok untuk koreksi atau pindah lokasi.</p>
                    </div>
                    {/* Filter Kategori & Sub-Kategori */}
                    <div className="p-4 bg-blue-50 border-b border-blue-100">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üîç Cari Barang</label>
                                <input value={adjustSearch} onChange={e => setAdjustSearch(e.target.value)} placeholder="Cari nama barang..." className="w-full border border-blue-200 p-2.5 rounded-lg text-sm focus:outline-blue-500 bg-white" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üìÇ Kategori</label>
                                <select value={adjustCategoryFilter} onChange={e => { setAdjustCategoryFilter(e.target.value); setAdjustSubCategoryFilter(''); }} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white">
                                    <option value="">Semua Kategori</option>
                                    {allCategories.map(cat => <option key={cat} value={cat}>{cat} ({inv.filter(i => i.category === cat).length})</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üìÅ Sub-Kategori</label>
                                <select value={adjustSubCategoryFilter} onChange={e => setAdjustSubCategoryFilter(e.target.value)} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white" disabled={!adjustCategoryFilter}>
                                    <option value="">Semua Sub-Kategori</option>
                                    {adjustCategoryFilter && subCategories[adjustCategoryFilter] && subCategories[adjustCategoryFilter].map(sub => <option key={sub} value={sub}>{sub}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div className="divide-y max-h-96 overflow-y-auto">
                        {inv.filter(i => {
                            const matchCategory = !adjustCategoryFilter || i.category === adjustCategoryFilter;
                            const matchSubCategory = !adjustSubCategoryFilter || i.subCategory === adjustSubCategoryFilter;
                            const matchSearch = !adjustSearch || i.name.toLowerCase().includes(adjustSearch.toLowerCase());
                            return matchCategory && matchSubCategory && matchSearch;
                        }).map(i => (
                            <div key={i.id} className="p-4 flex justify-between items-center hover:bg-slate-50">
                                <div>
                                    <p className="font-bold text-slate-800">{i.name}</p>
                                    <div className="flex gap-1 mt-1 flex-wrap">
                                        {i.category && <span className="inline-block bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded">üì¶ {i.category}</span>}
                                        {i.subCategory && <span className="inline-block bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded">‚Üí {i.subCategory}</span>}
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">Stok saat ini: {i.stock}</p>
                                </div>
                                <button onClick={() => setAdjustModal(i)} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">Sesuaikan</button>
                            </div>
                        ))}
                        {inv.filter(i => {
                            const matchCategory = !adjustCategoryFilter || i.category === adjustCategoryFilter;
                            const matchSubCategory = !adjustSubCategoryFilter || i.subCategory === adjustSubCategoryFilter;
                            const matchSearch = !adjustSearch || i.name.toLowerCase().includes(adjustSearch.toLowerCase());
                            return matchCategory && matchSubCategory && matchSearch;
                        }).length === 0 && (
                            <div className="p-6 text-center text-slate-500">üì¶ Tidak ada barang ditemukan</div>
                        )}
                    </div>
                </div>
              )}

              {tab === 'opname' && (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-6 border-b bg-gradient-to-r from-blue-50 to-purple-50">
                        <h3 className="font-bold text-blue-900 mb-2 flex items-center gap-2">
                            <Upload className="w-6 h-6" /> Stock Opname
                        </h3>
                        <p className="text-sm text-blue-700">Periksa dan verifikasi seluruh stok fisik dengan hitungan aktual di gudang</p>
                    </div>
                    
                    {/* Filter Kategori & Sub-Kategori untuk Opname */}
                    {opnameActive && (
                        <div className="p-4 bg-blue-50 border-b border-blue-100">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label className="text-xs font-bold text-blue-600 mb-1 block">üîç Cari Barang</label>
                                    <input value={opnameSearch} onChange={e => setOpnameSearch(e.target.value)} placeholder="Cari nama barang..." className="w-full border border-blue-200 p-2.5 rounded-lg text-sm focus:outline-blue-500 bg-white" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-blue-600 mb-1 block">üìÇ Kategori</label>
                                    <select value={opnameCategoryFilter} onChange={e => { setOpnameCategoryFilter(e.target.value); setOpnameSubCategoryFilter(''); }} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white">
                                        <option value="">Semua Kategori</option>
                                        {allCategories.map(cat => <option key={cat} value={cat}>{cat} ({inv.filter(i => i.category === cat).length})</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-blue-600 mb-1 block">üìÅ Sub-Kategori</label>
                                    <select value={opnameSubCategoryFilter} onChange={e => setOpnameSubCategoryFilter(e.target.value)} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white" disabled={!opnameCategoryFilter}>
                                        <option value="">Semua Sub-Kategori</option>
                                        {opnameCategoryFilter && subCategories[opnameCategoryFilter] && subCategories[opnameCategoryFilter].map(sub => <option key={sub} value={sub}>{sub}</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {!opnameActive ? (
                        <div className="p-8 text-center">
                            <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Upload className="w-10 h-10 text-blue-600" />
                            </div>
                            <h4 className="font-bold text-lg text-slate-800 mb-2">Belum Ada Opname Aktif</h4>
                            <p className="text-sm text-slate-600 mb-6 max-w-md mx-auto">
                                Mulai stock opname untuk menghitung dan membandingkan stok fisik dengan stok sistem. 
                                Semua perbedaan akan tercatat otomatis.
                            </p>
                            <button 
                                onClick={handleStartOpname}
                                className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:from-blue-700 hover:to-purple-700 flex items-center justify-center gap-2 mx-auto shadow-lg"
                            >
                                <Upload className="w-5 h-5" /> Mulai Stock Opname
                            </button>
                        </div>
                    ) : (
                        <div>
                            <div className="p-4 bg-yellow-50 border-b border-yellow-200 flex items-center justify-between">
                                <div className="flex items-center gap-2 text-yellow-800">
                                    <AlertTriangle className="w-5 h-5" />
                                    <span className="font-bold text-sm">Stock Opname Sedang Berlangsung</span>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={handleCancelOpname}
                                        disabled={saving}
                                        className="px-4 py-2 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-100 disabled:opacity-50"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={handleSaveOpname}
                                        disabled={saving}
                                        className="px-6 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 flex items-center gap-2 disabled:opacity-50"
                                    >
                                        {saving ? (
                                            <>
                                                <Loader2 className="w-4 h-4 animate-spin" /> Menyimpan...
                                            </>
                                        ) : (
                                            <>
                                                <Save className="w-4 h-4" /> Simpan Opname
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-slate-100 border-b-2 border-slate-200">
                                        <tr>
                                            <th className="p-3 text-left font-bold text-slate-700">No</th>
                                            <th className="p-3 text-left font-bold text-slate-700">Nama Barang</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Kategori</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Sub-Kategori</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Stok Sistem</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Stok Fisik</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Selisih</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {inv.filter(item => {
                                            const matchCategory = !opnameCategoryFilter || item.category === opnameCategoryFilter;
                                            const matchSubCategory = !opnameSubCategoryFilter || item.subCategory === opnameSubCategoryFilter;
                                            const matchSearch = !opnameSearch || item.name.toLowerCase().includes(opnameSearch.toLowerCase());
                                            return matchCategory && matchSubCategory && matchSearch;
                                        }).map((item, idx) => {
                                            const data = opnameData[item.id] || { systemStock: item.stock || 0, physicalStock: item.stock || 0, difference: 0 };
                                            const diffColor = data.difference > 0 ? 'text-green-600 bg-green-50' : data.difference < 0 ? 'text-red-600 bg-red-50' : 'text-slate-600 bg-slate-50';
                                            
                                            return (
                                                <tr key={item.id} className="hover:bg-slate-50">
                                                    <td className="p-3 text-slate-500 font-medium">{idx + 1}</td>
                                                    <td className="p-3 font-bold text-slate-800">{item.name}</td>
                                                    <td className="p-3 text-center">
                                                        <span className="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">
                                                            {item.category || '‚Äî'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        {item.subCategory ? (
                                                            <span className="inline-block bg-purple-100 text-purple-800 text-xs font-bold px-2 py-1 rounded">
                                                                {item.subCategory}
                                                            </span>
                                                        ) : (
                                                            <span className="text-slate-400 text-xs">‚Äî</span>
                                                        )}
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <span className="inline-block bg-slate-100 text-slate-700 font-bold px-3 py-1 rounded">
                                                            {data.systemStock}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <input 
                                                            type="number"
                                                            min="0"
                                                            value={data.physicalStock}
                                                            onChange={(e) => handleOpnameInput(item.id, e.target.value)}
                                                            className="w-24 px-3 py-2 border border-slate-300 rounded-lg text-center font-bold focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        />
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <span className={`inline-block font-bold px-3 py-1 rounded ${diffColor}`}>
                                                            {data.difference > 0 ? '+' : ''}{data.difference}
                                                        </span>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                                
                                {inv.length === 0 && (
                                    <div className="p-8 text-center text-slate-500">
                                        üì¶ Tidak ada barang untuk di-opname
                                    </div>
                                )}
                            </div>
                            
                            {/* Summary */}
                            <div className="p-4 bg-slate-50 border-t border-slate-200">
                                <div className="flex flex-wrap gap-4 justify-center text-sm">
                                    <div className="bg-white px-4 py-2 rounded-lg border border-slate-200">
                                        <span className="text-slate-600">Total Item: </span>
                                        <span className="font-bold text-slate-800">{inv.length}</span>
                                    </div>
                                    <div className="bg-white px-4 py-2 rounded-lg border border-slate-200">
                                        <span className="text-slate-600">Item Berubah: </span>
                                        <span className="font-bold text-blue-600">
                                            {Object.values(opnameData).filter(d => d.difference !== 0).length}
                                        </span>
                                    </div>
                                    <div className="bg-green-50 px-4 py-2 rounded-lg border border-green-200">
                                        <span className="text-green-700">Surplus: </span>
                                        <span className="font-bold text-green-600">
                                            {Object.values(opnameData).filter(d => d.difference > 0).length}
                                        </span>
                                    </div>
                                    <div className="bg-red-50 px-4 py-2 rounded-lg border border-red-200">
                                        <span className="text-red-700">Kekurangan: </span>
                                        <span className="font-bold text-red-600">
                                            {Object.values(opnameData).filter(d => d.difference < 0).length}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
              )}

              {tab === 'alerts' && (
                <div className="space-y-4">
                    {/* Settings Header */}
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200">
                        <div>
                            <h3 className="font-bold text-slate-800">Pengaturan Peringatan Stok</h3>
                            <p className="text-sm text-slate-500">Threshold saat ini: <span className="font-bold text-blue-600">{stockThreshold} pcs</span></p>
                        </div>
                        <button 
                            onClick={() => {
                                setTempSettings({ minStockThreshold: stockThreshold });
                                setSettingsModal(true);
                            }} 
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2"
                        >
                            <Settings className="w-4 h-4" /> Settings
                        </button>
                    </div>
                    
                    {/* Filter Kategori & Sub-Kategori */}
                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üìÇ Filter Kategori</label>
                                <select value={alertCategoryFilter} onChange={e => { setAlertCategoryFilter(e.target.value); setAlertSubCategoryFilter(''); }} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white">
                                    <option value="">Semua Kategori</option>
                                    {allCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üìÅ Sub-Kategori</label>
                                <select value={alertSubCategoryFilter} onChange={e => setAlertSubCategoryFilter(e.target.value)} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white" disabled={!alertCategoryFilter}>
                                    <option value="">Semua Sub-Kategori</option>
                                    {alertCategoryFilter && subCategories[alertCategoryFilter] && subCategories[alertCategoryFilter].map(sub => <option key={sub} value={sub}>{sub}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                        <h3 className="font-bold text-red-900 mb-3 flex items-center gap-2"><AlertTriangle className="w-5 h-5" /> ‚õî Stok KOSONG</h3>
                        {outOfStockItems.filter(item => {
                            const matchCategory = !alertCategoryFilter || item.category === alertCategoryFilter;
                            const matchSubCategory = !alertSubCategoryFilter || item.subCategory === alertSubCategoryFilter;
                            return matchCategory && matchSubCategory;
                        }).length === 0 ? (
                            <p className="text-red-700 text-sm">‚úì Tidak ada barang yang kosong{alertCategoryFilter ? ` di kategori "${alertCategoryFilter}"` : ''}</p>
                        ) : (
                            <div className="space-y-2">
                                {outOfStockItems.filter(item => {
                                    const matchCategory = !alertCategoryFilter || item.category === alertCategoryFilter;
                                    const matchSubCategory = !alertSubCategoryFilter || item.subCategory === alertSubCategoryFilter;
                                    return matchCategory && matchSubCategory;
                                }).map(item => (
                                    <div key={item.id} className="bg-white p-3 rounded-lg border border-red-200 flex justify-between items-center">
                                        <div className="flex-1">
                                            <p className="font-bold text-slate-800">{item.name}</p>
                                            <div className="flex gap-2 mt-1 text-xs flex-wrap">
                                                <span className="bg-red-100 text-red-700 px-2 py-1 rounded font-bold">Stok: 0</span>
                                                {item.category && <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold">üì¶ {item.category}</span>}
                                                {item.subCategory && <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">‚Üí {item.subCategory}</span>}
                                                {item.supplier && <span className="bg-slate-100 text-slate-700 px-2 py-1 rounded">{item.supplier}</span>}
                                            </div>
                                        </div>
                                        <button onClick={() => { setAdjustModal(item); setAdjustAmount(0); setAdjustType('add'); }} className="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-blue-700">‚ûï Tambah</button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                        <h3 className="font-bold text-yellow-900 mb-3 flex items-center gap-2"><AlertTriangle className="w-5 h-5" /> ‚ö†Ô∏è Stok Rendah (‚â§{stockThreshold} pcs)</h3>
                        {lowStockItems.filter(i => {
                            const matchCategory = !alertCategoryFilter || i.category === alertCategoryFilter;
                            const matchSubCategory = !alertSubCategoryFilter || i.subCategory === alertSubCategoryFilter;
                            return i.stock > 0 && matchCategory && matchSubCategory;
                        }).length === 0 ? (
                            <p className="text-yellow-700 text-sm">‚úì Tidak ada barang stok rendah{alertCategoryFilter ? ` di kategori "${alertCategoryFilter}"` : ''}</p>
                        ) : (
                            <div className="space-y-2">
                                {lowStockItems.filter(i => {
                                    const matchCategory = !alertCategoryFilter || i.category === alertCategoryFilter;
                                    const matchSubCategory = !alertSubCategoryFilter || i.subCategory === alertSubCategoryFilter;
                                    return matchCategory && matchSubCategory;
                                }).map(item => (
                                    <div key={item.id} className="bg-white p-3 rounded-lg border border-yellow-200 flex justify-between items-center">
                                        <div className="flex-1">
                                            <p className="font-bold text-slate-800">{item.name}</p>
                                            <div className="flex gap-2 mt-1 text-xs flex-wrap">
                                                <span className={`px-2 py-1 rounded font-bold ${item.stock <= Math.floor(stockThreshold / 2) ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                                    Stok: {item.stock} pcs {item.stock <= Math.floor(stockThreshold / 2) ? '(SANGAT RENDAH!)' : ''}
                                                </span>
                                                {item.category && <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold">üì¶ {item.category}</span>}
                                                {item.subCategory && <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">‚Üí {item.subCategory}</span>}
                                                {item.supplier && <span className="bg-slate-100 text-slate-700 px-2 py-1 rounded">{item.supplier}</span>}
                                            </div>
                                        </div>
                                        <button onClick={() => { setAdjustModal(item); setAdjustAmount(0); setAdjustType('add'); }} className="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-700">‚ûï Tambah</button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
              )}

              {adjustModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                        <h3 className="font-bold text-xl text-slate-800 mb-2 flex items-center gap-2">
                            <PenTool className="w-5 h-5 text-orange-600" />
                            {adjustModal.name}
                        </h3>
                        <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg mb-4">
                            <p className="text-sm text-slate-600">Stok Saat Ini:</p>
                            <p className="text-2xl font-bold text-blue-600">{adjustModal.stock || 0} pcs</p>
                            <p className="text-xs text-slate-500 mt-1">Min Stok: <span className="font-bold">{adjustModal.minStock || stockThreshold} pcs</span></p>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Jenis Penyesuaian</label>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setAdjustType('add')}
                                        className={`flex-1 py-2.5 rounded-lg font-bold transition-all ${adjustType === 'add' ? 'bg-green-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                    >
                                        ‚ûï Tambah Stok
                                    </button>
                                    <button 
                                        onClick={() => setAdjustType('reduce')}
                                        className={`flex-1 py-2.5 rounded-lg font-bold transition-all ${adjustType === 'reduce' ? 'bg-red-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                    >
                                        ‚ûñ Kurangi Stok
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Jumlah ({adjustType === 'add' ? 'Tambahan' : 'Pengurangan'})</label>
                                <NumberInput value={adjustAmount} onChange={setAdjustAmount} placeholder="Masukkan jumlah" className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" min="0" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Minimal Stok Baru (Opsional)</label>
                                <NumberInput value={newMinStock} onChange={setNewMinStock} placeholder={`Default: ${adjustModal.minStock || stockThreshold}`} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" min="1" />
                                <p className="text-[10px] text-slate-500 mt-1">Kosongkan untuk tidak mengubah. Default: {adjustModal.minStock || stockThreshold} pcs</p>
                            </div>
                            <div className="bg-slate-50 p-3 rounded-lg">
                                <p className="text-xs text-slate-600 mb-1">Stok Baru:</p>
                                <p className="text-lg font-bold text-slate-800">
                                    {adjustType === 'add' ? (adjustModal.stock || 0) + adjustAmount : Math.max(0, (adjustModal.stock || 0) - adjustAmount)} pcs
                                </p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setAdjustModal(null)} className="flex-1 border border-slate-300 py-2.5 rounded-lg font-bold text-slate-600 hover:bg-slate-50">Batal</button>
                                <button onClick={handleAdjust} className="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700">Simpan</button>
                            </div>
                        </div>
                    </div>
                </div>
              )}
              
              {editModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-bold text-xl text-slate-800">Edit Produk</h3>
                            <button onClick={() => setEditModal(null)} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <form onSubmit={handleEditProduct} className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-600 block mb-2">Nama Produk *</label>
                                <input className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500" value={editModal.name} onChange={e => setEditModal({...editModal, name: e.target.value})} required />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Kategori *</label>
                                    <select className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 bg-white" value={editModal.category || ''} onChange={e => setEditModal({...editModal, category: e.target.value, subCategory: ''})} required>
                                        <option value="">-- Pilih Kategori --</option>
                                        {allCategories.map(cat => (
                                            <option key={cat} value={cat}>{cat}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Sub-Kategori</label>
                                    <select className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 bg-white" value={editModal.subCategory || ''} onChange={e => setEditModal({...editModal, subCategory: e.target.value})} disabled={!editModal.category}>
                                        <option value="">-- Pilih Sub (Opsional) --</option>
                                        {editModal.category && subCategories[editModal.category] && subCategories[editModal.category].map(sub => (
                                            <option key={sub} value={sub}>{sub}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Brand</label>
                                    <select className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 bg-white" value={editModal.brand || ''} onChange={e => setEditModal({...editModal, brand: e.target.value})}>
                                        <option value="">-- Pilih Brand (Opsional) --</option>
                                        {brands.map(brand => (
                                            <option key={brand.id} value={brand.name}>{brand.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Supplier</label>
                                    <select className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 bg-white" value={editModal.supplier || ''} onChange={e => setEditModal({...editModal, supplier: e.target.value})}>
                                        <option value="">-- Pilih Supplier (Opsional) --</option>
                                        {suppliers.map(sup => (
                                            <option key={sup.id} value={sup.name}>{sup.name}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Harga Modal *</label>
                                    <NumberInput value={editModal.buyPrice} onChange={(val) => setEditModal({...editModal, buyPrice: val})} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Harga Jual *</label>
                                    <NumberInput value={editModal.sellPrice} onChange={(val) => setEditModal({...editModal, sellPrice: val})} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-600 block mb-2">Minimal Stok</label>
                                <NumberInput value={editModal.minStock || ''} onChange={(val) => setEditModal({...editModal, minStock: val})} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder={stockThreshold.toString()}/>
                                <p className="text-xs text-slate-500 mt-1">Kosongkan untuk menggunakan default ({stockThreshold} pcs)</p>
                            </div>
                            <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                                <p className="text-xs text-slate-600 mb-1">Margin Keuntungan:</p>
                                <p className="text-lg font-bold text-blue-600">{editModal.buyPrice > 0 ? ((editModal.sellPrice - editModal.buyPrice) / editModal.buyPrice * 100).toFixed(1) : '0'}%</p>
                            </div>
                            <div className="flex gap-2 pt-2">
                                <button type="button" onClick={() => setEditModal(null)} className="flex-1 border py-3 rounded-lg font-bold hover:bg-slate-50">Batal</button>
                                <button type="submit" className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">üíæ Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
              )}
              
              {categoryModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-bold text-xl text-slate-800">Kelola Kategori</h3>
                            <button onClick={() => setCategoryModal(null)} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <div className="space-y-3 max-h-96 overflow-y-auto">
                            {allCategories.map(cat => (
                                <div key={cat} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <div>
                                        <p className="font-bold text-slate-700">{cat}</p>
                                        <p className="text-xs text-slate-500">{inv.filter(i => i.category === cat).length} produk</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <button onClick={() => setCategoryModal(null)} className="w-full mt-4 py-3 border rounded-lg font-bold hover:bg-slate-50">Tutup</button>
                    </div>
                </div>
              )}
              
              {/* Stock Settings Modal */}
              {settingsModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-bold text-xl text-slate-800">‚öôÔ∏è Pengaturan Stok</h3>
                            <button onClick={() => setSettingsModal(false)} className="p-1 hover:bg-gray-100 rounded-full">
                                <X className="w-5 h-5 text-slate-400"/>
                            </button>
                        </div>
                        
                        <div className="space-y-4">
                            <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <h4 className="font-bold text-blue-800 mb-2">üìä Info Stok Saat Ini</h4>
                                <div className="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <p className="text-slate-600">Total Barang:</p>
                                        <p className="font-bold text-blue-600">{inv.length} item</p>
                                    </div>
                                    <div>
                                        <p className="text-slate-600">Stok Kosong:</p>
                                        <p className="font-bold text-red-600">{outOfStockItems.length} item</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label className="text-sm font-bold text-slate-700 block mb-2">
                                    üö® Batas Minimum Stok Peringatan
                                </label>
                                <div className="relative flex items-center gap-3">
                                    <NumberInput 
                                        value={tempSettings.minStockThreshold || stockThreshold} 
                                        onChange={(val) => setTempSettings(prev => ({ ...prev, minStockThreshold: val }))}
                                        placeholder="Minimal stok" 
                                        className="flex-1 border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" 
                                        min="1" 
                                        max="1000"
                                    />
                                    <span className="text-slate-500 font-medium">unit</span>
                                </div>
                                <p className="text-xs text-slate-500 mt-1">
                                    Stok di bawah atau sama dengan angka ini akan muncul peringatan
                                </p>
                            </div>
                            
                            <div className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                                <h5 className="font-bold text-yellow-800 text-sm mb-1">Preview Peringatan:</h5>
                                <p className="text-xs text-yellow-700">
                                    Dengan threshold <span className="font-bold">{tempSettings.minStockThreshold || stockThreshold} pcs</span>, 
                                    akan ada <span className="font-bold">{inv.filter(i => (i.stock || 0) <= (tempSettings.minStockThreshold || stockThreshold) && (i.stock || 0) > 0).length} item</span> yang muncul peringatan stok rendah.
                                </p>
                            </div>
                        </div>
                        
                        <div className="flex gap-3 mt-6">
                            <button 
                                onClick={() => setSettingsModal(false)} 
                                className="flex-1 border border-slate-300 py-2.5 rounded-lg font-bold text-slate-600 hover:bg-slate-50"
                            >
                                Batal
                            </button>
                            <button 
                                onClick={saveStockSettings}
                                className="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700"
                            >
                                üíæ Simpan
                            </button>
                        </div>
                    </div>
                </div>
              )}
            </div>
          );
        };

        const PaymentModal = ({ service, close, pay }) => {
           const { activeOwner, activeStore } = useContext(SessionContext);
           const sisa = (service.costEstimate || 0) - (service.dp || 0);
           const [paymentType, setPaymentType] = useState('full'); // 'full', 'partial', 'credit'
           const [amount, setAmount] = useState(sisa);
           const [method, setMethod] = useState('Cash');
           const [cashAccount, setCashAccount] = useState('Kas Tunai');
           const [saving, setSaving] = useState(false);
           const [creditDueDate, setCreditDueDate] = useState('');
           
           const handlePayment = async () => {
               setSaving(true);
               try {
                   if (paymentType === 'credit') {
                       // Generate invoice number
                       const now = new Date();
                       const pad = (n,l=2) => String(n).padStart(l,'0');
                       const dateStr = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}`;
                       const rand = pad(Math.floor(Math.random()*9000)+1000, 4);
                       const invoiceNo = `PIU-${dateStr}-${rand}`;
                       // Create receivable (piutang) and close service
                       const serviceItems = (service.usedParts || []).map(p => ({
                           name: p.name || '-',
                           qty: p.qty || 1,
                           price: p.sellPrice || p.price || 0
                       }));
                       // Add service fee as an item if present
                       if (service.serviceFee > 0) {
                           serviceItems.unshift({ name: 'Biaya Jasa Service', qty: 1, price: service.serviceFee || 0 });
                       }
                       await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                           ownerId: activeOwner.id,
                           storeId: activeStore.id,
                           serviceId: service.id,
                           invoiceNo,
                           type: 'receivable',
                           customerName: service.customerName,
                           customerPhone: service.customerPhone || '',
                           amount: sisa,
                           paid: 0,
                           remaining: sisa,
                           description: `Service ${service.unitType || 'HP'} - ${service.complaint || ''}`,
                           items: serviceItems,
                           dueDate: creditDueDate ? new Date(Date.now()+Number(creditDueDate)*86400000).toISOString().split('T')[0] : '',
                           status: 'unpaid',
                           createdAt: serverTimestamp()
                       });
                       
                       // Update service to show it's now a receivable
                       await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', service.id), { 
                           paymentStatus: 'Piutang',
                           updatedAt: serverTimestamp()
                       });
                       
                       alert(`‚úÖ Piutang ${formatCurrency(sisa)} berhasil dicatat untuk ${service.customerName}\n\nüí∞ Pelanggan dapat membayar nanti melalui menu Piutang`);
                       close();
                   } else {
                       // Normal payment flow
                       await pay(service, amount, method, cashAccount);
                   }
               } catch (err) {
                   alert('Error: ' + err.message);
               } finally {
                   setSaving(false);
               }
           };
           
           return (
             <div className="fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
                   <div className="flex justify-between items-center mb-4 border-b pb-3">
                       <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2">
                           <DollarSign className="w-6 h-6 text-green-600" />
                           Pembayaran Service
                       </h3>
                       <button onClick={close} className="p-1 hover:bg-gray-100 rounded-full">
                           <X className="w-5 h-5 text-slate-400" />
                       </button>
                   </div>
                   
                   <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl mb-4 border border-blue-100">
                      <p className="text-sm text-slate-600 mb-1">Pelanggan: <span className="font-bold text-slate-800">{service.customerName}</span></p>
                      <p className="text-sm text-slate-600 mb-1">Unit: <span className="font-bold text-slate-800">{service.unitType}</span></p>
                      <div className="flex justify-between items-center mt-3 pt-3 border-t border-blue-200">
                          <span className="text-sm text-slate-600">Sisa Tagihan:</span>
                          <span className="font-bold text-2xl text-red-600">{formatCurrency(sisa)}</span>
                      </div>
                   </div>
                   
                   <div className="space-y-4">
                       <div>
                           <label className="text-xs font-bold text-slate-600 uppercase mb-2 block">Pilih Jenis Pembayaran</label>
                           <div className="grid grid-cols-3 gap-2">
                               <button
                                   onClick={() => {
                                       setPaymentType('full');
                                       setAmount(sisa);
                                   }}
                                   className={`p-3 rounded-lg border-2 transition-all text-center ${
                                       paymentType === 'full'
                                           ? 'border-green-500 bg-green-50 shadow-lg'
                                           : 'border-slate-200 hover:border-green-300'
                                   }`}
                               >
                                   <CheckCircle className={`w-6 h-6 mx-auto mb-1 ${paymentType === 'full' ? 'text-green-600' : 'text-slate-400'}`} />
                                   <p className="text-xs font-bold text-slate-700">Lunas</p>
                                   <p className="text-[10px] text-slate-500">Bayar Semua</p>
                               </button>
                               
                               <button
                                   onClick={() => {
                                       setPaymentType('partial');
                                       setAmount(0);
                                   }}
                                   className={`p-3 rounded-lg border-2 transition-all text-center ${
                                       paymentType === 'partial'
                                           ? 'border-orange-500 bg-orange-50 shadow-lg'
                                           : 'border-slate-200 hover:border-orange-300'
                                   }`}
                               >
                                   <div className={`w-6 h-6 mx-auto mb-1 rounded-full border-2 flex items-center justify-center ${
                                       paymentType === 'partial' ? 'border-orange-600 text-orange-600' : 'border-slate-400 text-slate-400'
                                   }`}>
                                       <span className="text-xs font-bold">%</span>
                                   </div>
                                   <p className="text-xs font-bold text-slate-700">Sebagian</p>
                                   <p className="text-[10px] text-slate-500">Bayar DP</p>
                               </button>
                               
                               <button
                                   onClick={() => {
                                       setPaymentType('credit');
                                       setAmount(0);
                                   }}
                                   className={`p-3 rounded-lg border-2 transition-all text-center ${
                                       paymentType === 'credit'
                                           ? 'border-blue-500 bg-blue-50 shadow-lg'
                                           : 'border-slate-200 hover:border-blue-300'
                                   }`}
                               >
                                   <div className={`w-6 h-6 mx-auto mb-1 text-2xl leading-6 ${paymentType === 'credit' ? 'text-blue-600' : 'text-slate-400'}`}>
                                       ‚è∞
                                   </div>
                                   <p className="text-xs font-bold text-slate-700">Piutang</p>
                                   <p className="text-[10px] text-slate-500">Bayar Nanti</p>
                               </button>
                           </div>
                       </div>
                       
                       {paymentType !== 'credit' && (
                           <>
                               <div>
                                   <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">
                                       Jumlah Bayar {paymentType === 'partial' && '(Minimal DP)'}
                                   </label>
                                   <NumberInput 
                                       className="w-full border-2 p-3 rounded-lg font-bold text-xl text-slate-800 focus:border-green-500 focus:outline-none" 
                                       value={amount} 
                                       onChange={val=>setAmount(val)}
                                       placeholder="0"
                                   />
                                   {paymentType === 'full' && amount !== sisa && (
                                       <p className="text-xs text-orange-600 mt-1">‚ö†Ô∏è Jumlah tidak sesuai untuk pelunasan</p>
                                   )}
                               </div>
                               
                               <div>
                                   <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">Metode Pembayaran</label>
                                   <select className="w-full border-2 p-3 rounded-lg bg-white focus:border-blue-500 focus:outline-none" value={method} onChange={e=>setMethod(e.target.value)}>
                                       <option>Cash</option>
                                       <option>Transfer</option>
                                       <option>Debit Card</option>
                                       <option>Credit Card</option>
                                       <option>E-Wallet</option>
                                   </select>
                               </div>
                               <CashAccountSelect value={cashAccount} onChange={setCashAccount} label="Masuk ke Kas" />
                           </>
                       )}
                       
                       {paymentType === 'credit' && (
                           <div className="space-y-3">
                               <div>
                                   <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">Jatuh Tempo <span className="text-slate-400 font-normal normal-case">(opsional)</span></label>
                                   <div className="flex items-center gap-2">
                                       <input type="number" min="1" max="365" placeholder="cth: 30" value={creditDueDate} onChange={e => setCreditDueDate(e.target.value)} className="w-full border-2 border-slate-200 p-3 rounded-lg focus:border-blue-500 focus:outline-none text-slate-700" />
                                       <span className="text-sm text-slate-500 whitespace-nowrap">hari</span>
                                   </div>
                                   {creditDueDate > 0 && <p className="text-xs text-slate-400 mt-1">Jatuh tempo: {new Date(Date.now()+Number(creditDueDate)*86400000).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}</p>}
                               </div>
                               <div className="bg-blue-50 border-2 border-blue-200 p-4 rounded-lg">
                                   <h4 className="font-bold text-sm text-blue-900 mb-2 flex items-center gap-2">
                                       <Info className="w-4 h-4" />
                                       Informasi Piutang
                                   </h4>
                                   <ul className="text-xs text-blue-800 space-y-1">
                                       <li>‚Ä¢ Sisa tagihan <b>{formatCurrency(sisa)}</b> akan dicatat sebagai piutang</li>
                                       <li>‚Ä¢ Pelanggan dapat membayar kapan saja melalui menu <b>Piutang</b></li>
                                       <li>‚Ä¢ Status service akan berubah menjadi <b>"Piutang"</b></li>
                                       <li>‚Ä¢ Anda akan mendapat notifikasi saat pelanggan melakukan pembayaran</li>
                                   </ul>
                               </div>
                           </div>
                       )}
                   </div>
                   
                   <div className="mt-6 flex gap-3">
                      <button onClick={close} className="flex-1 py-3 border-2 border-slate-200 rounded-xl hover:bg-slate-50 font-bold text-slate-600 transition-all">Batal</button>
                      <button 
                          onClick={handlePayment} 
                          disabled={saving || (paymentType !== 'credit' && (!amount || amount <= 0))}
                          className={`flex-1 py-3 rounded-xl font-bold shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed ${
                              paymentType === 'credit'
                                  ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-blue-200'
                                  : 'bg-green-600 text-white hover:bg-green-700 shadow-green-200'
                          }`}
                      >
                          {saving ? 'Memproses...' : paymentType === 'credit' ? 'üìù Catat Piutang' : 'üíµ Proses Pembayaran'}
                      </button>
                   </div>
                </div>
             </div>
           );
        };

        // =============================================
        // üñ®Ô∏è THERMAL PRINT UTILITY (58mm)
        // =============================================
        // Buka popup window berformat struk thermal 58mm ‚Üí pakai system print dialog
        // Android: bisa pilih printer Bluetooth Classic dari print dialog system
        // Desktop: bisa pilih printer apapun yang terdaftar

        const printThermal58mm = (s, store) => {
            const fmt = (n) => 'Rp ' + Number(n || 0).toLocaleString('id-ID');
            const sisa = Math.max(0, (s.costEstimate || 0) - (s.dp || 0));
            const _parseDate = (v) => { if (!v) return new Date(); if (v?.toDate) return v.toDate(); return new Date(String(v).replace(' ', 'T')); };
            const date = _parseDate(s.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
            const time = _parseDate(s.createdAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const storeName = store?.name || 'iFix Pro';
            const storeAddr = store?.address || '';
            const storePhone = store?.phone || '';

            // Logo sudah tersimpan sebagai base64 data URL di store.logo
            const logoB64 = store?.logo || '';

            const partsRows = (s.usedParts && s.usedParts.length > 0)
                ? s.usedParts.map(p => `
                    <tr>
                      <td style="padding:4px 0;font-size:var(--fs);">${p.name||'-'}</td>
                      <td style="padding:4px 0;text-align:center;font-size:var(--fs);width:32px;">x${p.qty||1}</td>
                      <td style="padding:4px 0;text-align:right;font-size:var(--fs);">${fmt(p.price||0)}</td>
                    </tr>`).join('')
                : `<tr><td colspan="3" style="font-size:var(--fs);color:#999;padding:4px 0;">-</td></tr>`;

            const statusColor = s.status === 'Selesai' ? '#16a34a' : s.status === 'Dalam Proses' ? '#2563eb' : '#92400e';
            const statusBg   = s.status === 'Selesai' ? '#dcfce7' : s.status === 'Dalam Proses' ? '#dbeafe' : '#fef3c7';

            const html = `<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Struk #${s.token||s.id}</title>
<style>
:root{--fs:15px;--fs-sm:13px;--fs-xs:12px;}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;background:#e8ecf0;}
body{font-family:'Courier New',Courier,monospace;color:#1a1a1a;}
.page{max-width:480px;margin:0 auto;background:#fff;}
.header{background:#fff;text-align:center;padding:18px 16px 10px;}
.header img{max-width:120px;max-height:80px;object-fit:contain;display:block;margin:0 auto 8px;}
.header .logo-placeholder{width:64px;height:64px;background:#1d4ed8;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900;color:#fff;margin:0 auto 8px;}
.header .store-name{font-size:18px;font-weight:900;letter-spacing:1px;text-transform:uppercase;}
.header .store-sub{font-size:var(--fs-xs);color:#555;margin-top:2px;line-height:1.5;}
.sep{border:none;border-top:2px dashed #ccc;margin:0 16px;}
.sep-solid{border:none;border-top:2px solid #1a1a1a;margin:0 16px;}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:var(--fs-xs);font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin:8px auto;}
.body{padding:10px 16px;}
.section-label{font-size:var(--fs-xs);font-weight:700;color:#888;text-transform:uppercase;letter-spacing:1px;margin:10px 0 4px;}
.kv{display:flex;justify-content:space-between;align-items:baseline;padding:3px 0;}
.kv .k{font-size:var(--fs-sm);color:#555;}
.kv .v{font-size:var(--fs-sm);font-weight:700;text-align:right;max-width:60%;word-break:break-word;}
.keluhan-text{font-size:var(--fs-sm);line-height:1.5;padding:3px 0;}
table.parts{width:100%;border-collapse:collapse;}
table.parts th{font-size:var(--fs-xs);color:#888;text-align:left;padding:2px 0;border-bottom:1px solid #eee;}
table.parts th:last-child,table.parts td:last-child{text-align:right;}
table.parts th:nth-child(2),table.parts td:nth-child(2){text-align:center;}
.total-box{background:#f8fafc;border-radius:10px;padding:10px 12px;margin-top:8px;}
.total-row{display:flex;justify-content:space-between;padding:3px 0;font-size:var(--fs-sm);}
.total-row .tl{color:#555;}
.total-row .tr{font-weight:700;}
.sisa-row{display:flex;justify-content:space-between;align-items:center;border-top:2px solid #1a1a1a;margin-top:6px;padding-top:8px;}
.sisa-row .sl{font-size:17px;font-weight:900;}
.sisa-row .sr{font-size:22px;font-weight:900;}
.footer{text-align:center;padding:10px 16px 14px;font-size:var(--fs-xs);color:#888;line-height:1.8;}
.btn-row{display:flex;gap:8px;padding:12px 16px 28px;background:#e8ecf0;position:sticky;bottom:0;}
.btn-row .status-msg{width:100%;text-align:center;font-size:14px;min-height:18px;margin-bottom:8px;font-weight:600;}
@media print{
  @page{size:58mm auto;margin:0;}
  :root{--fs:10px;--fs-sm:10px;--fs-xs:9px;}
  html,body{background:#fff;}
  .page{max-width:100%;}
  .header{padding:2mm 2mm 1mm;}
  .header img{max-width:36mm;max-height:20mm;}
  .header .logo-placeholder{width:12mm;height:12mm;font-size:18px;}
  .header .store-name{font-size:12px;}
  .sep{margin:0 2mm;}
  .sep-solid{margin:0 2mm;}
  .body{padding:1mm 2mm;}
  .section-label{margin:4px 0 2px;}
  .total-box{padding:4px 6px;border-radius:4px;}
  .sisa-row .sl{font-size:12px;}
  .sisa-row .sr{font-size:15px;}
  .footer{padding:4px 2mm 2mm;}
  .btn-row{display:none!important;}
}
</style></head><body>
<div class="page">
  <div class="header">
    ${logoB64
        ? `<img src="${logoB64}" alt="logo"/>`
        : `<div class="logo-placeholder">${storeName.charAt(0).toUpperCase()}</div>`
    }
    <div class="store-name">${storeName}</div>
    ${storeAddr ? `<div class="store-sub">${storeAddr}</div>` : ''}
    ${storePhone ? `<div class="store-sub">üì± ${storePhone}</div>` : ''}
  </div>
  <hr class="sep-solid">
  <div style="text-align:center;padding:6px 0;">
    <span class="badge" style="background:#dbeafe;color:#1e40af;">STRUK SERVIS</span>
  </div>
  <hr class="sep">
  <div class="body">
    <div class="kv"><span class="k">No Token</span><span class="v">#${s.token||s.id||'-'}</span></div>
    <div class="kv"><span class="k">Tanggal</span><span class="v">${date} ${time}</span></div>

    <div class="section-label">Pelanggan</div>
    <div class="kv"><span class="k">Nama</span><span class="v">${s.customerName||'-'}</span></div>
    <div class="kv"><span class="k">Telp</span><span class="v">${s.customerPhone||s.phone||'-'}</span></div>

    <div class="section-label">Unit</div>
    ${s.deviceBrand ? `<div class="kv"><span class="k">Brand</span><span class="v">${s.deviceBrand}</span></div>` : ''}
    <div class="kv"><span class="k">Tipe</span><span class="v">${s.deviceModel||s.unitType||'-'}</span></div>
    <div class="kv"><span class="k">Status</span>
      <span class="v"><span style="background:${statusBg};color:${statusColor};padding:2px 8px;border-radius:12px;font-size:var(--fs-xs);font-weight:700;">${s.status||'-'}</span></span>
    </div>
    <div class="kv"><span class="k">Keluhan</span></div>
    <div class="keluhan-text">${s.problem||s.complaint||'-'}</div>

    <div class="section-label">Sparepart</div>
    <table class="parts">
      <thead><tr><th>Nama</th><th>Qty</th><th>Harga</th></tr></thead>
      <tbody>${partsRows}</tbody>
    </table>

    <div class="total-box">
      <div class="total-row"><span class="tl">Biaya Servis</span><span class="tr">${fmt(s.costEstimate)}</span></div>
      <div class="total-row"><span class="tl">DP</span><span class="tr" style="color:#16a34a;">- ${fmt(s.dp||0)}</span></div>
      <div class="sisa-row">
        <span class="sl">SISA BAYAR</span>
        <span class="sr">${fmt(sisa)}</span>
      </div>
    </div>
  </div>
  <div class="footer">
    Terima kasih atas kepercayaan Anda!<br>
    Simpan struk ini sebagai bukti servis<br>
    <span style="font-size:10px;color:#bbb;">Powered by iFix Pro</span>
  </div>
</div>
<div class="btn-row">
  <div class="status-msg" id="bt-status"></div>
  <button id="bt-btn" onclick="doCetakBluetooth()" style="flex:1;font-size:15px;padding:14px 8px;background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">üì∂ Cetak Bluetooth</button>
  <button onclick="window.print()" style="flex:1;font-size:15px;padding:14px 8px;background:#e2e8f0;color:#475569;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">üñ®Ô∏è Print</button>
  <button onclick="window.close()" style="font-size:15px;padding:14px 14px;background:#fee2e2;color:#dc2626;border:none;border-radius:10px;cursor:pointer;font-weight:bold;">‚úï</button>
</div>
<script>
var _svc = ${JSON.stringify({
    token: s.token, id: s.id, customerName: s.customerName, customerPhone: s.customerPhone, phone: s.phone,
    deviceBrand: s.deviceBrand||'', deviceModel: s.deviceModel||'', unitType: s.unitType||'',
    status: s.status, problem: s.problem||'', complaint: s.complaint||'',
    costEstimate: s.costEstimate||0, dp: s.dp||0, usedParts: s.usedParts||[], createdAt: s.createdAt
})};
var _storeName = ${JSON.stringify(storeName)};
var _storeAddr = ${JSON.stringify(storeAddr)};
var _storePhone = ${JSON.stringify(storePhone)};

function setStatus(msg,color){var el=document.getElementById('bt-status');if(el){el.textContent=msg;el.style.color=color||'#1e293b';}}
function setBusy(busy){var btn=document.getElementById('bt-btn');if(btn){btn.disabled=busy;btn.textContent=busy?'‚è≥ Mohon tunggu...':'üì∂ Cetak Bluetooth';}}

async function buildEscPosService(svc, storeName, storeAddr) {
  var T = new TextEncoder();
  var parts = [];
  var add = function(arr){parts.push(arr instanceof Uint8Array?arr:new Uint8Array(arr));};
  var text = function(s){parts.push(T.encode(String(s||'')));};
  var W = 32;
  var SEP  = '================================';
  var DASH = '--------------------------------';
  function center(s){s=String(s).substring(0,W);var pad=Math.floor((W-s.length)/2);return ' '.repeat(pad)+s;}
  function padR(s,n){s=String(s);return s.length>=n?s.substring(0,n):s+' '.repeat(n-s.length);}
  function padL(s,n){s=String(s);return s.length>=n?s.substring(0,n):' '.repeat(n-s.length)+s;}
  function lr(l,r){l=String(l);r=String(r);var sp=W-l.length-r.length;if(sp<1)sp=1;return l+' '.repeat(sp)+r;}
  function fmt(n){return 'Rp '+(n||0).toLocaleString('id-ID');}
  function fmtDate(d){if(!d)return'-';try{var dt=d&&d.seconds?new Date(d.seconds*1000):new Date(String(d).replace(' ','T'));return dt.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});}catch(e){return'-';}}
  function ln(s){text(s);add([0x0A]);}
  var sisa=Math.max(0,(svc.costEstimate||0)-(svc.dp||0));

  // INIT only - no ESC commands, pure text
  add([0x1B,0x40]);

  // Header
  ln(center(storeName.substring(0,W)));
  if(storeAddr){
    var words=storeAddr.split(' ');var line='';
    words.forEach(function(w){if((line+' '+w).trim().length>W){ln(center(line.trim()));line=w;}else{line=(line+' '+w).trim();}});
    if(line)ln(center(line));
  }
  if(typeof _storePhone!=='undefined'&&_storePhone){ln(center(_storePhone));}
  ln('');
  ln(center('STRUK SERVIS'));
  ln(SEP);
  ln(lr('No','#'+(svc.token||svc.id||'-')));
  ln(lr('Tgl',fmtDate(svc.createdAt)));
  ln(DASH);
  ln('PELANGGAN');
  ln(lr('Nama',(svc.customerName||'-').substring(0,W-6)));
  ln(lr('Telp',svc.customerPhone||svc.phone||'-'));
  ln(DASH);
  ln('UNIT');
  var brand=svc.deviceBrand||'';var model=svc.deviceModel||svc.unitType||'';
  var tipe=(brand&&model)?(brand+' '+model):(brand||model||'-');
  if(brand&&model){
    ln(lr('Brand',brand.substring(0,W-7)));
    ln(lr('Tipe',model.substring(0,W-6)));
  } else {
    ln(lr('Tipe',tipe.substring(0,W-6)));
  }
  ln(lr('Status',(svc.status||'-').substring(0,W-8)));
  ln('Keluhan:');
  var kel=svc.problem||svc.complaint||'-';
  for(var i=0;i<kel.length;i+=W-2){ln('  '+kel.substring(i,i+W-2));}
  ln(DASH);
  ln('SPAREPART');
  var usedP=svc.usedParts||[];
  if(usedP.length>0){
    usedP.forEach(function(p){
      ln(lr((p.name||'-').substring(0,W-6),'x'+(p.qty||1)));
    });
  } else { ln('  -'); }
  ln(DASH);
  ln(lr('Biaya',fmt(svc.costEstimate)));
  ln(lr('DP','-'+fmt(svc.dp||0)));
  ln(SEP);
  ln(lr('SISA BAYAR',fmt(sisa)));
  ln(SEP);
  ln(center('Terima kasih!'));
  ln(center('iFix Pro'));
  ln('');ln('');ln('');ln('');

  var total=0;parts.forEach(function(p){total+=p.length;});
  var buf=new Uint8Array(total);var off=0;
  parts.forEach(function(p){buf.set(p,off);off+=p.length;});
  return buf;
}

async function doCetakBluetooth() {
  if(!navigator.bluetooth){setStatus('Web Bluetooth tidak didukung browser ini','#dc2626');return;}
  setBusy(true);
  setStatus('Mencari printer...','#2563eb');
  try {
    var device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices:[
        '000018f0-0000-1000-8000-00805f9b34fb',
        'e7810a71-73ae-499d-8c15-faa9aef0c3f2',
        '0000ff00-0000-1000-8000-00805f9b34fb',
        '49535343-fe7d-4ae5-8fa9-9fafd205e455',
        '0000ff01-0000-1000-8000-00805f9b34fb',
        '0000ff02-0000-1000-8000-00805f9b34fb',
        'bef8d6c9-9c21-4c9e-b632-bd58c1009f9f',
      ]
    });
    setStatus('Connecting ke '+device.name+'...','#2563eb');
    var server = await device.gatt.connect();
    var svcs = await server.getPrimaryServices();
    var writeCh = null;
    for(var i=0;i<svcs.length;i++){
      try{
        var chars = await svcs[i].getCharacteristics();
        for(var j=0;j<chars.length;j++){
          if(chars[j].properties.writeWithoutResponse||chars[j].properties.write){writeCh=chars[j];break;}
        }
        if(writeCh)break;
      }catch(e){}
    }
    if(!writeCh){setStatus('‚ùå Characteristic tidak ditemukan','#dc2626');setBusy(false);return;}
    setStatus('Mencetak...','#16a34a');
    var data = await buildEscPosService(_svc, _storeName, _storeAddr);
    var chunk=100;
    for(var k=0;k<data.length;k+=chunk){
      var slice=data.slice(k,k+chunk);
      if(writeCh.properties.writeWithoutResponse) await writeCh.writeValueWithoutResponse(slice);
      else await writeCh.writeValue(slice);
      await new Promise(function(r){setTimeout(r,30);});
    }
    setStatus('‚úÖ Berhasil dicetak!','#16a34a');
  } catch(e) {
    if(e.name==='NotFoundError'){setStatus('Dibatalkan','#94a3b8');}
    else{setStatus('‚ùå Error: '+e.message,'#dc2626');}
  }
  setBusy(false);
}
<\/script>
</body></html>`;

            const popup = window.open('', '_blank');
            if (popup) {
                popup.document.write(html);
                popup.document.close();
            } else {
                alert('Popup diblokir. Izinkan popup untuk mencetak struk thermal.');
            }
        };

        // =============================================
        // üñ®Ô∏è PRINT MODAL ‚Äî pilih A4 biasa / thermal 58mm
        // =============================================
        const PrintModal = ({ s, store, allKelengkapanItems = [], allQCItems = [], onClose }) => {
            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[9999] flex items-end sm:items-center justify-center p-4"
                     onClick={(e) => { if (e.target === e.currentTarget) onClose(null); }}>
                    <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
                        {/* Header */}
                        <div className="flex items-center justify-between p-5 border-b border-slate-700">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-blue-600/20 rounded-xl flex items-center justify-center">
                                    <Printer className="w-5 h-5 text-blue-400" />
                                </div>
                                <div>
                                    <h3 className="font-bold text-white text-sm">Cetak Struk</h3>
                                    <p className="text-xs text-slate-400">#{s.token} ‚Äî {s.customerName}</p>
                                </div>
                            </div>
                            <button onClick={() => onClose(null)} className="text-slate-400 hover:text-white p-1">
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        <div className="p-5 space-y-3">
                            {/* Share ke App Printer */}
                            <button onClick={() => onClose('share')}
                                className="w-full flex items-center gap-4 p-4 bg-violet-700/30 hover:bg-violet-700/50 rounded-xl border border-violet-500/50 hover:border-violet-400 transition-all text-left active:scale-95">
                                <div className="w-11 h-11 bg-violet-600/30 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <Printer className="w-5 h-5 text-violet-300" />
                                </div>
                                <div className="flex-1">
                                    <p className="font-bold text-white text-sm">üì≤ Share ke App Printer</p>
                                    <p className="text-xs text-violet-300">Kirim langsung ke PrintHand / Xprinter / dsb</p>
                                </div>
                                <span className="text-[10px] text-violet-400 font-bold bg-violet-900/30 px-2 py-0.5 rounded-full flex-shrink-0">Baru</span>
                            </button>

                            {/* Cetak as Image ‚Äî 100% sesuai preview layar */}
                            <button onClick={() => onClose('image')}
                                className="w-full flex items-center gap-4 p-4 bg-emerald-700/30 hover:bg-emerald-700/50 rounded-xl border border-emerald-500/50 hover:border-emerald-400 transition-all text-left active:scale-95">
                                <div className="w-11 h-11 bg-emerald-600/30 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <Printer className="w-5 h-5 text-emerald-300" />
                                </div>
                                <div className="flex-1">
                                    <p className="font-bold text-white text-sm">üì∏ Print as Image (Thermal)</p>
                                    <p className="text-xs text-emerald-300">Anti-berantakan ¬∑ 100% sesuai preview layar</p>
                                </div>
                            </button>

                            {/* Cetak Thermal 58mm - UTAMA */}}
                            <button onClick={() => { printThermal58mm(s, store); onClose('thermal'); }}
                                className="w-full flex items-center gap-4 p-4 bg-blue-700/30 hover:bg-blue-700/50 rounded-xl border border-blue-500/50 hover:border-blue-400 transition-all text-left active:scale-95">
                                <div className="w-11 h-11 bg-blue-600/30 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <Printer className="w-5 h-5 text-blue-300" />
                                </div>
                                <div className="flex-1">
                                    <p className="font-bold text-white text-sm">üñ®Ô∏è Cetak Thermal 58mm</p>
                                    <p className="text-xs text-blue-300">Untuk printer Bluetooth / USB thermal</p>
                                </div>
                                <span className="text-[10px] text-emerald-400 font-bold bg-emerald-900/30 px-2 py-0.5 rounded-full flex-shrink-0">Rekomendasi</span>
                            </button>

                            {/* Cetak biasa A4 */}
                            <button onClick={() => onClose('regular')}
                                className="w-full flex items-center gap-4 p-4 bg-slate-700 hover:bg-slate-600 rounded-xl border border-slate-600 hover:border-slate-500 transition-all text-left active:scale-95">
                                <div className="w-11 h-11 bg-slate-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <Printer className="w-5 h-5 text-slate-300" />
                                </div>
                                <div>
                                    <p className="font-bold text-white text-sm">Cetak A4 (Invoice)</p>
                                    <p className="text-xs text-slate-400">Format invoice lengkap ukuran A4 / PDF</p>
                                </div>
                            </button>

                            <div className="pt-2 space-y-1">
                                <p className="text-[10px] text-slate-500 text-center leading-relaxed">
                                    <strong className="text-slate-400">üí° Tips:</strong> Untuk printer Bluetooth, pastikan printer sudah dipasangkan di <strong>Pengaturan Bluetooth</strong> HP dan install aplikasi printer (jika ada) agar muncul di daftar printer sistem.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Invoice = ({ s, store, allKelengkapanItems = [], allQCItems = [] }) => {
          const sisa = (s.costEstimate || 0) - (s.dp || 0);
          
          const getSelectedItems = (obj, allItems = []) => {
            if (!obj) return [];
            return Object.entries(obj).filter(([k, v]) => v === true).map(([k]) => {
              const found = allItems.find(item => item.name.toLowerCase().replace(/\s+/g, '_') === k);
              return found ? found.name : k.replace(/_/g, ' ');
            });
          };
          
          const kelengkapanList = getSelectedItems(s.kelengkapan, allKelengkapanItems);
          const qcFunctionalList = getSelectedItems(s.qcFunctional, allQCItems);
          
          return (
            <div className="w-[80mm] mx-auto bg-white text-slate-800 shadow-xl" style={{ fontFamily: 'Inter, sans-serif', overflow: 'visible' }}>
                {/* Header */}
                <div style={{background:'#fff', padding:'20px 20px 18px', textAlign:'center'}}>
                    {/* Logo tengah */}
                    <div style={{display:'flex', justifyContent:'center', marginBottom:'10px'}}>
                        {store?.logo
                            ? <img src={store.logo} alt="Logo" style={{maxWidth:'100%', maxHeight:'64px', objectFit:'contain', display:'block'}} />
                            : <div style={{width:'56px', height:'56px', background:'linear-gradient(135deg,#3b82f6,#1d4ed8)', borderRadius:'10px', display:'flex', alignItems:'center', justifyContent:'center', color:'#fff', fontWeight:900, fontSize:'26px'}}>{store?.name?.[0]?.toUpperCase() || 'i'}</div>
                        }
                    </div>
                    {/* Info toko */}
                    <h2 style={{fontWeight:900, color:'#1e293b', fontSize:'14px', textTransform:'uppercase', letterSpacing:'0.05em', lineHeight:1.3, margin:0}}>{store?.name || 'iFix Pro'}</h2>
                    {store?.address && <p style={{fontSize:'10px', color:'#64748b', lineHeight:1.5, marginTop:'4px', whiteSpace:'pre-wrap', wordBreak:'break-word'}}>{store.address}</p>}
                    {store?.phone && (
                        <p style={{marginTop:'6px', fontSize:'11px', color:'#64748b', textAlign:'center'}}>üìû {store.phone}</p>
                    )}
                </div>
                {/* Separator */}
                <div style={{height:'2px', background:'#1e293b', margin:'0'}}></div>
                
                <div style={{padding:'20px'}}>
                {/* Customer & Invoice Info */}
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-end', marginBottom:'16px'}}>
                    <div>
                        <p style={{fontSize:'10px', color:'#94a3b8', textTransform:'uppercase', fontWeight:700, letterSpacing:'0.05em', margin:0}}>Kepada</p>
                        <h3 style={{fontWeight:700, fontSize:'14px', color:'#1e293b', margin:'2px 0 0'}}>{s.customerName}</h3>
                        {(s.customerPhone || s.phone) && (
                            <p style={{fontSize:'10px', color:'#64748b', margin:'2px 0 0'}}>{s.customerPhone || s.phone}</p>
                        )}
                    </div>
                    <div style={{textAlign:'right'}}>
                        <p style={{fontSize:'10px', color:'#94a3b8', textTransform:'uppercase', fontWeight:700, letterSpacing:'0.05em', margin:0}}>Invoice</p>
                        <h3 style={{fontWeight:700, fontSize:'14px', color:'#2563eb', margin:'2px 0 0'}}>#{s.token}</h3>
                        <p style={{fontSize:'10px', color:'#64748b', margin:'2px 0 0'}}>{formatDate(s.createdAt)}</p>
                    </div>
                </div>
                
                {/* Unit & Status Info */}
                <div style={{background:'#f8fafc', padding:'12px', borderRadius:'8px', border:'1px solid #e2e8f0', marginBottom:'16px'}}>
                    {(s.deviceBrand) && (
                        <div style={{display:'flex', justifyContent:'space-between', fontSize:'12px', marginBottom:'4px'}}>
                            <span style={{color:'#64748b', fontWeight:500}}>Brand</span>
                            <span style={{fontWeight:700, color:'#334155'}}>{s.deviceBrand}</span>
                        </div>
                    )}
                    <div style={{display:'flex', justifyContent:'space-between', fontSize:'12px', marginBottom:'4px'}}>
                        <span style={{color:'#64748b', fontWeight:500}}>Tipe</span>
                        <span style={{fontWeight:700, color:'#334155'}}>{s.deviceModel || s.unitType || '-'}</span>
                    </div>
                    <div style={{display:'flex', justifyContent:'space-between', fontSize:'12px', marginBottom:'4px'}}>
                        <span style={{color:'#64748b', fontWeight:500}}>Status</span>
                        <span style={{fontWeight:700, color:'#334155'}}>{s.status}</span>
                    </div>
                    <div style={{display:'flex', justifyContent:'space-between', fontSize:'12px'}}>
                        <span style={{color:'#64748b', fontWeight:500}}>Keluhan</span>
                        <span style={{fontWeight:600, color:'#334155', textAlign:'right', maxWidth:'55%', fontSize:'10px', wordBreak:'break-word'}}>{s.problem || s.complaint}</span>
                    </div>
                </div>
                
                {/* Sparepart List */}
                <div style={{marginBottom:'16px'}}>
                    <h3 style={{fontWeight:700, fontSize:'11px', color:'#1e293b', textTransform:'uppercase', letterSpacing:'0.05em', marginBottom:'8px', paddingBottom:'4px', borderBottom:'1px solid #e2e8f0'}}>Sparepart</h3>
                    {s.usedParts && s.usedParts.length > 0 ? (
                        <table style={{width:'100%', fontSize:'12px', borderCollapse:'collapse'}}>
                            <tbody>
                                {s.usedParts.map((p, i) => (
                                    <tr key={i} style={{borderBottom:'1px solid #f1f5f9'}}>
                                        <td style={{padding:'6px 0', color:'#334155'}}>{p.name}</td>
                                        <td style={{padding:'6px 0', textAlign:'right', color:'#64748b', fontSize:'10px', whiteSpace:'nowrap', paddingLeft:'8px'}}>x{p.qty}</td>
                                        {i === 0 && (s.warrantyDays || s.warranty) && (
                                            <td rowSpan={s.usedParts.length} style={{padding:'6px 0 6px 12px', textAlign:'right', whiteSpace:'nowrap', verticalAlign:'middle'}}>
                                                <span style={{fontSize:'9px', color:'#94a3b8', display:'block', textTransform:'uppercase', letterSpacing:'0.05em'}}>Garansi</span>
                                                <span style={{fontSize:'11px', fontWeight:700, color:'#334155'}}>{s.warrantyDays || s.warranty} Hari</span>
                                            </td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    ) : (
                        <p style={{fontSize:'12px', color:'#94a3b8', fontStyle:'italic'}}>-</p>
                    )}
                </div>
                
                {/* Kelengkapan Section */}
                {allKelengkapanItems.length > 0 && (
                    <div style={{marginBottom:'12px', borderBottom:'1px solid #e2e8f0', paddingBottom:'8px'}}>
                        <h3 style={{fontWeight:700, fontSize:'11px', color:'#1e293b', marginBottom:'4px', textTransform:'uppercase'}}>‚òë Kelengkapan</h3>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'2px 8px', fontSize:'8px'}}>
                            {allKelengkapanItems.map((item, i) => {
                              const isSelected = kelengkapanList.includes(item.name);
                              return (
                                <div key={i} style={{display:'flex', alignItems:'center'}}>
                                    <span style={{fontWeight:700, marginRight:'4px', color: isSelected ? '#0891b2' : '#cbd5e1'}}>{isSelected ? '‚òë' : '‚òê'}</span>
                                    <span style={{color: isSelected ? '#334155' : '#94a3b8', fontWeight: isSelected ? 500 : 400}}>{item.name}</span>
                                </div>
                              );
                            })}
                        </div>
                    </div>
                )}
                
                {/* QC Cek Fungsional Section */}
                {allQCItems.length > 0 && (
                    <div style={{marginBottom:'16px', borderBottom:'1px solid #e2e8f0', paddingBottom:'8px'}}>
                        <h3 style={{fontWeight:700, fontSize:'11px', color:'#1e293b', marginBottom:'4px', textTransform:'uppercase'}}>‚òë QC Cek</h3>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'2px 8px', fontSize:'8px'}}>
                            {allQCItems.map((item, i) => {
                              const isSelected = qcFunctionalList.includes(item.name);
                              return (
                                <div key={i} style={{display:'flex', alignItems:'center'}}>
                                    <span style={{fontWeight:700, marginRight:'4px', color: isSelected ? '#16a34a' : '#cbd5e1'}}>{isSelected ? '‚òë' : '‚òê'}</span>
                                    <span style={{color: isSelected ? '#334155' : '#94a3b8', fontWeight: isSelected ? 500 : 400}}>{item.name}</span>
                                </div>
                              );
                            })}
                        </div>
                    </div>
                )}
                
                {/* Sisa Tagihan */}
                <div style={{borderTop:'1px solid #e2e8f0', paddingTop:'16px', marginBottom:'12px'}}>
                    <div style={{display:'flex', justifyContent:'space-between', fontSize:'12px', marginBottom:'8px'}}>
                        <span style={{color:'#64748b', fontWeight:500}}>Subtotal</span>
                        <span style={{fontWeight:700, color:'#334155'}}>{formatCurrency(s.costEstimate)}</span>
                    </div>
                    <div style={{display:'flex', justifyContent:'space-between', fontSize:'12px', marginBottom:'8px'}}>
                        <span style={{color:'#64748b', fontWeight:500}}>Pembayaran (DP/Lunas)</span>
                        <span style={{fontWeight:700, color:'#16a34a'}}>-{formatCurrency(s.dp)}</span>
                    </div>
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', paddingTop:'10px', borderTop:'2px solid #1e293b', marginTop:'4px'}}>
                        <span style={{fontSize:'14px', fontWeight:800, color:'#1e293b'}}>Sisa Tagihan</span>
                        <span style={{fontSize:'20px', fontWeight:900, color: sisa > 0 ? '#dc2626' : '#16a34a'}}>{formatCurrency(sisa < 0 ? 0 : sisa)}</span>
                    </div>
                </div>

                {/* Footer */}
                <div style={{textAlign:'center', borderTop:'1px solid #f1f5f9', paddingTop:'12px', paddingBottom:'4px'}}>
                    <p style={{fontSize:'10px', color:'#94a3b8', margin:0}}>Terima kasih telah mempercayakan servis kepada kami.</p>
                </div>
                </div>{/* end padding wrapper */}
            </div>
          );
        };
        
        const FinanceManager = () => { 
            const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
            
            // State untuk filter bulan (default: bulan saat ini)
            const now = new Date();
            const defaultMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const [selectedMonth, setSelectedMonth] = useState(defaultMonth);
            
            // ‚úÖ FIXED: Load transactions hanya untuk cabang aktif (bukan semua cabang)
            const { data: allTransactions } = useFirestoreCollection('transactions', activeOwner?.id, activeStore?.id);
            const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
            
            // Filter transactions by selectedMonth di client-side
            const transactions = useMemo(() => {
                if (!selectedMonth) return allTransactions;
                
                const [year, month] = selectedMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59, 999);
                
                return allTransactions.filter(t => {
                    const tDate = t.createdAt?.seconds 
                        ? new Date(t.createdAt.seconds * 1000) 
                        : (t.date?.seconds ? new Date(t.date.seconds * 1000) : null);
                    
                    if (!tDate) return false;
                    return tDate >= startDate && tDate <= endDate;
                });
            }, [allTransactions, selectedMonth]);
            
            const [editModal, setEditModal] = useState(null);
            const [expenseModal, setExpenseModal] = useState(false);
            const [expenseCashAccount, setExpenseCashAccount] = useState('Kas Tunai');
            const [detailModal, setDetailModal] = useState(null);
            const [filter, setFilter] = useState('today');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            
            const canEdit = checkPermission('feature_finance_edit');

            if (!checkPermission('menu_finance')) return <div className="p-20 text-center text-slate-400 flex flex-col items-center"><Lock className="w-12 h-12 mb-4 text-slate-300"/>Akses Menu Keuangan Dikunci oleh Developer</div>;

            // Filter transactions by date
            const getFilteredTrans = (trans, f) => {
                if (f === 'all') return trans;
                const now = new Date();
                return trans.filter(t => {
                    if (!t.date && !t.createdAt) return true; // Jika tidak ada tanggal, tetap tampilkan
                    const tDate = t.date?.toDate?.() || (t.date ? new Date(t.date) : null) || (t.createdAt?.seconds ? new Date(t.createdAt.seconds * 1000) : null);
                    if (!tDate) return true;
                    if (f === 'today') return tDate.toDateString() === now.toDateString();
                    if (f === 'month') return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                    if (f === 'year') return tDate.getFullYear() === now.getFullYear();
                    return true;
                });
            };
            
            const filteredTrans = getFilteredTrans(transactions, filter);
            
            // Pagination logic
            const totalItems = filteredTrans.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTrans = filteredTrans.slice(startIndex, endIndex);
            
            // Reset to page 1 when filter changes
            useEffect(() => {
                setCurrentPage(1);
            }, [filter]);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    setCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const handleItemsPerPageChange = (value) => {
                setItemsPerPage(value);
                setCurrentPage(1);
            };

            // Calculate summary by type
            const totalExpense = filteredTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalIncome = filteredTrans.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalProfit = filteredTrans.filter(t => t.type === 'profit').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalLoss = filteredTrans.filter(t => t.type === 'loss').reduce((sum, t) => sum + (t.amount || 0), 0);
            const netProfit = totalIncome - totalExpense;
            
            // Debug log untuk troubleshooting - lebih detail
            useEffect(() => {
                console.log('üí∞ Finance Data Debug:', {
                    rawTransactions: transactions.length,
                    filteredCount: filteredTrans.length,
                    expense: { count: filteredTrans.filter(t => t.type === 'expense').length, total: totalExpense },
                    income: { count: filteredTrans.filter(t => t.type === 'income').length, total: totalIncome },
                    profit: { count: filteredTrans.filter(t => t.type === 'profit').length, total: totalProfit },
                    loss: { count: filteredTrans.filter(t => t.type === 'loss').length, total: totalLoss },
                    filter: filter,
                    activeOwner: activeOwner?.id,
                    transactions: transactions.slice(0, 3) // Sample 3 transactions
                });
            }, [transactions, filter]);

            const deleteTransaction = async (t) => {
                if(!confirm(`Hapus transaksi ${t.description}? \nJika ini pembayaran servis, data servis akan disinkronkan.`)) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'transactions', t.id));
                    if(t.serviceId) {
                        await recalculateServicePayment(t.serviceId, activeOwner.id);
                    }
                    alert("Transaksi dihapus.");
                } catch(e) {
                    alert("Gagal hapus: " + e.message);
                }
            };

            const updateTransaction = async (e) => {
                e.preventDefault();
                const amount = parseFloat(e.target.amount.value);
                const desc = e.target.description.value;
                try {
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'transactions', editModal.id), {
                        amount: amount,
                        description: desc
                    });
                    if(editModal.serviceId) {
                        await recalculateServicePayment(editModal.serviceId, activeOwner.id);
                    }
                    setEditModal(null);
                    alert("Transaksi diperbarui.");
                } catch(e) {
                    alert("Gagal update: " + e.message);
                }
            };
            
            const addExpense = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'expense',
                        category: 'Pengeluaran Operasional',
                        description: formData.get('description'),
                        amount: parseFloat(formData.get('amount')),
                        date: serverTimestamp(),
                        cashAccount: formData.get('cashAccount') || expenseCashAccount || 'Kas Tunai'
                    });
                    setExpenseModal(false);
                    setExpenseCashAccount('Kas Tunai');
                    e.target.reset();
                } catch(e) { alert("Error: " + e.message); }
            };

            return (
                <div className="space-y-6">
                  <div className="flex justify-between items-center gap-4 flex-wrap">
                    <h2 className="font-bold text-2xl">Keuangan</h2>
                    <div className="flex gap-2 items-center">
                        {/* Month Picker untuk hemat quota */}
                        <div className="bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 flex items-center gap-2">
                            <Calendar className="w-4 h-4 text-blue-600"/>
                            <input 
                                type="month" 
                                value={selectedMonth} 
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                className="text-sm font-bold text-blue-700 bg-transparent border-none outline-none cursor-pointer"
                                max={defaultMonth}
                            />
                        </div>
                        <div className="bg-white border border-slate-200 rounded-lg p-1 flex">
                            {[{id:'today',l:'Hari Ini'},{id:'month',l:'Bulan Ini'},{id:'year',l:'Tahun Ini'},{id:'all',l:'Semua'}].map(f => (
                                <button key={f.id} onClick={()=>setFilter(f.id)} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${filter === f.id ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-100'}`}>{f.l}</button>
                            ))}
                        </div>
                    </div>
                    <button onClick={()=>setExpenseModal(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-700 flex items-center gap-2 shadow-lg"><MinusCircle className="w-4 h-4"/> Catat Pengeluaran</button>
                  </div>

                  {/* Summary Cards */}
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button onClick={() => setDetailModal({type: 'expense', title: 'Pengeluaran (Modal)', data: filteredTrans.filter(t => t.type === 'expense')})} className="bg-red-50 border border-red-200 rounded-xl p-6 text-left hover:bg-red-100 hover:shadow-lg transition-all cursor-pointer">
                        <div className="text-red-600 text-sm font-bold uppercase mb-2">Pengeluaran (Modal)</div>
                        <div className="text-3xl font-bold text-red-600">{formatCurrency(totalExpense)}</div>
                        <div className="text-xs text-red-500 mt-2">{filteredTrans.filter(t => t.type === 'expense').length} transaksi ‚Ä¢ Klik untuk detail</div>
                    </button>
                    <button onClick={() => setDetailModal({type: 'income', title: 'Pemasukan (Penjualan)', data: filteredTrans.filter(t => t.type === 'income')})} className="bg-green-50 border border-green-200 rounded-xl p-6 text-left hover:bg-green-100 hover:shadow-lg transition-all cursor-pointer">
                        <div className="text-green-600 text-sm font-bold uppercase mb-2">Pemasukan (Penjualan)</div>
                        <div className="text-3xl font-bold text-green-600">{formatCurrency(totalIncome)}</div>
                        <div className="text-xs text-green-500 mt-2">{filteredTrans.filter(t => t.type === 'income').length} transaksi ‚Ä¢ Klik untuk detail</div>
                    </button>
                    <button onClick={() => setDetailModal({type: 'profit', title: 'Keuntungan', data: filteredTrans.filter(t => t.type === 'profit')})} className="bg-blue-50 border border-blue-200 rounded-xl p-6 text-left hover:bg-blue-100 hover:shadow-lg transition-all cursor-pointer">
                        <div className="text-blue-600 text-sm font-bold uppercase mb-2">Keuntungan</div>
                        <div className="text-3xl font-bold text-blue-600">{formatCurrency(totalProfit)}</div>
                        <div className="text-xs text-blue-500 mt-2">{filteredTrans.filter(t => t.type === 'profit').length} transaksi ‚Ä¢ Klik untuk detail</div>
                    </button>
                    <button onClick={() => setDetailModal({type: 'net', title: 'Bersih (Pemasukan - Pengeluaran)', data: [...filteredTrans.filter(t => t.type === 'income'), ...filteredTrans.filter(t => t.type === 'expense')]})} className={`border rounded-xl p-6 text-left hover:shadow-lg transition-all cursor-pointer ${netProfit >= 0 ? 'bg-emerald-50 border-emerald-200 hover:bg-emerald-100' : 'bg-amber-50 border-amber-200 hover:bg-amber-100'}`}>
                        <div className={`text-sm font-bold uppercase mb-2 ${netProfit >= 0 ? 'text-emerald-600' : 'text-amber-600'}`}>Bersih (Pemasukan - Pengeluaran)</div>
                        <div className={`text-3xl font-bold ${netProfit >= 0 ? 'text-emerald-600' : 'text-amber-600'}`}>{formatCurrency(Math.abs(netProfit))}</div>
                        <div className={`text-xs mt-2 ${netProfit >= 0 ? 'text-emerald-500' : 'text-amber-500'}`}>{netProfit >= 0 ? '‚úÖ Untung' : '‚ö†Ô∏è Rugi'} ‚Ä¢ Klik untuk detail</div>
                    </button>
                  </div>

                  {/* Transactions Table */}
                  <div className="bg-white rounded shadow overflow-hidden overflow-x-auto">
                      <table className="w-full text-sm text-left"><thead className="bg-gray-50"><tr><th className="p-3">Tgl</th><th className="p-3">Jenis</th><th className="p-3">Ket</th><th className="p-3 text-right">Jml</th><th className="p-3 text-center">Aksi</th></tr></thead>
                      <tbody className="divide-y">{paginatedTrans.map((t,i) => {
                          let typeColor = 'text-slate-600';
                          let typeLabel = t.type;
                          if(t.type === 'expense') { typeColor = 'text-red-600'; typeLabel = '‚ùå Pengeluaran'; }
                          else if(t.type === 'income') { typeColor = 'text-green-600'; typeLabel = '‚úÖ Pemasukan'; }
                          else if(t.type === 'profit') { typeColor = 'text-blue-600'; typeLabel = 'üìà Keuntungan'; }
                          else if(t.type === 'loss') { typeColor = 'text-amber-600'; typeLabel = 'üìâ Rugi'; }
                          return (
                          <tr key={i}>
                              <td className="p-3 text-gray-500">{formatDate(t.date)}</td>
                              <td className={`p-3 font-bold text-sm ${typeColor}`}>{typeLabel}</td>
                              <td className="p-3">
                                  <div className="font-medium">{t.category}</div>
                                  <div className="text-xs text-gray-400">{t.description}</div>
                                  {t.serviceId && <span className="text-[9px] bg-blue-50 text-blue-600 px-1 rounded border border-blue-100">Linked Service</span>}
                              </td>
                              <td className={`p-3 text-right font-bold text-sm`}>{formatCurrency(t.amount)}</td>
                              <td className="p-3 text-center">
                                  {canEdit ? (
                                      <div className="flex justify-center gap-2">
                                          <button onClick={()=>setEditModal(t)} className="text-blue-500 hover:bg-blue-50 p-1 rounded"><Pencil className="w-4 h-4"/></button>
                                          <button onClick={()=>deleteTransaction(t)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Trash2 className="w-4 h-4"/></button>
                                      </div>
                                  ) : (
                                      <span className="text-xs text-slate-300 italic">Locked</span>
                                  )}
                              </td>
                          </tr>
                          );
                      })}</tbody></table>
                      {paginatedTrans.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada transaksi.</div>}
                  </div>
                  
                  {/* Pagination Controls */}
                  <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                      <div className="flex items-center gap-3">
                          <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                          <div className="flex gap-2">
                              <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                              <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                          </div>
                      </div>
                      <div className="text-sm text-slate-600 font-medium">
                          Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                      </div>
                  </div>
                  
                  {/* Pagination Navigation */}
                  {totalPages > 1 && (
                      <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                          <button 
                              onClick={() => handlePageChange(currentPage - 1)} 
                              disabled={currentPage === 1}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              ‚Üê Sebelumnya
                          </button>
                          <div className="text-sm text-slate-600 font-medium">
                              Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                          </div>
                          <button 
                              onClick={() => handlePageChange(currentPage + 1)} 
                              disabled={currentPage === totalPages}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              Selanjutnya ‚Üí
                          </button>
                      </div>
                  )}

                  {expenseModal && (
                      <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                          <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl">
                              <h3 className="font-bold text-lg mb-4 text-red-600 flex items-center gap-2"><ArrowDownRight className="w-5 h-5"/> Catat Pengeluaran</h3>
                              <form onSubmit={addExpense} className="space-y-4">
                                  <div><label className="text-xs font-bold text-slate-500">Keterangan</label><input name="description" placeholder="Contoh: Bayar Listrik, Beli Kopi" className="w-full border p-2 rounded" required/></div>
                                  <div><label className="text-xs font-bold text-slate-500">Jumlah (Rp)</label><NumberInput name="amount" className="w-full border p-2 rounded font-bold" required/></div>
                                  <CashAccountSelect value={expenseCashAccount} onChange={setExpenseCashAccount} label="Keluar dari Kas" />
                                  <div className="flex gap-2 pt-2">
                                      <button type="button" onClick={()=>setExpenseModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                      <button className="flex-1 bg-red-600 text-white p-2 rounded font-bold">Simpan</button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  )}

                  {editModal && (
                      <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                          <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl">
                              <h3 className="font-bold text-lg mb-4">Edit Transaksi</h3>
                              <form onSubmit={updateTransaction} className="space-y-4">
                                  <div><label className="text-xs font-bold text-slate-500">Keterangan</label><input name="description" defaultValue={editModal.description} className="w-full border p-2 rounded" required/></div>
                                  <div><label className="text-xs font-bold text-slate-500">Jumlah (Rp)</label><NumberInput name="amount" defaultValue={editModal.amount} className="w-full border p-2 rounded font-bold" required/></div>
                                  <div className="flex gap-2 pt-2">
                                      <button type="button" onClick={()=>setEditModal(null)} className="flex-1 border p-2 rounded">Batal</button>
                                      <button className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  )}
                  
                  {detailModal && (
                      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                          <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
                              <div className="flex justify-between items-center border-b border-slate-200 p-6 bg-gradient-to-r from-slate-50 to-slate-100">
                                  <div>
                                      <h3 className="font-bold text-2xl text-slate-800">{detailModal.title}</h3>
                                      <p className="text-xs text-slate-500 mt-1">
                                          {detailModal.type === 'expense' && 'üí∏ Semua transaksi pengeluaran & modal'}
                                          {detailModal.type === 'income' && 'üí∞ Semua transaksi pemasukan'}
                                          {detailModal.type === 'profit' && 'üìà Semua transaksi keuntungan'}
                                          {detailModal.type === 'net' && 'üìä Perhitungan pemasukan dikurangi pengeluaran'}
                                      </p>
                                  </div>
                                  <button onClick={() => setDetailModal(null)} className="p-2 hover:bg-slate-200 rounded-lg transition-all"><X className="w-6 h-6 text-slate-600" /></button>
                              </div>
                              
                              <div className="overflow-y-auto flex-1 p-6">
                                  {detailModal.data.length === 0 ? (
                                      <div className="text-center py-12 text-slate-400">
                                          <FileText className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                                          <p>Tidak ada transaksi</p>
                                      </div>
                                  ) : (
                                      <div className="space-y-3">
                                          {detailModal.data.map((t, idx) => {
                                              const isExpense = t.type === 'expense';
                                              const isIncome = t.type === 'income';
                                              const isProfit = t.type === 'profit';
                                              const bgColor = isExpense ? 'bg-red-50 border-red-200' : isIncome ? 'bg-green-50 border-green-200' : isProfit ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-200';
                                              const textColor = isExpense ? 'text-red-700' : isIncome ? 'text-green-700' : isProfit ? 'text-blue-700' : 'text-slate-700';
                                              const relatedService = services.find(s => s.id === t.serviceId);
                                              
                                              return (
                                                  <div key={idx} className={`border rounded-xl p-4 ${bgColor} hover:shadow-md transition-all`}>
                                                      <div className="flex justify-between items-start mb-2">
                                                          <div className="flex-1">
                                                              <div className="flex items-center gap-2 mb-1">
                                                                  {isExpense && <span className="text-red-600 font-bold text-xs bg-red-100 px-2 py-0.5 rounded">‚ùå KELUAR</span>}
                                                                  {isIncome && <span className="text-green-600 font-bold text-xs bg-green-100 px-2 py-0.5 rounded">‚úÖ MASUK</span>}
                                                                  {isProfit && <span className="text-blue-600 font-bold text-xs bg-blue-100 px-2 py-0.5 rounded">üìà PROFIT</span>}
                                                                  {t.type === 'loss' && <span className="text-amber-600 font-bold text-xs bg-amber-100 px-2 py-0.5 rounded">üìâ LOSS</span>}
                                                                  <span className="text-[10px] text-slate-400">{formatDate(t.date || t.createdAt)}</span>
                                                              </div>
                                                              <h4 className={`font-bold text-sm ${textColor} mb-1`}>{t.category}</h4>
                                                              <p className="text-xs text-slate-600">{t.description}</p>
                                                              {t.serviceId && <span className="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded border border-blue-100 inline-block mt-1">üîó Linked Service</span>}
                                                              
                                                              {/* Sparepart Info */}
                                                              {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                                  <div className="bg-white/80 p-3 rounded-lg mt-3 border border-purple-100">
                                                                      <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart yang Digunakan:</p>
                                                                      <div className="flex flex-wrap gap-2">
                                                                          {relatedService.usedParts.map((part, pidx) => {
                                                                              const profit = (part.sellPrice - part.buyPrice) * part.qty;
                                                                              return (
                                                                              <div key={pidx} className="bg-purple-50 border border-purple-200 rounded-md px-2 py-1.5 text-[10px]">
                                                                                  <div className="font-bold text-purple-700">{part.name} x{part.qty}</div>
                                                                                  {isExpense && <div className="text-red-600">Modal: {formatCurrency(part.buyPrice * part.qty)}</div>}
                                                                                  {isIncome && <div className="text-green-600">Jual: {formatCurrency(part.sellPrice * part.qty)}</div>}
                                                                                  {isProfit && <div className="text-blue-600">Profit: {formatCurrency(profit)}</div>}
                                                                              </div>
                                                                              );
                                                                          })}
                                                                      </div>
                                                                  </div>
                                                              )}
                                                          </div>
                                                          <div className={`text-right font-bold text-lg ${textColor}`}>
                                                              {formatCurrency(t.amount)}
                                                          </div>
                                                      </div>
                                                  </div>
                                              );
                                          })}
                                          
                                          <div className="mt-6 pt-4 border-t-2 border-slate-200">
                                              <div className="flex justify-between items-center bg-gradient-to-r from-slate-100 to-slate-50 p-4 rounded-xl">
                                                  <span className="font-bold text-slate-700">TOTAL {detailModal.title.toUpperCase()}</span>
                                                  <span className="font-bold text-2xl text-slate-800">
                                                      {formatCurrency(detailModal.data.reduce((sum, t) => {
                                                          if (detailModal.type === 'net') {
                                                              return sum + (t.type === 'income' ? t.amount : -t.amount);
                                                          }
                                                          return sum + (t.amount || 0);
                                                      }, 0))}
                                                  </span>
                                              </div>
                                          </div>
                                      </div>
                                  )}
                              </div>
                              
                              <div className="border-t border-slate-200 p-4 bg-slate-50">
                                  <button onClick={() => setDetailModal(null)} className="w-full py-3 bg-slate-600 text-white rounded-xl font-bold hover:bg-slate-700 transition-all">
                                      Tutup
                                  </button>
                              </div>
                          </div>
                      </div>
                  )}
                </div>
            ); 
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AFTER SALES CARE - WhatsApp Follow-Up Dashboard
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ‚îÄ‚îÄ SVG Icons untuk AfterSalesCare ‚îÄ‚îÄ
        const WhatsAppIcon = ({ className = 'w-5 h-5' }) => (
          <svg viewBox="0 0 24 24" fill="currentColor" className={className}>
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
          </svg>
        );

        // ‚îÄ‚îÄ Helper: Format nomor telepon Indonesia ‚Üí format wa.me ‚îÄ‚îÄ
        function formatPhoneForWA(phone) {
          if (!phone) return '';
          let cleaned = phone.replace(/[\s\-\(\)]/g, '');
          if (cleaned.startsWith('+')) cleaned = cleaned.slice(1);
          if (cleaned.startsWith('0')) cleaned = '62' + cleaned.slice(1);
          if (!cleaned.startsWith('62')) cleaned = '62' + cleaned;
          return cleaned;
        }

        // ‚îÄ‚îÄ Helper: Normalisasi Firestore Timestamp / string / Date ‚Üí Date object ‚îÄ‚îÄ
        function toJsDate(val) {
          if (!val) return null;
          if (val && typeof val === 'object' && typeof val.toDate === 'function') return val.toDate();
          if (val && typeof val === 'object' && val.seconds) return new Date(val.seconds * 1000);
          const d = new Date(val);
          return isNaN(d.getTime()) ? null : d;
        }

        // ‚îÄ‚îÄ Helper: Hitung tanggal berakhir garansi ‚îÄ‚îÄ
        function getWarrantyEndDate(completedAt, warrantyDays) {
          if (!completedAt || !warrantyDays) return null;
          const completed = toJsDate(completedAt);
          if (!completed) return null;
          const end = new Date(completed);
          end.setDate(end.getDate() + Number(warrantyDays));
          return end;
        }

        // ‚îÄ‚îÄ Helper: Format tanggal ke Bahasa Indonesia ‚îÄ‚îÄ
        function formatDateAfterSales(date) {
          if (!date) return '-';
          const d = toJsDate(date);
          if (!d) return '-';
          return d.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
        }

        // ‚îÄ‚îÄ Helper: Hitung sisa hari ‚îÄ‚îÄ
        function daysUntil(targetDate) {
          if (!targetDate) return Infinity;
          const now = new Date(); now.setHours(0,0,0,0);
          const target = new Date(targetDate); target.setHours(0,0,0,0);
          return Math.ceil((target - now) / (1000 * 60 * 60 * 24));
        }

        // ‚îÄ‚îÄ Skeleton Loader Row ‚îÄ‚îÄ
        const ASCSkeletonRow = () => (
          <tr className="animate-pulse">
            {[...Array(6)].map((_, i) => (<td key={i} className="px-4 py-3"><div className="h-4 bg-slate-200 rounded w-3/4" /></td>))}
          </tr>
        );

        // ‚îÄ‚îÄ Definisi opsi filter garansi ‚îÄ‚îÄ
        const WARRANTY_FILTER_OPTIONS = [
          { value: 'smart',    label: 'üéØ Smart Filter',       desc: 'Garansi 0‚Äì7 hari + ~30 hari lalu' },
          { value: 'all',      label: 'üìã Semua Data',         desc: 'Tampilkan semua servis selesai' },
          { value: 'expired',  label: 'üî¥ Sudah Expired',      desc: 'Garansi sudah habis' },
          { value: 'today',    label: 'üü† Hari ini / Besok',   desc: 'Sisa 0‚Äì1 hari' },
          { value: '1-3',      label: 'üü° 1‚Äì3 Hari Lagi',      desc: 'Sisa 1 s/d 3 hari' },
          { value: '4-7',      label: 'üü¢ 4‚Äì7 Hari Lagi',      desc: 'Sisa 4 s/d 7 hari' },
          { value: '8-14',     label: 'üîµ 8‚Äì14 Hari Lagi',     desc: 'Sisa 8 s/d 14 hari' },
          { value: '15-30',    label: 'üîµ 15‚Äì30 Hari Lagi',    desc: 'Sisa 15 s/d 30 hari' },
          { value: '31-60',    label: '‚ö™ 31‚Äì60 Hari Lagi',    desc: 'Sisa 31 s/d 60 hari' },
          { value: '30d-ago',  label: 'üìÖ ~30 Hari Lalu',      desc: 'Selesai 28‚Äì32 hari yang lalu' },
        ];

        const AfterSalesCare = () => {
          const { activeOwner, activeStore } = useContext(SessionContext);
          const { data: allServices, loading: servicesLoading } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
          const { data: allCustomers } = useFirestoreCollection('customers', activeOwner?.id, activeStore?.id);
          const [searchQuery, setSearchQuery] = useState('');
          const [warrantyFilter, setWarrantyFilter] = useState('smart');
          const [contactFilter, setContactFilter] = useState('all');   // all | sent | unsent
          const [sortBy, setSortBy] = useState('warranty_asc');         // warranty_asc | warranty_desc | name | date_desc
          const [showFilterPanel, setShowFilterPanel] = useState(false);
          const [sentIds, setSentIds] = useState(() => {
            try { return JSON.parse(localStorage.getItem('afterSalesSent') || '[]'); } catch { return []; }
          });

          // ‚îÄ‚îÄ Lookup address dari customers (fallback untuk service lama) ‚îÄ‚îÄ
          const customerAddressMap = useMemo(() => {
            const map = {};
            (allCustomers || []).forEach(c => {
              if (c.phone)    map[c.phone] = c.address || '';
              if (c.name)     map[c.name]  = c.address || '';
            });
            return map;
          }, [allCustomers]);

          // ‚îÄ‚îÄ Filter dari PocketBase: hanya status Selesai/Diambil ‚îÄ‚îÄ
          const records = useMemo(() =>
            (allServices || []).filter(s => s.status === 'Selesai' || s.status === 'Diambil'),
            [allServices]
          );
          const loading = servicesLoading;
          const error = null;

          // ‚îÄ‚îÄ Enrich semua records dengan computed fields ‚îÄ‚îÄ
          const enrichedRecords = useMemo(() => {
            const now = new Date(); now.setHours(0,0,0,0);
            return records.map(rec => {
              // Prioritas: completedAt ‚Üí updatedAt ‚Üí createdAt sebagai fallback
              const tsSource = rec.completedAt || rec.updatedAt || rec.createdAt;
              const warrantyEnd = getWarrantyEndDate(tsSource, rec.warrantyDays);
              const remaining = daysUntil(warrantyEnd);
              const completedDate = toJsDate(tsSource);
              const daysSinceCompleted = !completedDate ? 0
                : Math.floor((now - completedDate) / (1000 * 60 * 60 * 24));
              // Normalisasi address: service.address ‚Üí lookup dari customers by phone ‚Üí by name
              const address = rec.address || rec.customerAddress
                || customerAddressMap[rec.customerPhone]
                || customerAddressMap[rec.customerName]
                || '';
              return { ...rec, address, warrantyEnd, remaining, daysSinceCompleted };
            });
          }, [records, customerAddressMap]);

          // ‚îÄ‚îÄ Statistik global (dari semua data, bukan filtered) ‚îÄ‚îÄ
          const stats = useMemo(() => ({
            total: enrichedRecords.length,
            expired: enrichedRecords.filter(r => r.remaining < 0).length,
            urgent: enrichedRecords.filter(r => r.remaining >= 0 && r.remaining <= 3).length,
            week:   enrichedRecords.filter(r => r.remaining >= 0 && r.remaining <= 7).length,
            sent:   enrichedRecords.filter(r => sentIds.includes(r.id)).length,
            unsent: enrichedRecords.filter(r => !sentIds.includes(r.id) && r.remaining >= 0 && r.remaining <= 7).length,
          }), [enrichedRecords, sentIds]);

          // ‚îÄ‚îÄ Filter + Sort ‚îÄ‚îÄ
          const filteredRecords = useMemo(() => {
            let result = enrichedRecords.filter(rec => {
              // Warranty window filter
              switch (warrantyFilter) {
                case 'smart':    return (rec.remaining >= 0 && rec.remaining <= 7) || (rec.daysSinceCompleted >= 28 && rec.daysSinceCompleted <= 32);
                case 'all':      return true;
                case 'expired':  return rec.remaining < 0;
                case 'today':    return rec.remaining >= 0 && rec.remaining <= 1;
                case '1-3':      return rec.remaining >= 1 && rec.remaining <= 3;
                case '4-7':      return rec.remaining >= 4 && rec.remaining <= 7;
                case '8-14':     return rec.remaining >= 8 && rec.remaining <= 14;
                case '15-30':    return rec.remaining >= 15 && rec.remaining <= 30;
                case '31-60':    return rec.remaining >= 31 && rec.remaining <= 60;
                case '30d-ago':  return rec.daysSinceCompleted >= 28 && rec.daysSinceCompleted <= 32;
                default:         return true;
              }
            });

            // Contact status filter
            if (contactFilter === 'sent')   result = result.filter(r => sentIds.includes(r.id));
            if (contactFilter === 'unsent') result = result.filter(r => !sentIds.includes(r.id));

            // Search filter
            if (searchQuery.trim()) {
              const q = searchQuery.toLowerCase();
              result = result.filter(r =>
                (r.customerName || '').toLowerCase().includes(q) ||
                (r.customerPhone || '').includes(q) ||
                (r.deviceModel || '').toLowerCase().includes(q) ||
                (r.deviceBrand || '').toLowerCase().includes(q) ||
                (r.token || '').toLowerCase().includes(q)
              );
            }

            // Sort
            result = [...result].sort((a, b) => {
              switch (sortBy) {
                case 'warranty_asc':  return a.remaining - b.remaining;
                case 'warranty_desc': return b.remaining - a.remaining;
                case 'name':          return (a.customerName || '').localeCompare(b.customerName || '');
                case 'date_desc':     return new Date(b.completedAt) - new Date(a.completedAt);
                default:              return a.remaining - b.remaining;
              }
            });

            return result;
          }, [enrichedRecords, warrantyFilter, contactFilter, searchQuery, sortBy, sentIds]);

          // ‚îÄ‚îÄ Simpan sentIds ke localStorage ‚îÄ‚îÄ
          useEffect(() => { localStorage.setItem('afterSalesSent', JSON.stringify(sentIds)); }, [sentIds]);

          // ‚îÄ‚îÄ Reset semua filter ‚îÄ‚îÄ
          const isFilterActive = warrantyFilter !== 'smart' || contactFilter !== 'all' || sortBy !== 'warranty_asc' || searchQuery.trim();
          const resetFilters = () => { setWarrantyFilter('smart'); setContactFilter('all'); setSortBy('warranty_asc'); setSearchQuery(''); };

          // ‚îÄ‚îÄ Helper: durasi sejak selesai ‚Üí kalimat alami Bahasa Indonesia ‚îÄ‚îÄ
          const formatElapsedNatural = (days) => {
            if (!days || days <= 0) return 'baru saja';
            if (days === 1) return '1 hari';
            if (days < 7)  return `${days} hari`;
            if (days < 14) return '1 minggu';
            if (days < 21) return '2 minggu';
            if (days < 28) return '3 minggu';
            const months = Math.floor(days / 30);
            const sisaHari = days % 30;
            if (months === 0) return `${days} hari`;
            if (sisaHari === 0) return `${months} bulan`;
            if (sisaHari < 7)  return `${months} bulan lebih`;
            return `${months} bulan ${Math.round(sisaHari / 7)} minggu`;
          };

          // ‚îÄ‚îÄ Generate pesan WhatsApp & buka wa.me ‚îÄ‚îÄ
          const handleSendWhatsApp = useCallback((rec) => {
            const phone = formatPhoneForWA(rec.customerPhone);
            if (!phone) { alert('Nomor telepon pelanggan tidak tersedia.'); return; }
            // Warranty end & sisa hari sudah dihitung otomatis dari completedAt + warrantyDays
            const warrantyEndStr = formatDateAfterSales(rec.warrantyEnd);
            const deviceName = [rec.deviceBrand, rec.deviceModel].filter(Boolean).join(' ') || 'HP';
            const storeName = activeStore?.name || activeOwner?.name || 'Toko Kami';
            // Durasi sejak servis selesai ‚Äî dinamis dari data, bukan hardcode
            const elapsedText = formatElapsedNatural(rec.daysSinceCompleted);
            const message =
              `Halo Kak ${rec.customerName || 'Pelanggan'}, ini pesan dari *${storeName}*. ` +
              `Sudah ${elapsedText} sejak servis ${deviceName} Kakak selesai. ` +
              `Bagaimana kondisi HP-nya saat ini? Semoga lancar ya! ` +
              `Sekadar mengingatkan, masa garansi servis akan berakhir pada *${warrantyEndStr}*` +
              `${rec.remaining >= 0 ? ` (${rec.remaining} hari lagi)` : ' (sudah berakhir)'}. ` +
              `Jika ada keluhan, segera bawa kembali ke toko. Terima kasih!`;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
            setSentIds(prev => prev.includes(rec.id) ? prev : [...prev, rec.id]);
          }, [activeStore?.name, activeOwner?.name]);

          // ‚îÄ‚îÄ Badge urgency ‚îÄ‚îÄ
          const getUrgencyBadge = (remaining) => {
            if (remaining < 0)   return <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700">Expired {Math.abs(remaining)}h lalu</span>;
            if (remaining === 0) return <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700">Berakhir hari ini!</span>;
            if (remaining <= 3)  return <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700">{remaining} hari lagi</span>;
            if (remaining <= 7)  return <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">{remaining} hari lagi</span>;
            if (remaining <= 14) return <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">{remaining} hari lagi</span>;
            return <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">{remaining} hari</span>;
          };

          return (
            <div className="space-y-5">
              {/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */}
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div className="flex items-center gap-3">
                  <div className="bg-gradient-to-br from-green-500 to-emerald-600 p-2.5 rounded-xl shadow-lg shadow-green-500/20 text-white">
                    <WhatsAppIcon className="w-6 h-6" />
                  </div>
                  <div>
                    <h1 className="text-xl md:text-2xl font-bold text-slate-800 tracking-tight">After Sales Care</h1>
                    <p className="text-xs md:text-sm text-slate-500">Follow-up garansi servis pelanggan via WhatsApp</p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => setShowFilterPanel(v => !v)}
                    className={`inline-flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border transition-all duration-200 shadow-sm ${showFilterPanel || isFilterActive ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}
                  >
                    <Filter className="w-4 h-4" />
                    Filter
                    {isFilterActive && <span className="bg-white text-blue-600 rounded-full text-xs font-bold px-1.5 leading-5 min-w-[20px] text-center">!</span>}
                  </button>
                  <button onClick={() => window.location.reload()} disabled={loading} className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-all duration-200 shadow-sm disabled:opacity-50">
                    <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
                    <span className="hidden sm:inline">Refresh</span>
                  </button>
                </div>
              </div>

              {/* ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ */}
              {!loading && !error && (
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  <div className="bg-white rounded-xl border border-slate-200 p-3 shadow-sm">
                    <p className="text-xs text-slate-400 mb-1">Total Data</p>
                    <p className="text-2xl font-bold text-slate-800">{stats.total}</p>
                    <p className="text-xs text-slate-400">servis selesai</p>
                  </div>
                  <div className="bg-white rounded-xl border border-red-100 p-3 shadow-sm">
                    <p className="text-xs text-red-400 mb-1">Expired / Kritis</p>
                    <p className="text-2xl font-bold text-red-600">{stats.expired} <span className="text-slate-400 font-normal text-sm">/ {stats.urgent}</span></p>
                    <p className="text-xs text-slate-400">habis / ‚â§3 hari</p>
                  </div>
                  <div className="bg-white rounded-xl border border-amber-100 p-3 shadow-sm">
                    <p className="text-xs text-amber-500 mb-1">Ditampilkan</p>
                    <p className="text-2xl font-bold text-amber-600">{filteredRecords.length}</p>
                    <p className="text-xs text-slate-400">hasil filter aktif</p>
                  </div>
                  <div className="bg-white rounded-xl border border-green-100 p-3 shadow-sm">
                    <div className="flex items-start justify-between">
                      <div>
                        <p className="text-xs text-green-500 mb-1">Sudah Dihubungi</p>
                        <p className="text-2xl font-bold text-green-600">{stats.sent}</p>
                        <p className="text-xs text-slate-400">dari {stats.total} data</p>
                      </div>
                      {stats.sent > 0 && (
                        <button
                          onClick={() => {
                            if (window.confirm(`Reset ${stats.sent} riwayat kontak? Semua tanda "Sudah Dihubungi" akan dihapus.`)) {
                              setSentIds([]);
                            }
                          }}
                          className="flex-shrink-0 flex items-center gap-1 px-2 py-1 text-xs font-medium text-red-500 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 hover:text-red-700 transition-colors"
                          title="Reset riwayat kontak"
                        >
                          <RefreshCw className="w-3 h-3" /> Reset
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* ‚îÄ‚îÄ Filter Panel ‚îÄ‚îÄ */}
              {showFilterPanel && (
                <div className="bg-white border border-slate-200 rounded-xl shadow-sm p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <h3 className="text-sm font-semibold text-slate-700 flex items-center gap-2"><Filter className="w-4 h-4 text-blue-500" /> Panel Filter</h3>
                    {isFilterActive && (
                      <button onClick={resetFilters} className="text-xs text-red-500 hover:text-red-700 font-medium flex items-center gap-1">
                        <X className="w-3 h-3" /> Reset Semua Filter
                      </button>
                    )}
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    {/* Filter Garansi */}
                    <div>
                      <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">üîí Window Garansi</label>
                      <div className="space-y-1 max-h-56 overflow-y-auto pr-1">
                        {WARRANTY_FILTER_OPTIONS.map(opt => (
                          <button key={opt.value} onClick={() => setWarrantyFilter(opt.value)}
                            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-all ${warrantyFilter === opt.value ? 'bg-blue-600 text-white font-semibold' : 'hover:bg-slate-100 text-slate-700'}`}>
                            <span>{opt.label}</span>
                            <span className={`block text-xs mt-0.5 ${warrantyFilter === opt.value ? 'text-blue-100' : 'text-slate-400'}`}>{opt.desc}</span>
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Filter Status Kontak */}
                    <div>
                      <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">üì± Status Kontak</label>
                      <div className="space-y-1">
                        {[
                          { value: 'all',    label: 'üë• Semua Pelanggan',      desc: 'Tampilkan semua' },
                          { value: 'unsent', label: 'üì© Belum Dihubungi',      desc: 'Belum ada pesan terkirim' },
                          { value: 'sent',   label: '‚úÖ Sudah Dihubungi',      desc: 'Sudah pernah dikirim WA' },
                        ].map(opt => (
                          <button key={opt.value} onClick={() => setContactFilter(opt.value)}
                            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-all ${contactFilter === opt.value ? 'bg-blue-600 text-white font-semibold' : 'hover:bg-slate-100 text-slate-700'}`}>
                            <span>{opt.label}</span>
                            <span className={`block text-xs mt-0.5 ${contactFilter === opt.value ? 'text-blue-100' : 'text-slate-400'}`}>{opt.desc}</span>
                          </button>
                        ))}
                      </div>

                      {/* Sort */}
                      <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-4">‚ÜïÔ∏è Urutan</label>
                      <div className="space-y-1">
                        {[
                          { value: 'warranty_asc',  label: 'Garansi: Paling Dekat' },
                          { value: 'warranty_desc', label: 'Garansi: Paling Jauh' },
                          { value: 'name',          label: 'Nama A‚ÄìZ' },
                          { value: 'date_desc',     label: 'Servis: Terbaru' },
                        ].map(opt => (
                          <button key={opt.value} onClick={() => setSortBy(opt.value)}
                            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-all ${sortBy === opt.value ? 'bg-blue-600 text-white font-semibold' : 'hover:bg-slate-100 text-slate-700'}`}>
                            {opt.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Search + Info */}
                    <div>
                      <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">üîç Cari Pelanggan</label>
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                        <input type="text" placeholder="Nama, telepon, perangkat..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
                          className="w-full pl-9 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" />
                        {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"><X className="w-4 h-4" /></button>}
                      </div>

                      {/* Quick filter chips */}
                      <div className="mt-3">
                        <p className="text-xs text-slate-400 mb-2">Quick Filter:</p>
                        <div className="flex flex-wrap gap-1.5">
                          {[
                            { wf: 'expired', cf: 'unsent', label: 'üî¥ Expired belum WA' },
                            { wf: '1-3',     cf: 'unsent', label: 'üü° Kritis belum WA' },
                            { wf: 'smart',   cf: 'unsent', label: 'üéØ Smart belum WA' },
                            { wf: 'all',     cf: 'all',    label: 'üìã Semua' },
                          ].map(q => (
                            <button key={q.label} onClick={() => { setWarrantyFilter(q.wf); setContactFilter(q.cf); }}
                              className="px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600 hover:bg-blue-100 hover:text-blue-700 transition-colors border border-slate-200 hover:border-blue-300">
                              {q.label}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Breakdown garansi */}
                      {!loading && enrichedRecords.length > 0 && (
                        <div className="mt-4 bg-slate-50 rounded-lg p-3 border border-slate-200">
                          <p className="text-xs font-semibold text-slate-500 mb-2 uppercase">Distribusi Garansi</p>
                          {[
                            { label: 'Expired',     count: enrichedRecords.filter(r => r.remaining < 0).length,               color: 'text-red-600' },
                            { label: 'Hari ini',    count: enrichedRecords.filter(r => r.remaining === 0).length,               color: 'text-red-500' },
                            { label: '1‚Äì3 hari',    count: enrichedRecords.filter(r => r.remaining >= 1 && r.remaining <= 3).length, color: 'text-orange-500' },
                            { label: '4‚Äì7 hari',    count: enrichedRecords.filter(r => r.remaining >= 4 && r.remaining <= 7).length, color: 'text-amber-500' },
                            { label: '8‚Äì14 hari',   count: enrichedRecords.filter(r => r.remaining >= 8 && r.remaining <= 14).length, color: 'text-yellow-600' },
                            { label: '15‚Äì30 hari',  count: enrichedRecords.filter(r => r.remaining >= 15 && r.remaining <= 30).length, color: 'text-blue-500' },
                            { label: '> 30 hari',   count: enrichedRecords.filter(r => r.remaining > 30).length,               color: 'text-slate-500' },
                          ].map(row => row.count > 0 && (
                            <div key={row.label} className="flex items-center justify-between py-0.5">
                              <span className="text-xs text-slate-500">{row.label}</span>
                              <span className={`text-xs font-bold ${row.color}`}>{row.count}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* ‚îÄ‚îÄ Search bar (mini, saat filter panel tertutup) ‚îÄ‚îÄ */}
              {!showFilterPanel && (
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                  <input type="text" placeholder="Cari nama, telepon, atau perangkat..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
                    className="w-full pl-10 pr-10 py-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm" />
                  {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"><X className="w-4 h-4" /></button>}
                </div>
              )}

              {/* ‚îÄ‚îÄ Active filter pills ‚îÄ‚îÄ */}
              {isFilterActive && (
                <div className="flex flex-wrap items-center gap-2">
                  <span className="text-xs text-slate-400">Filter aktif:</span>
                  {warrantyFilter !== 'smart' && (
                    <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">
                      {WARRANTY_FILTER_OPTIONS.find(o => o.value === warrantyFilter)?.label}
                      <button onClick={() => setWarrantyFilter('smart')}><X className="w-3 h-3" /></button>
                    </span>
                  )}
                  {contactFilter !== 'all' && (
                    <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700 border border-purple-200">
                      {contactFilter === 'sent' ? '‚úÖ Sudah Dihubungi' : 'üì© Belum Dihubungi'}
                      <button onClick={() => setContactFilter('all')}><X className="w-3 h-3" /></button>
                    </span>
                  )}
                  {sortBy !== 'warranty_asc' && (
                    <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200">
                      ‚Üï {sortBy === 'name' ? 'Nama A-Z' : sortBy === 'date_desc' ? 'Terbaru' : 'Garansi ‚Üì'}
                      <button onClick={() => setSortBy('warranty_asc')}><X className="w-3 h-3" /></button>
                    </span>
                  )}
                  {searchQuery.trim() && (
                    <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200">
                      üîç "{searchQuery}"
                      <button onClick={() => setSearchQuery('')}><X className="w-3 h-3" /></button>
                    </span>
                  )}
                </div>
              )}

              {/* ‚îÄ‚îÄ Error State ‚îÄ‚îÄ */}
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                  <AlertCircle className="w-12 h-12 mx-auto text-red-400 mb-2" />
                  <h3 className="text-lg font-semibold text-red-700 mb-1">Gagal Memuat Data</h3>
                  <p className="text-sm text-red-600 mb-4">{error}</p>
                  <button onClick={fetchData} className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">
                    <RefreshCw className="w-4 h-4" /> Coba Lagi
                  </button>
                </div>
              )}

              {/* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-slate-200">
                    <thead>
                      <tr className="bg-slate-50">
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Pelanggan</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider hidden md:table-cell">No. Telepon</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider hidden sm:table-cell">Perangkat</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider hidden lg:table-cell">Tgl Selesai</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Garansi</th>
                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Aksi</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {loading && <><ASCSkeletonRow /><ASCSkeletonRow /><ASCSkeletonRow /><ASCSkeletonRow /><ASCSkeletonRow /></>}
                      {!loading && !error && filteredRecords.length === 0 && (
                        <tr><td colSpan="6" className="px-4 py-16 text-center">
                          <CheckCircle className="w-16 h-16 mx-auto text-slate-200 mb-3" />
                          <h3 className="text-lg font-semibold text-slate-500 mb-1">
                            {records.length === 0 ? 'Belum ada data servis selesai' : 'Tidak ada yang cocok dengan filter ini'}
                          </h3>
                          <p className="text-sm text-slate-400 mb-3">
                            {records.length === 0
                              ? 'Belum ada data servis dengan status "Selesai" atau "Diambil" di database.'
                              : warrantyFilter === 'smart'
                              ? `${records.length} data ditemukan, tapi tidak ada yang garansinya 0‚Äì7 hari atau selesai ~30 hari lalu.`
                              : searchQuery
                              ? `Tidak ada hasil untuk pencarian "${searchQuery}".`
                              : 'Coba ubah kombinasi filter di atas.'}
                          </p>
                          <div className="flex flex-wrap justify-center gap-2">
                            {records.length > 0 && warrantyFilter !== 'all' && (
                              <button onClick={() => { setWarrantyFilter('all'); setContactFilter('all'); }}
                                className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                üìã Tampilkan Semua {records.length} Data
                              </button>
                            )}
                            {isFilterActive && (
                              <button onClick={resetFilters} className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors border border-blue-200">
                                <RefreshCw className="w-4 h-4" /> Reset Filter
                              </button>
                            )}
                          </div>
                        </td></tr>
                      )}
                      {!loading && filteredRecords.map(rec => {
                        const isSent = sentIds.includes(rec.id);
                        const deviceName = [rec.deviceBrand, rec.deviceModel].filter(Boolean).join(' ') || '-';
                        return (
                          <tr key={rec.id} className={`hover:bg-slate-50 transition-colors duration-150 ${isSent ? 'bg-green-50/40' : ''}`}>
                            <td className="px-4 py-3">
                              <div className="flex items-center gap-3">
                                <div className="flex-shrink-0 w-9 h-9 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-sm font-bold shadow-sm">
                                  {(rec.customerName || '?')[0].toUpperCase()}
                                </div>
                                <div className="min-w-0">
                                  <div className="flex items-center gap-1.5">
                                    <p className="text-sm font-semibold text-slate-800 truncate">{rec.customerName || '-'}</p>
                                    {isSent && <CheckCheck className="w-3.5 h-3.5 text-green-500 flex-shrink-0" />}
                                  </div>
                                  <p className="text-xs text-slate-400 truncate max-w-[160px]" title={rec.address || '-'}>üìç {rec.address || '-'}</p>
                                  <p className="text-xs text-slate-400 sm:hidden">{rec.customerPhone || '-'}</p>
                                  <p className="text-xs text-slate-400 sm:hidden">{deviceName}</p>
                                </div>
                              </div>
                            </td>
                            <td className="px-4 py-3 hidden md:table-cell"><span className="text-sm text-slate-600 font-mono">{rec.customerPhone || '-'}</span></td>
                            <td className="px-4 py-3 hidden sm:table-cell"><span className="text-sm text-slate-700 font-medium">{deviceName}</span></td>
                            <td className="px-4 py-3 hidden lg:table-cell">
                              <div>
                                <span className="text-sm text-slate-600">{formatDateAfterSales(rec.completedAt)}</span>
                                <p className="text-xs text-slate-400">{rec.daysSinceCompleted} hari lalu</p>
                              </div>
                            </td>
                            <td className="px-4 py-3">
                              <div className="flex flex-col gap-1">
                                <span className="text-xs text-slate-500">{formatDateAfterSales(rec.warrantyEnd)}</span>
                                {getUrgencyBadge(rec.remaining)}
                                <span className="text-xs text-slate-400 hidden lg:inline">{rec.warrantyDays} hari garansi</span>
                              </div>
                            </td>
                            <td className="px-4 py-3 text-center">
                              <button onClick={() => handleSendWhatsApp(rec)}
                                className={`inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 shadow-sm ${
                                  isSent ? 'bg-slate-100 text-slate-500 border border-slate-200 hover:bg-slate-200'
                                    : 'bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:from-green-600 hover:to-emerald-700 shadow-green-500/25 hover:shadow-green-500/40'
                                }`}
                                title={isSent ? 'Kirim ulang WhatsApp' : 'Kirim WhatsApp'}
                              >
                                <WhatsAppIcon className="w-4 h-4" />
                                <span className="hidden sm:inline">{isSent ? 'Kirim Ulang' : 'WhatsApp'}</span>
                              </button>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
                {!loading && (
                  <div className="px-4 py-3 bg-slate-50 border-t border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                    <p className="text-xs text-slate-500">
                      Menampilkan <strong className="text-blue-600">{filteredRecords.length}</strong> dari <strong>{records.length}</strong> total data servis selesai
                      {isFilterActive && <span className="text-amber-500 ml-1">(filter aktif)</span>}
                    </p>
                    <p className="text-xs text-slate-400">Diperbarui: {new Date().toLocaleString('id-ID')}</p>
                  </div>
                )}
              </div>

              {/* ‚îÄ‚îÄ Info Card ‚îÄ‚îÄ */}
              <div className="bg-blue-50 border border-blue-100 rounded-xl p-4">
                <h4 className="text-sm font-semibold text-blue-800 mb-2 flex items-center gap-2"><Info className="w-4 h-4" /> Panduan Penggunaan</h4>
                <ul className="text-xs text-blue-700 space-y-1 list-disc list-inside">
                  <li><strong>Smart Filter (default)</strong>: garansi 0‚Äì7 hari + servis selesai sekitar 30 hari lalu.</li>
                  <li><strong>Semua Data</strong>: tampilkan semua servis selesai ‚Äî cocok untuk testing / eksplorasi.</li>
                  <li>Gunakan <strong>Quick Filter</strong> di panel untuk aksi cepat (expired belum di-WA, dll).</li>
                  <li>Tombol <strong>WhatsApp</strong> membuka chat dengan template pesan otomatis.</li>
                  <li>Status <span className="font-bold text-green-700">‚úÖ Sudah Dihubungi</span> tersimpan di browser (localStorage). Gunakan tombol <span className="font-bold text-red-600">Reset</span> di kartu hijau untuk menghapus riwayat kontak.</li>
                </ul>
              </div>
            </div>
          );
        };
        
        const Sidebar = ({ setView, view, isOpen, close }) => {
            const { user, activeOwner, activeStore, availableStores, switchStore, logout, checkPermission } = useContext(SessionContext);
            const [storeMenuOpen, setStoreMenuOpen] = useState(false);
            const [expandedGroups, setExpandedGroups] = useState({ operations: true, finance: false, inventory: false });
            const [showInstallButton, setShowInstallButton] = useState(false);
            const [isInstalled, setIsInstalled] = useState(false);
            const [totalKas, setTotalKas] = useState(null);
            const effectiveRole = user.role === 'developer' ? 'owner' : user.role;

            // ‚úÖ Saldo kas - pakai admin token agar tidak gagal karena PB collection rules
            useEffect(() => {
                if (!activeOwner?.id) { setTotalKas(null); return; }
                let cancelled = false;
                const fetchKas = async () => {
                    try {
                        let filter = `ownerId="${activeOwner.id}"`;
                        if (activeStore?.id && activeStore.id !== 'all') {
                            filter += `&&storeId="${activeStore.id}"`;
                        }
                        const adminToken = await getAdminToken();
                        const url = `${POCKETBASE_URL}/api/collections/cash_flow/records?perPage=500&filter=${encodeURIComponent(filter)}`;
                        const resp = await fetch(url, { headers: { 'Authorization': adminToken || pb.authStore.token || '' } });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        if (cancelled) return;
                        const items = data.items || [];
                        const tin = items.filter(r => r.type === 'in').reduce((s, r) => s + (Number(r.amount) || 0), 0);
                        const tout = items.filter(r => r.type === 'out').reduce((s, r) => s + (Number(r.amount) || 0), 0);
                        setTotalKas(tin - tout);
                    } catch (err) {
                        console.warn('Sidebar kas fetch error:', err.message);
                        // Retry setelah 3 detik jika gagal
                        if (!cancelled) setTimeout(fetchKas, 3000);
                    }
                };
                fetchKas();
                const interval = setInterval(fetchKas, 15000);
                const unsub = _subscribeCollection('cash_flow', () => fetchKas());
                return () => { cancelled = true; clearInterval(interval); unsub(); };
            }, [activeOwner?.id, activeStore?.id]);
            
            useEffect(() => {
                // Cek status install saat ini
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
                setIsInstalled(isStandalone);

                if (isStandalone) {
                    setShowInstallButton(false);
                    return;
                }

                // ‚úÖ Cek apakah deferredPrompt sudah ada (event mungkin sudah fire sebelum komponen mount)
                if (window.deferredPrompt) {
                    setShowInstallButton(true);
                }

                const handleInstallable = () => {
                    if (!window.matchMedia('(display-mode: standalone)').matches) {
                        setShowInstallButton(true);
                    }
                };
                const handleInstalled = () => {
                    setIsInstalled(true);
                    setShowInstallButton(false);
                };

                window.addEventListener('pwa-installable', handleInstallable);
                window.addEventListener('pwa-installed', handleInstalled);

                // Pantau perubahan display-mode (ketika dibuka standalone)
                const mq = window.matchMedia('(display-mode: standalone)');
                const handleMqChange = (e) => {
                    if (e.matches) {
                        setIsInstalled(true);
                        setShowInstallButton(false);
                    }
                };
                mq.addEventListener('change', handleMqChange);

                return () => {
                    window.removeEventListener('pwa-installable', handleInstallable);
                    window.removeEventListener('pwa-installed', handleInstalled);
                    mq.removeEventListener('change', handleMqChange);
                };
            }, []);
            
            const handleInstallClick = async () => {
                const prompt = window.deferredPrompt;
                if (prompt) {
                    // ‚úÖ Simpan referensi lokal sebelum prompt (window.deferredPrompt bisa di-null setelah prompt)
                    window.deferredPrompt = null;
                    setShowInstallButton(false);
                    try {
                        await prompt.prompt();
                        const { outcome } = await prompt.userChoice;
                        if (outcome === 'accepted') {
                            setIsInstalled(true);
                        } else {
                            // User cancel ‚Äî kembalikan prompt agar bisa dicoba lagi
                            window.deferredPrompt = prompt;
                            setShowInstallButton(true);
                        }
                    } catch (err) {
                        console.warn('PWA install error:', err);
                        window.deferredPrompt = prompt;
                        setShowInstallButton(true);
                    }
                } else {
                    // Tidak ada native prompt ‚Äî tampilkan panduan manual
                    const ua = navigator.userAgent;
                    const isIOS = /iPhone|iPad|iPod/.test(ua);
                    const isChrome = /Chrome/.test(ua) && /Google Inc/.test(navigator.vendor);
                    const isEdge = /Edg/.test(ua);
                    const isSamsung = /SamsungBrowser/.test(ua);

                    let msg = 'üì≤ Cara Install Aplikasi:\n\n';
                    if (isIOS) {
                        msg += '1. Tap ikon Share (kotak + panah ke atas)\n2. Pilih "Add to Home Screen"\n3. Tap "Add"';
                    } else if (isChrome || isEdge || isSamsung) {
                        msg += '1. Tap menu ‚ãÆ (titik tiga) di pojok kanan atas\n2. Pilih "Install app" atau "Add to Home screen"\n3. Tap "Install"';
                    } else {
                        msg += 'Gunakan Chrome, Edge, atau Samsung Browser untuk install aplikasi ini.';
                    }
                    alert(msg);
                }
            };
            
            const toggleGroup = (group) => {
                setExpandedGroups(prev => ({ ...prev, [group]: !prev[group] }));
            };
            
            const menuGroups = [
                {
                    id: 'main',
                    items: [
                        { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard, permission: 'menu_dashboard' }
                    ]
                },
                {
                    id: 'operations',
                    label: 'üìã Transaksi',
                    expandable: true,
                    items: [
                        { id: 'service', label: 'Servis HP', icon: Smartphone, permission: 'menu_service' },
                        { id: 'sales', label: 'Penjualan', icon: Store, permission: 'menu_sales' },
                        { id: 'purchase', label: 'Pembelian', icon: ShoppingCart, permission: 'menu_purchase' },
                        { id: 'return-sales', label: 'Retur Penjualan', icon: RotateCcw, permission: 'menu_return_sales' },
                        { id: 'return-purchase', label: 'Retur Pembelian', icon: RotateCw, permission: 'menu_return_purchase' }
                    ]
                },
                {
                    id: 'finance',
                    label: 'üí∞ Keuangan',
                    expandable: true,
                    items: [
                        { id: 'payable', label: 'Utang', icon: ArrowUpRight, permission: 'menu_payable' },
                        { id: 'receivable', label: 'Piutang', icon: ArrowDownRight, permission: 'menu_receivable' },
                        { id: 'cash', label: 'Kas', icon: Banknote, permission: 'menu_cash' },
                        { id: 'finance', label: 'Laporan Keuangan', icon: Wallet, permission: 'menu_finance' }
                    ]
                },
                {
                    id: 'inventory',
                    label: 'üì¶ Inventory',
                    expandable: true,
                    items: [
                        { id: 'inventory', label: 'Stok', icon: Box, permission: 'menu_inventory' },
                        { id: 'supplier', label: 'Supplier', icon: Truck, permission: 'menu_supplier' }
                    ]
                },
                {
                    id: 'other',
                    items: [
                        { id: 'customers', label: 'Pelanggan', icon: Users, permission: 'menu_customers' },
                        { id: 'after-sales', label: 'After Sales Care', icon: HeartHandshake, permission: 'menu_after_sales' },
                        { id: 'report', label: 'Laporan', icon: FileText, permission: 'menu_report' },
                        { id: 'hr', label: 'HR & Payroll', icon: Calendar, permission: 'menu_hr' },
                        { id: 'ai-assistant', label: '‚ú® AI Assistant', icon: Brain, permission: 'menu_ai_assistant', isPremium: true }
                    ]
                }
            ];
            
            if(effectiveRole === 'owner') {
                menuGroups.push({
                    id: 'admin',
                    items: [
                        { id: 'users', label: 'Pegawai', icon: Users, permission: 'menu_users' },
                        { id: 'settings', label: 'Pengaturan', icon: Settings, permission: 'menu_settings' }
                    ]
                });
            }
            
            // Backup menu untuk Admin & Owner (dengan permission check)
            if(effectiveRole === 'owner' || effectiveRole === 'admin') {
                menuGroups.push({
                    id: 'backup-menu',
                    items: [
                        { id: 'backup', label: 'Backup Data', icon: Database, permission: 'feature_backup_per_item' }
                    ]
                });
            }
            
            return (
                <aside className={`bg-slate-900 text-slate-300 flex flex-col fixed left-0 top-0 bottom-0 z-50 shadow-2xl transition-transform duration-300 mobile-sidebar ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 w-64`}>
                    {user.role === 'developer' && activeOwner ? (
                        <div className="bg-purple-900 border-b border-purple-800 flex-shrink-0">
                            <div className="px-4 pt-3 pb-1 text-xs text-purple-200 font-bold flex items-center justify-between gap-2">
                                <span className="truncate">üëÅÔ∏è Spy Mode: {activeOwner.name}</span>
                                <div className="md:hidden flex-shrink-0"><button onClick={close} className="text-purple-300 hover:text-white p-1 rounded-lg hover:bg-purple-800 transition-colors"><X className="w-5 h-5"/></button></div>
                            </div>
                            <button onClick={()=>window.location.reload()} className="w-full py-2 bg-red-700/80 hover:bg-red-600 active:bg-red-800 text-white text-xs font-bold transition-colors flex items-center justify-center gap-1.5">
                                <LogOut className="w-3 h-3"/>
                                Keluar Spy Mode
                            </button>
                        </div>
                    ) : (
                        <div className="md:hidden absolute top-4 right-4 z-10"><button onClick={close} className="text-slate-400 hover:text-white"><X className="w-6 h-6"/></button></div>
                    )}
                    <div className="p-6 flex-1 overflow-y-auto sidebar-scroll bg-slate-900">
                        <div className="flex items-center gap-3 text-white mb-6"><img src="/logo-ifix.png" alt="iFix Enterprise" className="w-10 h-10 rounded-lg object-contain"/><div><h1 className="font-bold text-lg leading-tight">iFix Pro</h1><p className="text-[10px] text-blue-400 uppercase tracking-widest">{activeOwner?.plan || 'Cloud'} Edition</p></div></div>
                        <div className="relative mb-6">
                            <button onClick={() => effectiveRole === 'owner' && setStoreMenuOpen(!storeMenuOpen)} className={`w-full bg-slate-800 p-3 rounded-xl flex items-center gap-3 border border-slate-700 ${effectiveRole === 'owner' ? 'hover:border-blue-500 cursor-pointer' : ''}`}>
                                <div className="bg-blue-900 p-2 rounded-lg text-blue-400"><Store className="w-4 h-4"/></div><div className="flex-1 min-w-0 text-left"><p className="text-[10px] text-slate-500 uppercase font-bold">Lokasi Aktif</p><p className="text-sm font-bold text-white truncate">{!activeStore ? 'üìä Semua Toko' : (activeStore.name || 'Loading...')}</p></div>{effectiveRole === 'owner' ? <ChevronDown className="w-4 h-4"/> : <Lock className="w-3 h-3"/>}
                            </button>
                            {storeMenuOpen && <div className="absolute top-full left-0 w-full mt-2 bg-slate-800 rounded-xl border border-slate-700 shadow-xl overflow-hidden z-50">
                                <button onClick={()=>{switchStore(null); setStoreMenuOpen(false);}} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-700 flex justify-between border-b border-slate-700 text-slate-300 font-bold text-blue-400 bg-slate-700/50">
                                    <span className="truncate">üìä Semua Toko (Full Database)</span>
                                    {!activeStore?.id && <Check className="w-4 h-4 text-blue-500"/>}
                                </button>
                                {availableStores.map(s => <button key={s.id} onClick={()=>{switchStore(s.id); setStoreMenuOpen(false);}} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-700 flex justify-between border-b border-slate-700 last:border-0 text-slate-300"><span className="truncate">{s.name}</span>{s.id === activeStore?.id && <Check className="w-4 h-4 text-blue-500"/>}</button>)}</div>}
                        </div>
                        {/* ‚úÖ Widget Saldo Kas Realtime */}
                        {totalKas !== null && (
                            <button
                                onClick={() => { setView('cash'); if(window.innerWidth < 768) close(); }}
                                className={`w-full mb-4 rounded-xl p-3 text-left border transition-all hover:scale-[1.02] ${
                                    totalKas < 0
                                        ? 'bg-red-900/30 border-red-500/40 hover:border-red-400'
                                        : totalKas < 100000
                                        ? 'bg-yellow-900/30 border-yellow-500/40 hover:border-yellow-400'
                                        : 'bg-emerald-900/30 border-emerald-500/40 hover:border-emerald-400'
                                }`}
                            >
                                <div className="flex items-center justify-between mb-1">
                                    <p className={`text-[10px] uppercase font-bold ${
                                        totalKas < 0 ? 'text-red-400' : totalKas < 100000 ? 'text-yellow-400' : 'text-emerald-400'
                                    }`}>üíµ Kas Tersedia</p>
                                    <span className="text-[9px] text-slate-500">tap untuk detail</span>
                                </div>
                                <p className={`text-base font-bold leading-tight ${
                                    totalKas < 0 ? 'text-red-400' : totalKas < 100000 ? 'text-yellow-300' : 'text-emerald-300'
                                }`}>
                                    {totalKas < 0 ? '‚ö†Ô∏è ' : totalKas < 100000 ? '‚ö° ' : '‚úÖ '}
                                    {new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(totalKas)}
                                </p>
                                {totalKas < 100000 && totalKas >= 0 && (
                                    <p className="text-[9px] text-yellow-500 mt-0.5">‚ö†Ô∏è Saldo hampir habis</p>
                                )}
                                {totalKas < 0 && (
                                    <p className="text-[9px] text-red-400 mt-0.5">‚ùå Saldo minus - tidak bisa belanja</p>
                                )}
                            </button>
                        )}
                        <nav className="space-y-1">
                            {menuGroups.map(group => (
                                <div key={group.id}>
                                    {group.label && (
                                        <button
                                            onClick={() => group.expandable && toggleGroup(group.id)}
                                            className="w-full flex items-center justify-between px-3 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider hover:text-slate-200 transition-colors"
                                        >
                                            <span>{group.label}</span>
                                            {group.expandable && (
                                                <ChevronDown className={`w-3 h-3 transition-transform ${expandedGroups[group.id] ? 'rotate-180' : ''}`} />
                                            )}
                                        </button>
                                    )}
                                    <div className={`space-y-1 ${group.expandable && !expandedGroups[group.id] ? 'hidden' : ''}`}>
                                        {group.items.map(m => {
                                            // Jika trial AI aktif, menu ai-assistant tidak terkunci meski permission belum di-set
                                            const hasActiveTrial = m.id === 'ai-assistant' && !!(activeOwner?.accessRights?.aiTrialEnabled);
                                            const isLocked = m.permission && !checkPermission(m.permission) && !hasActiveTrial;
                                            return (
                                                <button 
                                                    key={m.id} 
                                                    onClick={()=>{ 
                                                        if(isLocked) { 
                                                            alert("‚ùå Menu ini dikunci oleh Developer/Owner"); 
                                                        } else { 
                                                            setView(m.id); 
                                                            if(window.innerWidth < 768) close(); 
                                                        } 
                                                    }} 
                                                    className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-medium transition-all
                                                        ${m.isPremium
                                                            ? view === m.id
                                                                ? 'bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-lg shadow-violet-900/50'
                                                                : 'bg-violet-900/30 border border-violet-500/30 text-violet-300 hover:bg-violet-800/40 hover:text-white'
                                                            : view === m.id
                                                                ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50'
                                                                : 'hover:bg-slate-800 hover:text-white'
                                                        }
                                                        ${isLocked ? 'text-slate-500 cursor-not-allowed hover:bg-transparent' : ''}
                                                        ${group.label ? 'ml-2' : ''}`}
                                                >
                                                    {isLocked ? <Lock className="w-4 h-4"/> : <m.icon className="w-4 h-4"/>}
                                                    <span className="text-xs flex-1">{m.label}</span>
                                                    {m.isPremium && !isLocked && <span className="text-[9px] bg-yellow-400 text-yellow-900 font-black px-1.5 py-0.5 rounded-full leading-none">AI</span>}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </nav>
                    </div>
                    {!isInstalled && showInstallButton && (
                        <div className="p-4 flex-shrink-0 bg-slate-900 border-t border-slate-800">
                            <button
                                onClick={handleInstallClick}
                                className="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-3 rounded-xl font-bold text-sm hover:from-purple-700 hover:to-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl active:scale-95"
                            >
                                <Download className="w-5 h-5" />
                                <span>Install Aplikasi</span>
                            </button>
                            <p className="text-xs text-center text-slate-500 mt-1.5">Install untuk akses lebih cepat & offline</p>
                        </div>
                    )}
                    <div className="p-4 border-t border-slate-800 flex-shrink-0 bg-slate-900"><div className="flex items-center gap-3 px-2"><div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white font-bold text-xs">{user.name.charAt(0)}</div><div className="flex-1 min-w-0"><p className="text-sm font-bold text-white truncate">{user.name}</p><p className="text-[10px] text-slate-500 uppercase font-bold">{user.role}</p></div></div></div>
                </aside>
            );
        };
        
        const SettingsManager = () => {
             const { user, activeOwner, activeStore, checkPermission, ownerAccess, storeConfig, availableStores } = useContext(SessionContext);
             const { data: users } = useFirestoreCollection('users', activeOwner?.id);
             const [storeData, setStoreData] = useState(activeStore || {});
             const [config, setConfig] = useState(storeConfig || {});
             const [saving, setSaving] = useState(false);
             const [selectedRole, setSelectedRole] = useState('admin');
             // Config per-role: jika ada nested (baru), gunakan; fallback ke flat (lama)
             const roleConfig = config?.permissions?.[selectedRole] ?? {};
             const [savingGPS, setSavingGPS] = useState(false);
             const [gettingGPS, setGettingGPS] = useState(false);
             const [restoring, setRestoring] = useState(false);
             const [isBranchModalOpen, setBranchModalOpen] = useState(false);
             const [modal, setModal] = useState(null);
             const [openSect, setOpenSect] = useState(() => new Set(['profil-toko', 'gps-absensi', 'master-data']));
             const toggleSect = (id) => setOpenSect(prev => { const n = new Set(prev); n.has(id) ? n.delete(id) : n.add(id); return n; });

             // Hanya reset form profil toko ketika berpindah ke toko berbeda (bukan saat data diperbarui)
             useEffect(() => { 
                 setStoreData(activeStore || {});
             }, [activeStore?.id, activeStore?.gps_lat, activeStore?.gps_lon, activeStore?.gps_radius]);

             // Config (non-logo) tetap sinkron dengan storeConfig
             useEffect(() => {
                 setConfig(storeConfig || {}); 
                 console.log('üîÑ Real-time sync: Config updated', storeConfig);
             }, [storeConfig]);
             const effectiveRole = user.role === 'developer' ? 'owner' : user.role;
             if (effectiveRole !== 'owner') return <div className="p-10 text-center text-red-500 font-bold"><Lock className="w-10 h-10 mx-auto mb-2"/>Akses Ditolak: Hanya Owner</div>;
             if (!activeOwner) return <div className="p-10 text-center text-slate-400"><Loader2 className="w-8 h-8 animate-spin mx-auto mb-2"/>Memuat data...</div>;
             
             // NEW: Image Processor (Optimized for Spark Plan)
             const processImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            // Resize logic: Max width 600px (HD untuk logo invoice)
                            const MAX_WIDTH = 600;
                            let width = img.width;
                            let height = img.height;

                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            // Compress to PNG quality tinggi (HD)
                            resolve(canvas.toDataURL('image/png', 1.0));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
             };

             const handleLogo = async (e) => { 
                 const file = e.target.files[0]; 
                 if(file) { 
                     // Check max size 5MB for input
                     if (file.size > 5 * 1024 * 1024) {
                         alert("File terlalu besar! Maksimal 5MB.");
                         return;
                     }
                     try {
                        const compressed = await processImage(file);
                        setStoreData(prev => ({...prev, logo: compressed}));
                     } catch (err) {
                        alert("Gagal memproses gambar: " + err.message);
                     }
                 } 
             };

             const saveProfile = async (e) => { 
                e.preventDefault(); 
                setSaving(true); 
                try { 
                    if(!activeStore?.id) throw new Error("Data toko tidak ditemukan.");
                    
                    // Explicitly update only relevant fields
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'stores', activeStore.id), {
                        name: storeData.name || '',
                        address: storeData.address || '',
                        phone: storeData.phone || '',
                        logo: storeData.logo || null
                    }); 
                    alert("Profil Toko Disimpan!"); 
                } catch(err) { 
                    alert("Gagal: " + err.message); 
                } finally { 
                    setSaving(false); 
                } 
             };
             
             // Simpan koordinat GPS toko
             const saveGPS = async (e) => {
                 if (e && e.preventDefault) e.preventDefault();
                 if (!activeStore?.id) { alert('Pilih toko dulu.'); return; }
                 const lat = parseFloat(storeData.gps_lat);
                 const lon = parseFloat(storeData.gps_lon);
                 const radius = parseInt(storeData.gps_radius) || 200;
                 if (isNaN(lat) || isNaN(lon)) { alert('Koordinat GPS tidak valid. Gunakan tombol "Ambil Lokasi Toko Sekarang".'); return; }
                 if (radius < 50 || radius > 2000) { alert('Radius harus antara 50 - 2000 meter.'); return; }
                 setSavingGPS(true);
                 try {
                     await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'stores', activeStore.id), {
                         gps_lat: lat, gps_lon: lon, gps_radius: radius
                     });
                     alert('‚úÖ Lokasi GPS toko berhasil disimpan!');
                 } catch(err) { alert('Gagal simpan GPS: ' + err.message); }
                 finally { setSavingGPS(false); }
             };

             const getMyGPS = () => {
                 if (!navigator.geolocation) { alert('Browser tidak mendukung GPS.'); return; }
                 setGettingGPS(true);
                 navigator.geolocation.getCurrentPosition(
                     (pos) => {
                         setStoreData(prev => ({
                             ...prev,
                             gps_lat: pos.coords.latitude.toFixed(8),
                             gps_lon: pos.coords.longitude.toFixed(8)
                         }));
                         setGettingGPS(false);
                         alert(`‚úÖ Koordinat berhasil diambil!\nLat: ${pos.coords.latitude.toFixed(6)}\nLon: ${pos.coords.longitude.toFixed(6)}\nAkurasi: ${Math.round(pos.coords.accuracy)}m\n\nKlik Simpan untuk menyimpan.`);
                     },
                     (err) => {
                         setGettingGPS(false);
                         alert('Gagal ambil GPS: ' + err.message);
                     },
                     { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
                 );
             };

             const handleCreateBranch = async (e) => {
                 e.preventDefault();
                 
                 // LIMITATION CHECK: PLAN-BASED STORE LIMITS
                 if (activeOwner.plan === 'basic' && availableStores.length >= 1) {
                     alert("üö´ AKSES DITOLAK: Basic Plan hanya diizinkan memiliki 1 cabang (Toko Pusat).\n\nSilakan hubungi Developer untuk upgrade ke PRO Plan (max 5 cabang).");
                     return;
                 }
                 
                 // NEW: PRO PLAN MAX 5 STORES
                 if (activeOwner.plan === 'pro' && availableStores.length >= 5) {
                     alert("üö´ LIMIT TERCAPAI: Pro Plan maksimal 5 cabang.\n\nAnda sudah memiliki " + availableStores.length + " cabang.\n\nHubungi Developer untuk solusi Enterprise jika membutuhkan lebih banyak cabang.");
                     return;
                 }

                 setSaving(true);
                 const formData = new FormData(e.target);
                 try {
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'stores'), {
                         ownerId: activeOwner.id,
                         name: formData.get('name'),
                         address: formData.get('address'),
                         phone: formData.get('phone'),
                         createdAt: serverTimestamp()
                     });
                     alert("Cabang baru berhasil dibuka!");
                     setBranchModalOpen(false);
                 } catch(e) {
                     alert("Error: " + e.message);
                 } finally {
                     setSaving(false);
                 }
             };

             const saveStorePermissions = async (e) => {
                 e.preventDefault();
                 setSaving(true);
                 try {
                     const formData = new FormData(e.target);
                     const roleToSave = formData.get('_selectedRole') || 'admin';
                     const g = (k) => formData.get(k) === 'on';
                     const rolePermissions = {
                         menu_dashboard: g('menu_dashboard'),
                         menu_report: g('menu_report'),
                         menu_service: g('menu_service'),
                         menu_sales: g('menu_sales'),
                         menu_purchase: g('menu_purchase'),
                         menu_return_sales: g('menu_return_sales'),
                         menu_return_purchase: g('menu_return_purchase'),
                         menu_after_sales: g('menu_after_sales'),
                         menu_payable: g('menu_payable'),
                         menu_receivable: g('menu_receivable'),
                         menu_cash: g('menu_cash'),
                         menu_finance: g('menu_finance'),
                         menu_inventory: g('menu_inventory'),
                         menu_supplier: g('menu_supplier'),
                         menu_customers: g('menu_customers'),
                         menu_hr: g('menu_hr'),
                         menu_ai_assistant: g('menu_ai_assistant'),
                         menu_users: g('menu_users'),
                         menu_settings: g('menu_settings'),
                         feature_service_edit: g('feature_service_edit'),
                         feature_sales_edit: g('feature_sales_edit'),
                         feature_inventory_edit: g('feature_inventory_edit'),
                         feature_customer_edit: g('feature_customer_edit'),
                         feature_employee_edit: g('feature_employee_edit'),
                         feature_finance_edit: g('feature_finance_edit'),
                         feature_print: g('feature_print'),
                         feature_share: g('feature_share'),
                         feature_delete: g('feature_delete'),
                         feature_stock_add: g('feature_stock_add'),
                         feature_backup: g('feature_backup'),
                         feature_import_export: g('feature_import_export'),
                         feature_multi_branch: g('feature_multi_branch'),
                         feature_qc_checklist: g('feature_qc_checklist'),
                         feature_kelengkapan: g('feature_kelengkapan'),
                         feature_accounting: g('feature_accounting'),
                         feature_subdomain: g('feature_subdomain'),
                         dash_servis_selesai: g('dash_servis_selesai'),
                         dash_untung_jasa: g('dash_untung_jasa'),
                         dash_pemasukan: g('dash_pemasukan'),
                         dash_pengeluaran: g('dash_pengeluaran'),
                         dash_untung_jual: g('dash_untung_jual'),
                         dash_komp_retur: g('dash_komp_retur'),
                         dash_nilai_stok: g('dash_nilai_stok'),
                         dash_total_keuntungan: g('dash_total_keuntungan'),
                         feature_show_modal: g('feature_show_modal'),
                     };

                     // Ambil permissions existing, update hanya role yang dipilih
                     const existingPermissions = storeConfig?.permissions || {};
                     const updatedPermissions = { ...existingPermissions, [roleToSave]: rolePermissions };

                     const q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('storeId', '==', activeStore.id));
                     const snap = await getDocs(q);
                     if (snap.empty) {
                         await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), {
                             storeId: activeStore.id,
                             ownerId: activeOwner.id,
                             permissions: updatedPermissions
                         });
                     } else {
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'store_configs', snap.docs[0].id), { permissions: updatedPermissions });
                     }

                     const roleLabel = roleToSave === 'admin' ? 'Admin' : roleToSave === 'kasir' ? 'Kasir' : 'Teknisi';
                     alert(`‚úÖ Hak akses ${roleLabel} berhasil disimpan!\n\nüîÑ Perubahan tersinkronisasi real-time ke semua perangkat karyawan.`);
                     setModal(null);
                 } catch (err) {
                     alert("‚ùå Gagal menyimpan: " + err.message);
                 } finally {
                     setSaving(false);
                 }
             };

             const handleBackup = async () => {
                 if (!checkPermission('feature_backup')) { showAccessDenied('Fitur Backup hanya tersedia untuk PRO Plan.'); return; }
                 const backupData = { version: '1.0', timestamp: new Date().toISOString(), services: [], inventory: [], transactions: [], customers: [] };
                 const fetchCol = async (name) => { const q = query(collection(db, APP_COLLECTION_PREFIX, 'public', name), where('ownerId', '==', activeOwner.id)); const snap = await getDocs(q); return snap.docs.map(d => ({id: d.id, ...d.data()})); }
                 try { setSaving(true); backupData.services = await fetchCol('services'); backupData.inventory = await fetchCol('inventory'); backupData.transactions = await fetchCol('transactions'); backupData.customers = await fetchCol('customers'); const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `ifix_backup_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); } catch(e) { alert("Gagal backup: " + e.message); } finally { setSaving(false); }
             };

             const handleRestore = async (e) => {
                 const file = e.target.files[0]; if (!file) return;
                 if (!checkPermission('feature_backup')) { showAccessDenied('Fitur Restore hanya tersedia untuk PRO Plan.'); return; }
                 if (!confirm("PERINGATAN: Restore akan menimpa/menambah data yang ada. Apakah Anda yakin ingin melanjutkannya?")) return;
                 const reader = new FileReader();
                 reader.onload = async (event) => {
                     try {
                         setRestoring(true);
                         const json = JSON.parse(event.target.result);
                         const collectionsToRestore = ['services', 'inventory', 'transactions', 'customers'];
                         let totalItems = 0;
                         for (const key of collectionsToRestore) {
                             if (json[key] && Array.isArray(json[key])) {
                                 const batchArray = []; let currentBatch = writeBatch(db); let count = 0;
                                 for (const item of json[key]) {
                                     const cleanItem = normalizeFirestoreData(item);
                                     cleanItem.ownerId = activeOwner.id; cleanItem.storeId = activeStore.id; 
                                     const docRef = cleanItem.id ? doc(db, APP_COLLECTION_PREFIX, 'public', key, cleanItem.id) : doc(collection(db, APP_COLLECTION_PREFIX, 'public', key));
                                     currentBatch.set(docRef, cleanItem, { merge: true });
                                     count++; totalItems++;
                                     if (count >= 400) { batchArray.push(currentBatch); currentBatch = writeBatch(db); count = 0; }
                                 }
                                 if (count > 0) batchArray.push(currentBatch);
                                 for (const batch of batchArray) { await batch.commit(); }
                             }
                         }
                         alert(`Restore Berhasil! Total ${totalItems} data dipulihkan.`); window.location.reload();
                     } catch (err) { alert("Gagal restore: " + err.message); console.error(err); } finally { setRestoring(false); }
                 };
                 reader.readAsText(file);
             };

             // NEW: Reset All Data Function
             const resetAllData = async () => {
                 const confirmText = prompt(
                     "‚ö†Ô∏è BAHAYA: Ini akan menghapus SEMUA DATA TOKO!\n\nData yang akan dihapus:\n- Semua servis\n- Semua transaksi\n- Semua pelanggan\n- Semua stok barang\n- Semua riwayat penjualan\n\nKetik 'RESET SEMUA DATA' untuk konfirmasi:"
                 );
                 
                 if (confirmText !== 'RESET SEMUA DATA') {
                     alert('‚ùå Konfirmasi dibatalkan');
                     return;
                 }
                 
                 if (!confirm(`üö® KONFIRMASI TERAKHIR\n\nüìã SEMUA DATA AKAN TERHAPUS PERMANEN!\n\nüö´ TIDAK BISA DIKEMBALIKAN!\n\nAnda yakin ingin melanjutkan?`)) {
                     return;
                 }
                 
                 try {
                     setRestoring(true);
                     console.log('üóëÔ∏è Starting complete data reset...');
                     
                     const collectionsToReset = ['services', 'inventory', 'transactions', 'customers', 'sales'];
                     let totalDeleted = 0;
                     
                     // Delete each collection
                     for (const collectionName of collectionsToReset) {
                         console.log(`Deleting ${collectionName}...`);
                         
                         const collectionRef = collection(db, APP_COLLECTION_PREFIX, 'public', collectionName);
                         const q = query(collectionRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                         const snapshot = await getDocs(q);
                         
                         if (snapshot.docs.length > 0) {
                             // Delete in batches
                             const batchArray = [];
                             let currentBatch = writeBatch(db);
                             let count = 0;
                             
                             snapshot.docs.forEach(doc => {
                                 currentBatch.delete(doc.ref);
                                 count++;
                                 totalDeleted++;
                                 
                                 if (count >= 450) {
                                     batchArray.push(currentBatch);
                                     currentBatch = writeBatch(db);
                                     count = 0;
                                 }
                             });
                             
                             if (count > 0) {
                                 batchArray.push(currentBatch);
                             }
                             
                             // Commit all batches for this collection
                             for (const batch of batchArray) {
                                 await batch.commit();
                             }
                             
                             console.log(`‚úÖ Deleted ${snapshot.docs.length} ${collectionName}`);
                         }
                     }
                     
                     console.log('‚úÖ Complete data reset finished');
                     alert(`‚úÖ RESET BERHASIL!\n\nüìã Total ${totalDeleted} data terhapus\nüéÜ Toko kembali seperti baru!\n\nüîÑ Halaman akan dimuat ulang...`);
                     
                     // Reload page to refresh all data
                     setTimeout(() => {
                         window.location.reload();
                     }, 1500);
                     
                 } catch (err) {
                     console.error('‚ùå Error in data reset:', err);
                     alert(`‚ùå Gagal reset data: ${err.message}`);
                 } finally {
                     setRestoring(false);
                 }
             };

             const handleChangePassword = async (e) => {
                 e.preventDefault();
                 const formData = new FormData(e.target);
                 const currentPassword = formData.get('currentPassword');
                 const newPassword = formData.get('newPassword');
                 const confirmPassword = formData.get('confirmPassword');
                 
                 if (newPassword !== confirmPassword) {
                     alert('‚ùå Password baru dan konfirmasi tidak cocok!');
                     return;
                 }
                 
                 if (newPassword.length < 6) {
                     alert('‚ùå Password baru minimal 6 karakter!');
                     return;
                 }
                 
                 setSaving(true);
                 try {
                     const currentUser = auth.currentUser;
                     
                     // Reautentikasi user dengan password lama
                     const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                     await reauthenticateWithCredential(currentUser, credential);
                     
                     // Update password baru
                     await updatePassword(currentUser, newPassword);
                     
                     alert('‚úÖ Password berhasil diubah!\n\nGunakan password baru untuk login berikutnya.');
                     setModal(null);
                 } catch (err) {
                     console.error('Error changing password:', err);
                     if (err.code === 'auth/wrong-password') {
                         alert('‚ùå Password lama salah!');
                     } else if (err.code === 'auth/requires-recent-login') {
                         alert('‚ùå Sesi login Anda sudah terlalu lama. Silakan logout dan login kembali untuk mengganti password.');
                     } else {
                         alert('‚ùå Gagal mengganti password: ' + err.message);
                     }
                 } finally {
                     setSaving(false);
                 }
             };

             return (
                 <div className="space-y-2 max-w-4xl">
                     {/* PROFIL TOKO */}
                     <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                         <button onClick={() => toggleSect('profil-toko')} className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                             <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-slate-800">
                                 <Store className="w-5 h-5 text-blue-600"/> Profil Toko
                             </h3>
                             <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 ${openSect.has('profil-toko') ? 'rotate-180' : ''}`}/>
                         </button>
                         {openSect.has('profil-toko') && (
                         <div className="px-4 sm:px-5 pb-4 sm:pb-5 border-t border-slate-100 pt-4">
                         <div className="flex flex-wrap justify-between items-center gap-2 mb-3">
                             <div className={`text-xs font-bold px-3 py-1.5 rounded-lg ${activeOwner.plan === 'basic' ? 'bg-blue-50 text-blue-700 border border-blue-200' : 'bg-purple-50 text-purple-700 border border-purple-200'}`}>
                                 {activeOwner.plan === 'basic' ? (
                                     <span>üìä BASIC: Max 1 cabang {availableStores.length >= 1 && '(Limit)'}</span>
                                 ) : (
                                     <span>üìä PRO: {availableStores.length}/5 cabang {availableStores.length >= 5 && '(Limit)'}</span>
                                 )}
                             </div>
                             <button 
                                 onClick={()=>setBranchModalOpen(true)} 
                                 disabled={(activeOwner.plan === 'basic' && availableStores.length >= 1) || (activeOwner.plan === 'pro' && availableStores.length >= 5)}
                                 className="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-700 flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed"
                             >
                                 <Plus className="w-3.5 h-3.5"/> Cabang Baru
                             </button>
                         </div>
                         
                         <form onSubmit={saveProfile} className="space-y-6"><div className="flex items-center gap-6">
                            
                            {/* FIX: LOGO UPLOADER */}
                            <div className="w-24 h-24 rounded-2xl border-2 border-dashed border-slate-300 flex items-center justify-center bg-slate-50 overflow-hidden relative group cursor-pointer hover:border-blue-500 transition-colors">
                                {storeData.logo ? <img src={storeData.logo} className="w-full h-full object-contain pointer-events-none"/> : <ImageIcon className="w-8 h-8 text-slate-300 pointer-events-none"/>}
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs font-bold pointer-events-none">Ganti Logo</div>
                                <input type="file" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" accept="image/*" onChange={handleLogo} title="Ganti Logo Toko"/>
                            </div>

                            <div><h4 className="font-bold text-slate-700">Logo Struk</h4><p className="text-xs text-slate-500 mb-2">Format: JPG/PNG, Max 5MB</p></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Toko</label><input className="w-full border border-slate-300 p-3 rounded-lg font-bold text-slate-800" value={storeData.name||''} onChange={e=>setStoreData({...storeData, name:e.target.value})}/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">No Telepon</label><input className="w-full border border-slate-300 p-3 rounded-lg" value={storeData.phone||''} onChange={e=>setStoreData({...storeData, phone:e.target.value})}/></div><div className="md:col-span-2"><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Alamat</label><input className="w-full border border-slate-300 p-3 rounded-lg" value={storeData.address||''} onChange={e=>setStoreData({...storeData, address:e.target.value})}/></div></div><div className="flex justify-end"><button disabled={saving} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-600/30 transition-all">{saving?'Saving...':'Simpan Perubahan'}</button></div></form>
                     </div>)}
                     </div>
                     {isBranchModalOpen && (
                         <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                 <h3 className="font-bold text-xl mb-6 text-slate-800">Buka Cabang Baru</h3>
                                 <form onSubmit={handleCreateBranch} className="space-y-4">
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Nama Cabang</label>
                                         <input name="name" className="w-full border p-3 rounded-lg focus:outline-blue-500" placeholder="Contoh: iFix Jakarta Selatan" required/>
                                     </div>
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Alamat Cabang</label>
                                         <input name="address" className="w-full border p-3 rounded-lg focus:outline-blue-500" placeholder="Alamat lengkap..." required/>
                                     </div>
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">No Telepon</label>
                                         <input name="phone" className="w-full border p-3 rounded-lg focus:outline-blue-500" placeholder="08..." required/>
                                     </div>
                                     <div className="flex gap-3 mt-6">
                                         <button type="button" onClick={()=>setBranchModalOpen(false)} className="flex-1 py-3 border rounded-xl font-bold hover:bg-slate-50">Batal</button>
                                         <button disabled={saving} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center gap-2">
                                             {saving && <Loader2 className="w-4 h-4 animate-spin"/>} Buat Cabang
                                         </button>
                                     </div>
                                 </form>
                             </div>
                         </div>
                     )}

                     {/* üìç LOKASI GPS ABSENSI */}
                     <div className="bg-white rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-blue-500 overflow-hidden">
                         <button onClick={() => toggleSect('gps-absensi')} className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                             <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-slate-800">
                                 <MapPin className="w-5 h-5 text-blue-600"/> Lokasi GPS Absensi Karyawan
                             </h3>
                             <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 ${openSect.has('gps-absensi') ? 'rotate-180' : ''}`}/>
                         </button>
                         {openSect.has('gps-absensi') && (
                         <div className="px-4 sm:px-5 pb-5 border-t border-slate-100 pt-4 space-y-4">

                             {/* Tombol utama ‚Äî paling mudah */}
                             <button type="button" onClick={getMyGPS} disabled={gettingGPS}
                                 className="w-full py-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white rounded-2xl font-bold text-base disabled:opacity-60 flex items-center justify-center gap-3 shadow-lg shadow-blue-600/30 transition-all">
                                 {gettingGPS
                                     ? <><Loader2 className="w-5 h-5 animate-spin"/> Mendeteksi lokasi HP Anda...</>
                                     : <><MapPin className="w-5 h-5"/> üìç Ambil Lokasi Toko Sekarang</>}
                             </button>
                             <p className="text-xs text-center text-slate-400">Tap tombol di atas saat Anda berada di lokasi toko</p>

                             {/* Preview koordinat + maps link */}
                             {storeData.gps_lat && storeData.gps_lon && (
                                 <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-3 space-y-2">
                                     <div className="flex items-center justify-between">
                                         <span className="text-xs font-bold text-emerald-700">‚úÖ Lokasi Toko</span>
                                         <a href={`https://maps.google.com/?q=${storeData.gps_lat},${storeData.gps_lon}`} target="_blank"
                                             className="text-xs bg-white border border-emerald-300 text-emerald-700 font-bold px-3 py-1 rounded-lg hover:bg-emerald-100 flex items-center gap-1">
                                             <MapPin className="w-3 h-3"/> Lihat di Maps
                                         </a>
                                     </div>
                                     <p className="font-mono text-xs text-emerald-800 bg-white rounded-lg px-2 py-1.5 border border-emerald-200">
                                         {parseFloat(storeData.gps_lat).toFixed(7)}, {parseFloat(storeData.gps_lon).toFixed(7)}
                                     </p>
                                 </div>
                             )}

                             {/* Radius ‚Äî preset buttons + input manual */}
                             <div>
                                 <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Radius Absensi</label>
                                 <div className="flex gap-2 mb-2 flex-wrap">
                                     {[50, 100, 150, 200, 300, 500].map(r => (
                                         <button key={r} type="button"
                                             onClick={() => setStoreData({...storeData, gps_radius: r})}
                                             className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${String(storeData.gps_radius) === String(r) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-300 hover:border-blue-400'}`}>
                                             {r}m
                                         </button>
                                     ))}
                                 </div>
                                 <div className="flex items-center gap-2">
                                     <input
                                         type="number" min="50" max="2000"
                                         className="w-32 border border-slate-300 p-2.5 rounded-lg text-sm text-center font-bold"
                                         placeholder="200"
                                         value={storeData.gps_radius ?? ''}
                                         onChange={e => setStoreData({...storeData, gps_radius: e.target.value === '' ? '' : Number(e.target.value)})}
                                     />
                                     <span className="text-sm text-slate-500">meter &mdash; {storeData.gps_radius ? (storeData.gps_radius <= 100 ? 'üè† Toko kecil' : storeData.gps_radius <= 200 ? 'üè™ Normal' : storeData.gps_radius <= 400 ? 'üè¨ Area luas' : 'üè≠ Sangat luas') : ''}</span>
                                 </div>
                                 <p className="text-xs text-slate-400 mt-1">Karyawan harus dalam radius ini untuk bisa absen. Rekomendasi: 150‚Äì200m.</p>
                             </div>

                             {/* Koordinat manual (lipat ke bawah) */}
                             <details className="text-xs">
                                 <summary className="cursor-pointer text-slate-400 hover:text-slate-600 font-medium select-none">‚úèÔ∏è Edit koordinat manual</summary>
                                 <div className="grid grid-cols-2 gap-2 mt-2">
                                     <div>
                                         <label className="text-xs text-slate-500 mb-1 block">Latitude</label>
                                         <input type="text" className="w-full border border-slate-300 p-2 rounded-lg font-mono text-xs"
                                             placeholder="-6.200000"
                                             value={storeData.gps_lat || ''}
                                             onChange={e => setStoreData({...storeData, gps_lat: e.target.value})}/>
                                     </div>
                                     <div>
                                         <label className="text-xs text-slate-500 mb-1 block">Longitude</label>
                                         <input type="text" className="w-full border border-slate-300 p-2 rounded-lg font-mono text-xs"
                                             placeholder="106.816666"
                                             value={storeData.gps_lon || ''}
                                             onChange={e => setStoreData({...storeData, gps_lon: e.target.value})}/>
                                     </div>
                                 </div>
                             </details>

                             <button onClick={saveGPS} disabled={savingGPS || !storeData.gps_lat || !storeData.gps_lon}
                                 className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold text-sm disabled:opacity-50 flex items-center justify-center gap-2 shadow-lg shadow-emerald-600/20 transition-all">
                                 {savingGPS ? <><Loader2 className="w-4 h-4 animate-spin"/> Menyimpan...</> : 'üíæ Simpan Pengaturan GPS'}
                             </button>

                             <div className="bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs text-slate-500 space-y-1">
                                 <p className="font-bold text-slate-600">‚ÑπÔ∏è Cara kerja:</p>
                                 <p>‚Ä¢ Karyawan hanya bisa absen dalam radius yang ditentukan</p>
                                 <p>‚Ä¢ Sistem mendeteksi GPS palsu (fake GPS) secara otomatis</p>
                                 <p>‚Ä¢ GPS sinyal lemah (&gt;150m akurasi) akan ditolak</p>
                             </div>
                         </div>)}
                     </div>

                     {/* PROFIL OWNER */}
                     <div className="bg-white rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-green-500 overflow-hidden">
                         <button onClick={() => toggleSect('profil-owner')} className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                             <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-slate-800"><User className="w-5 h-5 text-green-600"/> Profil Owner</h3>
                             <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 ${openSect.has('profil-owner') ? 'rotate-180' : ''}`}/>
                         </button>
                         {openSect.has('profil-owner') && (
                         <div className="px-4 sm:px-5 pb-4 sm:pb-5 border-t border-slate-100 pt-4 space-y-3">
                             <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                 <div>
                                     <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Bisnis</label>
                                     <input className="w-full border border-slate-300 p-2.5 rounded-lg text-sm font-bold text-slate-800 bg-slate-50" value={activeOwner?.name || ''} disabled/>
                                 </div>
                                 <div>
                                     <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Email Login</label>
                                     <input className="w-full border border-slate-300 p-2.5 rounded-lg text-sm text-slate-800 bg-slate-50" value={user?.email || ''} disabled/>
                                 </div>
                             </div>
                             <div className="flex items-center justify-between bg-blue-50 border border-blue-200 p-3 rounded-lg">
                                 <div className="flex items-center gap-2">
                                     <Package className="w-5 h-5 text-blue-600"/>
                                     <p className="font-bold text-blue-900 text-sm">Paket Langganan</p>
                                 </div>
                                 <span className="text-lg font-black text-blue-600 uppercase">{activeOwner?.plan || 'Basic'}</span>
                             </div>
                             <p className="text-xs text-slate-400">üí° Hubungi developer untuk mengubah data owner / upgrade paket</p>
                         </div>
                         )}
                     </div>

                     {/* üåê SUBDOMAIN CUSTOM ‚Äî Fitur Premium */}
                     <SubdomainManager activeOwner={activeOwner} />

                     {/* GANTI PASSWORD */}
                     <div className="bg-white rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-yellow-500 overflow-hidden">
                         <button onClick={() => toggleSect('password')} className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                             <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-slate-800"><Lock className="w-5 h-5 text-yellow-600"/> Ganti Password</h3>
                             <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 ${openSect.has('password') ? 'rotate-180' : ''}`}/>
                         </button>
                         {openSect.has('password') && (
                         <div className="px-4 sm:px-5 pb-4 sm:pb-5 border-t border-slate-100 pt-4">
                             <p className="text-sm text-slate-500 mb-3">Ubah password login untuk keamanan akun Anda</p>
                             <button 
                                 onClick={() => setModal('changePassword')}
                                 className="w-full bg-gradient-to-r from-yellow-600 to-orange-600 text-white p-3 rounded-xl font-bold hover:from-yellow-700 hover:to-orange-700 transition-all flex items-center justify-center gap-2 shadow-lg"
                             >
                                 <Key className="w-5 h-5"/>
                                 Ubah Password Saya
                             </button>
                         </div>
                         )}
                     </div>

                     {/* MASTER DATA MANAGEMENT */}
                     <div className="bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl border border-purple-200 shadow-sm overflow-hidden">
                         <button onClick={() => toggleSect('master-data')} className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                             <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-slate-800"><Settings className="w-5 h-5 text-purple-600"/> Master Data</h3>
                             <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 ${openSect.has('master-data') ? 'rotate-180' : ''}`}/>
                         </button>
                         {openSect.has('master-data') && (
                         <div className="px-4 sm:px-5 pb-4 sm:pb-5 border-t border-purple-100 pt-4">
                         <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3">
                             {[
                                 {
                                     title: 'Cek Fungsional',
                                     desc: 'Item QC',
                                     emoji: '‚úì',
                                     icon: <CheckCircle className="w-5 h-5 text-green-600"/>,
                                     onClick: () => setModal('qcItems'),
                                     color: 'from-green-50 to-green-100 border-green-200'
                                 },
                                 {
                                     title: 'Kelengkapan',
                                     desc: 'Item kelengkapan',
                                     emoji: 'üì¶',
                                     icon: <Box className="w-5 h-5 text-blue-600"/>,
                                     onClick: () => setModal('kelengkapanItems'),
                                     color: 'from-blue-50 to-blue-100 border-blue-200'
                                 },
                                 {
                                     title: 'Kategori Stok',
                                     desc: 'Kategori & sub',
                                     emoji: 'üè∑Ô∏è',
                                     icon: <Tag className="w-5 h-5 text-orange-600"/>,
                                     onClick: () => setModal('categoryItems'),
                                     color: 'from-orange-50 to-orange-100 border-orange-200'
                                 },
                                 {
                                     title: 'Brand',
                                     desc: 'Daftar brand',
                                     emoji: 'üîñ',
                                     icon: <Tag className="w-5 h-5 text-purple-600"/>,
                                     onClick: () => setModal('brandItems'),
                                     color: 'from-purple-50 to-purple-100 border-purple-200'
                                 },
                                 {
                                     title: 'Setting Stok',
                                     desc: 'Duplikasi & validasi',
                                     emoji: '‚öôÔ∏è',
                                     icon: <Settings className="w-5 h-5 text-slate-600"/>,
                                     onClick: () => setModal('inventorySettings'),
                                     color: 'from-slate-50 to-slate-100 border-slate-200'
                                 }
                             ].map((item, idx) => (
                                 <button
                                     key={idx}
                                     onClick={item.onClick}
                                     className={`bg-gradient-to-br ${item.color} p-3 rounded-xl border hover:shadow-md transition-all text-left group`}
                                 >
                                     <div className="flex items-center gap-2 mb-1">
                                         {item.icon}
                                         <h4 className="font-bold text-slate-800 text-xs sm:text-sm group-hover:text-slate-900 leading-tight">{item.title}</h4>
                                     </div>
                                     <p className="text-xs text-slate-500">{item.desc}</p>
                                 </button>
                             ))}
                         </div>
                         </div>
                         )}
                     </div>

                     {/* EMPLOYEE PERMISSIONS */}
                     <div className="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-2xl border border-cyan-200 shadow-sm overflow-hidden">
                         <button onClick={() => toggleSect('hak-akses')} className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                             <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-slate-800"><ShieldCheck className="w-5 h-5 text-cyan-600"/> Hak Akses Karyawan</h3>
                             <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 ${openSect.has('hak-akses') ? 'rotate-180' : ''}`}/>
                         </button>
                         {openSect.has('hak-akses') && (
                         <div className="px-4 sm:px-5 pb-4 sm:pb-5 border-t border-cyan-100 pt-4">
                             <p className="text-sm text-slate-600 mb-3">Kontrol menu & fitur yang dapat diakses Admin/Teknisi. <strong className="text-orange-600">Owner selalu punya akses penuh.</strong></p>
                             <button 
                                 onClick={() => setModal('storePermissions')}
                                 className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white p-3 rounded-xl font-bold hover:from-cyan-700 hover:to-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg"
                             >
                                 <Settings className="w-5 h-5"/>
                                 Kelola Hak Akses Karyawan
                             </button>
                         </div>
                         )}
                     </div>

                     <div className="bg-white rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-orange-500 overflow-hidden">
                         <button onClick={() => toggleSect('backup')} className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                             <div className="flex items-center gap-2">
                                 <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-slate-800"><Database className="w-5 h-5 text-orange-600"/> Backup & Restore</h3>
                                 {activeOwner.plan === 'basic' && <span className="bg-slate-100 text-slate-500 px-2 py-0.5 rounded text-[10px] font-bold border border-slate-200">LOCKED</span>}
                                 {activeOwner.plan === 'pro' && <span className="bg-purple-100 text-purple-600 px-2 py-0.5 rounded text-[10px] font-bold border border-purple-200">PRO</span>}
                             </div>
                             <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 flex-shrink-0 ${openSect.has('backup') ? 'rotate-180' : ''}`}/>
                         </button>
                         {openSect.has('backup') && (
                         <div className="px-4 sm:px-5 pb-4 sm:pb-5 border-t border-slate-100 pt-4">
                             <div className="grid grid-cols-2 gap-3">
                                 <div className={`bg-slate-50 p-4 rounded-xl border border-slate-200 flex flex-col items-center text-center ${activeOwner.plan === 'basic' ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                                     <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-2"><HardDriveDownload className="w-5 h-5"/></div>
                                     <h4 className="font-bold text-slate-800 text-sm">Download</h4>
                                     <p className="text-xs text-slate-500 mt-1 mb-3">Backup semua data ke file JSON.</p>
                                     <button onClick={handleBackup} disabled={saving} className="mt-auto w-full py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700">{saving ? 'Proses...' : 'Download JSON'}</button>
                                 </div>
                                 <div className={`bg-slate-50 p-4 rounded-xl border border-slate-200 flex flex-col items-center text-center ${activeOwner.plan === 'basic' ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                                     <div className="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-2"><HardDriveUpload className="w-5 h-5"/></div>
                                     <h4 className="font-bold text-slate-800 text-sm">Restore</h4>
                                     <p className="text-xs text-slate-500 mt-1 mb-3">Upload file .json untuk restore data.</p>
                                     <label className={`mt-auto w-full py-2 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700 cursor-pointer flex items-center justify-center gap-1 ${restoring ? 'opacity-50 cursor-wait' : ''}`}>{restoring ? <Loader2 className="w-4 h-4 animate-spin"/> : <Upload className="w-4 h-4"/>} {restoring ? 'Restore...' : 'Pilih JSON'}<input type="file" accept=".json" onChange={handleRestore} disabled={restoring} className="hidden"/></label>
                                 </div>
                             </div>
                         </div>
                         )}
                     </div>

                     {/* DANGER ZONE - RESET DATA */}
                     <div className="bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl border-2 border-red-200 shadow-sm overflow-hidden">
                         <button onClick={() => toggleSect('danger')} className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                             <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-red-800"><AlertTriangle className="w-5 h-5 text-red-600"/> Danger Zone</h3>
                             <ChevronDown className={`w-5 h-5 text-red-400 transition-transform duration-200 ${openSect.has('danger') ? 'rotate-180' : ''}`}/>
                         </button>
                         {openSect.has('danger') && (
                         <div className="px-4 sm:px-5 pb-4 sm:pb-5 border-t border-red-100 pt-4">
                             <div className="bg-white p-4 rounded-xl border-2 border-red-200 flex flex-col sm:flex-row items-center gap-4">
                                 <div className="flex-shrink-0 w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center">
                                     <Trash2 className="w-6 h-6"/>
                                 </div>
                                 <div className="flex-1 text-center sm:text-left">
                                     <h4 className="font-bold text-red-800 mb-1">Reset Semua Data Toko</h4>
                                     <p className="text-xs text-red-600 mb-3">‚ö†Ô∏è Menghapus SEMUA servis, transaksi, pelanggan, stok. <strong>Tidak bisa dikembalikan!</strong> Backup dulu sebelum reset.</p>
                                     <button 
                                         onClick={resetAllData}
                                         disabled={restoring}
                                         className="w-full sm:w-auto px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2"
                                     >
                                         {restoring ? <><Loader2 className="w-4 h-4 animate-spin"/>Menghapus...</> : <><Trash2 className="w-4 h-4"/>Reset Semua Data</>}
                                     </button>
                                 </div>
                             </div>
                         </div>
                         )}
                     </div>

                     {/* USER GUIDE PDF */}
                     <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border border-blue-200 shadow-sm overflow-hidden">
                         <button onClick={() => toggleSect('panduan')} className="w-full flex items-center justify-between px-4 py-3 sm:px-5 sm:py-4 text-left">
                             <h3 className="font-bold text-base sm:text-lg flex items-center gap-2 text-slate-800"><FileText className="w-5 h-5 text-blue-600"/> Panduan Aplikasi</h3>
                             <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 ${openSect.has('panduan') ? 'rotate-180' : ''}`}/>
                         </button>
                         {openSect.has('panduan') && (
                         <div className="px-4 sm:px-5 pb-4 sm:pb-5 border-t border-blue-100 pt-4">
                         <div className="bg-white p-4 rounded-xl border border-blue-100">
                             <div className="grid grid-cols-2 gap-2 mb-4">
                                 {[
                                   {icon:<FileText className="w-4 h-4 text-blue-600"/>, bg:'bg-blue-100', title:'Format PDF', sub:'Dokumen profesional'},
                                   {icon:<ImageIcon className="w-4 h-4 text-green-600"/>, bg:'bg-green-100', title:'Screenshot', sub:'Panduan visual'},
                                   {icon:<Zap className="w-4 h-4 text-purple-600"/>, bg:'bg-purple-100', title:'Auto-Update', sub:'Selalu terbaru'},
                                   {icon:<Download className="w-4 h-4 text-orange-600"/>, bg:'bg-orange-100', title:'Offline', sub:'Simpan lokal'},
                                 ].map((f,i) => (
                                   <div key={i} className="flex items-center gap-2">
                                     <div className={`w-8 h-8 ${f.bg} rounded-lg flex items-center justify-center flex-shrink-0`}>{f.icon}</div>
                                     <div><p className="font-bold text-xs">{f.title}</p><p className="text-[10px] text-slate-500">{f.sub}</p></div>
                                   </div>
                                 ))}
                             </div>
                             <div className="bg-slate-50 p-3 rounded-lg mb-3">
                                 <p className="text-xs font-bold text-slate-700 mb-1">üìö Mencakup:</p>
                                 <p className="text-xs text-slate-500">Dashboard, Servis HP, Stok, Keuangan, Customer, HR & Payroll, Multi-Branch, Backup & Restore, Tips & Trik</p>
                             </div>
                             
                             <button
                                 onClick={async () => {
                                     setSaving(true);
                                     try {
                                         const doc = new jsPDF('p', 'mm', 'a4');
                                         const pageWidth = doc.internal.pageSize.getWidth();
                                         const pageHeight = doc.internal.pageSize.getHeight();
                                         const margin = 15;
                                         let yPos = margin;

                                         // Helper function to add new page
                                         const checkPage = (neededSpace = 20) => {
                                             if (yPos + neededSpace > pageHeight - margin) {
                                                 doc.addPage();
                                                 yPos = margin;
                                                 return true;
                                             }
                                             return false;
                                         };

                                         // Cover Page
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(0, 0, pageWidth, pageHeight, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(32);
                                         doc.text('iFix POS', pageWidth / 2, 80, { align: 'center' });
                                         doc.setFontSize(18);
                                         doc.text('Panduan Penggunaan Aplikasi', pageWidth / 2, 100, { align: 'center' });
                                         doc.setFontSize(12);
                                         doc.text('Sistem Manajemen Service HP Profesional', pageWidth / 2, 120, { align: 'center' });
                                         doc.setFontSize(10);
                                         doc.text(`Versi ${new Date().getFullYear()}.${new Date().getMonth() + 1}`, pageWidth / 2, 140, { align: 'center' });
                                         doc.text(`Generated: ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`, pageWidth / 2, 150, { align: 'center' });
                                         doc.setFontSize(8);
                                         doc.text('(c) ' + (storeData.name || 'iFix POS'), pageWidth / 2, pageHeight - 20, { align: 'center' });

                                         // Table of Contents
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(20);
                                         doc.text('Daftar Isi', margin, yPos);
                                         yPos += 15;
                                         
                                         const chapters = [
                                             '1. Dashboard & Laporan',
                                             '2. Manajemen Servis HP',
                                             '3. Stok & Inventory',
                                             '4. Keuangan & Transaksi',
                                             '5. Customer Management',
                                             '6. HR & Payroll',
                                             '7. User Management',
                                             '8. Multi-Branch',
                                             '9. Settings & Backup'
                                         ];

                                         doc.setFontSize(11);
                                         chapters.forEach((chapter) => {
                                             doc.text(chapter, margin + 5, yPos);
                                             yPos += 8;
                                         });

                                         // Chapter 1: Dashboard
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('1. Dashboard & Laporan', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(10);
                                         doc.text('Dashboard adalah halaman utama yang menampilkan ringkasan bisnis Anda:', margin, yPos);
                                         yPos += 10;

                                         const dashboardFeatures = [
                                             '- Total Pendapatan: Jumlah keseluruhan uang masuk',
                                             '- Servis Aktif: Jumlah HP yang sedang dikerjakan',
                                             '- Stok Value: Total nilai inventory',
                                             '- Grafik Penjualan: Trend penjualan 7 hari terakhir',
                                             '- Status Servis: Breakdown servis per status',
                                             '- Top Services: Layanan paling laris'
                                         ];

                                         doc.setFontSize(9);
                                         dashboardFeatures.forEach(feature => {
                                             checkPage();
                                             doc.text(feature, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi Dashboard
                                         yPos += 5;
                                         checkPage(80);
                                         const dashboardY = yPos;
                                         
                                         // Title ilustrasi
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Tampilan Dashboard', margin + 3, yPos + 5);
                                         yPos += 10;
                                         
                                         // Dashboard cards mockup
                                         const cardWidth = 40;
                                         const cardHeight = 25;
                                         const cardGap = 5;
                                         
                                         // Card 1: Total Pendapatan
                                         doc.setFillColor(239, 246, 255);
                                         doc.rect(margin, yPos, cardWidth, cardHeight, 'F');
                                         doc.setDrawColor(191, 219, 254);
                                         doc.rect(margin, yPos, cardWidth, cardHeight, 'S');
                                         doc.setFontSize(7);
                                         doc.setTextColor(59, 130, 246);
                                         doc.text('Total Pendapatan', margin + 2, yPos + 5);
                                         doc.setFontSize(11);
                                         doc.setTextColor(30, 64, 175);
                                         doc.text('Rp 15.000.000', margin + 2, yPos + 13);
                                         doc.setFontSize(6);
                                         doc.setTextColor(107, 114, 128);
                                         doc.text('+12% dari bulan lalu', margin + 2, yPos + 18);
                                         
                                         // Card 2: Servis Aktif
                                         doc.setFillColor(254, 243, 199);
                                         doc.rect(margin + cardWidth + cardGap, yPos, cardWidth, cardHeight, 'F');
                                         doc.setDrawColor(253, 224, 71);
                                         doc.rect(margin + cardWidth + cardGap, yPos, cardWidth, cardHeight, 'S');
                                         doc.setFontSize(7);
                                         doc.setTextColor(202, 138, 4);
                                         doc.text('Servis Aktif', margin + cardWidth + cardGap + 2, yPos + 5);
                                         doc.setFontSize(11);
                                         doc.setTextColor(161, 98, 7);
                                         doc.text('24 Unit', margin + cardWidth + cardGap + 2, yPos + 13);
                                         doc.setFontSize(6);
                                         doc.setTextColor(107, 114, 128);
                                         doc.text('Dalam proses', margin + cardWidth + cardGap + 2, yPos + 18);
                                         
                                         // Card 3: Stok Value
                                         doc.setFillColor(243, 232, 255);
                                         doc.rect(margin + (cardWidth + cardGap) * 2, yPos, cardWidth, cardHeight, 'F');
                                         doc.setDrawColor(216, 180, 254);
                                         doc.rect(margin + (cardWidth + cardGap) * 2, yPos, cardWidth, cardHeight, 'S');
                                         doc.setFontSize(7);
                                         doc.setTextColor(126, 34, 206);
                                         doc.text('Stok Value', margin + (cardWidth + cardGap) * 2 + 2, yPos + 5);
                                         doc.setFontSize(11);
                                         doc.setTextColor(91, 33, 182);
                                         doc.text('Rp 8.500.000', margin + (cardWidth + cardGap) * 2 + 2, yPos + 13);
                                         doc.setFontSize(6);
                                         doc.setTextColor(107, 114, 128);
                                         doc.text('142 item', margin + (cardWidth + cardGap) * 2 + 2, yPos + 18);
                                         
                                         // Card 4: Customer
                                         doc.setFillColor(240, 253, 244);
                                         doc.rect(margin + (cardWidth + cardGap) * 3, yPos, cardWidth, cardHeight, 'F');
                                         doc.setDrawColor(134, 239, 172);
                                         doc.rect(margin + (cardWidth + cardGap) * 3, yPos, cardWidth, cardHeight, 'S');
                                         doc.setFontSize(7);
                                         doc.setTextColor(22, 163, 74);
                                         doc.text('Total Customer', margin + (cardWidth + cardGap) * 3 + 2, yPos + 5);
                                         doc.setFontSize(11);
                                         doc.setTextColor(21, 128, 61);
                                         doc.text('387 Orang', margin + (cardWidth + cardGap) * 3 + 2, yPos + 13);
                                         doc.setFontSize(6);
                                         doc.setTextColor(107, 114, 128);
                                         doc.text('Database lengkap', margin + (cardWidth + cardGap) * 3 + 2, yPos + 18);
                                         
                                         yPos += cardHeight + 10;
                                         
                                         // Chart mockup
                                         doc.setFillColor(248, 250, 252);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 35, 'F');
                                         doc.setDrawColor(226, 232, 240);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 35, 'S');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Grafik Penjualan 7 Hari Terakhir', margin + 3, yPos + 5);
                                         
                                         // Simple bar chart
                                         const barY = yPos + 10;
                                         const barWidth = 8;
                                         const barGap = 4;
                                         const heights = [15, 20, 18, 25, 22, 28, 24];
                                         const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
                                         
                                         heights.forEach((h, i) => {
                                             const x = margin + 10 + i * (barWidth + barGap);
                                             doc.setFillColor(59, 130, 246);
                                             doc.rect(x, barY + (25 - h), barWidth, h, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(days[i], x + 1, yPos + 33);
                                         });
                                         
                                         yPos += 40;

                                         // Chapter 2: Servis HP
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('2. Manajemen Servis HP', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Membuat Servis Baru', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const servisSteps = [
                                             '1. Klik tombol "+ Servis Baru"',
                                             '2. Pilih pelanggan (atau buat baru)',
                                             '3. Input detail HP:',
                                             '   - Merk & Tipe HP',
                                             '   - IMEI (opsional)',
                                             '   - Keluhan pelanggan',
                                             '   - Password HP (jika ada)',
                                             '4. Centang Cek Fungsional (kamera, mic, speaker, dll)',
                                             '5. Centang Kelengkapan (charger, case, dll)',
                                             '6. Input estimasi biaya dan tanggal selesai',
                                             '7. Klik "Simpan"'
                                         ];

                                         servisSteps.forEach(step => {
                                             checkPage();
                                             doc.text(step, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Ilustrasi Form Servis
                                         yPos += 8;
                                         checkPage(90);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Form Input Servis Baru', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Form container
                                         doc.setFillColor(255, 255, 255);
                                         doc.setDrawColor(226, 232, 240);
                                         doc.setLineWidth(0.5);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 75, 'FD');
                                         
                                         // Form title
                                         doc.setFillColor(59, 130, 246);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 10, 'F');
                                         doc.setFontSize(10);
                                         doc.setTextColor(255, 255, 255);
                                         doc.text('+ Servis Baru', margin + 3, yPos + 7);
                                         
                                         yPos += 15;
                                         
                                         // Form fields
                                         const formX = margin + 5;
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         
                                         // Customer
                                         doc.text('Customer:', formX, yPos);
                                         doc.setDrawColor(203, 213, 225);
                                         doc.rect(formX + 25, yPos - 3, 80, 5, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Budi Santoso - 0812345678', formX + 27, yPos);
                                         yPos += 8;
                                         
                                         // HP Details
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Merk HP:', formX, yPos);
                                         doc.rect(formX + 25, yPos - 3, 35, 5, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Samsung', formX + 27, yPos);
                                         
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Tipe:', formX + 70, yPos);
                                         doc.rect(formX + 80, yPos - 3, 35, 5, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Galaxy S21', formX + 82, yPos);
                                         yPos += 8;
                                         
                                         // Keluhan
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Keluhan:', formX, yPos);
                                         doc.rect(formX + 25, yPos - 3, 80, 10, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Layar pecah, tidak bisa touch', formX + 27, yPos);
                                         yPos += 13;
                                         
                                         // Checkboxes - Cek Fungsional
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Cek Fungsional:', formX, yPos);
                                         yPos += 5;
                                         
                                         const checks = ['Kamera', 'Mic', 'Speaker', 'Touch'];
                                         checks.forEach((item, i) => {
                                             const x = formX + 5 + (i * 25);
                                             // Checkbox
                                             doc.setFillColor(34, 197, 94);
                                             doc.rect(x, yPos - 3, 3, 3, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(item, x + 5, yPos);
                                         });
                                         yPos += 7;
                                         
                                         // Estimasi
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Estimasi Biaya:', formX, yPos);
                                         doc.rect(formX + 30, yPos - 3, 30, 5, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Rp 500.000', formX + 32, yPos);
                                         yPos += 8;
                                         
                                         // Button
                                         doc.setFillColor(59, 130, 246);
                                         doc.rect(formX + 60, yPos - 3, 20, 6, 'F');
                                         doc.setFontSize(7);
                                         doc.setTextColor(255, 255, 255);
                                         doc.text('Simpan', formX + 65, yPos + 1);
                                         
                                         yPos += 15;

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Status Servis', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const statusFlow = [
                                             '- Diterima: HP baru masuk, sedang diperiksa',
                                             '- Diagnosa: Teknisi sedang menganalisa kerusakan',
                                             '- Menunggu Sparepart: Menunggu part datang',
                                             '- Selesai: HP sudah diperbaiki, siap diambil',
                                             '- Dibatalkan: Servis dibatalkan pelanggan'
                                         ];

                                         statusFlow.forEach(status => {
                                             checkPage();
                                             doc.text(status, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('C. Fitur Lanjutan', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const advancedFeatures = [
                                             '- Cetak Invoice: Print struk dengan logo toko',
                                             '- Share WhatsApp: Kirim update progress ke customer',
                                             '- Edit Servis: Ubah detail atau status',
                                             '- Hapus Servis: Hapus data (dengan permission)',
                                             '- Filter: Cari berdasarkan token, nama, atau HP',
                                             '- QR Code: Scan untuk cek status servis'
                                         ];

                                         advancedFeatures.forEach(feature => {
                                             checkPage();
                                             doc.text(feature, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Chapter 3: Stok & Inventory
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('3. Stok & Inventory', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Tambah Barang', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const stockSteps = [
                                             '1. Klik "+ Tambah Stok"',
                                             '2. Pilih kategori (Sparepart, Aksesoris, dll)',
                                             '3. Input nama barang',
                                             '4. Input harga beli (modal)',
                                             '5. Input harga jual',
                                             '6. Input jumlah stok',
                                             '7. Klik "Simpan"'
                                         ];

                                         stockSteps.forEach(step => {
                                             checkPage();
                                             doc.text(step, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Stock Opname', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const opnameSteps = [
                                             '1. Klik tab "Stock Opname"',
                                             '2. Input jumlah fisik di kolom "Input Fisik"',
                                             '3. Sistem otomatis hitung selisih',
                                             '4. Klik "Simpan Stock Opname"',
                                             '5. Data tersimpan di history'
                                         ];

                                         opnameSteps.forEach(step => {
                                             checkPage();
                                             doc.text(step, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Ilustrasi Tabel Stok
                                         yPos += 8;
                                         checkPage(60);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Tabel Inventory Barang', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Table header
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'F');
                                         doc.setDrawColor(226, 232, 240);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'S');
                                         
                                         doc.setFontSize(7);
                                         doc.setTextColor(51, 65, 85);
                                         doc.text('Nama Barang', margin + 2, yPos + 5);
                                         doc.text('Kategori', margin + 60, yPos + 5);
                                         doc.text('Stok', margin + 95, yPos + 5);
                                         doc.text('Harga Beli', margin + 115, yPos + 5);
                                         doc.text('Harga Jual', margin + 145, yPos + 5);
                                         yPos += 7;
                                         
                                         // Table rows
                                         const stockItems = [
                                             {name: 'LCD Samsung A52', cat: 'Sparepart', stock: '15', buy: '450.000', sell: '650.000'},
                                             {name: 'Baterai iPhone 12', cat: 'Sparepart', stock: '8', buy: '320.000', sell: '500.000'},
                                             {name: 'Casing Xiaomi Note', cat: 'Aksesoris', stock: '25', buy: '25.000', sell: '45.000'},
                                             {name: 'Charger Type-C', cat: 'Aksesoris', stock: '40', buy: '15.000', sell: '30.000'},
                                             {name: 'Tempered Glass', cat: 'Aksesoris', stock: '60', buy: '8.000', sell: '20.000'}
                                         ];
                                         
                                         doc.setFontSize(6);
                                         stockItems.forEach((item, i) => {
                                             const rowY = yPos;
                                             const bgColor = i % 2 === 0 ? [255, 255, 255] : [249, 250, 251];
                                             doc.setFillColor(...bgColor);
                                             doc.rect(margin, rowY, pageWidth - 2 * margin, 6, 'F');
                                             doc.setDrawColor(226, 232, 240);
                                             doc.rect(margin, rowY, pageWidth - 2 * margin, 6, 'S');
                                             
                                             doc.setTextColor(51, 65, 85);
                                             doc.text(item.name, margin + 2, rowY + 4);
                                             
                                             // Category badge
                                             const catColor = item.cat === 'Sparepart' ? [219, 234, 254] : [254, 240, 138];
                                             const catText = item.cat === 'Sparepart' ? [29, 78, 216] : [161, 98, 7];
                                             doc.setFillColor(...catColor);
                                             doc.rect(margin + 60, rowY + 1, 25, 4, 'F');
                                             doc.setFontSize(5);
                                             doc.setTextColor(...catText);
                                             doc.text(item.cat, margin + 62, rowY + 3.5);
                                             
                                             doc.setFontSize(6);
                                             doc.setTextColor(51, 65, 85);
                                             doc.text(item.stock, margin + 98, rowY + 4);
                                             doc.text('Rp ' + item.buy, margin + 115, rowY + 4);
                                             doc.setTextColor(22, 163, 74);
                                             doc.text('Rp ' + item.sell, margin + 145, rowY + 4);
                                             
                                             yPos += 6;
                                         });
                                         
                                         yPos += 5;

                                         // Chapter 4: Keuangan
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('4. Keuangan & Transaksi', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Jenis Transaksi', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const transactions = [
                                             '- Service: Pembayaran dari servis HP',
                                             '- Penjualan Barang: Jual sparepart/aksesoris',
                                             '- Pengeluaran: Biaya operasional (restok, dll)',
                                             '- Lain-lain: Transaksi diluar kategori utama'
                                         ];

                                         transactions.forEach(trx => {
                                             checkPage();
                                             doc.text(trx, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Laporan Keuangan', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const financeReports = [
                                             '- Total Pemasukan: Semua uang masuk',
                                             '- Total Pengeluaran: Semua biaya operasional',
                                             '- Profit Bersih: Pemasukan - Pengeluaran',
                                             '- Grafik Trend: Visualisasi keuangan',
                                             '- Export Excel: Download laporan'
                                         ];

                                         financeReports.forEach(report => {
                                             checkPage();
                                             doc.text(report, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi Laporan Keuangan
                                         yPos += 8;
                                         checkPage(50);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Summary Laporan Keuangan', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Finance summary cards
                                         const financeCards = [
                                             {label: 'Total Pemasukan', value: 'Rp 25.500.000', icon: '', color: [34, 197, 94], bgColor: [240, 253, 244]},
                                             {label: 'Total Pengeluaran', value: 'Rp 12.000.000', icon: '', color: [239, 68, 68], bgColor: [254, 242, 242]},
                                             {label: 'Profit Bersih', value: 'Rp 13.500.000', icon: '', color: [59, 130, 246], bgColor: [239, 246, 255]}
                                         ];
                                         
                                         const cardW = 58;
                                         const cardH = 22;
                                         
                                         financeCards.forEach((card, i) => {
                                             const x = margin + (i * (cardW + 3));
                                             
                                             // Card background
                                             doc.setFillColor(...card.bgColor);
                                             doc.rect(x, yPos, cardW, cardH, 'F');
                                             doc.setDrawColor(...card.color);
                                             doc.setLineWidth(0.5);
                                             doc.rect(x, yPos, cardW, cardH, 'S');
                                             
                                             // Icon/Badge
                                             doc.setFillColor(...card.color);
                                             doc.circle(x + 5, yPos + 5, 3, 'F');
                                             
                                             // Label
                                             doc.setFontSize(7);
                                             doc.setTextColor(71, 85, 105);
                                             doc.text(card.label, x + 3, yPos + 12);
                                             
                                             // Value
                                             doc.setFontSize(10);
                                             doc.setTextColor(...card.color);
                                             doc.text(card.value, x + 3, yPos + 19);
                                         });
                                         
                                         yPos += cardH + 10;
                                         
                                         // Transaction list preview
                                         doc.setFillColor(255, 255, 255);
                                         doc.setDrawColor(226, 232, 240);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 25, 'FD');
                                         
                                         doc.setFontSize(8);
                                         doc.setTextColor(51, 65, 85);
                                         doc.text('Transaksi Terbaru', margin + 3, yPos + 5);
                                         yPos += 8;
                                         
                                         const recentTransactions = [
                                             {type: 'Service', desc: 'Ganti LCD Samsung A52', amount: '+650.000'},
                                             {type: 'Penjualan', desc: 'Charger Type-C x2', amount: '+60.000'},
                                             {type: 'Pengeluaran', desc: 'Restok Sparepart', amount: '-2.300.000'}
                                         ];
                                         
                                         doc.setFontSize(6);
                                         recentTransactions.forEach((trx, i) => {
                                             const typeColor = trx.type === 'Pengeluaran' ? [239, 68, 68] : [34, 197, 94];
                                             const bgColor = trx.type === 'Pengeluaran' ? [254, 226, 226] : [220, 252, 231];
                                             
                                             // Type badge
                                             doc.setFillColor(...bgColor);
                                             doc.rect(margin + 3, yPos - 2, 18, 4, 'F');
                                             doc.setFontSize(5);
                                             doc.setTextColor(...typeColor);
                                             doc.text(trx.type, margin + 5, yPos);
                                             
                                             // Description
                                             doc.setFontSize(6);
                                             doc.setTextColor(71, 85, 105);
                                             doc.text(trx.desc, margin + 25, yPos);
                                             
                                             // Amount
                                             doc.setTextColor(...typeColor);
                                             doc.text('Rp ' + trx.amount, margin + 140, yPos);
                                             
                                             yPos += 6;
                                         });
                                         
                                         yPos += 5;

                                         // Chapter 5: Customer
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('5. Customer Management', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(9);
                                         const customerFeatures = [
                                             '- Database Pelanggan: Simpan semua data customer',
                                             '- Riwayat Servis: Lihat semua servis customer',
                                             '- Auto WhatsApp: Link langsung ke chat WA',
                                             '- Sync dari Servis: Otomatis tambah saat buat servis',
                                             '- Edit & Hapus: Kelola data customer',
                                             '- Search: Cari berdasarkan nama atau nomor'
                                         ];

                                         customerFeatures.forEach(feature => {
                                             checkPage();
                                             doc.text(feature, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi Customer Cards
                                         yPos += 8;
                                         checkPage(70);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Daftar Customer', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         const customers = [
                                             {name: 'Ahmad Fadli', phone: '0812-3456-7890', count: 5, lastService: '15 Des 2024'},
                                             {name: 'Dewi Kartika', phone: '0856-7890-1234', count: 3, lastService: '10 Des 2024'},
                                             {name: 'Budi Setiawan', phone: '0821-5678-9012', count: 8, lastService: '18 Des 2024'}
                                         ];
                                         
                                         customers.forEach((customer, i) => {
                                             // Card container
                                             doc.setFillColor(255, 255, 255);
                                             doc.setDrawColor(226, 232, 240);
                                             doc.setLineWidth(0.3);
                                             doc.rect(margin, yPos, pageWidth - 2 * margin, 18, 'FD');
                                             
                                             // Avatar circle
                                             doc.setFillColor(59, 130, 246);
                                             doc.circle(margin + 8, yPos + 8, 4, 'F');
                                             doc.setFontSize(7);
                                             doc.setTextColor(255, 255, 255);
                                             doc.text(customer.name.charAt(0), margin + 6.5, yPos + 9.5);
                                             
                                             // Customer name
                                             doc.setFontSize(8);
                                             doc.setTextColor(15, 23, 42);
                                             doc.text(customer.name, margin + 15, yPos + 6);
                                             
                                             // Phone number
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(customer.phone, margin + 15, yPos + 11);
                                             
                                             // Service count badge
                                             doc.setFillColor(240, 253, 244);
                                             doc.rect(margin + 15, yPos + 13, 18, 4, 'F');
                                             doc.setFontSize(5);
                                             doc.setTextColor(34, 197, 94);
                                             doc.text(customer.count + ' servis', margin + 16, yPos + 15.8);
                                             
                                             // Last service date
                                             doc.setFontSize(6);
                                             doc.setTextColor(148, 163, 184);
                                             doc.text('Terakhir: ' + customer.lastService, margin + 15, yPos + 18);
                                             
                                             // WhatsApp button
                                             doc.setFillColor(34, 197, 94);
                                             doc.roundedRect(margin + 150, yPos + 6, 20, 6, 1, 1, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(255, 255, 255);
                                             doc.text('WhatsApp', margin + 153, yPos + 10);
                                             
                                             // History button
                                             doc.setDrawColor(148, 163, 184);
                                             doc.setLineWidth(0.3);
                                             doc.roundedRect(margin + 125, yPos + 6, 20, 6, 1, 1, 'S');
                                             doc.setTextColor(71, 85, 105);
                                             doc.text('Riwayat', margin + 130, yPos + 10);
                                             
                                             yPos += 20;
                                         });

                                         // Chapter 6: HR & Payroll
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('6. HR & Payroll Management', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Absensi', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const absensi = [
                                             '- Karyawan: Check-in/out sendiri',
                                             '- Owner: Monitor real-time semua karyawan',
                                             '- Auto Hitung: Jam kerja otomatis terhitung',
                                             '- Riwayat: Database absensi lengkap'
                                         ];

                                         absensi.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Ilustrasi Absensi Karyawan
                                         yPos += 8;
                                         checkPage(70);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Dashboard Absensi Karyawan', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Employee attendance cards
                                         const employees = [
                                             {name: 'Ahmad Rizki', role: 'Teknisi', status: 'active', checkIn: '08:15', checkOut: '-'},
                                             {name: 'Siti Nurhaliza', role: 'Admin', status: 'done', checkIn: '08:00', checkOut: '17:00'},
                                             {name: 'Budi Santoso', role: 'Teknisi', status: 'notyet', checkIn: '-', checkOut: '-'}
                                         ];
                                         
                                         employees.forEach((emp, i) => {
                                             const cardY = yPos;
                                             
                                             // Card container
                                             doc.setFillColor(255, 255, 255);
                                             doc.setDrawColor(226, 232, 240);
                                             doc.rect(margin, cardY, pageWidth - 2 * margin, 18, 'FD');
                                             
                                             // Employee info
                                             doc.setFontSize(8);
                                             doc.setTextColor(30, 41, 59);
                                             doc.text(emp.name, margin + 3, cardY + 5);
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(emp.role, margin + 3, cardY + 9);
                                             
                                             // Status badge
                                             const statusColors = {
                                                 active: {bg: [254, 243, 199], text: [161, 98, 7], label: 'Aktif'},
                                                 done: {bg: [220, 252, 231], text: [21, 128, 61], label: 'Selesai'},
                                                 notyet: {bg: [241, 245, 249], text: [100, 116, 139], label: 'Belum'}
                                             };
                                             const status = statusColors[emp.status];
                                             doc.setFillColor(...status.bg);
                                             doc.rect(margin + 130, cardY + 2, 18, 5, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(...status.text);
                                             doc.text(status.label, margin + 134, cardY + 5.5);
                                             
                                             // Time info
                                             doc.setFontSize(6);
                                             doc.setTextColor(71, 85, 105);
                                             doc.text('Check In:', margin + 3, cardY + 13);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(emp.checkIn, margin + 18, cardY + 13);
                                             
                                             doc.setTextColor(71, 85, 105);
                                             doc.text('Check Out:', margin + 35, cardY + 13);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(emp.checkOut, margin + 52, cardY + 13);
                                             
                                             // Buttons
                                             if (emp.status === 'notyet') {
                                                 doc.setFillColor(34, 197, 94);
                                                 doc.rect(margin + 75, cardY + 10, 15, 5, 'F');
                                                 doc.setFontSize(6);
                                                 doc.setTextColor(255, 255, 255);
                                                 doc.text('Check In', margin + 77, cardY + 13.5);
                                             } else if (emp.status === 'active') {
                                                 doc.setFillColor(239, 68, 68);
                                                 doc.rect(margin + 75, cardY + 10, 16, 5, 'F');
                                                 doc.setFontSize(6);
                                                 doc.setTextColor(255, 255, 255);
                                                 doc.text('Check Out', margin + 77, cardY + 13.5);
                                             }
                                             
                                             yPos += 19;
                                         });
                                         
                                         yPos += 3;

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Gaji Tetap', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const salary = [
                                             '- Set Sekali Pakai: Input gaji pokok per karyawan',
                                             '- Rate Komisi: Tentukan % komisi',
                                             '- Auto-Generate: Generate payroll semua karyawan',
                                             '- Update Mudah: Edit kapan saja'
                                         ];

                                         salary.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('C. Payroll', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const payroll = [
                                             '- Generate Manual: Input per karyawan',
                                             '- Auto-Generate: Dari gaji tetap',
                                             '- Komponen: Gaji + Komisi + Bonus - Potongan',
                                             '- Edit & Hapus: Kelola payroll',
                                             '- Status: Pending atau Paid'
                                         ];

                                         payroll.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('D. Cuti', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const cuti = [
                                             '- Karyawan: Ajukan cuti sendiri',
                                             '- Owner: Approve/Reject pengajuan',
                                             '- Tipe: Tahunan, Sakit, Izin, Lainnya',
                                             '- Status: Pending, Disetujui, Ditolak'
                                         ];

                                         cuti.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('E. Anggaran Bulanan', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const budget = [
                                             '- Catat Pengeluaran Rutin: Sewa, listrik, dll',
                                             '- Kategori: Terorganisir per jenis',
                                             '- Jatuh Tempo: Reminder pembayaran',
                                             '- Dashboard: Total & rata-rata anggaran'
                                         ];

                                         budget.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Chapter 7: User Management
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('7. User Management', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(9);
                                         const userMgmt = [
                                             '- Role: Owner, Admin, Teknisi',
                                             '- Tambah Karyawan: Buat akun dengan email & password',
                                             '- Edit: Ubah nama, role, atau status',
                                             '- Hapus: Remove user dari sistem',
                                             '- Password: Set saat membuat akun'
                                         ];

                                         userMgmt.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi User Management Table
                                         yPos += 8;
                                         checkPage(50);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Daftar User', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Table header
                                         doc.setFillColor(248, 250, 252);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'F');
                                         doc.setFontSize(7);
                                         doc.setTextColor(51, 65, 85);
                                         doc.text('Nama', margin + 3, yPos + 4.5);
                                         doc.text('Email', margin + 50, yPos + 4.5);
                                         doc.text('Role', margin + 110, yPos + 4.5);
                                         doc.text('Status', margin + 140, yPos + 4.5);
                                         doc.text('Aksi', margin + 165, yPos + 4.5);
                                         yPos += 7;
                                         
                                         const users = [
                                             {name: 'Anda (Owner)', email: 'owner@ifix.com', role: 'Owner', status: 'Aktif', roleColor: [139, 92, 246], bgColor: [237, 233, 254]},
                                             {name: 'Ahmad Admin', email: 'admin@ifix.com', role: 'Admin', status: 'Aktif', roleColor: [59, 130, 246], bgColor: [239, 246, 255]},
                                             {name: 'Budi Teknisi', email: 'teknisi1@ifix.com', role: 'Teknisi', status: 'Aktif', roleColor: [34, 197, 94], bgColor: [240, 253, 244]},
                                             {name: 'Siti Kasir', email: 'kasir@ifix.com', role: 'Teknisi', status: 'Nonaktif', roleColor: [34, 197, 94], bgColor: [240, 253, 244]}
                                         ];
                                         
                                         users.forEach((user, i) => {
                                             const rowColor = i % 2 === 0 ? [255, 255, 255] : [249, 250, 251];
                                             doc.setFillColor(...rowColor);
                                             doc.rect(margin, yPos, pageWidth - 2 * margin, 10, 'F');
                                             
                                             doc.setFontSize(7);
                                             doc.setTextColor(15, 23, 42);
                                             doc.text(user.name, margin + 3, yPos + 6);
                                             
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(user.email, margin + 50, yPos + 6);
                                             
                                             // Role badge
                                             doc.setFillColor(...user.bgColor);
                                             doc.rect(margin + 110, yPos + 2.5, 20, 5, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(...user.roleColor);
                                             doc.text(user.role, margin + 113, yPos + 5.5);
                                             
                                             // Status badge
                                             const isActive = user.status === 'Aktif';
                                             doc.setFillColor(isActive ? 220 : 254, isActive ? 252 : 226, isActive ? 231 : 226);
                                             doc.rect(margin + 140, yPos + 2.5, 18, 5, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(isActive ? 34 : 239, isActive ? 197 : 68, isActive ? 94 : 68);
                                             doc.text(user.status, margin + 142, yPos + 5.5);
                                             
                                             // Action buttons
                                             doc.setFontSize(5);
                                             doc.setTextColor(59, 130, 246);
                                             doc.text('Edit', margin + 165, yPos + 4);
                                             doc.setTextColor(239, 68, 68);
                                             doc.text('Hapus', margin + 165, yPos + 8);
                                             
                                             yPos += 10;
                                         });

                                         // Chapter 8: Multi-Branch
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('8. Multi-Branch System', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(9);
                                         const multiBranch = [
                                             '- Buka Cabang Baru: Max 5 cabang untuk PRO Plan',
                                             '- BASIC Plan: Max 1 cabang (toko pusat)',
                                             '- Data Terpisah: Setiap cabang punya data sendiri',
                                             '- Switch Branch: Pindah cabang dengan mudah',
                                             '- All Stores: Lihat gabungan semua cabang',
                                             '- Sentralisasi: Owner kontrol semua cabang'
                                         ];

                                         multiBranch.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi Branch Selector
                                         yPos += 8;
                                         checkPage(55);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Pilih Cabang', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         const branches = [
                                             {name: 'All Stores', desc: 'Gabungan semua cabang', count: 150, isActive: true},
                                             {name: 'iFix Surabaya Pusat', desc: 'Jl. Raya Darmo No. 123', count: 85, isActive: false},
                                             {name: 'iFix Surabaya Timur', desc: 'Jl. Ahmad Yani No. 45', count: 42, isActive: false},
                                             {name: 'iFix Sidoarjo', desc: 'Jl. Pahlawan No. 67', count: 23, isActive: false}
                                         ];
                                         
                                         branches.forEach((branch, i) => {
                                             // Card container
                                             const borderColor = branch.isActive ? [37, 99, 235] : [226, 232, 240];
                                             const bgColor = branch.isActive ? [239, 246, 255] : [255, 255, 255];
                                             
                                             doc.setFillColor(...bgColor);
                                             doc.setDrawColor(...borderColor);
                                             doc.setLineWidth(branch.isActive ? 0.8 : 0.3);
                                             doc.rect(margin, yPos, pageWidth - 2 * margin, 12, 'FD');
                                             
                                             // Branch icon
                                             doc.setFillColor(37, 99, 235);
                                             doc.circle(margin + 6, yPos + 6, 3, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(255, 255, 255);
                                             doc.text('', margin + 5, yPos + 7);
                                             
                                             // Branch name
                                             doc.setFontSize(8);
                                             doc.setTextColor(15, 23, 42);
                                             doc.text(branch.name, margin + 12, yPos + 5);
                                             
                                             // Description
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(branch.desc, margin + 12, yPos + 9);
                                             
                                             // Transaction count badge
                                             doc.setFillColor(240, 253, 244);
                                             doc.rect(margin + 130, yPos + 3, 25, 6, 'F');
                                             doc.setFontSize(7);
                                             doc.setTextColor(34, 197, 94);
                                             doc.text(branch.count + ' transaksi', margin + 132, yPos + 7);
                                             
                                             // Active indicator
                                             if (branch.isActive) {
                                                 doc.setFillColor(34, 197, 94);
                                                 doc.circle(margin + 165, yPos + 6, 2, 'F');
                                                 doc.setFontSize(6);
                                                 doc.setTextColor(34, 197, 94);
                                                 doc.text('Aktif', margin + 168, yPos + 7);
                                             }
                                             
                                             yPos += 13;
                                         });

                                         // Chapter 9: Settings
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('9. Settings & Backup', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Profil Toko', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const settings = [
                                             '- Upload Logo: Muncul di struk/invoice',
                                             '- Nama Toko: Identitas bisnis',
                                             '- Alamat & Telepon: Info kontak'
                                         ];

                                         settings.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Backup & Restore', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const backup = [
                                             '- Download Backup: Export semua data ke JSON',
                                             '- Restore: Import data dari file backup',
                                             '- Hanya PRO Plan: Fitur premium',
                                             '- Backup Berkala: Disarankan mingguan'
                                         ];

                                         backup.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('C. Hak Akses', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const permissions = [
                                             '- Hapus Data: Izinkan admin hapus servis',
                                             '- Cetak Invoice: Akses printer',
                                             '- Share WhatsApp: Kirim ke customer',
                                             '- Tambah Stok: Input barang baru'
                                         ];

                                         permissions.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Ilustrasi Settings Panel
                                         yPos += 10;
                                         checkPage(65);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Halaman Settings', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Settings sections
                                         const settingsSections = [
                                             {
                                                 title: 'Profil Toko',
                                                 items: [
                                                     {label: 'Nama Toko', value: 'iFix Phone Repair', type: 'input'},
                                                     {label: 'Alamat', value: 'Jl. Raya Darmo No. 123, Surabaya', type: 'input'},
                                                     {label: 'Telepon', value: '031-5678901', type: 'input'}
                                                 ]
                                             },
                                             {
                                                 title: 'Hak Akses',
                                                 items: [
                                                     {label: 'Admin boleh hapus data', value: true, type: 'toggle'},
                                                     {label: 'Teknisi bisa cetak invoice', value: true, type: 'toggle'},
                                                     {label: 'Auto-backup harian', value: false, type: 'toggle'}
                                                 ]
                                             }
                                         ];
                                         
                                         settingsSections.forEach((section, idx) => {
                                             // Section header
                                             doc.setFillColor(248, 250, 252);
                                             doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'F');
                                             doc.setFontSize(8);
                                             doc.setTextColor(51, 65, 85);
                                             doc.text(section.title, margin + 3, yPos + 4.5);
                                             yPos += 7;
                                             
                                             // Section items
                                             section.items.forEach((item, i) => {
                                                 doc.setFillColor(255, 255, 255);
                                                 doc.setDrawColor(226, 232, 240);
                                                 doc.setLineWidth(0.2);
                                                 doc.rect(margin, yPos, pageWidth - 2 * margin, 9, 'FD');
                                                 
                                                 doc.setFontSize(7);
                                                 doc.setTextColor(71, 85, 105);
                                                 doc.text(item.label, margin + 3, yPos + 5);
                                                 
                                                 if (item.type === 'input') {
                                                     // Input field
                                                     doc.setFillColor(249, 250, 251);
                                                     doc.setDrawColor(203, 213, 225);
                                                     doc.rect(margin + 90, yPos + 2, 80, 5, 'FD');
                                                     doc.setFontSize(6);
                                                     doc.setTextColor(15, 23, 42);
                                                     doc.text(item.value, margin + 92, yPos + 5.5);
                                                 } else if (item.type === 'toggle') {
                                                     // Toggle switch
                                                     const toggleOn = item.value;
                                                     doc.setFillColor(toggleOn ? 34 : 203, toggleOn ? 197 : 213, toggleOn ? 94 : 225);
                                                     doc.roundedRect(margin + 155, yPos + 2.5, 12, 4, 2, 2, 'F');
                                                     doc.setFillColor(255, 255, 255);
                                                     doc.circle(margin + (toggleOn ? 163 : 159), yPos + 4.5, 1.5, 'F');
                                                 }
                                                 
                                                 yPos += 9;
                                             });
                                             
                                             yPos += 3;
                                         });
                                         
                                         // Save button
                                         doc.setFillColor(37, 99, 235);
                                         doc.roundedRect(margin + 135, yPos, 35, 7, 1, 1, 'F');
                                         doc.setFontSize(7);
                                         doc.setTextColor(255, 255, 255);
                                         doc.text('Simpan Perubahan', margin + 140, yPos + 4.5);

                                         // Tips & Tricks
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(16, 185, 129);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('Tips & Trik Penggunaan', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(9);
                                         const tips = [
                                             '1. Backup rutin setiap minggu untuk keamanan data',
                                             '2. Gunakan fitur filter untuk pencarian cepat',
                                             '3. Set gaji tetap untuk efisiensi generate payroll',
                                             '4. Manfaatkan WhatsApp untuk komunikasi customer',
                                             '5. Cek dashboard setiap pagi untuk monitoring',
                                             '6. Stock opname minimal sebulan sekali',
                                             '7. Update status servis real-time untuk akurasi',
                                             '8. Gunakan kategori untuk organisasi stok',
                                             '9. Aktifkan hak akses sesuai posisi karyawan',
                                             '10. Download laporan keuangan untuk analisa bulanan'
                                         ];

                                         tips.forEach(tip => {
                                             checkPage();
                                             doc.text(tip, margin + 5, yPos);
                                             yPos += 7;
                                         });

                                         // Footer
                                         doc.addPage();
                                         yPos = pageHeight / 2 - 20;
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 60, 'F');
                                         doc.setTextColor(51, 65, 85);
                                         doc.setFontSize(14);
                                         doc.text('Terima Kasih!', pageWidth / 2, yPos + 15, { align: 'center' });
                                         doc.setFontSize(10);
                                         doc.text('Untuk pertanyaan atau bantuan lebih lanjut,', pageWidth / 2, yPos + 25, { align: 'center' });
                                         doc.text('hubungi admin atau developer Anda.', pageWidth / 2, yPos + 32, { align: 'center' });
                                         doc.setFontSize(8);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('iFix POS - Professional Service Management System', pageWidth / 2, yPos + 45, { align: 'center' });

                                         // Save PDF
                                         doc.save(`Panduan_iFix_POS_${new Date().toISOString().slice(0,10)}.pdf`);
                                         alert('‚úÖ Panduan berhasil didownload!');
                                     } catch (err) {
                                         alert('Error: ' + err.message);
                                         console.error(err);
                                     } finally {
                                         setSaving(false);
                                     }
                                 }}
                                 disabled={saving}
                                 className="w-full bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-600/30 transition-all flex items-center justify-center gap-2"
                             >
                                 {saving ? (
                                     <>
                                         <Loader2 className="w-5 h-5 animate-spin"/>
                                         Generating PDF...
                                     </>
                                 ) : (
                                     <>
                                         <Download className="w-5 h-5"/>
                                         Download Panduan PDF
                                     </>
                                 )}
                             </button>
                         </div>
                         </div>
                         )}
                     </div>
                     
                     {/* MODAL RENDERING */}
                     {modal === 'qcItems' && <QCFunctionalItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} />}
                     {modal === 'kelengkapanItems' && <KelengkapanItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} />}
                     {modal === 'categoryItems' && <CategoryItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} storeId={activeStore?.id} />}
                     {modal === 'brandItems' && <BrandItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} />}
                     {modal === 'inventorySettings' && <InventorySettingsModal close={()=>setModal(null)} ownerId={activeOwner?.id} storeId={activeStore?.id} />}
                     {modal === 'backup' && <BackupModal close={()=>setModal(null)} />}
                     
                     {modal === 'changePassword' && (
                         <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                 <div className="flex items-center gap-3 mb-6">
                                     <div className="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                         <Key className="w-6 h-6 text-yellow-600"/>
                                     </div>
                                     <div>
                                         <h3 className="font-bold text-xl text-slate-800">Ganti Password</h3>
                                         <p className="text-sm text-slate-500">Ubah password login Anda</p>
                                     </div>
                                 </div>
                                 <form onSubmit={handleChangePassword} className="space-y-4">
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">Password Lama</label>
                                         <input 
                                             name="currentPassword" 
                                             type="password" 
                                             className="w-full border border-slate-300 p-3 rounded-lg focus:outline-yellow-500" 
                                             placeholder="Masukkan password lama" 
                                             required
                                             minLength="6"
                                         />
                                     </div>
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">Password Baru</label>
                                         <input 
                                             name="newPassword" 
                                             type="password" 
                                             className="w-full border border-slate-300 p-3 rounded-lg focus:outline-yellow-500" 
                                             placeholder="Masukkan password baru (min 6 karakter)" 
                                             required
                                             minLength="6"
                                         />
                                     </div>
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">Konfirmasi Password Baru</label>
                                         <input 
                                             name="confirmPassword" 
                                             type="password" 
                                             className="w-full border border-slate-300 p-3 rounded-lg focus:outline-yellow-500" 
                                             placeholder="Ketik ulang password baru" 
                                             required
                                             minLength="6"
                                         />
                                     </div>
                                     <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                                         <p className="text-xs text-blue-700">
                                             üí° <strong>Tips Keamanan:</strong> Gunakan kombinasi huruf besar, huruf kecil, angka, dan simbol untuk password yang lebih kuat.
                                         </p>
                                     </div>
                                     <div className="flex gap-3 mt-6">
                                         <button type="button" onClick={()=>setModal(null)} className="flex-1 py-3 border rounded-xl font-bold hover:bg-slate-50">Batal</button>
                                         <button disabled={saving} className="flex-1 py-3 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-xl font-bold hover:from-yellow-700 hover:to-orange-700 flex items-center justify-center gap-2">
                                             {saving ? <><Loader2 className="w-4 h-4 animate-spin"/> Menyimpan...</> : <><Key className="w-4 h-4"/> Ubah Password</>}
                                         </button>
                                     </div>
                                 </form>
                             </div>
                         </div>
                     )}
                     
                     {modal === 'storePermissions' && (
                         <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-2">
                             <div className="bg-slate-800 border border-slate-700 w-full max-w-[98vw] rounded-2xl shadow-2xl h-[96vh] overflow-hidden flex flex-col">
                                 <div className="flex items-center justify-between gap-3 p-6 border-b border-slate-700 bg-slate-750">
                                     <div className="flex items-center gap-3">
                                         <div className="w-10 h-10 rounded-full bg-cyan-600 flex items-center justify-center font-bold text-white text-lg">
                                             <ShieldCheck className="w-6 h-6"/>
                                         </div>
                                         <div className="flex-1">
                                             <div className="flex items-center gap-2">
                                                 <h3 className="font-bold text-lg text-white">{activeStore?.name || 'Pengaturan Toko'}</h3>
                                                 <span className="bg-green-500/20 text-green-300 text-[10px] font-bold px-2 py-0.5 rounded-full border border-green-500/30 flex items-center gap-1">
                                                     <span className="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
                                                     REAL-TIME SYNC
                                                 </span>
                                             </div>
                                             <p className="text-xs text-cyan-300">Hak Akses Karyawan (Admin & Teknisi) - Owner Selalu Punya Akses Penuh</p>
                                         </div>
                                     </div>
                                     <button 
                                         type="button" 
                                         onClick={()=>setModal(null)} 
                                         className="text-slate-400 hover:text-white transition-colors p-2 hover:bg-slate-700 rounded-lg"
                                     >
                                         <X className="w-5 h-5"/>
                                     </button>
                                 </div>
                                 <div className="px-6 pt-4 space-y-3">
                                     <p className="text-slate-400 text-sm bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                                         <span className="text-cyan-400 font-bold">‚ÑπÔ∏è INFO:</span> Setiap role punya hak akses <strong>terpisah</strong>. Pilih role di bawah lalu atur togglenya. Owner selalu punya akses penuh. <span className="text-green-400 font-bold">‚úì Real-time sync</span> ke semua perangkat.
                                     </p>
                                     {/* Role Tabs */}
                                     <div className="flex gap-2 bg-slate-900 p-1 rounded-xl border border-slate-700">
                                         {[{id:'admin',label:'üë§ Admin',color:'bg-blue-600'},{id:'kasir',label:'üí≥ Kasir',color:'bg-emerald-600'},{id:'teknisi',label:'üîß Teknisi',color:'bg-orange-600'}].map(r => (
                                             <button key={r.id} type="button" onClick={()=>setSelectedRole(r.id)}
                                                 className={`flex-1 py-2.5 px-3 rounded-lg text-sm font-bold transition-all ${selectedRole === r.id ? r.color + ' text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}>
                                                 {r.label}
                                                 {config?.[r.id] && <span className="ml-1.5 text-[10px] opacity-75">‚úì</span>}
                                             </button>
                                         ))}
                                     </div>
                                 </div>
                                 <form key={selectedRole} onSubmit={saveStorePermissions} className="flex-1 overflow-y-auto p-6 space-y-6">
                                     <input type="hidden" name="_selectedRole" value={selectedRole}/>
                                     <div className="space-y-4">
                                         <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-blue-300 mb-3 flex items-center gap-2">
                                                 <LayoutDashboard className="w-4 h-4"/> MENU UTAMA
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'menu_dashboard', label: 'üìä Dashboard', locked: ownerAccess?.menu_dashboard === false},
                                                     {id: 'menu_report', label: 'üìà Laporan', locked: ownerAccess?.menu_report === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={roleConfig[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         <div className="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-green-300 mb-3 flex items-center gap-2">
                                                 <Smartphone className="w-4 h-4"/> MENU TRANSAKSI
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'menu_service', label: 'üì± Servis HP', locked: ownerAccess?.menu_service === false},
                                                     {id: 'menu_sales', label: 'üõí Penjualan', locked: ownerAccess?.menu_sales === false},
                                                     {id: 'menu_purchase', label: 'üõçÔ∏è Pembelian', locked: ownerAccess?.menu_purchase === false},
                                                     {id: 'menu_return_sales', label: '‚Ü©Ô∏è Retur Penjualan', locked: ownerAccess?.menu_return_sales === false},
                                                     {id: 'menu_return_purchase', label: '‚Ü™Ô∏è Retur Pembelian', locked: ownerAccess?.menu_return_purchase === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={roleConfig[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-yellow-300 mb-3 flex items-center gap-2">
                                                 <Wallet className="w-4 h-4"/> MENU KEUANGAN
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'menu_payable', label: 'üì§ Utang', locked: ownerAccess?.menu_payable === false},
                                                     {id: 'menu_receivable', label: 'üì• Piutang', locked: ownerAccess?.menu_receivable === false},
                                                     {id: 'menu_cash', label: 'üíµ Kas', locked: ownerAccess?.menu_cash === false},
                                                     {id: 'menu_finance', label: 'üí≥ Laporan Keuangan', locked: ownerAccess?.menu_finance === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={roleConfig[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         <div className="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-purple-300 mb-3 flex items-center gap-2">
                                                 <Box className="w-4 h-4"/> MENU INVENTORY & DATA
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'menu_inventory', label: 'üì¶ Stok Barang', locked: ownerAccess?.menu_inventory === false},
                                                     {id: 'menu_supplier', label: 'üöö Supplier', locked: ownerAccess?.menu_supplier === false},
                                                     {id: 'menu_customers', label: 'üë• Pelanggan', locked: ownerAccess?.menu_customers === false},
                                                     {id: 'menu_hr', label: 'üëî HR & Payroll', locked: ownerAccess?.menu_hr === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={roleConfig[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         <div className="bg-cyan-900/20 border border-cyan-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-cyan-300 mb-3 flex items-center gap-2">
                                                 <ShieldCheck className="w-4 h-4"/> FITUR & AKSI
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'feature_service_edit', label: '‚úèÔ∏è Edit Servis', locked: ownerAccess?.feature_service_edit === false},
                                                     {id: 'feature_sales_edit', label: '‚úèÔ∏è Edit Penjualan', locked: ownerAccess?.feature_sales_edit === false},
                                                     {id: 'feature_inventory_edit', label: '‚úèÔ∏è Edit Inventory', locked: ownerAccess?.feature_inventory_edit === false},
                                                     {id: 'feature_customer_edit', label: '‚úèÔ∏è Edit Pelanggan', locked: ownerAccess?.feature_customer_edit === false},
                                                     {id: 'feature_employee_edit', label: '‚úèÔ∏è Edit Pegawai', locked: ownerAccess?.feature_employee_edit === false},
                                                     {id: 'feature_finance_edit', label: '‚úèÔ∏è Edit Keuangan', locked: ownerAccess?.feature_finance_edit === false},
                                                     {id: 'feature_print', label: 'üñ®Ô∏è Cetak Invoice', locked: ownerAccess?.feature_print === false},
                                                     {id: 'feature_share', label: 'üí¨ Share WhatsApp', locked: ownerAccess?.feature_share === false},
                                                     {id: 'feature_delete', label: 'üóëÔ∏è Hapus Data', locked: ownerAccess?.feature_delete === false},
                                                     {id: 'feature_stock_add', label: '‚ûï Tambah Stok', locked: ownerAccess?.feature_stock_add === false},
                                                     {id: 'feature_backup', label: 'üíæ Backup Data', locked: ownerAccess?.feature_backup === false},
                                                     {id: 'feature_import_export', label: 'üì§ Import/Export', locked: ownerAccess?.feature_import_export === false},
                                                     {id: 'feature_multi_branch', label: 'üè¢ Multi Cabang', locked: ownerAccess?.feature_multi_branch === false},
                                                     {id: 'feature_qc_checklist', label: '‚úÖ QC Checklist', locked: ownerAccess?.feature_qc_checklist === false},
                                                     {id: 'feature_kelengkapan', label: 'üìã Kelengkapan Item', locked: ownerAccess?.feature_kelengkapan === false},
                                                     {id: 'feature_accounting', label: 'üìä Akuntansi', locked: ownerAccess?.feature_accounting === false},
                                                     {id: 'feature_subdomain', label: 'üåê Subdomain Custom', locked: ownerAccess?.feature_subdomain === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={roleConfig[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         {/* STATISTIK DASHBOARD */}
                                         <div className="bg-indigo-900/20 border border-indigo-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-indigo-300 mb-3 flex items-center gap-2">
                                                 <BarChart3 className="w-4 h-4"/> STATISTIK DASHBOARD
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'dash_servis_selesai',   label: 'üìä Status Selesai'},
                                                     {id: 'dash_untung_jasa',      label: 'üí∞ Untung Jasa'},
                                                     {id: 'dash_pemasukan',        label: 'üìà Pemasukan'},
                                                     {id: 'dash_pengeluaran',      label: 'üìâ Pengeluaran'},
                                                     {id: 'dash_untung_jual',      label: 'üíπ Untung Jual'},
                                                     {id: 'dash_komp_retur',       label: 'üîÑ Kompensasi Retur'},
                                                     {id: 'dash_nilai_stok',       label: 'üì¶ Nilai Stok'},
                                                     {id: 'dash_total_keuntungan', label: 'üèÜ Total Keuntungan'}
                                                 ].map(item => (
                                                     <label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group">
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span>
                                                         <div className="relative flex items-center">
                                                             <input type="checkbox" name={item.id} defaultChecked={roleConfig[item.id] !== false} className="peer sr-only"/>
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         {/* VISIBILITAS DATA */}
                                         <div className="bg-orange-900/20 border border-orange-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-orange-300 mb-3 flex items-center gap-2">
                                                 <Eye className="w-4 h-4"/> VISIBILITAS DATA
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'feature_show_modal', label: 'üëÅÔ∏è Lihat Harga Modal/Beli'}
                                                 ].map(item => (
                                                     <label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group">
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span>
                                                         <div className="relative flex items-center">
                                                             <input type="checkbox" name={item.id} defaultChecked={roleConfig[item.id] !== false} className="peer sr-only"/>
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                     </div>
                                     <div className="flex gap-3 pt-4 border-t border-slate-700">
                                         <button type="button" onClick={()=>setModal(null)} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700 text-sm">Batal</button>
                                         <button disabled={saving} className="flex-1 py-3 bg-cyan-600 text-white rounded-lg font-bold hover:bg-cyan-700 text-sm flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                             {saving ? (
                                                 <>
                                                     <Loader2 className="w-4 h-4 animate-spin"/>
                                                     Menyimpan & Sync...
                                                 </>
                                             ) : (
                                                 <>
                                                     <Save className="w-4 h-4"/>
                                                     Simpan Pengaturan
                                                 </>
                                             )}
                                         </button>
                                     </div>
                                 </form>
                             </div>
                         </div>
                     )}
                 </div>
             );
        };
        const UserManager = () => {
             const { user, activeOwner, activeStore, checkPermission } = useContext(SessionContext);
             const { data: stores } = useFirestoreCollection('stores', activeOwner?.id);
             const [users, setUsers] = useState([]);
             const [modal, setModal] = useState(null);
             const [editUserModal, setEditUserModal] = useState(null);
             const [userCurrentPage, setUserCurrentPage] = useState(1);
             const [userItemsPerPage, setUserItemsPerPage] = useState(10);

             // Fetch users via Admin API (regular token cannot list other users in PocketBase)
             const fetchUsers = async () => {
                 if (!activeOwner?.id) return;
                 try {
                     const adminToken = await getAdminToken();
                     if (adminToken) {
                         const ownerIdEncoded = encodeURIComponent(`ownerId="${activeOwner.id.replace(/"/g, '\\"')}"`);
                         const resp = await fetch(`${POCKETBASE_URL}/api/collections/users/records?filter=${ownerIdEncoded}&perPage=500&sort=-created`, {
                             headers: { 'Authorization': adminToken }
                         });
                         if (resp.ok) {
                             const data = await resp.json();
                             setUsers(data.items.map(u => ({ id: u.id, ...u })));
                         }
                     } else {
                         // Fallback ke SDK jika tidak ada admin token
                         const result = await pb.collection('users').getList(1, 500, {
                             filter: `ownerId = "${activeOwner.id}"`
                         });
                         setUsers(result.items.map(u => ({ id: u.id, ...u })));
                     }
                 } catch(e) {
                     console.warn('fetchUsers error:', e.message);
                 }
             };

             useEffect(() => {
                 fetchUsers();
             }, [activeOwner?.id]);
             
             const effectiveRole = user.role === 'developer' ? 'owner' : user.role;
             if (effectiveRole !== 'owner') return null;
             
             // Check permission for editing employee
             const canEditEmployee = checkPermission('feature_employee_edit');

             const addUser = async (userData) => { 
                 try { 
                     // Create atau gunakan user yang sudah ada
                     let newUid = null; 
                     try { 
                         const userCred = await createUserWithEmailAndPassword(auth, userData.email, userData.password); 
                         newUid = userCred.user.uid; 
                     } catch(authErr) { 
                         if(authErr.code === 'auth/email-already-in-use') {
                             // Cek apakah user sudah punya ownerId
                             const existingUser = await findUserByEmail(userData.email);
                             if (existingUser && existingUser.ownerId) {
                                 throw new Error('Email ini sudah terdaftar sebagai pegawai di tenant lain.');
                             }
                             if (existingUser) {
                                 newUid = existingUser.id;
                                 try {
                                     const adminTok = await getAdminToken();
                                     if (adminTok) {
                                         await fetch(`${POCKETBASE_URL}/api/collections/users/records/${newUid}`, {
                                             method: 'PATCH',
                                             headers: { 'Content-Type': 'application/json', 'Authorization': adminTok },
                                             body: JSON.stringify({ password: userData.password, passwordConfirm: userData.password })
                                         });
                                     } else {
                                         await pb.collection('users').update(newUid, {
                                             password: userData.password,
                                             passwordConfirm: userData.password
                                         });
                                     }
                                 } catch(pwErr) { console.warn('Could not update password:', pwErr.message); }
                             } else {
                                 throw new Error('Email terdaftar tapi tidak ditemukan.');
                             }
                         } else if(authErr.code === 'auth/weak-password') { 
                             throw new Error("Password terlalu lemah. Minimal 8 karakter."); 
                         } else {
                             throw authErr;
                         }
                     } 
                     
                     // Update user record dengan data role (gunakan Admin API karena owner tidak bisa update user lain)
                     const { password, email, ...userDataWithoutAuth } = userData;
                     
                     const adminToken = await getAdminToken();
                     if (adminToken) {
                         const patchResp = await fetch(`${POCKETBASE_URL}/api/collections/users/records/${newUid}`, {
                             method: 'PATCH',
                             headers: {
                                 'Content-Type': 'application/json',
                                 'Authorization': adminToken
                             },
                             body: JSON.stringify({
                                 ...userDataWithoutAuth,
                                 ownerId: activeOwner.id,
                             })
                         });
                         if (!patchResp.ok) {
                             const errData = await patchResp.json().catch(() => ({}));
                             throw new Error('Gagal menyimpan data pegawai: ' + (errData.message || patchResp.status));
                         }
                     } else {
                         // Fallback: coba updateDoc biasa (mungkin berhasil jika rules PocketBase mengizinkan)
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', newUid), { 
                             ...userDataWithoutAuth, 
                             ownerId: activeOwner.id, 
                         }); 
                     }

                     // Backup: selalu simpan ke Firestore agar Strategy 2 login bisa berjalan sbg fallback
                     try {
                         await setDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', newUid), {
                             ...userDataWithoutAuth,
                             ownerId: activeOwner.id,
                             email: email,
                             createdAt: new Date().toISOString()
                         }, { merge: true });
                     } catch(fsErr) {
                         console.warn('\u26A0\uFE0F Firestore backup failed (bukan masalah kritis):', fsErr.message);
                     }
                     
                     setModal(null);
                     await fetchUsers();
                     alert(`‚úÖ Pegawai berhasil ditambahkan!\n\nEmail: ${userData.email}\nPassword: ${userData.password}\n\nPegawai dapat langsung login menggunakan kredensial di atas.`); 
                 } catch(e) { 
                     console.error('‚ùå addUser error:', e);
                     alert("Error: " + e.message); 
                 } 
             };
             const deleteUser = async (id) => {
                 if(confirm("Hapus akses user ini?")) {
                     try {
                         const adminToken = await getAdminToken();
                         if (adminToken) {
                             const resp = await fetch(`${POCKETBASE_URL}/api/collections/users/records/${id}`, {
                                 method: 'DELETE',
                                 headers: { 'Authorization': adminToken }
                             });
                             if (!resp.ok && resp.status !== 404) {
                                 const errData = await resp.json().catch(() => ({}));
                                 alert('Gagal hapus pegawai: ' + (errData.message || resp.status));
                             } else {
                                 await fetchUsers();
                             }
                         } else {
                             await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', id));
                             await fetchUsers();
                         }
                     } catch(e) { alert('Gagal hapus: ' + e.message); }
                 }
             };
             
             const handleEditUser = async (e) => {
                 e.preventDefault();
                 const newName = e.target.name.value;
                 const newRole = e.target.role.value;
                 const newStore = e.target.storeId.value;
                 try {
                     const adminToken = await getAdminToken();
                     if (adminToken) {
                         const resp = await fetch(`${POCKETBASE_URL}/api/collections/users/records/${editUserModal.id}`, {
                             method: 'PATCH',
                             headers: { 'Content-Type': 'application/json', 'Authorization': adminToken },
                             body: JSON.stringify({ name: newName, role: newRole, storeId: newStore })
                         });
                         if (!resp.ok) {
                             const errData = await resp.json().catch(() => ({}));
                             throw new Error(errData.message || resp.status);
                         }
                     } else {
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', editUserModal.id), {
                             name: newName, role: newRole, storeId: newStore
                         });
                     }
                     setEditUserModal(null);
                     await fetchUsers();
                     alert("Data Pegawai Diperbarui");
                 } catch(err) {
                     alert("Gagal update: " + err.message);
                 }
             };

             return (
                 <div className="space-y-6">
                    <div className="flex justify-between items-center"><h2 className="text-xl md:text-2xl font-bold text-slate-800">Pegawai & Akses</h2><button onClick={()=>setModal({})} className="bg-blue-600 text-white px-3 md:px-5 py-2 md:py-2.5 rounded-xl font-bold flex items-center gap-2 text-xs md:text-sm shadow-lg hover:bg-blue-700"><Plus className="w-4 h-4"/> <span className="hidden sm:inline">Tambah Pegawai</span><span className="sm:hidden">Tambah</span></button></div>
                    
                    {/* Desktop Table View */}
                    <div className="mobile-card-wrapper">
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase text-xs tracking-wider">
                                    <tr><th className="p-4">Nama</th><th className="p-4">Email</th><th className="p-4">Role</th><th className="p-4">Penempatan Toko</th><th className="p-4">Aksi</th></tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {users.slice((userCurrentPage - 1) * userItemsPerPage, userCurrentPage * userItemsPerPage).map(u => { 
                                        const storeName = stores.find(s => s.id === u.storeId)?.name || 'Semua (Owner)'; 
                                        return (
                                            <tr key={u.id} className="hover:bg-slate-50">
                                                <td className="p-4 font-bold text-slate-700">
                                                    {u.name} {u.role === 'owner' && <span className="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded ml-2">OWNER</span>}
                                                </td>
                                                <td className="p-4 text-slate-500">{u.email}</td>
                                                <td className="p-4"><span className="uppercase text-xs font-bold bg-slate-100 px-2 py-1 rounded border border-slate-200">{u.role}</span></td>
                                                <td className="p-4 text-slate-500 font-medium">{storeName}</td>
                                                <td className="p-4">
                                                    <div className="flex gap-2">
                                                        {u.role !== 'owner' && canEditEmployee && (
                                                            <button onClick={()=>setEditUserModal(u)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil className="w-4 h-4"/></button>
                                                        )}
                                                        {u.role !== 'owner' && (
                                                            <button onClick={()=>deleteUser(u.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4"/></button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ); 
                                    })}
                                </tbody>
                            </table>
                        </div>
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {users.slice((userCurrentPage - 1) * userItemsPerPage, userCurrentPage * userItemsPerPage).map(u => {
                                const storeName = stores.find(s => s.id === u.storeId)?.name || 'Semua (Owner)';
                                return (
                                    <div key={u.id} className="mobile-card">
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Nama</span>
                                            <span className="mobile-card-value">
                                                {u.name} {u.role === 'owner' && <span className="bg-purple-100 text-purple-700 text-[9px] px-1.5 py-0.5 rounded ml-1">OWNER</span>}
                                            </span>
                                        </div>
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Email</span>
                                            <span className="mobile-card-value text-xs">{u.email}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Role</span>
                                            <span className="mobile-card-value"><span className="uppercase text-[10px] font-bold bg-slate-100 px-2 py-1 rounded border border-slate-200">{u.role}</span></span>
                                        </div>
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Toko</span>
                                            <span className="mobile-card-value text-xs">{storeName}</span>
                                        </div>
                                        {u.role !== 'owner' && (
                                            <div className="mobile-card-actions">
                                                {canEditEmployee && (
                                                    <button onClick={()=>setEditUserModal(u)} className="flex-1 bg-blue-50 text-blue-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                                        <Pencil className="w-3 h-3"/> Edit
                                                    </button>
                                                )}
                                                <button onClick={()=>deleteUser(u.id)} className="flex-1 bg-red-50 text-red-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                                    <Trash2 className="w-3 h-3"/> Hapus
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    {users.length > userItemsPerPage && (
                        <div className="p-4 border-t border-slate-200">
                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                    <select value={userItemsPerPage} onChange={(e) => { setUserItemsPerPage(parseInt(e.target.value)); setUserCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                        <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                    </select>
                                    <span className="text-sm text-slate-600">per halaman</span>
                                </div>
                                <div className="text-sm text-slate-600">
                                    Menampilkan {Math.min((userCurrentPage - 1) * userItemsPerPage + 1, users.length)} - {Math.min(userCurrentPage * userItemsPerPage, users.length)} dari {users.length}
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => { if (userCurrentPage > 1) setUserCurrentPage(userCurrentPage - 1); }} disabled={userCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                    <div className="flex space-x-1">
                                        {Array.from({ length: Math.ceil(users.length / userItemsPerPage) }, (_, i) => {
                                            const p = i + 1;
                                            if (p === 1 || p === Math.ceil(users.length / userItemsPerPage) || (p >= userCurrentPage - 2 && p <= userCurrentPage + 2)) {
                                                return <button key={p} onClick={() => setUserCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === userCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                            } else if (p === userCurrentPage - 3 || p === userCurrentPage + 3) {
                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                            }
                                            return null;
                                        })}
                                    </div>
                                    <button onClick={() => { const tp = Math.ceil(users.length / userItemsPerPage); if (userCurrentPage < tp) setUserCurrentPage(userCurrentPage + 1); }} disabled={userCurrentPage === Math.ceil(users.length / userItemsPerPage)} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {modal && (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl"><h3 className="font-bold text-xl mb-6">Tambah Karyawan Baru</h3><form onSubmit={(e) => { e.preventDefault(); const formData = new FormData(e.target); addUser(Object.fromEntries(formData)); }} className="space-y-4"><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Nama</label><input name="name" className="w-full border p-2.5 rounded-lg" required/></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Email</label><input name="email" type="email" className="w-full border p-2.5 rounded-lg" required/></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Password</label><input name="password" type="password" className="w-full border p-2.5 rounded-lg" required minLength="8" placeholder="Min. 8 karakter"/><p className="text-xs text-slate-500 mt-1">Password ini akan digunakan pegawai untuk login (min. 8 karakter)</p></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Role</label><select name="role" className="w-full border p-2.5 rounded-lg"><option value="admin">Admin</option><option value="kasir">Kasir</option><option value="teknisi">Teknisi</option></select></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Penempatan Toko</label><select name="storeId" className="w-full border p-2.5 rounded-lg">{stores.map(s => (<option key={s.id} value={s.id}>{s.name}</option>))}</select></div><div className="flex gap-3 mt-8"><button type="button" onClick={()=>setModal(null)} className="flex-1 py-3 border rounded-xl font-bold">Batal</button><button className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Simpan</button></div></form></div></div>)}

                    {editUserModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <h3 className="font-bold text-xl mb-6">Edit Data Pegawai</h3>
                                <form onSubmit={handleEditUser} className="space-y-4">
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Nama</label><input name="name" defaultValue={editUserModal.name} className="w-full border p-2.5 rounded-lg" required/></div>
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Email (Tidak bisa diubah)</label><input value={editUserModal.email} disabled className="w-full border p-2.5 rounded-lg bg-gray-100 text-gray-500"/></div>
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Role</label><select name="role" defaultValue={editUserModal.role} className="w-full border p-2.5 rounded-lg"><option value="admin">Admin</option><option value="kasir">Kasir</option><option value="teknisi">Teknisi</option></select></div>
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Penempatan Toko</label><select name="storeId" defaultValue={editUserModal.storeId} className="w-full border p-2.5 rounded-lg">{stores.map(s => (<option key={s.id} value={s.id}>{s.name}</option>))}</select></div>
                                    <div className="flex gap-3 mt-8"><button type="button" onClick={()=>setEditUserModal(null)} className="flex-1 py-3 border rounded-xl font-bold">Batal</button><button className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Update</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                 </div>
             );
        };

        // ==========================================
        // üí∞ PURCHASE MANAGER (Pembelian)
        // ==========================================
        const PurchaseManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [purchases, setPurchases] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ supplierId: '', items: [], paymentMethod: 'cash', notes: '' });
            const [items, setItems] = useState([{ productId: '', productName: '', qty: 0, price: 0, subcategory: '' }]);
            const [purchaseCashAccount, setPurchaseCashAccount] = useState('Kas Tunai');
            const [purchaseDueDate, setPurchaseDueDate] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            const [brands, setBrands] = useState([]);
            const [customCategories, setCustomCategories] = useState([]);
            const [subCategories, setSubCategories] = useState({});
            const [filterBrand, setFilterBrand] = useState('');
            const [filterCategory, setFilterCategory] = useState('');
            const [searchTerms, setSearchTerms] = useState({}); // Search terms for each item index
            const [dropdownOpen, setDropdownOpen] = useState({}); // Track which dropdown is open
            const [cashFlow, setCashFlow] = useState([]); // For balance validation
            const [editMode, setEditMode] = useState(null); // Purchase ID being edited

            // Auto-clear search terms when filter changes to show filtered products
            useEffect(() => {
                if (filterBrand || filterCategory) {
                    setSearchTerms({});
                }
            }, [filterBrand, filterCategory]);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const purchasesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'purchases');
                let q = query(purchasesRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(purchasesRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setPurchases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const suppliersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers');
                const qSupplier = query(suppliersRef, where('ownerId', '==', activeOwner.id));
                const unsubSupplier = onSnapshot(qSupplier, (snapshot) => {
                    setSuppliers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const inventoryRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory');
                const qInv = activeStore?.id && activeStore.id !== 'all' 
                    ? query(inventoryRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id))
                    : query(inventoryRef, where('ownerId', '==', activeOwner.id));
                const unsubInv = onSnapshot(qInv, (snapshot) => {
                    setInventory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                // Load brands
                const brandsQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'brands'), where('ownerId', '==', activeOwner.id));
                const unsubBrands = onSnapshot(brandsQ, (snapshot) => {
                    setBrands(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                // Load categories and subcategories from store_configs
                let qConfig;
                if (activeStore?.id && activeStore.id !== 'all') {
                    qConfig = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id), 
                        where('storeId', '==', activeStore.id));
                } else {
                    qConfig = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id));
                }
                const unsubConfig = onSnapshot(qConfig, (snapshot) => {
                    const allCats = new Set();
                    const allSubCats = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.customCategories && Array.isArray(data.customCategories)) {
                            data.customCategories.forEach(cat => allCats.add(cat));
                        }
                        if (data.subCategories && typeof data.subCategories === 'object') {
                            Object.assign(allSubCats, data.subCategories);
                        }
                    });
                    setCustomCategories(Array.from(allCats));
                    setSubCategories(allSubCats);
                    console.log('üì¶ Purchase Manager - Loaded Categories:', Array.from(allCats));
                    console.log('üì¶ Purchase Manager - Loaded SubCategories:', allSubCats);
                });

                return () => { unsubscribe(); unsubSupplier(); unsubInv(); unsubBrands(); unsubConfig(); };
            }, [activeOwner?.id, activeStore?.id]);

            // Load cash flow for balance validation
            useEffect(() => {
                if (!activeOwner?.id) return;
                const cashRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow');
                let q = query(cashRef, where('ownerId', '==', activeOwner.id));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(cashRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setCashFlow(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            // Calculate cash balance for specific account
            const getCashBalance = (accountName) => {
                const flows = cashFlow.filter(c => (c.account || 'Kas Tunai') === accountName);
                const totalIn = flows.filter(c => c.type === 'in').reduce((sum, c) => sum + c.amount, 0);
                const totalOut = flows.filter(c => c.type === 'out').reduce((sum, c) => sum + c.amount, 0);
                return totalIn - totalOut;
            };

            // Build category list
            const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
            const allCategories = [...new Set([...defaultCategories, ...customCategories])];

            // Filter inventory by brand & category for item selection
            const filteredInventory = inventory.filter(i => {
                const matchBrand = !filterBrand || (i.brand && i.brand === filterBrand);
                const matchCategory = !filterCategory || (i.category && i.category === filterCategory);
                return matchBrand && matchCategory;
            });

            // Log filtered results when filters change
            useEffect(() => {
                if (filterBrand || filterCategory) {
                    console.log('üîç Active Filters:', { filterBrand, filterCategory });
                    console.log('üîç Filtered Inventory Count:', filteredInventory.length);
                    console.log('üîç Total Inventory Count:', inventory.length);
                }
            }, [filterBrand, filterCategory, filteredInventory.length, inventory.length]);

            const addItem = () => setItems([...items, { productId: '', productName: '', qty: 0, price: 0, subcategory: '' }]);
            
            const removeItem = (idx) => {
                setItems(items.filter((_, i) => i !== idx));
                // Clean up search terms and dropdown state for removed item
                setSearchTerms(prev => {
                    const newState = { ...prev };
                    delete newState[idx];
                    // Re-index remaining items
                    const reindexed = {};
                    Object.keys(newState).forEach(key => {
                        const keyNum = parseInt(key);
                        if (keyNum > idx) {
                            reindexed[keyNum - 1] = newState[key];
                        } else {
                            reindexed[key] = newState[key];
                        }
                    });
                    return reindexed;
                });
                setDropdownOpen(prev => {
                    const newState = { ...prev };
                    delete newState[idx];
                    // Re-index remaining items
                    const reindexed = {};
                    Object.keys(newState).forEach(key => {
                        const keyNum = parseInt(key);
                        if (keyNum > idx) {
                            reindexed[keyNum - 1] = newState[key];
                        } else {
                            reindexed[key] = newState[key];
                        }
                    });
                    return reindexed;
                });
            };
            const updateItem = (idx, field, value) => {
                const newItems = [...items];
                newItems[idx][field] = value;
                if (field === 'productId') {
                    const product = inventory.find(p => p.id === value);
                    if (product) {
                        newItems[idx].productName = product.name;
                        newItems[idx].price = product.buyPrice || 0;
                    }
                    // Clear search term and close dropdown when product is selected
                    setSearchTerms(prev => ({ ...prev, [idx]: '' }));
                    setDropdownOpen(prev => ({ ...prev, [idx]: false }));
                }
                setItems(newItems);
            };

            const handleSearchChange = (idx, value) => {
                setSearchTerms(prev => ({ ...prev, [idx]: value }));
                setDropdownOpen(prev => ({ ...prev, [idx]: true }));
                
                // Clear selected product if search term is cleared
                if (!value.trim()) {
                    updateItem(idx, 'productId', '');
                }
            };

            const selectProduct = (idx, product) => {
                updateItem(idx, 'productId', product.id);
            };

            const getFilteredProducts = (idx) => {
                const searchTerm = searchTerms[idx]?.toLowerCase() || '';
                if (!searchTerm) return filteredInventory;
                
                return filteredInventory.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.brand && product.brand.toLowerCase().includes(searchTerm)) ||
                    (product.category && product.category.toLowerCase().includes(searchTerm)) ||
                    (product.subCategory && product.subCategory.toLowerCase().includes(searchTerm))
                );
            };

            const submitPurchase = async (e) => {
                e.preventDefault();
                if (items.length === 0 || items.some(i => !i.productId || i.qty <= 0)) {
                    alert('Isi semua item dengan benar!');
                    return;
                }

                try {
                    const total = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
                    
                    // Validate cash balance if not credit
                    if (form.paymentMethod !== 'credit') {
                        const currentBalance = getCashBalance(purchaseCashAccount);
                        if (currentBalance < total) {
                            alert(`‚ùå Saldo kas "${purchaseCashAccount}" tidak mencukupi!\n\nSaldo tersedia: ${formatCurrency(currentBalance)}\nTotal pembelian: ${formatCurrency(total)}\n\nSilakan pilih akun kas lain atau gunakan metode kredit.`);
                            return;
                        }
                    }
                    
                    const purchaseData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        supplierId: form.supplierId,
                        supplierName: suppliers.find(s => s.id === form.supplierId)?.name || 'Unknown',
                        items: items,
                        total: total,
                        paymentMethod: form.paymentMethod,
                        cashAccount: purchaseCashAccount,
                        notes: form.notes,
                        createdAt: serverTimestamp()
                    };

                    if (editMode) {
                        // Update existing purchase
                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'purchases', editMode), purchaseData);
                        alert('‚úÖ Pembelian berhasil diupdate!');
                    } else {
                        // Add new purchase
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'purchases'), purchaseData);

                        // Update stock for each item
                        for (const item of items) {
                            const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.productId);
                            await runTransaction(db, async (transaction) => {
                                const productSnap = await transaction.get(productRef);
                                if (productSnap.exists()) {
                                    transaction.update(productRef, {
                                        stock: increment(item.qty)
                                    });
                                }
                            });
                        }

                        // Add to cash flow (only if not credit)
                        if (form.paymentMethod !== 'credit') {
                            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), {
                                ownerId: activeOwner.id,
                                storeId: activeStore.id,
                                type: 'out',
                                amount: total,
                                category: 'Pembelian Barang',
                                description: `Pembelian dari ${purchaseData.supplierName}`,
                                account: purchaseCashAccount,
                                createdAt: serverTimestamp()
                            });
                        }

                        // Add to expense transactions (only if not kredit)
                        if (form.paymentMethod !== 'credit') {
                            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                                ownerId: activeOwner.id,
                                storeId: activeStore.id,
                                type: 'expense',
                                category: 'Pembelian Barang',
                                description: `Pembelian dari ${purchaseData.supplierName}`,
                                amount: total,
                                cashAccount: purchaseCashAccount,
                                date: serverTimestamp()
                            });
                        }

                        // If credit, create payable (debt)
                        if (form.paymentMethod === 'credit') {
                            const _now2 = new Date();
                            const _pad2 = (n,l=2) => String(n).padStart(l,'0');
                            const _ds2 = `${_now2.getFullYear()}${_pad2(_now2.getMonth()+1)}${_pad2(_now2.getDate())}`;
                            const _inv2 = `UTG-${_ds2}-${_pad2(Math.floor(Math.random()*9000)+1000,4)}`;
                            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                                ownerId: activeOwner.id,
                                storeId: activeStore.id,
                                type: 'payable',
                                customerName: purchaseData.supplierName,
                                invoiceNo: _inv2,
                                amount: total,
                                paid: 0,
                                remaining: total,
                                description: `Pembelian barang - ${items.map(i => i.productName).join(', ')}`,
                                items: items.map(i => ({ name: i.productName, qty: i.qty, price: i.price })),
                                dueDate: purchaseDueDate ? new Date(Date.now()+Number(purchaseDueDate)*86400000).toISOString().split('T')[0] : '',
                                status: 'unpaid',
                                createdAt: serverTimestamp()
                            });
                        }

                        alert('‚úÖ Pembelian berhasil dicatat!');
                    }
                    
                    closeModal();
                    setPurchaseCashAccount('Kas Tunai');
                    setFilterBrand('');
                    setFilterCategory('');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = purchases.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedPurchases = purchases.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };
            
            const resetForm = () => {
                setForm({ supplierId: '', items: [], paymentMethod: 'cash', notes: '' });
                setItems([{ productId: '', productName: '', qty: 0, price: 0, subcategory: '' }]);
                setSearchTerms({});
                setDropdownOpen({});
                setEditMode(null);
                setPurchaseDueDate('');
                setFilterBrand('');
                setFilterCategory('');
            };
            
            const openModal = () => {
                resetForm();
                setModal(true);
            };
            
            const openEditModal = (purchase) => {
                setForm({
                    supplierId: purchase.supplierId,
                    paymentMethod: purchase.paymentMethod,
                    notes: purchase.notes || ''
                });
                setItems(purchase.items.map(item => ({ ...item })));
                setPurchaseCashAccount(purchase.cashAccount || 'Kas Tunai');
                setEditMode(purchase.id);
                setModal(true);
            };
            
            const deletePurchase = async (purchase) => {
                if (!confirm(`Hapus pembelian dari ${purchase.supplierName}?\n\nPeringatan: Stok barang akan dikurangi kembali!`)) return;
                
                try {
                    // Restore stock for each item
                    for (const item of purchase.items) {
                        const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.productId);
                        const productSnap = await getDoc(productRef);
                        if (productSnap.exists()) {
                            await updateDoc(productRef, {
                                stock: increment(-item.qty)
                            });
                        }
                    }
                    
                    // Delete purchase document
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'purchases', purchase.id));
                    
                    // Find and delete related cash flow entry (if not credit)
                    if (purchase.paymentMethod !== 'credit') {
                        const cashFlowRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow');
                        const q = query(
                            cashFlowRef, 
                            where('ownerId', '==', purchase.ownerId),
                            where('storeId', '==', purchase.storeId),
                            where('type', '==', 'out'),
                            where('amount', '==', purchase.total),
                            where('category', '==', 'Pembelian Barang')
                        );
                        const snapshot = await getDocs(q);
                        snapshot.docs.forEach(async (docSnap) => {
                            const desc = docSnap.data().description || '';
                            if (desc.includes(purchase.supplierName)) {
                                await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow', docSnap.id));
                            }
                        });
                        
                        // Also delete from transactions
                        const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                        const qTrans = query(
                            transRef,
                            where('ownerId', '==', purchase.ownerId),
                            where('storeId', '==', purchase.storeId),
                            where('type', '==', 'expense'),
                            where('amount', '==', purchase.total),
                            where('category', '==', 'Pembelian Barang')
                        );
                        const transSnapshot = await getDocs(qTrans);
                        transSnapshot.docs.forEach(async (docSnap) => {
                            const desc = docSnap.data().description || '';
                            if (desc.includes(purchase.supplierName)) {
                                await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'transactions', docSnap.id));
                            }
                        });
                    } else {
                        // Delete payable if credit
                        const debtsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'debts');
                        const qDebt = query(
                            debtsRef,
                            where('ownerId', '==', purchase.ownerId),
                            where('storeId', '==', purchase.storeId),
                            where('type', '==', 'payable'),
                            where('amount', '==', purchase.total),
                            where('customerName', '==', purchase.supplierName)
                        );
                        const debtSnapshot = await getDocs(qDebt);
                        debtSnapshot.docs.forEach(async (docSnap) => {
                            await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'debts', docSnap.id));
                        });
                    }
                    
                    alert('‚úÖ Pembelian berhasil dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            
            const closeModal = () => {
                resetForm();
                setModal(false);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üì¶ Pembelian</h2>
                        <button onClick={openModal} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Pembelian
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto mobile-card-wrapper">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Supplier</th>
                                    <th className="p-3 text-left">Item</th>
                                    <th className="p-3 text-right">Total</th>
                                    <th className="p-3 text-left">Pembayaran</th>
                                    <th className="p-3 text-left">Catatan</th>
                                    <th className="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedPurchases.map(p => (
                                    <tr key={p.id}>
                                        <td className="p-3 text-gray-500">{formatDate(p.createdAt)}</td>
                                        <td className="p-3 font-medium">{p.supplierName}</td>
                                        <td className="p-3">
                                            <div className="text-xs space-y-1">
                                                {p.items.map((item, idx) => (
                                                    <div key={idx}>
                                                        {item.productName} x{item.qty}
                                                        {item.subcategory && <span className="ml-1 text-[10px] bg-purple-100 text-purple-700 px-1 rounded">{item.subcategory}</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-right font-bold text-blue-600">{formatCurrency(p.total)}</td>
                                        <td className="p-3">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${p.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : p.paymentMethod === 'credit' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                                                {p.paymentMethod === 'cash' ? 'Tunai' : p.paymentMethod === 'credit' ? 'üí≥ Kredit' : 'Transfer'}
                                            </span>
                                        </td>
                                        <td className="p-3 text-xs text-gray-500">{p.notes || '-'}</td>
                                        <td className="p-3">
                                            <div className="flex gap-2 justify-center">
                                                <button 
                                                    onClick={() => openEditModal(p)}
                                                    className="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors"
                                                    title="Edit Pembelian"
                                                >
                                                    <Pencil className="w-4 h-4" />
                                                </button>
                                                <button 
                                                    onClick={() => deletePurchase(p)}
                                                    className="text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors"
                                                    title="Hapus Pembelian"
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {purchases.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data pembelian</div>}
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {paginatedPurchases.map(p => (
                                <div key={p.id} className="mobile-card">
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Tanggal</span>
                                        <span className="mobile-card-value text-xs">{formatDate(p.createdAt)}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Supplier</span>
                                        <span className="mobile-card-value">{p.supplierName}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Item</span>
                                        <span className="mobile-card-value">
                                            <div className="text-xs space-y-1">
                                                {p.items.map((item, idx) => (
                                                    <div key={idx}>
                                                        {item.productName} x{item.qty}
                                                        {item.subcategory && <span className="ml-1 text-[10px] bg-purple-100 text-purple-700 px-1 rounded">{item.subcategory}</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Total</span>
                                        <span className="mobile-card-value font-bold text-blue-600">{formatCurrency(p.total)}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Pembayaran</span>
                                        <span className="mobile-card-value">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${p.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : p.paymentMethod === 'credit' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                                                {p.paymentMethod === 'cash' ? 'Tunai' : p.paymentMethod === 'credit' ? 'üí≥ Kredit' : 'Transfer'}
                                            </span>
                                        </span>
                                    </div>
                                    {p.notes && (
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Catatan</span>
                                            <span className="mobile-card-value text-xs">{p.notes}</span>
                                        </div>
                                    )}
                                    <div className="mobile-card-row" style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #e5e7eb'}}>
                                        <div style={{display: 'flex', gap: '8px', width: '100%'}}>
                                            <button 
                                                onClick={() => openEditModal(p)}
                                                className="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 p-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 transition-colors"
                                            >
                                                <Pencil className="w-4 h-4" /> Edit
                                            </button>
                                            <button 
                                                onClick={() => deletePurchase(p)}
                                                className="flex-1 bg-red-50 text-red-600 hover:bg-red-100 p-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 transition-colors"
                                            >
                                                <Trash2 className="w-4 h-4" /> Hapus
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {purchases.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data pembelian</div>}
                        </div>
                    </div>

                    {purchases.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6">
                                <h3 className="font-bold text-xl mb-4">{editMode ? '‚úèÔ∏è Edit Pembelian' : '‚ûï Tambah Pembelian'}</h3>
                                <form onSubmit={submitPurchase} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Supplier</label>
                                        <select value={form.supplierId} onChange={e => setForm({ ...form, supplierId: e.target.value })} className="w-full border p-2 rounded" required>
                                            <option value="">-- Pilih Supplier --</option>
                                            {suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                        </select>
                                    </div>

                                    {/* Filter Brand & Kategori */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <div>
                                            <label className="text-xs font-bold text-blue-600 mb-1 block">üè∑Ô∏è Filter Brand</label>
                                            <select value={filterBrand} onChange={e => setFilterBrand(e.target.value)} className="w-full border border-blue-300 p-2 rounded text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                                <option value="">-- Semua Brand --</option>
                                                {brands.map(b => <option key={b.id} value={b.name}>{b.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-blue-600 mb-1 block">üìÇ Filter Kategori</label>
                                            <select value={filterCategory} onChange={e => setFilterCategory(e.target.value)} className="w-full border border-blue-300 p-2 rounded text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                                <option value="">-- Semua Kategori --</option>
                                                {allCategories.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                        {(filterBrand || filterCategory) && (
                                            <div className="col-span-2 flex items-center justify-between">
                                                <span className="text-xs text-blue-600">Menampilkan {filteredInventory.length} dari {inventory.length} produk</span>
                                                <button type="button" onClick={() => { setFilterBrand(''); setFilterCategory(''); }} className="text-xs text-blue-700 hover:underline font-bold">Reset Filter</button>
                                            </div>
                                        )}
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-xs font-bold text-slate-500">Item Pembelian</label>
                                            <button type="button" onClick={addItem} className="text-xs bg-green-600 text-white px-3 py-1 rounded">+ Item</button>
                                        </div>
                                        {items.map((item, idx) => {
                                            const selectedProduct = inventory.find(p => p.id === item.productId);
                                            const filteredProducts = getFilteredProducts(idx);
                                            const isOpen = dropdownOpen[idx] || false;
                                            // Get subcategories for selected product's category
                                            const availableSubCategories = selectedProduct?.category && subCategories[selectedProduct.category] 
                                                ? subCategories[selectedProduct.category] 
                                                : [];
                                            
                                            // Debug log when product is selected
                                            if (selectedProduct && idx === 0) {
                                                console.log('üîç Selected Product:', selectedProduct.name);
                                                console.log('üîç Product Category:', selectedProduct.category);
                                                console.log('üîç Available SubCategories:', availableSubCategories);
                                            }
                                            
                                            return (
                                                <div key={idx} className="flex gap-2 mb-2">
                                                    {/* Custom Searchable Product Dropdown */}
                                                    <div className="flex-1 relative">
                                                        <input
                                                            type="text"
                                                            value={selectedProduct ? `${selectedProduct.name}${selectedProduct.brand ? ` (${selectedProduct.brand})` : ''}${selectedProduct.subCategory ? ` [${selectedProduct.subCategory}]` : ''}` : (searchTerms[idx] || '')}
                                                            onChange={(e) => {
                                                                // If a product is selected, clear it first to allow re-searching
                                                                if (selectedProduct) {
                                                                    const newItems = [...items];
                                                                    newItems[idx].productId = '';
                                                                    newItems[idx].productName = '';
                                                                    newItems[idx].price = 0;
                                                                    setItems(newItems);
                                                                    setSearchTerms(prev => ({ ...prev, [idx]: '' }));
                                                                    setDropdownOpen(prev => ({ ...prev, [idx]: true }));
                                                                    return;
                                                                }
                                                                handleSearchChange(idx, e.target.value);
                                                            }}
                                                            onFocus={() => {
                                                                // If no product selected, show dropdown immediately
                                                                if (!selectedProduct) {
                                                                    setDropdownOpen(prev => ({ ...prev, [idx]: true }));
                                                                }
                                                            }}
                                                            onClick={() => {
                                                                // If product is selected, clear it and show dropdown for re-search
                                                                if (selectedProduct) {
                                                                    const newItems = [...items];
                                                                    newItems[idx].productId = '';
                                                                    newItems[idx].productName = '';
                                                                    newItems[idx].price = 0;
                                                                    setItems(newItems);
                                                                    setSearchTerms(prev => ({ ...prev, [idx]: '' }));
                                                                    setDropdownOpen(prev => ({ ...prev, [idx]: true }));
                                                                }
                                                            }}
                                                            placeholder="Ketik untuk cari produk..."
                                                            className="w-full border p-2 rounded text-sm"
                                                            required
                                                        />
                                                        
                                                        {/* Dropdown Options */}
                                                        {isOpen && (
                                                            <div className="absolute z-20 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto mt-1">
                                                                {filteredProducts.length > 0 ? (
                                                                    filteredProducts.slice(0, 10).map(product => (
                                                                        <button
                                                                            key={product.id}
                                                                            type="button"
                                                                            onClick={() => selectProduct(idx, product)}
                                                                            className="w-full text-left px-3 py-2 hover:bg-blue-50 text-sm border-b border-gray-100 last:border-b-0"
                                                                        >
                                                                            <div className="font-medium text-slate-800">{product.name}</div>
                                                                            <div className="text-xs text-slate-500 flex items-center gap-1 mt-1">
                                                                                {product.brand && <span className="bg-blue-100 text-blue-700 px-1 rounded">{product.brand}</span>}
                                                                                {product.category && <span className="bg-green-100 text-green-700 px-1 rounded">{product.category}</span>}
                                                                {product.subCategory && <span className="bg-purple-100 text-purple-700 px-1 rounded">{product.subCategory}</span>}
                                                                                <span className="text-slate-400">Stok: {product.stock || 0}</span>
                                                                                <span className="text-slate-400">|</span>
                                                                                <span className="text-slate-600 font-medium">Beli: {formatCurrency(product.buyPrice || 0)}</span>
                                                                            </div>
                                                                        </button>
                                                                    ))
                                                                ) : (
                                                                    <div className="px-3 py-2 text-sm text-gray-500">
                                                                        {(filterBrand || filterCategory) ? (
                                                                            <div>
                                                                                <div className="font-medium text-orange-600">Tidak ada produk ditemukan</div>
                                                                                <div className="text-xs mt-1">
                                                                                    {filterBrand && <div>‚Ä¢ Brand: {filterBrand}</div>}
                                                                                    {filterCategory && <div>‚Ä¢ Kategori: {filterCategory}</div>}
                                                                                    {searchTerms[idx] && <div>‚Ä¢ Pencarian: "{searchTerms[idx]}"</div>}
                                                                                </div>
                                                                            </div>
                                                                        ) : (
                                                                            searchTerms[idx] ? `Tidak ada produk "${searchTerms[idx]}" ditemukan` : 'Ketik untuk mencari produk...'
                                                                        )}
                                                                    </div>
                                                                )}
                                                                {filteredProducts.length > 10 && (
                                                                    <div className="px-3 py-2 text-xs text-gray-400 bg-gray-50 font-medium">
                                                                        {filteredProducts.length - 10} produk lainnya... (ketik lebih spesifik)
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                        
                                                        {/* Click outside to close */}
                                                        {isOpen && (
                                                            <div 
                                                                className="fixed inset-0 z-5"
                                                                onClick={() => setDropdownOpen(prev => ({ ...prev, [idx]: false }))}
                                                            ></div>
                                                        )}
                                                    </div>
                                                    
                                                    <select 
                                                        value={item.subcategory} 
                                                        onChange={e => updateItem(idx, 'subcategory', e.target.value)} 
                                                        className="w-36 border p-2 rounded text-sm" 
                                                        disabled={!selectedProduct}
                                                        required={availableSubCategories.length > 0}
                                                    >
                                                        <option value="">{selectedProduct ? (availableSubCategories.length > 0 ? 'Pilih Sub Kategori' : 'Tidak Ada Sub') : 'Pilih Produk Dulu'}</option>
                                                        {availableSubCategories.map(sub => <option key={sub} value={sub}>{sub}</option>)}
                                                    </select>
                                                    <NumberInput value={item.qty} onChange={val => updateItem(idx, 'qty', val)} placeholder="Qty" className="w-20 border p-2 rounded text-sm" required />
                                                    <NumberInput value={item.price} onChange={val => updateItem(idx, 'price', val)} placeholder="Harga" className="w-32 border p-2 rounded text-sm" required />
                                                    {items.length > 1 && <button type="button" onClick={() => removeItem(idx)} className="text-red-600 px-2"><Trash2 className="w-4 h-4" /></button>}
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Total</label>
                                        <div className="text-2xl font-bold text-blue-600">{formatCurrency(items.reduce((sum, i) => sum + (i.qty * i.price), 0))}</div>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Metode Pembayaran</label>
                                        <select value={form.paymentMethod} onChange={e => setForm({ ...form, paymentMethod: e.target.value })} className="w-full border p-2 rounded">
                                            <option value="cash">Tunai</option>
                                            <option value="transfer">Transfer</option>
                                            <option value="credit">üí≥ Kredit (Hutang)</option>
                                        </select>
                                        {form.paymentMethod === 'credit' && (
                                            <div>
                                                <p className="text-xs text-orange-600 mt-1">‚ö†Ô∏è Akan otomatis dicatat sebagai utang ke supplier</p>
                                                <div className="mt-2">
                                                    <label className="text-xs font-bold text-slate-500">üìÖ Jatuh Tempo</label>
                                                    <div className="flex items-center gap-2 mt-1">
                                                        <input type="number" min="1" max="365" placeholder="cth: 30" value={purchaseDueDate} onChange={e => setPurchaseDueDate(e.target.value)} className="w-full border border-orange-300 p-2 rounded-lg text-sm" />
                                                        <span className="text-xs text-slate-500 whitespace-nowrap">hari</span>
                                                    </div>
                                                    {purchaseDueDate > 0 && <p className="text-xs text-slate-400 mt-1">Jatuh tempo: {new Date(Date.now()+Number(purchaseDueDate)*86400000).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}</p>}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {form.paymentMethod !== 'credit' && (
                                        <CashAccountSelect value={purchaseCashAccount} onChange={setPurchaseCashAccount} />
                                    )}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Catatan</label>
                                        <textarea value={form.notes} onChange={e => setForm({ ...form, notes: e.target.value })} className="w-full border p-2 rounded" rows="2" placeholder="Catatan tambahan..."></textarea>
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={closeModal} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">
                                            {editMode ? 'üíæ Update' : '‚úÖ Simpan'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üöö SUPPLIER MANAGER
        // ==========================================
        const SupplierManager = () => {
            const { activeOwner } = useContext(SessionContext);
            const [suppliers, setSuppliers] = useState([]);
            const [modal, setModal] = useState(false);
            const [editModal, setEditModal] = useState(null);
            const [form, setForm] = useState({ name: '', phone: '', address: '', email: '' });
            const [supplierCurrentPage, setSupplierCurrentPage] = useState(1);
            const [supplierItemsPerPage, setSupplierItemsPerPage] = useState(9);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers'), where('ownerId', '==', activeOwner.id));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setSuppliers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id]);

            const addSupplier = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers'), {
                        ownerId: activeOwner.id,
                        name: form.name,
                        phone: form.phone,
                        address: form.address,
                        email: form.email,
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Supplier berhasil ditambahkan!');
                    setModal(false);
                    setForm({ name: '', phone: '', address: '', email: '' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const updateSupplier = async (e) => {
                e.preventDefault();
                try {
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'suppliers', editModal.id), {
                        name: form.name,
                        phone: form.phone,
                        address: form.address,
                        email: form.email
                    });
                    alert('‚úÖ Supplier berhasil diperbarui!');
                    setEditModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const deleteSupplier = async (supplier) => {
                if (!confirm(`Hapus supplier "${supplier.name}"?`)) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'suppliers', supplier.id));
                    alert('‚úÖ Supplier berhasil dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üöö Supplier</h2>
                        <button onClick={() => setModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Supplier
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {(() => {
                            const supStart = (supplierCurrentPage - 1) * supplierItemsPerPage;
                            const supEnd = supStart + supplierItemsPerPage;
                            return suppliers.slice(supStart, supEnd).map(s => (
                            <div key={s.id} className="bg-white border rounded-lg p-4 hover:shadow-lg transition-shadow">
                                <div className="flex justify-between items-start mb-3">
                                    <h3 className="font-bold text-lg">{s.name}</h3>
                                    <div className="flex gap-1">
                                        <button onClick={() => { setForm(s); setEditModal(s); }} className="text-blue-600 p-1 hover:bg-blue-50 rounded"><Pencil className="w-4 h-4" /></button>
                                        <button onClick={() => deleteSupplier(s)} className="text-red-600 p-1 hover:bg-red-50 rounded"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                </div>
                                <div className="space-y-2 text-sm text-gray-600">
                                    <div className="flex items-center gap-2">
                                        <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                                        </svg>
                                        {s.phone || '-'}
                                    </div>
                                    <div className="flex items-center gap-2"><Mail className="w-3 h-3" /> {s.email || '-'}</div>
                                    <div className="flex items-start gap-2"><MapPin className="w-3 h-3 mt-1" /> <span className="flex-1">{s.address || '-'}</span></div>
                                </div>
                            </div>
                        ));
                        })()}
                    </div>
                    {suppliers.length === 0 && <div className="bg-white rounded-lg p-8 text-center text-gray-400">Belum ada data supplier</div>}
                    
                    {/* Pagination Controls for Suppliers */}
                    {suppliers.length > supplierItemsPerPage && (
                        <div className="pt-4 border-t border-slate-200">
                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                    <select value={supplierItemsPerPage} onChange={(e) => { setSupplierItemsPerPage(parseInt(e.target.value)); setSupplierCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                        <option value="6">6</option><option value="9">9</option><option value="12">12</option><option value="24">24</option>
                                    </select>
                                    <span className="text-sm text-slate-600">per halaman</span>
                                </div>
                                <div className="text-sm text-slate-600">
                                    Menampilkan {Math.min((supplierCurrentPage - 1) * supplierItemsPerPage + 1, suppliers.length)} - {Math.min(supplierCurrentPage * supplierItemsPerPage, suppliers.length)} dari {suppliers.length}
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => { if (supplierCurrentPage > 1) setSupplierCurrentPage(supplierCurrentPage - 1); }} disabled={supplierCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                    <div className="flex space-x-1">
                                        {Array.from({ length: Math.ceil(suppliers.length / supplierItemsPerPage) }, (_, i) => {
                                            const p = i + 1;
                                            if (p === 1 || p === Math.ceil(suppliers.length / supplierItemsPerPage) || (p >= supplierCurrentPage - 2 && p <= supplierCurrentPage + 2)) {
                                                return <button key={p} onClick={() => setSupplierCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === supplierCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                            } else if (p === supplierCurrentPage - 3 || p === supplierCurrentPage + 3) {
                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                            }
                                            return null;
                                        })}
                                    </div>
                                    <button onClick={() => { const tp = Math.ceil(suppliers.length / supplierItemsPerPage); if (supplierCurrentPage < tp) setSupplierCurrentPage(supplierCurrentPage + 1); }} disabled={supplierCurrentPage === Math.ceil(suppliers.length / supplierItemsPerPage)} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {(modal || editModal) && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">{editModal ? 'Edit Supplier' : 'Tambah Supplier'}</h3>
                                <form onSubmit={editModal ? updateSupplier : addSupplier} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Supplier</label>
                                        <input value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">No. Telepon</label>
                                        <input value={form.phone} onChange={e => setForm({ ...form, phone: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Email</label>
                                        <input type="email" value={form.email} onChange={e => setForm({ ...form, email: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Alamat</label>
                                        <textarea value={form.address} onChange={e => setForm({ ...form, address: e.target.value })} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => { setModal(false); setEditModal(null); setForm({ name: '', phone: '', address: '', email: '' }); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üîÑ RETURN SALES MANAGER (Retur Penjualan)
        // ==========================================
        const ReturnSalesManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [returns, setReturns] = useState([]);
            const [sales, setSales] = useState([]);
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ saleId: '', reason: '', compensation: 0 });
            const [returnSalesCashAccount, setReturnSalesCashAccount] = useState('Kas Tunai');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                
                const returnsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'return_sales');
                let qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                }
                const unsubReturns = onSnapshot(qReturns, (snapshot) => {
                    setReturns(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const salesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'sales');
                let qSales = query(salesRef, where('ownerId', '==', activeOwner.id), where('type', '==', 'sale'), orderBy('createdAt', 'desc'), limit(50));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qSales = query(salesRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), where('type', '==', 'sale'), orderBy('createdAt', 'desc'), limit(50));
                }
                const unsubSales = onSnapshot(qSales, (snapshot) => {
                    setSales(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubReturns(); unsubSales(); };
            }, [activeOwner?.id, activeStore?.id]);

            const submitReturn = async (e) => {
                e.preventDefault();
                if (!form.saleId) {
                    alert('Pilih transaksi penjualan!');
                    return;
                }

                try {
                    const sale = sales.find(s => s.id === form.saleId);
                    if (!sale) {
                        alert('Transaksi tidak ditemukan');
                        return;
                    }

                    const returnData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        saleId: form.saleId,
                        customerName: sale.customerName,
                        items: sale.items || [],
                        total: sale.total,
                        reason: form.reason,
                        compensation: form.compensation || 0,
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'return_sales'), returnData);

                    // Kembalikan stok
                    for (const item of (sale.items || [])) {
                        if (item.id) {
                            const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.id);
                            await runTransaction(db, async (transaction) => {
                                const productSnap = await transaction.get(productRef);
                                if (productSnap.exists()) {
                                    transaction.update(productRef, {
                                        stock: increment(item.qty)
                                    });
                                }
                            });
                        }
                    }

                    // Catat refund sebagai pengeluaran
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'expense',
                        category: 'Retur Penjualan',
                        description: `Retur dari ${sale.customerName} - ${form.reason}`,
                        amount: sale.total,
                        cashAccount: returnSalesCashAccount,
                        date: serverTimestamp()
                    });

                    // Jika ada kompensasi, catat sebagai income dengan kategori khusus
                    if (form.compensation > 0) {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'income',
                            category: 'Kompensasi Retur Penjualan',
                            description: `Kompensasi retur dari ${sale.customerName} - ${form.reason}`,
                            amount: form.compensation,
                            cashAccount: returnSalesCashAccount,
                            date: serverTimestamp()
                        });
                    }

                    alert('‚úÖ Retur berhasil diproses!');
                    setModal(false);
                    setForm({ saleId: '', reason: '', compensation: 0 });
                    setReturnSalesCashAccount('Kas Tunai');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = returns.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedReturns = returns.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üîÑ Retur Penjualan</h2>
                        <button onClick={() => setModal(true)} className="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Proses Retur
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto mobile-card-wrapper">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Pelanggan</th>
                                    <th className="p-3 text-left">Item</th>
                                    <th className="p-3 text-left">Alasan</th>
                                    <th className="p-3 text-right">Total Refund</th>
                                    <th className="p-3 text-right">Kompensasi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedReturns.map(r => (
                                    <tr key={r.id}>
                                        <td className="p-3 text-gray-500">{formatDate(r.createdAt)}</td>
                                        <td className="p-3 font-medium">{r.customerName}</td>
                                        <td className="p-3">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.name} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-xs text-gray-600">{r.reason}</td>
                                        <td className="p-3 text-right font-bold text-red-600">{formatCurrency(r.total)}</td>
                                        <td className="p-3 text-right font-bold text-green-600">{r.compensation ? formatCurrency(r.compensation) : '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur penjualan</div>}
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {paginatedReturns.map(r => (
                                <div key={r.id} className="mobile-card">
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Tanggal</span>
                                        <span className="mobile-card-value text-xs">{formatDate(r.createdAt)}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Pelanggan</span>
                                        <span className="mobile-card-value">{r.customerName}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Item</span>
                                        <span className="mobile-card-value">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.name} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Alasan</span>
                                        <span className="mobile-card-value text-xs">{r.reason}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Total Refund</span>
                                        <span className="mobile-card-value font-bold text-red-600">{formatCurrency(r.total)}</span>
                                    </div>
                                    {r.compensation && (
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Kompensasi</span>
                                            <span className="mobile-card-value font-bold text-green-600">{formatCurrency(r.compensation)}</span>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur penjualan</div>}
                        </div>
                    </div>

                    {returns.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-2xl p-6">
                                <h3 className="font-bold text-xl mb-4">Proses Retur Penjualan</h3>
                                <form onSubmit={submitReturn} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Pilih Transaksi Penjualan</label>
                                        <select value={form.saleId} onChange={e => setForm({ ...form, saleId: e.target.value })} className="w-full border p-2 rounded" required>
                                            <option value="">-- Pilih Penjualan --</option>
                                            {sales.map(s => (
                                                <option key={s.id} value={s.id}>
                                                    {formatDate(s.createdAt)} - {s.customerName} - {formatCurrency(s.total)}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {form.saleId && (() => {
                                        const sale = sales.find(s => s.id === form.saleId);
                                        return sale ? (
                                            <div className="bg-blue-50 p-3 rounded border border-blue-200">
                                                <div className="text-xs font-bold text-blue-700 mb-2">Detail Penjualan:</div>
                                                <div className="space-y-1 text-xs">
                                                    {(sale.items || []).map((item, idx) => (
                                                        <div key={idx} className="flex justify-between">
                                                            <span>{item.name} x{item.qty}</span>
                                                            <span className="font-bold">{formatCurrency(item.sellPrice * item.qty)}</span>
                                                        </div>
                                                    ))}
                                                    <div className="border-t border-blue-300 pt-1 flex justify-between font-bold">
                                                        <span>Total:</span>
                                                        <span>{formatCurrency(sale.total)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : null;
                                    })()}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Alasan Retur</label>
                                        <textarea value={form.reason} onChange={e => setForm({ ...form, reason: e.target.value })} className="w-full border p-2 rounded" rows="3" placeholder="Contoh: Barang rusak, salah item, dll" required></textarea>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Biaya Kompensasi dari Pelanggan (Opsional)</label>
                                        <input type="number" value={form.compensation || 0} onChange={e => setForm({ ...form, compensation: parseFloat(e.target.value) || 0 })} className="w-full border p-2 rounded" placeholder="0" min="0" />
                                        <p className="text-xs text-slate-500 mt-1">Contoh: Biaya restocking, handling fee, dll</p>
                                        {form.compensation > 0 && (
                                            <div className="mt-1 text-xs text-green-600 font-bold">
                                                ‚úì Kompensasi {formatCurrency(form.compensation)} akan masuk ke Pemasukan (Kompensasi Retur Penjualan)
                                            </div>
                                        )}
                                    </div>

                                    <CashAccountSelect value={returnSalesCashAccount} onChange={setReturnSalesCashAccount} />

                                    <div className="bg-orange-50 border border-orange-200 p-3 rounded text-xs text-orange-700">
                                        ‚ö†Ô∏è <strong>Perhatian:</strong> Refund dicatat sebagai pengeluaran, kompensasi dari pelanggan masuk ke pemasukan
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-orange-600 text-white p-2 rounded font-bold">Proses Retur</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üîô RETURN PURCHASE MANAGER (Retur Pembelian)
        // ==========================================
        const ReturnPurchaseManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [returns, setReturns] = useState([]);
            const [purchases, setPurchases] = useState([]);
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ purchaseId: '', reason: '', compensation: 0 });
            const [returnPurchaseCashAccount, setReturnPurchaseCashAccount] = useState('Kas Tunai');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                
                const returnsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'return_purchases');
                let qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                }
                const unsubReturns = onSnapshot(qReturns, (snapshot) => {
                    setReturns(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const purchasesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'purchases');
                let qPurchases = query(purchasesRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'), limit(50));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qPurchases = query(purchasesRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'), limit(50));
                }
                const unsubPurchases = onSnapshot(qPurchases, (snapshot) => {
                    setPurchases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubReturns(); unsubPurchases(); };
            }, [activeOwner?.id, activeStore?.id]);

            const submitReturn = async (e) => {
                e.preventDefault();
                if (!form.purchaseId) {
                    alert('Pilih transaksi pembelian!');
                    return;
                }

                try {
                    const purchase = purchases.find(p => p.id === form.purchaseId);
                    if (!purchase) {
                        alert('Transaksi tidak ditemukan');
                        return;
                    }

                    const returnData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        purchaseId: form.purchaseId,
                        supplierName: purchase.supplierName,
                        items: purchase.items || [],
                        total: purchase.total,
                        reason: form.reason,
                        compensation: form.compensation || 0,
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'return_purchases'), returnData);

                    for (const item of (purchase.items || [])) {
                        if (item.productId) {
                            const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.productId);
                            await runTransaction(db, async (transaction) => {
                                const productSnap = await transaction.get(productRef);
                                if (productSnap.exists()) {
                                    transaction.update(productRef, {
                                        stock: increment(-item.qty)
                                    });
                                }
                            });
                        }
                    }

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'income',
                        category: 'Retur Pembelian',
                        description: `Retur ke ${purchase.supplierName} - ${form.reason}`,
                        amount: purchase.total,
                        cashAccount: returnPurchaseCashAccount,
                        date: serverTimestamp()
                    });

                    // Jika ada kompensasi ke supplier, catat sebagai expense
                    if (form.compensation > 0) {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'expense',
                            category: 'Kompensasi Retur Pembelian',
                            description: `Kompensasi retur ke ${purchase.supplierName} - ${form.reason}`,
                            amount: form.compensation,
                            cashAccount: returnPurchaseCashAccount,
                            date: serverTimestamp()
                        });
                    }

                    alert('‚úÖ Retur berhasil diproses!');
                    setModal(false);
                    setForm({ purchaseId: '', reason: '', compensation: 0 });
                    setReturnPurchaseCashAccount('Kas Tunai');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = returns.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedReturns = returns.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üîô Retur Pembelian</h2>
                        <button onClick={() => setModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Proses Retur
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto mobile-card-wrapper">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Supplier</th>
                                    <th className="p-3 text-left">Item</th>
                                    <th className="p-3 text-left">Alasan</th>
                                    <th className="p-3 text-right">Total Refund</th>
                                    <th className="p-3 text-right">Kompensasi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedReturns.map(r => (
                                    <tr key={r.id}>
                                        <td className="p-3 text-gray-500">{formatDate(r.createdAt)}</td>
                                        <td className="p-3 font-medium">{r.supplierName}</td>
                                        <td className="p-3">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.productName} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-xs text-gray-600">{r.reason}</td>
                                        <td className="p-3 text-right font-bold text-green-600">{formatCurrency(r.total)}</td>
                                        <td className="p-3 text-right font-bold text-red-600">{r.compensation ? formatCurrency(r.compensation) : '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur pembelian</div>}
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {paginatedReturns.map(r => (
                                <div key={r.id} className="mobile-card">
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Tanggal</span>
                                        <span className="mobile-card-value text-xs">{formatDate(r.createdAt)}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Supplier</span>
                                        <span className="mobile-card-value">{r.supplierName}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Item</span>
                                        <span className="mobile-card-value">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.productName} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Alasan</span>
                                        <span className="mobile-card-value text-xs">{r.reason}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Total Refund</span>
                                        <span className="mobile-card-value font-bold text-green-600">{formatCurrency(r.total)}</span>
                                    </div>
                                    {r.compensation > 0 && (
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Kompensasi</span>
                                            <span className="mobile-card-value font-bold text-orange-600">{formatCurrency(r.compensation)}</span>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur pembelian</div>}
                        </div>
                    </div>

                    {returns.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-2xl p-6">
                                <h3 className="font-bold text-xl mb-4">Proses Retur Pembelian</h3>
                                <form onSubmit={submitReturn} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Pilih Transaksi Pembelian</label>
                                        <select value={form.purchaseId} onChange={e => setForm({ ...form, purchaseId: e.target.value })} className="w-full border p-2 rounded" required>
                                            <option value="">-- Pilih Pembelian --</option>
                                            {purchases.map(p => (
                                                <option key={p.id} value={p.id}>
                                                    {formatDate(p.createdAt)} - {p.supplierName} - {formatCurrency(p.total)}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {form.purchaseId && (() => {
                                        const purchase = purchases.find(p => p.id === form.purchaseId);
                                        return purchase ? (
                                            <div className="bg-purple-50 p-3 rounded border border-purple-200">
                                                <div className="text-xs font-bold text-purple-700 mb-2">Detail Pembelian:</div>
                                                <div className="space-y-1 text-xs">
                                                    {(purchase.items || []).map((item, idx) => (
                                                        <div key={idx} className="flex justify-between">
                                                            <span>{item.productName} x{item.qty}</span>
                                                            <span className="font-bold">{formatCurrency(item.price * item.qty)}</span>
                                                        </div>
                                                    ))}
                                                    <div className="border-t border-purple-300 pt-1 flex justify-between font-bold">
                                                        <span>Total:</span>
                                                        <span>{formatCurrency(purchase.total)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : null;
                                    })()}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Alasan Retur</label>
                                        <textarea value={form.reason} onChange={e => setForm({ ...form, reason: e.target.value })} className="w-full border p-2 rounded" rows="3" placeholder="Contoh: Barang cacat, salah kirim, dll" required></textarea>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Biaya Kompensasi ke Supplier (Opsional)</label>
                                        <input type="number" value={form.compensation || 0} onChange={e => setForm({ ...form, compensation: parseFloat(e.target.value) || 0 })} className="w-full border p-2 rounded" placeholder="0" min="0" />
                                        <p className="text-xs text-slate-500 mt-1">Contoh: Ongkir retur, restocking fee, dll</p>
                                        {form.compensation > 0 && (
                                            <div className="mt-1 text-xs text-red-600 font-bold">
                                                ‚úì Kompensasi {formatCurrency(form.compensation)} akan masuk ke Pengeluaran (Kompensasi Retur Pembelian)
                                            </div>
                                        )}
                                    </div>

                                    <CashAccountSelect value={returnPurchaseCashAccount} onChange={setReturnPurchaseCashAccount} />

                                    <div className="bg-purple-50 border border-purple-200 p-3 rounded text-xs text-purple-700">
                                        ‚ö†Ô∏è <strong>Perhatian:</strong> Stok dikurangi, refund masuk pemasukan, kompensasi (jika ada) masuk pengeluaran
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-purple-600 text-white p-2 rounded font-bold">Proses Retur</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // ÔøΩ PAYABLE MANAGER (Utang - Yang Harus Kita Bayar)
        // ==========================================
        // ‚îÄ‚îÄ Invoice print helper (Utang/Piutang) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const printDebtInvoice = (debt, storeInfo, ownerInfo) => {
            const isPayable = debt.type === 'payable';
            const color = isPayable ? '#dc2626' : '#16a34a';
            const colorDark = isPayable ? '#b91c1c' : '#15803d';
            const colorBg = isPayable ? '#fef2f2' : '#f0fdf4';
            const colorBorder = isPayable ? '#fecaca' : '#bbf7d0';
            const label = isPayable ? 'INVOICE UTANG' : 'INVOICE PIUTANG';
            const items = debt.items || [];
            const hasItems = items.length > 0;
            const fmt = (n) => 'Rp ' + (n||0).toLocaleString('id-ID');
            const fmtDate = (d) => {
                if (!d) return '-';
                const dt = d?.toDate ? d.toDate() : new Date(d);
                return dt.toLocaleDateString('id-ID', {day:'2-digit',month:'short',year:'numeric'});
            };
            const itemRows = hasItems ? items.map(it => {
                const sub = (it.qty||1)*(it.price||0);
                return `<div style="padding:10px 0;border-bottom:1px solid #f0f0f0;">
                  <div style="font-size:16px;font-weight:700;color:#1e293b;margin-bottom:4px;">${it.name||'-'}</div>
                  <div style="display:flex;justify-content:space-between;"><span style="font-size:14px;color:#64748b;">${it.qty||1} x ${fmt(it.price)}</span><span style="font-size:16px;font-weight:700;">${fmt(sub)}</span></div>
                </div>`;
            }).join('') : `<div style="padding:16px 0;text-align:center;color:#94a3b8;font-size:15px;">${debt.description||'Tidak ada detail item'}</div>`;
            const statusLabel = debt.status==='paid'?'LUNAS':debt.status==='partial'?'DICICIL':'BELUM BAYAR';
            const statusColor = debt.status==='paid'?'#16a34a':debt.status==='partial'?'#ca8a04':'#dc2626';
            const statusBg = debt.status==='paid'?'#dcfce7':debt.status==='partial'?'#fef9c3':'#fee2e2';
            // ESC/POS inline script ‚Äî semua logika Bluetooth ada di dalam popup itu sendiri
            // agar requestDevice() dipanggil langsung dari user gesture di window yang sama
            const escposScript = `
<script>
var _btChar = null;
var _debt = ${JSON.stringify(debt)};
var _store = ${JSON.stringify(storeInfo||{})};

function setStatus(msg, color) {
  var el = document.getElementById('bt-status');
  if (el) { el.textContent = msg; el.style.color = color||'#1e293b'; }
}
function setBusy(busy) {
  var btn = document.getElementById('bt-btn');
  if (btn) { btn.disabled = busy; btn.textContent = busy ? '‚è≥ Mohon tunggu...' : 'üì∂ Cetak Bluetooth'; }
}

async function buildEscPos(debt, store) {
  var T = new TextEncoder();
  var parts = [];
  var add = function(arr) { parts.push(arr instanceof Uint8Array ? arr : new Uint8Array(arr)); };
  var text = function(s) { parts.push(T.encode(String(s||''))); };
  var W = 32;
  var SEP  = '================================';
  var DASH = '--------------------------------';
  function center(s){s=String(s).substring(0,W);var pad=Math.floor((W-s.length)/2);return ' '.repeat(pad)+s;}
  function padR(s,n){s=String(s);return s.length>=n?s.substring(0,n):s+' '.repeat(n-s.length);}
  function padL(s,n){s=String(s);return s.length>=n?s.substring(0,n):' '.repeat(n-s.length)+s;}
  function lr(l,r){l=String(l);r=String(r);var sp=W-l.length-r.length;if(sp<1)sp=1;return l+' '.repeat(sp)+r;}
  function fmt(n){return 'Rp '+(n||0).toLocaleString('id-ID');}
  function fmtDate(d){if(!d)return'-';try{var dt=d&&d.seconds?new Date(d.seconds*1000):new Date(String(d).replace(' ','T'));return dt.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});}catch(e){return'-';}}
  function ln(s){text(s);add([0x0A]);}

  add([0x1B,0x40]);

  ln(center((store.name||'Toko').substring(0,W)));
  if(store.address){ var words=(store.address||'').split(' '); var line=''; words.forEach(function(w){ if((line+' '+w).trim().length>W){ln(center(line.trim()));line=w;}else{line=(line+' '+w).trim();} }); if(line){ln(center(line));} }
  ln('');
  ln(center(debt.type==='payable'?'INVOICE UTANG':'INVOICE PIUTANG'));
  ln(SEP);
  ln(lr('No',(debt.invoiceNo||'-')));
  ln(lr('Tgl',fmtDate(debt.createdAt)));
  if(debt.dueDate){ln(lr('Tempo',fmtDate(debt.dueDate)));}
  ln(lr(debt.type==='payable'?'Vendor':'Kepada',(debt.customerName||'-').substring(0,W-8)));
  ln(DASH);
  var items = debt.items||[];
  if(items.length>0){
    items.forEach(function(it){
      var sub=(it.qty||1)*(it.price||0);
      ln((it.name||'-').substring(0,W));
      ln('  '+(it.qty||1)+' x '+fmt(it.price));
      ln(lr('',fmt(sub)));
    });
  } else {
    ln((debt.description||'-').substring(0,W));
  }
  ln(DASH);
  ln(lr('Total',fmt(debt.amount)));
  ln(lr('Dibayar',fmt(debt.paid||0)));
  ln(SEP);
  ln(lr('SISA BAYAR',fmt(debt.remaining)));
  ln(SEP);
  var st=debt.status==='paid'?'** LUNAS **':debt.status==='partial'?'~ DICICIL ~':'! BELUM BAYAR !';
  ln(center(st));
  ln('');
  ln(center('iFix Pro'));
  ln('');ln('');ln('');ln('');

  var total=0; parts.forEach(function(p){total+=p.length;});
  var buf=new Uint8Array(total); var off=0;
  parts.forEach(function(p){buf.set(p,off);off+=p.length;});
  return buf;
}

async function doCetakBluetooth() {
  if(!navigator.bluetooth){setStatus('Web Bluetooth tidak didukung browser ini','#dc2626');return;}
  setBusy(true);
  setStatus('Mencari printer...','#2563eb');
  try {
    var device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [
        '000018f0-0000-1000-8000-00805f9b34fb',
        'e7810a71-73ae-499d-8c15-faa9aef0c3f2',
        '0000ff00-0000-1000-8000-00805f9b34fb',
        '49535343-fe7d-4ae5-8fa9-9fafd205e455',
        '0000ff01-0000-1000-8000-00805f9b34fb',
        '0000ff02-0000-1000-8000-00805f9b34fb',
        'bef8d6c9-9c21-4c9e-b632-bd58c1009f9f',
      ]
    });
    setStatus('Connecting ke '+device.name+'...','#2563eb');
    var server = await device.gatt.connect();
    var svcs = await server.getPrimaryServices();
    var writeCh = null;
    for(var i=0;i<svcs.length;i++){
      try {
        var chars = await svcs[i].getCharacteristics();
        for(var j=0;j<chars.length;j++){
          if(chars[j].properties.writeWithoutResponse||chars[j].properties.write){
            writeCh=chars[j]; break;
          }
        }
        if(writeCh) break;
      } catch(e){}
    }
    if(!writeCh){setStatus('‚ùå Characteristic tidak ditemukan. Printer tidak support BLE?','#dc2626');setBusy(false);return;}
    setStatus('Mencetak...','#16a34a');
    var data = await buildEscPos(_debt, _store);
    var chunk=100;
    for(var k=0;k<data.length;k+=chunk){
      var slice=data.slice(k,k+chunk);
      if(writeCh.properties.writeWithoutResponse) await writeCh.writeValueWithoutResponse(slice);
      else await writeCh.writeValue(slice);
      await new Promise(function(r){setTimeout(r,30);});
    }
    setStatus('‚úÖ Berhasil dicetak!','#16a34a');
  } catch(e) {
    if(e.name==='NotFoundError'){setStatus('Dibatalkan','#94a3b8');}
    else{setStatus('‚ùå Error: '+e.message,'#dc2626');}
  }
  setBusy(false);
}
<\/script>`;
            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
            <meta name="viewport" content="width=device-width,initial-scale=1">
            <title>Invoice ${debt.invoiceNo||''}</title>
            <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"><\/script>
            <style>
              *{box-sizing:border-box;margin:0;padding:0;}
              html,body{height:auto!important;min-height:0!important;overflow:visible;}
              body{font-family:-apple-system,system-ui,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#1e293b;background:#fff;width:100%;padding:0 0 100px;margin:0;}
              .no-print{display:block;}
              @media print{.no-print{display:none!important;}html,body{padding:0!important;margin:0!important;}}
            </style></head>
            <body>
              <div style="background:linear-gradient(135deg,${color},${colorDark});padding:24px 20px;color:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact;">
                <div style="font-size:12px;font-weight:700;opacity:.6;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;">iFix Pro</div>
                <div style="font-size:24px;font-weight:800;margin-bottom:3px;">${storeInfo?.name||ownerInfo?.name||'Toko'}</div>
                ${storeInfo?.address?`<div style="font-size:13px;opacity:.8;">${storeInfo.address}</div>`:''}
                <div style="display:inline-block;margin-top:10px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);padding:5px 14px;border-radius:20px;font-size:13px;font-weight:700;">${isPayable?'üî¥':'üü¢'} ${label}</div>
              </div>
              <div style="padding:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:2px dashed #e2e8f0;padding-bottom:14px;margin-bottom:16px;">
                  <span style="font-size:12px;font-weight:700;color:#94a3b8;letter-spacing:1px;text-transform:uppercase;">NO. INVOICE</span>
                  <span style="font-size:14px;font-weight:700;color:${color};background:${colorBg};padding:5px 12px;border-radius:8px;border:1px solid ${colorBorder};">${debt.invoiceNo||'-'}</span>
                </div>
                <div style="display:flex;gap:10px;margin-bottom:10px;">
                  <div style="flex:1;background:#f8fafc;border-radius:12px;padding:12px;">
                    <div style="font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;margin-bottom:3px;">Tanggal</div>
                    <div style="font-size:15px;font-weight:700;">${fmtDate(debt.createdAt)}</div>
                  </div>
                  <div style="flex:1;background:#f8fafc;border-radius:12px;padding:12px;">
                    <div style="font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;margin-bottom:3px;">Jatuh Tempo</div>
                    <div style="font-size:15px;font-weight:700;${debt.dueDate?'color:#dc2626;':''}">${fmtDate(debt.dueDate)}</div>
                  </div>
                </div>
                <div style="background:#f8fafc;border-radius:12px;padding:12px;margin-bottom:16px;">
                  <div style="font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;margin-bottom:3px;">${isPayable?'Supplier / Vendor':'Nama Pelanggan'}</div>
                  <div style="font-size:17px;font-weight:700;">${debt.customerName||'-'}</div>
                </div>
                <div style="font-size:12px;font-weight:700;color:#94a3b8;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">${hasItems?'DETAIL ITEM':'KETERANGAN'}</div>
                <div>${itemRows}</div>
                <div style="background:#f8fafc;border-radius:14px;padding:16px;margin-top:16px;">
                  <div style="display:flex;justify-content:space-between;padding:6px 0;"><span style="font-size:15px;color:#64748b;">Total</span><span style="font-size:15px;font-weight:700;">${fmt(debt.amount)}</span></div>
                  <div style="display:flex;justify-content:space-between;padding:6px 0;"><span style="font-size:15px;color:#64748b;">Sudah Dibayar</span><span style="font-size:15px;font-weight:700;color:#16a34a;">- ${fmt(debt.paid||0)}</span></div>
                  <hr style="border:none;border-top:2px dashed #cbd5e1;margin:10px 0;">
                  <div style="display:flex;justify-content:space-between;padding:8px 0 0;"><span style="font-size:18px;font-weight:800;">Sisa</span><span style="font-size:22px;font-weight:800;color:${color};">${fmt(debt.remaining)}</span></div>
                </div>
                ${debt.description&&hasItems?`<div style="margin-top:12px;background:#fefce8;border:1px solid #fde68a;border-radius:10px;padding:10px 14px;font-size:14px;color:#78350f;"><b>üìù Catatan:</b> ${debt.description}</div>`:''}
                <div style="text-align:center;margin-top:16px;">
                  <span style="display:inline-block;padding:8px 24px;border-radius:30px;font-size:16px;font-weight:700;background:${statusBg};color:${statusColor};">${statusLabel}</span>
                </div>
                <div style="text-align:center;font-size:12px;color:#94a3b8;margin-top:14px;">Diterbitkan oleh sistem iFix Pro</div>
              </div>
              <div class="no-print" style="position:fixed;bottom:0;left:0;right:0;padding:10px 16px;background:rgba(255,255,255,.97);border-top:1px solid #e2e8f0;box-shadow:0 -4px 16px rgba(0,0,0,.08);">
                <div id="bt-status" style="text-align:center;font-size:13px;min-height:18px;margin-bottom:8px;font-weight:600;"></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button id="wa-btn" onclick="doShareWA()" style="flex:1;min-width:120px;background:linear-gradient(135deg,#25D366,#128C7E);color:#fff;border:none;padding:14px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;">üì§ Share WA</button>
                  <button id="bt-btn" onclick="doCetakBluetooth()" style="flex:1;min-width:120px;background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;padding:14px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;">üì∂ Bluetooth</button>
                  <button onclick="window.print()" style="flex:1;min-width:120px;background:#f1f5f9;color:#475569;border:none;padding:14px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;">üñ®Ô∏è Print</button>
                  <button onclick="window.close()" style="background:#fee2e2;color:#dc2626;border:none;padding:14px 18px;border-radius:12px;font-size:16px;cursor:pointer;font-weight:700;">‚úï</button>
                </div>
              </div>
              ${escposScript}
              <script>
async function doShareWA() {
  var waBtn = document.getElementById('wa-btn');
  if (waBtn) { waBtn.disabled = true; waBtn.textContent = '‚è≥ Memproses...'; }
  try {
    var noprint = document.querySelectorAll('.no-print');
    noprint.forEach(function(el){ el.style.display='none'; });
    var canvas = await html2canvas(document.body, { useCORS:true, scale:2, backgroundColor:'#ffffff' });
    noprint.forEach(function(el){ el.style.display='block'; });
    canvas.toBlob(function(blob) {
      if (!blob) { alert('Gagal membuat gambar invoice.'); return; }
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'invoice_${debt.invoiceNo||'utang'}.png';
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        var phone = (_debt.customerPhone||'').replace(/\D/g,'');
        if (phone && phone[0]==='0') phone = '62'+phone.slice(1);
        var nama = _debt.customerName||'Pelanggan';
        var tgl = _debt.dueDate ? new Date(_debt.dueDate).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}) : '-';
        var status = _debt.status==='paid'?'LUNAS':_debt.status==='partial'?'DICICIL':'BELUM BAYAR';
        var jumlah = 'Rp '+(_debt.amount||0).toLocaleString('id-ID');
        var terbayar = 'Rp '+(_debt.paidAmount||0).toLocaleString('id-ID');
        var sisa = 'Rp '+((_debt.amount||0)-(_debt.paidAmount||0)).toLocaleString('id-ID');
        var msg = 'Halo '+nama+', berikut invoice Anda:%0A%0A';
        msg += 'üìÑ No: '+(_debt.invoiceNo||'-')+'%0A';
        msg += 'üìÖ Jatuh Tempo: '+tgl+'%0A';
        msg += 'üí∞ Total: '+jumlah+'%0A';
        msg += '‚úÖ Terbayar: '+terbayar+'%0A';
        msg += '‚è≥ Sisa: '+sisa+'%0A';
        msg += 'üîñ Status: '+status+'%0A%0A';
        msg += 'Gambar invoice telah terunduh, silakan lampirkan ke chat ini. Terima kasih üôè';
        var waUrl = phone ? 'https://wa.me/'+phone+'?text='+msg : 'https://wa.me/?text='+msg;
        window.open(waUrl, '_blank');
      }, 500);
    }, 'image/png');
  } catch(e) {
    alert('Gagal share: '+e.message);
    var noprint2 = document.querySelectorAll('.no-print');
    noprint2.forEach(function(el){ el.style.display='block'; });
  } finally {
    if (waBtn) { waBtn.disabled = false; waBtn.textContent = 'üì§ Share WA'; }
  }
}
<\/script>
            </body></html>`;
            const w = window.open('','_blank');
            if (w) { w.document.write(html); w.document.close(); }
        };

        const PayableManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [payables, setPayables] = useState([]);
            const [modal, setModal] = useState(false);
            const [paymentModal, setPaymentModal] = useState(null);
            const [form, setForm] = useState({ customerName: '', amount: 0, description: '', dueDate: '', useItems: false });
            const [formItems, setFormItems] = useState([{ name: '', qty: 1, price: 0 }]);
            const [paymentAmount, setPaymentAmount] = useState(0);
            const [payableCashAccount, setPayableCashAccount] = useState('Kas Tunai');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const debtsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'debts');
                let q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('type', '==', 'payable'), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), where('type', '==', 'payable'), orderBy('createdAt', 'desc'));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setPayables(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            const addPayable = async (e) => {
                e.preventDefault();
                try {
                    const now = new Date();
                    const pad = (n,l=2) => String(n).padStart(l,'0');
                    const dateStr = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}`;
                    const rand = pad(Math.floor(Math.random()*9000)+1000, 4);
                    const invoiceNo = `UTG-${dateStr}-${rand}`;
                    let totalAmount;
                    let savedItems = [];
                    if (form.useItems) {
                        savedItems = formItems.filter(it => it.name.trim());
                        totalAmount = savedItems.reduce((s, it) => s + (it.qty||1)*(it.price||0), 0);
                    } else {
                        totalAmount = parseNumberFromInput(form.amount.toString());
                    }
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'payable',
                        invoiceNo,
                        customerName: form.customerName,
                        amount: totalAmount,
                        paid: 0,
                        remaining: totalAmount,
                        description: form.description,
                        items: savedItems,
                        dueDate: form.dueDate ? new Date(Date.now()+Number(form.dueDate)*86400000).toISOString().split('T')[0] : '',
                        status: 'unpaid',
                        createdAt: serverTimestamp()
                    });
                    alert(`‚úÖ Data utang berhasil ditambahkan!\nNo. Invoice: ${invoiceNo}`);
                    setModal(false);
                    setForm({ customerName: '', amount: 0, description: '', dueDate: '', useItems: false });
                    setFormItems([{ name: '', qty: 1, price: 0 }]);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const recordPayment = async (debt) => {
                if (paymentAmount <= 0 || paymentAmount > debt.remaining) {
                    alert('Jumlah pembayaran tidak valid!');
                    return;
                }
                try {
                    const newPaid = debt.paid + paymentAmount;
                    const newRemaining = debt.amount - newPaid;
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'debts', debt.id), {
                        paid: newPaid,
                        remaining: newRemaining,
                        status: newRemaining === 0 ? 'paid' : 'partial'
                    });

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'expense',
                        category: 'Pembayaran Utang',
                        description: `${debt.customerName} - ${debt.description}`,
                        amount: paymentAmount,
                        cashAccount: payableCashAccount,
                        date: serverTimestamp()
                    });

                    alert('‚úÖ Pembayaran berhasil dicatat!');
                    setPaymentModal(null);
                    setPaymentAmount(0);
                    setPayableCashAccount('Kas Tunai');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = payables.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedPayables = payables.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">ÔøΩ Utang (Yang Harus Kita Bayar)</h2>
                        <button onClick={() => setModal(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Utang
                        </button>
                    </div>

                    <div className="bg-red-50 border border-red-200 rounded-xl p-6">
                        <h3 className="text-red-700 font-bold mb-2">Total Utang</h3>
                        <div className="text-4xl font-bold text-red-600 mb-2">
                            {formatCurrency(payables.reduce((sum, d) => sum + d.remaining, 0))}
                        </div>
                        <div className="text-sm text-red-600">{payables.filter(d => d.status !== 'paid').length} transaksi belum lunas</div>
                    </div>

                    {/* Mobile: Card View */}
                    <div className="md:hidden space-y-3">
                        {paginatedPayables.map(d => (
                            <div key={d.id} className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                                <div className="flex items-start justify-between mb-2">
                                    <div>
                                        <div className="font-bold text-sm text-gray-800">{d.customerName}</div>
                                        <div className="text-xs font-mono text-red-600 bg-red-50 px-1.5 py-0.5 rounded mt-0.5 inline-block">{d.invoiceNo||'-'}</div>
                                    </div>
                                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${d.status==='paid'?'bg-green-100 text-green-700':d.status==='partial'?'bg-yellow-100 text-yellow-700':'bg-gray-100 text-gray-600'}`}>
                                        {d.status==='paid'?'‚úÖ Lunas':d.status==='partial'?'‚è≥ Dicicil':'‚ùå Belum'}
                                    </span>
                                </div>
                                <div className="text-xs text-gray-400 mb-2">
                                    {formatDate(d.createdAt)}{d.dueDate ? ` ¬∑ Jatuh Tempo: ${formatDate(d.dueDate)}` : ''}
                                </div>
                                {d.items?.length > 0
                                    ? <div className="text-xs text-blue-600 mb-2">üì¶ {d.items.length} item</div>
                                    : d.description ? <div className="text-xs text-gray-500 mb-2 truncate">{d.description}</div> : null}
                                <div className="grid grid-cols-3 gap-1 mb-3 bg-gray-50 rounded-lg p-2">
                                    <div className="text-center">
                                        <div className="text-xs text-gray-400">Total</div>
                                        <div className="text-xs font-bold text-red-600">{formatCurrency(d.amount)}</div>
                                    </div>
                                    <div className="text-center border-x border-gray-200">
                                        <div className="text-xs text-gray-400">Dibayar</div>
                                        <div className="text-xs font-bold text-blue-600">{formatCurrency(d.paid)}</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-xs text-gray-400">Sisa</div>
                                        <div className="text-xs font-bold text-orange-600">{formatCurrency(d.remaining)}</div>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => printDebtInvoice(d, activeStore, activeOwner)} className="flex-1 text-center text-xs font-bold py-1.5 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">üßæ Invoice</button>
                                    {d.status !== 'paid' && (
                                        <button onClick={() => { setPaymentModal(d); setPaymentAmount(d.remaining); }} className="flex-1 text-center text-xs font-bold py-1.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700">üí∞ Bayar</button>
                                    )}
                                </div>
                            </div>
                        ))}
                        {payables.length === 0 && <div className="p-8 text-center text-gray-400 bg-white rounded-xl border">Belum ada data utang</div>}
                    </div>
                    {/* Desktop: Table View */}
                    <div className="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">No. Invoice</th>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Supplier/Vendor</th>
                                    <th className="p-3 text-left">Keterangan</th>
                                    <th className="p-3 text-right">Total</th>
                                    <th className="p-3 text-right">Dibayar</th>
                                    <th className="p-3 text-right">Sisa</th>
                                    <th className="p-3 text-center">Status</th>
                                    <th className="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedPayables.map(d => (
                                    <tr key={d.id} className="hover:bg-gray-50">
                                        <td className="p-3"><span className="text-xs font-mono bg-red-50 text-red-700 px-2 py-0.5 rounded border border-red-100">{d.invoiceNo||'-'}</span></td>
                                        <td className="p-3 text-gray-500 whitespace-nowrap">{formatDate(d.createdAt)}</td>
                                        <td className="p-3 font-medium">{d.customerName}</td>
                                        <td className="p-3 text-xs text-gray-500 max-w-[160px] truncate" title={d.description}>{d.items?.length>0?<span className="text-blue-600">üì¶ {d.items.length} item</span>:d.description||'-'}</td>
                                        <td className="p-3 text-right font-bold text-red-600">{formatCurrency(d.amount)}</td>
                                        <td className="p-3 text-right text-blue-600">{formatCurrency(d.paid)}</td>
                                        <td className="p-3 text-right font-bold text-orange-600">{formatCurrency(d.remaining)}</td>
                                        <td className="p-3 text-center"><span className={`px-2 py-1 rounded text-xs font-bold ${d.status==='paid'?'bg-green-100 text-green-700':d.status==='partial'?'bg-yellow-100 text-yellow-700':'bg-gray-100 text-gray-700'}`}>{d.status==='paid'?'‚úÖ Lunas':d.status==='partial'?'‚è≥ Dicicil':'‚ùå Belum Bayar'}</span></td>
                                        <td className="p-3 text-center">
                                            <div className="flex items-center justify-center gap-1">
                                                <button onClick={() => printDebtInvoice(d, activeStore, activeOwner)} className="text-slate-600 hover:bg-slate-100 px-2 py-1 rounded text-xs font-bold">üßæ Invoice</button>
                                                {d.status !== 'paid' && <button onClick={() => { setPaymentModal(d); setPaymentAmount(d.remaining); }} className="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold">üí∞ Bayar</button>}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {payables.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data utang</div>}
                    </div>

                    {payables.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-xl mb-4 text-red-600">üì§ Tambah Data Utang</h3>
                                <form onSubmit={addPayable} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Supplier / Vendor</label>
                                        <input value={form.customerName} onChange={e => setForm({ ...form, customerName: e.target.value })} className="w-full border p-2 rounded" required />
                                    </div>

                                    {/* Toggle: manual amount vs item list */}
                                    <div className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border">
                                        <label className="flex items-center gap-2 cursor-pointer select-none">
                                            <input type="checkbox" checked={form.useItems} onChange={e => setForm({...form, useItems: e.target.checked})} className="w-4 h-4 accent-red-600"/>
                                            <span className="text-sm font-bold text-slate-700">Input Detail Barang / Jasa</span>
                                        </label>
                                        <span className="text-xs text-slate-400">(agar muncul di invoice)</span>
                                    </div>

                                    {form.useItems ? (
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 mb-2 block">Daftar Barang / Jasa</label>
                                            <div className="space-y-2">
                                                {formItems.map((it, idx) => (
                                                    <div key={idx} className="flex gap-2 items-start">
                                                        <input placeholder="Nama barang/jasa" value={it.name} onChange={e => { const n=[...formItems]; n[idx]={...n[idx],name:e.target.value}; setFormItems(n); }} className="flex-1 border p-2 rounded text-sm" />
                                                        <input type="number" placeholder="Qty" value={it.qty} min="1" onChange={e => { const n=[...formItems]; n[idx]={...n[idx],qty:Number(e.target.value)}; setFormItems(n); }} className="w-16 border p-2 rounded text-sm text-center" />
                                                        <NumberInput value={it.price} onChange={val => { const n=[...formItems]; n[idx]={...n[idx],price:val}; setFormItems(n); }} className="w-36 border p-2 rounded text-sm" placeholder="Harga" />
                                                        <button type="button" onClick={() => setFormItems(formItems.filter((_,i)=>i!==idx))} className="text-red-400 hover:text-red-600 px-1 text-lg font-bold">‚úï</button>
                                                    </div>
                                                ))}
                                            </div>
                                            <button type="button" onClick={() => setFormItems([...formItems, {name:'',qty:1,price:0}])} className="mt-2 text-sm text-red-600 hover:text-red-700 font-bold flex items-center gap-1">+ Tambah item</button>
                                            <div className="mt-3 text-right text-sm font-bold text-red-600">
                                                Total: {formatCurrency(formItems.reduce((s,it)=>s+(it.qty||1)*(it.price||0),0))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                            <NumberInput value={form.amount} onChange={val => setForm({ ...form, amount: val })} className="w-full border p-2 rounded font-bold" required />
                                        </div>
                                    )}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Catatan / Keterangan</label>
                                        <textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jatuh Tempo (Opsional)</label>
                                        <div className="flex items-center gap-2 mt-1">
                                            <input type="number" min="1" max="365" placeholder="cth: 30" value={form.dueDate} onChange={e => setForm({ ...form, dueDate: e.target.value })} className="w-full border p-2 rounded" />
                                            <span className="text-xs text-slate-500 whitespace-nowrap">hari</span>
                                        </div>
                                        {form.dueDate > 0 && <p className="text-xs text-slate-400 mt-1">Jatuh tempo: {new Date(Date.now()+Number(form.dueDate)*86400000).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}</p>}
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => { setModal(false); setFormItems([{name:'',qty:1,price:0}]); setForm({customerName:'',amount:0,description:'',dueDate:'',useItems:false}); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-red-600 text-white p-2 rounded font-bold">Simpan & Generate Invoice</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {paymentModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">Catat Pembayaran</h3>
                                <div className="space-y-4">
                                    <div className="bg-gray-50 p-3 rounded">
                                        <div className="text-xs text-gray-500">Nama</div>
                                        <div className="font-bold">{paymentModal.customerName}</div>
                                        <div className="text-xs text-gray-500 mt-2">Sisa</div>
                                        <div className="text-2xl font-bold text-orange-600">{formatCurrency(paymentModal.remaining)}</div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah Bayar</label>
                                        <NumberInput value={paymentAmount} onChange={val => setPaymentAmount(val)} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <CashAccountSelect value={payableCashAccount} onChange={setPayableCashAccount} />
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => { setPaymentModal(null); setPaymentAmount(0); setPayableCashAccount('Kas Tunai'); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button onClick={() => recordPayment(paymentModal)} className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Bayar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // ÔøΩ RECEIVABLE MANAGER (Piutang - Yang Harus Dibayar ke Kita)
        // ==========================================
        const ReceivableManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [receivables, setReceivables] = useState([]);
            const [modal, setModal] = useState(false);
            const [paymentModal, setPaymentModal] = useState(null);
            const [form, setForm] = useState({ customerName: '', customerPhone: '', amount: 0, description: '', dueDate: '', useItems: false });
            const [formItems, setFormItems] = useState([{ name: '', qty: 1, price: 0 }]);
            const [paymentAmount, setPaymentAmount] = useState(0);
            const [paymentDueDate, setPaymentDueDate] = useState('');
            const [receivableCashAccount, setReceivableCashAccount] = useState('Kas Tunai');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            const [editModal, setEditModal] = useState(null);
            const [editForm, setEditForm] = useState({ customerName: '', customerPhone: '', description: '', dueDate: '', amount: 0, useItems: false });
            const [editFormItems, setEditFormItems] = useState([{ name: '', qty: 1, price: 0 }]);

            const fetchReceivables = React.useCallback(async () => {
                if (!activeOwner?.id) { setReceivables([]); return; }
                try {
                    let filter = `ownerId = "${activeOwner.id}" && type = "receivable"`;
                    if (activeStore?.id && activeStore.id !== 'all') filter += ` && storeId = "${activeStore.id}"`;
                    const records = await pb.collection('debts').getFullList({ filter, sort: '-created' });
                    setReceivables(records.map(r => ({
                        ...r,
                        createdAt: r.createdAt || r.created,
                        items: typeof r.items === 'string' ? (() => { try { return JSON.parse(r.items); } catch(e) { return []; } })() : (r.items || []),
                    })));
                } catch(err) {
                    console.error('fetchReceivables:', err);
                    setReceivables([]);
                }
            }, [activeOwner?.id, activeStore?.id]);

            useEffect(() => {
                fetchReceivables();
                const unsub = _subscribeCollection('debts', () => fetchReceivables());
                return unsub;
            }, [fetchReceivables]);

            const addReceivable = async (e) => {
                e.preventDefault();
                try {
                    const now = new Date();
                    const pad = (n,l=2) => String(n).padStart(l,'0');
                    const dateStr = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}`;
                    const rand = pad(Math.floor(Math.random()*9000)+1000, 4);
                    const invoiceNo = `PIU-${dateStr}-${rand}`;
                    let totalAmount;
                    let savedItems = [];
                    if (form.useItems) {
                        savedItems = formItems.filter(it => it.name.trim());
                        totalAmount = savedItems.reduce((s, it) => s + (it.qty||1)*(it.price||0), 0);
                    } else {
                        totalAmount = parseNumberFromInput(form.amount.toString());
                    }
                    await pb.collection('debts').create({
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'receivable',
                        invoiceNo,
                        customerName: form.customerName,
                        customerPhone: form.customerPhone || '',
                        amount: totalAmount,
                        paid: 0,
                        remaining: totalAmount,
                        description: form.description || '',
                        items: savedItems,
                        dueDate: form.dueDate ? new Date(Date.now()+Number(form.dueDate)*86400000).toISOString().split('T')[0] : '',
                        status: 'unpaid',
                    });
                    alert(`‚úÖ Data piutang berhasil ditambahkan!\nNo. Invoice: ${invoiceNo}`);
                    setModal(false);
                    setForm({ customerName: '', customerPhone: '', amount: 0, description: '', dueDate: '', useItems: false });
                    setFormItems([{ name: '', qty: 1, price: 0 }]);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const recordPayment = async (debt) => {
                if (paymentAmount <= 0 || paymentAmount > debt.remaining) {
                    alert('Jumlah pembayaran tidak valid!');
                    return;
                }
                try {
                    const newPaid = (debt.paid||0) + paymentAmount;
                    const newRemaining = (debt.amount||0) - newPaid;
                    const updateData = { paid: newPaid, remaining: newRemaining, status: newRemaining <= 0 ? 'paid' : 'partial' };
                    if (paymentDueDate) updateData.dueDate = new Date(Date.now()+Number(paymentDueDate)*86400000).toISOString().split('T')[0];
                    await pb.collection('debts').update(debt.id, updateData);
                    await pb.collection('cash_flow').create({
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'in',
                        category: 'Pembayaran Piutang',
                        description: `${debt.customerName} - ${debt.description}`,
                        amount: paymentAmount,
                        account: receivableCashAccount,
                    });

                    alert('‚úÖ Pembayaran berhasil dicatat!');
                    setPaymentModal(null);
                    setPaymentAmount(0);
                    setPaymentDueDate('');
                    setReceivableCashAccount('Kas Tunai');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const deleteReceivable = async (debt) => {
                if (!window.confirm(`Hapus piutang ${debt.customerName} (${formatCurrency(debt.amount)})?

${debt.paid > 0 ? `‚ö†Ô∏è Sudah ada pembayaran ${formatCurrency(debt.paid)} yang akan dikembalikan (dicatat sebagai pengeluaran koreksi).` : 'Belum ada pembayaran yang perlu dikembalikan.'}`)) return;
                try {
                    // Kembalikan transaksi cash flow jika sudah ada pembayaran
                    if (debt.paid > 0) {
                        await pb.collection('cash_flow').create({
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'out',
                            category: 'Koreksi - Piutang Dihapus',
                            description: `Pengembalian pembayaran piutang ${debt.customerName} (${debt.invoiceNo||'-'}) - dihapus`,
                            amount: debt.paid,
                            account: 'Kas Tunai',
                        });
                    }
                    await pb.collection('debts').delete(debt.id);
                    alert(`‚úÖ Piutang ${debt.customerName} berhasil dihapus!${debt.paid > 0 ? `\nüí∞ ${formatCurrency(debt.paid)} dicatat sebagai koreksi pengembalian.` : ''}`);
                } catch (err) {
                    alert('Error menghapus: ' + err.message);
                }
            };

            const openEditModal = (debt) => {
                const hasItems = debt.items?.length > 0;
                setEditForm({
                    customerName: debt.customerName || '',
                    customerPhone: debt.customerPhone || '',
                    description: debt.description || '',
                    dueDate: debt.dueDate ? (debt.dueDate.includes('T') ? debt.dueDate.split('T')[0] : debt.dueDate) : '',
                    amount: debt.amount || 0,
                    useItems: hasItems,
                });
                setEditFormItems(hasItems ? debt.items.map(it => ({ name: it.name||'', qty: it.qty||1, price: it.price||0 })) : [{ name:'', qty:1, price:0 }]);
                setEditModal(debt);
            };

            const saveEditReceivable = async (e) => {
                e.preventDefault();
                try {
                    let totalAmount;
                    let savedItems = [];
                    if (editForm.useItems) {
                        savedItems = editFormItems.filter(it => it.name.trim());
                        totalAmount = savedItems.reduce((s, it) => s + (it.qty||1)*(it.price||0), 0);
                    } else {
                        totalAmount = parseNumberFromInput(editForm.amount.toString());
                    }
                    const newPaid = editModal.paid || 0;
                    const newRemaining = totalAmount - newPaid;
                    const newStatus = newRemaining <= 0 ? 'paid' : newPaid > 0 ? 'partial' : 'unpaid';
                    await pb.collection('debts').update(editModal.id, {
                        customerName: editForm.customerName,
                        customerPhone: editForm.customerPhone || '',
                        description: editForm.description || '',
                        dueDate: editForm.dueDate ? new Date(Date.now()+Number(editForm.dueDate)*86400000).toISOString().split('T')[0] : '',
                        amount: totalAmount,
                        remaining: Math.max(0, newRemaining),
                        status: newStatus,
                        items: savedItems,
                    });
                    alert('‚úÖ Data piutang berhasil diperbarui!');
                    setEditModal(null);
                } catch (err) {
                    alert('Error update: ' + err.message);
                }
            };

            const totalItems = receivables.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedReceivables = receivables.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            const shareReceivableToWA = (d) => {
                const fmt = (n) => 'Rp ' + (n||0).toLocaleString('id-ID');
                const fmtDate = (dt) => {
                    if (!dt) return '-';
                    const date = dt?.toDate ? dt.toDate() : new Date(dt);
                    return date.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
                };
                let itemsText = '';
                if (d.items?.length > 0) {
                    itemsText = '\nüì¶ *Detail Item:*\n' + d.items.map(it => `  - ${it.name} x${it.qty||1} = ${fmt((it.qty||1)*(it.price||0))}`).join('\n');
                } else if (d.description) {
                    itemsText = `\nüìù Keterangan: ${d.description}`;
                }
                const statusLabel = d.status==='paid' ? '‚úÖ LUNAS' : d.status==='partial' ? '‚è≥ DICICIL' : '‚ùå BELUM BAYAR';
                const dueDateText = d.dueDate ? `\nüìÖ Jatuh Tempo: ${fmtDate(d.dueDate)}` : '';
                const msg =
                    `üßæ *INVOICE PIUTANG*\n` +
                    `No: *${d.invoiceNo||'-'}*\n` +
                    `Tgl: ${fmtDate(d.createdAt)}${dueDateText}\n` +
                    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                    `üë§ Kepada: *${d.customerName}*` +
                    itemsText + `\n` +
                    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                    `üí∞ Total  : ${fmt(d.amount)}\n` +
                    `‚úÖ Dibayar: ${fmt(d.paid)}\n` +
                    `‚ö†Ô∏è Sisa   : *${fmt(d.remaining)}*\n` +
                    `Status: ${statusLabel}\n` +
                    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                    `Mohon segera melakukan pembayaran. Terima kasih üôè`;
                const phone = d.customerPhone || '';
                let formattedPhone = phone.replace(/[\s\-\(\)]/g, '');
                if (formattedPhone.startsWith('+')) formattedPhone = formattedPhone.slice(1);
                if (formattedPhone.startsWith('0')) formattedPhone = '62' + formattedPhone.slice(1);
                if (formattedPhone && !formattedPhone.startsWith('62')) formattedPhone = '62' + formattedPhone;
                const url = formattedPhone
                    ? `https://wa.me/${formattedPhone}?text=${encodeURIComponent(msg)}`
                    : `https://wa.me/?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üì• Piutang (Yang Harus Dibayar ke Kita)</h2>
                        <button onClick={() => setModal(true)} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Piutang
                        </button>
                    </div>

                    <div className="bg-green-50 border border-green-200 rounded-xl p-6">
                        <h3 className="text-green-700 font-bold mb-2">Total Piutang</h3>
                        <div className="text-4xl font-bold text-green-600 mb-2">
                            {formatCurrency(receivables.reduce((sum, d) => sum + d.remaining, 0))}
                        </div>
                        <div className="text-sm text-green-600">{receivables.filter(d => d.status !== 'paid').length} transaksi belum lunas</div>
                    </div>

                    {/* Mobile: Card View */}
                    <div className="md:hidden space-y-3">
                        {paginatedReceivables.map(d => (
                            <div key={d.id} className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                                <div className="flex items-start justify-between mb-2">
                                    <div>
                                        <div className="font-bold text-sm text-gray-800">{d.customerName}</div>
                                        <div className="text-xs font-mono text-green-700 bg-green-50 px-1.5 py-0.5 rounded mt-0.5 inline-block">{d.invoiceNo||'-'}</div>
                                    </div>
                                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${d.status==='paid'?'bg-green-100 text-green-700':d.status==='partial'?'bg-yellow-100 text-yellow-700':'bg-gray-100 text-gray-600'}`}>
                                        {d.status==='paid'?'‚úÖ Lunas':d.status==='partial'?'‚è≥ Dicicil':'‚ùå Belum'}
                                    </span>
                                </div>
                                <div className="text-xs text-gray-400 mb-2">
                                    {formatDate(d.createdAt)}{d.dueDate ? ` ¬∑ Jatuh Tempo: ${formatDate(d.dueDate)}` : ''}
                                </div>
                                {d.items?.length > 0
                                    ? <div className="text-xs text-blue-600 mb-2">üì¶ {d.items.length} item</div>
                                    : d.description ? <div className="text-xs text-gray-500 mb-2 truncate">{d.description}</div> : null}
                                <div className="grid grid-cols-3 gap-1 mb-3 bg-gray-50 rounded-lg p-2">
                                    <div className="text-center">
                                        <div className="text-xs text-gray-400">Total</div>
                                        <div className="text-xs font-bold text-green-600">{formatCurrency(d.amount)}</div>
                                    </div>
                                    <div className="text-center border-x border-gray-200">
                                        <div className="text-xs text-gray-400">Dibayar</div>
                                        <div className="text-xs font-bold text-blue-600">{formatCurrency(d.paid)}</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-xs text-gray-400">Sisa</div>
                                        <div className="text-xs font-bold text-orange-600">{formatCurrency(d.remaining)}</div>
                                    </div>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    <button onClick={() => printDebtInvoice(d, activeStore, activeOwner)} className="flex-1 text-center text-xs font-bold py-1.5 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">üßæ Invoice</button>
                                    <button onClick={() => shareReceivableToWA(d)} className="flex-1 text-center text-xs font-bold py-1.5 rounded-lg border border-green-200 text-green-600 hover:bg-green-50">üí¨ WA</button>
                                    {d.status !== 'paid' && (
                                        <button onClick={() => { setPaymentModal(d); setPaymentAmount(d.remaining); }} className="flex-1 text-center text-xs font-bold py-1.5 rounded-lg bg-green-600 text-white hover:bg-green-700">üí∞ Terima</button>
                                    )}
                                    <button onClick={() => openEditModal(d)} className="flex-1 text-center text-xs font-bold py-1.5 rounded-lg border border-blue-200 text-blue-600 hover:bg-blue-50">‚úèÔ∏è Edit</button>
                                    <button onClick={() => deleteReceivable(d)} className="flex-1 text-center text-xs font-bold py-1.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50">üóëÔ∏è Hapus</button>
                                </div>
                            </div>
                        ))}
                        {receivables.length === 0 && <div className="p-8 text-center text-gray-400 bg-white rounded-xl border">Belum ada data piutang</div>}
                    </div>
                    {/* Desktop: Table View */}
                    <div className="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">No. Invoice</th>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Nama Pelanggan</th>
                                    <th className="p-3 text-left">Keterangan</th>
                                    <th className="p-3 text-right">Total</th>
                                    <th className="p-3 text-right">Dibayar</th>
                                    <th className="p-3 text-right">Sisa</th>
                                    <th className="p-3 text-center">Status</th>
                                    <th className="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedReceivables.map(d => (
                                    <tr key={d.id} className="hover:bg-gray-50">
                                        <td className="p-3"><span className="text-xs font-mono bg-green-50 text-green-700 px-2 py-0.5 rounded border border-green-100">{d.invoiceNo||'-'}</span></td>
                                        <td className="p-3 text-gray-500 whitespace-nowrap">{formatDate(d.createdAt)}</td>
                                        <td className="p-3 font-medium">{d.customerName}</td>
                                        <td className="p-3 text-xs text-gray-500 max-w-[160px] truncate" title={d.description}>{d.items?.length>0?<span className="text-blue-600">üì¶ {d.items.length} item</span>:d.description||'-'}</td>
                                        <td className="p-3 text-right font-bold text-green-600">{formatCurrency(d.amount)}</td>
                                        <td className="p-3 text-right text-blue-600">{formatCurrency(d.paid)}</td>
                                        <td className="p-3 text-right font-bold text-orange-600">{formatCurrency(d.remaining)}</td>
                                        <td className="p-3 text-center"><span className={`px-2 py-1 rounded text-xs font-bold ${d.status==='paid'?'bg-green-100 text-green-700':d.status==='partial'?'bg-yellow-100 text-yellow-700':'bg-gray-100 text-gray-700'}`}>{d.status==='paid'?'‚úÖ Lunas':d.status==='partial'?'‚è≥ Dicicil':'‚ùå Belum Bayar'}</span></td>
                                        <td className="p-3 text-center">
                                            <div className="flex items-center justify-center gap-1">
                                                <button onClick={() => printDebtInvoice(d, activeStore, activeOwner)} className="text-slate-600 hover:bg-slate-100 px-2 py-1 rounded text-xs font-bold">üßæ Invoice</button>
                                                <button onClick={() => shareReceivableToWA(d)} className="text-green-600 hover:bg-green-50 px-2 py-1 rounded text-xs font-bold">üí¨ WA</button>
                                                {d.status !== 'paid' && <button onClick={() => { setPaymentModal(d); setPaymentAmount(d.remaining); }} className="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold">üí∞ Terima Bayar</button>}
                                                <button onClick={() => openEditModal(d)} className="text-blue-500 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold border border-blue-100">‚úèÔ∏è Edit</button>
                                                <button onClick={() => deleteReceivable(d)} className="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-xs font-bold border border-red-100">üóëÔ∏è Hapus</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {receivables.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data piutang</div>}
                    </div>

                    {receivables.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-xl mb-4 text-green-600">üì• Tambah Data Piutang</h3>
                                <form onSubmit={addReceivable} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Pelanggan</label>
                                        <input value={form.customerName} onChange={e => setForm({ ...form, customerName: e.target.value })} className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">No. HP / WhatsApp <span className="text-slate-400 font-normal">(opsional, untuk kirim WA langsung)</span></label>
                                        <input value={form.customerPhone} onChange={e => setForm({ ...form, customerPhone: e.target.value })} className="w-full border p-2 rounded" placeholder="Contoh: 08123456789" />
                                    </div>
                                    <div className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border">
                                        <label className="flex items-center gap-2 cursor-pointer select-none">
                                            <input type="checkbox" checked={form.useItems} onChange={e => setForm({...form, useItems: e.target.checked})} className="w-4 h-4 accent-green-600"/>
                                            <span className="text-sm font-bold text-slate-700">Input Detail Barang / Jasa</span>
                                        </label>
                                        <span className="text-xs text-slate-400">(agar muncul di invoice)</span>
                                    </div>

                                    {form.useItems ? (
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 mb-2 block">Daftar Barang / Jasa</label>
                                            <div className="space-y-2">
                                                {formItems.map((it, idx) => (
                                                    <div key={idx} className="flex gap-2 items-start">
                                                        <input placeholder="Nama barang/jasa" value={it.name} onChange={e => { const n=[...formItems]; n[idx]={...n[idx],name:e.target.value}; setFormItems(n); }} className="flex-1 border p-2 rounded text-sm" />
                                                        <input type="number" placeholder="Qty" value={it.qty} min="1" onChange={e => { const n=[...formItems]; n[idx]={...n[idx],qty:Number(e.target.value)}; setFormItems(n); }} className="w-16 border p-2 rounded text-sm text-center" />
                                                        <NumberInput value={it.price} onChange={val => { const n=[...formItems]; n[idx]={...n[idx],price:val}; setFormItems(n); }} className="w-36 border p-2 rounded text-sm" placeholder="Harga" />
                                                        <button type="button" onClick={() => setFormItems(formItems.filter((_,i)=>i!==idx))} className="text-red-400 hover:text-red-600 px-1 text-lg font-bold">‚úï</button>
                                                    </div>
                                                ))}
                                            </div>
                                            <button type="button" onClick={() => setFormItems([...formItems, {name:'',qty:1,price:0}])} className="mt-2 text-sm text-green-600 hover:text-green-700 font-bold flex items-center gap-1">+ Tambah item</button>
                                            <div className="mt-3 text-right text-sm font-bold text-green-600">
                                                Total: {formatCurrency(formItems.reduce((s,it)=>s+(it.qty||1)*(it.price||0),0))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                            <NumberInput value={form.amount} onChange={val => setForm({ ...form, amount: val })} className="w-full border p-2 rounded font-bold" required />
                                        </div>
                                    )}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Catatan / Keterangan</label>
                                        <textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jatuh Tempo (Opsional)</label>
                                        <div className="flex items-center gap-2 mt-1">
                                            <input type="number" min="1" max="365" placeholder="cth: 30" value={form.dueDate} onChange={e => setForm({ ...form, dueDate: e.target.value })} className="w-full border p-2 rounded" />
                                            <span className="text-xs text-slate-500 whitespace-nowrap">hari</span>
                                        </div>
                                        {form.dueDate > 0 && <p className="text-xs text-slate-400 mt-1">Jatuh tempo: {new Date(Date.now()+Number(form.dueDate)*86400000).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}</p>}
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => { setModal(false); setFormItems([{name:'',qty:1,price:0}]); setForm({customerName:'',amount:0,description:'',dueDate:'',useItems:false}); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-green-600 text-white p-2 rounded font-bold">Simpan & Generate Invoice</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {editModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-xl mb-4 text-blue-600">‚úèÔ∏è Edit Piutang</h3>
                                <form onSubmit={saveEditReceivable} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Pelanggan</label>
                                        <input value={editForm.customerName} onChange={e => setEditForm({...editForm, customerName: e.target.value})} className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">No. HP / WhatsApp <span className="text-slate-400 font-normal">(opsional)</span></label>
                                        <input value={editForm.customerPhone} onChange={e => setEditForm({...editForm, customerPhone: e.target.value})} className="w-full border p-2 rounded" placeholder="Contoh: 08123456789" />
                                    </div>
                                    <div className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border">
                                        <label className="flex items-center gap-2 cursor-pointer select-none">
                                            <input type="checkbox" checked={editForm.useItems} onChange={e => setEditForm({...editForm, useItems: e.target.checked})} className="w-4 h-4 accent-blue-600"/>
                                            <span className="text-sm font-bold text-slate-700">Input Detail Barang / Jasa</span>
                                        </label>
                                    </div>
                                    {editForm.useItems ? (
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 mb-2 block">Daftar Barang / Jasa</label>
                                            <div className="space-y-2">
                                                {editFormItems.map((it, idx) => (
                                                    <div key={idx} className="flex gap-2 items-start">
                                                        <input placeholder="Nama barang/jasa" value={it.name} onChange={e => { const n=[...editFormItems]; n[idx]={...n[idx],name:e.target.value}; setEditFormItems(n); }} className="flex-1 border p-2 rounded text-sm" />
                                                        <input type="number" placeholder="Qty" value={it.qty} min="1" onChange={e => { const n=[...editFormItems]; n[idx]={...n[idx],qty:Number(e.target.value)}; setEditFormItems(n); }} className="w-16 border p-2 rounded text-sm text-center" />
                                                        <NumberInput value={it.price} onChange={val => { const n=[...editFormItems]; n[idx]={...n[idx],price:val}; setEditFormItems(n); }} className="w-36 border p-2 rounded text-sm" placeholder="Harga" />
                                                        <button type="button" onClick={() => setEditFormItems(editFormItems.filter((_,i)=>i!==idx))} className="text-red-400 hover:text-red-600 px-1 text-lg font-bold">‚úï</button>
                                                    </div>
                                                ))}
                                            </div>
                                            <button type="button" onClick={() => setEditFormItems([...editFormItems, {name:'',qty:1,price:0}])} className="mt-2 text-sm text-blue-600 hover:text-blue-700 font-bold flex items-center gap-1">+ Tambah item</button>
                                            <div className="mt-3 text-right text-sm font-bold text-blue-600">
                                                Total: {formatCurrency(editFormItems.reduce((s,it)=>s+(it.qty||1)*(it.price||0),0))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <label className="text-xs font-bold text-slate-500">Jumlah Total</label>
                                            <NumberInput value={editForm.amount} onChange={val => setEditForm({...editForm, amount: val})} className="w-full border p-2 rounded font-bold" required />
                                            {editModal.paid > 0 && <p className="text-xs text-orange-500 mt-1">‚ö†Ô∏è Sudah dibayar {formatCurrency(editModal.paid)}, sisa akan dihitung otomatis.</p>}
                                        </div>
                                    )}
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Catatan / Keterangan</label>
                                        <textarea value={editForm.description} onChange={e => setEditForm({...editForm, description: e.target.value})} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jatuh Tempo (Opsional)</label>
                                        <div className="flex items-center gap-2 mt-1">
                                            <input type="number" min="1" max="365" placeholder="cth: 30" value={editForm.dueDate} onChange={e => setEditForm({...editForm, dueDate: e.target.value})} className="w-full border p-2 rounded" />
                                            <span className="text-xs text-slate-500 whitespace-nowrap">hari</span>
                                        </div>
                                        {editForm.dueDate > 0 && <p className="text-xs text-slate-400 mt-1">Jatuh tempo: {new Date(Date.now()+Number(editForm.dueDate)*86400000).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}</p>}
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setEditModal(null)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">üíæ Simpan Perubahan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {paymentModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-xl mb-4">Catat Pembayaran</h3>
                                <div className="space-y-4">
                                    <div className="bg-gray-50 p-3 rounded">
                                        <div className="text-xs text-gray-500">Nama</div>
                                        <div className="font-bold">{paymentModal.customerName}</div>
                                        <div className="text-xs text-gray-500 mt-2">Sisa</div>
                                        <div className="text-2xl font-bold text-orange-600">{formatCurrency(paymentModal.remaining)}</div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah Diterima</label>
                                        <NumberInput value={paymentAmount} onChange={val => setPaymentAmount(val)} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <CashAccountSelect value={receivableCashAccount} onChange={setReceivableCashAccount} />
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Jatuh Tempo Berikutnya <span className="text-slate-400 font-normal normal-case">(opsional)</span></label>
                                        <div className="flex items-center gap-2">
                                            <input type="number" min="1" max="365" placeholder="cth: 30" value={paymentDueDate} onChange={e => setPaymentDueDate(e.target.value)} className="w-full border border-slate-300 p-2.5 rounded-lg text-slate-700" />
                                            <span className="text-sm text-slate-500 whitespace-nowrap">hari</span>
                                        </div>
                                        {paymentDueDate > 0 && <p className="text-xs text-slate-400 mt-1">Jatuh tempo: {new Date(Date.now()+Number(paymentDueDate)*86400000).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}</p>}
                                        {paymentModal.dueDate && (
                                            <p className="text-xs text-slate-400 mt-1">Jatuh tempo saat ini: {(() => { const d = paymentModal.dueDate?.toDate ? paymentModal.dueDate.toDate() : new Date(paymentModal.dueDate); return d.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}); })()}</p>
                                        )}
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => { setPaymentModal(null); setPaymentAmount(0); setPaymentDueDate(''); setReceivableCashAccount('Kas Tunai'); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button onClick={() => recordPayment(paymentModal)} className="flex-1 bg-green-600 text-white p-2 rounded font-bold">Terima</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üíµ CASH MANAGER (Uang Kas)
        // ==========================================
        const CashManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [cashFlow, setCashFlow] = useState([]);
            const [cashAccounts, setCashAccounts] = useState([]);
            const [modal, setModal] = useState(false);
            const [accountModal, setAccountModal] = useState(false);
            const [form, setForm] = useState({ type: 'in', amount: 0, category: '', description: '', account: 'Kas Tunai' });
            const [newAccount, setNewAccount] = useState({ name: '', type: 'bank', color: '#3B82F6', initialBalance: 0 });
            const [filterAccount, setFilterAccount] = useState('all');
            const [editModal, setEditModal] = useState(false);
            const [editForm, setEditForm] = useState({ id: '', type: 'in', amount: 0, category: '', description: '', account: 'Kas Tunai' });
            
            // Pagination states
            const [cashCurrentPage, setCashCurrentPage] = useState(1);
            const [cashItemsPerPage, setCashItemsPerPage] = useState(10);

            // Load cash accounts
            useEffect(() => {
                if (!activeOwner?.id) return;
                const accountsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts');
                let q = query(accountsRef, where('ownerId', '==', activeOwner.id));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(accountsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setCashAccounts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            // Load cash flow - direct PocketBase getFullList (same API as sidebar but fetches all fields)
            const fetchCashFlow = React.useCallback(async () => {
                if (!activeOwner?.id) { setCashFlow([]); return; }
                try {
                    let filter = `ownerId = "${activeOwner.id}"`;
                    if (activeStore?.id && activeStore.id !== 'all') {
                        filter += ` && storeId = "${activeStore.id}"`;
                    }
                    console.log('üì° CashManager fetch:', filter);
                    const records = await pb.collection('cash_flow').getFullList({
                        filter,
                        sort: '-created',
                    });
                    console.log('‚úÖ CashManager result:', records.length, 'items');
                    setCashFlow(records.map(r => ({
                        id: r.id,
                        type: r.type,
                        amount: r.amount || 0,
                        category: r.category || '',
                        description: r.description || '',
                        account: r.account || 'Kas Tunai',
                        ownerId: r.ownerId,
                        storeId: r.storeId,
                        serviceId: r.serviceId,
                        createdAt: r.created,
                    })));
                } catch (err) {
                    console.error('‚ùå CashManager fetch error:', err.message, err.status, err);
                    // Fallback: try via adapter
                    try {
                        console.log('üîÑ CashManager fallback via adapter...');
                        const cashRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow');
                        let q2 = query(cashRef, where('ownerId', '==', activeOwner.id));
                        if (activeStore?.id && activeStore.id !== 'all') {
                            q2 = query(cashRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                        }
                        const snap = await getDocs(q2);
                        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        docs.sort((a, b) => {
                            const getTs = (x) => {
                                if (!x.createdAt) return 0;
                                if (typeof x.createdAt === 'string') return new Date(x.createdAt).getTime();
                                if (x.createdAt.seconds) return x.createdAt.seconds * 1000;
                                return 0;
                            };
                            return getTs(b) - getTs(a);
                        });
                        console.log('‚úÖ CashManager fallback result:', docs.length, 'items');
                        setCashFlow(docs);
                    } catch (err2) {
                        console.error('‚ùå CashManager fallback also failed:', err2);
                        setCashFlow([]);
                    }
                }
            }, [activeOwner?.id, activeStore?.id]);

            useEffect(() => {
                fetchCashFlow();
                // Listen for changes via subscription
                const unsub = _subscribeCollection('cash_flow', () => { fetchCashFlow(); });
                return unsub;
            }, [fetchCashFlow]);

            const addAccount = async (e) => {
                e.preventDefault();
                try {
                    const accountRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        name: newAccount.name,
                        type: newAccount.type,
                        color: newAccount.color,
                        createdAt: serverTimestamp()
                    });
                    
                    // Add initial balance if provided
                    if (newAccount.initialBalance && newAccount.initialBalance > 0) {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'in',
                            amount: parseNumberFromInput(newAccount.initialBalance.toString()),
                            category: 'Saldo Awal',
                            description: `Saldo awal akun ${newAccount.name}`,
                            account: newAccount.name,
                            createdAt: serverTimestamp()
                        });
                    }
                    
                    alert('‚úÖ Akun berhasil ditambahkan!');
                    setAccountModal(false);
                    setNewAccount({ name: '', type: 'bank', color: '#3B82F6', initialBalance: 0 });
                    fetchCashFlow();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const deleteAccount = async (id) => {
                if (!confirm('Hapus akun ini? Transaksi tetap tersimpan.')) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts', id));
                    alert('‚úÖ Akun dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const addCashFlow = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: form.type,
                        amount: parseNumberFromInput(form.amount.toString()),
                        category: form.category,
                        description: form.description,
                        account: form.account || 'Kas Tunai',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Kas berhasil dicatat!');
                    setModal(false);
                    setForm({ type: 'in', amount: 0, category: '', description: '', account: 'Kas Tunai' });
                    fetchCashFlow();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const deleteCashFlow = async (id) => {
                if (!confirm('üóëÔ∏è Hapus transaksi ini?\nSaldo kas akan otomatis berubah. Tindakan tidak bisa dibatalkan.')) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow', id));
                    fetchCashFlow();
                } catch (err) {
                    alert('Error hapus transaksi: ' + err.message);
                }
            };

            const openEditCashModal = (c) => {
                setEditForm({ id: c.id, type: c.type, amount: c.amount, category: c.category || '', description: c.description || '', account: c.account || 'Kas Tunai' });
                setEditModal(true);
            };

            const handleEditCashFlow = async (e) => {
                e.preventDefault();
                try {
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow', editForm.id), {
                        type: editForm.type,
                        amount: parseNumberFromInput(editForm.amount.toString()),
                        category: editForm.category,
                        description: editForm.description,
                        account: editForm.account || 'Kas Tunai',
                    });
                    setEditModal(false);
                    fetchCashFlow();
                } catch (err) {
                    alert('Error edit transaksi: ' + err.message);
                }
            };

            // Filter by account
            const filteredCashFlow = filterAccount === 'all' 
                ? cashFlow 
                : cashFlow.filter(c => (c.account || 'Kas Tunai') === filterAccount);

            // Get all unique accounts (from cash_accounts + default)
            const allAccountNames = ['Kas Tunai', ...cashAccounts.map(a => a.name)];
            
            // Calculate balance per account
            const accountBalances = allAccountNames.map(accName => {
                const flows = cashFlow.filter(c => (c.account || 'Kas Tunai') === accName);
                const totalIn = flows.filter(c => c.type === 'in').reduce((sum, c) => sum + c.amount, 0);
                const totalOut = flows.filter(c => c.type === 'out').reduce((sum, c) => sum + c.amount, 0);
                const accountInfo = cashAccounts.find(a => a.name === accName);
                return { 
                    account: accName, 
                    balance: totalIn - totalOut, 
                    totalIn, 
                    totalOut,
                    type: accountInfo?.type || 'cash',
                    color: accountInfo?.color || '#10B981'
                };
            });

            const totalIn = filteredCashFlow.filter(c => c.type === 'in').reduce((sum, c) => sum + c.amount, 0);
            const totalOut = filteredCashFlow.filter(c => c.type === 'out').reduce((sum, c) => sum + c.amount, 0);
            const balance = totalIn - totalOut;
            const grandTotal = accountBalances.reduce((sum, a) => sum + a.balance, 0);

            // Pagination calculations for cash flow
            const cashTotalPages = Math.ceil(filteredCashFlow.length / cashItemsPerPage);
            const cashStartIndex = (cashCurrentPage - 1) * cashItemsPerPage;
            const cashEndIndex = cashStartIndex + cashItemsPerPage;
            const paginatedCashFlow = filteredCashFlow.slice(cashStartIndex, cashEndIndex);
            
            // Calculate running balance before the current page
            const balanceBeforePage = filteredCashFlow.slice(0, cashStartIndex).reduce((acc, c) => {
                return acc + (c.type === 'in' ? c.amount : -c.amount);
            }, 0);

            const handleCashPageChange = (newPage) => {
                if (newPage >= 1 && newPage <= cashTotalPages) {
                    setCashCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleCashItemsPerPageChange = (value) => {
                setCashItemsPerPage(value);
                setCashCurrentPage(1);
            };

            // Auto-reset ke halaman 1 jika halaman aktif melebihi total halaman
            React.useEffect(() => {
                if (cashTotalPages > 0 && cashCurrentPage > cashTotalPages) {
                    setCashCurrentPage(1);
                }
            }, [cashTotalPages, cashCurrentPage]);

            const getAccountIcon = (type) => {
                switch(type) {
                    case 'bank': return 'üè¶';
                    case 'ewallet': return 'üì±';
                    case 'cash': return 'üíµ';
                    default: return 'üí∞';
                }
            };

            return (
                <div className="space-y-4">
                    {/* Header - mobile compact */}
                    <div>
                        <h2 className="font-bold text-xl mb-3">üíµ Uang Kas & Bank</h2>
                        {/* Mobile: 2x2 grid buttons */}
                        <div className="grid grid-cols-2 gap-2 md:hidden">
                            <button onClick={() => setModal(true)} className="bg-blue-600 text-white py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 text-sm active:scale-95 transition-transform">
                                <Plus className="w-4 h-4" /> Catat Transaksi
                            </button>
                            <button onClick={() => setAccountModal(true)} className="bg-purple-600 text-white py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 text-sm active:scale-95 transition-transform">
                                <Plus className="w-4 h-4" /> Tambah Akun
                            </button>
                            <button onClick={() => { setForm({ type: 'in', amount: 0, category: 'Saldo Awal', description: 'Penambahan saldo', account: 'Kas Tunai' }); setModal(true); }} className="bg-green-600 text-white py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 text-sm active:scale-95 transition-transform">
                                <Plus className="w-4 h-4" /> Tambah Saldo
                            </button>
                            <button onClick={() => { setForm({ type: 'out', amount: 0, category: 'Pengurangan Saldo', description: 'Pengurangan saldo', account: 'Kas Tunai' }); setModal(true); }} className="bg-orange-600 text-white py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 text-sm active:scale-95 transition-transform">
                                <Minus className="w-4 h-4" /> Kurangi Saldo
                            </button>
                        </div>
                        {/* Desktop: row buttons */}
                        <div className="hidden md:flex gap-2 flex-wrap">
                            <button onClick={() => setAccountModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 flex items-center gap-2">
                                <Plus className="w-4 h-4" /> Tambah Akun
                            </button>
                            <button onClick={() => { setForm({ type: 'in', amount: 0, category: 'Saldo Awal', description: 'Penambahan saldo', account: 'Kas Tunai' }); setModal(true); }} className="bg-green-600 text-white px-3 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2 text-sm">
                                <Plus className="w-4 h-4" /> üí∞ Tambah Saldo
                            </button>
                            <button onClick={() => { setForm({ type: 'out', amount: 0, category: 'Pengurangan Saldo', description: 'Pengurangan saldo', account: 'Kas Tunai' }); setModal(true); }} className="bg-orange-600 text-white px-3 py-2 rounded-lg font-bold hover:bg-orange-700 flex items-center gap-2 text-sm">
                                <Minus className="w-4 h-4" /> üìâ Kurangi Saldo
                            </button>
                            <button onClick={() => setModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                                <Plus className="w-4 h-4" /> Catat Transaksi
                            </button>
                        </div>
                    </div>

                    {/* Saldo Per Akun */}
                    <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-xl p-3 md:p-4">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-purple-800 text-sm flex items-center gap-2">
                                <Banknote className="w-4 h-4" />
                                Saldo Per Akun ({accountBalances.length})
                            </h3>
                            <span className="text-xs font-bold text-purple-600">{formatCurrency(grandTotal)}</span>
                        </div>
                        {/* Mobile: horizontal scroll */}
                        <div className="flex gap-3 overflow-x-auto pb-1 md:hidden" style={{scrollbarWidth:'none'}}>
                            {accountBalances.map(acc => {
                                const accountData = cashAccounts.find(a => a.name === acc.account);
                                return (
                                    <div key={acc.account} className="bg-white rounded-xl p-3 border border-gray-200 relative flex-shrink-0 w-44">
                                        {accountData && (
                                            <button onClick={() => deleteAccount(accountData.id)} className="absolute top-1.5 right-1.5 bg-red-50 hover:bg-red-100 text-red-500 rounded p-1" title="Hapus akun">
                                                <Trash2 className="w-3 h-3" />
                                            </button>
                                        )}
                                        <div className="text-xs text-gray-500 mb-0.5 flex items-center gap-1 pr-5">
                                            <span>{getAccountIcon(acc.type)}</span>
                                            <span className="truncate font-medium">{acc.account}</span>
                                        </div>
                                        <div className={`text-base font-black mb-2 ${acc.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {formatCurrency(acc.balance)}
                                        </div>
                                        <div className="flex gap-1">
                                            <button onClick={() => { setForm({ type: 'in', amount: 0, category: 'Penambahan Saldo', description: `Penambahan saldo ${acc.account}`, account: acc.account }); setModal(true); }} className="flex-1 bg-green-100 text-green-700 text-[10px] py-1 rounded font-bold flex items-center justify-center gap-0.5 active:scale-95">
                                                <Plus className="w-2.5 h-2.5" /> +
                                            </button>
                                            <button onClick={() => { setForm({ type: 'out', amount: 0, category: 'Pengurangan Saldo', description: `Pengurangan saldo ${acc.account}`, account: acc.account }); setModal(true); }} className="flex-1 bg-orange-100 text-orange-700 text-[10px] py-1 rounded font-bold flex items-center justify-center gap-0.5 active:scale-95">
                                                <Minus className="w-2.5 h-2.5" /> -
                                            </button>
                                            <button onClick={async () => {
                                                if (!confirm(`‚ö†Ô∏è Reset saldo ${acc.account} menjadi Rp 0?\n\nIni akan menambahkan transaksi penyesuaian. Riwayat transaksi tetap tersimpan.`)) return;
                                                try {
                                                    const adjustmentAmount = Math.abs(acc.balance);
                                                    if (adjustmentAmount > 0) {
                                                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), { ownerId: activeOwner.id, storeId: activeStore.id, type: acc.balance > 0 ? 'out' : 'in', amount: adjustmentAmount, category: 'Reset Saldo', description: `Reset saldo ${acc.account} menjadi Rp 0`, account: acc.account, createdAt: serverTimestamp() });
                                                        alert('‚úÖ Saldo berhasil direset menjadi Rp 0!');
                                                    } else { alert('‚ÑπÔ∏è Saldo sudah Rp 0'); }
                                                } catch (err) { alert('Error: ' + err.message); }
                                            }} className="flex-1 bg-red-100 text-red-600 text-[10px] py-1 rounded font-bold flex items-center justify-center active:scale-95">
                                                <RotateCcw className="w-2.5 h-2.5" />
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        {/* Desktop: grid */}
                        <div className="hidden md:grid grid-cols-4 gap-3">
                            {accountBalances.map(acc => {
                                const accountData = cashAccounts.find(a => a.name === acc.account);
                                return (
                                    <div key={acc.account} className="bg-white rounded-lg p-3 border border-gray-200 relative group">
                                        {accountData && (
                                            <button onClick={() => deleteAccount(accountData.id)} className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-red-100 hover:bg-red-200 text-red-600 rounded p-1" title="Hapus akun">
                                                <Trash2 className="w-3 h-3" />
                                            </button>
                                        )}
                                        <div className="text-xs text-gray-600 mb-1 flex items-center gap-1">
                                            <span>{getAccountIcon(acc.type)}</span>
                                            <span className="truncate">{acc.account}</span>
                                        </div>
                                        <div className={`text-lg font-bold ${acc.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(acc.balance)}</div>
                                        <div className="mt-2 space-y-1">
                                            <button onClick={() => { setForm({ type: 'in', amount: 0, category: 'Penambahan Saldo', description: `Penambahan saldo ${acc.account}`, account: acc.account }); setModal(true); }} className="w-full bg-green-50 hover:bg-green-100 text-green-700 text-xs py-1 px-2 rounded font-medium transition-colors flex items-center justify-center gap-1"><Plus className="w-3 h-3" /> Tambah Saldo</button>
                                            <button onClick={() => { setForm({ type: 'out', amount: 0, category: 'Pengurangan Saldo', description: `Pengurangan saldo ${acc.account}`, account: acc.account }); setModal(true); }} className="w-full bg-orange-50 hover:bg-orange-100 text-orange-700 text-xs py-1 px-2 rounded font-medium transition-colors flex items-center justify-center gap-1"><Minus className="w-3 h-3" /> Kurangi Saldo</button>
                                            <button onClick={async () => {
                                                if (!confirm(`‚ö†Ô∏è Reset saldo ${acc.account} menjadi Rp 0?\n\nIni akan menambahkan transaksi penyesuaian. Riwayat transaksi tetap tersimpan.`)) return;
                                                try {
                                                    const adjustmentAmount = Math.abs(acc.balance);
                                                    if (adjustmentAmount > 0) {
                                                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), { ownerId: activeOwner.id, storeId: activeStore.id, type: acc.balance > 0 ? 'out' : 'in', amount: adjustmentAmount, category: 'Reset Saldo', description: `Reset saldo ${acc.account} menjadi Rp 0`, account: acc.account, createdAt: serverTimestamp() });
                                                        alert('‚úÖ Saldo berhasil direset menjadi Rp 0!');
                                                    } else { alert('‚ÑπÔ∏è Saldo sudah Rp 0'); }
                                                } catch (err) { alert('Error: ' + err.message); }
                                            }} className="w-full bg-red-50 hover:bg-red-100 text-red-700 text-xs py-1 px-2 rounded font-medium transition-colors flex items-center justify-center gap-1"><RotateCcw className="w-3 h-3" /> Reset Saldo</button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="mt-3 pt-3 border-t border-purple-200 hidden md:flex justify-between items-center">
                            <span className="text-2xl font-bold text-purple-600">{formatCurrency(grandTotal)}</span>
                        </div>
                    </div>

                    {/* Filter + Stats gabungan */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="px-3 py-2.5 border-b border-slate-100 flex items-center gap-2">
                            <label className="text-xs font-bold text-slate-500 flex-shrink-0">Filter:</label>
                            <select value={filterAccount} onChange={e => { setFilterAccount(e.target.value); setCashCurrentPage(1); }} className="flex-1 border-0 text-sm font-semibold text-slate-700 focus:outline-none bg-transparent">
                                <option value="all">üìä Semua Akun</option>
                                {allAccountNames.map(acc => {
                                    const accountInfo = cashAccounts.find(a => a.name === acc);
                                    return <option key={acc} value={acc}>{getAccountIcon(accountInfo?.type || 'cash')} {acc}</option>;
                                })}
                            </select>
                        </div>
                        <div className="grid grid-cols-3 divide-x divide-slate-100">
                            <div className="p-3 text-center">
                                <p className="text-[10px] text-blue-500 font-bold uppercase mb-0.5">üí∞ Saldo</p>
                                <p className="text-sm font-black text-blue-600 leading-tight">{formatCurrency(balance)}</p>
                            </div>
                            <div className="p-3 text-center">
                                <p className="text-[10px] text-green-500 font-bold uppercase mb-0.5">üì• Masuk</p>
                                <p className="text-sm font-black text-green-600 leading-tight">{formatCurrency(totalIn)}</p>
                            </div>
                            <div className="p-3 text-center">
                                <p className="text-[10px] text-red-500 font-bold uppercase mb-0.5">üì§ Keluar</p>
                                <p className="text-sm font-black text-red-600 leading-tight">{formatCurrency(totalOut)}</p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        {/* Header riwayat */}
                        <div className="px-4 py-3 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
                            <h3 className="font-bold text-slate-700 text-sm">üìã Riwayat Transaksi</h3>
                            <span className="text-xs text-slate-500">{filteredCashFlow.length} transaksi</span>
                        </div>
                        {/* Mobile card view */}
                        <div className="md:hidden divide-y divide-slate-100">
                            {paginatedCashFlow.length === 0 && <div className="p-8 text-center text-gray-400 text-sm">{filteredCashFlow.length === 0 ? 'Belum ada transaksi kas' : 'Tidak ada data di halaman ini'}</div>}
                            {paginatedCashFlow.reduce((acc, c) => {
                                const runningBalance = acc.balance + (c.type === 'in' ? c.amount : -c.amount);
                                const accountInfo = cashAccounts.find(a => a.name === c.account);
                                acc.rows.push(
                                    <div key={c.id} className="p-3">
                                        <div className="flex items-start gap-3">
                                            {/* Badge jenis */}
                                            <div className={`flex-shrink-0 w-9 h-9 rounded-full flex items-center justify-center text-lg ${c.type === 'in' ? 'bg-green-100' : 'bg-red-100'}`}>
                                                {c.type === 'in' ? 'üì•' : 'üì§'}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between items-start">
                                                    <div className="min-w-0 flex-1 pr-2">
                                                        <p className="font-bold text-slate-800 text-sm truncate">{c.category || '-'}</p>
                                                        {c.description ? <p className="text-xs text-slate-400 truncate mt-0.5">{c.description}</p> : null}
                                                    </div>
                                                    <div className="text-right flex-shrink-0">
                                                        <p className={`font-black text-sm ${c.type === 'in' ? 'text-green-600' : 'text-red-600'}`}>{c.type === 'in' ? '+' : '-'}{formatCurrency(c.amount)}</p>
                                                        <p className="text-[10px] text-blue-500 font-semibold">{formatCurrency(runningBalance)}</p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 mt-1.5">
                                                    <span className="text-[10px] text-slate-400">{getAccountIcon(accountInfo?.type || 'cash')} {c.account || 'Kas Tunai'}</span>
                                                    <span className="text-[10px] text-slate-300">¬∑</span>
                                                    <span className="text-[10px] text-slate-400">{formatDate(c.createdAt)}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-1.5 mt-2">
                                            <button onClick={() => openEditCashModal(c)} className="flex-1 flex items-center justify-center gap-1 py-1.5 rounded-lg bg-blue-50 active:bg-blue-100 text-blue-600 text-xs font-semibold active:scale-[0.97] transition-transform">
                                                <Pencil className="w-3 h-3" /> Edit
                                            </button>
                                            <button onClick={() => deleteCashFlow(c.id)} className="flex-1 flex items-center justify-center gap-1 py-1.5 rounded-lg bg-red-50 active:bg-red-100 text-red-500 text-xs font-semibold active:scale-[0.97] transition-transform">
                                                <Trash2 className="w-3 h-3" /> Hapus
                                            </button>
                                        </div>
                                    </div>
                                );
                                acc.balance = runningBalance;
                                return acc;
                            }, { rows: [], balance: balanceBeforePage }).rows}
                        </div>
                        {/* Desktop table */}
                        <div className="hidden md:block overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal & Waktu</th>
                                    <th className="p-3 text-left">Akun</th>
                                    <th className="p-3 text-left">Jenis</th>
                                    <th className="p-3 text-left">Kategori</th>
                                    <th className="p-3 text-left">Keterangan</th>
                                    <th className="p-3 text-right">Jumlah</th>
                                    <th className="p-3 text-right">Saldo</th>
                                    <th className="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedCashFlow.reduce((acc, c, idx) => {
                                    const runningBalance = acc.balance + (c.type === 'in' ? c.amount : -c.amount);
                                    const accountInfo = cashAccounts.find(a => a.name === c.account);
                                    acc.rows.push(
                                        <tr key={c.id}>
                                            <td className="p-3 text-gray-500 text-xs">{formatDate(c.createdAt)}</td>
                                            <td className="p-3">
                                                <span className="text-xs font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded flex items-center gap-1 w-fit">
                                                    <span>{getAccountIcon(accountInfo?.type || 'cash')}</span>
                                                    <span>{c.account || 'Kas Tunai'}</span>
                                                </span>
                                            </td>
                                            <td className="p-3">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${c.type === 'in' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                    {c.type === 'in' ? 'üì• Masuk' : 'üì§ Keluar'}
                                                </span>
                                            </td>
                                            <td className="p-3 font-medium">{c.category || '-'}</td>
                                            <td className="p-3 text-xs text-gray-500">{c.description}</td>
                                            <td className={`p-3 text-right font-bold ${c.type === 'in' ? 'text-green-600' : 'text-red-600'}`}>
                                                {c.type === 'in' ? '+' : '-'}{formatCurrency(c.amount)}
                                            </td>
                                            <td className="p-3 text-right font-bold text-blue-600">{formatCurrency(runningBalance)}</td>
                                            <td className="p-3 text-center">
                                                <div className="flex items-center justify-center gap-1">
                                                    <button onClick={() => openEditCashModal(c)} className="p-1.5 rounded bg-blue-50 hover:bg-blue-100 text-blue-600 transition-colors" title="Edit transaksi">
                                                        <Pencil className="w-3.5 h-3.5" />
                                                    </button>
                                                    <button onClick={() => deleteCashFlow(c.id)} className="p-1.5 rounded bg-red-50 hover:bg-red-100 text-red-600 transition-colors" title="Hapus transaksi">
                                                        <Trash2 className="w-3.5 h-3.5" />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                    acc.balance = runningBalance;
                                    return acc;
                                }, { rows: [], balance: balanceBeforePage }).rows}
                            </tbody>
                        </table>
                        {filteredCashFlow.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada transaksi kas</div>}
                        {filteredCashFlow.length > 0 && paginatedCashFlow.length === 0 && <div className="p-8 text-center text-gray-400">Tidak ada data di halaman ini. <button onClick={() => setCashCurrentPage(1)} className="text-blue-600 underline">Kembali ke halaman 1</button></div>}
                        </div>
                    </div>

                    {/* Pagination */}
                    {filteredCashFlow.length > 0 && (
                        <div className="bg-white rounded-xl border border-slate-200 p-3">
                            {/* Mobile pagination */}
                            <div className="md:hidden">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-xs text-slate-500">{Math.min(cashStartIndex + 1, filteredCashFlow.length)}-{Math.min(cashEndIndex, filteredCashFlow.length)} dari {filteredCashFlow.length}</span>
                                    <div className="flex items-center gap-1.5">
                                        <span className="text-xs text-slate-500">Per hal:</span>
                                        <select value={cashItemsPerPage} onChange={(e) => handleCashItemsPerPageChange(parseInt(e.target.value))} className="border border-slate-200 rounded px-1.5 py-0.5 text-xs bg-white font-medium">
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => handleCashPageChange(1)} disabled={cashCurrentPage === 1} className="px-2 py-1.5 rounded-lg border border-slate-200 text-xs disabled:opacity-40 active:bg-slate-50 font-bold">¬´</button>
                                    <button onClick={() => handleCashPageChange(cashCurrentPage - 1)} disabled={cashCurrentPage === 1} className="flex-1 py-1.5 rounded-lg border border-slate-200 text-xs disabled:opacity-40 active:bg-slate-50 font-semibold">‚Üê Sebelumnya</button>
                                    <span className="text-xs font-bold text-slate-600 px-1">{cashCurrentPage}/{cashTotalPages}</span>
                                    <button onClick={() => handleCashPageChange(cashCurrentPage + 1)} disabled={cashCurrentPage === cashTotalPages} className="flex-1 py-1.5 rounded-lg border border-slate-200 text-xs disabled:opacity-40 active:bg-slate-50 font-semibold">Selanjutnya ‚Üí</button>
                                    <button onClick={() => handleCashPageChange(cashTotalPages)} disabled={cashCurrentPage === cashTotalPages} className="px-2 py-1.5 rounded-lg border border-slate-200 text-xs disabled:opacity-40 active:bg-slate-50 font-bold">¬ª</button>
                                </div>
                            </div>
                            {/* Desktop pagination */}
                            <div className="hidden md:flex flex-row justify-between items-center gap-4">
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                    <select value={cashItemsPerPage} onChange={(e) => handleCashItemsPerPageChange(parseInt(e.target.value))} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <span className="text-sm text-slate-600">transaksi per halaman</span>
                                </div>
                                <div className="text-sm text-slate-600">Menampilkan {Math.min(cashStartIndex + 1, filteredCashFlow.length)} - {Math.min(cashEndIndex, filteredCashFlow.length)} dari {filteredCashFlow.length} transaksi</div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => handleCashPageChange(cashCurrentPage - 1)} disabled={cashCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 hover:bg-slate-50">‚Üê Sebelumnya</button>
                                    <div className="flex space-x-1">
                                        {Array.from({ length: cashTotalPages }, (_, i) => {
                                            const p = i + 1;
                                            if (p === 1 || p === cashTotalPages || (p >= cashCurrentPage - 2 && p <= cashCurrentPage + 2)) {
                                                return <button key={p} onClick={() => handleCashPageChange(p)} className={`px-3 py-1 text-sm rounded ${p === cashCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                            } else if (p === cashCurrentPage - 3 || p === cashCurrentPage + 3) {
                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                            }
                                            return null;
                                        })}
                                    </div>
                                    <button onClick={() => handleCashPageChange(cashCurrentPage + 1)} disabled={cashCurrentPage === cashTotalPages} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Tambah Akun */}
                    {accountModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">Tambah Akun Kas/Bank</h3>
                                <form onSubmit={addAccount} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Akun</label>
                                        <input 
                                            value={newAccount.name} 
                                            onChange={e => setNewAccount({ ...newAccount, name: e.target.value })} 
                                            placeholder="Contoh: Bank BRI Cabang Jakarta, Kas Toko 1" 
                                            className="w-full border p-2 rounded" 
                                            required 
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Tipe Akun</label>
                                        <select 
                                            value={newAccount.type} 
                                            onChange={e => setNewAccount({ ...newAccount, type: e.target.value })} 
                                            className="w-full border p-2 rounded"
                                        >
                                            <option value="cash">üíµ Kas Tunai</option>
                                            <option value="bank">üè¶ Bank</option>
                                            <option value="ewallet">üì± E-Wallet</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Saldo Awal (Opsional)</label>
                                        <NumberInput 
                                            value={newAccount.initialBalance} 
                                            onChange={val => setNewAccount({ ...newAccount, initialBalance: val })} 
                                            className="w-full border p-2 rounded font-bold text-lg" 
                                            placeholder="0"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">üí° Isi jika ingin menambahkan saldo awal untuk akun ini</p>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setAccountModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-purple-600 text-white p-2 rounded font-bold">Tambah Akun</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Modal Transaksi */}
                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">
                                    {form.type === 'in' && form.category === 'Saldo Awal' 
                                        ? 'üí∞ Tambah Saldo Kas/Bank' 
                                        : 'Catat Transaksi Kas/Bank'
                                    }
                                </h3>
                                <form onSubmit={addCashFlow} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Akun</label>
                                        <select 
                                            value={form.account} 
                                            onChange={e => setForm({ ...form, account: e.target.value })} 
                                            className="w-full border p-2 rounded"
                                        >
                                            {allAccountNames.map(acc => {
                                                const accountInfo = cashAccounts.find(a => a.name === acc);
                                                const icon = getAccountIcon(accountInfo?.type || 'cash');
                                                return <option key={acc} value={acc}>{icon} {acc}</option>;
                                            })}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jenis Transaksi</label>
                                        <select value={form.type} onChange={e => setForm({ ...form, type: e.target.value })} className="w-full border p-2 rounded">
                                            <option value="in">üì• Kas Masuk</option>
                                            <option value="out">üì§ Kas Keluar</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Kategori</label>
                                        <input 
                                            value={form.category} 
                                            onChange={e => setForm({ ...form, category: e.target.value })} 
                                            placeholder={form.type === 'in' ? 'Contoh: Saldo Awal, Penjualan, Pendapatan Lain' : 'Contoh: Pembelian, Gaji, Operasional'} 
                                            className="w-full border p-2 rounded" 
                                            required 
                                            list="categoryOptions"
                                        />
                                        <datalist id="categoryOptions">
                                            {form.type === 'in' ? (
                                                <>
                                                    <option value="Saldo Awal" />
                                                    <option value="Penjualan" />
                                                    <option value="Pendapatan Jasa" />
                                                    <option value="Pendapatan Lain" />
                                                </>
                                            ) : (
                                                <>
                                                    <option value="Pembelian Barang" />
                                                    <option value="Gaji Karyawan" />
                                                    <option value="Biaya Operasional" />
                                                    <option value="Biaya Lain" />
                                                </>
                                            )}
                                        </datalist>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                        <NumberInput value={form.amount} onChange={val => setForm({ ...form, amount: val })} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Keterangan</label>
                                        <textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full border p-2 rounded" rows="2" placeholder="Detail transaksi..."></textarea>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Modal Edit Transaksi */}
                    {editModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4 flex items-center gap-2">
                                    <Pencil className="w-5 h-5 text-blue-600" /> Edit Transaksi Kas
                                </h3>
                                <form onSubmit={handleEditCashFlow} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Akun</label>
                                        <select value={editForm.account} onChange={e => setEditForm({ ...editForm, account: e.target.value })} className="w-full border p-2 rounded">
                                            {allAccountNames.map(acc => {
                                                const accountInfo = cashAccounts.find(a => a.name === acc);
                                                const icon = getAccountIcon(accountInfo?.type || 'cash');
                                                return <option key={acc} value={acc}>{icon} {acc}</option>;
                                            })}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jenis Transaksi</label>
                                        <select value={editForm.type} onChange={e => setEditForm({ ...editForm, type: e.target.value })} className="w-full border p-2 rounded">
                                            <option value="in">üì• Kas Masuk</option>
                                            <option value="out">üì§ Kas Keluar</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Kategori</label>
                                        <input value={editForm.category} onChange={e => setEditForm({ ...editForm, category: e.target.value })} placeholder="Kategori transaksi" className="w-full border p-2 rounded" required list="editCategoryOptions" />
                                        <datalist id="editCategoryOptions">
                                            {editForm.type === 'in' ? (
                                                <><option value="Saldo Awal" /><option value="Penjualan" /><option value="Pendapatan Jasa" /><option value="Pendapatan Lain" /></>
                                            ) : (
                                                <><option value="Pembelian Barang" /><option value="Gaji Karyawan" /><option value="Biaya Operasional" /><option value="Biaya Lain" /></>
                                            )}
                                        </datalist>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                        <NumberInput value={editForm.amount} onChange={val => setEditForm({ ...editForm, amount: val })} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Keterangan</label>
                                        <textarea value={editForm.description} onChange={e => setEditForm({ ...editForm, description: e.target.value })} className="w-full border p-2 rounded" rows="2" placeholder="Detail transaksi..."></textarea>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setEditModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold flex items-center justify-center gap-2">
                                            <Save className="w-4 h-4" /> Simpan Perubahan
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üîó PUBLIC SERVICE TRACKER (Tracking Progress via Link)
        // ==========================================
        const PublicServiceTracker = ({ serviceId, onBack }) => {
            const [service, setService] = useState(null);
            const [store, setStore] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                let pollInterval = null;
                let cancelled = false;

                const fetchWithAdmin = async (url) => {
                    const adminToken = await getAdminToken();
                    const headers = adminToken ? { 'Authorization': adminToken } : {};
                    const res = await fetch(url, { headers });
                    if (!res.ok) throw Object.assign(new Error('HTTP ' + res.status), { status: res.status });
                    return res.json();
                };

                const fetchService = async () => {
                    try {
                        setLoading(true);
                        // Coba by ID dulu
                        let serviceData = null;
                        try {
                            const rec = await fetchWithAdmin(`${POCKETBASE_URL}/api/collections/services/records/${encodeURIComponent(serviceId)}`);
                            serviceData = { id: rec.id, ...rec };
                        } catch(e) {
                            if (e.status !== 404 && e.status !== 403) throw e;
                            // Fallback: cari by token field
                            const res2 = await fetchWithAdmin(`${POCKETBASE_URL}/api/collections/services/records?filter=${encodeURIComponent(`token="${serviceId}"`)}&perPage=1`);
                            if (res2.items && res2.items.length > 0) {
                                const rec = res2.items[0];
                                serviceData = { id: rec.id, ...rec };
                            }
                        }

                        if (!serviceData || !serviceData.id) {
                            if (!cancelled) setError('Data servis tidak ditemukan. Pastikan link yang dibuka benar.');
                            if (!cancelled) setLoading(false);
                            return;
                        }

                        if (!cancelled) setService(serviceData);

                        // Fetch store data
                        if (serviceData.storeId) {
                            try {
                                const storeRec = await fetchWithAdmin(`${POCKETBASE_URL}/api/collections/stores/records/${encodeURIComponent(serviceData.storeId)}`);
                                if (!cancelled) setStore({ id: storeRec.id, ...storeRec });
                            } catch(e) { /* store optional */ }
                        }

                        if (!cancelled) setLoading(false);
                    } catch (err) {
                        console.error('Error fetching service:', err);
                        if (!cancelled) setError('Gagal memuat data: ' + err.message);
                        if (!cancelled) setLoading(false);
                    }
                };

                fetchService();

                // Polling realtime setiap 30 detik
                pollInterval = setInterval(async () => {
                    if (cancelled) return;
                    try {
                        const adminToken = await getAdminToken();
                        const headers = adminToken ? { 'Authorization': adminToken } : {};
                        const res = await fetch(`${POCKETBASE_URL}/api/collections/services/records/${encodeURIComponent(serviceId)}`, { headers });
                        if (res.ok) {
                            const rec = await res.json();
                            if (!cancelled) setService({ id: rec.id, ...rec });
                        }
                    } catch(e) {}
                }, 30000);

                return () => {
                    cancelled = true;
                    if (pollInterval) clearInterval(pollInterval);
                };
            }, [serviceId]);

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                        <div className="text-center">
                            <Loader2 className="w-12 h-12 animate-spin text-blue-600 mx-auto mb-4" />
                            <p className="text-slate-600 font-medium">Memuat data servis...</p>
                        </div>
                    </div>
                );
            }

            if (error || !service) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <AlertTriangle className="w-8 h-8 text-red-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-2">Data Tidak Ditemukan</h2>
                            <p className="text-slate-600 mb-6">{error || 'Service tidak ditemukan'}</p>
                        </div>
                    </div>
                );
            }

            const statusColors = {
                'Diterima': 'bg-blue-100 text-blue-700 border-blue-300',
                'Diagnosa': 'bg-yellow-100 text-yellow-700 border-yellow-300',
                'Menunggu Sparepart': 'bg-orange-100 text-orange-700 border-orange-300',
                'Selesai': 'bg-green-100 text-green-700 border-green-300',
                'Dibatalkan': 'bg-red-100 text-red-700 border-red-300'
            };

            const paid = parseFloat(service.dp) || 0;
            const total = parseFloat(service.costEstimate) || 0;
            const remaining = total - paid;

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
                    <div className="max-w-2xl mx-auto p-4 py-8">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="flex items-center gap-4 mb-4">
                                <div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                                    <Smartphone className="w-6 h-6 text-white" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-800">Tracking Servis</h1>
                                    {store && <p className="text-sm text-slate-500">{store.name}</p>}
                                </div>
                            </div>
                            <div className="flex items-center gap-2 text-xs text-slate-500">
                                <Activity className="w-4 h-4" />
                                <span>Update Realtime</span>
                            </div>
                        </div>

                        {/* Service Info */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="space-y-4">
                                <div className="flex justify-between items-start border-b pb-4">
                                    <div>
                                        <p className="text-xs text-slate-500 mb-1">Token Servis</p>
                                        <p className="text-2xl font-bold text-blue-600">{service.token}</p>
                                    </div>
                                    <div className={`px-4 py-2 rounded-xl border-2 font-bold text-sm ${statusColors[service.status] || 'bg-gray-100 text-gray-700'}`}>
                                        {service.status}
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-xs text-slate-500 mb-1">Pelanggan</p>
                                        <p className="font-bold text-slate-800">{service.customerName}</p>
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-500 mb-1">No. HP</p>
                                        <p className="font-bold text-slate-800">{service.phone}</p>
                                    </div>
                                </div>

                                <div>
                                    <p className="text-xs text-slate-500 mb-1">Perangkat</p>
                                    <p className="font-bold text-slate-800">{service.unitType || service.deviceType}</p>
                                </div>

                                <div>
                                    <p className="text-xs text-slate-500 mb-1">Keluhan</p>
                                    <p className="text-slate-700 bg-slate-50 p-3 rounded-lg">{service.complaint || service.problem}</p>
                                </div>

                                <div className="border-t pt-4">
                                    <p className="text-xs text-slate-500 mb-1">Tanggal Masuk</p>
                                    <p className="font-bold text-slate-800">{formatDate(service.createdAt)}</p>
                                </div>
                            </div>
                        </div>

                        {/* Payment Info */}
                        <div className="bg-white rounded-2xl shadow-xl p-6">
                            <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                                <Wallet className="w-5 h-5 text-green-600" />
                                Informasi Pembayaran
                            </h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-600">Total Biaya</span>
                                    <span className="font-bold text-xl text-slate-800">{formatCurrency(total)}</span>
                                </div>
                                {service.paymentStatus === 'Lunas' ? (
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center gap-3">
                                        <CheckCircle className="w-6 h-6 text-green-600" />
                                        <div>
                                            <p className="font-bold text-green-700">Lunas</p>
                                            <p className="text-xs text-green-600">Pembayaran sudah diselesaikan</p>
                                        </div>
                                    </div>
                                ) : service.paymentStatus === 'DP' ? (
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-600">DP Dibayar</span>
                                            <span className="font-bold text-green-600">{formatCurrency(paid)}</span>
                                        </div>
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-600">Sisa Pembayaran</span>
                                            <span className="font-bold text-orange-600">{formatCurrency(remaining)}</span>
                                        </div>
                                        <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 text-xs text-orange-700">
                                            ‚è≥ Pembayaran DP telah diterima. Sisa pembayaran dapat dilunasi saat pengambilan.
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                        <p className="text-sm text-slate-600">Belum ada pembayaran</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="text-center mt-8 text-xs text-slate-500">
                            <p>Halaman ini update secara realtime</p>
                            <p className="mt-1">Powered by iFix Pro Enterprise</p>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== HR MANAGER ====================
        const HRManager = () => {
            const { user, activeOwner, activeStore, checkPermission } = useContext(SessionContext);
            const [tab, setTab] = useState('attendance');
            const { data: users } = useFirestoreCollection('users', activeOwner?.id, activeStore?.id);
            const [attendances, setAttendances] = useState([]);
            const [payrolls, setPayrolls] = useState([]);
            const [leaves, setLeaves] = useState([]);
            const [shifts, setShifts] = useState([]);
            const [salarySettings, setSalarySettings] = useState([]);
            const [monthlyBudgets, setMonthlyBudgets] = useState([]);
            const [modal, setModal] = useState(null);
            const [loading, setLoading] = useState(false);
            
            // Pagination states
            const [attCurrentPage, setAttCurrentPage] = useState(1);
            const [attItemsPerPage, setAttItemsPerPage] = useState(10);
            const [payrollCurrentPage, setPayrollCurrentPage] = useState(1);
            const [payrollItemsPerPage, setPayrollItemsPerPage] = useState(10);
            const [leaveCurrentPage, setLeaveCurrentPage] = useState(1);
            const [leaveItemsPerPage, setLeaveItemsPerPage] = useState(10);
            const [budgetCurrentPage, setBudgetCurrentPage] = useState(1);
            const [budgetItemsPerPage, setBudgetItemsPerPage] = useState(10);

            // Check if current user is owner
            const isOwner = user?.role === 'owner' || user?.role === 'developer';
            
            // Get current user data from users collection
            const currentUserData = users.find(u => u.email === user?.email);

            // Load Attendance Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'attendance'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setAttendances(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Payroll Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'payroll'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setPayrolls(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Leave Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'leaves'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setLeaves(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Shift Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'shifts'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setShifts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Salary Settings Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'salarySettings'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setSalarySettings(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Monthly Budget Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'monthlyBudgets'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setMonthlyBudgets(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Check In/Out Handler
            const handleCheckInOut = async (userId, type) => {
                setLoading(true);
                try {
                    const user = users.find(u => u.id === userId);
                    const now = new Date();
                    const today = now.toISOString().split('T')[0];

                    // Check if already checked in today
                    // a.date is stored as plain text "YYYY-MM-DD", a.checkOut is "" when empty
                    const todayAttendance = attendances.find(a => {
                        const aDate = a.date?.toDate ? a.date.toDate().toISOString().split('T')[0] : String(a.date || '').split('T')[0].split(' ')[0];
                        return a.userId === userId && aDate === today && !a.checkOut;
                    });

                    if (type === 'in') {
                        if (todayAttendance) {
                            alert('Sudah check-in hari ini!');
                            return;
                        }
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'attendance'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            userId: userId,
                            userName: user?.name || 'Unknown',
                            date: today,
                            checkIn: serverTimestamp(),
                            checkOut: null,
                            workHours: 0,
                            createdAt: serverTimestamp()
                        });
                        alert('‚úÖ Check-in berhasil!');
                    } else {
                        if (!todayAttendance) {
                            alert('Belum check-in hari ini!');
                            return;
                        }
                        const checkInTime = todayAttendance.checkIn?.seconds ? new Date(todayAttendance.checkIn.seconds * 1000) : new Date();
                        const workHours = ((now - checkInTime) / (1000 * 60 * 60)).toFixed(2);

                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'attendance', todayAttendance.id), {
                            checkOut: serverTimestamp(),
                            workHours: parseFloat(workHours)
                        });
                        alert(`‚úÖ Check-out berhasil! Jam kerja: ${workHours} jam`);
                    }
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Generate Payroll
            const handleGeneratePayroll = async (formData) => {
                setLoading(true);
                try {
                    const user = users.find(u => u.id === formData.userId);
                    
                    // Calculate total work hours for the month
                    const monthAttendances = attendances.filter(a => 
                        a.userId === formData.userId && 
                        a.date?.startsWith(formData.month)
                    );
                    const totalHours = monthAttendances.reduce((sum, a) => sum + (a.workHours || 0), 0);
                    const totalDays = monthAttendances.length;

                    const baseSalary = parseFloat(formData.baseSalary) || 0;
                    const commission = parseFloat(formData.commission) || 0;
                    const bonus = parseFloat(formData.bonus) || 0;
                    const deduction = parseFloat(formData.deduction) || 0;
                    const totalSalary = baseSalary + commission + bonus - deduction;

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'payroll'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        userId: formData.userId,
                        userName: user?.name || 'Unknown',
                        month: formData.month,
                        baseSalary,
                        commission,
                        bonus,
                        deduction,
                        totalSalary,
                        totalHours,
                        totalDays,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });

                    alert('‚úÖ Payroll berhasil digenerate!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Request Leave
            const handleRequestLeave = async (formData) => {
                setLoading(true);
                try {
                    // For employee, use their own userId. For owner, use selected userId
                    const targetUserId = isOwner ? formData.userId : currentUserData?.id;
                    const targetUser = users.find(u => u.id === targetUserId);
                    
                    if (!targetUserId || !targetUser) {
                        alert('User tidak ditemukan!');
                        return;
                    }
                    
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'leaves'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        userId: targetUserId,
                        userName: targetUser.name || 'Unknown',
                        type: formData.type,
                        startDate: formData.startDate,
                        endDate: formData.endDate,
                        reason: formData.reason,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Pengajuan cuti berhasil!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Approve/Reject Leave
            const handleLeaveAction = async (leaveId, status) => {
                try {
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'leaves', leaveId), {
                        status: status,
                        updatedAt: serverTimestamp()
                    });
                    alert(`‚úÖ Cuti ${status === 'approved' ? 'disetujui' : 'ditolak'}!`);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            // Create Shift
            const handleCreateShift = async (formData) => {
                setLoading(true);
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'shifts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        name: formData.name,
                        startTime: formData.startTime,
                        endTime: formData.endTime,
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Shift berhasil dibuat!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Save/Update Salary Setting
            const handleSaveSalarySetting = async (formData) => {
                setLoading(true);
                try {
                    const user = users.find(u => u.id === formData.userId);
                    const existing = salarySettings.find(s => s.userId === formData.userId);
                    
                    const salaryData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        userId: formData.userId,
                        userName: user?.name || 'Unknown',
                        baseSalary: parseFloat(formData.baseSalary) || 0,
                        commissionRate: parseFloat(formData.commissionRate) || 0,
                        updatedAt: serverTimestamp()
                    };

                    if (existing) {
                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'salarySettings', existing.id), salaryData);
                        alert('‚úÖ Gaji tetap berhasil diupdate!');
                    } else {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'salarySettings'), {
                            ...salaryData,
                            createdAt: serverTimestamp()
                        });
                        alert('‚úÖ Gaji tetap berhasil disimpan!');
                    }
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Auto Generate Payroll for All Employees
            const handleAutoGeneratePayroll = async (month) => {
                if (!month) {
                    alert('Pilih bulan terlebih dahulu!');
                    return;
                }
                
                if (!confirm(`Generate payroll untuk semua karyawan untuk bulan ${month}?`)) {
                    return;
                }
                
                setLoading(true);
                try {
                    let generated = 0;
                    for (const setting of salarySettings) {
                        // Check if payroll already exists for this user and month
                        const existingPayroll = payrolls.find(p => 
                            p.userId === setting.userId && p.month === month
                        );
                        
                        if (existingPayroll) {
                            console.log(`Payroll untuk ${setting.userName} bulan ${month} sudah ada, skip.`);
                            continue;
                        }

                        // Calculate total work hours for the month
                        const monthAttendances = attendances.filter(a => 
                            a.userId === setting.userId && 
                            a.date?.startsWith(month)
                        );
                        const totalHours = monthAttendances.reduce((sum, a) => sum + (a.workHours || 0), 0);
                        const totalDays = monthAttendances.length;

                        const baseSalary = setting.baseSalary || 0;
                        const commission = 0; // Will be added manually if needed
                        const bonus = 0;
                        const deduction = 0;
                        const totalSalary = baseSalary + commission + bonus - deduction;

                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'payroll'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            userId: setting.userId,
                            userName: setting.userName,
                            month: month,
                            baseSalary,
                            commission,
                            bonus,
                            deduction,
                            totalSalary,
                            totalHours,
                            totalDays,
                            status: 'pending',
                            createdAt: serverTimestamp()
                        });
                        
                        generated++;
                    }
                    
                    if (generated > 0) {
                        alert(`‚úÖ Payroll berhasil digenerate untuk ${generated} karyawan!`);
                    } else {
                        alert('‚ÑπÔ∏è Tidak ada payroll baru yang digenerate. Mungkin sudah ada untuk bulan tersebut.');
                    }
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Add Monthly Budget
            const handleAddMonthlyBudget = async (formData) => {
                setLoading(true);
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'monthlyBudgets'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        name: formData.name,
                        amount: parseFloat(formData.amount) || 0,
                        category: formData.category,
                        dueDate: formData.dueDate || null,
                        notes: formData.notes || '',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Anggaran bulanan berhasil ditambahkan!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Delete Monthly Budget
            const handleDeleteBudget = async (budgetId) => {
                if (!confirm('Hapus anggaran bulanan ini?')) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'monthlyBudgets', budgetId));
                    alert('‚úÖ Anggaran bulanan berhasil dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            // Update Payroll
            const handleUpdatePayroll = async (payrollId, formData) => {
                setLoading(true);
                try {
                    const user = users.find(u => u.id === formData.userId);
                    
                    // Calculate total work hours for the month
                    const monthAttendances = attendances.filter(a => 
                        a.userId === formData.userId && 
                        a.date?.startsWith(formData.month)
                    );
                    const totalHours = monthAttendances.reduce((sum, a) => sum + (a.workHours || 0), 0);
                    const totalDays = monthAttendances.length;

                    const baseSalary = parseFloat(formData.baseSalary) || 0;
                    const commission = parseFloat(formData.commission) || 0;
                    const bonus = parseFloat(formData.bonus) || 0;
                    const deduction = parseFloat(formData.deduction) || 0;
                    const totalSalary = baseSalary + commission + bonus - deduction;

                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'payroll', payrollId), {
                        userId: formData.userId,
                        userName: user?.name || 'Unknown',
                        month: formData.month,
                        baseSalary,
                        commission,
                        bonus,
                        deduction,
                        totalSalary,
                        totalHours,
                        totalDays,
                        updatedAt: serverTimestamp()
                    });

                    alert('‚úÖ Payroll berhasil diupdate!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Delete Payroll
            const handleDeletePayroll = async (payrollId) => {
                if (!confirm('Hapus data payroll ini?')) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'payroll', payrollId));
                    alert('‚úÖ Payroll berhasil dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl flex items-center gap-2">
                            <Users className="w-7 h-7 text-blue-600" />
                            HR & Payroll Management
                        </h2>
                    </div>

                    {!isOwner && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p className="text-sm text-blue-800"><strong>[i] Info:</strong> Anda dapat mengakses Absensi dan Cuti. Fitur Gaji, Payroll, Shift, dan Anggaran hanya untuk Owner.</p>
                        </div>
                    )}

                    {/* Tabs */}
                    <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200 overflow-x-auto">
                        {[
                            { id: 'attendance', label: 'üìã Absensi', icon: CheckCircle, forAll: true },
                            { id: 'salary', label: 'üíµ Gaji Tetap', icon: DollarSign, ownerOnly: true },
                            { id: 'payroll', label: 'üí∞ Payroll', icon: Wallet, ownerOnly: true },
                            { id: 'leave', label: 'üèñÔ∏è Cuti', icon: Calendar, forAll: true },
                            { id: 'shift', label: 'üïê Shift', icon: RotateCw, ownerOnly: true },
                            { id: 'budget', label: 'üìä Anggaran Bulanan', icon: TrendingDown, ownerOnly: true }
                        ].filter(t => t.forAll || (t.ownerOnly && isOwner)).map(t => (
                            <button 
                                key={t.id} 
                                onClick={() => setTab(t.id)} 
                                className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap flex items-center gap-2 ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}
                            >
                                {t.label}
                            </button>
                        ))}
                    </div>

                    {/* ATTENDANCE TAB */}
                    {tab === 'attendance' && (() => {
                        // Helper: ambil date string "YYYY-MM-DD" dari nilai apapun (PBTimestamp atau string)
                        const _toDateStr = (d) => d?.toDate ? d.toDate().toISOString().split('T')[0] : String(d||'').split('T')[0].split(' ')[0];
                        return (
                        <div className="space-y-4">
                            {/* Employee Self-Service View */}
                            {!isOwner && currentUserData && (
                                <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 text-white">
                                    <h3 className="font-bold text-xl mb-4">Absensi Saya</h3>
                                    {(() => {
                                        const today = new Date().toISOString().split('T')[0];
                                        const todayAttendance = attendances.find(a => 
                                            a.userId === currentUserData.id && _toDateStr(a.date) === today
                                        );
                                        const isCheckedIn = todayAttendance && !todayAttendance.checkOut;
                                        const isCheckedOut = todayAttendance && todayAttendance.checkOut;

                                        return (
                                            <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6">
                                                <div className="mb-4">
                                                    <p className="text-2xl font-bold mb-1">{currentUserData.name}</p>
                                                    <p className="opacity-75">{currentUserData.role}</p>
                                                </div>
                                                <div className="mb-4">
                                                    <div className={`inline-block px-4 py-2 rounded-full text-sm font-bold ${
                                                        isCheckedOut ? 'bg-green-500' : isCheckedIn ? 'bg-yellow-500' : 'bg-slate-500'
                                                    }`}>
                                                        {isCheckedOut ? '‚úì Sudah Check Out' : isCheckedIn ? '‚è∞ Sedang Bekerja' : '‚óã Belum Check In'}
                                                    </div>
                                                </div>
                                                {todayAttendance && (
                                                    <div className="mb-4 space-y-2 text-sm">
                                                        <p>Check In: {todayAttendance.checkIn?.seconds ? new Date(todayAttendance.checkIn.seconds * 1000).toLocaleTimeString('id-ID') : '-'}</p>
                                                        <p>Check Out: {todayAttendance.checkOut?.seconds ? new Date(todayAttendance.checkOut.seconds * 1000).toLocaleTimeString('id-ID') : '-'}</p>
                                                        {todayAttendance.workHours && <p className="font-bold">Total: {todayAttendance.workHours} jam</p>}
                                                    </div>
                                                )}
                                                <div className="flex gap-3">
                                                    <button
                                                        onClick={() => handleCheckInOut(currentUserData.id, 'in')}
                                                        disabled={isCheckedIn || isCheckedOut || loading}
                                                        className="flex-1 bg-green-500 text-white py-3 rounded-lg text-base font-bold hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    >
                                                        ‚úì Check In
                                                    </button>
                                                    <button
                                                        onClick={() => handleCheckInOut(currentUserData.id, 'out')}
                                                        disabled={!isCheckedIn || isCheckedOut || loading}
                                                        className="flex-1 bg-red-500 text-white py-3 rounded-lg text-base font-bold hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    >
                                                        ‚úì Check Out
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}

                            {/* Owner View - All Employees */}
                            {isOwner && (
                                <>
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                        <p className="text-sm text-blue-800"><strong>[i] Info:</strong> Owner hanya dapat melihat absensi karyawan. Karyawan melakukan check-in dan check-out sendiri.</p>
                                    </div>
                                    <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 text-white">
                                        <h3 className="font-bold text-xl mb-4">Absensi Semua Karyawan Hari Ini</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {users.filter(u => u.role !== 'owner').map(user => {
                                            const today = new Date().toISOString().split('T')[0];
                                            const todayAttendance = attendances.find(a => 
                                                a.userId === user.id && _toDateStr(a.date) === today
                                            );
                                            const isCheckedIn = todayAttendance && !todayAttendance.checkOut;
                                            const isCheckedOut = todayAttendance && todayAttendance.checkOut;

                                            return (
                                                <div key={user.id} className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <div>
                                                            <p className="font-bold">{user.name}</p>
                                                            <p className="text-xs opacity-75">{user.role}</p>
                                                        </div>
                                                        <div className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                            isCheckedOut ? 'bg-green-500' : isCheckedIn ? 'bg-yellow-500' : 'bg-slate-500'
                                                        }`}>
                                                            {isCheckedOut ? '‚úì Selesai' : isCheckedIn ? '‚è∞ Aktif' : '‚óã Belum'}
                                                        </div>
                                                    </div>
                                                    {todayAttendance && (
                                                        <div className="text-xs space-y-1 mb-2 opacity-90">
                                                            <p>In: {todayAttendance.checkIn?.seconds ? new Date(todayAttendance.checkIn.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'}</p>
                                                            <p>Out: {todayAttendance.checkOut?.seconds ? new Date(todayAttendance.checkOut.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'}</p>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                </>
                            )}

                            {/* Attendance History */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b bg-slate-50">
                                    <h3 className="font-bold text-slate-800">
                                        {isOwner ? 'Riwayat Absensi Semua Karyawan' : 'Riwayat Absensi Saya'}
                                    </h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                <th className="p-3 text-left">Tanggal</th>
                                                {isOwner && <th className="p-3 text-left">Nama</th>}
                                                <th className="p-3 text-center">Check In</th>
                                                <th className="p-3 text-center">Check Out</th>
                                                <th className="p-3 text-center">Jam Kerja</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {(() => {
                                                const _getDateStr = (d) => d?.toDate ? d.toDate().toISOString().split('T')[0] : String(d || '').split('T')[0].split(' ')[0];
                                                const filteredAtt = attendances
                                                    .filter(att => isOwner || att.userId === currentUserData?.id)
                                                    .sort((a, b) => _getDateStr(b.date).localeCompare(_getDateStr(a.date)));
                                                const attTotalPages = Math.ceil(filteredAtt.length / attItemsPerPage);
                                                const attStart = (attCurrentPage - 1) * attItemsPerPage;
                                                const attEnd = attStart + attItemsPerPage;
                                                const paginatedAtt = filteredAtt.slice(attStart, attEnd);
                                                return paginatedAtt.map(att => (
                                                <tr key={att.id} className="hover:bg-slate-50">
                                                    <td className="p-3">{att.date?.toDate ? att.date.toDate().toISOString().split('T')[0] : String(att.date||'').split('T')[0].split(' ')[0]}</td>
                                                    {isOwner && <td className="p-3 font-bold">{att.userName}</td>}
                                                    <td className="p-3 text-center">
                                                        {att.checkIn?.seconds ? new Date(att.checkIn.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'}
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        {att.checkOut?.seconds ? new Date(att.checkOut.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'}
                                                    </td>
                                                    <td className="p-3 text-center font-bold text-blue-600">
                                                        {att.workHours ? `${att.workHours} jam` : '-'}
                                                    </td>
                                                </tr>
                                            ));
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                                {/* Pagination Controls for Attendance */}
                                {(() => {
                                    const filteredAtt = attendances
                                        .filter(att => isOwner || att.userId === currentUserData?.id);
                                    const attTotal = filteredAtt.length;
                                    const attTotalPages = Math.ceil(attTotal / attItemsPerPage);
                                    if (attTotal === 0) return null;
                                    return (
                                        <div className="p-4 border-t border-slate-200">
                                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                                    <select value={attItemsPerPage} onChange={(e) => { setAttItemsPerPage(parseInt(e.target.value)); setAttCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                                        <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                                    </select>
                                                    <span className="text-sm text-slate-600">per halaman</span>
                                                </div>
                                                <div className="text-sm text-slate-600">
                                                    Menampilkan {Math.min((attCurrentPage - 1) * attItemsPerPage + 1, attTotal)} - {Math.min(attCurrentPage * attItemsPerPage, attTotal)} dari {attTotal}
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <button onClick={() => { if (attCurrentPage > 1) setAttCurrentPage(attCurrentPage - 1); }} disabled={attCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                                    <div className="flex space-x-1">
                                                        {Array.from({ length: attTotalPages }, (_, i) => {
                                                            const p = i + 1;
                                                            if (p === 1 || p === attTotalPages || (p >= attCurrentPage - 2 && p <= attCurrentPage + 2)) {
                                                                return <button key={p} onClick={() => setAttCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === attCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                                            } else if (p === attCurrentPage - 3 || p === attCurrentPage + 3) {
                                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                                            }
                                                            return null;
                                                        })}
                                                    </div>
                                                    <button onClick={() => { if (attCurrentPage < attTotalPages) setAttCurrentPage(attCurrentPage + 1); }} disabled={attCurrentPage === attTotalPages} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    ); })()}

                    {/* SALARY SETTINGS TAB */}
                    {tab === 'salary' && isOwner && (
                        <div className="space-y-4">
                            <div className="bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl p-6 text-white">
                                <h3 className="font-bold text-xl mb-2">Pengaturan Gaji Tetap</h3>
                                <p className="text-sm opacity-90">Set gaji pokok sekali, payroll akan auto-generate tiap bulan</p>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-800">Daftar Gaji Karyawan</h3>
                                    <button
                                        onClick={() => setModal('salary')}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2"
                                    >
                                        <Plus className="w-4 h-4" /> Set Gaji
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                <th className="p-3 text-left">Nama</th>
                                                <th className="p-3 text-right">Gaji Pokok</th>
                                                <th className="p-3 text-right">Rate Komisi (%)</th>
                                                <th className="p-3 text-center">Terakhir Update</th>
                                                <th className="p-3 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {users.filter(u => u.role !== 'owner').map(user => {
                                                const setting = salarySettings.find(s => s.userId === user.id);
                                                return (
                                                    <tr key={user.id} className="hover:bg-slate-50">
                                                        <td className="p-3 font-bold">{user.name}</td>
                                                        <td className="p-3 text-right text-green-600 font-bold">
                                                            {setting ? `Rp ${formatNumberWithSeparator(setting.baseSalary)}` : '-'}
                                                        </td>
                                                        <td className="p-3 text-right">
                                                            {setting ? `${setting.commissionRate}%` : '-'}
                                                        </td>
                                                        <td className="p-3 text-center text-xs text-slate-500">
                                                            {setting?.updatedAt?.seconds ? new Date(setting.updatedAt.seconds * 1000).toLocaleDateString('id-ID') : '-'}
                                                        </td>
                                                        <td className="p-3 text-center">
                                                            <button
                                                                onClick={() => setModal({ type: 'salary', userId: user.id, data: setting })}
                                                                className="bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-600"
                                                            >
                                                                {setting ? 'Edit' : 'Set Gaji'}
                                                            </button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {salarySettings.length > 0 && (
                                <div className="bg-blue-50 border border-blue-200 rounded-xl p-6">
                                    <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                                        <Zap className="w-5 h-5 text-blue-600" />
                                        Auto-Generate Payroll
                                    </h3>
                                    <p className="text-sm text-slate-600 mb-4">
                                        Generate payroll untuk semua karyawan berdasarkan gaji tetap yang sudah di-set
                                    </p>
                                    <button
                                        onClick={() => setModal('autoPayroll')}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center gap-2"
                                    >
                                        <Zap className="w-5 h-5" /> Auto Generate Payroll
                                    </button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* PAYROLL TAB */}
                    {tab === 'payroll' && (
                        <div className="space-y-4">
                            <div className="flex justify-end">
                                <button
                                    onClick={() => setModal('payroll')}
                                    className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center gap-2"
                                >
                                    <Plus className="w-5 h-5" /> Generate Payroll
                                </button>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                <th className="p-3 text-left">Bulan</th>
                                                <th className="p-3 text-left">Nama</th>
                                                <th className="p-3 text-right">Gaji Pokok</th>
                                                <th className="p-3 text-right">Komisi</th>
                                                <th className="p-3 text-right">Bonus</th>
                                                <th className="p-3 text-right">Potongan</th>
                                                <th className="p-3 text-right">Total</th>
                                                <th className="p-3 text-center">Status</th>
                                                <th className="p-3 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {(() => {
                                                const sortedPayrolls = payrolls.sort((a, b) => (b.month || '').localeCompare(a.month || ''));
                                                const prTotalPages = Math.ceil(sortedPayrolls.length / payrollItemsPerPage);
                                                const prStart = (payrollCurrentPage - 1) * payrollItemsPerPage;
                                                const prEnd = prStart + payrollItemsPerPage;
                                                return sortedPayrolls.slice(prStart, prEnd).map(pr => (
                                                <tr key={pr.id} className="hover:bg-slate-50">
                                                    <td className="p-3">{pr.month}</td>
                                                    <td className="p-3 font-bold">{pr.userName}</td>
                                                    <td className="p-3 text-right">{formatCurrency(pr.baseSalary)}</td>
                                                    <td className="p-3 text-right text-green-600">{formatCurrency(pr.commission)}</td>
                                                    <td className="p-3 text-right text-blue-600">{formatCurrency(pr.bonus)}</td>
                                                    <td className="p-3 text-right text-red-600">{formatCurrency(pr.deduction)}</td>
                                                    <td className="p-3 text-right font-bold text-lg">{formatCurrency(pr.totalSalary)}</td>
                                                    <td className="p-3 text-center">
                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                            pr.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                                        }`}>
                                                            {pr.status === 'paid' ? 'Dibayar' : 'Pending'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <div className="flex gap-2 justify-center">
                                                            <button
                                                                onClick={() => setModal({ type: 'payroll', mode: 'edit', data: pr })}
                                                                className="bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-600"
                                                            >
                                                                Edit
                                                            </button>
                                                            <button
                                                                onClick={() => handleDeletePayroll(pr.id)}
                                                                className="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600"
                                                            >
                                                                Hapus
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ));
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                                {/* Pagination Controls for Payroll */}
                                {payrolls.length > 0 && (
                                    <div className="p-4 border-t border-slate-200">
                                        <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                            <div className="flex items-center space-x-2">
                                                <span className="text-sm text-slate-600">Tampilkan:</span>
                                                <select value={payrollItemsPerPage} onChange={(e) => { setPayrollItemsPerPage(parseInt(e.target.value)); setPayrollCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                                    <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                                </select>
                                                <span className="text-sm text-slate-600">per halaman</span>
                                            </div>
                                            <div className="text-sm text-slate-600">
                                                Menampilkan {Math.min((payrollCurrentPage - 1) * payrollItemsPerPage + 1, payrolls.length)} - {Math.min(payrollCurrentPage * payrollItemsPerPage, payrolls.length)} dari {payrolls.length}
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => { if (payrollCurrentPage > 1) setPayrollCurrentPage(payrollCurrentPage - 1); }} disabled={payrollCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                                <div className="flex space-x-1">
                                                    {Array.from({ length: Math.ceil(payrolls.length / payrollItemsPerPage) }, (_, i) => {
                                                        const p = i + 1;
                                                        if (p === 1 || p === Math.ceil(payrolls.length / payrollItemsPerPage) || (p >= payrollCurrentPage - 2 && p <= payrollCurrentPage + 2)) {
                                                            return <button key={p} onClick={() => setPayrollCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === payrollCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                                        } else if (p === payrollCurrentPage - 3 || p === payrollCurrentPage + 3) {
                                                            return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                                        }
                                                        return null;
                                                    })}
                                                </div>
                                                <button onClick={() => { const tp = Math.ceil(payrolls.length / payrollItemsPerPage); if (payrollCurrentPage < tp) setPayrollCurrentPage(payrollCurrentPage + 1); }} disabled={payrollCurrentPage === Math.ceil(payrolls.length / payrollItemsPerPage)} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* LEAVE TAB */}
                    {tab === 'leave' && (
                        <div className="space-y-4">
                            {isOwner && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p className="text-sm text-blue-800"><strong>[i] Info:</strong> Owner hanya dapat melihat dan menyetujui/menolak pengajuan cuti karyawan. Karyawan mengajukan cuti sendiri.</p>
                                </div>
                            )}
                            {!isOwner && (
                                <div className="flex justify-end">
                                    <button
                                        onClick={() => setModal('leave')}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center gap-2"
                                    >
                                        <Plus className="w-5 h-5" /> Ajukan Cuti
                                    </button>
                                </div>
                            )}

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b bg-slate-50">
                                    <h3 className="font-bold text-slate-800">
                                        {isOwner ? 'Daftar Cuti Semua Karyawan' : 'Daftar Cuti Saya'}
                                    </h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                {isOwner && <th className="p-3 text-left">Nama</th>}
                                                <th className="p-3 text-left">Tipe</th>
                                                <th className="p-3 text-center">Tanggal Mulai</th>
                                                <th className="p-3 text-center">Tanggal Selesai</th>
                                                <th className="p-3 text-left">Alasan</th>
                                                <th className="p-3 text-center">Status</th>
                                                {isOwner && <th className="p-3 text-center">Aksi</th>}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {(() => {
                                                const filteredLeaves = leaves
                                                    .filter(leave => isOwner || leave.userId === currentUserData?.id)
                                                    .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                                                const leaveStart = (leaveCurrentPage - 1) * leaveItemsPerPage;
                                                const leaveEnd = leaveStart + leaveItemsPerPage;
                                                return filteredLeaves.slice(leaveStart, leaveEnd).map(leave => (
                                                <tr key={leave.id} className="hover:bg-slate-50">
                                                    {isOwner && <td className="p-3 font-bold">{leave.userName}</td>}
                                                    <td className="p-3">
                                                        <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">
                                                            {leave.type}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-center">{leave.startDate}</td>
                                                    <td className="p-3 text-center">{leave.endDate}</td>
                                                    <td className="p-3 text-sm">{leave.reason}</td>
                                                    <td className="p-3 text-center">
                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                            leave.status === 'approved' ? 'bg-green-100 text-green-700' :
                                                            leave.status === 'rejected' ? 'bg-red-100 text-red-700' :
                                                            'bg-yellow-100 text-yellow-700'
                                                        }`}>
                                                            {leave.status === 'approved' ? 'Disetujui' : leave.status === 'rejected' ? 'Ditolak' : 'Pending'}
                                                        </span>
                                                    </td>
                                                    {isOwner && (
                                                        <td className="p-3 text-center">
                                                            {leave.status === 'pending' && (
                                                                <div className="flex gap-2 justify-center">
                                                                    <button
                                                                        onClick={() => handleLeaveAction(leave.id, 'approved')}
                                                                        className="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-600"
                                                                    >
                                                                        Setujui
                                                                    </button>
                                                                    <button
                                                                        onClick={() => handleLeaveAction(leave.id, 'rejected')}
                                                                        className="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600"
                                                                    >
                                                                        Tolak
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </td>
                                                    )}
                                                </tr>
                                            ));
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                                {/* Pagination Controls for Leave */}
                                {(() => {
                                    const filteredLeaves = leaves.filter(leave => isOwner || leave.userId === currentUserData?.id);
                                    const leaveTotal = filteredLeaves.length;
                                    const leaveTotalPages = Math.ceil(leaveTotal / leaveItemsPerPage);
                                    if (leaveTotal === 0) return null;
                                    return (
                                        <div className="p-4 border-t border-slate-200">
                                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                                    <select value={leaveItemsPerPage} onChange={(e) => { setLeaveItemsPerPage(parseInt(e.target.value)); setLeaveCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                                        <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                                    </select>
                                                    <span className="text-sm text-slate-600">per halaman</span>
                                                </div>
                                                <div className="text-sm text-slate-600">
                                                    Menampilkan {Math.min((leaveCurrentPage - 1) * leaveItemsPerPage + 1, leaveTotal)} - {Math.min(leaveCurrentPage * leaveItemsPerPage, leaveTotal)} dari {leaveTotal}
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <button onClick={() => { if (leaveCurrentPage > 1) setLeaveCurrentPage(leaveCurrentPage - 1); }} disabled={leaveCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                                    <div className="flex space-x-1">
                                                        {Array.from({ length: leaveTotalPages }, (_, i) => {
                                                            const p = i + 1;
                                                            if (p === 1 || p === leaveTotalPages || (p >= leaveCurrentPage - 2 && p <= leaveCurrentPage + 2)) {
                                                                return <button key={p} onClick={() => setLeaveCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === leaveCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                                            } else if (p === leaveCurrentPage - 3 || p === leaveCurrentPage + 3) {
                                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                                            }
                                                            return null;
                                                        })}
                                                    </div>
                                                    <button onClick={() => { if (leaveCurrentPage < leaveTotalPages) setLeaveCurrentPage(leaveCurrentPage + 1); }} disabled={leaveCurrentPage === leaveTotalPages} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}

                    {/* SHIFT TAB */}
                    {tab === 'shift' && (
                        <div className="space-y-4">
                            <div className="flex justify-end">
                                <button
                                    onClick={() => setModal('shift')}
                                    className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center gap-2"
                                >
                                    <Plus className="w-5 h-5" /> Buat Shift
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {shifts.map(shift => (
                                    <div key={shift.id} className="bg-white rounded-xl border border-slate-200 p-6 hover:shadow-lg transition-shadow">
                                        <h3 className="font-bold text-lg text-slate-800 mb-3">{shift.name}</h3>
                                        <div className="space-y-2 text-sm">
                                            <div className="flex items-center gap-2 text-slate-600">
                                                <span className="text-lg">‚è∞</span>
                                                <span>Mulai: <strong>{shift.startTime}</strong></span>
                                            </div>
                                            <div className="flex items-center gap-2 text-slate-600">
                                                <span className="text-lg">‚è∞</span>
                                                <span>Selesai: <strong>{shift.endTime}</strong></span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* PERFORMANCE TAB */}
                    {tab === 'performance' && (
                        <div className="space-y-4">
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                <h3 className="font-bold text-xl mb-6 text-slate-800">Performance Review</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {users.filter(u => u.role !== 'owner').map(user => {
                                        const userAttendances = attendances.filter(a => a.userId === user.id);
                                        const totalHours = userAttendances.reduce((sum, a) => sum + (a.workHours || 0), 0);
                                        const avgHours = userAttendances.length > 0 ? (totalHours / userAttendances.length).toFixed(1) : 0;

                                        return (
                                            <div key={user.id} className="border border-slate-200 rounded-xl p-6 hover:shadow-md transition-shadow">
                                                <div className="flex items-center gap-4 mb-4">
                                                    <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                                        <Users className="w-6 h-6 text-blue-600" />
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-lg">{user.name}</h4>
                                                        <p className="text-sm text-slate-500">{user.role}</p>
                                                    </div>
                                                </div>
                                                <div className="space-y-3">
                                                    <div className="flex justify-between items-center py-2 border-b">
                                                        <span className="text-slate-600">Total Hadir</span>
                                                        <span className="font-bold text-blue-600">{userAttendances.length} hari</span>
                                                    </div>
                                                    <div className="flex justify-between items-center py-2 border-b">
                                                        <span className="text-slate-600">Total Jam Kerja</span>
                                                        <span className="font-bold text-green-600">{totalHours.toFixed(1)} jam</span>
                                                    </div>
                                                    <div className="flex justify-between items-center py-2">
                                                        <span className="text-slate-600">Rata-rata/Hari</span>
                                                        <span className="font-bold text-purple-600">{avgHours} jam</span>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MONTHLY BUDGET TAB */}
                    {tab === 'budget' && isOwner && (
                        <div className="space-y-4">
                            <div className="bg-gradient-to-r from-orange-600 to-red-600 rounded-2xl p-6 text-white">
                                <h3 className="font-bold text-xl mb-2">Anggaran Bulanan</h3>
                                <p className="text-sm opacity-90">Catat pengeluaran rutin bulanan seperti sewa, listrik, dll</p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                                    <p className="text-slate-600 text-sm mb-2">Total Anggaran</p>
                                    <p className="font-bold text-2xl text-blue-600">
                                        Rp {formatNumberWithSeparator(monthlyBudgets.reduce((sum, b) => sum + (b.amount || 0), 0))}
                                    </p>
                                </div>
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                                    <p className="text-slate-600 text-sm mb-2">Jumlah Item</p>
                                    <p className="font-bold text-2xl text-green-600">{monthlyBudgets.length}</p>
                                </div>
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                                    <p className="text-slate-600 text-sm mb-2">Rata-rata per Item</p>
                                    <p className="font-bold text-2xl text-purple-600">
                                        Rp {monthlyBudgets.length > 0 ? formatNumberWithSeparator(Math.round(monthlyBudgets.reduce((sum, b) => sum + (b.amount || 0), 0) / monthlyBudgets.length)) : '0'}
                                    </p>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-800">Daftar Pengeluaran Bulanan</h3>
                                    <button
                                        onClick={() => setModal('budget')}
                                        className="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-700 flex items-center gap-2"
                                    >
                                        <Plus className="w-4 h-4" /> Tambah Anggaran
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                <th className="p-3 text-left">Nama</th>
                                                <th className="p-3 text-left">Kategori</th>
                                                <th className="p-3 text-right">Jumlah</th>
                                                <th className="p-3 text-center">Jatuh Tempo</th>
                                                <th className="p-3 text-left">Catatan</th>
                                                <th className="p-3 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {(() => {
                                                const budgetStart = (budgetCurrentPage - 1) * budgetItemsPerPage;
                                                const budgetEnd = budgetStart + budgetItemsPerPage;
                                                return monthlyBudgets.slice(budgetStart, budgetEnd).map(budget => (
                                                <tr key={budget.id} className="hover:bg-slate-50">
                                                    <td className="p-3 font-bold">{budget.name}</td>
                                                    <td className="p-3">
                                                        <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">
                                                            {budget.category}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-right font-bold text-red-600">
                                                        Rp {formatNumberWithSeparator(budget.amount)}
                                                    </td>
                                                    <td className="p-3 text-center">{budget.dueDate || '-'}</td>
                                                    <td className="p-3 text-sm text-slate-600">{budget.notes || '-'}</td>
                                                    <td className="p-3 text-center">
                                                        <button
                                                            onClick={() => handleDeleteBudget(budget.id)}
                                                            className="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600"
                                                        >
                                                            Hapus
                                                        </button>
                                                    </td>
                                                </tr>
                                            ));
                                            })()}
                                        </tbody>
                                    </table>
                                    {monthlyBudgets.length === 0 && (
                                        <div className="p-8 text-center text-slate-400">
                                            <TrendingDown className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                            <p>Belum ada anggaran bulanan</p>
                                        </div>
                                    )}
                                    {/* Pagination Controls for Budget */}
                                    {monthlyBudgets.length > 0 && (
                                        <div className="p-4 border-t border-slate-200">
                                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                                    <select value={budgetItemsPerPage} onChange={(e) => { setBudgetItemsPerPage(parseInt(e.target.value)); setBudgetCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                                        <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                                    </select>
                                                    <span className="text-sm text-slate-600">per halaman</span>
                                                </div>
                                                <div className="text-sm text-slate-600">
                                                    Menampilkan {Math.min((budgetCurrentPage - 1) * budgetItemsPerPage + 1, monthlyBudgets.length)} - {Math.min(budgetCurrentPage * budgetItemsPerPage, monthlyBudgets.length)} dari {monthlyBudgets.length}
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <button onClick={() => { if (budgetCurrentPage > 1) setBudgetCurrentPage(budgetCurrentPage - 1); }} disabled={budgetCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                                    <div className="flex space-x-1">
                                                        {Array.from({ length: Math.ceil(monthlyBudgets.length / budgetItemsPerPage) }, (_, i) => {
                                                            const p = i + 1;
                                                            if (p === 1 || p === Math.ceil(monthlyBudgets.length / budgetItemsPerPage) || (p >= budgetCurrentPage - 2 && p <= budgetCurrentPage + 2)) {
                                                                return <button key={p} onClick={() => setBudgetCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === budgetCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                                            } else if (p === budgetCurrentPage - 3 || p === budgetCurrentPage + 3) {
                                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                                            }
                                                            return null;
                                                        })}
                                                    </div>
                                                    <button onClick={() => { const tp = Math.ceil(monthlyBudgets.length / budgetItemsPerPage); if (budgetCurrentPage < tp) setBudgetCurrentPage(budgetCurrentPage + 1); }} disabled={budgetCurrentPage === Math.ceil(monthlyBudgets.length / budgetItemsPerPage)} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODALS */}
                    {modal?.type === 'salary' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">
                                    {modal.data ? 'Edit Gaji Tetap' : 'Set Gaji Tetap'}
                                </h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleSaveSalarySetting({
                                        userId: modal.userId,
                                        baseSalary: fd.get('baseSalary'),
                                        commissionRate: fd.get('commissionRate')
                                    });
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Pegawai</label>
                                        <input 
                                            type="text" 
                                            value={users.find(u => u.id === modal.userId)?.name || ''} 
                                            disabled 
                                            className="w-full border p-3 rounded-lg bg-slate-100"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Gaji Pokok (Rp)</label>
                                        <NumberInput 
                                            name="baseSalary" 
                                            required 
                                            value={modal.data?.baseSalary || 0}
                                            className="w-full border p-3 rounded-lg" 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Rate Komisi (%)</label>
                                        <input 
                                            type="number" 
                                            name="commissionRate" 
                                            step="0.1" 
                                            defaultValue={modal.data?.commissionRate || 0}
                                            className="w-full border p-3 rounded-lg" 
                                        />
                                    </div>
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-slate-600">
                                        üí° Gaji pokok akan digunakan untuk auto-generate payroll tiap bulan
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700">
                                            {loading ? 'Proses...' : 'Simpan'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {modal === 'autoPayroll' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4 flex items-center gap-2">
                                    <Zap className="w-6 h-6 text-blue-600" />
                                    Auto Generate Payroll
                                </h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleAutoGeneratePayroll(fd.get('month'));
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Pilih Bulan</label>
                                        <input 
                                            type="month" 
                                            name="month" 
                                            required 
                                            className="w-full border p-3 rounded-lg"
                                        />
                                    </div>
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-2 text-sm">
                                        <p className="font-bold text-blue-900">‚ÑπÔ∏è Informasi:</p>
                                        <ul className="list-disc list-inside text-slate-700 space-y-1">
                                            <li>Payroll akan digenerate untuk {salarySettings.length} karyawan</li>
                                            <li>Menggunakan gaji pokok yang sudah di-set</li>
                                            <li>Komisi dan bonus bisa ditambahkan manual setelah generate</li>
                                            <li>Jika payroll untuk bulan tersebut sudah ada, akan di-skip</li>
                                        </ul>
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
                                            {loading ? 'Processing...' : 'Generate Payroll'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {modal === 'budget' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">Tambah Anggaran Bulanan</h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleAddMonthlyBudget({
                                        name: fd.get('name'),
                                        amount: fd.get('amount'),
                                        category: fd.get('category'),
                                        dueDate: fd.get('dueDate'),
                                        notes: fd.get('notes')
                                    });
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Nama Pengeluaran</label>
                                        <input 
                                            type="text" 
                                            name="name" 
                                            required 
                                            placeholder="e.g. Sewa Toko" 
                                            className="w-full border p-3 rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Kategori</label>
                                        <select name="category" required className="w-full border p-3 rounded-lg">
                                            <option value="Sewa">Sewa/Kontrak</option>
                                            <option value="Utilitas">Utilitas (Listrik, Air, Internet)</option>
                                            <option value="Transportasi">Transportasi</option>
                                            <option value="Maintenance">Maintenance/Pemeliharaan</option>
                                            <option value="Asuransi">Asuransi</option>
                                            <option value="Lainnya">Lainnya</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Jumlah (Rp)</label>
                                        <NumberInput 
                                            name="amount" 
                                            required 
                                            className="w-full border p-3 rounded-lg" 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Tanggal Jatuh Tempo (Opsional)</label>
                                        <input 
                                            type="number" 
                                            name="dueDate" 
                                            min="1" 
                                            max="31" 
                                            placeholder="Tanggal 1-31" 
                                            className="w-full border p-3 rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Catatan (Opsional)</label>
                                        <textarea 
                                            name="notes" 
                                            placeholder="Catatan tambahan..." 
                                            className="w-full border p-3 rounded-lg" 
                                            rows="3"
                                        ></textarea>
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700">
                                            {loading ? 'Proses...' : 'Tambah'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {(modal === 'payroll' || modal?.type === 'payroll') && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">
                                    {modal?.mode === 'edit' ? 'Edit Payroll' : 'Generate Payroll'}
                                </h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    if (modal?.mode === 'edit') {
                                        handleUpdatePayroll(modal.data.id, {
                                            userId: fd.get('userId'),
                                            month: fd.get('month'),
                                            baseSalary: fd.get('baseSalary'),
                                            commission: fd.get('commission'),
                                            bonus: fd.get('bonus'),
                                            deduction: fd.get('deduction')
                                        });
                                    } else {
                                        handleGeneratePayroll({
                                            userId: fd.get('userId'),
                                            month: fd.get('month'),
                                            baseSalary: fd.get('baseSalary'),
                                            commission: fd.get('commission'),
                                            bonus: fd.get('bonus'),
                                            deduction: fd.get('deduction')
                                        });
                                    }
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Pegawai</label>
                                        <select name="userId" required defaultValue={modal?.data?.userId || ''} className="w-full border p-3 rounded-lg">
                                            <option value="">Pilih Pegawai</option>
                                            {users.filter(u => u.role !== 'owner').map(u => (
                                                <option key={u.id} value={u.id}>{u.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Bulan</label>
                                        <input type="month" name="month" required defaultValue={modal?.data?.month || ''} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Gaji Pokok</label>
                                        <NumberInput name="baseSalary" required value={modal?.data?.baseSalary || 0} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Komisi</label>
                                        <NumberInput name="commission" value={modal?.data?.commission || 0} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Bonus</label>
                                        <NumberInput name="bonus" value={modal?.data?.bonus || 0} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Potongan</label>
                                        <NumberInput name="deduction" value={modal?.data?.deduction || 0} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
                                            {loading ? 'Proses...' : (modal?.mode === 'edit' ? 'Update' : 'Generate')}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {modal === 'leave' && !isOwner && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">Ajukan Cuti</h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleRequestLeave({
                                        userId: currentUserData?.id,
                                        type: fd.get('type'),
                                        startDate: fd.get('startDate'),
                                        endDate: fd.get('endDate'),
                                        reason: fd.get('reason')
                                    });
                                }} className="space-y-4">
                                    {currentUserData && (
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <p className="text-sm text-slate-600 mb-1">Mengajukan cuti untuk:</p>
                                            <p className="font-bold text-lg">{currentUserData.name}</p>
                                        </div>
                                    )}
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Tipe Cuti</label>
                                        <select name="type" required className="w-full border p-3 rounded-lg">
                                            <option value="Cuti Tahunan">Cuti Tahunan</option>
                                            <option value="Sakit">Sakit</option>
                                            <option value="Izin">Izin</option>
                                            <option value="Lainnya">Lainnya</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Tanggal Mulai</label>
                                        <input type="date" name="startDate" required className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Tanggal Selesai</label>
                                        <input type="date" name="endDate" required className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Alasan</label>
                                        <textarea name="reason" required className="w-full border p-3 rounded-lg" rows="3"></textarea>
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
                                            {loading ? 'Proses...' : 'Ajukan'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {modal === 'shift' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">Buat Shift Baru</h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleCreateShift({
                                        name: fd.get('name'),
                                        startTime: fd.get('startTime'),
                                        endTime: fd.get('endTime')
                                    });
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Nama Shift</label>
                                        <input type="text" name="name" required placeholder="e.g. Shift Pagi" className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Jam Mulai</label>
                                        <input type="time" name="startTime" required className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Jam Selesai</label>
                                        <input type="time" name="endTime" required className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
                                            {loading ? 'Proses...' : 'Buat Shift'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // ==================== END HR MANAGER ====================

        // ==================== AI ASSISTANT (PREMIUM FEATURE) ====================
        const AIAssistant = () => {
            const { activeOwner, activeStore, availableStores } = useContext(SessionContext);
            const oid = activeOwner?.id || 'default';
            // provider: 'groq' | 'gemini'
            const [provider, setProvider] = useState(() => localStorage.getItem(`ai_provider_${oid}`) || 'groq');
            const groqKey = `groq_api_key_${oid}`;
            const geminiKey = `gemini_api_key_${oid}`;
            const [apiKey, setApiKey] = useState(() => {
                const p = localStorage.getItem(`ai_provider_${oid}`) || 'groq';
                return p === 'groq'
                    ? (localStorage.getItem(`groq_api_key_${oid}`) || localStorage.getItem('groq_api_key') || '')
                    : (localStorage.getItem(`gemini_api_key_${oid}`) || localStorage.getItem('gemini_api_key') || '');
            });

            // ‚îÄ‚îÄ Trial Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const trialInfo = useMemo(() => {
                const now = new Date();
                // Semua config trial berasal dari accessRights owner record (per-tenant)
                const tr = activeOwner?.accessRights || {};
                if (!tr.aiTrialEnabled) return { active: false, expired: false, remainingDays: 0, key: '', provider: 'groq' };

                // Priority 1: Tanggal akhir trial spesifik yang diset developer
                if (tr.aiTrialEndDate) {
                    const end = new Date(tr.aiTrialEndDate);
                    end.setHours(23, 59, 59, 999);
                    const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
                    return {
                        active: diff > 0,
                        expired: diff <= 0,
                        remainingDays: Math.max(0, diff),
                        key: tr.aiTrialKey || '',
                        provider: tr.aiTrialProvider || 'groq',
                        hasEndDate: true
                    };
                }

                // Priority 2: Durasi trial dihitung dari hari pertama owner buka AI
                const trialStartStorageKey = `ai_trial_start_${oid}`;
                let trialStart = localStorage.getItem(trialStartStorageKey);
                // Jika belum ada start date, buat baru hanya jika aiTrialDays masih > 0
                // (tidak auto-start lagi setelah clear localStorage ‚Üí trial dianggap habis)
                if (!trialStart) {
                    // Cek apakah masih dalam masa grace period 1 hari sejak aiTrialEnabled
                    // Jika tidak ada aiTrialStartedAt di accessRights ‚Üí expired
                    if (!tr.aiTrialStartedAt) {
                        return { active: false, expired: true, remainingDays: 0, key: '', provider: 'groq' };
                    }
                    trialStart = tr.aiTrialStartedAt;
                    localStorage.setItem(trialStartStorageKey, trialStart);
                }
                const trialDays = Math.max(1, parseInt(tr.aiTrialDays) || 7);
                const trialEnd = new Date(new Date(trialStart).getTime() + trialDays * 24 * 60 * 60 * 1000);
                const diff = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
                return {
                    active: diff > 0,
                    expired: diff <= 0,
                    remainingDays: Math.max(0, diff),
                    key: tr.aiTrialKey || '',
                    provider: tr.aiTrialProvider || 'groq',
                    trialEnd
                };
            }, [activeOwner, oid]);

            // Trial key tersedia jika: trial aktif, tidak punya key sendiri, dan key trial ada
            const isUsingTrial = trialInfo.active && !apiKey && !!trialInfo.key;
            const effectiveKey = isUsingTrial ? trialInfo.key : apiKey;
            const effectiveProvider = isUsingTrial ? trialInfo.provider : provider;

            // Tentukan layar yang ditampilkan:
            // 'setup'   ‚Üí tidak punya key sendiri & trial tidak aktif/tidak dikonfigurasi
            // 'expired' ‚Üí trial expired & tidak punya key sendiri
            // 'chat'    ‚Üí normal (punya key sendiri ATAU sedang trial)
            const [showSetup, setShowSetup] = useState(false);
            const [setupProvider, setSetupProvider] = useState(() => localStorage.getItem(`ai_provider_${oid}`) || 'groq');
            const [tempKey, setTempKey] = useState('');
            const [messages, setMessages] = useState([{
                role: 'assistant', id: 1,
                content: 'Halo! Saya **AI Assistant iFix Pro** ‚ú®\n\nSaya terhubung langsung ke **data realtime** toko Anda dan dapat membantu:\n‚Ä¢ üìä Laporan penjualan & item terlaris\n‚Ä¢ üîß Rekap servis, performa teknisi & keluhan terbanyak\n‚Ä¢ üì¶ Analisis stok, kategori & rekomendasi restock\n‚Ä¢ üí∞ Keuangan dashboard: pemasukan, pengeluaran, keuntungan bersih\n‚Ä¢ üõçÔ∏è Data pembelian & supplier\n‚Ä¢ üë• Data pelanggan & karyawan\n‚Ä¢ üí° Saran & insight bisnis berbasis data\n\nSemua angka yang saya tampilkan **sama persis** dengan yang ada di Dashboard!\n\nKetik pertanyaan Anda atau pilih **perintah cepat** di bawah.',
                timestamp: new Date()
            }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [fetchingData, setFetchingData] = useState(false);
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            const msgIdRef = useRef(2);
            const nextId = () => { msgIdRef.current += 1; return msgIdRef.current; };

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const quickCommands = [
                { icon: 'üìä', label: 'Laporan Penjualan', prompt: 'Buatkan laporan penjualan bulan ini secara lengkap: total omzet, jumlah transaksi, rata-rata transaksi, item terlaris, metode pembayaran, dan daftar transaksi terbaru' },
                { icon: 'üîß', label: 'Rekap Servis', prompt: 'Tampilkan rekap servis bulan ini: total unit masuk, yang selesai, yang masih proses, antrian, pendapatan servis, brand HP terbanyak, performa teknisi, dan keluhan terbanyak' },
                { icon: 'üì¶', label: 'Analisis Stok', prompt: 'Analisis kondisi stok inventori saat ini: produk hampir habis, stok habis, nilai total stok (harga jual dan modal), breakdown per kategori, dan rekomendasi pengadaan' },
                { icon: 'üí∞', label: 'Dashboard Keuangan', prompt: 'Buat laporan keuangan lengkap sesuai dashboard: pemasukan, pengeluaran, untung jasa, untung penjualan, kompensasi retur, total keuntungan bersih, dan breakdown per kategori transaksi' },
                { icon: 'üèÜ', label: 'Top Produk Terlaris', prompt: 'Tampilkan 10 produk dan item terlaris berdasarkan data penjualan bulan ini, beserta jumlah terjual dan total pendapatan per item' },
                { icon: 'üí°', label: 'Saran Bisnis', prompt: 'Berdasarkan semua data toko (penjualan, servis, stok, keuangan), berikan analisis mendalam dan saran bisnis konkret untuk meningkatkan penjualan, efisiensi operasional, dan profitabilitas' },
            ];

            const fetchContextData = async (userMessage) => {
                const msg = userMessage.toLowerCase();
                const ownerId = activeOwner?.id;
                if (!ownerId) return {};

                // ‚îÄ‚îÄ 1. Parse nama cabang/toko dari pesan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                let targetStoreId = (activeStore?.id && activeStore.id !== 'all') ? activeStore.id : null;
                let targetStoreName = activeStore?.name || 'Semua Toko';
                if (availableStores && availableStores.length > 0) {
                    for (const s of availableStores) {
                        const sName = (s.name || '').toLowerCase();
                        // cocokkan potongan kata dari nama toko (min 4 karakter)
                        const words = sName.split(/\s+/).filter(w => w.length >= 4);
                        const matched = words.some(w => msg.includes(w)) || msg.includes(sName);
                        if (matched) {
                            targetStoreId = s.id;
                            targetStoreName = s.name;
                            break;
                        }
                    }
                }

                // ‚îÄ‚îÄ 2. Parse periode/rentang tanggal dari pesan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const now = new Date();
                const MONTHS_ID = ['januari','februari','maret','april','mei','juni','juli','agustus','september','oktober','november','desember'];
                let dateFrom = null, dateTo = null, periodeLabel = 'Bulan Ini';

                // Deteksi "bulan <nama>" atau "bulan ke-N"
                const monthMatch = msg.match(/\b(januari|februari|maret|april|mei|juni|juli|agustus|september|oktober|november|desember)\b/);
                if (monthMatch) {
                    const mIdx = MONTHS_ID.indexOf(monthMatch[1]);
                    // Tahun: cari 4 digit atau pakai tahun berjalan/lalu
                    const yearMatch = msg.match(/\b(202\d)\b/);
                    let yr = yearMatch ? parseInt(yearMatch[1]) : now.getFullYear();
                    // Jika bulan tsb belum tiba tahun ini, pakai tahun lalu
                    if (!yearMatch && mIdx > now.getMonth()) yr = yr - 1;
                    dateFrom = new Date(yr, mIdx, 1);
                    dateTo   = new Date(yr, mIdx + 1, 0, 23, 59, 59);
                    periodeLabel = `${monthMatch[1].charAt(0).toUpperCase() + monthMatch[1].slice(1)} ${yr}`;
                } else if (/bulan lalu|bulan kemarin/.test(msg)) {
                    const d = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    dateFrom = d;
                    dateTo   = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                    periodeLabel = 'Bulan Lalu';
                } else if (/tahun ini/.test(msg)) {
                    dateFrom = new Date(now.getFullYear(), 0, 1);
                    dateTo   = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                    periodeLabel = `Tahun ${now.getFullYear()}`;
                } else if (/tahun lalu/.test(msg)) {
                    dateFrom = new Date(now.getFullYear() - 1, 0, 1);
                    dateTo   = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59);
                    periodeLabel = `Tahun ${now.getFullYear() - 1}`;
                } else if (/hari ini|today/.test(msg)) {
                    dateFrom = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                    dateTo   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    periodeLabel = 'Hari Ini';
                } else if (/semua|seluruh|all|keseluruhan/.test(msg)) {
                    dateFrom = null; dateTo = null;
                    periodeLabel = 'Semua Waktu';
                } else {
                    // default: bulan ini
                    dateFrom = new Date(now.getFullYear(), now.getMonth(), 1);
                    dateTo   = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    periodeLabel = `Bulan Ini (${now.toLocaleDateString('id-ID',{month:'long',year:'numeric'})})`;
                }

                const fmtPB = d => d.toISOString().slice(0, 19).replace('T', ' ');
                const storeFilter = targetStoreId ? `&&storeId="${targetStoreId}"` : '';
                const baseFilter  = `ownerId="${ownerId}"${storeFilter}`;
                const dateFilter  = dateFrom && dateTo ? `&&created>='${fmtPB(dateFrom)}'&&created<='${fmtPB(dateTo)}'` : '';

                let adminToken = null;
                try { adminToken = await getAdminToken(); } catch(e) {}
                const headers = { 'Authorization': adminToken || pb.authStore.token || '' };

                const fetchCol = async (col, extraFilter, fields, perPage) => {
                    try {
                        const filter = baseFilter + (extraFilter || '') + (col !== 'inventory' && col !== 'customers' ? dateFilter : '');
                        let url = `${POCKETBASE_URL}/api/collections/${col}/records?perPage=${perPage || 300}&sort=-created&filter=${encodeURIComponent(filter)}`;
                        if (fields) url += `&fields=${fields}`;
                        const res = await fetch(url, { headers });
                        if (!res.ok) return [];
                        const d = await res.json();
                        return d.items || [];
                    } catch(e) { return []; }
                };

                const ctx = { _meta: { storeName: targetStoreName, periode: periodeLabel } };
                const wantsSales     = /jual|pendapat|omzet|laporan|revenue|transaksi.*jual|pelangg.*beli|penjualan|sale|terlaris|top.?produk/i.test(msg);
                const wantsService   = /servis|service|repair|teknis|hp|gadget|device|keluhan|unit|garansi|teknisi|antri/i.test(msg);
                const wantsInventory = /stok|inventori|produk|barang|sparepart|habis|stock|inventory|item|kategori/i.test(msg);
                const wantsFinance   = /kas|keuangan|untung|rugi|profit|modal|pengeluaran|pemasuk|saldo|laba|margin|keuntungan|income|expense|arus.*kas|cash|neraca|revenue|pendapatan|retur|kompensasi/i.test(msg);
                const wantsCustomer  = /pelanggan|customer|klien|pembeli|langganan/i.test(msg);
                const wantsPurchase  = /beli|pembelian|purchase|restok|restock|kulak|supplier|pemasok/i.test(msg);
                const wantsHR        = /karyawan|pegawai|employee|gaji|payroll|absen|kehadiran|cuti|shift|staff|hr/i.test(msg);
                const isGeneral      = !wantsSales && !wantsService && !wantsInventory && !wantsFinance && !wantsCustomer && !wantsPurchase && !wantsHR;
                const wantsDashboard = /dashboard|ringkasan|summary|rangkuman|overview|rekap|laporan/i.test(msg);

                const promises = [];
                // Sales data
                if (wantsSales || wantsDashboard || isGeneral) promises.push(fetchCol('sales', '', 'id,total,customerName,created,paymentMethod,items,discount', 500).then(d => { ctx.sales = d; }));
                // Services data
                if (wantsService || wantsDashboard || isGeneral) promises.push(fetchCol('services', '', 'id,customerName,deviceBrand,deviceModel,status,total,created,technicians,problem,completedAt,warrantyDays,customerPhone,usedParts', 500).then(d => { ctx.services = d; }));
                // Transactions data (CRITICAL: matches Dashboard financial calculations)
                if (wantsFinance || wantsDashboard || wantsSales || wantsService || isGeneral) promises.push(fetchCol('transactions', '', 'id,type,amount,category,description,created', 500).then(d => { ctx.transactions = d; }));
                // Inventory data
                if (wantsInventory || wantsDashboard || isGeneral) promises.push(fetchCol('inventory', '', 'id,name,stock,sellPrice,buyPrice,category,subCategory,minStock,brand', 500).then(d => { ctx.inventory = d; }));
                // Cash flow data
                if (wantsFinance || wantsDashboard) promises.push(fetchCol('cash_flow', '', 'id,type,amount,description,category,account,created', 500).then(d => { ctx.cashFlow = d; }));
                // Customer data
                if (wantsCustomer || wantsDashboard) promises.push(fetchCol('customers', '', 'id,name,phone,address,totalTransactions,created,customerType', 500).then(d => { ctx.customers = d; }));
                // Purchase data
                if (wantsPurchase || wantsDashboard) promises.push(fetchCol('purchases', '', 'id,supplierName,items,total,paymentMethod,created,notes', 300).then(d => { ctx.purchases = d; }));
                // Supplier data
                if (wantsPurchase || wantsDashboard) promises.push(fetchCol('suppliers', '', 'id,name,phone,address,created', 300).then(d => { ctx.suppliers = d; }));
                // Employee/Users data
                if (wantsHR || wantsDashboard) {
                    promises.push(fetchCol('users', '', 'id,name,email,role,created', 100).then(d => { ctx.employees = d; }));
                }
                await Promise.all(promises);
                return ctx;
            };

            const buildContext = (ctx) => {
                const lines = [];
                const ownerName = activeOwner?.name || 'Toko';
                const storeName = ctx._meta?.storeName || activeStore?.name || 'Semua Toko';
                const periodeLabel = ctx._meta?.periode || 'Bulan Ini';
                const fmt = n => 'Rp ' + (Number(n) || 0).toLocaleString('id-ID');

                lines.push(`=== DATA REALTIME TOKO: ${ownerName} | Cabang: ${storeName} | Periode: ${periodeLabel} ===`);
                lines.push(`Tanggal laporan: ${new Date().toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'})}`);

                // ‚îÄ‚îÄ TRANSACTIONS (Dashboard financial metrics - SAME as Dashboard component) ‚îÄ‚îÄ
                if (ctx.transactions) {
                    const trans = ctx.transactions;
                    const income_trans = trans.filter(t => t.type === 'income');
                    const expense_trans = trans.filter(t => t.type === 'expense');
                    const profit_trans = trans.filter(t => t.type === 'profit');
                    const loss_trans = trans.filter(t => t.type === 'loss');

                    const service_income = income_trans.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                    const expense = expense_trans.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                    const profit_total = profit_trans.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                    const profit_jasa = profit_trans.filter(t => (t.category || '').includes('Jasa')).reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                    const profit_penjualan = profit_total - profit_jasa;
                    const loss_total = loss_trans.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                    const service_income_only = income_trans.filter(t => (t.category || '').includes('Servis')).reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);

                    // Kompensasi Retur (sama persis dengan Dashboard)
                    const kompensasi_retur_penjualan = income_trans.filter(t => t.category === 'Kompensasi Retur Penjualan').reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                    const kompensasi_retur_pembelian = expense_trans.filter(t => t.category === 'Kompensasi Retur Pembelian').reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                    const keuntungan = profit_jasa + profit_penjualan - kompensasi_retur_penjualan - kompensasi_retur_pembelian;
                    const netProfit = service_income - expense;

                    lines.push(`\nüí∞ KEUANGAN DASHBOARD (${trans.length} transaksi keuangan):`);
                    lines.push(`Pemasukan Total: ${fmt(service_income)} (${income_trans.length} transaksi)`);
                    lines.push(`  ‚Üí Pendapatan Servis: ${fmt(service_income_only)}`);
                    lines.push(`Pengeluaran Total: ${fmt(expense)} (${expense_trans.length} transaksi)`);
                    lines.push(`Untung Jasa Servis: ${fmt(profit_jasa)}`);
                    lines.push(`Untung Penjualan: ${fmt(profit_penjualan)}`);
                    lines.push(`Kerugian: ${fmt(loss_total)}`);
                    if (kompensasi_retur_penjualan > 0) lines.push(`Kompensasi Retur Penjualan: ${fmt(kompensasi_retur_penjualan)}`);
                    if (kompensasi_retur_pembelian > 0) lines.push(`Kompensasi Retur Pembelian: ${fmt(kompensasi_retur_pembelian)}`);
                    lines.push(`‚≠ê TOTAL KEUNTUNGAN BERSIH: ${fmt(keuntungan)}`);
                    lines.push(`Saldo Bersih (Pemasukan - Pengeluaran): ${fmt(netProfit)}`);

                    // Breakdown by category
                    const byCat = trans.reduce((a, t) => {
                        const cat = t.category || t.type;
                        if (!a[cat]) a[cat] = { income: 0, expense: 0, profit: 0, loss: 0, count: 0 };
                        a[cat][t.type] = (a[cat][t.type] || 0) + (parseFloat(t.amount) || 0);
                        a[cat].count++;
                        return a;
                    }, {});
                    lines.push('Breakdown per Kategori:');
                    Object.entries(byCat).sort((a, b) => b[1].count - a[1].count).slice(0, 15).forEach(([cat, val]) => {
                        const parts = [];
                        if (val.income > 0) parts.push(`Masuk: ${fmt(val.income)}`);
                        if (val.expense > 0) parts.push(`Keluar: ${fmt(val.expense)}`);
                        if (val.profit > 0) parts.push(`Profit: ${fmt(val.profit)}`);
                        if (val.loss > 0) parts.push(`Rugi: ${fmt(val.loss)}`);
                        lines.push(`  ‚Ä¢ ${cat}: ${parts.join(' | ')} (${val.count}x)`);
                    });
                }

                // ‚îÄ‚îÄ PENJUALAN ‚îÄ‚îÄ
                if (ctx.sales) {
                    const total = ctx.sales.reduce((s, i) => s + (parseFloat(i.total) || 0), 0);
                    const avg = ctx.sales.length > 0 ? total / ctx.sales.length : 0;
                    const totalDiscount = ctx.sales.reduce((s, i) => s + (parseFloat(i.discount) || 0), 0);
                    lines.push(`\nüìä PENJUALAN (${ctx.sales.length} transaksi):`);
                    lines.push(`Total Omzet: ${fmt(total)} | Rata-rata/transaksi: ${fmt(avg)}`);
                    if (totalDiscount > 0) lines.push(`Total Diskon: ${fmt(totalDiscount)}`);
                    const byPm = ctx.sales.reduce((a, s) => { const pm = s.paymentMethod || 'Tunai'; a[pm] = (a[pm] || 0) + (parseFloat(s.total) || 0); return a; }, {});
                    lines.push('Metode Bayar: ' + Object.entries(byPm).map(([k, v]) => `${k}: ${fmt(v)} (${ctx.sales.filter(s => (s.paymentMethod || 'Tunai') === k).length}x)`).join(' | '));

                    // Top items sold
                    const allItems = ctx.sales.flatMap(s => (s.items || []).map(item => ({ name: item.name || item.productName || 'Unknown', qty: item.qty || 1, total: (item.sellPrice || item.price || 0) * (item.qty || 1) })));
                    if (allItems.length > 0) {
                        const byItem = allItems.reduce((a, item) => { if (!a[item.name]) a[item.name] = { qty: 0, total: 0 }; a[item.name].qty += item.qty; a[item.name].total += item.total; return a; }, {});
                        const topItems = Object.entries(byItem).sort((a, b) => b[1].qty - a[1].qty).slice(0, 10);
                        lines.push('Top 10 Item Terlaris:');
                        topItems.forEach(([name, data], i) => lines.push(`  ${i+1}. ${name} | Terjual: ${data.qty} pcs | Total: ${fmt(data.total)}`));
                    }

                    // Per-day breakdown (last 7 days)
                    const byDay = ctx.sales.reduce((a, s) => { const day = s.created ? new Date(s.created).toLocaleDateString('id-ID') : '-'; if (!a[day]) a[day] = { count: 0, total: 0 }; a[day].count++; a[day].total += parseFloat(s.total) || 0; return a; }, {});
                    const dayEntries = Object.entries(byDay).slice(0, 7);
                    if (dayEntries.length > 1) {
                        lines.push('Penjualan per Hari (7 hari terakhir):');
                        dayEntries.forEach(([day, data]) => lines.push(`  ‚Ä¢ ${day}: ${data.count} transaksi = ${fmt(data.total)}`));
                    }

                    lines.push(`Detail 20 transaksi terakhir:`);
                    ctx.sales.slice(0, 20).forEach(s => {
                        const tgl = s.created ? new Date(s.created).toLocaleDateString('id-ID') : '-';
                        lines.push(`  ‚Ä¢ ${tgl} | ${s.customerName || 'Umum'} | ${fmt(s.total)} | ${s.paymentMethod || 'Tunai'}`);
                    });
                    if (ctx.sales.length > 20) lines.push(`  ...dan ${ctx.sales.length - 20} transaksi lainnya`);
                }

                // ‚îÄ‚îÄ SERVIS ‚îÄ‚îÄ
                if (ctx.services) {
                    const selesai = ctx.services.filter(s => s.status === 'Selesai');
                    const diambil = ctx.services.filter(s => s.status === 'Diambil');
                    const proses = ctx.services.filter(s => ['Dikerjakan', 'Menunggu Sparepart'].includes(s.status));
                    const antrian = ctx.services.filter(s => ['Diterima', 'Diagnosa'].includes(s.status));
                    const dibatalkan = ctx.services.filter(s => s.status === 'Dibatalkan');
                    const totalServis = selesai.reduce((s, i) => s + (parseFloat(i.total) || 0), 0);
                    lines.push(`\nüîß SERVIS (${ctx.services.length} unit):`);
                    lines.push(`Antrian: ${antrian.length} | Dikerjakan: ${proses.length} | Selesai: ${selesai.length} | Diambil: ${diambil.length}${dibatalkan.length > 0 ? ` | Dibatalkan: ${dibatalkan.length}` : ''}`);
                    lines.push(`Pendapatan Servis Selesai: ${fmt(totalServis)}`);

                    // Brand analysis
                    const byBrand = ctx.services.reduce((a, s) => { const b = s.deviceBrand || 'Lainnya'; a[b] = (a[b] || 0) + 1; return a; }, {});
                    const topBrands = Object.entries(byBrand).sort((a, b) => b[1] - a[1]).slice(0, 10);
                    lines.push('Brand HP terbanyak: ' + topBrands.map(([b, n]) => `${b}(${n})`).join(', '));

                    // Technician performance
                    const techMap = {};
                    ctx.services.forEach(s => {
                        (s.technicians || []).forEach(t => {
                            if (!techMap[t]) techMap[t] = { total: 0, selesai: 0, revenue: 0 };
                            techMap[t].total++;
                            if (s.status === 'Selesai' || s.status === 'Diambil') {
                                techMap[t].selesai++;
                                techMap[t].revenue += parseFloat(s.total) || 0;
                            }
                        });
                    });
                    if (Object.keys(techMap).length > 0) {
                        lines.push('Performa Teknisi:');
                        Object.entries(techMap).sort((a, b) => b[1].selesai - a[1].selesai).forEach(([name, data]) => {
                            lines.push(`  ‚Ä¢ ${name}: ${data.selesai}/${data.total} selesai | Revenue: ${fmt(data.revenue)}`);
                        });
                    }

                    // Common problems
                    const problems = ctx.services.reduce((a, s) => { const p = (s.problem || '').trim(); if (p) { a[p] = (a[p] || 0) + 1; } return a; }, {});
                    const topProblems = Object.entries(problems).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    if (topProblems.length > 0) {
                        lines.push('Keluhan Terbanyak:');
                        topProblems.forEach(([p, n]) => lines.push(`  ‚Ä¢ ${p} (${n}x)`));
                    }

                    lines.push(`Detail 15 servis terakhir:`);
                    ctx.services.slice(0, 15).forEach(s => {
                        const tgl = s.created ? new Date(s.created).toLocaleDateString('id-ID') : '-';
                        lines.push(`  ‚Ä¢ ${tgl} | ${s.customerName || '-'} | ${s.deviceBrand || ''} ${s.deviceModel || ''} | ${s.status} | ${fmt(s.total)} | Teknisi: ${(s.technicians || []).join(', ') || '-'}`);
                    });
                }

                // ‚îÄ‚îÄ INVENTORI ‚îÄ‚îÄ
                if (ctx.inventory) {
                    const lowStock = ctx.inventory.filter(i => (i.stock || 0) <= (i.minStock ?? 0) && (i.stock || 0) > 0);
                    const outOfStock = ctx.inventory.filter(i => (i.stock || 0) <= 0);
                    const totalVal = ctx.inventory.reduce((s, i) => s + ((i.sellPrice || 0) * (i.stock || 0)), 0);
                    const totalBuyVal = ctx.inventory.reduce((s, i) => s + ((i.buyPrice || 0) * (i.stock || 0)), 0);
                    const potentialProfit = totalVal - totalBuyVal;
                    lines.push(`\nüì¶ INVENTORI (${ctx.inventory.length} produk):`);
                    lines.push(`Nilai Stok (Harga Jual): ${fmt(totalVal)}`);
                    lines.push(`Nilai Stok (Harga Beli/Modal): ${fmt(totalBuyVal)}`);
                    lines.push(`Potensi Margin: ${fmt(potentialProfit)}`);
                    lines.push(`Stok Menipis: ${lowStock.length} | Stok Habis: ${outOfStock.length}`);

                    // Category breakdown
                    const byCat = ctx.inventory.reduce((a, i) => { const c = i.category || 'Tanpa Kategori'; if (!a[c]) a[c] = { count: 0, stock: 0, value: 0 }; a[c].count++; a[c].stock += (i.stock || 0); a[c].value += ((i.sellPrice || 0) * (i.stock || 0)); return a; }, {});
                    if (Object.keys(byCat).length > 1) {
                        lines.push('Breakdown per Kategori:');
                        Object.entries(byCat).sort((a, b) => b[1].value - a[1].value).forEach(([cat, data]) => {
                            lines.push(`  ‚Ä¢ ${cat}: ${data.count} produk | Total stok: ${data.stock} | Nilai: ${fmt(data.value)}`);
                        });
                    }

                    if (outOfStock.length > 0) {
                        lines.push('üî¥ Stok HABIS (perlu restock):');
                        outOfStock.slice(0, 10).forEach(i => lines.push(`  ‚õî ${i.name} | Kategori: ${i.category || '-'}${i.brand ? ` | Brand: ${i.brand}` : ''}`));
                        if (outOfStock.length > 10) lines.push(`  ...dan ${outOfStock.length - 10} item lainnya`);
                    }
                    if (lowStock.length > 0) {
                        lines.push('‚ö†Ô∏è Stok MENIPIS:');
                        lowStock.slice(0, 10).forEach(i => lines.push(`  ‚ö†Ô∏è ${i.name} | Stok: ${i.stock} | Min: ${i.minStock ?? 0}`));
                    }
                    lines.push('Top 10 produk by nilai stok:');
                    [...ctx.inventory].sort((a, b) => ((b.sellPrice || 0) * (b.stock || 0)) - ((a.sellPrice || 0) * (a.stock || 0))).slice(0, 10).forEach(i => {
                        lines.push(`  ‚Ä¢ ${i.name} | Stok: ${i.stock} | Beli: ${fmt(i.buyPrice)} | Jual: ${fmt(i.sellPrice)} | Margin: ${fmt((i.sellPrice || 0) - (i.buyPrice || 0))} | Nilai: ${fmt((i.sellPrice || 0) * (i.stock || 0))}`);
                    });
                }

                // ‚îÄ‚îÄ KAS / CASH FLOW ‚îÄ‚îÄ
                if (ctx.cashFlow) {
                    const masuk = ctx.cashFlow.filter(c => c.type === 'in').reduce((s, c) => s + (parseFloat(c.amount) || 0), 0);
                    const keluar = ctx.cashFlow.filter(c => c.type === 'out').reduce((s, c) => s + (parseFloat(c.amount) || 0), 0);
                    lines.push(`\nüè¶ ARUS KAS (${ctx.cashFlow.length} entri):`);
                    lines.push(`Kas Masuk: ${fmt(masuk)} | Kas Keluar: ${fmt(keluar)} | Saldo: ${fmt(masuk - keluar)}`);

                    // By account
                    const byAccount = ctx.cashFlow.reduce((a, c) => { const acc = c.account || 'Kas Tunai'; if (!a[acc]) a[acc] = { in: 0, out: 0 }; a[acc][c.type === 'in' ? 'in' : 'out'] += parseFloat(c.amount) || 0; return a; }, {});
                    if (Object.keys(byAccount).length > 1) {
                        lines.push('Per Akun/Rekening:');
                        Object.entries(byAccount).forEach(([acc, val]) => lines.push(`  ‚Ä¢ ${acc}: Masuk ${fmt(val.in)} | Keluar ${fmt(val.out)} | Net ${fmt(val.in - val.out)}`));
                    }

                    const byCat = ctx.cashFlow.reduce((a, c) => { const cat = c.category || (c.type === 'in' ? 'Pemasukan Lain' : 'Pengeluaran Lain'); if (!a[cat]) a[cat] = { in: 0, out: 0 }; a[cat][c.type === 'in' ? 'in' : 'out'] += parseFloat(c.amount) || 0; return a; }, {});
                    lines.push('Breakdown kategori:');
                    Object.entries(byCat).forEach(([cat, val]) => {
                        if (val.in > 0) lines.push(`  + ${cat}: ${fmt(val.in)}`);
                        if (val.out > 0) lines.push(`  - ${cat}: ${fmt(val.out)}`);
                    });
                }

                // ‚îÄ‚îÄ PELANGGAN ‚îÄ‚îÄ
                if (ctx.customers) {
                    const salesCust = ctx.customers.filter(c => (c.customerType || '') === 'sales' || !c.customerType);
                    const serviceCust = ctx.customers.filter(c => (c.customerType || '') === 'service');
                    lines.push(`\nüë• PELANGGAN: ${ctx.customers.length} terdaftar`);
                    if (salesCust.length > 0 || serviceCust.length > 0) lines.push(`  Pelanggan Penjualan: ${salesCust.length} | Pelanggan Servis: ${serviceCust.length}`);
                    const top10 = [...ctx.customers].sort((a, b) => (b.totalTransactions || 0) - (a.totalTransactions || 0)).slice(0, 10);
                    lines.push('Top 10 pelanggan:');
                    top10.forEach((c, i) => lines.push(`  ${i+1}. ${c.name} | ${c.phone || '-'} | Transaksi: ${c.totalTransactions || 0}x`));
                }

                // ‚îÄ‚îÄ PEMBELIAN / PURCHASE ‚îÄ‚îÄ
                if (ctx.purchases) {
                    const totalPurchase = ctx.purchases.reduce((s, p) => s + (parseFloat(p.total) || 0), 0);
                    lines.push(`\nüõçÔ∏è PEMBELIAN/RESTOK (${ctx.purchases.length} transaksi):`);
                    lines.push(`Total Pembelian: ${fmt(totalPurchase)}`);
                    const bySupplier = ctx.purchases.reduce((a, p) => { const s = p.supplierName || 'Unknown'; if (!a[s]) a[s] = { count: 0, total: 0 }; a[s].count++; a[s].total += parseFloat(p.total) || 0; return a; }, {});
                    lines.push('Per Supplier:');
                    Object.entries(bySupplier).sort((a, b) => b[1].total - a[1].total).forEach(([s, d]) => lines.push(`  ‚Ä¢ ${s}: ${d.count}x pembelian = ${fmt(d.total)}`));
                    ctx.purchases.slice(0, 10).forEach(p => {
                        const tgl = p.created ? new Date(p.created).toLocaleDateString('id-ID') : '-';
                        lines.push(`  ‚Ä¢ ${tgl} | ${p.supplierName || '-'} | ${fmt(p.total)} | ${p.paymentMethod || 'Tunai'}`);
                    });
                }

                // ‚îÄ‚îÄ SUPPLIER ‚îÄ‚îÄ
                if (ctx.suppliers) {
                    lines.push(`\nüöö SUPPLIER: ${ctx.suppliers.length} terdaftar`);
                    ctx.suppliers.slice(0, 10).forEach(s => lines.push(`  ‚Ä¢ ${s.name} | ${s.phone || '-'} | ${s.address || '-'}`));
                }

                // ‚îÄ‚îÄ KARYAWAN ‚îÄ‚îÄ
                if (ctx.employees) {
                    const owners = ctx.employees.filter(e => e.role === 'owner');
                    const staff = ctx.employees.filter(e => e.role === 'employee' || e.role === 'kasir' || e.role === 'technician');
                    lines.push(`\nüëî KARYAWAN: ${ctx.employees.length} user (Owner: ${owners.length} | Staff: ${staff.length})`);
                    ctx.employees.forEach(e => lines.push(`  ‚Ä¢ ${e.name || e.email} | Role: ${e.role}`));
                }

                return lines.join('\n');
            };

            const sendToAI = async (userMsg) => {
                const msg = (userMsg !== undefined ? userMsg : input).trim();
                if (!msg || loading) return;
                if (!effectiveKey) {
                    if (trialInfo.expired) {
                        // trial expired, no own key ‚Üí do nothing (screen will show)
                        return;
                    }
                    setShowSetup(true);
                    return;
                }
                setInput('');
                setLoading(true);
                setFetchingData(true);
                const userMsgObj = { role: 'user', id: nextId(), content: msg, timestamp: new Date() };
                setMessages(prev => [...prev, userMsgObj]);
                const sleep = (ms) => new Promise(res => setTimeout(res, ms));
                const sysPrompt = `Kamu adalah AI Assistant premium iFix Pro Enterprise ‚Äî sistem manajemen toko servis HP & penjualan sparepart di Indonesia. Tugasmu membantu owner menganalisis data bisnis toko secara AKURAT berdasarkan data realtime yang diberikan.

ATURAN PENTING:
1. SELALU gunakan angka PERSIS dari data yang diberikan. JANGAN mengarang atau memperkirakan angka.
2. Jika data tidak tersedia, katakan "data tidak tersedia" daripada menebak.
3. Data yang diberikan adalah data LIVE langsung dari database PocketBase toko.
4. Bagian "KEUANGAN DASHBOARD" berisi data yang SAMA PERSIS dengan tampilan Dashboard aplikasi (pemasukan, pengeluaran, profit jasa, profit penjualan, kompensasi retur, dan total keuntungan).
5. Gunakan rumus keuntungan yang sama dengan Dashboard: Total Keuntungan = Untung Jasa + Untung Penjualan - Kompensasi Retur Penjualan - Kompensasi Retur Pembelian.
6. Untuk data penjualan, bedakan antara "PENJUALAN" (dari POS/kasir) dan "PEMASUKAN" (dari transaksi keuangan yang mungkin termasuk servis).

Cara merespons:
- Respons informatif, actionable, berbasis data
- Format rapi: heading (##), sub-heading (###), bullet (‚Ä¢), angka format Rp 1.500.000
- Ringkasan eksekutif singkat di awal, lalu detail data
- Sertakan insight bisnis & rekomendasi yang actionable
- Bahasa Indonesia profesional & ramah
- Highlight anomali, peluang, atau masalah yang terdeteksi dari data
- Jika diminta laporan, tampilkan data lengkap dalam format tabel/list yang terstruktur
- Bandingkan metrik jika data memungkinkan (misal: hari terbaik vs terburuk)`;
                try {
                    const ctx = await fetchContextData(msg);
                    setFetchingData(false);
                    const dataCtx = buildContext(ctx);
                    let aiText = null;

                    // ‚îÄ‚îÄ GROQ (primary) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (effectiveProvider === 'groq') {
                        const GROQ_MODELS = ['llama-3.3-70b-versatile', 'llama-3.1-8b-instant', 'mixtral-8x7b-32768'];
                        const historyMsgs = messages.slice(-6).map(m => ({ role: m.role === 'assistant' ? 'assistant' : 'user', content: m.content }));
                        historyMsgs.push({ role: 'user', content: `DATA TOKO REALTIME:\n${dataCtx}\n\n---\nPERTANYAAN: ${msg}` });
                        for (let mi = 0; mi < GROQ_MODELS.length; mi++) {
                            const model = GROQ_MODELS[mi];
                            for (let attempt = 0; attempt < 2; attempt++) {
                                if (attempt > 0 || mi > 0) {
                                    const info = attempt > 0 ? `‚è≥ Retry pada ${model}...` : `‚è≥ Beralih ke ${model}...`;
                                    setMessages(prev => { const u=[...prev]; u[u.length-1]={...u[u.length-1],retryInfo:info}; return u; });
                                    await sleep(attempt > 0 ? 4000 : 1000);
                                }
                                try {
                                    const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${effectiveKey}` },
                                        body: JSON.stringify({ model, messages: [{ role: 'system', content: sysPrompt }, ...historyMsgs], temperature: 0.7, max_tokens: 2048 })
                                    });
                                    const d = await r.json();
                                    if (r.ok) {
                                        aiText = d.choices?.[0]?.message?.content || 'Tidak ada respons.';
                                        if (mi > 0) aiText = `*(model: ${model})*\n\n` + aiText;
                                        break;
                                    }
                                    const errMsg = d.error?.message || `HTTP ${r.status}`;
                                    if (r.status === 401) throw new Error('üîë Groq API Key tidak valid. Cek kembali di console.groq.com');
                                    if (r.status === 429 || r.status === 503) { if (attempt < 1) continue; break; }
                                    if (r.status === 404) break; // model not found, coba model berikutnya
                                    throw new Error(errMsg);
                                } catch(e) { if (e.message.includes('API Key') || e.message.includes('tidak valid')) throw e; if (attempt < 1) continue; break; }
                            }
                            if (aiText) break;
                            if (mi < GROQ_MODELS.length - 1) await sleep(500);
                        }
                    }

                    // ‚îÄ‚îÄ GEMINI (alternatif) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (effectiveProvider === 'gemini' || (!aiText && effectiveProvider === 'groq')) {
                        const GEMINI_MODELS = ['gemini-2.0-flash', 'gemini-1.5-flash'];
                        const gemApiKey = effectiveProvider === 'gemini'
                            ? effectiveKey
                            : (localStorage.getItem(`gemini_api_key_${oid}`) || localStorage.getItem('gemini_api_key') || '');
                        if (gemApiKey) {
                            const hist = messages.slice(-6).map(m => ({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] }));
                            hist.push({ role: 'user', parts: [{ text: `DATA TOKO REALTIME:\n${dataCtx}\n\n---\nPERTANYAAN: ${msg}` }] });
                            const body = JSON.stringify({ systemInstruction: { parts: [{ text: sysPrompt }] }, contents: hist, generationConfig: { temperature: 0.7, maxOutputTokens: 2048 } });
                            for (let mi = 0; mi < GEMINI_MODELS.length; mi++) {
                                const model = GEMINI_MODELS[mi];
                                for (let attempt = 0; attempt < 2; attempt++) {
                                    if (attempt > 0 || mi > 0) await sleep(attempt > 0 ? 5000 : 1500);
                                    try {
                                        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${gemApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body });
                                        const d = await r.json();
                                        if (r.ok) { aiText = d.candidates?.[0]?.content?.parts?.[0]?.text || 'Tidak ada respons.'; break; }
                                        const em = d.error?.message || '';
                                        if (r.status === 400 && (em.includes('not found') || em.includes('not supported'))) break;
                                        if (r.status === 400 && (em.includes('api key') || em.includes('API_KEY'))) throw new Error('üîë Gemini API Key tidak valid.');
                                        if (r.status === 429 || r.status === 503) { if (attempt < 1) continue; break; }
                                        throw new Error(em || `HTTP ${r.status}`);
                                    } catch(e) { if (e.message.includes('API Key') || e.message.includes('tidak valid')) throw e; if (attempt < 1) continue; break; }
                                }
                                if (aiText) break;
                            }
                        }
                    }

                    if (!aiText) {
                        aiText = '‚è≥ Asisten AI sedang padat. Mohon tunggu 1‚Äì2 menit lalu coba lagi.';
                    }
                    setMessages(prev => [...prev, { role: 'assistant', id: nextId(), content: aiText, timestamp: new Date() }]);
                } catch (err) {
                    setFetchingData(false);
                    const errContent = err.message.includes('\n') ? err.message : `‚ùå **Error:** ${err.message}`;
                    setMessages(prev => [...prev, { role: 'assistant', id: nextId(), content: errContent, isError: true, timestamp: new Date(), retryMsg: msg }]);
                } finally {
                    setLoading(false);
                }
            };

            const saveKey = () => {
                const k = tempKey.trim();
                if (!k) return;
                if (setupProvider === 'groq') {
                    localStorage.setItem(groqKey, k);
                    localStorage.setItem('groq_api_key', k);
                } else {
                    localStorage.setItem(geminiKey, k);
                    localStorage.setItem('gemini_api_key', k);
                }
                localStorage.setItem(`ai_provider_${oid}`, setupProvider);
                setProvider(setupProvider);
                setApiKey(k);
                setShowSetup(false);
                setTempKey('');
            };

            const renderMsg = (text) => {
                if (!text) return '';
                const esc = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                let html = esc
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code style="background:#1e293b;padding:1px 5px;border-radius:3px;font-size:0.8em;color:#93c5fd">$1</code>');
                const lines = html.split('\n');
                let result = '';
                lines.forEach(line => {
                    const t = line.trim();
                    if (!t) { result += '<div style="height:6px"></div>'; return; }
                    if (t.startsWith('### ')) { result += `<div style="font-weight:700;font-size:0.9em;color:#a78bfa;margin-top:10px;margin-bottom:3px">${t.slice(4)}</div>`; return; }
                    if (t.startsWith('## ')) { result += `<div style="font-weight:700;font-size:1em;color:#818cf8;margin-top:12px;margin-bottom:4px">${t.slice(3)}</div>`; return; }
                    if (t.startsWith('# ')) { result += `<div style="font-weight:800;font-size:1.05em;color:#6366f1;margin-top:14px;margin-bottom:6px">${t.slice(2)}</div>`; return; }
                    if (t.startsWith('‚Ä¢ ') || t.startsWith('- ') || t.startsWith('* ')) {
                        result += `<div style="display:flex;gap:6px;margin:2px 0;padding-left:4px"><span style="color:#818cf8;flex-shrink:0;font-weight:700">‚Ä¢</span><span>${t.slice(2)}</span></div>`; return;
                    }
                    if (/^\d+\.\s/.test(t)) {
                        const m2 = t.match(/^(\d+\.)\s/);
                        result += `<div style="display:flex;gap:6px;margin:2px 0"><span style="color:#a78bfa;flex-shrink:0;font-weight:700">${m2[1]}</span><span>${t.replace(/^\d+\.\s/, '')}</span></div>`; return;
                    }
                    result += `<div style="margin:1px 0">${line}</div>`;
                });
                return result;
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Respons AI disalin ke clipboard!');
                }).catch(() => {});
            };

            // ‚îÄ‚îÄ Tentukan layar yang ditampilkan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 'setup'   ‚Üí tidak punya key sendiri & trial tidak aktif/tidak ada
            // 'expired' ‚Üí trial expired & tidak punya key sendiri
            // 'chat'    ‚Üí normal (punya key sendiri ATAU sedang trial dengan effectiveKey)
            let currentScreen = 'chat';
            if (showSetup) {
                currentScreen = 'setup';
            } else if (!apiKey) {
                if (trialInfo.active && trialInfo.key) {
                    currentScreen = 'chat'; // gunakan trial key
                } else if (trialInfo.expired) {
                    currentScreen = 'expired';
                } else {
                    currentScreen = 'setup'; // tidak ada trial atau trial belum dikonfigurasi
                }
            }

            if (currentScreen === 'setup') {
                const providerInfo = {
                    groq: {
                        name: 'Groq', gradient: 'from-orange-500 to-red-500',
                        badge: '‚ö° REKOMENDASI', badgeColor: 'bg-green-400 text-green-900',
                        desc: 'Gratis 30 req/menit ¬∑ Model Llama 3.3 70B ¬∑ Sangat cepat & stabil',
                        placeholder: 'gsk_... (paste Groq API Key)',
                        steps: [
                            { text: <>Buka <a href="https://console.groq.com/keys" target="_blank" className="text-orange-600 font-bold underline">console.groq.com/keys</a></> },
                            { text: <>Daftar/login gratis, klik <strong>"Create API Key"</strong></> },
                            { text: <>Copy API Key (diawali <strong>gsk_</strong>) dan paste di bawah</> },
                        ]
                    },
                    gemini: {
                        name: 'Google Gemini', gradient: 'from-blue-500 to-violet-600',
                        badge: 'üîµ ALTERNATIF', badgeColor: 'bg-blue-100 text-blue-800',
                        desc: 'Gratis 15 req/menit ¬∑ Model Gemini 2.0 Flash ¬∑ Bisa kena rate limit',
                        placeholder: 'AIzaSy... (paste Gemini API Key)',
                        steps: [
                            { text: <>Buka <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-600 font-bold underline">aistudio.google.com/app/apikey</a></> },
                            { text: <>Login Google, klik <strong>"Create API Key"</strong>, pilih project</> },
                            { text: <>Copy API Key (diawali <strong>AIza</strong>) dan paste di bawah</> },
                        ]
                    }
                };
                const pi = providerInfo[setupProvider];
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900/20 to-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                            <div className={`bg-gradient-to-r ${pi.gradient} p-7 text-center`}>
                                <div className="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-3 backdrop-blur-sm shadow-lg">
                                    <Brain className="w-9 h-9 text-white"/>
                                </div>
                                <h2 className="text-xl font-black text-white">AI Assistant Setup</h2>
                                <p className="text-white/80 text-xs mt-1">iFix Pro Enterprise ¬∑ Pilih Provider AI</p>
                            </div>
                            <div className="p-5">
                                {/* Provider selector */}
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    {['groq','gemini'].map(p => (
                                        <button key={p} onClick={() => { setSetupProvider(p); setTempKey(''); }}
                                            className={`border-2 rounded-xl p-3 text-left transition-all ${
                                                setupProvider === p ? 'border-orange-400 bg-orange-50' : 'border-slate-200 hover:border-slate-300'
                                            }`}>
                                            <div className="flex items-center justify-between mb-1">
                                                <span className="font-bold text-sm text-slate-800">{providerInfo[p].name}</span>
                                                {setupProvider === p && <Check className="w-4 h-4 text-orange-500"/>}
                                            </div>
                                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full ${providerInfo[p].badgeColor}`}>{providerInfo[p].badge}</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="bg-slate-50 border border-slate-200 rounded-xl p-3 mb-4">
                                    <p className="text-xs text-slate-600">{pi.desc}</p>
                                </div>
                                <div className="space-y-2 mb-4 text-xs text-slate-600">
                                    {pi.steps.map((s, i) => (
                                        <div key={i} className="flex items-start gap-2.5 bg-slate-50 rounded-lg p-2.5">
                                            <span className={`bg-gradient-to-r ${pi.gradient} text-white w-5 h-5 rounded-full flex items-center justify-center font-bold flex-shrink-0 text-[10px]`}>{i+1}</span>
                                            <div>{s.text}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="space-y-2">
                                    <input type="text" value={tempKey} onChange={e => setTempKey(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && saveKey()}
                                        placeholder={pi.placeholder}
                                        className="w-full border-2 border-slate-200 rounded-xl px-4 py-2.5 text-sm font-mono focus:outline-none focus:border-orange-400 transition-colors"
                                    />
                                    <button onClick={saveKey} disabled={!tempKey.trim()}
                                        className={`w-full py-3 bg-gradient-to-r ${pi.gradient} text-white rounded-xl font-bold text-sm transition-all disabled:opacity-50 flex items-center justify-center gap-2 shadow-lg`}>
                                        <Brain className="w-4 h-4"/> Aktifkan dengan {pi.name}
                                    </button>
                                    {(apiKey || isUsingTrial) && (
                                        <button onClick={() => setShowSetup(false)} className="w-full py-2 text-slate-500 text-sm hover:text-slate-700 underline">Batal</button>
                                    )}
                                </div>
                                <p className="text-xs text-slate-400 text-center mt-3">üîí API Key disimpan lokal di perangkat Anda saja.</p>
                            </div>
                        </div>
                    </div>
                );
            }

            // ‚îÄ‚îÄ Screen: Trial Expired ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (currentScreen === 'expired') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-rose-900/20 to-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                            <div className="bg-gradient-to-r from-rose-500 to-pink-600 p-7 text-center">
                                <div className="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-3 backdrop-blur-sm shadow-lg">
                                    <Brain className="w-9 h-9 text-white"/>
                                </div>
                                <h2 className="text-xl font-black text-white">Masa Trial Berakhir</h2>
                                <p className="text-white/80 text-xs mt-1">AI Assistant ¬∑ iFix Pro Enterprise</p>
                            </div>
                            <div className="p-6 text-center">
                                <div className="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span className="text-3xl">‚è∞</span>
                                </div>
                                <h3 className="text-lg font-black text-slate-800 mb-2">Trial AI Assistant Anda Telah Habis</h3>
                                <p className="text-sm text-slate-600 mb-5">
                                    Untuk terus menggunakan AI Assistant, masukkan <strong>API Key Anda sendiri</strong> (Groq atau Google Gemini). Keduanya tersedia <strong>gratis</strong>!
                                </p>
                                <div className="space-y-3">
                                    <a href="https://console.groq.com/keys" target="_blank"
                                        className="flex items-center justify-between w-full px-4 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold text-sm transition-colors shadow-lg">
                                        <span className="flex items-center gap-2">‚ö° Dapatkan Groq API Key Gratis</span>
                                        <span className="text-orange-200 text-xs">console.groq.com</span>
                                    </a>
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank"
                                        className="flex items-center justify-between w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold text-sm transition-colors shadow">
                                        <span className="flex items-center gap-2">üîµ Dapatkan Gemini API Key Gratis</span>
                                        <span className="text-blue-200 text-xs">aistudio.google.com</span>
                                    </a>
                                    <button onClick={() => setShowSetup(true)}
                                        className="w-full py-3 border-2 border-violet-400 text-violet-700 rounded-xl font-bold text-sm hover:bg-violet-50 transition-colors flex items-center justify-center gap-2">
                                        <Key className="w-4 h-4"/> Masukkan API Key Saya
                                    </button>
                                </div>
                                <p className="text-xs text-slate-400 mt-4">üîí API Key disimpan lokal di perangkat Anda saja.</p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col" style={{height: 'calc(100vh - 130px)', minHeight: '500px'}}>
                    {/* ‚îÄ‚îÄ Trial Banner ‚îÄ‚îÄ */}
                    {isUsingTrial && (
                        <div className="mb-3 flex-shrink-0 flex items-center justify-between gap-3 px-4 py-2.5 rounded-xl bg-gradient-to-r from-amber-400 to-orange-400 shadow-md shadow-amber-400/30">
                            <div className="flex items-center gap-2 text-amber-900">
                                <span className="text-lg">üéÅ</span>
                                <div>
                                    <p className="text-xs font-black leading-tight">Mode Trial Aktif</p>
                                    <p className="text-[11px] font-medium leading-tight">
                                        {trialInfo.remainingDays > 1
                                            ? `Sisa ${trialInfo.remainingDays} hari masa trial`
                                            : trialInfo.remainingDays === 1
                                                ? 'Berakhir hari ini!'
                                                : 'Trial berakhir hari ini'}
                                    </p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowSetup(true)}
                                className="flex-shrink-0 text-[11px] font-black bg-amber-900 text-amber-100 px-3 py-1.5 rounded-lg hover:bg-amber-950 transition-colors whitespace-nowrap"
                            >
                                Pakai Key Sendiri
                            </button>
                        </div>
                    )}

                    {/* Header gradient */}
                    <div className="bg-gradient-to-r from-violet-600 via-purple-600 to-indigo-600 rounded-2xl mb-3 p-4 flex items-center justify-between shadow-lg flex-shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                                <Brain className="w-6 h-6 text-white"/>
                            </div>
                            <div>
                                <h1 className="text-white font-black text-base leading-tight">AI Assistant iFix Pro</h1>
                                <p className="text-purple-200 text-xs">
                                    {effectiveProvider === 'groq' ? '‚ö° Groq (Llama 3.3)' : 'üîµ Google Gemini'} ¬∑ Data Realtime PocketBase
                                </p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            {isUsingTrial
                                ? <span className="bg-amber-400 text-amber-900 text-[10px] font-black px-2 py-0.5 rounded-full hidden sm:block">üéÅ TRIAL</span>
                                : <span className="bg-yellow-400 text-yellow-900 text-[10px] font-black px-2 py-0.5 rounded-full hidden sm:block">‚ú® PREMIUM</span>
                            }
                            <button onClick={() => { setShowSetup(true); setTempKey(apiKey); }} className="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all" title={isUsingTrial ? 'Berhenti trial - masukkan key sendiri' : 'Ganti API Key'}>
                                <Key className="w-4 h-4 text-white"/>
                            </button>
                            <button
                                onClick={() => { setMessages([{ role: 'assistant', id: nextId(), content: 'Chat baru dimulai ‚ú® Ada yang bisa saya bantu?', timestamp: new Date() }]); }}
                                className="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all" title="Chat baru"
                            >
                                <RefreshCw className="w-4 h-4 text-white"/>
                            </button>
                        </div>
                    </div>

                    {/* Quick Commands horizontal scroll */}
                    <div className="mb-3 flex-shrink-0 overflow-x-auto pb-1">
                        <div className="flex gap-2" style={{width: 'max-content'}}>
                            {quickCommands.map((cmd, i) => (
                                <button
                                    key={i}
                                    onClick={() => sendToAI(cmd.prompt)}
                                    disabled={loading}
                                    className="flex-shrink-0 flex items-center gap-1.5 bg-white border-2 border-slate-200 rounded-xl px-3 py-2 text-xs font-semibold text-slate-700 hover:border-violet-400 hover:text-violet-700 hover:bg-violet-50 transition-all disabled:opacity-50 shadow-sm whitespace-nowrap"
                                >
                                    <span>{cmd.icon}</span><span>{cmd.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Messages area */}
                    <div className="flex-1 overflow-y-auto bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-4" style={{minHeight: 0}}>
                        {messages.map(msg => (
                            <div key={msg.id} className={`flex gap-3 ${msg.role === 'user' ? 'flex-row-reverse' : 'flex-row'}`}>
                                <div className={`flex-shrink-0 w-8 h-8 rounded-xl flex items-center justify-center shadow-sm ${msg.role === 'user' ? 'bg-blue-600' : 'bg-gradient-to-br from-violet-600 to-indigo-600'}`}>
                                    {msg.role === 'user' ? <User className="w-4 h-4 text-white"/> : <Brain className="w-4 h-4 text-white"/>}
                                </div>
                                <div className={`flex-1 min-w-0 ${msg.role === 'user' ? 'flex flex-col items-end' : ''}`}>
                                    <div className={`inline-block max-w-full rounded-2xl px-4 py-3 text-sm leading-relaxed shadow-sm ${
                                        msg.role === 'user'
                                            ? 'bg-blue-600 text-white rounded-tr-sm'
                                            : msg.isError
                                                ? 'bg-red-50 border border-red-200 text-red-700 rounded-tl-sm'
                                                : 'bg-slate-50 border border-slate-200 text-slate-800 rounded-tl-sm'
                                    } text-left`} style={{wordBreak:'break-word'}}>
                                        {msg.role === 'assistant'
                                            ? <div dangerouslySetInnerHTML={{ __html: renderMsg(msg.content) }}/>
                                            : <span>{msg.content}</span>
                                        }
                                        {msg.isError && msg.retryMsg && (
                                            <button
                                                onClick={() => sendToAI(msg.retryMsg)}
                                                disabled={loading}
                                                className="mt-2 flex items-center gap-1.5 text-xs bg-red-100 hover:bg-red-200 text-red-700 font-bold px-3 py-1.5 rounded-lg transition-all disabled:opacity-50"
                                            >
                                                <RefreshCw className="w-3 h-3"/> Coba Lagi
                                            </button>
                                        )}
                                    </div>
                                    <div className="flex items-center gap-2 mt-1 px-1">
                                        <span className="text-[10px] text-slate-400">{msg.timestamp?.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</span>
                                        {msg.role === 'assistant' && !msg.isError && (
                                            <button onClick={() => copyToClipboard(msg.content)} className="text-[10px] text-slate-400 hover:text-slate-600 flex items-center gap-0.5">
                                                <Copy className="w-3 h-3"/> Salin
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}

                        {loading && (
                            <div className="flex gap-3">
                                <div className="flex-shrink-0 w-8 h-8 rounded-xl bg-gradient-to-br from-violet-600 to-indigo-600 flex items-center justify-center">
                                    <Brain className="w-4 h-4 text-white"/>
                                </div>
                                <div className="bg-slate-50 border border-slate-200 rounded-2xl rounded-tl-sm px-4 py-3">
                                    {fetchingData ? (
                                        <div className="flex items-center gap-2 text-sm text-slate-600">
                                            <div className="w-3 h-3 border-2 border-violet-400 border-t-transparent rounded-full animate-spin"/>
                                            <span>Mengambil data toko secara realtime...</span>
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-2 text-sm text-slate-600">
                                            <div className="flex gap-1">
                                                <div className="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style={{animationDelay:'0ms'}}/>
                                                <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{animationDelay:'150ms'}}/>
                                                <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style={{animationDelay:'300ms'}}/>
                                            </div>
                                            <span>AI sedang menganalisis data Anda...</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef}/>
                    </div>

                    {/* Input bar */}
                    <div className="mt-3 flex gap-2 flex-shrink-0">
                        <input
                            ref={inputRef}
                            type="text"
                            value={input}
                            onChange={e => setInput(e.target.value)}
                            onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendToAI(); } }}
                            placeholder="Ketik pertanyaan... contoh: buatkan laporan penjualan bulan Juni"
                            disabled={loading}
                            className="flex-1 border-2 border-slate-200 focus:border-violet-400 rounded-xl px-4 py-3 text-sm focus:outline-none transition-colors bg-white shadow-sm disabled:opacity-60"
                        />
                        <button
                            onClick={() => sendToAI()}
                            disabled={loading || !input.trim()}
                            className="px-4 py-3 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-xl font-bold hover:from-violet-700 hover:to-indigo-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-sm flex items-center justify-center"
                            style={{minWidth: '48px'}}
                        >
                            {loading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"/> : <Send className="w-5 h-5"/>}
                        </button>
                    </div>
                </div>
            );
        };
        // ==================== END AI ASSISTANT ====================

        const App = () => {
            const { user, activeOwner, activeStore, loading, logout, subscriptionStatus, adminWhatsApp, subConfig, ownerAccess } = useContext(SessionContext);
            
            // üñ±Ô∏è Aktifkan drag untuk semua modal popup
            useDraggableModals();

            // ‚úÖ Restore last visited page after reload
            const VALID_VIEWS = ['dashboard','service','sales','purchase','return-sales','return-purchase',
                                 'inventory','customers','supplier','finance','transactions','cash',
                                 'report','users','settings','hr','receivable','payable','accounting',
                                 'backup','after-sales','ai-assistant'];
            const [view, setViewState] = useState(() => {
                try {
                    const saved = localStorage.getItem('ifix_last_view');
                    return (saved && VALID_VIEWS.includes(saved)) ? saved : 'dashboard';
                } catch(e) { return 'dashboard'; }
            });
            
            // Wrap setView untuk auto-save ke localStorage
            const setView = (v) => {
                setViewState(v);
                try { localStorage.setItem('ifix_last_view', v); } catch(e) {}
            };
            
            // Reset ke dashboard saat user berganti (logout/login akun lain)
            const prevUidRef = React.useRef(null);
            useEffect(() => {
                if (user?.uid && user.uid !== prevUidRef.current) {
                    if (prevUidRef.current !== null) {
                        // User baru login atau ganti akun ‚Üí reset ke dashboard
                        setView('dashboard');
                    }
                    prevUidRef.current = user.uid;
                }
                if (!user) prevUidRef.current = null;
            }, [user?.uid]);

            // Redirect ke dashboard jika view yang sedang dibuka dinonaktifkan oleh developer
            useEffect(() => {
                const viewPermMap = {
                    'after-sales': 'menu_after_sales',
                    'service': 'menu_service',
                    'sales': 'menu_sales',
                    'purchase': 'menu_purchase',
                    'return-sales': 'menu_return_sales',
                    'return-purchase': 'menu_return_purchase',
                    'report': 'menu_report',
                    'customers': 'menu_customers',
                    'inventory': 'menu_inventory',
                    'supplier': 'menu_supplier',
                    'hr': 'menu_hr',
                    'payable': 'menu_payable',
                    'receivable': 'menu_receivable',
                    'cash': 'menu_cash',
                    'finance': 'menu_finance',
                    'users': 'menu_users',
                    'settings': 'menu_settings',
                };
                const permKey = viewPermMap[view];
                if (permKey && ownerAccess?.[permKey] === false) {
                    setView('dashboard');
                }
            }, [view, ownerAccess]);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [initialServiceData, setInitialServiceData] = useState(null);
            const [showAdminMessagePopup, setShowAdminMessagePopup] = useState(false);
            const [showPackageModal, setShowPackageModal] = useState(false);
            const [selectedPlan, setSelectedPlan] = useState('basic');
            const [planConfigs, setPlanConfigs] = useState({ basic: {}, pro: {} });
            const [lastDismissedMessageTime, setLastDismissedMessageTime] = useState(() => {
                return localStorage.getItem('lastDismissedMessageTime') || null;
            });
            
            // Load plan configs for package modal
            useEffect(() => {
                let cancelled = false;
                // Strategy 1: Direct PocketBase load (instant)
                (async () => {
                    try {
                        const basicRec = await pb.collection('plan_configs').getOne(_planDocId('basic'));
                        if (!cancelled && basicRec) {
                            const data = { ...basicRec };
                            delete data.collectionId; delete data.collectionName; delete data.expand;
                            setPlanConfigs(prev => ({ ...prev, basic: data }));
                            console.log('‚úÖ Owner: basic plan config loaded from PocketBase');
                        }
                    } catch (e) { console.warn('‚ö†Ô∏è PB basic plan load:', e.message); }
                    try {
                        const proRec = await pb.collection('plan_configs').getOne(_planDocId('pro'));
                        if (!cancelled && proRec) {
                            const data = { ...proRec };
                            delete data.collectionId; delete data.collectionName; delete data.expand;
                            setPlanConfigs(prev => ({ ...prev, pro: data }));
                            console.log('‚úÖ Owner: pro plan config loaded from PocketBase');
                        }
                    } catch (e) { console.warn('‚ö†Ô∏è PB pro plan load:', e.message); }
                })();
                
                // Strategy 2: Adapter real-time listener
                const unsubBasic = onSnapshot(
                    doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', _planDocId('basic')),
                    (snap) => {
                        if (!cancelled && snap.exists()) {
                            setPlanConfigs(prev => ({ ...prev, basic: snap.data() }));
                        }
                    }
                );
                const unsubPro = onSnapshot(
                    doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', _planDocId('pro')),
                    (snap) => {
                        if (!cancelled && snap.exists()) {
                            setPlanConfigs(prev => ({ ...prev, pro: snap.data() }));
                        }
                    }
                );
                if (window.firestoreListeners) {
                    window.firestoreListeners.add(unsubBasic);
                    window.firestoreListeners.add(unsubPro);
                }
                return () => {
                    cancelled = true;
                    if (window.firestoreListeners) {
                        window.firestoreListeners.delete(unsubBasic);
                        window.firestoreListeners.delete(unsubPro);
                    }
                    unsubBasic();
                    unsubPro();
                };
            }, []);
            
            // Set selectedPlan when modal opens
            useEffect(() => {
                if (showPackageModal && activeOwner?.plan) {
                    setSelectedPlan(activeOwner.plan.toLowerCase());
                }
            }, [showPackageModal, activeOwner?.plan]);
            
            // Monitor access notifications
            useAccessNotification(user);
            
            // Monitor admin message and show popup for active subscribers
            useEffect(() => {
                if (!activeOwner?.adminMessage || !subscriptionStatus) return;
                
                // Only show popup if subscription is active (not expired)
                if (subscriptionStatus.expired) return;
                
                // Check if there's a new admin message
                const messageTime = activeOwner.adminMessageAt?.seconds 
                    ? new Date(activeOwner.adminMessageAt.seconds * 1000).getTime().toString()
                    : null;
                
                // Don't show if user already dismissed this exact message
                if (messageTime && lastDismissedMessageTime === messageTime) return;
                
                // Show popup for new message
                setShowAdminMessagePopup(true);
            }, [activeOwner?.adminMessage, activeOwner?.adminMessageAt, subscriptionStatus, lastDismissedMessageTime]);
            
            const dismissAdminMessagePopup = () => {
                const messageTime = activeOwner.adminMessageAt?.seconds 
                    ? new Date(activeOwner.adminMessageAt.seconds * 1000).getTime().toString()
                    : Date.now().toString();
                
                setLastDismissedMessageTime(messageTime);
                localStorage.setItem('lastDismissedMessageTime', messageTime);
                setShowAdminMessagePopup(false);
            };
            
            // Check for Tracking Token or Track ID
            const [urlToken, setUrlToken] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return params.get('token');
            });
            
            const [trackId, setTrackId] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return params.get('track');
            });

            if (urlToken) {
                return <PublicTrackingView token={urlToken} onBack={() => { setUrlToken(null); window.history.pushState({}, '', window.location.pathname); }} />;
            }
            
            if (trackId) {
                return <PublicServiceTracker serviceId={trackId} onBack={() => { setTrackId(null); window.history.pushState({}, '', window.location.pathname); }} />;
            }

            if (loading) return <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center text-white gap-4"><Loader2 className="w-10 h-10 animate-spin text-blue-500"/><p className="text-sm font-medium animate-pulse">Menghubungkan ke Cloud Database...</p></div>;
            
            if (!user) return <LoginScreen />;
            if (user.role === 'guest') return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white max-w-md w-full p-8 rounded-2xl shadow-xl text-center">
                        <div className="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <ShieldAlert className="w-8 h-8"/>
                        </div>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">Akun Belum Aktif</h2>
                        <p className="text-slate-500 mb-4">Halo <strong>{user.email}</strong>. Akun berhasil dibuat namun belum memiliki hak akses (Role).</p>
                        <p className="text-slate-400 text-sm mb-6">Apabila Owner sudah mengaktifkan akun Anda, coba tekan tombol <strong>Muat Ulang</strong> di bawah. Jika masih muncul pesan ini, hubungi Owner atau Developer.</p>
                        <div className="flex flex-col gap-3">
                            <button onClick={()=>window.location.reload()} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors">üîÑ Muat Ulang</button>
                            <button onClick={()=>getAuth().signOut().then(()=>window.location.reload())} className="text-slate-400 text-sm hover:underline">Keluar / Ganti Akun</button>
                        </div>
                    </div>
                </div>
            );
            if (user.role === 'developer' && !activeOwner) return <DeveloperDashboard />;
            
            // Subscription Lock Screen - block access if subscription expired
            if (subscriptionStatus && subscriptionStatus.expired && user.role !== 'developer') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-red-900/20 to-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white max-w-lg w-full rounded-2xl shadow-2xl overflow-hidden">
                            <div className="bg-red-600 p-8 text-center">
                                <div className="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Lock className="w-10 h-10 text-white"/>
                                </div>
                                <h2 className="text-2xl font-black text-white">Aplikasi Terkunci</h2>
                                <p className="text-red-100 mt-2 text-sm">Langganan Anda telah berakhir</p>
                            </div>
                            <div className="p-8 text-center">
                                <div className="bg-red-50 border-2 border-red-200 rounded-xl p-5 mb-6">
                                    <p className="text-red-800 font-bold text-sm mb-2">Masa aktif aplikasi Anda telah habis.</p>
                                    <p className="text-red-600 text-xs">Untuk melanjutkan menggunakan aplikasi iFix Enterprise, silakan hubungi Administrator untuk melakukan perpanjangan langganan.</p>
                                    {subscriptionStatus.expiresAt && (
                                        <p className="text-red-500 text-xs mt-3 font-mono">Kedaluwarsa: {subscriptionStatus.expiresAt.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                    )}
                                </div>
                                <div className="bg-slate-50 rounded-xl p-4 mb-6 text-left">
                                    <p className="text-xs font-bold text-slate-700 uppercase mb-2">Informasi Akun</p>
                                    <div className="space-y-1 text-sm">
                                        <div className="flex justify-between"><span className="text-slate-500">Bisnis:</span><span className="font-bold text-slate-800">{activeOwner?.name}</span></div>
                                        <div className="flex justify-between"><span className="text-slate-500">Email:</span><span className="font-bold text-slate-800">{user.email}</span></div>
                                        <div className="flex justify-between"><span className="text-slate-500">Paket:</span><span className="font-bold text-slate-800 uppercase">{activeOwner?.plan}</span></div>
                                    </div>
                                </div>
                                {activeOwner?.adminMessage && (
                                    <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-5 mb-6">
                                        <div className="flex items-start gap-2 mb-2">
                                            <MessageCircle className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"/>
                                            <p className="text-xs font-bold text-blue-800 uppercase">Pesan dari Admin:</p>
                                        </div>
                                        <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">{activeOwner.adminMessage}</p>
                                        {activeOwner.adminMessageAt && activeOwner.adminMessageAt.seconds && (
                                            <p className="text-[10px] text-blue-500 mt-2 opacity-70">
                                                {new Date(activeOwner.adminMessageAt.seconds * 1000).toLocaleString('id-ID', {
                                                    day: 'numeric',
                                                    month: 'long',
                                                    year: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}
                                            </p>
                                        )}
                                    </div>
                                )}
                                <div className="space-y-3">
                                    <a href={`https://wa.me/${adminWhatsApp || '6281234567890'}?text=Halo%20Admin%2C%20saya%20ingin%20memperpanjang%20langganan%20iFix%20Enterprise.%20Bisnis%3A%20${encodeURIComponent(activeOwner?.name || '')}`} target="_blank" className="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all" onClick={() => console.log('üì± Opening WhatsApp:', adminWhatsApp || '6281234567890 (default)')}>
                                        <MessageCircle className="w-5 h-5"/> Hubungi Admin via WhatsApp
                                    </a>
                                    {adminWhatsApp && <p className="text-xs text-slate-500 text-center mt-2">WA: +{adminWhatsApp}</p>}
                                    <button onClick={logout} className="w-full py-3 border-2 border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center justify-center gap-2 transition-all">
                                        <LogOut className="w-4 h-4"/> Keluar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="flex bg-slate-50 min-h-screen relative overflow-x-hidden">
                    {mobileMenuOpen && ( <div className="fixed inset-0 bg-black/50 z-40 md:hidden backdrop-blur-sm transition-opacity" onClick={() => setMobileMenuOpen(false)}></div> )}
                    <Sidebar setView={setView} view={view} isOpen={mobileMenuOpen} close={() => setMobileMenuOpen(false)} />
                    <main className="flex-1 md:ml-64 transition-all duration-300" style={{minWidth: 0}}>
                        {/* Desktop Header - hidden di mobile */}
                        <header className="hidden md:flex bg-white border-b border-slate-200 px-6 py-4 justify-between items-center sticky top-0 z-30 shadow-sm">
                            <div className="flex items-center gap-4">
                                <div className="text-right">
                                    <p className="text-sm font-bold text-slate-800">{user.name}</p>
                                    <p className="text-xs text-slate-500 uppercase">{user.role}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                {subscriptionStatus && subscriptionStatus.status === 'active' && (
                                    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold ${
                                        subscriptionStatus.remainingDays <= 30 
                                            ? 'bg-red-100 text-red-700 border border-red-200 animate-pulse' 
                                            : subscriptionStatus.remainingDays <= 90 
                                                ? 'bg-yellow-100 text-yellow-700 border border-yellow-200' 
                                                : 'bg-green-100 text-green-700 border border-green-200'
                                    }`}>
                                        <Calendar className="w-3 h-3"/>
                                        {subscriptionStatus.remainingDays <= 30 ? '‚ö†Ô∏è ' : ''}{subscriptionStatus.remainingDays} hari tersisa
                                    </div>
                                )}
                                <button onClick={()=>{setShowPackageModal(true);}} className="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-white text-sm"><Crown className="w-4 h-4"/> Paket</button>
                                <button onClick={logout} className="bg-red-600 hover:bg-red-700 p-2 rounded-lg transition-colors flex items-center gap-2 text-white"><LogOut className="w-5 h-5"/></button>
                            </div>
                        </header>
                        {/* Mobile Header - hanya 1 header, clean */}
                        <div className="md:hidden bg-slate-900 text-white sticky top-0 z-30 shadow-md">
                            <div className="px-4 py-3 flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <button onClick={() => setMobileMenuOpen(true)} className="p-2 rounded-lg bg-slate-800 border border-slate-700 active:scale-95 transition-transform"><Menu className="w-5 h-5 text-white"/></button>
                                    <div><h1 className="font-bold text-sm leading-tight">iFix Pro</h1><p className="text-[10px] text-blue-400 uppercase">{activeOwner?.plan || 'Mobile'}</p></div>
                                </div>
                                <div className="flex items-center gap-2">
                                    {subscriptionStatus && subscriptionStatus.status === 'active' && (
                                        <span className={`text-[10px] px-2 py-1 rounded font-bold ${
                                            subscriptionStatus.remainingDays <= 30 
                                                ? 'bg-red-600 text-white animate-pulse' 
                                                : subscriptionStatus.remainingDays <= 90 
                                                    ? 'bg-yellow-600 text-white' 
                                                    : 'bg-green-600 text-white'
                                        }`}>{subscriptionStatus.remainingDays}hr</span>
                                    )}
                                    <button onClick={logout} className="p-2 rounded-lg bg-red-600/20 border border-red-500/30 active:scale-95 transition-transform"><LogOut className="w-4 h-4 text-red-400"/></button>
                                </div>
                            </div>
                            {/* Strip Kas Tersedia di bawah header mobile */}
                            {false && null /* totalKas widget now in Sidebar */}
                        </div>
                        <div className="p-3 md:p-8 mobile-bottom-padding">
                            {/* ‚îÄ‚îÄ NOTIF TRIAL AI ASSISTANT ‚îÄ‚îÄ */}
                            {(() => {
                                const tr = activeOwner?.accessRights;
                                if (!tr?.aiTrialEnabled) return null;
                                // Hitung sisa hari
                                let remaining = 0, expired = false;
                                if (tr.aiTrialEndDate) {
                                    const end = new Date(tr.aiTrialEndDate); end.setHours(23,59,59,999);
                                    remaining = Math.ceil((end - new Date()) / 86400000);
                                    expired = remaining <= 0;
                                } else {
                                    const startKey = 'ai_trial_start_' + activeOwner.id;
                                    const start = localStorage.getItem(startKey);
                                    if (start) {
                                        const days = Math.max(1, parseInt(tr.aiTrialDays)||7);
                                        remaining = Math.ceil((new Date(start).getTime() + days*86400000 - Date.now()) / 86400000);
                                        expired = remaining <= 0;
                                    } else {
                                        remaining = parseInt(tr.aiTrialDays)||7;
                                    }
                                }
                                const adminWa = adminWhatsApp || subConfig?.whatsapp || '';
                                const waLink = adminWa ? `https://wa.me/${adminWa.replace(/\D/g,'')}?text=${encodeURIComponent('Halo Admin, saya ingin memperpanjang masa trial AI Assistant. Terima kasih.')}` : null;
                                if (expired) return (
                                    <div className="mb-4 flex items-center gap-3 bg-rose-50 border border-rose-300 rounded-xl px-4 py-3 text-sm">
                                        <span className="text-2xl">üòî</span>
                                        <div className="flex-1 min-w-0">
                                            <p className="font-bold text-rose-700">Masa Trial AI Assistant Telah Berakhir</p>
                                            <p className="text-rose-600 text-xs mt-0.5">Hubungi admin untuk memperpanjang atau aktifkan paket AI.</p>
                                        </div>
                                        {waLink && <a href={waLink} target="_blank" rel="noreferrer" className="flex-shrink-0 bg-green-500 hover:bg-green-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg flex items-center gap-1.5 transition-colors">üí¨ Hubungi Admin</a>}
                                    </div>
                                );
                                const urgent = remaining <= 3;
                                return (
                                    <div className={`mb-4 flex items-center gap-3 rounded-xl px-4 py-3 text-sm border ${urgent ? 'bg-amber-50 border-amber-400 animate-pulse' : 'bg-violet-50 border-violet-300'}`}>
                                        <span className="text-2xl">üéÅ</span>
                                        <div className="flex-1 min-w-0">
                                            <p className={`font-bold ${urgent ? 'text-amber-700' : 'text-violet-700'}`}>
                                                {urgent ? '‚ö†Ô∏è ' : ''}Masa Trial AI Assistant: <span className="text-lg">{remaining}</span> hari lagi
                                            </p>
                                            <p className={`text-xs mt-0.5 ${urgent ? 'text-amber-600' : 'text-violet-500'}`}>
                                                {urgent ? 'Trial hampir habis! ' : ''}Untuk memperpanjang, hubungi admin.
                                            </p>
                                        </div>
                                        {waLink && <a href={waLink} target="_blank" rel="noreferrer" className="flex-shrink-0 bg-green-500 hover:bg-green-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg flex items-center gap-1.5 transition-colors">üí¨ Hubungi Admin</a>}
                                    </div>
                                );
                            })()}
                            {view === 'dashboard' && <Dashboard setView={setView}/>}
                            {view === 'service' && <ServiceManager />}
                            {view === 'sales' && <SalesManager />}
                            {view === 'purchase' && <PurchaseManager />}
                            {view === 'return-sales' && <ReturnSalesManager />}
                            {view === 'return-purchase' && <ReturnPurchaseManager />}
                            {view === 'supplier' && <SupplierManager />}
                            {view === 'payable' && <PayableManager />}
                            {view === 'receivable' && <ReceivableManager />}
                            {view === 'cash' && <CashManager />}
                            {view === 'report' && <ReportManager />}
                            {view === 'customers' && <CustomerManager setView={setView} />}
                            {view === 'after-sales' && ownerAccess?.menu_after_sales !== false && <AfterSalesCare />}
                            {view === 'users' && <UserManager />}
                            {view === 'hr' && <HRManager />}
                            {view === 'settings' && <SettingsManager />}
                            {view === 'inventory' && <StockManager />}
                            {view === 'finance' && <FinanceManager />}
                            {view === 'backup' && <BackupPage />}
                            {view === 'ai-assistant' && <AIAssistant />}
                        </div>
                        {/* Bottom Navigation Mobile */}
                        <div className="bottom-nav">
                            {[
                                { id: 'dashboard', label: 'Home', icon: LayoutDashboard },
                                { id: 'service', label: 'Servis', icon: Smartphone },
                                { id: 'sales', label: 'Jual', icon: Store },
                                { id: 'inventory', label: 'Stok', icon: Box },
                                { id: 'finance', label: 'Keuangan', icon: Wallet }
                            ].map(nav => (
                                <button key={nav.id} onClick={() => setView(nav.id)} className={`bottom-nav-item ${view === nav.id ? 'active' : ''}`}>
                                    <nav.icon />
                                    <span>{nav.label}</span>
                                </button>
                            ))}
                        </div>
                    </main>

                    {/* Admin Message Popup - hanya muncul saat subscription aktif */}
                    {showAdminMessagePopup && activeOwner?.adminMessage && !subscriptionStatus?.expired && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100] animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-scale-up">
                                {/* Header dengan gradien */}
                                <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-center relative">
                                    <div className="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm">
                                        <MessageCircle className="w-8 h-8 text-white"/>
                                    </div>
                                    <h2 className="text-xl font-black text-white">Pesan dari Admin</h2>
                                    <p className="text-blue-100 text-xs mt-1">iFix Pro Enterprise</p>
                                </div>

                                {/* Konten pesan */}
                                <div className="p-6">
                                    <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
                                        <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap font-medium">
                                            {activeOwner.adminMessage}
                                        </p>
                                    </div>

                                    {/* Timestamp */}
                                    {activeOwner.adminMessageAt && activeOwner.adminMessageAt.seconds && (
                                        <div className="flex items-center gap-2 text-xs text-slate-500 mb-6 justify-center">
                                            <Clock className="w-3 h-3"/>
                                            <span>
                                                {new Date(activeOwner.adminMessageAt.seconds * 1000).toLocaleString('id-ID', {
                                                    day: 'numeric',
                                                    month: 'long',
                                                    year: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}
                                            </span>
                                        </div>
                                    )}

                                    {/* Tombol tutup */}
                                    <button 
                                        onClick={dismissAdminMessagePopup}
                                        className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg hover:shadow-xl"
                                    >
                                        <CheckCircle className="w-5 h-5"/> Mengerti
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Subscription Package Modal */}
                    {showPackageModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[100] animate-fade-in">
                                <div className="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden animate-scale-up max-h-[90vh] overflow-y-auto">
                                    {/* Compact Header */}
                                    <div className="bg-gradient-to-r from-emerald-600 to-teal-600 p-4 relative">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm">
                                                    <Crown className="w-6 h-6 text-white"/>
                                                </div>
                                                <div>
                                                    <h2 className="text-xl font-black text-white">Paket Langganan</h2>
                                                    <p className="text-emerald-100 text-xs">iFix Pro Enterprise Cloud SaaS</p>
                                                </div>
                                            </div>
                                            <button 
                                                onClick={() => setShowPackageModal(false)}
                                                className="w-8 h-8 rounded-lg bg-white/20 hover:bg-white/30 flex items-center justify-center transition-all"
                                            >
                                                <X className="w-5 h-5 text-white"/>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Content */}
                                    <div className="p-5">
                                        {/* Current Plan Info - Compact */}
                                        <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl p-3 mb-4">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-gradient-to-br from-blue-500 to-purple-500 text-white px-3 py-1.5 rounded-lg font-bold text-sm">
                                                        {(activeOwner?.plan || 'Basic').toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-slate-600">Status Langganan</p>
                                                        {subscriptionStatus && subscriptionStatus.status === 'active' ? (
                                                            <p className="text-sm font-bold text-green-600 flex items-center gap-1">
                                                                <CheckCircle className="w-3 h-3"/> {subscriptionStatus.remainingDays} hari tersisa
                                                            </p>
                                                        ) : (
                                                            <p className="text-sm font-bold text-red-600 flex items-center gap-1">
                                                                <AlertCircle className="w-3 h-3"/> {subscriptionStatus?.expired ? 'Expired' : 'Tidak Aktif'}
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Tab Selector */}
                                        <div className="flex gap-2 mb-4 p-1 bg-slate-100 rounded-xl">
                                            <button
                                                onClick={() => setSelectedPlan('basic')}
                                                className={`flex-1 py-2.5 rounded-lg font-bold text-sm transition-all ${
                                                    selectedPlan === 'basic' 
                                                    ? 'bg-white text-blue-600 shadow-md' 
                                                    : 'text-slate-600 hover:text-slate-800'
                                                }`}
                                            >
                                                Basic Plan
                                            </button>
                                            <button
                                                onClick={() => setSelectedPlan('pro')}
                                                className={`flex-1 py-2.5 rounded-lg font-bold text-sm transition-all ${
                                                    selectedPlan === 'pro' 
                                                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-md' 
                                                    : 'text-slate-600 hover:text-slate-800'
                                                }`}
                                            >
                                                Pro Plan ‚≠ê
                                            </button>
                                        </div>

                                        {/* Plan Details - Animated */}
                                        <div className="relative">
                                            {selectedPlan === 'basic' && (
                                                <div className="border-2 border-blue-300 rounded-xl p-5 bg-gradient-to-br from-blue-50 to-slate-50 animate-fade-in">
                                                    <div className="flex items-center justify-between mb-4">
                                                        <div>
                                                            <h3 className="text-2xl font-black text-blue-600 mb-1">
                                                                Rp {(subConfig?.basicFirstYear || 1200000).toLocaleString('id-ID')}
                                                            </h3>
                                                            <p className="text-xs text-slate-600">per tahun (tahun pertama)</p>
                                                            <p className="text-sm font-bold text-emerald-600 mt-1">
                                                                Rp {(subConfig?.basicRenewal || 960000).toLocaleString('id-ID')}/tahun berikutnya
                                                            </p>
                                                        </div>
                                                        <span className="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold text-sm">
                                                            PEMULA
                                                        </span>
                                                    </div>
                                                    <div className="grid md:grid-cols-2 gap-3">
                                                        {(planConfigs.basic.featuresList && planConfigs.basic.featuresList.length > 0) ? (
                                                            planConfigs.basic.featuresList.map((feat, idx) => (
                                                                <div key={idx} className="flex items-start gap-2 text-sm">
                                                                    {feat.startsWith('~') ? <X className="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5"/> : <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"/>}
                                                                    <span className={feat.startsWith('~') ? 'line-through text-slate-400' : ''} dangerouslySetInnerHTML={{ __html: (feat.startsWith('~') ? feat.slice(1) : feat).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }}></span>
                                                                </div>
                                                            ))
                                                        ) : (
                                                            <>
                                                                <div className="flex items-start gap-2 text-sm">
                                                                    <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"/>
                                                                    <span>Maksimal <strong>1 Cabang</strong></span>
                                                                </div>
                                                                <div className="flex items-start gap-2 text-sm">
                                                                    <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"/>
                                                                    <span>Semua fitur dasar POS</span>
                                                                </div>
                                                                <div className="flex items-start gap-2 text-sm">
                                                                    <X className="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5"/>
                                                                    <span className="line-through text-slate-400">Backup otomatis</span>
                                                                </div>
                                                                <div className="flex items-start gap-2 text-sm">
                                                                    <X className="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5"/>
                                                                    <span className="line-through text-slate-400">Support prioritas</span>
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            )}

                                            {selectedPlan === 'pro' && (
                                                <div className="border-2 border-purple-400 rounded-xl p-5 bg-gradient-to-br from-purple-50 to-pink-50 animate-fade-in relative overflow-hidden">
                                                    <div className="absolute -top-10 -right-10 w-32 h-32 bg-gradient-to-br from-purple-400/20 to-pink-400/20 rounded-full blur-2xl"></div>
                                                    <div className="relative">
                                                        <div className="flex items-center justify-between mb-4">
                                                            <div>
                                                                <h3 className="text-2xl font-black text-purple-600 mb-1">
                                                                    Rp {(subConfig?.proFirstYear || 2400000).toLocaleString('id-ID')}
                                                                </h3>
                                                                <p className="text-xs text-slate-600">per tahun (tahun pertama)</p>
                                                                <p className="text-sm font-bold text-emerald-600 mt-1">
                                                                    Rp {(subConfig?.proRenewal || 1920000).toLocaleString('id-ID')}/tahun berikutnya
                                                                </p>
                                                            </div>
                                                            <div className="flex flex-col gap-1 items-end">
                                                                <span className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                                                    BISNIS
                                                                </span>
                                                                <span className="text-xs text-purple-600 font-bold">‚≠ê POPULER</span>
                                                            </div>
                                                        </div>
                                                        <div className="grid md:grid-cols-2 gap-3">
                                                            {(planConfigs.pro.featuresList && planConfigs.pro.featuresList.length > 0) ? (
                                                                planConfigs.pro.featuresList.map((feat, idx) => (
                                                                    <div key={idx} className="flex items-start gap-2 text-sm">
                                                                        {feat.startsWith('~') ? <X className="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5"/> : <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"/>}
                                                                        <span className={feat.startsWith('~') ? 'line-through text-slate-400' : ''} dangerouslySetInnerHTML={{ __html: (feat.startsWith('~') ? feat.slice(1) : feat).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }}></span>
                                                                    </div>
                                                                ))
                                                            ) : (
                                                                <>
                                                                    <div className="flex items-start gap-2 text-sm">
                                                                        <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"/>
                                                                        <span>Maksimal <strong>5 Cabang</strong></span>
                                                                    </div>
                                                                    <div className="flex items-start gap-2 text-sm">
                                                                        <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"/>
                                                                        <span>Semua fitur lengkap</span>
                                                                    </div>
                                                                    <div className="flex items-start gap-2 text-sm">
                                                                        <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"/>
                                                                        <span>Backup & Restore data</span>
                                                                    </div>
                                                                    <div className="flex items-start gap-2 text-sm">
                                                                        <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"/>
                                                                        <span>Support prioritas 24/7</span>
                                                                    </div>
                                                                    <div className="flex items-start gap-2 text-sm">
                                                                        <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"/>
                                                                        <span>Custom request fitur</span>
                                                                    </div>
                                                                </>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* Contact CTA - Compact */}
                                        <div className="mt-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4">
                                            <div className="flex items-center gap-3 mb-3">
                                                <MessageCircle className="w-5 h-5 text-green-600"/>
                                                <div>
                                                    <h4 className="font-bold text-sm text-green-900">Hubungi Admin</h4>
                                                    <p className="text-xs text-slate-600">Tim kami siap membantu Anda</p>
                                                </div>
                                            </div>
                                            <a 
                                                href={`https://wa.me/${adminWhatsApp || '6281234567890'}?text=Halo%20Admin%2C%20saya%20ingin%20berlangganan%20${selectedPlan.toUpperCase()}%20PLAN%20iFix%20Enterprise.%0A%0ABisnis%3A%20${encodeURIComponent(activeOwner?.name || '')}%0AEmail%3A%20${encodeURIComponent(user?.email || '')}`}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="w-full py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-all shadow-md hover:shadow-lg text-sm"
                                            >
                                                <MessageCircle className="w-4 h-4"/> WhatsApp Admin
                                            </a>
                                            {adminWhatsApp && (
                                                <p className="text-xs text-center text-slate-500 mt-2 flex items-center justify-center gap-1">
                                                    <Phone className="w-3 h-3"/> +{adminWhatsApp}
                                                </p>
                                            )}
                                        </div>

                                        {/* Close Button - Compact */}
                                        <button 
                                            onClick={() => setShowPackageModal(false)}
                                            className="w-full mt-3 py-2.5 border-2 border-slate-200 text-slate-600 rounded-lg font-bold hover:bg-slate-50 transition-all text-sm"
                                        >
                                            Tutup
                                        </button>
                                    </div>
                                </div>
                            </div>
                    )}
                </div>
            );
        };

        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [rememberMe, setRememberMe] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showDebug, setShowDebug] = useState(false);

            // ‚îÄ‚îÄ Subdomain tenant branding ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const [tenantInfo, setTenantInfo] = useState(null);
            const [tenantError, setTenantError] = useState(false);

            // ‚îÄ‚îÄ Domain restriction: tenant login at main domain ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const [tenantRedirect, setTenantRedirect] = useState(null); // { name, subdomain }

            useEffect(() => {
                // Cek apakah app dibuka via subdomain
                if (!window.DETECTED_SUBDOMAIN) return;
                // Tunggu resolveSubdomainTenant selesai (sudah berjalan di background)
                const poll = setInterval(() => {
                    if (window._SUBDOMAIN_TENANT !== null) {
                        clearInterval(poll);
                        if (window._SUBDOMAIN_TENANT.notFound) {
                            setTenantError(true);
                        } else {
                            setTenantInfo(window._SUBDOMAIN_TENANT);
                        }
                    }
                }, 200);
                return () => clearInterval(poll);
            }, []);
            
            // Detect PWA mode
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                          window.navigator.standalone === true;

            const handleAuth = async (e) => {
                e.preventDefault();
                
                // Prevent double submission
                if (loading) {
                    console.log('Login already in progress...');
                    return;
                }
                
                setError('');
                setLoading(true);
                
                console.log('üîê Starting login process...');
                console.log('üì± User Agent:', navigator.userAgent);
                console.log('üåê Online:', navigator.onLine);
                console.log('üì¶ PWA Mode:', window.matchMedia('(display-mode: standalone)').matches);
                
                try {
                    const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                    console.log('‚öôÔ∏è Setting persistence:', rememberMe ? 'localStorage' : 'sessionStorage');
                    await setPersistence(auth, persistence);
                    
                    console.log('üîë Attempting sign in...');
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log('‚úÖ Sign in successful!');
                } catch (err) {
                    console.error('‚ùå Login error:', err.code, err.message);
                    if (err.code === 'auth/wrong-domain-tenant') {
                        setTenantRedirect({ name: err.ownerName, subdomain: err.ownerSubdomain });
                    } else if (err.code === 'auth/wrong-domain-dev') {
                        setTenantRedirect({ isDev: true });
                    } else {
                        let msg = err.message;
                        if (err.code === 'auth/invalid-credential') msg = 'Email atau password salah.';
                        if (err.code === 'auth/user-not-found') msg = 'Akun tidak ditemukan.';
                        if (err.code === 'auth/wrong-password') msg = 'Password salah.';
                        if (err.code === 'auth/too-many-requests') msg = 'Terlalu banyak percobaan. Coba lagi nanti.';
                        if (err.code === 'auth/network-request-failed') msg = 'Koneksi internet bermasalah. Periksa koneksi Anda.';
                        setError(msg);
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center"></div>

                    {/* ‚îÄ‚îÄ Banner error subdomain tidak ditemukan ‚îÄ‚îÄ */}
                    {tenantError && (
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 z-20 bg-red-600 text-white text-sm font-bold px-5 py-2.5 rounded-full shadow-lg flex items-center gap-2">
                            <ShieldAlert className="w-4 h-4"/>
                            Subdomain "<span className="font-mono">{window.DETECTED_SUBDOMAIN}</span>" tidak ditemukan
                        </div>
                    )}

                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative z-10">
                        {/* ‚îÄ‚îÄ Header: tampilkan branding tenant jika via subdomain, fallback ke default ‚îÄ‚îÄ */}
                        {tenantInfo ? (
                            <div className="p-8 text-center bg-gradient-to-br from-purple-700 to-blue-600">
                                {tenantInfo.logo ? (
                                    <div className="w-24 h-24 bg-white rounded-2xl mx-auto mb-3 flex items-center justify-center shadow-lg overflow-hidden p-2">
                                        <img
                                            src={tenantInfo.logo}
                                            alt={tenantInfo.name}
                                            className="w-full h-full object-contain"
                                            onError={e => { e.target.style.display='none'; e.target.nextSibling.style.display='flex'; }}
                                        />
                                        <div className="w-full h-full hidden items-center justify-center text-4xl font-black text-purple-700">
                                            {tenantInfo.name.charAt(0).toUpperCase()}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="w-20 h-20 bg-white rounded-2xl mx-auto mb-3 flex items-center justify-center shadow-lg text-4xl font-black text-purple-700">
                                        {tenantInfo.name.charAt(0).toUpperCase()}
                                    </div>
                                )}
                                <h1 className="text-xl font-black text-white tracking-tight">{tenantInfo.name}</h1>
                                {tenantInfo.storeAddress && <p className="text-purple-200 text-xs mt-1">{tenantInfo.storeAddress}</p>}
                                <p className="text-purple-200 text-xs mt-1">Powered by iFix Enterprise</p>
                                <div className="mt-2 inline-block bg-white/10 border border-white/20 text-white/80 text-xs font-mono px-3 py-1 rounded-full">
                                    {window.DETECTED_SUBDOMAIN}.amproject.my.id
                                </div>
                            </div>
                        ) : (
                            <div className="p-8 text-center bg-blue-600">
                                <img src="/logo-ifix.png" alt="iFix Enterprise" className="w-32 h-32 object-contain mx-auto mb-4 bg-white rounded-2xl p-3 shadow-lg" />
                                <h1 className="text-2xl font-black text-white tracking-tight">iFix Enterprise</h1>
                                <p className="text-blue-100 text-sm mt-1">Cloud Management Platform</p>
                            </div>
                        )}
                        <div className="p-8">
                            {tenantRedirect ? (
                                <div className="text-center py-4">
                                    {tenantRedirect.isDev ? (
                                        <>
                                            <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                <ShieldAlert className="w-8 h-8 text-orange-500"/>
                                            </div>
                                            <h3 className="text-lg font-black text-slate-800 mb-2">Akses Tidak Diizinkan</h3>
                                            <p className="text-sm text-slate-500 mb-5">
                                                Akun developer tidak dapat login di halaman tenant.<br/>
                                                Silakan login melalui portal utama.
                                            </p>
                                            <a
                                                href="https://amproject.my.id"
                                                className="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold px-5 py-2.5 rounded-xl text-sm transition-all"
                                            >
                                                Buka amproject.my.id
                                            </a>
                                        </>
                                    ) : (
                                        <>
                                            <div className="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                <ShieldAlert className="w-8 h-8 text-amber-500"/>
                                            </div>
                                            <h3 className="text-lg font-black text-slate-800 mb-2">Halaman Khusus Developer</h3>
                                            <p className="text-sm text-slate-500 mb-1">
                                                Akun <span className="font-semibold text-slate-700">{tenantRedirect.name}</span> tidak dapat login di sini.
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">Silakan login melalui portal toko Anda:</p>
                                            {tenantRedirect.subdomain ? (
                                                <a
                                                    href={`https://${tenantRedirect.subdomain}.amproject.my.id`}
                                                    className="inline-flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-bold px-5 py-2.5 rounded-xl text-sm transition-all"
                                                >
                                                    Buka {tenantRedirect.subdomain}.amproject.my.id
                                                </a>
                                            ) : (
                                                <p className="text-xs text-slate-400 italic mt-2">Subdomain toko tidak ditemukan. Hubungi administrator.</p>
                                            )}
                                            <button
                                                type="button"
                                                onClick={() => setTenantRedirect(null)}
                                                className="block mt-4 text-xs text-slate-400 hover:text-slate-600 mx-auto"
                                            >
                                                ‚Üê Kembali ke halaman login
                                            </button>
                                        </>
                                    )}
                                </div>
                            ) : (<>
                            <h2 className="text-xl font-bold text-slate-800 mb-6 text-center">Login</h2>

                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-xs font-bold mb-4 flex items-center gap-2 border border-red-100"><ShieldAlert className="w-4 h-4"/> {error}</div>}

                            <form onSubmit={handleAuth} className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Email</label>
                                    <div className="relative">
                                        <input 
                                            type="email" 
                                            value={email} 
                                            onChange={e=>setEmail(e.target.value)} 
                                            className="w-full border border-slate-300 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none touch-manipulation" 
                                            placeholder="nama@email.com" 
                                            autoComplete="email"
                                            inputMode="email"
                                            autoCapitalize="off"
                                            autoCorrect="off"
                                            spellCheck="false"
                                            required
                                        />
                                        <UserPlus className="w-5 h-5 text-slate-400 absolute left-3 top-3.5"/>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Password</label>
                                    <div className="relative">
                                        <input 
                                            type="password" 
                                            value={password} 
                                            onChange={e=>setPassword(e.target.value)} 
                                            className="w-full border border-slate-300 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none touch-manipulation" 
                                            placeholder="******" 
                                            autoComplete="current-password"
                                            required
                                        />
                                        <Key className="w-5 h-5 text-slate-400 absolute left-3 top-3.5"/>
                                    </div>
                                </div>
                                
                                <div className="flex items-center">
                                    <input 
                                        id="remember-me" 
                                        type="checkbox" 
                                        checked={rememberMe}
                                        onChange={(e) => setRememberMe(e.target.checked)}
                                        className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 touch-manipulation"
                                    />
                                    <label htmlFor="remember-me" className="ml-2 text-sm font-medium text-slate-600 cursor-pointer touch-manipulation">Ingat Saya</label>
                                </div>

                                <button 
                                    type="submit" 
                                    disabled={loading} 
                                    className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-600/30 transition-all flex items-center justify-center gap-2 touch-manipulation active:scale-95"
                                >
                                    {loading ? (
                                        <>
                                            <Loader2 className="w-5 h-5 animate-spin"/> 
                                            <span>Memproses...</span>
                                        </>
                                    ) : (
                                        'Masuk Aplikasi'
                                    )}
                                </button>
                            </form>
                            
                            {/* PWA Mode Info */}
                            {isPWA && (
                                <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p className="text-xs text-blue-700 font-bold mb-1 flex items-center gap-1">
                                        <Smartphone className="w-3.5 h-3.5"/> Mode Aplikasi (PWA)
                                    </p>
                                    <p className="text-xs text-blue-600">
                                        Jika tidak bisa login, <span className="font-bold">buka dari browser</span> untuk clear cache lama, lalu install ulang.
                                    </p>
                                </div>
                            )}
                            
                            {/* Debug Panel for Troubleshooting */}
                            <div className="mt-4">
                                <button 
                                    type="button"
                                    onClick={() => setShowDebug(!showDebug)}
                                    className="w-full text-xs text-slate-500 hover:text-slate-700 py-2 touch-manipulation"
                                >
                                    {showDebug ? '‚ñº' : '‚ñ∂'} Info Koneksi & Troubleshooting
                                </button>
                                
                                {showDebug && (
                                    <div className="mt-2 p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs space-y-2">
                                        <div className="flex justify-between">
                                            <span className="text-slate-600">Status Internet:</span>
                                            <span className={`font-bold ${navigator.onLine ? 'text-green-600' : 'text-red-600'}`}>
                                                {navigator.onLine ? '‚úì Online' : '‚úó Offline'}
                                            </span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-slate-600">Mode PWA:</span>
                                            <span className={`font-bold ${isPWA ? 'text-blue-600' : 'text-slate-600'}`}>
                                                {isPWA ? '‚úì Ya' : '‚úó Tidak'}
                                            </span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-slate-600">Browser:</span>
                                            <span className="font-mono text-[10px] text-slate-700">
                                                {navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                                                 navigator.userAgent.includes('Safari') ? 'Safari' : 
                                                 navigator.userAgent.includes('Firefox') ? 'Firefox' : 'Other'}
                                            </span>
                                        </div>
                                        <div className="pt-2 border-t border-slate-300 space-y-1">
                                            <p className="font-bold text-slate-700">üí° Tips Login:</p>
                                            <ul className="list-disc list-inside text-slate-600 space-y-1">
                                                <li>Pastikan email sudah didaftarkan</li>
                                                <li>Cek koneksi internet stabil</li>
                                                <li>Coba reload halaman (pull down)</li>
                                                <li>Hapus cache browser jika masih error</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            <div className="mt-6 pt-6 border-t border-slate-100 text-center">
                                <p className="text-xs text-slate-400">Pastikan email Anda telah didaftarkan oleh Admin/Owner toko Anda.</p>
                            </div>
                            </>)}
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // üõ°Ô∏è ERROR BOUNDARY COMPONENT
        // ==========================================
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('üî¥ React Error Boundary caught:', error, errorInfo);
                this.setState({
                    error,
                    errorInfo
                });
                
                // Tampilkan error di UI
                window.showError(
                    'React Component Error',
                    'Terjadi error saat merender komponen React.\n\nComponent Stack: ' + (errorInfo?.componentStack || 'N/A'),
                    error
                );
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-gradient-to-br from-red-50 to-red-100 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-2xl p-8 max-w-2xl w-full">
                                <div className="flex items-center gap-3 mb-6">
                                    <AlertTriangle className="w-10 h-10 text-red-600" />
                                    <h1 className="text-2xl font-bold text-red-600">Aplikasi Mengalami Error</h1>
                                </div>
                                <div className="bg-red-50 border border-red-200 rounded p-4 mb-6">
                                    <p className="text-sm font-mono text-red-800 whitespace-pre-wrap break-words">
                                        {this.state.error && this.state.error.toString()}
                                    </p>
                                </div>
                                <div className="space-y-3">
                                    <button
                                        onClick={() => window.location.reload()}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
                                    >
                                        <RefreshCw className="w-5 h-5" />
                                        Reload Halaman
                                    </button>
                                    <button
                                        onClick={() => {
                                            localStorage.clear();
                                            window.location.reload();
                                        }}
                                        className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
                                    >
                                        <Trash2 className="w-5 h-5" />
                                        Clear Cache & Reload
                                    </button>
                                </div>
                                <p className="text-xs text-slate-500 mt-6 text-center">
                                    Jika masalah berlanjut, hubungi support atau screenshot error ini.
                                </p>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        const Root = () => (
            <ErrorBoundary>
                <QuotaTrackingProvider>
                    <ToastProvider>
                        <SessionProvider>
                            <App />
                        </SessionProvider>
                    </ToastProvider>
                </QuotaTrackingProvider>
            </ErrorBoundary>
        );
        
        // Render dengan error handling
        try {
            console.log('üîÑ Rendering React app...');
            const root = createRoot(document.getElementById('root'));
            root.render(<Root />);
            console.log('‚úÖ React app rendered successfully');
            
            // ==========================================
            // üîí VERSION COMPATIBILITY CHECK
            // ==========================================
            console.log('üîí ===== VERSION LOCK STATUS =====');
            console.log('üì¶ Dependencies Status: LOCKED');
            console.log('‚úÖ React: 18.2.0 (Stable)');
            console.log('‚úÖ Firebase: 10.7.1 (Tested)');
            console.log('‚úÖ Protection Layer: Active');
            console.log('üìÖ Last Verified: Feb 3, 2026');
            console.log('‚ö†Ô∏è  DO NOT auto-update without testing!');
            console.log('üîí ================================');
            
        } catch (error) {
            console.error('‚ùå Failed to render React app:', error);
            window.showError(
                'React Render Error',
                'Gagal merender aplikasi React.\nPeriksa kompabilitas browser atau koneksi internet.',
                error
            );
        }
    </script>
</body>
</html>